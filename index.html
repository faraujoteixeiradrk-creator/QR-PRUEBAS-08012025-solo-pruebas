<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-title">DRK: Comparador Multitarifa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluimos QRCode.js y jsQR.min.js para el manejo de QR -->
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <!-- Librer√≠as para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // --- TAILWIND CONFIGURATION ---
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        drk: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            400: '#38bdf8', /* Lighter Blue for Active Hover */
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1', /* A√ëADIDO */
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        powercup: {
                            50: '#f7fee7',
                            100: '#ecfccb',
                            400: '#a3e635', /* Lighter Green for Active Hover */
                            500: '#84cc16',
                            600: '#65a30d',
                            700: '#4d7c0f', /* A√ëADIDO */
                            800: '#3f6212',
                            900: '#365314',
                            'yellow-flash': '#facc15',
                        },
                        // Nuevos colores para asegurar el verde en el flujo de resultados y CTA
                        'cta-green': {
                            500: '#16a34a', /* Usado para los ahorros */
                            600: '#15803d',
                        },
                        'cta-red': {
                            500: '#CC0000',
                            600: '#A00000',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* === SISTEMA PANTALLAS === */
        .screen { display: none; }
        .screen.active { display: block; }
        
        /* Estilos base y animaciones */
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        #interactive.viewport { position: relative; width: 100%; height: auto; overflow: hidden; border-radius: 1rem; }
        #interactive.viewport > video { width: 100%; height: 100%; object-fit: cover; }
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .mode-selector { border: 2px solid; }

        /* Estilos de los botones de selecci√≥n de tarifa (Landing Page) */
        .tariff-select-btn {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 1rem; /* p-4 */
            background-color: white;
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); /* shadow-lg */
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0; /* slate-200 */
        }
        
        /* DRK Active Hover Styles (Default) */
        .drk-active .tariff-select-btn:hover {
            border-color: #0ea5e9; /* drk-500 */
            background-color: #f0f9ff; /* drk-50 */
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(14, 165, 233, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
        }
        .drk-active .tariff-select-btn:hover .arrow-icon {
            color: #0ea5e9; /* drk-500 */
        }

        /* POWER CUP Active Hover Styles */
        .powercup-active .tariff-select-btn:hover {
            border-color: #84cc16; /* powercup-500 */
            background-color: #f7fee7; /* powercup-50 */
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(132, 204, 22, 0.2), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
        }
        .powercup-active .tariff-select-btn:hover .arrow-icon {
            color: #84cc16; /* powercup-500 */
        }

        .icon-wrapper {
            padding: 0.75rem; /* p-3 */
            border-radius: 0.75rem; /* rounded-xl */
            margin-right: 1rem; /* mr-4 */
            flex-shrink: 0;
            transition: background-color 0.3s;
        }

        .arrow-icon {
            margin-left: auto;
            font-size: 1.5rem;
            color: #94a3b8; /* slate-400 */
            transition: color 0.3s ease;
        }

        /* Estilos QR */
        #qr-content-wrapper { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; overflow: hidden; max-height: 0; opacity: 0; }
        #qr-content-wrapper.active { max-height: 500px; opacity: 1; }
        #qr-visual-container { 
            position: relative; 
            display: inline-block; 
            background-color: white; 
            border-radius: 1rem; 
            padding: 1rem; 
            border: 4px solid var(--qr-border-color, #0ea5e9); 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        /* Texto central del QR */
        #qr-visual-container::before { 
            content: var(--qr-center-text, "DRK"); 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            font-size: 20px; /* Tama√±o reducido para no cubrir tanto */
            font-weight: bold; 
            color: #ffffff; 
            background-color: var(--qr-center-bg, #0c4a6e); 
            padding: 4px 8px; /* Padding reducido */
            border-radius: 6px; 
            z-index: 10; 
            opacity: 0.95; 
            min-width: 60px;
            text-align: center;
        }
        
        /* Ocultar elementos dependiendo del tipo de tarifa */
        .hidden-period { display: none; }
        
        /* Estilos para el campo de pegado temporal (FIX para Ctrl+V) */
        #paste-catcher {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: -1; /* Oculto por defecto */
            width: 0;
            height: 0;
            opacity: 0;
            pointer-events: none;
            transition: all 0.15s ease-in-out;
            resize: none;
        }

        #paste-catcher.pasting-active {
            width: 200px; 
            height: 100px; 
            opacity: 0.01; /* Debe ser casi transparente, pero no 0 */
            z-index: 1000; /* Siempre visible cuando activo */
            border: 4px dashed var(--qr-border-color, #0ea5e9);
            background-color: white;
        }
        
        /* PESTA√ëAS DE RESULTADOS */
        .tab-result-btn {
            background: transparent;
            color: #64748b;
        }
        .tab-result-btn.active {
            color: #0ea5e9;
            border-bottom-color: #0ea5e9 !important;
        }
        .tab-result-content {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800;900&display=swap');
        
        /* Sistema de vistas */
        #panel-view { display: block; }
        #calculator-view { display: none; }
        #comparison-view { display: none; }
        
        body.showing-calculator #panel-view { display: none !important; }
        body.showing-calculator #calculator-view { display: block !important; }
        body.showing-calculator #comparison-view { display: none !important; }

        body.showing-comparison #panel-view { display: none !important; }
        body.showing-comparison #calculator-view { display: none !important; }
        body.showing-comparison #comparison-view { display: block !important; }

        /* Estilos del Panel */
        #panel-view {
            background: linear-gradient(180deg, #1e7a9e 0%, #2596be 100%);
            min-height: 100vh;
            font-family: 'Outfit', sans-serif;
        }

        /* Selector de idiomas en el panel */
        .panel-language-selector {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 1000;
        }

        .panel-language-selector select {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(10px);
            color: white;
            font-weight: 700;
            font-size: 1rem;
            padding: 0.75rem 2.5rem 0.75rem 1rem;
            border-radius: 0.75rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            appearance: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .panel-language-selector select:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.2));
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }

        .panel-language-selector select option {
            background: #2596be;
            color: white;
        }

        .panel-language-arrow {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: white;
        }

        .logo-container {
            width: 140px;
            height: 140px;
            background: white;
            border-radius: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }

        .logo-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 36px;
            height: 36px;
            background: #3b82f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.5);
        }

        .dept-card {
            background: linear-gradient(135deg, #0f4c75 0%, #1b6ca8 100%);
            border: 2px solid rgba(37, 150, 190, 0.3);
            border-radius: 2rem;
            padding: 3rem 2rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 220px;
            color: white;
        }

        .dept-card:hover {
            background: linear-gradient(135deg, #1b6ca8 0%, #2596be 100%);
            border-color: rgba(37, 150, 190, 0.8);
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(37, 150, 190, 0.4);
        }

        .icon-box {
            width: 80px;
            height: 80px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dept-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: #93c5fd;
        }

        .dept-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            line-height: 1.2;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            width: 100%;
            max-width: 900px;
        }

        .back-btn {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 10000;
            background: linear-gradient(135deg, #2596be, #1e7a9e);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 1rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
            cursor: pointer;
            border: none;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.6);
        }

        /* Modal Email Backoffice */
        .email-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .email-modal.active {
            display: flex;
        }

        .email-modal-content {
            background: white;
            border-radius: 1.5rem;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .email-modal-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .email-modal-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #2596be, #3db4d8);
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .email-modal-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: #1e293b;
        }

        .email-modal-subtitle {
            font-size: 0.875rem;
            color: #64748b;
            margin-top: 0.25rem;
        }

        .email-form-group {
            margin-bottom: 1rem;
        }

        .email-form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #475569;
            margin-bottom: 0.5rem;
        }

        .email-form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.75rem;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .email-form-input:focus {
            outline: none;
            border-color: #2596be;
            box-shadow: 0 0 0 3px rgba(37, 150, 190, 0.1);
        }

        .email-modal-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .email-btn {
            flex: 1;
            padding: 0.875rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .email-btn-cancel {
            background: #f1f5f9;
            color: #475569;
        }

        .email-btn-cancel:hover {
            background: #e2e8f0;
        }

        .email-btn-send {
            background: linear-gradient(135deg, #2596be, #3db4d8);
            color: white;
        }

        .email-btn-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 150, 190, 0.4);
        }

        @media (max-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr;
                max-width: 500px;
            }
            
            .panel-language-selector {
                top: 1rem;
                right: 1rem;
            }
            
            .panel-language-selector select {
                font-size: 0.875rem;
                padding: 0.625rem 2rem 0.625rem 0.75rem;
            }
            
            .email-modal-content {
                padding: 1.5rem;
                margin: 1rem;
            }
            
            .email-modal-title {
                font-size: 1.25rem;
            }
            
            .email-modal-buttons {
                flex-direction: column;
            }
            
            .email-btn {
                width: 100%;
            }
        }

        /* ========== ESTILOS COMPARATIVA DE PRECIOS ========== */
        #screen-comparison {
            background: linear-gradient(180deg, #f8fafc 0%, #e0f2fe 100%);
            min-height: 100vh;
            padding: 6rem 1rem 2rem 1rem;
        }

        .comparison-hero {
            background: linear-gradient(135deg, #1e7a9e 0%, #2596be 100%);
            border-radius: 1.5rem;
            padding: 2.5rem 2rem;
            color: white;
            margin-bottom: 2rem;
            box-shadow: 0 20px 60px rgba(37, 150, 190, 0.3);
        }

        .comparison-table-container {
            background: white;
            border-radius: 1.5rem;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .comp-table-header {
            background: linear-gradient(135deg, #2596be 0%, #1e7a9e 100%);
            color: white;
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .comp-table-row {
            border-bottom: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .comp-table-row:hover {
            background: #f1f5f9;
        }

        .comp-table-row.best-row {
            background: linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);
            border-left: 4px solid #10b981;
            font-weight: 600;
        }

        .comp-table-row.best-row:hover {
            background: linear-gradient(135deg, #a7f3d0 0%, #d1fae5 100%);
        }

        .badge-winner {
            display: inline-block;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-left: 0.5rem;
        }

        .chart-bar-comp {
            height: 45px;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            color: white;
            font-weight: 700;
            transition: all 0.3s ease;
            margin-bottom: 0.5rem;
        }

        .chart-bar-comp:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .chart-bar-comp.winner-bar {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: 2px solid #047857;
        }

        .comparison-summary-card {
            background: white;
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .comparison-highlight {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-left: 4px solid #10b981;
            padding: 1.5rem;
            border-radius: 1rem;
            margin-top: 1.5rem;
        }

        .comparison-stat-box {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
        }

        @media (max-width: 768px) {
            #screen-comparison {
                padding: 5rem 0.5rem 1rem 0.5rem;
            }

            .comparison-hero {
                padding: 2rem 1.5rem;
            }

            .comp-table-responsive {
                overflow-x: auto;
            }

            .comp-table-responsive table {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen text-slate-800 drk-active">

<!-- ========== PANEL DE DEPARTAMENTOS ========== -->
<div id="panel-view">
    <!-- Selector de Idiomas -->
    <div class="panel-language-selector">
        <select id="panel-language-selector" onchange="changePanelLanguage(this.value)">
            <option value="es">üá™üá∏ Espa√±ol</option>
            <option value="en">üá¨üáß English</option>
            <option value="pt">üáµüáπ Portugu√™s</option>
            <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
            <option value="fr">üá´üá∑ Fran√ßais</option>
        </select>
        <span class="panel-language-arrow">‚ñº</span>
    </div>

    <div style="width: 100%; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem;">
        <div style="width: 100%; max-width: 1200px;">
            
            <!-- Logo y Branding -->
            <div style="text-align: center; margin-bottom: 3rem;">
                <div style="display: flex; justify-content: center; margin-bottom: 2rem;">
                    <div class="logo-container">
                        <span style="font-size: 3.5rem; font-weight: 900; color: #2596be; letter-spacing: -0.05em;">DRK</span>
                        <div class="logo-badge">
                            <i class="fas fa-bolt" style="color: white; font-size: 1.25rem;"></i>
                        </div>
                    </div>
                </div>
                <h1 style="font-size: 3rem; font-weight: 800; color: white; margin-bottom: 0.5rem;" data-translate="panel-title">DRK Energ√≠a</h1>
                <p style="font-size: 1rem; font-weight: 600; color: #93c5fd; text-transform: uppercase; letter-spacing: 0.3em;" data-translate="panel-subtitle">Smart Solutions</p>
            </div>

            <!-- Grid de Departamentos 2x2 -->
            <div class="grid-container" style="margin: 0 auto;">
                
                <!-- Departamento 1: Calcula tu Ahorro -->
                <div class="dept-card" onclick="showCalculator()">
                    <div class="icon-box">
                        <!-- Icono: Calculadora con monedas -->
                        <svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="8" y="10" width="30" height="38" rx="4" fill="#fbbf24" opacity="0.2"/>
                            <rect x="8" y="10" width="30" height="38" rx="4" stroke="#fbbf24" stroke-width="2"/>
                            <rect x="12" y="14" width="22" height="8" rx="2" fill="#fbbf24"/>
                            <circle cx="15" cy="27" r="2.5" fill="#fbbf24"/>
                            <circle cx="23" cy="27" r="2.5" fill="#fbbf24"/>
                            <circle cx="31" cy="27" r="2.5" fill="#fbbf24"/>
                            <circle cx="15" cy="34" r="2.5" fill="#fbbf24"/>
                            <circle cx="23" cy="34" r="2.5" fill="#fbbf24"/>
                            <circle cx="31" cy="34" r="2.5" fill="#fbbf24"/>
                            <circle cx="15" cy="41" r="2.5" fill="#fbbf24"/>
                            <rect x="20" y="38.5" width="14" height="5" rx="2.5" fill="#fbbf24"/>
                            <circle cx="45" cy="18" r="8" fill="#f59e0b" opacity="0.3"/>
                            <circle cx="45" cy="18" r="8" stroke="#f59e0b" stroke-width="2"/>
                            <text x="45" y="22" text-anchor="middle" font-size="10" font-weight="bold" fill="#f59e0b">‚Ç¨</text>
                        </svg>
                    </div>
                    <div>
                        <p class="dept-label" data-translate="dept1-label">Optimizaci√≥n</p>
                        <h3 class="dept-title" data-translate="dept1-title">Calcula tu Ahorro</h3>
                    </div>
                </div>

                <!-- Departamento 2: Precios de la Competencia -->
                <div class="dept-card" onclick="showComparison()">
                    <div class="icon-box">
                        <!-- Icono: Gr√°fico comparativo -->
                        <svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="8" y="35" width="8" height="20" rx="2" fill="#22d3ee"/>
                            <rect x="19" y="25" width="8" height="30" rx="2" fill="#06b6d4"/>
                            <rect x="30" y="30" width="8" height="25" rx="2" fill="#22d3ee"/>
                            <rect x="41" y="15" width="8" height="40" rx="2" fill="#06b6d4"/>
                            <path d="M10 28 L23 18 L34 22 L45 8" stroke="#0ea5e9" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <circle cx="10" cy="28" r="3" fill="#0ea5e9"/>
                            <circle cx="23" cy="18" r="3" fill="#0ea5e9"/>
                            <circle cx="34" cy="22" r="3" fill="#0ea5e9"/>
                            <circle cx="45" cy="8" r="3" fill="#0ea5e9"/>
                        </svg>
                    </div>
                    <div>
                        <p class="dept-label" data-translate="dept2-label">Mercado</p>
                        <h3 class="dept-title" data-translate="dept2-title">Precios de la Competencia</h3>
                    </div>
                </div>

                <!-- Departamento 3: Email Backoffice -->
                <div class="dept-card" onclick="openEmailModal()">
                    <div class="icon-box">
                        <!-- Icono: Sobre de correo con @ -->
                        <svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="8" y="15" width="44" height="30" rx="4" fill="#3db4d8" opacity="0.2"/>
                            <rect x="8" y="15" width="44" height="30" rx="4" stroke="#3db4d8" stroke-width="2"/>
                            <path d="M8 15 L30 32 L52 15" stroke="#3db4d8" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <circle cx="30" cy="30" r="10" fill="#2596be" opacity="0.3"/>
                            <circle cx="30" cy="30" r="10" stroke="#2596be" stroke-width="2"/>
                            <text x="30" y="35" text-anchor="middle" font-size="12" font-weight="bold" fill="#2596be">@</text>
                        </svg>
                    </div>
                    <div>
                        <p class="dept-label" data-translate="dept3-label">Contacto</p>
                        <h3 class="dept-title" data-translate="dept3-title">Email Backoffice</h3>
                    </div>
                </div>

                <!-- Departamento 4: C√≥digo Amigos y Descuentos -->
                <div class="dept-card" onclick="showFriendsCode()">
                    <div class="icon-box">
                        <!-- Icono: Ticket con descuento -->
                        <svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 20 L50 20 L50 25 C47 25 45 27 45 30 C45 33 47 35 50 35 L50 40 L10 40 L10 35 C13 35 15 33 15 30 C15 27 13 25 10 25 Z" fill="#f87171" opacity="0.2"/>
                            <path d="M10 20 L50 20 L50 25 C47 25 45 27 45 30 C45 33 47 35 50 35 L50 40 L10 40 L10 35 C13 35 15 33 15 30 C15 27 13 25 10 25 Z" stroke="#f87171" stroke-width="2"/>
                            <circle cx="30" cy="30" r="8" fill="#ef4444" opacity="0.3"/>
                            <circle cx="30" cy="30" r="8" stroke="#ef4444" stroke-width="2"/>
                            <text x="30" y="35" text-anchor="middle" font-size="10" font-weight="bold" fill="#ef4444">%</text>
                            <line x1="20" y1="15" x2="20" y2="45" stroke="#f87171" stroke-width="1.5" stroke-dasharray="3 3"/>
                            <line x1="40" y1="15" x2="40" y2="45" stroke="#f87171" stroke-width="1.5" stroke-dasharray="3 3"/>
                        </svg>
                    </div>
                    <div>
                        <p class="dept-label" data-translate="dept4-label">Beneficios</p>
                        <h3 class="dept-title" data-translate="dept4-title">C√≥digo Amigos y Descuentos</h3>
                    </div>
                </div>

                <!-- Departamento 5: Noticias -->
                <div class="dept-card" onclick="showNews()">
                    <div class="icon-box">
                        <!-- Icono: Peri√≥dico/Noticias -->
                        <svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <!-- Peri√≥dico -->
                            <rect x="12" y="15" width="36" height="30" rx="2" fill="#fbbf24" opacity="0.2"/>
                            <rect x="12" y="15" width="36" height="30" rx="2" stroke="#fbbf24" stroke-width="2"/>
                            
                            <!-- T√≠tulo principal -->
                            <line x1="16" y1="21" x2="44" y2="21" stroke="#fbbf24" stroke-width="3" stroke-linecap="round"/>
                            
                            <!-- L√≠neas de texto -->
                            <line x1="16" y1="27" x2="35" y2="27" stroke="#f59e0b" stroke-width="1.5" stroke-linecap="round"/>
                            <line x1="16" y1="31" x2="40" y2="31" stroke="#f59e0b" stroke-width="1.5" stroke-linecap="round"/>
                            <line x1="16" y1="35" x2="32" y2="35" stroke="#f59e0b" stroke-width="1.5" stroke-linecap="round"/>
                            
                            <!-- Imagen/foto -->
                            <rect x="16" y="38" width="12" height="5" rx="1" fill="#f59e0b" opacity="0.5"/>
                            
                            <!-- M√°s l√≠neas -->
                            <line x1="30" y1="39" x2="44" y2="39" stroke="#f59e0b" stroke-width="1.5" stroke-linecap="round"/>
                            <line x1="30" y1="42" x2="44" y2="42" stroke="#f59e0b" stroke-width="1.5" stroke-linecap="round"/>
                            
                            <!-- Icono de "nuevo" -->
                            <circle cx="46" cy="18" r="6" fill="#ef4444"/>
                            <text x="46" y="21" text-anchor="middle" font-size="7" font-weight="bold" fill="#ffffff">N</text>
                        </svg>
                    </div>
                    <div>
                        <p class="dept-label" data-translate="dept5-label">Informaci√≥n</p>
                        <h3 class="dept-title" data-translate="dept5-title">Noticias</h3>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- ========== CALCULADORA COMPLETA ========== -->
<div id="calculator-view">
    <button class="back-btn" onclick="showPanel()">
        <i class="fas fa-arrow-left" style="margin-right: 0.5rem;"></i>Volver al Panel
    </button>

    <!-- Navbar -->
    <div id="navbar" class="w-full bg-drk-900 text-white p-4 shadow-md sticky top-0 z-50 transition-colors duration-300">
        <div class="max-w-lg mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold tracking-tight cursor-pointer" onclick="resetToLanding()">
                <span id="app-logo-main">DRK</span> <span class="text-drk-500" id="app-logo-accent">Energ√≠a</span>
            </h1>
            
            <!-- Language Selector (oculto - idioma se selecciona en panel principal) -->
            <div id="calculator-language-selector" class="flex items-center gap-3" style="display: none;">
                <div class="relative">
                    <select id="language-selector" onchange="if(window.LANG) window.LANG.change(this.value)" 
                            class="bg-gradient-to-r from-drk-700 to-drk-800 text-white text-base px-5 py-3 rounded-lg border-2 border-drk-500 cursor-pointer hover:from-drk-600 hover:to-drk-700 transition-all appearance-none pr-10 font-bold shadow-lg">
                        <option value="es">üá™üá∏ Espa√±ol</option>
                        <option value="en">üá¨üáß English</option>
                        <option value="pt">üáµüáπ Portugu√™s</option>
                        <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                        <option value="fr">üá´üá∑ Fran√ßais</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-white">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>
                <span class="text-sm bg-drk-800 px-3 py-2 rounded-lg text-drk-100 font-semibold" id="app-subtitle">üåç Multilenguaje</span>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="app" class="w-full max-w-lg mx-auto p-4 md:p-6 flex-grow">

        <!-- MODO DE COMPARACI√ìN - OCULTO (solo DRK) -->
        <div id="modo-comparacion-section" class="hidden fade-in mb-6">
            <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-drk-500">
                <p class="text-sm font-bold text-drk-800 mb-3 text-center uppercase tracking-wider">MODO DE COMPARACI√ìN</p>
                <div class="flex flex-wrap justify-center gap-2 text-sm">
                    <label class="mode-selector flex-1 px-2 py-2 rounded-lg cursor-pointer transition border-2 border-drk-500 text-white bg-drk-500 hover:bg-drk-600">
                        <input type="radio" name="comparison_mode" value="drk_only" class="hidden" checked>
                        <span class="font-semibold flex items-center justify-between w-full">DRK √önicamente<svg class="w-4 h-4 ml-1 checkmark-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- PANTALLA INICIAL: Unificada con opciones de escaneo -->
        <div id="screen-inicio" class="screen active">
            <div class="fade-in flex flex-col items-center justify-center min-h-[60vh] py-8">
                <div class="bg-white p-8 md:p-12 rounded-3xl shadow-2xl w-full max-w-2xl border-4 border-drk-500 relative">
                    <!-- VERSION -->
                    <div class="absolute bottom-4 right-6 text-sm text-gray-400 font-semibold">
                        v2024.12.20
                    </div>
                    
                    <!-- Logo circular m√°s grande -->
                    <div class="w-32 h-32 bg-gradient-to-br from-drk-50 to-drk-100 rounded-full flex items-center justify-center mx-auto mb-8 shadow-lg">
                        <svg class="w-16 h-16" viewBox="0 0 100 100" fill="none">
                            <style>.drk-ring{fill:none;stroke-width:12;stroke-linecap:round;}</style>
                            <circle class="drk-ring" cx="45" cy="45" r="30" stroke="#10b981"/>
                            <circle class="drk-ring" cx="55" cy="55" r="30" stroke="#ef4444"/>
                            <circle class="drk-ring" cx="45" cy="55" r="30" stroke="#3b82f6"/>
                            <circle class="drk-ring" cx="55" cy="45" r="30" stroke="#fbbf24"/>
                        </svg>
                    </div>

                    <!-- T√≠tulo principal -->
                    <h2 id="inicio-title" class="text-4xl font-black text-slate-900 mb-4 text-center">Analizar Factura</h2>
                    
                    <!-- Subt√≠tulo explicativo -->
                    <p class="text-lg text-slate-600 mb-8 text-center font-medium">
                        Escanea el c√≥digo QR o introduce datos manualmente.
                    </p>
                    
                    <!-- Bot√≥n principal ESCANEAR QR AHORA -->
                    <button onclick="selectTariffType('2.0TD'); setTimeout(() => document.getElementById('start-scan-btn').click(), 300);" class="w-full bg-gradient-to-r from-drk-600 to-drk-700 hover:from-drk-700 hover:to-drk-800 text-white font-bold py-5 px-8 rounded-2xl shadow-xl transform transition active:scale-95 flex items-center justify-center gap-4 text-lg">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.125 3h3.75a2 2 0 011.664.89l.812 1.22a2 2 0 001.664.89H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <span>ESCANEAR QR AHORA</span>
                    </button>
                    
                    <!-- Botones ocultos pero funcionales -->
                    <button onclick="selectTariffType('2.0TD'); setTimeout(() => document.getElementById('upload-menu-btn').click(), 300);" class="w-full bg-drk-50 hover:bg-drk-100 text-drk-800 font-bold py-3 px-6 rounded-xl shadow-sm transform transition active:scale-95 flex items-center justify-center gap-3 mt-3" style="display: none;">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <span>OTRAS OPCIONES DE CAPTURA</span>
                    </button>
                    
                    <button onclick="selectTariffType('2.0TD'); setTimeout(() => document.getElementById('manual-input-btn').click(), 300);" class="w-full bg-drk-50 hover:bg-drk-100 text-drk-800 font-bold py-3 px-6 rounded-xl shadow-sm transform transition active:scale-95 flex items-center justify-center gap-3 mt-2" style="display: none;">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        <span>DATOS A MANO</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- PANTALLA 2: ELECTRICIDAD (landing-view original) -->
        <div id="screen-electricidad" class="screen">
        <!-- 1. Landing View -->
        <div id="landing-view" class="fade-in flex flex-col items-center justify-center min-h-[60vh] py-8">
            <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-drk-500" id="landing-card">
                <div id="landing-icon-bg" class="w-16 h-16 bg-drk-50 rounded-full flex items-center justify-center mx-auto mb-4 text-drk-600 shadow-inner">
                    <svg class="w-8 h-8" viewBox="0 0 100 100" fill="none">
                        <style>.drk-ring{fill:none;stroke-width:10;stroke-linecap:round;}</style>
                        <circle class="drk-ring" cx="45" cy="45" r="35" stroke="#E50000"/>
                        <circle class="drk-ring" cx="55" cy="55" r="35" stroke="#FFCC00"/>
                        <circle class="drk-ring" cx="45" cy="55" r="35" stroke="#0079C1"/>
                        <circle class="drk-ring" cx="55" cy="45" r="35" stroke="#00A859"/>
                    </svg>
                </div>
                <h2 id="landing-title" class="text-3xl font-black text-drk-900 mb-2 text-center">DRK COMPARADOR</h2>
                <p class="text-slate-500 mb-6 text-center">Selecciona la tarifa que deseas analizar.</p>
                
                <!-- Tariff Selection Buttons -->
                <div class="w-full space-y-4">
                    <button onclick="selectTariffType('2.0TD')" class="tariff-select-btn group">
                        <div class="icon-wrapper bg-drk-50 text-drk-600 group-hover:bg-drk-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                        </div>
                        <div class="text-left">
                            <span class="text-lg font-bold text-drk-900">2.0 TD</span>
                            <span class="block text-xs text-slate-500">Hogar / Peque√±o Negocio</span>
                        </div>
                        <span class="arrow-icon group-hover:text-drk-500">&rarr;</span>
                    </button>
                </div>
                
                <!-- QR Link Section -->
                <div id="pwa-install-section" class="mt-8 pt-4 border-t border-slate-200 text-center">
                    <label class="flex items-center justify-center cursor-pointer mb-3 text-drk-800 hover:text-drk-900 transition">
                        <input type="checkbox" id="qr-toggle-checkbox" class="h-4 w-4 text-drk-500 border-gray-300 rounded focus:ring-drk-500 mr-2">
                        <span class="text-xs font-bold uppercase tracking-wider underline decoration-drk-500 decoration-2 underline-offset-4">Abrir en el Movil</span>
                    </label>
                    <div id="qr-content-wrapper" class="opacity-0 max-h-0">
                        <div id="qr-visual-container" class="mx-auto w-44 h-44 p-2">
                            <div id="qr-code-container"></div>
                        </div>
                        <p class="text-xs text-slate-500 mt-3">Haz una foto del QR y √°brelo en tu m√≥vil.</p>
                    </div>
                </div>

            </div>
        </div>
        </div> <!-- Cierre screen-electricidad -->
        
        <!-- PANTALLA 3: GAS -->
        <div id="screen-gas" class="screen">
            <div class="fade-in flex flex-col items-center justify-center min-h-[60vh] py-8">
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-red-500">
                    
                    <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600 shadow-inner">
                        <span class="text-4xl">üî•</span>
                    </div>
                    <h2 class="text-3xl font-black text-red-600 mb-2 text-center">GAS</h2>
                    <p id="gas-regulation-subtitle" class="text-slate-500 mb-6 text-center">Selecciona la regulaci√≥n de gas.</p>
                    
                    <div class="w-full space-y-4">
                        <button onclick="selectGasTariff('RL1')" class="tariff-select-btn group">
                            <div class="icon-wrapper bg-red-50 text-red-600 group-hover:bg-red-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>
                            </div>
                            <div class="text-left">
                                <span class="text-lg font-bold text-drk-900">RL1</span>
                                <span class="block text-xs text-slate-500">Regulaci√≥n de Gas - Nivel 1</span>
                            </div>
                            <span class="arrow-icon group-hover:text-red-500">&rarr;</span>
                        </button>

                        <button onclick="selectGasTariff('RL2')" class="tariff-select-btn group">
                            <div class="icon-wrapper bg-red-50 text-red-600 group-hover:bg-red-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>
                            </div>
                            <div class="text-left">
                                <span class="text-lg font-bold text-drk-900">RL2</span>
                                <span class="block text-xs text-slate-500">Regulaci√≥n de Gas - Nivel 2</span>
                            </div>
                            <span class="arrow-icon group-hover:text-red-500">&rarr;</span>
                        </button>

                        <button onclick="selectGasTariff('RL3')" class="tariff-select-btn group">
                            <div class="icon-wrapper bg-red-50 text-red-600 group-hover:bg-red-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>
                            </div>
                            <div class="text-left">
                                <span class="text-lg font-bold text-drk-900">RL3</span>
                                <span class="block text-xs text-slate-500">Regulaci√≥n de Gas - Nivel 3</span>
                            </div>
                            <span class="arrow-icon group-hover:text-red-500">&rarr;</span>
                        </button>

                        <button onclick="selectGasTariff('RL4')" class="tariff-select-btn group">
                            <div class="icon-wrapper bg-red-50 text-red-600 group-hover:bg-red-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>
                            </div>
                            <div class="text-left">
                                <span class="text-lg font-bold text-drk-900">RL4</span>
                                <span class="block text-xs text-slate-500">Regulaci√≥n de Gas - Nivel 4</span>
                            </div>
                            <span class="arrow-icon group-hover:text-red-500">&rarr;</span>
                        </button>

                        <button onclick="selectGasTariff('RL5')" class="tariff-select-btn group">
                            <div class="icon-wrapper bg-red-50 text-red-600 group-hover:bg-red-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>
                            </div>
                            <div class="text-left">
                                <span class="text-lg font-bold text-drk-900">RL5</span>
                                <span class="block text-xs text-slate-500">Regulaci√≥n de Gas - Nivel 5</span>
                            </div>
                            <span class="arrow-icon group-hover:text-red-500">&rarr;</span>
                        </button>

                        <button onclick="selectGasTariff('RL6')" class="tariff-select-btn group">
                            <div class="icon-wrapper bg-red-50 text-red-600 group-hover:bg-red-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>
                            </div>
                            <div class="text-left">
                                <span class="text-lg font-bold text-drk-900">RL6</span>
                                <span class="block text-xs text-slate-500">Regulaci√≥n de Gas - Nivel 6</span>
                            </div>
                            <span class="arrow-icon group-hover:text-red-500">&rarr;</span>
                        </button>
                    </div>
                </div>
            </div>
        </div> <!-- Cierre screen-gas -->
        
        <!-- MODAL: Entrada manual de datos GAS -->
        <div id="gas-manual-input-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md border-t-4 border-red-500 max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <h3 class="text-2xl font-black text-red-600 mb-2 text-center">Datos de la Factura de GAS</h3>
                    <p class="text-sm text-slate-500 mb-4 text-center">Tarifa: <span id="gas-selected-tariff" class="font-bold text-red-600"></span></p>
                    
                    <div class="space-y-4">
                        <!-- CUPS de GAS -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">
                                CUPS (Opcional)
                            </label>
                            <input 
                                type="text" 
                                id="gas-cups" 
                                placeholder="Ej: ES0021000020679723GY" 
                                class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:border-red-500 focus:outline-none text-sm"
                            >
                            <p class="text-xs text-slate-500 mt-1">Se incluir√° en el PDF si lo proporcionas</p>
                        </div>
                        
                        <!-- D√≠as de facturaci√≥n -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">
                                D√≠as de facturaci√≥n
                            </label>
                            <input 
                                type="number" 
                                id="gas-dias" 
                                placeholder="Ej: 30" 
                                class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:border-red-500 focus:outline-none"
                                min="1"
                                step="1"
                            >
                        </div>
                        
                        <!-- kWh consumidos -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">
                                kWh consumidos
                            </label>
                            <input 
                                type="number" 
                                id="gas-kwh" 
                                placeholder="Ej: 250" 
                                class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:border-red-500 focus:outline-none"
                                min="0"
                                step="0.01"
                            >
                        </div>
                        
                        <!-- Total cliente -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">
                                Total factura actual (‚Ç¨)
                            </label>
                            <input 
                                type="number" 
                                id="gas-total-cliente" 
                                placeholder="Ej: 45.50" 
                                class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:border-red-500 focus:outline-none"
                                min="0"
                                step="0.01"
                            >
                        </div>
                        
                        <!-- SELECTOR: Comparar Indexada vs Fija -->
                        <div class="pt-4 border-t border-slate-200">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input 
                                    type="checkbox" 
                                    id="gas-compare-indexed-fixed" 
                                    class="w-5 h-5 text-red-600 rounded focus:ring-red-500"
                                    onchange="toggleGasComparisonMode()"
                                >
                                <span class="text-sm font-bold text-slate-700">Comparar Indexada vs Fija</span>
                            </label>
                            <p class="text-xs text-slate-500 mt-1 ml-8">
                                Activa para comparar autom√°ticamente tarifa indexada DRK contra tarifas fijas.
                            </p>
                        </div>
                        
                        <!-- OPCIONES DE SELECCI√ìN -->
                        <div class="pt-4 border-t border-slate-200">
                            <p class="text-sm font-bold text-slate-700 mb-3">Modo de selecci√≥n:</p>
                            
                            <!-- Opci√≥n 1: Mejores tarifas -->
                            <label class="flex items-start gap-3 mb-3 cursor-pointer p-3 border-2 border-slate-200 rounded-lg hover:border-red-300 transition">
                                <input 
                                    type="radio" 
                                    name="gas-selection-mode" 
                                    value="best" 
                                    class="mt-1 w-4 h-4 text-red-600"
                                    checked
                                    onchange="updateGasSelectionUI()"
                                >
                                <div>
                                    <span class="font-bold text-slate-800">Mejores tarifas</span>
                                    <p class="text-xs text-slate-500" id="gas-best-description">
                                        El sistema calcular√° autom√°ticamente las mejores opciones.
                                    </p>
                                </div>
                            </label>
                            
                            <!-- Opci√≥n 2: Elegir entre resultados -->
                            <label class="flex items-start gap-3 cursor-pointer p-3 border-2 border-slate-200 rounded-lg hover:border-red-300 transition">
                                <input 
                                    type="radio" 
                                    name="gas-selection-mode" 
                                    value="manual" 
                                    class="mt-1 w-4 h-4 text-red-600"
                                    onchange="updateGasSelectionUI()"
                                >
                                <div>
                                    <span class="font-bold text-slate-800">Elegir entre resultados</span>
                                    <p class="text-xs text-slate-500">
                                        Selecciona manualmente las tarifas que deseas comparar.
                                    </p>
                                </div>
                            </label>
                        </div>
                        
                        <!-- Botones FIJA/INDEXADA (solo cuando selector NO marcado y modo "best") -->
                        <div id="gas-type-buttons" class="pt-4 border-t border-slate-200 space-y-2">
                            <p class="text-sm font-bold text-slate-700 mb-2">Tipo de tarifa:</p>
                            <button 
                                onclick="calculateGasWithType('fija')" 
                                class="w-full px-6 py-3 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition"
                            >
                                üîµ Tarifa Fija
                            </button>
                            <button 
                                onclick="calculateGasWithType('indexada')" 
                                class="w-full px-6 py-3 bg-orange-500 text-white rounded-lg font-bold hover:bg-orange-600 transition"
                            >
                                üü† Tarifa Indexada
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button 
                            onclick="closeGasModal()" 
                            class="flex-1 px-6 py-3 bg-slate-200 text-slate-700 rounded-lg font-bold hover:bg-slate-300 transition"
                        >
                            Cancelar
                        </button>
                        <button 
                            id="gas-calculate-btn"
                            onclick="proceedToGasCalculation()" 
                            class="flex-1 px-6 py-3 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600 transition"
                        >
                            Continuar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PANTALLA 4: Resultados GAS -->
        <div id="screen-gas-results" class="screen">
            <div class="fade-in flex flex-col items-center justify-center min-h-[60vh] py-8">
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-red-500">
                    <button onclick="goToGas()" style="background:none;border:none;padding:0.5rem;margin-bottom:1rem;cursor:pointer;" class="text-sm text-slate-500 hover:text-red-600 flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        Volver
                    </button>
                    
                    <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600 shadow-inner">
                        <span class="text-4xl">üî•</span>
                    </div>
                    <h2 class="text-3xl font-black text-red-600 mb-2 text-center">Resultados GAS</h2>
                    <p class="text-slate-500 mb-6 text-center" id="gas-results-subtitle">Comparativa de tarifas</p>
                    
                    <!-- Contenedor de resultados -->
                    <div id="gas-results-container" class="mt-6">
                        <!-- Los resultados se insertar√°n aqu√≠ -->
                    </div>
                    
                    <!-- NUEVO: Bot√≥n para solicitar mejora cuando no hay ahorro en GAS -->
                    <div id="gas-request-improvement-container" style="display:none;" class="mt-6">
                        <button id="gas-request-improvement-btn" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                            <span id="gas-request-improvement-text">SOLICITAR MEJORA A DRK</span>
                        </button>
                    </div>
                    
                    <!-- NUEVO: Bot√≥n para a√±adir a DUAL (solo visible en modo DUAL) -->
                    <div id="gas-dual-button-container" style="display:none;" class="mt-6">
                        <button onclick="addCurrentGasToDual()" class="w-full text-white font-bold py-4 px-6 rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3" style="background: linear-gradient(135deg, #0ea5e9 0%, #84cc16 100%);">
                            <span class="text-2xl">‚ö°üî•</span>
                            <span>A√ëADIR A DUAL</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ========================================
             NUEVO M√ìDULO DUAL (ELECTRICIDAD + GAS)
             ======================================== -->
        
        <!-- PANTALLA DUAL: Gesti√≥n de suministros -->
        <div id="screen-dual" class="screen">
            
            <div class="fade-in flex flex-col items-center justify-center min-h-[60vh] py-8">
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-drk-500" style="border-image: linear-gradient(135deg, #0ea5e9 0%, #84cc16 100%) 1;">
                    <!-- Encabezado -->
                    <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner" style="background: linear-gradient(135deg, #f0f9ff 0%, #f7fee7 100%);">
                        <span class="text-4xl">‚ö°üî•</span>
                    </div>
                    <h2 id="dual-title" class="text-3xl font-black mb-2 text-center" style="background: linear-gradient(135deg, #0ea5e9 0%, #84cc16 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">DUAL</h2>
                    <p id="dual-subtitle" class="text-slate-500 mb-6 text-center">Gestiona m√∫ltiples suministros de Electricidad y Gas</p>
                    
                    <!-- Lista de suministros a√±adidos -->
                    <div id="dual-supplies-list" class="mb-6">
                        <p class="text-sm font-bold text-slate-700 mb-3"><span id="dual-supplies-label">Suministros a√±adidos:</span> <span id="dual-supplies-count" class="text-drk-600">0</span></p>
                        <div id="dual-supplies-container" class="space-y-2">
                            <!-- Los suministros se a√±adir√°n aqu√≠ din√°micamente -->
                        </div>
                    </div>
                    
                    <!-- Botones de acci√≥n -->
                    <div class="space-y-3">
                        <button id="dual-add-btn" onclick="dualAddSupply()" class="w-full py-4 text-white font-bold rounded-xl shadow-lg transition-all" style="background: linear-gradient(135deg, #0ea5e9 0%, #84cc16 100%);">
                            + A√±adir Suministro
                        </button>
                        
                        <button id="dual-calculate-btn" onclick="dualCalculate()" class="w-full py-4 bg-slate-600 hover:bg-slate-700 text-white font-bold rounded-xl shadow-lg transition-all" disabled>
                            Calcular Comparativa Global
                        </button>
                        
                        <button id="dual-reset-btn" onclick="dualReset()" class="w-full py-2 text-sm text-slate-500 hover:text-slate-700 transition-colors">
                            Limpiar todo
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PANTALLA DUAL: A√±adir tipo de suministro -->
        <div id="screen-dual-add-type" class="screen">
            <button onclick="backToDualManager()" style="background:none;border:none;padding:0.5rem;margin-bottom:1rem;cursor:pointer;" class="text-sm text-slate-500 hover:text-drk-600 flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                Volver
            </button>
            
            <div class="fade-in flex flex-col items-center justify-center min-h-[60vh] py-8">
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-drk-500">
                    <!-- Icono MULTICUPS -->
                    <div class="w-16 h-16 bg-drk-50 rounded-full flex items-center justify-center mx-auto mb-4 text-drk-600 shadow-inner">
                        <svg class="w-8 h-8" viewBox="0 0 100 100" fill="none">
                            <style>.drk-ring{fill:none;stroke-width:10;stroke-linecap:round;}</style>
                            <circle class="drk-ring" cx="45" cy="45" r="35" stroke="#E50000"/>
                            <circle class="drk-ring" cx="55" cy="55" r="35" stroke="#FFCC00"/>
                            <circle class="drk-ring" cx="45" cy="55" r="35" stroke="#0079C1"/>
                            <circle class="drk-ring" cx="55" cy="45" r="35" stroke="#00A859"/>
                        </svg>
                    </div>
                    
                    <h2 class="text-3xl font-black text-drk-900 mb-2 text-center">MULTICUPS</h2>
                    <p class="text-slate-500 mb-6 text-center">Selecciona el tipo de contrato que deseas a√±adir.</p>
                    
                    <!-- Secci√≥n ELECTRICIDAD -->
                    <div class="mb-6">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-2xl">‚ö°</span>
                            <h3 class="text-lg font-bold text-slate-800">ELECTRICIDAD</h3>
                        </div>
                        <div class="space-y-3">
                            <button onclick="dualSelectTariff('electricidad', '2.0TD')" class="tariff-select-btn group border-drk-300 hover:border-drk-500 w-full">
                                <div class="icon-wrapper bg-drk-50 text-drk-600 group-hover:bg-drk-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                                </div>
                                <div class="text-left flex-1">
                                    <span class="text-lg font-bold text-drk-900">2.0 TD</span>
                                    <span class="block text-xs text-slate-500">Permite Esc√°ner QR, Imagen y Entrada Manual</span>
                                </div>
                                <span class="arrow-icon group-hover:text-drk-500">&rarr;</span>
                            </button>
                            
                            <button onclick="dualSelectTariff('electricidad', '3.0TD')" class="tariff-select-btn group border-drk-300 hover:border-drk-500 w-full">
                                <div class="icon-wrapper bg-drk-50 text-drk-600 group-hover:bg-drk-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><rect width="16" height="20" x="4" y="2" rx="2" ry="2"></rect><path d="M9 22v-4h6v4"></path><path d="M8 6h.01"></path><path d="M16 6h.01"></path><path d="M12 6h.01"></path><path d="M12 10h.01"></path><path d="M12 14h.01"></path><path d="M16 10h.01"></path><path d="M16 14h.01"></path><path d="M8 10h.01"></path><path d="M8 14h.01"></path></svg>
                                </div>
                                <div class="text-left flex-1">
                                    <span class="text-lg font-bold text-drk-900">3.0 TD</span>
                                    <span class="block text-xs text-slate-500">Solo Entrada de Datos Manual</span>
                                </div>
                                <span class="arrow-icon group-hover:text-drk-500">&rarr;</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Secci√≥n GAS -->
                    <div>
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-2xl">üî•</span>
                            <h3 class="text-lg font-bold text-slate-800">GAS</h3>
                        </div>
                        <div class="space-y-2">
                            <button onclick="dualSelectTariff('gas', 'RL1')" class="w-full flex items-center gap-3 p-3 bg-white border-2 border-slate-200 hover:border-orange-400 hover:bg-orange-50 rounded-lg transition-all">
                                <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                                    <span class="text-orange-600 font-bold">1</span>
                                </div>
                                <div class="text-left flex-1">
                                    <span class="font-bold text-slate-800">RL1</span>
                                    <span class="block text-xs text-slate-500">Regulaci√≥n de Gas - Nivel 1</span>
                                </div>
                                <span class="text-slate-400">&rarr;</span>
                            </button>
                            
                            <button onclick="dualSelectTariff('gas', 'RL2')" class="w-full flex items-center gap-3 p-3 bg-white border-2 border-slate-200 hover:border-orange-400 hover:bg-orange-50 rounded-lg transition-all">
                                <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                                    <span class="text-orange-600 font-bold">2</span>
                                </div>
                                <div class="text-left flex-1">
                                    <span class="font-bold text-slate-800">RL2</span>
                                    <span class="block text-xs text-slate-500">Regulaci√≥n de Gas - Nivel 2</span>
                                </div>
                                <span class="text-slate-400">&rarr;</span>
                            </button>
                            
                            <button onclick="dualSelectTariff('gas', 'RL3')" class="w-full flex items-center gap-3 p-3 bg-white border-2 border-slate-200 hover:border-orange-400 hover:bg-orange-50 rounded-lg transition-all">
                                <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                                    <span class="text-orange-600 font-bold">3</span>
                                </div>
                                <div class="text-left flex-1">
                                    <span class="font-bold text-slate-800">RL3</span>
                                    <span class="block text-xs text-slate-500">Regulaci√≥n de Gas - Nivel 3</span>
                                </div>
                                <span class="text-slate-400">&rarr;</span>
                            </button>
                            
                            <button onclick="dualSelectTariff('gas', 'RL4')" class="w-full flex items-center gap-3 p-3 bg-white border-2 border-slate-200 hover:border-orange-400 hover:bg-orange-50 rounded-lg transition-all">
                                <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                                    <span class="text-orange-600 font-bold">4</span>
                                </div>
                                <div class="text-left flex-1">
                                    <span class="font-bold text-slate-800">RL4</span>
                                    <span class="block text-xs text-slate-500">Regulaci√≥n de Gas - Nivel 4</span>
                                </div>
                                <span class="text-slate-400">&rarr;</span>
                            </button>
                            
                            <button onclick="dualSelectTariff('gas', 'RL5')" class="w-full flex items-center gap-3 p-3 bg-white border-2 border-slate-200 hover:border-orange-400 hover:bg-orange-50 rounded-lg transition-all">
                                <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                                    <span class="text-orange-600 font-bold">5</span>
                                </div>
                                <div class="text-left flex-1">
                                    <span class="font-bold text-slate-800">RL5</span>
                                    <span class="block text-xs text-slate-500">Regulaci√≥n de Gas - Nivel 5</span>
                                </div>
                                <span class="text-slate-400">&rarr;</span>
                            </button>
                            
                            <button onclick="dualSelectTariff('gas', 'RL6')" class="w-full flex items-center gap-3 p-3 bg-white border-2 border-slate-200 hover:border-orange-400 hover:bg-orange-50 rounded-lg transition-all">
                                <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                                    <span class="text-orange-600 font-bold">6</span>
                                </div>
                                <div class="text-left flex-1">
                                    <span class="font-bold text-slate-800">RL6</span>
                                    <span class="block text-xs text-slate-500">Regulaci√≥n de Gas - Nivel 6</span>
                                </div>
                                <span class="text-slate-400">&rarr;</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PANTALLA DUAL: Resultados globales -->
        <div id="screen-dual-results" class="screen">
            <button onclick="backToDualManager()" style="background:none;border:none;padding:0.5rem;margin-bottom:1rem;cursor:pointer;" class="text-sm text-slate-500 hover:text-drk-600 flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                Volver
            </button>
            
            <div class="fade-in flex flex-col items-center justify-center min-h-[60vh] py-8">
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-drk-500">
                    <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner" style="background: linear-gradient(135deg, #f0f9ff 0%, #f7fee7 100%);">
                        <span class="text-4xl">‚ö°üî•</span>
                    </div>
                    <h2 class="text-3xl font-black mb-2 text-center" style="background: linear-gradient(135deg, #0ea5e9 0%, #84cc16 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">COMPARATIVA GLOBAL</h2>
                    <p class="text-slate-500 mb-6 text-center">Resultados de <span id="dual-results-count" class="font-bold">0</span> suministros</p>
                    
                    <!-- Contenedor de resultados -->
                    <div id="dual-results-container" class="mt-6 space-y-6">
                        <!-- Los resultados se insertar√°n aqu√≠ -->
                    </div>
                    
                    <!-- Botones de descarga -->
                    <div class="mt-6 flex flex-col gap-3">
                        <!-- NUEVO: Bot√≥n para solicitar mejora cuando NO hay ahorro en DUAL -->
                        <div id="dual-request-improvement-container" style="display:none;">
                            <button id="dual-request-improvement-btn" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mb-3">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                <span id="dual-request-improvement-text">SOLICITAR MEJORA A DRK</span>
                            </button>
                        </div>
                        
                        <button onclick="showClientDataModal()" class="w-full py-3 bg-slate-700 hover:bg-slate-800 text-white rounded-xl font-semibold transition-all text-sm shadow-md flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                            </svg>
                            Descargar PDF Global
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- NUEVO: PANTALLA DUAL - Confirmaci√≥n de suministro -->
        <div id="screen-dual-confirm" class="screen">
            <button onclick="dualCancelAdd()" style="background:none;border:none;padding:0.5rem;margin-bottom:1rem;cursor:pointer;" class="text-sm text-slate-500 hover:text-drk-600 flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                Cancelar
            </button>
            
            <div class="fade-in flex flex-col items-center justify-center min-h-[60vh] py-8">
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-drk-500">
                    <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner" style="background: linear-gradient(135deg, #f0f9ff 0%, #f7fee7 100%);">
                        <span class="text-4xl" id="dual-confirm-icon">‚ö°</span>
                    </div>
                    <h2 class="text-2xl font-black mb-2 text-center text-drk-900">Suministro Calculado</h2>
                    <p class="text-slate-500 mb-6 text-center">¬øDeseas a√±adir este suministro a tu comparativa DUAL?</p>
                    
                    <!-- Resumen del suministro -->
                    <div class="bg-slate-50 rounded-xl p-4 mb-6">
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-600">Tipo:</span>
                                <span class="font-bold text-slate-900" id="dual-confirm-type">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Tarifa:</span>
                                <span class="font-bold text-slate-900" id="dual-confirm-tariff">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Consumo:</span>
                                <span class="font-bold text-slate-900" id="dual-confirm-consumption">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">D√≠as:</span>
                                <span class="font-bold text-slate-900" id="dual-confirm-days">-</span>
                            </div>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-slate-200">
                            <div class="flex justify-between mb-2">
                                <span class="text-slate-600">DRK (anual):</span>
                                <span class="font-bold text-drk-600" id="dual-confirm-drk">-</span>
                            </div>
                            <div class="flex justify-between mb-2">
                                <span class="text-slate-600">Power Cup (anual):</span>
                                <span class="font-bold text-powercup-600" id="dual-confirm-powercup">-</span>
                            </div>
                            <!-- NUEVO: Mostrar ahorro anual -->
                            <div class="mt-3 pt-3 border-t-2 border-green-200 bg-green-50 rounded-lg p-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-green-700 font-semibold">${tr("TU AHORRO ANUAL ESTIMADO:")}</span>
                                    <span class="font-black text-2xl text-green-600" id="dual-confirm-savings">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones de acci√≥n -->
                    <div class="space-y-3">
                        <button onclick="dualConfirmAdd()" class="w-full py-4 text-white font-bold rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3" style="background: linear-gradient(135deg, #0ea5e9 0%, #84cc16 100%);">
                            <span class="text-2xl">‚úì</span>
                            <span>S√ç, A√ëADIR A DUAL</span>
                        </button>
                        
                        <button onclick="dualCancelAdd()" class="w-full py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold rounded-xl transition-all">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- MODAL: Datos del Comercial y Cliente (para PDF DUAL) -->
        <div id="client-data-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md border-t-4 border-blue-500 max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <h3 class="text-2xl font-black text-blue-600 mb-2 text-center">Datos del Comercial y Cliente</h3>
                    <p class="text-sm text-slate-500 mb-4 text-center">Rellene sus datos. El resumen profesional de la oferta se copiar√° a su portapapeles (Ctrl+V).</p>
                    
                    <div class="space-y-4">
                        <!-- C√≥digo comercial -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">
                                C√ìDIGO COMERCIAL (Obligatorio)
                            </label>
                            <input 
                                type="text" 
                                id="comercial-code" 
                                placeholder="Ej: D=00" 
                                class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none"
                            >
                        </div>
                        
                        <!-- Nombre del cliente -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">
                                Nombre Cliente
                            </label>
                            <input 
                                type="text" 
                                id="client-name" 
                                placeholder="Nombre completo del cliente" 
                                class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none"
                            >
                        </div>
                        
                        <!-- Tel√©fono -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">
                                Tel√©fono
                            </label>
                            <input 
                                type="tel" 
                                id="client-phone" 
                                placeholder="Tel√©fono del cliente" 
                                class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none"
                            >
                        </div>
                        
                        <!-- Email -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">
                                Email
                                <svg class="inline ml-1 w-5 h-5" viewBox="0 0 24 24" fill="#9333ea">
                                    <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                                </svg>
                            </label>
                            <input 
                                type="email" 
                                id="client-email" 
                                placeholder="email@ejemplo.com" 
                                class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none"
                            >
                        </div>
                        
                        <!-- Nota para iPhone -->
                        <div class="bg-amber-50 border-2 border-amber-200 rounded-lg p-4">
                            <div class="flex items-start gap-3">
                                <span class="text-2xl">‚ö†Ô∏è</span>
                                <div class="text-sm">
                                    <p class="font-bold text-amber-900 mb-2">NOTA PARA USUARIOS DE iPHONE:</p>
                                    <p class="text-amber-800 mb-2">Si copias desde iPhone, el formato puede no verse correctamente en algunos correos. Para mejor resultado:</p>
                                    <ul class="text-amber-800 space-y-1 ml-4">
                                        <li>‚úì Copia desde un <strong>ordenador</strong></li>
                                        <li>‚úì O usa <strong>Gmail/Outlook web</strong> en el navegador m√≥vil</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones -->
                    <div class="mt-6 space-y-3">
                        <button onclick="copyDualHTML()" class="w-full py-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>
                            </svg>
                            <span data-i18n="üìã COPIAR COMPARATIVO (HTML)">üìã COPIAR COMPARATIVO (HTML)</span>
                        </button>
                        
                        <button onclick="generateDualPDF()" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                            <span data-i18n="üìÑ CREAR PDF COMPARATIVO">üìÑ CREAR PDF COMPARATIVO</span>
                        </button>
                        
                        <button onclick="closeClientDataModal()" class="w-full py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold rounded-xl transition-all">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- FIN M√ìDULO DUAL -->
        
        <!-- 2. MultiCups Saga View (Intermediate Step) -->
        <div id="multicups-saga-view" class="fade-in hidden flex flex-col items-center justify-center min-h-[60vh] py-8">
            <button onclick="goBackFromMultiCupsSagaView()" class="mb-4 text-sm text-slate-500 hover:text-drk-600 flex items-center gap-1">
                &larr; Volver a selecci√≥n
            </button>
            
            <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-drk-500" id="multicups-saga-card">
                <div id="initial-icon-bg-saga" class="w-16 h-16 bg-drk-50 rounded-full flex items-center justify-center mx-auto mb-4 text-drk-600 shadow-inner">
                    <svg class="w-8 h-8" viewBox="0 0 100 100" fill="none">
                        <style>.drk-ring{fill:none;stroke-width:10;stroke-linecap:round;}</style>
                        <circle class="drk-ring" cx="45" cy="45" r="35" stroke="#E50000"/>
                        <circle class="drk-ring" cx="55" cy="55" r="35" stroke="#FFCC00"/>
                        <circle class="drk-ring" cx="45" cy="55" r="35" stroke="#0079C1"/>
                        <circle class="drk-ring" cx="55" cy="45" r="35" stroke="#00A859"/>
                    </svg>
                </div>
                
                <h2 class="text-3xl font-black text-drk-900 mb-2 text-center">MULTICUPS</h2>
                <p class="text-slate-500 mb-6 text-center" id="saga-instruction-text">
                    Selecciona el tipo de contrato que deseas a√±adir.<br>
                    Total de suministros actuales: <span class="font-bold text-drk-800" id="saga-total-cups">0</span>
                </p>
                
                <p id="loading-status-saga" class="text-center text-sm text-slate-400 mt-4 mb-4">Cargando tarifas 2.0TD y 3.0TD...</p>

                <div id="saga-button-wrapper" class="w-full space-y-4 pt-4 border-t border-slate-200">
                    <button onclick="selectMultiCupType('2.0TD')" class="tariff-select-btn group border-drk-300 hover:border-drk-500">
                        <div class="icon-wrapper bg-drk-50 text-drk-600 group-hover:bg-drk-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                        </div>
                        <div class="text-left">
                            <span class="text-lg font-bold text-drk-900">2.0 TD</span>
                            <span class="block text-xs text-slate-500">Permite Esc√°ner QR, Imagen y Entrada Manual</span>
                        </div>
                        <span class="arrow-icon group-hover:text-drk-500">&rarr;</span>
                    </button>
                </div>
                
                <button id="multicups-finalize-btn-saga" onclick="finalizeMultiCups()" class="w-full bg-cta-green-500 hover:bg-cta-green-600 text-white font-bold py-4 rounded-2xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mt-8 hidden">
                    <span id="finalize-btn-text">FINALIZAR Y COMPARAR</span> (<span id="saga-finalize-count">0</span> <span id="finalize-suministros-text">Suministros</span>)
                </button>
            </div>
        </div>

        <!-- 3. Initial Input View (Scan/Manual) -->
        <div id="initial-view" class="fade-in hidden">
            <button onclick="currentTariffType === 'MULTICUPS' ? showMultiCupsSagaView() : goBackFromInitialView()" class="mb-4 text-sm text-slate-500 hover:text-drk-600 flex items-center gap-1">
                &larr; Volver <span id="back-button-label">a selecci√≥n</span>
            </button>

            <div id="initial-card" class="bg-white p-6 rounded-3xl shadow-xl text-center border-t-4 border-drk-500 relative">
                <div id="tariff-badge" class="absolute top-4 right-4 bg-drk-500 px-2 py-1 rounded-full text-white text-xs font-bold shadow-md">
                    <span id="current-tariff-label">2.0TD</span> - <span id="tariff-display-badge">0</span>
                </div>
                
                <!-- VERSION -->
                <div class="absolute bottom-2 right-2 text-xs text-gray-400">
                    v2024.12.20
                </div>
                
                
                <div id="initial-icon-bg" class="w-16 h-16 bg-drk-50 rounded-full flex items-center justify-center mx-auto mb-4 text-drk-600"></div>
                
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Analizar Factura</h2>
                <p class="text-slate-500 mb-6" id="scan-instruction-text">Escanea el c√≥digo QR o introduce datos manualmente.</p>
                
                <div id="qr-buttons-container">
                    <button id="start-scan-btn" class="w-full bg-gradient-to-r from-drk-600 to-drk-800 hover:from-drk-700 hover:to-drk-900 text-white font-bold py-4 px-6 rounded-2xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mb-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.125 3h3.75a2 2 0 011.664.89l.812 1.22a2 2 0 001.664.89H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span>ESCANEAR QR AHORA</span>
                    </button>
                    
                    <input type="file" id="image-file-input" accept="image/*" class="hidden">
                    <button id="upload-menu-btn" class="w-full bg-drk-50 hover:bg-drk-100 text-drk-800 font-bold py-3 px-6 rounded-xl shadow-sm transform transition active:scale-95 flex items-center justify-center gap-3" style="display: none;">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <span>OTRAS OPCIONES DE CAPTURA</span>
                    </button>
                </div>
                <button id="manual-input-btn" class="w-full bg-drk-50 hover:bg-drk-100 text-drk-800 font-bold py-3 px-6 rounded-xl shadow-sm transform transition active:scale-95 flex items-center justify-center gap-3 mt-3" style="display: none;">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    <span>DATOS A MANO</span>
                </button>

                <button id="multicups-finalize-btn-main" class="hidden"></button>

                <p id="loading-status" class="text-center text-sm text-slate-400 mt-4 hidden">Cargando tarifas...</p>

            </div>
        </div>

        <!-- 4. Scanner View -->
        <div id="scanner-view" class="hidden flex-col h-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-slate-700">Escaneando...</h2>
                <button id="stop-scan-btn" class="text-red-500 font-bold text-sm bg-red-50 px-3 py-1 rounded-lg">Cancelar</button>
            </div>
            
            <!-- Indicador de intensidad de escaneo -->
            <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-3 mb-3">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-bold text-blue-800">Potencia de detecci√≥n:</span>
                    <span id="scan-power-label" class="text-xs font-bold text-blue-600">Est√°ndar</span>
                </div>
                <div class="w-full bg-blue-100 rounded-full h-2 overflow-hidden">
                    <div id="scan-power-bar" class="bg-gradient-to-r from-blue-400 to-blue-600 h-full transition-all duration-500" style="width: 20%"></div>
                </div>
            </div>
            
            <div class="relative w-full aspect-[3/4] bg-black rounded-2xl overflow-hidden shadow-2xl mb-4">
                <div id="interactive" class="viewport w-full h-full"></div>
                <div id="scanner-guide" class="absolute inset-0 border-2 border-white opacity-30 m-8 rounded-lg pointer-events-none"></div>
                
                <!-- Marco Google Lens - Aparece al detectar -->
                <div id="qr-detection-frame" class="absolute hidden pointer-events-none" style="border: 4px solid #4285f4; box-shadow: 0 0 30px rgba(66, 133, 244, 0.8), inset 0 0 20px rgba(66, 133, 244, 0.3); border-radius: 16px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease-in-out; z-index: 100; opacity: 0;">
                    <!-- Esquinas blancas m√°s brillantes -->
                    <div class="absolute" style="top: -4px; left: -4px; width: 32px; height: 32px; border-top: 5px solid white; border-left: 5px solid white; border-radius: 16px 0 0 0; box-shadow: 0 0 10px rgba(255,255,255,0.8);"></div>
                    <div class="absolute" style="top: -4px; right: -4px; width: 32px; height: 32px; border-top: 5px solid white; border-right: 5px solid white; border-radius: 0 16px 0 0; box-shadow: 0 0 10px rgba(255,255,255,0.8);"></div>
                    <div class="absolute" style="bottom: -4px; left: -4px; width: 32px; height: 32px; border-bottom: 5px solid white; border-left: 5px solid white; border-radius: 0 0 0 16px; box-shadow: 0 0 10px rgba(255,255,255,0.8);"></div>
                    <div class="absolute" style="bottom: -4px; right: -4px; width: 32px; height: 32px; border-bottom: 5px solid white; border-right: 5px solid white; border-radius: 0 0 16px 0; box-shadow: 0 0 10px rgba(255,255,255,0.8);"></div>
                    
                    <!-- L√≠nea de escaneo M√ÅS VISIBLE -->
                    <div id="scan-line" class="absolute left-0 right-0" style="top: 0%; height: 3px; background: linear-gradient(90deg, transparent, #4285f4, #4285f4, transparent); box-shadow: 0 0 15px #4285f4, 0 0 30px rgba(66, 133, 244, 0.6); z-index: 110; animation: scanLineMove 2s ease-in-out infinite;"></div>
                </div>
                
                <!-- Bot√≥n de captura flotante estilo Google Lens -->
                <button id="capture-photo-btn" class="absolute bottom-6 left-1/2 transform -translate-x-1/2 w-20 h-20 rounded-full bg-white flex items-center justify-center shadow-2xl transition-all duration-300 hover:scale-110 active:scale-95" style="z-index: 200;">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center">
                        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </div>
                </button>
                
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none"><div class="w-64 h-1 bg-red-500 opacity-30"></div></div>
            </div>
            
            <style>
                @keyframes scanLineMove {
                    0% { 
                        top: 0%; 
                        opacity: 0; 
                    }
                    5% { 
                        opacity: 1; 
                    }
                    50% { 
                        top: 100%; 
                        opacity: 1; 
                    }
                    55% {
                        opacity: 0;
                    }
                    100% { 
                        top: 100%; 
                        opacity: 0; 
                    }
                }
                
                /* Animaci√≥n suave para el bot√≥n (sin parpadeo agresivo) */
                @keyframes buttonGlow {
                    0%, 100% { 
                        box-shadow: 0 0 20px rgba(34, 197, 94, 0.6), 0 0 40px rgba(34, 197, 94, 0.4);
                        transform: scale(1);
                    }
                    50% { 
                        box-shadow: 0 0 30px rgba(34, 197, 94, 0.8), 0 0 60px rgba(34, 197, 94, 0.6);
                        transform: scale(1.05);
                    }
                }
                
                .button-detected {
                    animation: buttonGlow 1.5s ease-in-out infinite !important;
                    box-shadow: 0 0 20px rgba(34, 197, 94, 0.6) !important;
                }
            </style>
            <p class="text-center text-sm text-slate-600 mb-2 font-semibold">üëÜ Pulsa la lupa cuando veas el marco azul</p>
        </div>

        <!-- 5. Results View -->
        <div id="results-view" class="hidden animate-fade-in-up">
            <!-- Banner de Empresa -->
            <div id="company-banner" class="mb-8 rounded-2xl overflow-hidden shadow-lg">
                <!-- El contenido del banner se generar√° din√°micamente seg√∫n la marca activa -->
            </div>
            
            <div class="text-center mb-6">
                <div class="inline-flex items-center gap-2 bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold mb-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> An√°lisis Completado
                </div>
                <h2 class="2xl font-black text-slate-800">Resultado del Estudio</h2>
                <p class="text-sm text-slate-500" id="results-cups-list">CUPS: <span class="font-mono text-slate-700" id="cups-value"></span></p>
            </div>

            <div id="result-card" class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-100 mb-8 relative">
                <div id="result-header" class="bg-gradient-to-r from-drk-800 to-drk-600 p-6 text-white text-center relative overflow-hidden">
                    <p class="uppercase tracking-widest text-xs font-semibold text-drk-100 mb-1" id="best-offer-label"${tr("LA MEJOR OPCI√ìN PARA TI ES")}</p>
                    <h2 id="best-offer-name" class="text-2xl md:text-3xl font-extrabold leading-tight mb-2">Nombre Tarifa</h2>
                    <!-- offer.description del CSV -->
                    <p id="best-offer-desc" class="text-drk-100 text-sm opacity-90">Descripci√≥n</p> 
                </div>
                <div class="p-6">
                    <div class="flex flex-col gap-6">
                        <div class="text-center">
                            <p id="savings-label" class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Tu Ahorro Anual Estimado</p>
                            <p id="savings-estimate" class="text-5xl font-black text-cta-green-500 tracking-tight">- ‚Ç¨</p>
                        </div>
                        <div id="price-columns" class="w-full grid grid-cols-2 text-center text-sm border-b pb-4 border-slate-100">
                            <div class="border-r border-slate-200 pr-2">
                                <p class="text-slate-400 text-xs font-semibold mb-2 uppercase"${tr("TU FACTURA ACTUAL")}</p>
                                <div class="mb-3">
                                    <p class="text-xl font-bold text-cta-red-500 line-through decoration-cta-red-500/50 decoration-2" id="old-period-cost-display">0,00 ‚Ç¨</p>
                                    <p class="text-xs text-slate-500 font-medium" id="old-period-days-label"${tr("Total Periodo")}</p> 
                                </div>
                                <div><p class="text-lg font-bold text-cta-red-500 line-through decoration-cta-red-500/50 decoration-2" id="old-annual-cost-display">0,00 ‚Ç¨/a√±o</p></div>
                            </div>
                            <div class="pl-2">
                                <p class="text-drk-800 text-xs font-semibold mb-2 uppercase" id="new-cost-label"${tr("TU NUEVO COSTE DRK")}</p>
                                <div class="mb-3">
                                    <p class="text-2xl font-black text-drk-900" id="new-monthly-cost-display">0,00 ‚Ç¨/mes</p>
                                    <p class="text-xs text-drk-800 font-medium" id="monthly-label"${tr("Estimado Mensual")}</p>
                                </div>
                                <div><p class="text-2xl font-black text-drk-900" id="new-annual-cost-display">0,00 ‚Ç¨/a√±o</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-3 mb-8">
                <!-- NUEVO: Bot√≥n para a√±adir a DUAL (solo visible en modo DUAL) -->
                <button id="add-to-dual-btn" style="display:none;" onclick="addCurrentToDual()" class="w-full text-white font-bold py-4 px-6 rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mb-3" style="background: linear-gradient(135deg, #0ea5e9 0%, #84cc16 100%);">
                    <span class="text-2xl">‚ö°üî•</span>
                    <span>A√ëADIR A DUAL</span>
                </button>
                
                <button id="send-offer-btn" class="w-full bg-cta-red-500 hover:bg-cta-red-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mb-3" style="display: none;">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-2m-4-4l-4 4m0 0l-4-4m4 4V5"></path></svg>
                    <span>COPIAR COMPARATIVO</span>
                </button>
                
                <!-- NUEVO: Bot√≥n para solicitar mejora cuando no hay ahorro -->
                <button id="request-improvement-btn" style="display:none;" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mb-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    <span id="request-improvement-text">SOLICITAR MEJORA A DRK</span>
                </button>
                
                <button onclick="document.getElementById('details-container').classList.toggle('hidden')" class="text-center text-drk-800 font-bold text-sm hover:underline flex items-center justify-center gap-1" id="details-toggle-btn" style="display: none;"><span id="details-toggle-text"></span></button>
            </div>
            
            <!-- PESTA√ëAS HORIZONTALES -->
            <div class="mb-6">
                <div class="flex gap-2 border-b-2 border-slate-200 mb-4 overflow-x-auto">
                    <button onclick="switchResultTab('tab-resumen')" id="btn-tab-resumen" class="tab-result-btn px-6 py-3 font-bold text-sm transition-all border-b-4 border-transparent hover:border-drk-400 whitespace-nowrap active" data-i18n="Resumen">
                        Resumen
                    </button>
                    <button onclick="switchResultTab('tab-precios')" id="btn-tab-precios" class="tab-result-btn px-6 py-3 font-bold text-sm transition-all border-b-4 border-transparent hover:border-drk-400 whitespace-nowrap" data-i18n="Precios">
                        Precios
                    </button>
                    <button onclick="switchResultTab('tab-calculo')" id="btn-tab-calculo" class="tab-result-btn px-6 py-3 font-bold text-sm transition-all border-b-4 border-transparent hover:border-drk-400 whitespace-nowrap" data-i18n="C√°lculo Oficial">
                        C√°lculo Oficial
                    </button>
                </div>
                
                <!-- Contenido de pesta√±as -->
                <div id="tab-resumen" class="tab-result-content">
                    <div id="resumen-content" class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"></div>
                </div>
                
                <div id="tab-precios" class="tab-result-content hidden">
                    <div id="precios-content" class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"></div>
                </div>
                
                <div id="tab-calculo" class="tab-result-content hidden">
                    <div id="calculo-content" class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"></div>
                </div>
            </div>
            
            <div id="details-container" class="hidden space-y-6">
            </div>

            <div class="mt-8">
                <button onclick="resetToLanding()" class="w-full bg-white border-2 border-slate-200 hover:border-drk-500 text-slate-600 hover:text-drk-800 font-bold py-4 rounded-xl transition flex items-center justify-center gap-2" id="reset-button-text">
                    Realizar Nueva Comparaci√≥n
                </button>
            </div>
        </div>

        <!-- 6. Manual Input Modal -->
        <div id="manual-input-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-drk-800 mb-4" id="manual-modal-title">Entrada de Datos Manual</h3>
                
                <div id="manual-tariff-selector-wrapper" class="hidden mb-4">
                    <label for="manual-input-tariff-select" class="block text-sm font-medium text-slate-700 text-left mb-1">Tipo de Tarifa</label>
                    <select id="manual-input-tariff-select" onchange="toggleMultiCupsInputPeriods(this.value, 'input')" class="w-full p-3 rounded-lg border border-slate-300 text-sm font-bold focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <option value="2.0TD">2.0 TD (Hogar/Negocio)</option>
                        <option value="3.0TD">3.0 TD (Industria/Gran Consumo)</option>
                    </select>
                </div>

                <div class="border-b border-slate-200 pb-3 mb-4 bg-slate-50 p-3 rounded-lg">
                    <h4 id="multicups-datos-generales" class="font-bold text-slate-800 mb-2">Datos Generales</h4>
                    <input type="text" id="input-cups" placeholder="N√∫mero CUPS" class="w-full mb-3 p-3 rounded-lg border border-slate-300 text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                    <input type="number" id="input-billing-days" placeholder="D√≠as Facturados" class="w-full p-3 rounded-lg border border-slate-300 text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                </div>
                
                <div class="border-b border-slate-200 pb-3 mb-3">
                    <h4 id="multicups-potencias" class="font-bold text-slate-800 mb-2">Potencias (kW)</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" step="0.01" id="input-p1-kw" placeholder="P1" class="p-2 border rounded text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="0.01" id="input-p2-kw" placeholder="P2" class="p-2 border rounded text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="0.01" id="input-p3-kw" placeholder="P3" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="0.01" id="input-p4-kw" placeholder="P4" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="0.01" id="input-p5-kw" placeholder="P5" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="0.01" id="input-p6-kw" placeholder="P6" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                    </div>
                </div>
                
                <div class="border-b border-slate-200 pb-3 mb-3">
                    <h4 id="multicups-energia" class="font-bold text-slate-800 mb-2">Energ√≠a (kWh)</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" step="1" id="input-e1-kwh" placeholder="E1" class="p-2 border rounded text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="1" id="input-e2-kwh" placeholder="E2" class="p-2 border rounded text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="1" id="input-e3-kwh" placeholder="E3" class="p-2 border rounded text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="1" id="input-e4-kwh" placeholder="E4" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="1" id="input-e5-kwh" placeholder="E5" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="1" id="input-e6-kwh" placeholder="E6" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                    </div>
                </div>

                <div class="pb-3 mb-3">
                    <input type="number" step="0.01" id="input-total-bill" placeholder="Total Factura (‚Ç¨)" class="w-full mb-4 p-3 rounded-lg border border-slate-300 text-sm font-bold focus:outline-none focus:border-2 focus:focus:border-drk-500">
                </div>
                
                <button id="execute-manual-input-btn" class="w-full bg-drk-500 hover:bg-drk-600 text-white font-bold py-3 rounded-xl shadow-md mb-3">CALCULAR</button>
                <button id="cancel-manual-input-btn" onclick="closeManualInputModal()" class="w-full bg-slate-200 text-slate-600 font-bold py-3 rounded-xl text-sm">Cancelar</button>
            </div>
        </div>

        <!-- 7. QR Confirmation Modal (MultiCups) -->
        <div id="qr-confirm-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full max-h-[90vh] overflow-y-auto">
                <h3 id="qr-confirm-title" class="text-xl font-bold text-drk-800 mb-2">Confirmar Suministro</h3>
                <p id="qr-confirm-subtitle" class="text-sm text-slate-500 mb-4">Revisa los datos extra√≠dos y selecciona el tipo de tarifa para a√±adir a la lista.</p>

                <div class="mb-4" id="tariff-selector-wrapper">
                    <label for="confirm-tariff-select" class="block text-sm font-medium text-slate-700 text-left mb-1">Tipo de Tarifa</label>
                    <select id="confirm-tariff-select" class="w-full p-3 rounded-lg border border-slate-300 text-sm focus:outline-none focus:border-2 focus:border-drk-500">
                        <option value="2.0TD">2.0 TD (Punta, Llano, Valle)</option>
                        <option value="3.0TD">3.0 TD (6 Periodos)</option>
                    </select>
                </div>

                <div id="qr-data-summary" class="bg-slate-50 p-3 rounded-lg text-sm mb-4">
                    </div>

                <button id="confirm-save-supply-btn" class="w-full bg-drk-500 hover:bg-drk-600 text-white font-bold py-3 rounded-xl shadow-md mb-3">A√ëADIR A LA LISTA DE CUPS</button>
                <button onclick="document.getElementById('qr-confirm-modal').classList.add('hidden');" class="w-full bg-slate-200 text-slate-600 font-bold py-3 rounded-xl text-sm">Cancelar</button>
            </div>
        </div>

        <!-- 8. QR Options Modal (Upload/Paste) -->
        <div id="qr-options-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full">
                <h3 class="text-xl font-bold text-drk-800 mb-4" id="modal-qr-title">Seleccione Opci√≥n QR</h3>
                
                <!-- Input oculto para captura de foto -->
                <input type="file" id="camera-capture-input" accept="image/*" capture="environment" class="hidden">
                
                <!-- Bot√≥n Capturar Foto (primera opci√≥n) -->
                <button id="camera-capture-btn" class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 px-6 rounded-xl shadow-md mb-3 flex items-center justify-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.125 3h3.75a2 2 0 011.664.89l.812 1.22a2 2 0 001.664.89H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span>Capturar Foto</span>
                </button>
                
                <button id="modal-upload-file-btn" class="w-full bg-drk-800 hover:bg-drk-900 text-white font-bold py-3 px-6 rounded-xl shadow-md mb-3">Subir Imagen</button>
                <button id="modal-paste-image-btn" class="w-full bg-drk-600 hover:bg-drk-800 text-white font-bold py-3 px-6 rounded-xl shadow-md mb-4">Pegar Imagen (CTRL+V)</button>
                <button onclick="document.getElementById('qr-options-modal').classList.add('hidden'); document.getElementById('qr-options-modal').classList.remove('flex');" class="w-full bg-slate-200 font-bold py-3 rounded-xl">Cancelar</button>
            </div>
        </div>

        <!-- 9. Send Offer Modal (Copy HTML) -->
        <div id="send-offer-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full">
                <h3 class="text-xl font-bold text-drk-800 mb-4" id="modal-client-data-title">Datos del Comercial y Cliente</h3>
                <p class="text-sm text-slate-600 mb-3">Rellene sus datos. El resumen profesional de la oferta se copiar√° a su portapapeles (Ctrl+V).</p>
                
                <input type="text" id="comercial-code-input" placeholder="C√ìDIGO COMERCIAL (Obligatorio)" class="w-full mb-3 p-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-drk-500 outline-none">
                <input type="text" id="client-name-input" placeholder="Nombre Cliente" class="w-full mb-3 p-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-drk-500 outline-none">
                <input type="tel" id="client-phone-input" placeholder="Tel√©fono" class="w-full mb-3 p-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-drk-500 outline-none">
                <input type="email" id="client-email-input" placeholder="Email" class="w-full mb-4 p-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-drk-500 outline-none">
                
                <!-- Nota informativa para iPhone -->
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-4">
                    <div class="flex items-start gap-2">
                        <span class="text-amber-600 text-xl">‚ö†Ô∏è</span>
                        <div class="text-xs text-amber-800">
                            <p class="font-bold mb-1">NOTA PARA USUARIOS DE iPHONE:</p>
                            <p class="leading-relaxed">Si copias desde iPhone, el formato puede no verse correctamente en algunos correos. Para mejor resultado:</p>
                            <ul class="mt-1 ml-3 space-y-0.5">
                                <li>‚úì Copia desde un <strong>ordenador</strong></li>
                                <li>‚úì O usa <strong>Gmail/Outlook web</strong> en el navegador m√≥vil</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <button id="execute-send-offer-btn" class="w-full bg-cta-red-500 hover:bg-cta-red-600 text-white font-black py-3 rounded-xl shadow-md mb-3">
                    üìß COPIAR COMPARATIVO (HTML)
                </button>
                <button id="execute-pdf-offer-btn" class="w-full bg-drk-600 hover:bg-drk-700 text-white font-black py-3 rounded-xl shadow-md mb-3">
                    üìÑ CREAR PDF COMPARATIVO
                </button>
                <button onclick="document.getElementById('send-offer-modal').classList.add('hidden'); document.getElementById('send-offer-modal').classList.remove('flex');" class="w-full bg-slate-200 font-bold py-3 rounded-xl text-sm">Cancelar</button>
            </div>
        </div>

        <!-- 9.5. Request Improvement Modal (Nuevo) -->
        <div id="request-improvement-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full">
                <h3 class="text-xl font-bold text-drk-800 mb-4" data-i18n="Request Improvement from DRK">Solicitar Mejora a DRK</h3>
                <p class="text-sm text-slate-600 mb-4" data-i18n="Complete los datos para que el equipo de Back Office pueda revisar este comparativo y buscar una mejor opci√≥n.">Complete los datos para que el equipo de Back Office pueda revisar este comparativo y buscar una mejor opci√≥n.</p>
                
                <input type="text" id="improvement-comercial-code" data-i18n-placeholder="C√ìDIGO COMERCIAL (Obligatorio)" placeholder="C√ìDIGO COMERCIAL (Obligatorio)" class="w-full mb-3 p-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-amber-500 outline-none">
                <input type="text" id="improvement-client-name" data-i18n-placeholder="Nombre Cliente" placeholder="Nombre Cliente" class="w-full mb-3 p-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-amber-500 outline-none">
                <input type="text" id="improvement-client-cups" data-i18n-placeholder="CUPS" placeholder="CUPS" class="w-full mb-3 p-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-amber-500 outline-none">
                <input type="tel" id="improvement-client-phone" data-i18n-placeholder="Tel√©fono" placeholder="Tel√©fono" class="w-full mb-3 p-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-amber-500 outline-none">
                <input type="email" id="improvement-client-email" data-i18n-placeholder="Email" placeholder="Email" class="w-full mb-3 p-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-amber-500 outline-none">
                <textarea id="improvement-observations" data-i18n-placeholder="Observaciones (opcional)" placeholder="Observaciones (opcional)" rows="3" class="w-full mb-4 p-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-amber-500 outline-none resize-none"></textarea>
                
                <!-- Recordatorio -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                    <div class="flex items-start gap-2">
                        <span class="text-blue-600 text-xl">üìé</span>
                        <div class="text-xs text-blue-800">
                            <p class="font-bold mb-1" data-i18n="RECORDATORIO:">RECORDATORIO:</p>
                            <p class="leading-relaxed" data-i18n="Por favor, adjunte las facturas del cliente en su respuesta al email autom√°tico que recibir√°.">Por favor, adjunte las facturas del cliente en su respuesta al email autom√°tico que recibir√°.</p>
                        </div>
                    </div>
                </div>
                
                <button id="execute-improvement-request-btn" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white font-black py-3 rounded-xl shadow-md mb-3" data-i18n="üìß ENVIAR SOLICITUD">
                    üìß ENVIAR SOLICITUD
                </button>
                <button onclick="document.getElementById('request-improvement-modal').classList.add('hidden'); document.getElementById('request-improvement-modal').classList.remove('flex');" class="w-full bg-slate-200 font-bold py-3 rounded-xl text-sm" data-i18n="Cancelar">Cancelar</button>
            </div>
        </div>

        <!-- 9.8. Modal de Decisi√≥n (Mejor Opci√≥n vs Elegir) -->
        <div id="offer-decision-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full">
                <!-- Header -->
                <div class="bg-gradient-to-r from-drk-600 to-drk-700 p-6 text-white">
                    <h3 id="calculation-complete-title" class="text-2xl font-black">‚úÖ C√°lculo Completado</h3>
                    <p id="calculation-complete-subtitle" class="text-drk-100 text-sm mt-1">Hemos encontrado ofertas con ahorro. ¬øC√≥mo quieres continuar?</p>
                </div>
                
                <!-- Content -->
                <div class="p-6">
                    <!-- NUEVO: Checkbox para comparaci√≥n con tarifas indexadas (SOLO POWER CUP) -->
                    <div id="powercup-indexed-comparison-checkbox" class="hidden mb-6 p-4 bg-gradient-to-r from-blue-50 to-green-50 rounded-xl border-2 border-blue-200">
                        <label class="flex items-start gap-3 cursor-pointer group">
                            <input 
                                type="checkbox" 
                                id="compare-indexed-checkbox" 
                                class="mt-1 w-5 h-5 text-drk-600 border-2 border-slate-300 rounded focus:ring-2 focus:ring-drk-500 cursor-pointer"
                                onchange="toggleIndexedComparison(this.checked)"
                            >
                            <div class="flex-1">
                                <p id="compare-fijo-indexado-title" class="font-black text-base text-slate-900 mb-1 group-hover:text-drk-600 transition">
                                    ‚ö° Comparar FIJO vs INDEXADO
                                </p>
                                <p id="compare-fijo-indexado-desc" class="text-sm text-slate-600">
                                    Genera comparativa dual: tarifa fija y tarifa indexada DRK INDEX (precio variable del mercado).
                                </p>
                            </div>
                        </label>
                    </div>
                    
                    <div class="flex flex-col gap-4">
                        <!-- Opci√≥n 1: Mejor Opci√≥n (CON SELECTOR PARA DRK) -->
                        <div class="rounded-xl border-2 border-slate-300 bg-white overflow-hidden">
                            <!-- Cabecera clickeable -->
                            <button onclick="handleBestOptionClick()" class="w-full text-left p-6 hover:bg-drk-50 transition group">
                                <div class="flex items-start gap-4">
                                    <div class="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center flex-shrink-0 group-hover:bg-yellow-200">
                                        üèÜ
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-black text-lg text-slate-900 mb-2">VER MEJOR OPCI√ìN</p>
                                        <p class="text-sm text-slate-600">Muestra autom√°ticamente la mejor tarifa FIJA con tu ahorro</p>
                                    </div>
                                    <svg class="w-6 h-6 text-slate-400 group-hover:text-drk-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </div>
                            </button>
                            
                            <!-- Selector de tipo de tarifa (SOLO para DRK Individual) -->
                            <div id="best-option-tariff-selector" class="hidden border-t-2 border-slate-200 bg-slate-50 p-4">
                                <p id="tariff-selector-title" class="text-sm font-bold text-slate-700 mb-3">üéØ ¬øQu√© tipo de tarifa DRK quieres ver?</p>
                                <div class="space-y-2">
                                    <!-- Tarifa FIJA -->
                                    <label class="flex items-center gap-3 p-3 rounded-lg border-2 border-drk-500 bg-drk-50 cursor-pointer transition hover:bg-drk-100" id="best-fija-label">
                                        <input 
                                            type="radio" 
                                            name="best-option-tariff-type" 
                                            value="fija" 
                                            checked
                                            class="w-4 h-4 text-drk-600 border-2 border-slate-300 focus:ring-2 focus:ring-drk-500 cursor-pointer"
                                            onchange="updateBestOptionTariffChoice('fija')"
                                        >
                                        <div class="flex-1">
                                            <p id="tarifa-fija-title" class="font-bold text-sm text-slate-900">‚ö° Tarifa FIJA</p>
                                            <p id="tarifa-fija-desc" class="text-xs text-slate-600">Precio fijo estable (excluye DRK INDEX)</p>
                                        </div>
                                    </label>
                                    
                                    <!-- Tarifa INDEXADA -->
                                    <label class="flex items-center gap-3 p-3 rounded-lg border-2 border-slate-200 bg-white cursor-pointer transition hover:bg-green-50" id="best-indexada-label">
                                        <input 
                                            type="radio" 
                                            name="best-option-tariff-type" 
                                            value="indexada"
                                            class="w-4 h-4 text-green-600 border-2 border-slate-300 focus:ring-2 focus:ring-green-500 cursor-pointer"
                                            onchange="updateBestOptionTariffChoice('indexada')"
                                        >
                                        <div class="flex-1">
                                            <p id="tarifa-indexada-title" class="font-bold text-sm text-slate-900">üå± Tarifa INDEXADA (DRK INDEX)</p>
                                            <p id="tarifa-indexada-desc" class="text-xs text-slate-600">Solo muestra DRK INDEX del mercado</p>
                                        </div>
                                    </label>
                                </div>
                                
                                <!-- Bot√≥n de confirmaci√≥n -->
                                <button id="tariff-selector-continue-btn" onclick="selectBestOptionWithChoice()" class="w-full mt-3 bg-drk-600 hover:bg-drk-700 text-white font-bold py-3 rounded-lg transition">
                                    Continuar con esta opci√≥n ‚Üí
                                </button>
                            </div>
                        </div>
                        
                        <!-- Opci√≥n 2: Elegir Manual - OCULTO -->
                        <button onclick="selectFromResults()" class="hidden text-left p-6 rounded-xl border-2 border-slate-300 bg-white hover:border-drk-500 hover:bg-drk-50 transition group">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0 group-hover:bg-blue-200">
                                    üìã
                                </div>
                                <div class="flex-1">
                                    <p class="font-black text-lg text-slate-900 mb-2">ELEGIR ENTRE RESULTADOS</p>
                                    <p class="text-sm text-slate-600">Revisa todas las ofertas con ahorro positivo y elige la que prefieras</p>
                                </div>
                                <svg class="w-6 h-6 text-slate-400 group-hover:text-drk-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </div>
                        </button>
                    </div>
                    
                    <!-- Info adicional - OCULTO -->
                    <div class="hidden mt-6 p-4 bg-slate-50 rounded-lg">
                        <p id="advice-text" class="text-xs text-slate-600">
                            üí° <strong id="advice-label">Consejo:</strong> <span id="advice-content">Si quieres ver r√°pidamente la mejor oferta, elige la primera opci√≥n. Si necesitas comparar varias opciones o el cliente tiene preferencias espec√≠ficas, elige la segunda.</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 9.9. Modal de Selecci√≥n de Oferta -->
        <div id="offer-selection-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] flex flex-col">
                <!-- Header -->
                <div class="bg-gradient-to-r from-drk-600 to-drk-700 p-6 text-white flex-shrink-0">
                    <h3 id="offer-selection-title" class="text-2xl font-black">üìã SELECCIONA TU OFERTA</h3>
                    <p id="offer-selection-subtitle" class="text-drk-100 text-sm mt-1">Hemos calculado todas las opciones con ahorro. Elige la que prefieras.</p>
                </div>
                
                <!-- Content -->
                <div class="p-6 overflow-y-auto flex-1">
                    <!-- Info del CUPS -->
                    <div class="bg-slate-50 rounded-lg p-4 mb-4">
                        <p id="datos-suministro-label" class="text-xs font-bold text-slate-600 mb-2">üìã DATOS DEL SUMINISTRO</p>
                        <p class="text-sm font-mono" id="modal-selection-cups"></p>
                    </div>
                    
                    <!-- NUEVO: Controles de Filtrado y Ordenaci√≥n -->
                    <div class="bg-white border-2 border-drk-200 rounded-xl p-4 mb-4">
                        <div class="flex flex-col md:flex-row gap-3">
                            <!-- Filtro por nombre -->
                            <div class="flex-1">
                                <label id="buscar-nombre-label" class="block text-xs font-bold text-slate-600 mb-2">üîç BUSCAR POR NOMBRE</label>
                                <input 
                                    type="text" 
                                    id="offer-search-input" 
                                    placeholder="Escribe nombre de comercializadora..."
                                    class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-drk-500 focus:outline-none text-sm"
                                    onkeyup="filterAndSortOffers()"
                                >
                            </div>
                            
                            <!-- Ordenaci√≥n -->
                            <div class="md:w-64">
                                <label id="ordenar-por-label" class="block text-xs font-bold text-slate-600 mb-2">üìä ORDENAR POR</label>
                                <select 
                                    id="offer-sort-select" 
                                    class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-drk-500 focus:outline-none text-sm font-medium"
                                    onchange="filterAndSortOffers()"
                                >
                                    <option value="savings_desc">üí∞ Mayor ahorro primero</option>
                                    <option value="savings_asc">üí∏ Menor ahorro primero</option>
                                    <option value="name_asc">üî§ Nombre (A-Z)</option>
                                    <option value="name_desc">üî§ Nombre (Z-A)</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Contador de resultados -->
                        <div class="mt-3 flex items-center justify-between">
                            <p class="text-xs text-slate-500">
                                <span class="font-bold text-drk-600" id="offers-visible-count">0</span> <span id="offers-de-text">de</span> <span id="offers-total-count">0</span> <span id="offers-text">ofertas</span>
                            </p>
                            <button 
                                id="limpiar-filtros-btn"
                                onclick="clearOfferFilters()" 
                                class="text-xs text-drk-600 hover:text-drk-800 font-bold hover:underline"
                            >
                                üîÑ Limpiar filtros
                            </button>
                        </div>
                    </div>
                    
                    <!-- Lista de ofertas con radio buttons -->
                    <div id="offers-radio-list" class="space-y-3 mb-6">
                        <!-- Se rellenar√° din√°micamente -->
                    </div>
                    
                    <!-- Mensaje cuando no hay resultados -->
                    <div id="no-offers-message" class="hidden text-center py-8">
                        <p class="text-slate-400 text-lg mb-2">üîç</p>
                        <p class="text-slate-600 font-bold">No se encontraron ofertas</p>
                        <p class="text-slate-500 text-sm">Prueba con otros criterios de b√∫squeda</p>
                    </div>
                </div>
                
                <!-- Footer con botones -->
                <div class="p-6 border-t border-slate-200 flex-shrink-0">
                    <div class="flex gap-3">
                        <button id="back-offer-selection-btn" onclick="closeOfferSelectionModal()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 rounded-xl transition">
                            ‚Üê Volver
                        </button>
                        <button id="confirm-offer-selection-btn" class="flex-1 bg-drk-600 hover:bg-drk-700 text-white font-bold py-3 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed transition" disabled>
                            Generar Comparativa ‚Üí
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 10. Error/Message Modal -->
        <div id="error-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full text-center">
                <div class="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4" id="error-icon"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                <h3 class="text-lg font-bold text-slate-800 mb-2" id="error-title">¬°Atenci√≥n!</h3>
                <p id="error-message" class="text-slate-600 text-sm mb-6"></p>
                <div class="space-y-2">
                    <button onclick="hideErrorModal()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-xl">Entendido</button>
                    <button id="secondary-action-btn" class="w-full bg-slate-200 text-slate-600 font-bold py-3 rounded-xl text-sm mt-2 hidden">Acci√≥n Secundaria</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Overlay de procesamiento QR - Grande y visible -->
    <div id="qr-processing-overlay" class="fixed inset-0 bg-slate-900/95 hidden items-center justify-center z-[100] backdrop-blur-md">
        <div class="text-center px-6">
            <!-- Spinner grande animado -->
            <div class="relative mx-auto mb-8">
                <div class="w-32 h-32 border-8 border-green-500/20 border-t-green-500 rounded-full animate-spin"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <svg class="w-16 h-16 text-green-500 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M12 12h-4.01M12 12V8m0 4l-4-4m4 4l4-4m0 0v4m0-4h-4"></path>
                    </svg>
                </div>
            </div>
            
            <!-- T√≠tulo grande -->
            <h2 id="qr-analyzing-title" class="text-3xl font-bold text-white mb-3">
                üîç Analizando QR
            </h2>
            
            <!-- Mensaje de progreso -->
            <p id="qr-progress-message" class="text-xl text-green-400 font-semibold mb-6">
                Procesando imagen...
            </p>
            
            <!-- Contador de intentos -->
            <div class="bg-white/10 rounded-xl px-6 py-4 inline-block">
                <p id="qr-progress-label" class="text-white text-sm mb-2">Progreso de an√°lisis</p>
                <p id="qr-attempt-counter" class="text-2xl font-bold text-green-400">
                    1 / 6
                </p>
            </div>
            
            <!-- Texto de ayuda -->
            <p id="qr-help-text" class="text-slate-400 text-sm mt-8 max-w-md mx-auto">
                Estamos probando diferentes t√©cnicas para detectar tu c√≥digo QR. 
                Esto puede tardar unos segundos...
            </p>
        </div>
    </div>
    
    <!-- Paste Catcher (Hidden element for capturing pasted image data) -->
    <textarea id="paste-catcher" aria-hidden="true" title="√Årea de pegado (invisible)"></textarea>

    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        .animate-pulse {
            animation: pulse 2s ease-in-out infinite;
        }
    </style>

    <script>
        // Inicializar modo DUAL en false
        window.dualMode = false;
        
        // --- CONFIGURACI√ìN DE TIPO DE TARIFAS ---
        // **ATENCI√ìN: Los IDs de las hojas deben ser p√∫blicos para funcionar (CSV)**
        // Eliminamos 6.1TD de la configuraci√≥n
        const TARIFF_CONFIG = {
            '2.0TD': { sheetId: '19CBiWVvxHoWW0fqdbSbLGs-hoISQGORAfebBztFYi3w', periods: 3, powerPeriods: 2, label: '2.0 TD', isHighVoltage: false, requiresQR: true, isMulti: false },
            '3.0TD': { sheetId: '18nieA7yMD9Ytc2Z3EnktoNDZokuMrBet_ETGyhNZDuo', periods: 6, powerPeriods: 6, label: '3.0 TD', isHighVoltage: true, requiresQR: false, isMulti: false },
            'MULTICUPS': { sheetId: 'MULTICUPS_MIXED_TARIF_SHEET_ID', periods: 6, powerPeriods: 6, label: 'MULTICUPS', isHighVoltage: false, requiresQR: true, isMulti: true, baseTariffType: '2.0TD' }
        };

        const BRANDS = {
            DRK: {
                NAME: 'DRK', ACCENT: 'drk-500', ACCENT_TEXT: 'Energ√≠a',
                FULL_NAME: 'DRK ENERG√çA', // A√ëADIDO
                TITLE: 'DRK COMPARADOR', // T√≠tulo en may√∫sculas
                QR_URL: 'https://faraujoteixeiradrk-creator.github.io/QR-21-POWER-2-0-TD---3.0-TD-Con-PDF/',
                QR_TEXT: 'DRK',
                QR_BORDER_COLOR: '#0ea5e9', // drk-500
                QR_CENTER_BG: '#075985', // drk-800
                PRIMARY_BG_GRADIENT: 'from-drk-800 to-drk-600', 
                PRIMARY_BUTTON: 'from-drk-600 to-drk-800 hover:from-drk-700 hover:to-drk-900', // ESCANEAR QR
                SECONDARY_BUTTON_BG: 'bg-drk-50', // OPCIONES QR MANUAL / DATOS A MANO BG
                SECONDARY_BUTTON_TEXT: 'text-drk-800', // OPCIONES QR MANUAL / DATOS A MANO Text
                PRIMARY_TEXT: 'text-drk-800', SECONDARY_BG: 'bg-drk-50', SECONDARY_TEXT: 'text-drk-600', BORDER: 'border-drk-500',
                LOGO_SVG: `<svg class="w-8 h-8" viewBox="0 0 100 100" fill="none"><style>.drk-ring{fill:none;stroke-width:10;stroke-linecap:round;}</style><circle class="drk-ring" cx="45" cy="45" r="35" stroke="#E50000"/><circle class="drk-ring" cx="55" cy="55" r="35" stroke="#FFCC00"/><circle class="drk-ring" cx="45" cy="55" r="35" stroke="#0079C1"/><circle class="drk-ring" cx="55" cy="45" r="35" stroke="#00A859"/></svg>`,
                NAV_BG: 'bg-drk-900', NAV_SUBTITLE_BG: 'bg-drk-800', NAV_SUBTITLE_TEXT: 'text-drk-100'
            },
            POWER_CUP: {
                NAME: 'POWER CUP', ACCENT: 'powercup-500', ACCENT_TEXT: '',
                FULL_NAME: 'POWER CUP', // A√ëADIDO
                TITLE: 'POWER CUP COMPARADOR', // T√≠tulo en may√∫sculas
                QR_URL: 'https://faraujoteixeiradrk-creator.github.io/QR-21-POWER-2-0-TD---3.0-TD-Con-PDF/',
                QR_TEXT: 'POWER',
                QR_BORDER_COLOR: '#84cc16', // powercup-500
                QR_CENTER_BG: '#3f6212', // powercup-800
                PRIMARY_BG_GRADIENT: 'from-powercup-900 to-powercup-800', 
                PRIMARY_BUTTON: 'from-powercup-600 to-powercup-800 hover:from-powercup-500 hover:to-powercup-900', // ESCANEAR QR
                SECONDARY_BUTTON_BG: 'bg-powercup-50', // OPCIONES QR MANUAL / DATOS A MANO BG
                SECONDARY_BUTTON_TEXT: 'text-powercup-800', // OPCIONES QR MANUAL / DATOS A MANO Text
                PRIMARY_TEXT: 'text-powercup-800', SECONDARY_BG: 'bg-powercup-50', SECONDARY_TEXT: 'text-powercup-600', BORDER: 'border-powercup-500',
                LOGO_SVG: `<svg width="40" height="40" viewBox="0 0 100 100" fill="none"><path d="M78 40V70C78 80.25 70.25 88 60 88H30C19.75 88 12 80.25 12 70V40C12 29.75 19.75 22 30 22H60C70.25 22 78 29.75 78 40Z" fill="#3f6212"/><circle cx="45" cy="95" r="5" fill="#365314" opacity="0.8"/><rect x="20" y="80" width="50" height="5" rx="2.5" fill="#365314"/><rect x="20" y="30" width="50" height="50" fill="#f7fee7" rx="5"/><rect x="25" y="65" width="40" height="10" rx="2" fill="#84cc16"/><rect x="25" y="50" width="40" height="10" rx="2" fill="#84cc16"/><rect x="25" y="35" width="40" height="10" rx="2" fill="#84cc16"/><path d="M80 20L60 35L70 45L50 60L75 60L65 80L85 65L75 55L85 45L65 45L75 25Z" fill="#facc15" stroke="#3f6212" stroke-width="2" stroke-linejoin="round"/><path d="M78 40C88 40 88 50 88 60C88 70 88 80 78 80" stroke="#3f6212" stroke-width="8" stroke-linecap="round"/></svg>`,
                NAV_BG: 'bg-powercup-900', NAV_SUBTITLE_BG: 'bg-powercup-800', NAV_SUBTITLE_TEXT: 'text-powercup-100'
            }
        };

        const EXTERNAL_APP_URL = 'https://faraujoteixeiradrk-creator.github.io/QR-21-POWER-2-0-TD---3.0-TD-Con-PDF/';
        
        // Estado Global
        // ‚ö°‚ö°‚ö° VERSI√ìN: 2024-12-31-DEBUG-ULTRA-v45 ‚ö°‚ö°‚ö°
        console.log('üî•üî•üî• ARCHIVO CARGADO - VERSI√ìN: 2024-12-31-DEBUG-ULTRA-v45 üî•üî•üî•');
        console.log('üîç DEBUG ULTRA: Logs JSON.stringify para ver arrays completos');
        console.log('üîç Esto mostrar√° EXACTAMENTE qu√© propiedades tienen powerCosts y energyCosts');
        console.log('üìù Por favor, comparte los logs de powerCosts[0] y energyCosts[0] COMPLETOS');
        
        // Eliminamos 6.1TD del estado inicial
        let currentTariffs = {
            '2.0TD': [],
            '3.0TD': []
        };
        let currentTariffType = '2.0TD';
        let lastComparisonResult = null;
        let lastIndexedResult = null; // Para almacenar el resultado de tarifa indexada
        let comparisonMode = 'drk_prioritized';
        let compareWithIndexed = false; // Control para comparaci√≥n con tarifas indexadas
        let bestOptionTariffChoice = 'fija'; // NUEVO: Elecci√≥n de tarifa para VER MEJOR OPCI√ìN ('fija' o 'indexada')
        let isProcessingBestOption = false; // NUEVO: Bandera para prevenir llamadas concurrentes
        let activeBrand = BRANDS.DRK;
        let qrCodeInstance = null; // Instancia de QRCode.js
        
        // Nuevas variables para selecci√≥n avanzada de ofertas
        let availableOffers = []; // Array de todas las ofertas con ahorro positivo
        let manuallySelectedOffer = null; // Oferta seleccionada manualmente

        // Estado Multicups
        let multiCupsData = [];
        let tempQrData = null; // Almacenamiento temporal para datos de QR antes de la confirmaci√≥n
        let multiCupsAddType = null; // NEW: Holds '2.0TD' or '3.0TD' when adding a single CUPS in MultiCups mode.
        
        // Variables Esc√°ner
        let scannerRunning = false;
        let scanLoopCount = 0; // Contador de frames para procesamiento progresivo
        let stream = null, video = null, canvas = null, canvasCtx = null, animationFrameId = null;
        
        // Variables para detecci√≥n Google Lens
        let qrRegionDetected = null; // Regi√≥n del QR cuando se detecta: {x, y, width, height}
        let qrDetectionFrame = 0; // Frame en el que se detect√≥ el QR
        let qrStableFrames = 0; // Frames consecutivos con QR detectado (para estabilidad)
        
        // Protecci√≥n anti-duplicados para compareOffers
        let lastCompareOffersCall = 0;
        let lastCompareOffersData = null;

        // --- FUNCIONES DE FORMATO ROBUSTAS ---
        const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
        const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
        const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);

        // Funci√≥n para obtener TODAS las ofertas √∫nicas usadas en los resultados
        function getWinningOffersPerType(results) {
            // Cambio: Ahora guardamos arrays de ofertas √∫nicas
            const winningOffers = { '2.0TD': [], '3.0TD': [] };
            let hasDrkWinner = false;
            
            results.forEach(resItem => {
                const type = resItem.originalTariffType;
                const winnerOffer = resItem.offer;
                
                // Track if any DRK offer won
                if (winnerOffer.isDrk && winnerOffer.name !== 'Tu Tarifa Actual') {
                    hasDrkWinner = true;
                }

                // Collect ALL unique winning offers for this type
                if (type === '2.0TD' || type === '3.0TD') {
                    const key = type;
                    
                    if (winnerOffer.name !== 'Tu Tarifa Actual') {
                        // Crear un identificador √∫nico basado en los precios (no solo el nombre)
                        // Esto permite diferenciar ofertas con el mismo nombre pero diferentes precios
                        const offerSignature = type === '2.0TD' 
                            ? `${winnerOffer.name}_${winnerOffer.p1_price}_${winnerOffer.p2_price}_${winnerOffer.p3_price}`
                            : `${winnerOffer.name}_${winnerOffer.p1_price}_${winnerOffer.p2_price}_${winnerOffer.p3_price}_${winnerOffer.p4_price}`;
                        
                        // Verificar si esta oferta ya est√° (por firma √∫nica)
                        const alreadyExists = winningOffers[key].some(o => {
                            const existingSignature = type === '2.0TD'
                                ? `${o.name}_${o.p1_price}_${o.p2_price}_${o.p3_price}`
                                : `${o.name}_${o.p1_price}_${o.p2_price}_${o.p3_price}_${o.p4_price}`;
                            return existingSignature === offerSignature;
                        });
                        
                        if (!alreadyExists) {
                            winningOffers[key].push({
                                ...winnerOffer,
                                totalAnnual: resItem.totalAnnual
                            });
                        }
                    }
                }
            });

            return { winningOffers, hasDrkWinner };
        }
        
        // --- FUNCIONES DE MODALES Y UI ---
        
        window.hideErrorModal = () => {
            document.getElementById('error-modal').classList.add('hidden');
            document.getElementById('error-modal').classList.remove('flex');
            const secondaryBtn = document.getElementById('secondary-action-btn');
            if (secondaryBtn) secondaryBtn.classList.add('hidden');
            cleanupPasteCatcher();
        };

        function setModalContent(msg, title, isError) {
            const brand = activeBrand;
            const basePrefix = brand.NAME.includes('DRK') ? 'drk' : 'powercup';
            
            document.getElementById('error-title').textContent = title;
            document.getElementById('error-message').textContent = msg;

            if (isError) {
                document.getElementById('error-icon').className = "w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4";
                document.getElementById('error-icon').innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
            } else {
                document.getElementById('error-icon').className = `w-12 h-12 bg-${basePrefix}-100 text-${basePrefix}-500 rounded-full flex items-center justify-center mx-auto mb-4`;
                document.getElementById('error-icon').innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
            }
            
            const mainButton = document.querySelector('#error-modal button:not(#secondary-action-btn)');
            if (mainButton) {
                mainButton.textContent = tr("Entendido");
                mainButton.onclick = hideErrorModal;
            }

            document.getElementById('error-modal').classList.remove('hidden');
            document.getElementById('error-modal').classList.add('flex');
            
            const secondaryBtn = document.getElementById('secondary-action-btn');
            if (secondaryBtn) secondaryBtn.classList.add('hidden');
            
            // CR√çTICO: Traducir contenido del modal
            if (window.translateAll) {
                setTimeout(() => window.translateAll(), 50);
            }
        }

        window.showMessageModal = (msg, title=tr("√âxito")) => setModalContent(msg, title, false);
        window.showErrorModal = (msg, title=tr("¬°Atenci√≥n!")) => setModalContent(msg, title, true);
        
        function cleanupPasteCatcher() {
            const pasteCatcher = document.getElementById('paste-catcher');
            pasteCatcher.classList.remove('pasting-active');
            pasteCatcher.blur();  
            pasteCatcher.style.width = '0';
            pasteCatcher.style.height = '0';
            pasteCatcher.style.zIndex = '-1';
            pasteCatcher.style.pointerEvents = 'none';
            pasteCatcher.value = '';  
        }

        function showPasteModal(onCancel) {
            const pasteCatcher = document.getElementById('paste-catcher');
            
            // 1. Activar el campo de pegado
            pasteCatcher.classList.add('pasting-active');
            
            // Intentar asegurar el foco despu√©s de un breve momento para mayor fiabilidad.
            setTimeout(() => {
                pasteCatcher.focus();
            }, 50);
            
            // 2. Establecer contenido del modal
            setModalContent(tr("Con el cuadro de texto invisible enfocado, pulse Ctrl+V (o Cmd+V) para pegar la imagen de la factura."), tr("Esperando Pegado (Ctrl+V)"), false);

            // 3. Configurar el bot√≥n de Cancelar din√°micamente
            let secondaryBtn = document.getElementById('secondary-action-btn');
            secondaryBtn.textContent = tr("Cancelar Pegado");
            secondaryBtn.onclick = () => { onCancel(); hideErrorModal(); };
            secondaryBtn.classList.remove('hidden');
            
            // 4. Configurar bot√≥n principal para que tambi√©n cancele
            const mainButton = document.querySelector('#error-modal button:not(#secondary-action-btn)');
            mainButton.textContent = tr("Continuar Pegando");  
            mainButton.onclick = () => { hideErrorModal(); };
        }
        
        function setupPasteCatcher() {
            const pasteCatcher = document.getElementById('paste-catcher');
            const modalPasteBtn = document.getElementById('modal-paste-image-btn');
            
            modalPasteBtn.addEventListener('click', () => {
                document.getElementById('qr-options-modal').classList.add('hidden');
                document.getElementById('qr-options-modal').classList.remove('flex');
                showPasteModal(cleanupPasteCatcher);
            });

            pasteCatcher.addEventListener('paste', (e) => {
                e.preventDefault();
                hideErrorModal();
                cleanupPasteCatcher();
                
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                let imageFound = false;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        const file = items[i].getAsFile();
                        if (file) {
                            decodeQRFromImage(file);
                            imageFound = true;
                            break;
                        }
                    }
                }
                
                if (!imageFound) window.showErrorModal("No se detect√≥ ninguna imagen en el portapapeles.");
            });
        }
        
        // Funci√≥n para aplicar estilos de marca
        function applyBrandStyles(brand) {
            activeBrand = brand;
            const isDrk = brand.NAME.includes('DRK');
            
            const accent500 = isDrk ? 'drk-500' : 'powercup-500';
            const bg50 = isDrk ? 'bg-drk-50' : 'bg-powercup-50';
            const text800 = isDrk ? 'text-drk-800' : 'text-powercup-800';
            const borderColor = isDrk ? 'border-drk-500' : 'border-powercup-500';
            
            // --- CORE BRAND SWITCH (BODY CLASS) ---
            document.body.classList.toggle('powercup-active', !isDrk);
            document.body.classList.toggle('drk-active', isDrk);

            // 1. NAVBAR
            document.getElementById('app-logo-main').textContent = isDrk ? 'DRK' : 'POWER';
            document.getElementById('app-logo-accent').textContent = brand.ACCENT_TEXT;
            document.getElementById('app-logo-accent').className = `text-${brand.ACCENT}`;

            document.getElementById('navbar').className = `w-full ${brand.NAV_BG} text-white p-4 shadow-md sticky top-0 z-50 transition-colors duration-300`;
            document.getElementById('app-subtitle').className = `text-xs ${brand.NAV_SUBTITLE_BG} px-2 py-1 rounded ${brand.NAV_SUBTITLE_TEXT}`;

            // 2. LANDING PAGE CONTENT
            document.getElementById('landing-title').textContent = brand.TITLE; // Set main title in CAPS
            document.getElementById('landing-icon-bg').className = `w-16 h-16 ${bg50} rounded-full flex items-center justify-center mx-auto mb-4 ${text800} shadow-inner`;
            document.getElementById('landing-icon-bg').innerHTML = brand.LOGO_SVG; // Set main logo

            // 3. INITIAL VIEW ICON (Used when user proceeds to scan view)
            document.getElementById('initial-icon-bg').className = `w-16 h-16 ${bg50} rounded-full flex items-center justify-center mx-auto mb-4 ${text800} shadow-inner`;
            document.getElementById('initial-icon-bg').innerHTML = brand.LOGO_SVG;
            // Also apply to Saga View
            const sagaIcon = document.getElementById('initial-icon-bg-saga');
            if (sagaIcon) {
                sagaIcon.className = `w-16 h-16 ${bg50} rounded-full flex items-center justify-center mx-auto mb-4 ${text800} shadow-inner`;
                sagaIcon.innerHTML = brand.LOGO_SVG;
            }
            
            // 4. MAIN ACTION BUTTONS (Scanner/Input View)
            const primaryButtonClass = `w-full bg-gradient-to-r ${brand.PRIMARY_BUTTON} text-white font-bold py-4 px-6 rounded-2xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mb-3`;
            const startScanBtn = document.getElementById('start-scan-btn');
            if (startScanBtn) startScanBtn.className = primaryButtonClass; // Apply to scan button if visible

            const secondaryButtonBase = `w-full ${brand.SECONDARY_BUTTON_BG} ${isDrk ? 'hover:bg-drk-100' : 'hover:bg-powercup-100'} ${brand.SECONDARY_BUTTON_TEXT} font-bold py-3 px-6 rounded-xl shadow-sm transform transition active:scale-95 flex items-center justify-center gap-3`;
            const uploadMenuBtn = document.getElementById('upload-menu-btn');
            if (uploadMenuBtn) uploadMenuBtn.className = secondaryButtonBase; // Apply to upload button if visible
            
            // Apply unique style to Manual Input button
            const manualInputBtn = document.getElementById('manual-input-btn');
            if (manualInputBtn) {
                // Remove all previous style classes related to color/bg/hover
                manualInputBtn.className = manualInputBtn.className.split(' ').filter(c => 
                    !c.startsWith('bg-') && !c.startsWith('hover:bg-') && !c.startsWith('text-') && !c.includes('from-') && !c.includes('to-')
                ).join(' ');
                
                // If QR is hidden (3.0TD individual flow), use the Primary style for manual input
                const isManualPrimary = !isDrk && currentTariffType !== 'MULTICUPS' && !TARIFF_CONFIG[currentTariffType]?.requiresQR;
                
                if (isManualPrimary) {
                    manualInputBtn.classList.add('w-full', 'text-white', 'font-bold', 'py-4', 'px-6', 'rounded-2xl', 'shadow-lg', 'transform', 'transition', 'active:scale-95', 'flex', 'items-center', 'justify-center', 'gap-3');
                    // A√±adir clases de gradiente por separado
                    const gradientClasses = isDrk 
                        ? ['bg-gradient-to-r', 'from-drk-600', 'to-drk-800', 'hover:from-drk-700', 'hover:to-drk-900']
                        : ['bg-gradient-to-r', 'from-powercup-600', 'to-powercup-800', 'hover:from-powercup-500', 'hover:to-powercup-900'];
                    manualInputBtn.classList.add(...gradientClasses);
                } else { // DRK active, MULTICUPS, or 2.0TD flow (uses secondary style)
                    manualInputBtn.classList.add('w-full', 'font-bold', 'py-3', 'px-6', 'rounded-xl', 'shadow-sm', 'transform', 'transition', 'active:scale-95', ...brand.SECONDARY_BUTTON_BG.split(' '), ...brand.SECONDARY_BUTTON_TEXT.split(' '));
                }

                // Re-add mt-3 if QR buttons are visible
                if (!document.getElementById('qr-buttons-container')?.classList.contains('hidden')) {
                    manualInputBtn.classList.add('mt-3');
                } else {
                    manualInputBtn.classList.remove('mt-3');
                }
            }
            
            const focusColorClass = isDrk ? 'focus:border-drk-500' : 'focus:border-powercup-500';  
            const calcBtnBg = isDrk ? 'bg-drk-500 hover:bg-drk-600' : 'bg-powercup-500 hover:bg-powercup-600';
            
            // 5. MANUAL INPUT MODAL STYLES
            const manualModal = document.getElementById('manual-input-modal');
            manualModal.querySelector('h3#manual-modal-title').className = `text-xl font-bold ${text800} mb-4`;
            manualModal.querySelectorAll('input[type="text"], input[type="number"], select').forEach(input => {
                input.classList.remove('focus:border-drk-500', 'focus:border-powercup-500');
                input.classList.add(focusColorClass);
            });
            manualModal.querySelector('#execute-manual-input-btn').className = `w-full text-white font-bold py-3 rounded-xl shadow-md mb-3 ${calcBtnBg}`;

            // 6. QR OPTIONS MODAL STYLES (Modal 8)
            const qrOptionsModal = document.getElementById('qr-options-modal');
            qrOptionsModal.querySelector('h3#modal-qr-title').className = `text-xl font-bold ${text800} mb-4`;

            const uploadBtn = document.getElementById('modal-upload-file-btn');
            const pasteBtn = document.getElementById('modal-paste-image-btn');
            
            if (uploadBtn) {
                uploadBtn.className = `w-full text-white font-bold py-3 px-6 rounded-xl shadow-md mb-3 transform transition active:scale-95 ${isDrk ? 'bg-drk-800 hover:bg-drk-900' : 'bg-powercup-800 hover:bg-powercup-900'}`;
            }

            if (pasteBtn) {
                pasteBtn.className = `w-full text-white font-bold py-3 px-6 rounded-xl shadow-md mb-4 transform transition active:scale-95 ${isDrk ? 'bg-drk-600 hover:bg-drk-800' : 'bg-powercup-600 hover:bg-powercup-800'}`;
            }

            // 7. QR CONFIRM MODAL STYLES (Modal 7)
            const qrConfirmModal = document.getElementById('qr-confirm-modal');
            qrConfirmModal.querySelector('h3').className = `text-xl font-bold ${text800} mb-2`;
            qrConfirmModal.querySelector('#confirm-save-supply-btn').className = `w-full text-white font-bold py-3 rounded-xl shadow-md mb-3 ${calcBtnBg}`;

            // 8. SCANNER VIEW
            document.getElementById('scanner-guide').classList.remove('border-drk-500', 'border-powercup-500');
            document.getElementById('scanner-guide').classList.add(borderColor);
            
            const captureBtn = document.getElementById('capture-photo-btn');
            if (captureBtn) {
                captureBtn.classList.remove('border-drk-500', 'text-drk-800', 'border-powercup-500', 'text-powercup-800');
                captureBtn.classList.add('border-2', 'bg-white', borderColor, text800);
            }

            document.getElementById('paste-catcher').style.setProperty('--qr-border-color', brand.QR_BORDER_COLOR);


            // 9. Result Header Gradient & Card Borders
            document.getElementById('result-header').className = `bg-gradient-to-r ${brand.PRIMARY_BG_GRADIENT} p-6 text-white text-center relative overflow-hidden`;
            document.getElementById('initial-card').className = `bg-white p-6 rounded-3xl shadow-xl text-center border-t-4 ${borderColor} relative`;
            document.getElementById('landing-card').className = `bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 ${borderColor}`;
            
            const sagaCard = document.getElementById('multicups-saga-card');
            if (sagaCard) sagaCard.className = `bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 ${borderColor} relative`;

            // 10. TARIFF BADGE COLOR (In Initial View)
            const tariffBadge = document.getElementById('tariff-badge');
            tariffBadge.classList.remove('bg-drk-500', 'bg-powercup-500');  
            tariffBadge.classList.add(`bg-${accent500}`);

            // 11. Landing Page Tariff Buttons 
            document.querySelectorAll('.tariff-select-btn').forEach(btn => {
                const iconWrapper = btn.querySelector('.icon-wrapper');
                const arrowIcon = btn.querySelector('.arrow-icon');
                
                // Limpiar clases de color
                iconWrapper.className = iconWrapper.className.split(' ').filter(c => !c.startsWith('bg-') && !c.startsWith('text-') && !c.startsWith('group-hover')).join(' ');
                arrowIcon.classList.remove('group-hover:text-drk-500', 'group-hover:text-powercup-500');
                btn.classList.remove('border-drk-300', 'hover:border-drk-500', 'border-powercup-300', 'hover:border-powercup-500');

                if (isDrk) {
                    iconWrapper.classList.add('bg-drk-50', 'group-hover:bg-drk-100', 'text-drk-600');
                    arrowIcon.classList.add('group-hover:text-drk-500');
                    btn.classList.add('border-drk-300', 'hover:border-drk-500');
                } else {
                    iconWrapper.classList.add('bg-powercup-50', 'group-hover:bg-powercup-100', 'text-powercup-600');
                    arrowIcon.classList.add('group-hover:text-powercup-500');
                    btn.classList.add('border-powercup-300', 'hover:border-powercup-500');
                }
            });
        }
        
        // --- FUNCIONES DE LIMPIEZA ---

        function clearManualInputs(prefix = 'input') {
            document.getElementById(`${prefix}-cups`).value = '';
            document.getElementById(`${prefix}-billing-days`).value = '';
            document.getElementById(`${prefix}-total-bill`).value = '';
            for (let i = 1; i <= 6; i++) {
                const pInput = document.getElementById(`${prefix}-p${i}-kw`);
                if (pInput) pInput.value = '';
                const eInput = document.getElementById(`${prefix}-e${i}-kwh`);
                if (eInput) eInput.value = '';
            }
        }
        
        function closeManualInputModal() {
            document.getElementById('manual-input-modal').classList.add('hidden');
            document.getElementById('manual-input-modal').classList.remove('flex');
            // Si est√°bamos en modo MultiCups, volvemos al selector 2.0/3.0
            if (currentTariffType === 'MULTICUPS') {
                showMultiCupsSagaView();
            }
        }

        // FUNCI√ìN GLOBAL: Hacer accesible desde onclick en HTML
        window.resetToLanding = function() {
            console.log('resetToLanding llamada');
            stopScanner();
            
            // PRIMERO: Ocultar TODAS las pantallas antes de cualquier otra operaci√≥n
            hideAllScreens();
            console.log('‚úÖ Todas las pantallas ocultadas con hideAllScreens()');
            
            // CR√çTICO: Limpiar TODAS las variables globales
            lastComparisonResult = null;
            lastIndexedResult = null;
            multiCupsData = [];
            multiCupsAddType = null;
            availableOffers = [];
            manuallySelectedOffer = null;
            compareWithIndexed = false;
            bestOptionTariffChoice = 'fija';
            currentTariffType = null; // NUEVO: Resetear tipo de tarifa
            window.lastGasComparisonResult = null; // NUEVO: Resetear datos de GAS
            window.dualGlobalResults = null; // NUEVO: Resetear datos DUAL
            
            // DUAL: Limpiar variables DUAL
            window.dualMode = false;
            window.dualSupplies = [];
            dualSupplies = window.dualSupplies; // Mantener referencia
            window.dualGlobalResults = null;
            dualTempSupply = null;
            console.log('‚úÖ Variables DUAL limpiadas');
            
            // Resetear checkbox de comparaci√≥n indexada
            const checkboxIndexed = document.getElementById('compare-indexed-checkbox');
            if (checkboxIndexed) {
                checkboxIndexed.checked = false;
            }
            
            // Resetear selector de tipo de tarifa
            const fijaRadio = document.querySelector('input[name="best-option-tariff-type"][value="fija"]');
            if (fijaRadio) {
                fijaRadio.checked = true;
            }
            
            // Restaurar la marca activa seg√∫n el modo de comparaci√≥n
            const brandToApply = comparisonMode === 'overall_best' ? BRANDS.POWER_CUP : BRANDS.DRK;
            applyBrandStyles(brandToApply);  
            
            // Asegurarse de que el radio button correcto est√© checked
            const selectorInput = document.querySelector(`input[name="comparison_mode"][value="${comparisonMode}"]`);
            if (selectorInput) {
                selectorInput.checked = true;
                updateComparisonMode(comparisonMode);
            }

            // Ocultar vistas adicionales del flujo normal
            document.getElementById('initial-view')?.classList.add('hidden');
            document.getElementById('multicups-saga-view')?.classList.add('hidden');
            document.getElementById('results-view')?.classList.add('hidden');
            document.getElementById('scanner-view')?.classList.add('hidden');
            document.getElementById('manual-input-modal')?.classList.add('hidden');
            document.getElementById('manual-input-modal')?.classList.remove('flex');
            document.getElementById('multicups-finalize-btn-main')?.classList.add('hidden');
            document.getElementById('manual-tariff-selector-wrapper')?.classList.add('hidden');
            
            // IMPORTANTE: Mostrar landing-view para que est√© visible al volver a Electricidad/Gas
            document.getElementById('landing-view')?.classList.remove('hidden');
            
            document.querySelectorAll('.hidden-period').forEach(el => el.style.display = 'none');
            document.getElementById('tariff-display-badge').textContent = '0';
            
            // FINALMENTE: Mostrar pantalla inicial y mantener oculto selector de modo
            document.getElementById('screen-inicio')?.classList.add('active');
            const modoComparacionSection = document.getElementById('modo-comparacion-section');
            if (modoComparacionSection) {
                modoComparacionSection.style.display = 'none'; // Mantener oculto
            }
            
            console.log('‚úÖ resetToLanding completada - screen-inicio activa');
            
            // NUEVO: Mostrar navbar al volver al inicio
            showNavbar();
        };
        
        // NUEVAS FUNCIONES: Ocultar/Mostrar Navbar cuando se muestran resultados
        function hideNavbar() {
            const navbar = document.getElementById('navbar');
            if (navbar) {
                navbar.style.display = 'none';
                console.log('üîí Navbar ocultado');
            }
        }
        
        function showNavbar() {
            const navbar = document.getElementById('navbar');
            if (navbar) {
                navbar.style.display = 'block';
                console.log('üëÅÔ∏è Navbar mostrado');
            }
        }
        
        // NUEVA FUNCI√ìN: Volver desde initial-view SIN hacer reset completo
        window.goBackFromInitialView = function() {
            console.log('üîô goBackFromInitialView llamada');
            stopScanner();
            
            // Solo ocultar initial-view
            document.getElementById('initial-view')?.classList.add('hidden');
            
            // Mostrar la pantalla inicial (screen-inicio)
            document.getElementById('screen-inicio')?.classList.add('active');
            
            console.log('‚úÖ Vuelto a screen-inicio');
        };
        
        // NUEVA FUNCI√ìN: Volver desde multicups-saga-view SIN hacer reset completo
        window.goBackFromMultiCupsSagaView = function() {
            console.log('üîô goBackFromMultiCupsSagaView llamada');
            
            // Solo ocultar multicups-saga-view
            document.getElementById('multicups-saga-view')?.classList.add('hidden');
            
            // Mostrar la pantalla de selecci√≥n de tarifa (landing-view)
            document.getElementById('landing-view')?.classList.remove('hidden');
            
            console.log('‚úÖ Vuelto a landing-view desde MultiCups');
        };

        function toggleMultiCupsInputPeriods(tariffType, prefix = 'input') {
            // Eliminamos la referencia a 6.1TD en la comprobaci√≥n
            const isHighVoltage = tariffType === '3.0TD';
            const periods = document.querySelectorAll(`[id^="${prefix}-p3-kw"], [id^="${prefix}-p4-kw"], [id^="${prefix}-p5-kw"], [id^="${prefix}-p6-kw"], [id^="${prefix}-e4-kwh"], [id^="${prefix}-e5-kwh"], [id^="${prefix}-e6-kwh"]`);
            
            periods.forEach(el => {
                el.style.display = isHighVoltage ? 'block' : 'none';
            });
            // Ocultar/Mostrar campos de E1/E2/E3
            document.getElementById('input-e1-kwh').placeholder = isHighVoltage ? 'E1' : `E1 (${tr('Punta')})`;
            document.getElementById('input-e2-kwh').placeholder = isHighVoltage ? 'E2' : `E2 (${tr('Llano')})`;
            document.getElementById('input-e3-kwh').placeholder = isHighVoltage ? 'E3' : `E3 (${tr('Valle')})`;
        }

        function selectTariffType(type) {
            console.log('=== selectTariffType EJECUT√ÅNDOSE ===');
            console.log('Type:', type);
            console.log('dualMode:', window.dualMode);
            
            currentTariffType = type;
            const config = TARIFF_CONFIG[type];
            const qrButtonsContainer = document.getElementById('qr-buttons-container');

            // CR√çTICO: Si estamos en modo DUAL, limpiar TODAS las variables
            if (window.dualMode === true) {
                console.log('‚ö° MODO DUAL DETECTADO - Limpiando variables anteriores...');
                lastComparisonResult = null;
                lastIndexedResult = null;
                availableOffers = [];
                manuallySelectedOffer = null;
                compareWithIndexed = false;
                console.log('‚úÖ Variables limpiadas correctamente');
            }

            clearManualInputs();  

            if (config.isMulti) {
                // NEW: FLujo MULTICUPS: Va a la vista SAGA intermedia
                // CR√çTICO: Limpiar TODAS las variables globales al iniciar MultiCups
                multiCupsData = [];  
                multiCupsAddType = null; // Reset sub-type
                availableOffers = [];
                lastComparisonResult = null;
                manuallySelectedOffer = null;
                
                document.getElementById('landing-view').classList.add('hidden');
                showMultiCupsSagaView();

                // Forzar carga de tarifas 2.0TD y 3.0TD
                fetchTariffsForMultiCups();
                
            } else {
                // Flujo Individual (2.0TD, 3.0TD)
                document.getElementById('manual-input-btn').textContent = "DATOS A MANO";
                document.getElementById('multicups-finalize-btn-main').classList.add('hidden');
                
                // --- FIX: Loading status displayed during fetch (Issue 1) ---
                document.getElementById('loading-status').textContent = `Cargando tarifas ${config.label}...`;
                document.getElementById('loading-status').classList.remove('hidden');
                document.getElementById('tariff-display-badge').textContent = '0';

                // --- FIX: 3.0TD always manual ---
                if (config.requiresQR && type === '2.0TD') { // 2.0TD is the only single tariff with QR
                    qrButtonsContainer.classList.remove('hidden');
                    document.getElementById('manual-input-btn').classList.add('mt-3');
                    document.getElementById('scan-instruction-text').textContent = "Escanea el c√≥digo QR o introduce datos manualmente.";
                } else { // 3.0TD (Siempre manual)
                    qrButtonsContainer.classList.add('hidden');
                    document.getElementById('manual-input-btn').classList.remove('mt-3');
                    document.getElementById('scan-instruction-text').textContent = "Introduce los datos de la factura manualmente.";
                    document.getElementById('qr-toggle-checkbox').checked = false;
                    document.getElementById('qr-content-wrapper').classList.remove('active');
                }

                document.getElementById('current-tariff-label').textContent = config.label;
                document.getElementById('app-subtitle').textContent = `Comparador ${config.label}`;
                
                // Mostrar/Ocultar inputs P3-P6/E4-E6
                toggleMultiCupsInputPeriods(currentTariffType, 'input');

                // CR√çTICO: Ocultar todas las vistas antes de mostrar initial-view
                document.getElementById('screen-inicio').classList.remove('active'); // Ocultar pantalla inicio
                document.getElementById('landing-view').classList.add('hidden');
                document.getElementById('multicups-saga-view').classList.add('hidden');
                document.getElementById('initial-view').classList.remove('hidden');
                
                // Cargar tarifas al seleccionar tipo
                fetchTariffsFromSheet(currentTariffType);

                if (document.getElementById('qr-toggle-checkbox').checked) {
                    generateQRCode(activeBrand);
                }
            }
        }
        
        function generateQRCode(brand) {
            const qrContainer = document.getElementById('qr-code-container');
            const qrVisualContainer = document.getElementById('qr-visual-container');

            // En modo MULTICUPS el QR siempre enlaza con 2.0TD ya que es el √∫nico compatible con QR
            const tariffParam = currentTariffType === 'MULTICUPS' ? '2.0TD' : currentTariffType;  
            const fullUrl = `${brand.QR_URL}?tariff=${tariffParam}`;  

            qrContainer.innerHTML = '';
            qrCodeInstance = null;

            qrVisualContainer.style.setProperty('--qr-center-text', `'${brand.QR_TEXT}'`);
            qrVisualContainer.style.setProperty('--qr-border-color', brand.QR_BORDER_COLOR);
            qrVisualContainer.style.setProperty('--qr-center-bg', brand.QR_CENTER_BG);
            
            qrCodeInstance = new QRCode(qrContainer, {
                text: fullUrl,
                width: 140,
                height: 140,
                colorDark : brand.QR_CENTER_BG,
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        // --- C√ÅLCULOS Y COMPARACI√ìN INDIVIDUAL/MULTICUPS ---
        
        function calculateDays(startDateStr, endDateStr) {
             try {
                 const [d1, m1, y1] = startDateStr.split('/').map(Number);
                 const [d2, m2, y2] = endDateStr.split('/').map(Number);

                 const date1 = new Date(y1, m1 - 1, d1);
                 const date2 = new Date(y2, m2 - 1, d2);
                 
                 if (isNaN(date1.getTime()) || isNaN(date2.getTime())) return 30;

                 const ONE_DAY_MS = 1000 * 60 * 60 * 24;
                 const diffDays = (date2.getTime() - date1.getTime()) / ONE_DAY_MS;
                 return Math.round(diffDays) + 1;
             } catch (e) {
                 return 30;
             }
        }
        
        const formatIsoToDmy = (iso) => {
             if (!iso) return null;
             const parts = iso.split('-');
             if (parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0]}`;  
             return null;
        };

        function calculateTariffCost(tariff, data, tariffType) {
            const IVA_RATE = 0.21;
            const IE_RATE = 0.05113; // Impuesto El√©ctrico base
            const ANNUAL_DAYS = 365;
            const config = TARIFF_CONFIG[tariffType];  
            
            let subPower = 0;
            let powerCosts = [];
            
            // C√°lculo de Coste de Potencia
            for (let i = 1; i <= (config?.powerPeriods || 6); i++) {
                // Usamos 6 por defecto si no est√° definido (aunque TARIFF_CONFIG est√° bien definido ahora)
                const kw = data[`potencia_p${i}_kw`] || 0;
                const priceAnnual = tariff[`p_potencia_${i}`] || 0;
                const priceDay = priceAnnual / ANNUAL_DAYS;
                const cost = kw * data.dias_facturados * priceDay;
                subPower += cost;
                powerCosts.push({ period: i, cost: cost, priceDay: priceDay, kw: kw, priceAnnual: priceAnnual });
            }

            let subEnergy = 0;
            let energyCosts = [];
            
            // L√≥gica de consumo: usa los campos del data object
            for (let i = 1; i <= (config?.periods || 6); i++) {
                let kwh = 0;
                let price = 0;

                if (tariffType === '2.0TD') {
                    // 2.0TD usa nombres de campo espec√≠ficos para consumo: punta, llano, valle.
                    kwh = i === 1 ? data.consumo_punta : i === 2 ? data.consumo_llano : i === 3 ? data.consumo_valle : 0;
                    price = tariff[`p${i}_price`] || 0;
                } else {
                    // 3.0TD (y 6.1TD, aunque este √∫ltimo se elimin√≥ de la UI, el c√°lculo usa la estructura de 6 periodos)
                    kwh = data[`consumo_p${i}`] || 0;
                    price = tariff[`p${i}_price`] || 0;
                }
                
                const cost = kwh * price;
                energyCosts.push({ period: i, cost: cost, price: price, kwh: kwh });
                subEnergy += cost;
            }

            // Aplicar Descuento
            const discountRate = (tariff.descuento || 0) / 100;
            const discountAmount = subEnergy * discountRate;
            const subEnergyNet = subEnergy - discountAmount;

            // Base Imponible e Impuestos
            const subBase = subPower + subEnergyNet;
            const costIE = subBase * IE_RATE; // Impuesto El√©ctrico
            const baseImp = subBase + costIE;
            const costIVA = baseImp * IVA_RATE;
            const totalPeriod = baseImp + costIVA;
            
            // C√°lculo Anualizado
            const factorAnual = ANNUAL_DAYS / (data.dias_facturados || 30); // Prevenir divisi√≥n por cero/NaN
            const totalAnnual = totalPeriod * factorAnual;
            const originalBillAnnual = data.importe_total * factorAnual;

            const result = {
                ...data,
                tariffType: tariffType, // Tipo de tarifa usada en el c√°lculo (e.g. 2.0TD)
                powerCosts, energyCosts,
                subPower, subEnergy, subEnergyNet,
                discountRate, discountAmount,
                subBase, costIE, baseImp, costIVA, totalPeriod, totalAnnual,
                originalBillAnnual,
                savings: originalBillAnnual - totalAnnual,
                offer: deepCopyOffer(tariff),  // COPIA PROFUNDA para evitar referencias compartidas
                ieRate: IE_RATE
            };
            
            // NOTA: Para la comparativa, NO forzamos la tarifa actual aunque el ahorro sea negativo
            // Necesitamos los valores REALES de cada comercializadora
            // Esta l√≥gica solo aplica en el calculador normal
            /*
            if (result.savings <= 0) {
                result.isNegativeSavings = true;
                result.savings = 0;
                result.totalAnnual = result.originalBillAnnual;  
                result.offer = { name: "Tu Tarifa Actual", description: "Es la mejor opci√≥n detectada", isDrk: false };
            }
            */
            
            return result;
        }

        function compareOffers(data) {
            try {
                // PROTECCI√ìN: Evitar llamadas duplicadas dentro de 500ms con los mismos datos
                const now = Date.now();
                const dataStr = JSON.stringify(data);
                
                if (now - lastCompareOffersCall < 500 && dataStr === lastCompareOffersData) {
                    console.warn('‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è LLAMADA DUPLICADA A compareOffers DETECTADA Y BLOQUEADA ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è');
                    console.warn('Tiempo desde √∫ltima llamada:', now - lastCompareOffersCall, 'ms');
                    console.warn('Datos id√©nticos - ignorando llamada duplicada');
                    return; // Ignorar llamada duplicada
                }
                
                lastCompareOffersCall = now;
                lastCompareOffersData = dataStr;
                
                console.log('=================================================');
                console.log('‚ö°‚ö°‚ö° compareOffers LLAMADA ‚ö°‚ö°‚ö°');
                console.log('Stack trace para identificar origen:');
                console.trace();
                console.log('Data recibida:', data);
                console.log('currentTariffType:', currentTariffType);
                console.log('dualMode activo:', window.dualMode);
                console.log('=================================================');
                
                const tariffType = currentTariffType;  
                const tariffsToCompare = currentTariffs[tariffType] || [];

                console.log(`Tarifas disponibles para ${tariffType}:`, tariffsToCompare.length);

                if (tariffsToCompare.length === 0) {
                    console.error(`No hay tarifas cargadas para ${tariffType}`);
                    return window.showErrorModal(`Las tarifas ${tariffType} no est√°n cargadas. Por favor, espere un momento e intente de nuevo.`);
                }

                const results = tariffsToCompare.map(t => calculateTariffCost(t, data, tariffType));
                console.log('Results calculated:', results.length);
                
                let bestOverall = null;
                let bestDrk = null;

                results.forEach(r => {
                    // Siempre comparamos por el coste anual
                    const annualCost = r.totalAnnual;
                    
                    // Best overall is the one with the lowest annual cost
                    if (!bestOverall || annualCost < bestOverall.totalAnnual) {
                        bestOverall = r;
                    }

                    // Best DRK is the DRK one with the lowest annual cost
                    if (r.offer.isDrk && r.offer.name !== 'Tu Tarifa Actual') {
                        if (!bestDrk || annualCost < bestDrk.totalAnnual) {
                            bestDrk = r;
                        }
                    }
                });

                if (!bestOverall) {
                    console.error('No se encontr√≥ ning√∫n resultado v√°lido');
                    return window.showErrorModal("Sin resultados v√°lidos. Aseg√∫rate de que las tarifas est√°n cargadas.");
                }
                
                console.log('Best overall:', bestOverall.offer.name, bestOverall.totalAnnual);
                console.log('Best DRK:', bestDrk ? bestDrk.offer.name : 'None', bestDrk ? bestDrk.totalAnnual : 0);
                
                // --- GUARDAR OFERTAS CON AHORRO POSITIVO ---
                availableOffers = results.filter(r => {
                    r.savings = r.originalBillAnnual - r.totalAnnual;
                    const hasPositiveSavings = r.savings > 0 && r.totalAnnual < r.originalBillAnnual;
                    
                    // Si modo es "DRK √öNICAMENTE", filtrar solo ofertas DRK
                    if (comparisonMode === 'drk_only') {
                        return hasPositiveSavings && r.offer.isDrk;
                    }
                    
                    // En otros modos, mostrar todas las ofertas con ahorro
                    return hasPositiveSavings;
                });
                console.log('Available offers with savings (filtered by mode):', availableOffers.length);
                console.log('Comparison mode:', comparisonMode);
                
                let final = bestOverall;
                let brand = activeBrand;

                // --- L√ìGICA DE SELECCI√ìN Y BRANDING (Individual) ---
                if (comparisonMode === 'overall_best') {
                    // Modo POWER CUP: Buscar la mejor oferta absoluta (con o sin DRK)
                    final = bestOverall;
                    
                    // Aplicar branding seg√∫n qui√©n gan√≥
                    if (final.offer.isDrk) {
                        brand = BRANDS.DRK;
                    } else {
                        brand = BRANDS.POWER_CUP;
                    }
                } else {
                    // Modos DRK (drk_only, drk_prioritized)
                    if (comparisonMode === 'drk_only') {
                        final = bestDrk || bestOverall;
                        // DRK √öNICAMENTE: SIEMPRE mantener branding DRK (azul)
                        brand = BRANDS.DRK;
                    } else if (comparisonMode === 'drk_prioritized') {
                        // Usar DRK si tiene ahorro, sino usar la mejor absoluta
                        final = (bestDrk && bestDrk.totalAnnual < bestDrk.originalBillAnnual) ? bestDrk : bestOverall;
                        
                        // DRK PRIORITARIO: Solo cambiar a POWER_CUP si gan√≥ una comercializadora NO-DRK
                        if (final.offer.isDrk) {
                            brand = BRANDS.DRK;
                        } else {
                            brand = BRANDS.POWER_CUP;
                        }
                    }
                }
                
                console.log('Final selection:', final.offer.name, 'Brand:', brand.NAME);
                
                // Recalcular el ahorro basado en el resultado final seleccionado
                final.savings = final.originalBillAnnual - final.totalAnnual;
                
                // Manejar casos sin ahorro
                if (final.savings <= 0) {
                    final.isNegativeSavings = true;
                    final.savings = 0;
                    final.totalAnnual = final.originalBillAnnual;
                    final.offer = { 
                        name: "Tu Tarifa Actual", 
                        description: "Es la mejor opci√≥n detectada", 
                        isDrk: false 
                    };
                    // Mantener el branding seg√∫n el modo seleccionado
                    brand = comparisonMode === 'overall_best' ? BRANDS.POWER_CUP : BRANDS.DRK;
                }
                // Add originalTariffType for consistent logic in HTML generation
                final.originalTariffType = tariffType;

                lastComparisonResult = final;
                
                console.log('About to apply brand styles. Brand:', brand.NAME);
                try {
                    applyBrandStyles(brand);
                    console.log('Brand styles applied successfully');
                } catch (styleError) {
                    console.error('Error in applyBrandStyles:', styleError);
                    throw styleError;
                }
                
                // Guardar el resultado temporalmente
                lastComparisonResult = final;
                lastComparisonResult.isMulti = false;
                
                console.log('Checking available offers...');
                console.log('availableOffers.length:', availableOffers.length);
                console.log('final.savings:', final.savings);
                console.log('currentTariffType:', currentTariffType);
                
                // NUEVA L√ìGICA: Si hay ofertas con ahorro, mostrar modal de decisi√≥n
                // PERO SOLO en modo individual, NO en MultiCups
                const isMultiCupsMode = currentTariffType === 'MULTICUPS';
                
                if (!isMultiCupsMode && availableOffers.length > 1) {
                    console.log('Showing decision modal with', availableOffers.length, 'offers');
                    showOfferDecisionModal();
                    return; // No mostrar resultados todav√≠a, esperar decisi√≥n del usuario
                }
                
                // Si es MultiCups, solo hay 1 oferta, o ninguna, mostrar resultados directamente
                console.log('About to render UI...');
                renderResultsUI(final);
                
                console.log('Showing results view...');
                document.getElementById('initial-view').classList.add('hidden');
                document.getElementById('scanner-view').classList.add('hidden');
                
                // NUEVO: Si estamos en modo DUAL, mostrar confirmaci√≥n en lugar de resultados
                if (window.dualMode === true) {
                    console.log('Modo DUAL detectado - a√±adiendo suministro al array');
                    
                    // Extraer datos para DUAL
                    const tariff = final.tariffType || currentTariffType || '2.0TD';
                    const data = {
                        tariff: tariff,
                        kwh_p1: parseFloat(final.kwh_p1) || 0,
                        kwh_p2: parseFloat(final.kwh_p2) || 0,
                        kwh_p3: parseFloat(final.kwh_p3) || 0,
                        kwh_p4: parseFloat(final.kwh_p4) || 0,
                        kwh_p5: parseFloat(final.kwh_p5) || 0,
                        kwh_p6: parseFloat(final.kwh_p6) || 0,
                        p1: parseFloat(final.p1) || 0,
                        p2: parseFloat(final.p2) || 0,
                        p3: parseFloat(final.p3) || 0,
                        p4: parseFloat(final.p4) || 0,
                        p5: parseFloat(final.p5) || 0,
                        p6: parseFloat(final.p6) || 0,
                        dias: parseInt(final.dias) || 30
                    };
                    
                    let drkCost = 0;
                    let powercupCost = 0;
                    
                    if (final.bestOffer) {
                        drkCost = parseFloat(final.bestOffer.annual_cost) || parseFloat(final.bestOffer.total_cost_period) * 12 || 0;
                    }
                    
                    if (final.indexedResult) {
                        powercupCost = parseFloat(final.indexedResult.annual_cost) || parseFloat(final.indexedResult.total_cost_period) * 12 || 0;
                    }
                    
                    if (drkCost === 0 && final.aggregatedData) {
                        drkCost = parseFloat(final.aggregatedData.total_anual_drk) || 0;
                    }
                    
                    if (powercupCost === 0 && final.aggregatedData) {
                        powercupCost = parseFloat(final.aggregatedData.total_anual_powercup) || 0;
                    }
                    
                    if (drkCost === 0 && final.offer) {
                        drkCost = parseFloat(final.offer.annual_cost) || 0;
                    }
                    
                    const results = {
                        drk: {
                            total: drkCost / 12,
                            total_anual: drkCost
                        },
                        powercup: {
                            total: powercupCost / 12,
                            total_anual: powercupCost
                        }
                    };
                    
                    // NUEVO FLUJO DUAL: A√±adir suministro directamente al array
                    const currentCost = comparisonMode === 'overall_best' ? powercupCost : drkCost;
                    const originalBill = parseFloat(final.originalBillAnnual) || parseFloat(final.totalBillPeriod) * 12 || 0;
                    
                    // CORRECCI√ìN: Usar final.totalAnnual si existe (ya tiene la l√≥gica de "Tu Tarifa Actual")
                    const totalAnnualCost = final.totalAnnual || currentCost;
                    
                    const newSupply = {
                        type: 'electricidad',
                        tariff: tariff,
                        cups: final.cups || 'CUPS-ELECTRICIDAD',
                        originalBillAnnual: originalBill,
                        totalAnnual: totalAnnualCost, // Usar el valor correcto
                        offer: final.bestOffer || final.offer,
                        data: final,
                        electricityBreakdown: {
                            energyCosts: final.energyCosts || [],
                            powerCosts: final.powerCosts || [],
                            subEnergy: final.subEnergyNet || 0,
                            subPower: final.subPower || 0,
                            subBase: final.subBase || 0,
                            costIE: final.costIE || 0,
                            baseImp: final.baseImp || 0,
                            costIVA: final.costIVA || 0,
                            totalPeriod: final.totalPeriod || 0,
                            totalAnnual: final.totalAnnual || 0,
                            ahorro_mensual: (final.originalBillPeriod || 0) - (final.totalPeriod || 0),
                            ahorro_anual: final.savings || (originalBill - totalAnnualCost), // Usar final.savings si existe
                            dias: final.dias_facturados || 30
                        },
                        results: results
                    };
                    
                    // A√±adir al array
                    dualSupplies.push(newSupply);
                    console.log('‚úÖ Suministro ELECTRICIDAD a√±adido al array DUAL');
                    console.log('  - Total suministros:', dualSupplies.length);
                    console.log('  - CUPS:', newSupply.cups);
                    console.log('  - originalBillAnnual:', newSupply.originalBillAnnual);
                    console.log('  - totalAnnual:', newSupply.totalAnnual);
                    console.log('  - final.totalAnnual (source):', final.totalAnnual);
                    console.log('  - final.savings:', final.savings);
                    console.log('  - results.drk.total_anual:', newSupply.results.drk.total_anual);
                    console.log('  - results.powercup.total_anual:', newSupply.results.powercup.total_anual);
                    console.log('  - Ahorro:', (originalBill - totalAnnualCost).toFixed(2), '‚Ç¨/a√±o');
                    
                    // Actualizar lista
                    updateDualSuppliesList();
                    
                    // Volver al gestor DUAL
                    hideAllScreens();
                    document.getElementById('screen-dual').classList.add('active');
                    
                    console.log('‚úÖ Usuario puede a√±adir m√°s suministros o calcular');
                
                } else {
                    // Flujo normal - mostrar resultados
                    document.getElementById('screen-inicio').classList.remove('active'); // Ocultar pantalla inicio
                    document.getElementById('results-view').classList.remove('hidden');
                    document.getElementById('results-view').classList.add('animate-fade-in-up');
                    hideNavbar(); // Ocultar navbar al mostrar resultados
                    
                    // Detectar modo DUAL y mostrar bot√≥n si corresponde
                    if (window.checkDualMode) window.checkDualMode();
                }
                
                console.log('compareOffers completed successfully');
            } catch (error) {
                console.error('Error in compareOffers:', error);
                window.showErrorModal(`Error al calcular: ${error.message}. Por favor, intente de nuevo.`);
            }
        }


        // --- L√ìGICA MULTICUPS ---

        /**
         * Nueva vista intermedia para seleccionar 2.0TD o 3.0TD en modo MultiCups.
         */
        function showMultiCupsSagaView() {
            document.getElementById('initial-view').classList.add('hidden');
            document.getElementById('landing-view').classList.add('hidden');
            document.getElementById('multicups-saga-view').classList.remove('hidden');
            document.getElementById('app-subtitle').textContent = TARIFF_CONFIG.MULTICUPS.label;
            
            // Mostrar secci√≥n de tipo de selecci√≥n de oferta

            updateMultiCupsSagaView();
        }
        
        /**
         * Actualiza el contador y el bot√≥n de finalizar en la vista SAGA.
         */
        function updateMultiCupsSagaView() {
            const totalCount = multiCupsData.length;
            document.getElementById('saga-total-cups').textContent = totalCount;
            document.getElementById('saga-finalize-count').textContent = totalCount;
            
            const finalizeBtn = document.getElementById('multicups-finalize-btn-saga');
            if (totalCount > 0) {
                finalizeBtn.classList.remove('hidden');
            } else {
                finalizeBtn.classList.add('hidden');
            }

            // Habilitar botones si las tarifas est√°n cargadas
            const loadingEl = document.getElementById('loading-status-saga');
            const isReady = currentTariffs['2.0TD'].length > 0 && currentTariffs['3.0TD'].length > 0;
            const sagaButtonWrapper = document.getElementById('saga-button-wrapper');

            if (isReady) {
                loadingEl.classList.add('hidden');
                sagaButtonWrapper.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                loadingEl.classList.remove('hidden');
                sagaButtonWrapper.classList.add('opacity-50', 'pointer-events-none');
            }
        }
        
        /**
         * Se llama al pulsar 2.0TD o 3.0TD en la vista SAGA.
         * @param {string} type - '2.0TD' or '3.0TD'
         */
        window.selectMultiCupType = (type) => {
            multiCupsAddType = type;
            
            // 1. Ocultar Saga, Mostrar Vista de entrada
            document.getElementById('multicups-saga-view').classList.add('hidden');
            document.getElementById('initial-view').classList.remove('hidden');
            
            // 2. Configurar el bot√≥n de volver
            document.getElementById('back-button-label').textContent = "a MultiCups";
            
            // 3. Configurar Vista de entrada
            const qrButtonsContainer = document.getElementById('qr-buttons-container');
            const manualInputBtn = document.getElementById('manual-input-btn');
            const currentTariffLabel = document.getElementById('current-tariff-label');
            const scanInstructionText = document.getElementById('scan-instruction-text');

            currentTariffLabel.textContent = `MULTICUPS (${type})`;
            document.getElementById('tariff-display-badge').textContent = multiCupsData.length; // Keep existing count

            if (type === '2.0TD') {
                // 2.0TD: QR and Manual
                qrButtonsContainer.classList.remove('hidden');
                manualInputBtn.classList.add('mt-3');
                scanInstructionText.textContent = "Escanea el c√≥digo QR (2.0TD) o introduce datos manualmente.";
                document.getElementById('scan-instruction-text').classList.remove('hidden'); // Ensure instruction is visible
            } else if (type === '3.0TD') {
                // 3.0TD: ONLY Manual
                qrButtonsContainer.classList.add('hidden');
                manualInputBtn.classList.remove('mt-3');
                scanInstructionText.textContent = "Introduce los datos de la factura 3.0TD manualmente.";
                document.getElementById('scan-instruction-text').classList.remove('hidden'); // Ensure instruction is visible
            }
            
            manualInputBtn.textContent = "A√ëADIR SUMINISTRO MANUAL";
            // Asegurarse de aplicar los estilos correctos al bot√≥n manual
            applyBrandStyles(activeBrand);  
            // Ocultar status de carga, ya que ya est√°n cargadas desde la vista SAGA
            document.getElementById('loading-status').classList.add('hidden');
        }

        function finalizeMultiCups() {
            if (multiCupsData.length === 0) return window.showErrorModal("A√±ada al menos un suministro.");

            compareMultiOffers();
        }

        function compareMultiOffers() {
            if (multiCupsData.length === 0) return window.showErrorModal("No hay suministros para comparar.");
            
            console.log('=== DIAGN√ìSTICO AHORRO CONSOLIDADO ===');
            console.log('Total CUPS:', multiCupsData.length);
            
            // Verificar si hay comparaciones indexadas
            const hasIndexedComparisons = multiCupsData.some(d => d.indexedComparison);
            console.log('¬øHay comparaciones indexadas?', hasIndexedComparisons);
            
            // Mostrar datos de cada CUPS antes de la suma
            multiCupsData.forEach((cups, idx) => {
                console.log(`CUPS ${idx + 1}:`, cups.cups);
                console.log(`  - Original Annual: ${cups.originalBillAnnual}`);
                console.log(`  - Total Annual (Fijo): ${cups.totalAnnual}`);
                console.log(`  - Savings (Fijo): ${cups.savings}`);
                if (cups.indexedComparison) {
                    console.log(`  - ‚úÖ TIENE indexedComparison:`, cups.indexedComparison.offer.name);
                    console.log(`  - Total Annual (Indexado): ${cups.indexedComparison.totalAnnual}`);
                    console.log(`  - Savings (Indexado): ${cups.indexedComparison.savings}`);
                    console.log(`  - originalTariffType (Indexado): ${cups.indexedComparison.originalTariffType}`);
                } else {
                    console.log(`  - ‚ùå NO tiene indexedComparison`);
                }
            });
            
            // 1. Acumular Totales y Consumos (FIJO)
            const total = multiCupsData.reduce((acc, current) => {
                const newAnnual = current.totalAnnual;  
                
                acc.originalBillAnnual += current.originalBillAnnual;
                acc.totalAnnual += newAnnual;
                acc.totalPeriod += current.importe_total;

                // Acumulaci√≥n de Potencias y Energ√≠as
                const type = current.originalTariffType;
                
                for (let i = 1; i <= 6; i++) {
                    const kwKey = `potencia_p${i}_kw`;
                    if (current[kwKey] !== undefined) {
                        const groupKey = (type === '2.0TD' ? '2.0TD' : '3.0TD');
                        
                        if (TARIFF_CONFIG[type]?.powerPeriods >= i || type === '3.0TD') {
                            acc.aggregatedData[groupKey].power[`p${i}`] += current[kwKey] || 0;
                        }
                    }
                }

                if (type === '2.0TD') {
                    acc.aggregatedData[type].energy.e1 += current.consumo_punta || 0;
                    acc.aggregatedData[type].energy.e2 += current.consumo_llano || 0;
                    acc.aggregatedData[type].energy.e3 += current.consumo_valle || 0;
                } else if (type === '3.0TD') {
                    for (let i = 1; i <= 6; i++) {
                        acc.aggregatedData['3.0TD'].energy[`e${i}`] += current[`consumo_p${i}`] || 0;
                    }
                }
                
                return acc;
            }, {
                originalBillAnnual: 0,
                totalAnnual: 0,
                totalPeriod: 0,
                diasFacturados: 0,
                aggregatedData: {
                    '2.0TD': { power: { p1: 0, p2: 0, p3: 0, p4: 0, p5: 0, p6: 0 }, energy: { e1: 0, e2: 0, e3: 0, e4: 0, e5: 0, e6: 0 } },
                    '3.0TD': { power: { p1: 0, p2: 0, p3: 0, p4: 0, p5: 0, p6: 0 }, energy: { e1: 0, e2: 0, e3: 0, e4: 0, e5: 0, e6: 0 } }
                }
            });

            // 1b. Si hay comparaciones indexadas, acumular tambi√©n esos totales
            let totalIndexed = null;
            if (hasIndexedComparisons) {
                totalIndexed = multiCupsData.reduce((acc, current) => {
                    if (current.indexedComparison) {
                        acc.totalAnnual += current.indexedComparison.totalAnnual;
                    }
                    return acc;
                }, {
                    originalBillAnnual: total.originalBillAnnual, // Mismo original
                    totalAnnual: 0,
                    totalPeriod: total.totalPeriod
                });
                
                totalIndexed.savings = totalIndexed.originalBillAnnual - totalIndexed.totalAnnual;
                console.log('Total Indexado acumulado:', totalIndexed);
            }

            // 2. Calcular Ahorro Final Consolidado (FIJO)
            total.savings = total.originalBillAnnual - total.totalAnnual;
            
            console.log('=== TOTALES ACUMULADOS ===');
            console.log('Total originalBillAnnual:', total.originalBillAnnual);
            console.log('Total totalAnnual:', total.totalAnnual);
            console.log('Total savings calculado:', total.savings);

            // 3. Determinar la Oferta de Referencia para el resumen
            let bestOverallWinner = multiCupsData.reduce((best, current) => {
                // If this item has more savings, it becomes the reference.
                if (current.savings > best.savings) return { savings: current.savings, offer: current.offer, originalTariffType: current.originalTariffType };
                return best;
            }, { 
                savings: -1, 
                offer: { name: 'Resultado Consolidado', description: 'N/A', isDrk: false },
                originalTariffType: 'N/A'
            });

            if (total.savings <= 0) {
                bestOverallWinner.offer = { name: tr("Tu Tarifa Actual"), description: tr("Es la mejor opci√≥n consolidada"), isDrk: false };
                total.savings = 0; // Ensure consistency
            } else {
                // Ahorro positivo: Usar un nombre gen√©rico para la cabecera
                const genericName = activeBrand.NAME.includes('DRK') ? 'DRK Energ√≠a' : 'POWER CUP';
                const genericDescription = tr('Ofrece el mayor ahorro consolidado con') + ' ' + genericName + '.';

                bestOverallWinner.offer = { 
                    name: genericName, 
                    description: genericDescription, 
                    // Se usa la bandera isDrk basada en el modo de comparaci√≥n para el styling/branding
                    isDrk: activeBrand.NAME.includes('DRK') 
                };
            }

            const finalResult = {
                cups: `${multiCupsData.length} CUPS`, // String for display
                multiCupsList: multiCupsData.map(d => `${d.cups} (${d.originalTariffType})`).join(', '),
                dias_facturados: total.diasFacturados, // Should remain N/A or 0 for multi-cups
                importe_total: total.totalPeriod,
                originalBillAnnual: total.originalBillAnnual,
                totalAnnual: total.totalAnnual,
                savings: total.savings,
                offer: bestOverallWinner.offer, // Use the (potentially generic) offer for the header display
                isMulti: true,
                isMultiCups: true, // IMPORTANTE: A√±adir esta propiedad para que se detecte correctamente
                individualResults: multiCupsData, // A√±adir resultados individuales para el desglose HTML
                aggregatedData: total.aggregatedData,
                // A√±adir datos indexados si existen
                indexedTotals: totalIndexed // Ser√° null si no hay comparaciones indexadas
            };
            
            console.log('finalResult created:', finalResult);
            if (totalIndexed) {
                console.log('finalResult incluye datos indexados:', totalIndexed);
            }
            
            lastComparisonResult = finalResult;
            
            // --- L√ìGICA DE BRANDING (MultiCups) ---
            let brandToApply = activeBrand;
            
            if (comparisonMode === 'overall_best') {
                // REQUERIMIENTO DEL USUARIO: Si es modo Power Cup Global, siempre usa Power Cup.
                brandToApply = BRANDS.POWER_CUP;
            } else {
                // DRK modes (drk_only, drk_prioritized)
                if (finalResult.savings <= 0) {
                    // No savings, stick to the initial DRK brand
                    brandToApply = BRANDS.DRK;
                } else if (bestOverallWinner.offer.isDrk) {
                    // DRK won overall combo -> Use DRK brand
                    brandToApply = BRANDS.DRK;
                } else {
                    // Competitor won overall combo in a DRK mode -> Use Power Cup (general market/non-DRK saving)
                    brandToApply = BRANDS.POWER_CUP;
                }
            }
            
            applyBrandStyles(brandToApply);
            
            renderMultiResultsUI(finalResult);
            
            document.getElementById('screen-inicio').classList.remove('active'); // Ocultar pantalla inicio
            document.getElementById('initial-view').classList.add('hidden');
            document.getElementById('multicups-saga-view').classList.add('hidden');
            document.getElementById('scanner-view').classList.add('hidden');
            document.getElementById('results-view').classList.remove('hidden');
            document.getElementById('results-view').classList.add('animate-fade-in-up');
            hideNavbar(); // Ocultar navbar al mostrar resultados
        }


        // Nueva funci√≥n para renderizar comparaci√≥n dual en MULTICUPS
        function renderMultiDualComparisonUI(res) {
            console.log('renderMultiDualComparisonUI llamada', res);
            
            // IMPORTANTE: Asegurar que la variable global est√© guardada
            if (!lastComparisonResult) {
                lastComparisonResult = res;
            }
            
            const brand = activeBrand;
            const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            
            // CR√çTICO: Colores din√°micos seg√∫n marca
            const isDrk = brand.NAME.includes('DRK');
            const brandPrefix = isDrk ? 'drk' : 'powercup';  // drk (azul) o powercup (verde)
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // BOT√ìN ROJO DE VOLVER (RECARGA P√ÅGINA)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            let backButtonContainer = document.getElementById('back-button-top-container');
            if (!backButtonContainer) {
                backButtonContainer = document.createElement('div');
                backButtonContainer.id = 'back-button-top-container';
                backButtonContainer.className = 'fixed top-0 left-0 right-0 z-[100] bg-white shadow-lg p-3 border-b-4 border-red-500';
                backButtonContainer.innerHTML = `
                    <div class="max-w-lg mx-auto">
                        <button id="force-back-button" class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-black py-4 px-6 rounded-xl shadow-2xl transform transition active:scale-95 flex items-center justify-center gap-3 text-lg">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                            <span>‚¨ÖÔ∏è VOLVER AL INICIO</span>
                        </button>
                    </div>
                `;
                document.body.insertBefore(backButtonContainer, document.body.firstChild);
                
                document.getElementById('force-back-button').addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üîÑ RECARGANDO P√ÅGINA (MULTICUPS)...');
                    window.location.reload();
                });
            }
            backButtonContainer.style.display = 'block';
            
            const resultsView = document.getElementById('results-view');
            if (resultsView) {
                resultsView.style.paddingTop = '80px';
            }
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // FIN BOT√ìN ROJO
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            
            // Banner
            const companyBanner = document.getElementById('company-banner');
            
            // CR√çTICO: Usar colores din√°micos seg√∫n marca
            if (isDrk) {
                // DRK - Banner mejorado y m√°s grande
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-drk-900 via-drk-800 to-drk-700 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                            <div class="transform scale-125">
                                ${brand.LOGO_SVG}
                            </div>
                            <div class="text-center md:text-left">
                                <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">${brand.FULL_NAME}</h1>
                                <p class="text-drk-100 text-lg md:text-xl font-semibold">${tr('Liderando el ahorro y la eficiencia energ√©tica')}</p>
                            </div>
                        </div>
                        <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">üìä ESTUDIO DE AHORRO</p>
                            <p class="text-drk-100 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                            <p class="text-drk-100 text-base md:text-lg font-bold">${tr("PROFESIONAL")}</p>
                        </div>
                    </div>
                `;
            } else {
                // POWER CUP - Banner mejorado y m√°s grande
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-powercup-700 via-powercup-600 to-powercup-500 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                            <div class="transform scale-125">
                                ${brand.LOGO_SVG}
                            </div>
                            <div class="text-center md:text-left">
                                <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">${brand.FULL_NAME}</h1>
                                <p class="text-powercup-50 text-lg md:text-xl font-semibold">Asesor√≠a Energ√©tica</p>
                            </div>
                        </div>
                        <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">üìä ESTUDIO DE AHORRO</p>
                            <p class="text-powercup-50 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                            <p class="text-powercup-50 text-base md:text-lg font-bold">${tr("PROFESIONAL")}</p>
                        </div>
                    </div>
                `;
            }
            
            // CUPS list
            document.getElementById('results-cups-list').innerHTML = `
                Total: ${res.cups} - <span class="text-xs">${res.multiCupsList}</span>
            `;
            
            // Calcular totales indexados
            const totalIndexadoAnual = res.indexedTotals ? res.indexedTotals.totalAnnual : 0;
            const ahorroIndexado = res.indexedTotals ? res.indexedTotals.savings : 0;
            
            // Vista con TRES COLUMNAS (similar a individual pero con totales MULTICUPS)
            const resultCard = document.getElementById('result-card');
            resultCard.innerHTML = `
                <div class="p-4">
                    <h2 class="text-xl font-black text-slate-800 mb-4 text-center">
                        üìä COMPARATIVA MULTICUPS: ${res.cups}
                    </h2>
                    
                    <!-- TRES COLUMNAS -->
                    <div class="grid grid-cols-3 gap-3 mb-6">
                        <!-- COLUMNA 1: TU FACTURA ACTUAL -->
                        <div class="text-center">
                            <div class="bg-slate-600 text-white py-2 px-2 rounded-t-lg">
                                <p class="text-xs font-bold uppercase"${tr("TU FACTURA ACTUAL")}</p>
                            </div>
                            <div class="bg-white border-2 border-slate-300 rounded-b-lg p-3">
                                <p class="text-xs text-slate-500 mb-2 uppercase"${tr("TU FACTURA ACTUAL")}</p>
                                <p class="text-2xl font-black text-red-600 line-through mb-2">${eur(res.importe_total)}</p>
                                <p class="text-xs text-slate-500 mb-3">${tr('Total Periodo')} (${res.dias_facturados || 'varios'} ${tr('d√≠as')})</p>
                                <p class="text-2xl font-black text-red-600">${eur(res.originalBillAnnual)}${tr("/a√±o")}</p>
                            </div>
                        </div>
                        
                        <!-- COLUMNA 2: LA MEJOR OPCI√ìN - FIJO (Color de marca) -->
                        <div class="text-center">
                            <div class="${isDrk ? 'bg-drk-600' : 'bg-powercup-600'} text-white py-2 px-2 rounded-t-lg">
                                <p class="text-xs font-bold uppercase">LA MEJOR OPCI√ìN PARA TI ES ${isDrk ? 'DRK' : 'POWER CUP'}</p>
                            </div>
                            <div class="${isDrk ? 'bg-drk-50 border-drk-400' : 'bg-powercup-50 border-powercup-400'} border-2 rounded-b-lg p-3">
                                <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} mb-2 font-bold">${isDrk ? 'DRK' : 'POWER CUP'} - TARIFAS FIJAS</p>
                                <p class="text-2xl font-black ${isDrk ? 'text-drk-900' : 'text-powercup-900'} mb-2">${eur(res.totalAnnual / 12)}${tr("/mes")}</p>
                                <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} mb-3"${tr("Estimado Mensual")}</p>
                                <p class="text-2xl font-black ${isDrk ? 'text-drk-900' : 'text-powercup-900'}">${eur(res.totalAnnual)}${tr("/a√±o")}</p>
                            </div>
                        </div>
                        
                        <!-- COLUMNA 3: LA MEJOR OPCI√ìN - INDEXADO (Verde) -->
                        <div class="text-center">
                            <div class="bg-green-600 text-white py-2 px-2 rounded-t-lg">
                                <p class="text-xs font-bold uppercase">LA MEJOR OPCI√ìN PARA TI ES ${isDrk ? 'DRK' : 'POWER CUP'}</p>
                            </div>
                            <div class="bg-green-50 border-2 border-green-400 rounded-b-lg p-3">
                                <p class="text-xs text-green-700 mb-2 font-bold">${isDrk ? 'DRK' : 'POWER CUP'} - TARIFAS INDEXADAS</p>
                                <p class="text-2xl font-black text-green-900 mb-2">${eur(totalIndexadoAnual / 12)}${tr("/mes")}</p>
                                <p class="text-xs text-green-700 mb-3"${tr("Estimado Mensual")}</p>
                                <p class="text-2xl font-black text-green-900">${eur(totalIndexadoAnual)}${tr("/a√±o")}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AHORROS -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="${isDrk ? 'bg-drk-100 border-drk-400' : 'bg-powercup-100 border-powercup-400'} border-2 rounded-xl p-4 text-center">
                            <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} font-bold uppercase mb-2">üíº TU AHORRO CON TARIFAS FIJAS</p>
                            <p class="text-4xl font-black text-green-600">${eur(res.savings)}</p>
                            <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} mt-1">Ahorro anual estimado total</p>
                        </div>
                        <div class="bg-green-100 border-2 border-green-400 rounded-xl p-4 text-center">
                            <p class="text-xs text-green-700 font-bold uppercase mb-2">‚ö° TU AHORRO CON TARIFAS INDEXADAS</p>
                            <p class="text-4xl font-black text-green-600">${eur(ahorroIndexado)}</p>
                            <p class="text-xs text-green-700 mt-1">Ahorro anual estimado total</p>
                        </div>
                    </div>
                    
                    <!-- LISTADO DE CUPS -->
                    <div class="bg-slate-50 rounded-xl p-4 mb-4">
                        <h3 class="text-sm font-black text-slate-800 mb-3 text-center">
                            üìã DETALLE POR SUMINISTRO
                        </h3>
                        <div class="grid md:grid-cols-2 gap-4 text-xs">
                            <!-- Lista FIJAS -->
                            <div>
                                <p class="font-bold text-blue-700 mb-2">üíº TARIFAS FIJAS:</p>
                                <div class="space-y-2">
                                    ${res.individualResults.map((supply, idx) => `
                                        <div class="bg-white rounded p-2 border border-blue-200">
                                            <div class="flex justify-between items-start mb-1">
                                                <span class="font-mono text-slate-600">${supply.cups.slice(-12)}</span>
                                                <span class="font-bold text-green-600">${eur(supply.savings)}</span>
                                            </div>
                                            <div class="text-slate-700">
                                                <span class="font-semibold">${supply.offer.name}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Lista INDEXADAS -->
                            <div>
                                <p class="font-bold text-green-700 mb-2">‚ö° TARIFAS INDEXADAS:</p>
                                <div class="space-y-2">
                                    ${res.individualResults.map((supply, idx) => {
                                        const indexedOffer = supply.indexedComparison ? supply.indexedComparison.offer : null;
                                        const indexedSavings = supply.indexedComparison ? supply.indexedComparison.savings : 0;
                                        return `
                                        <div class="bg-white rounded p-2 border border-green-200">
                                            <div class="flex justify-between items-start mb-1">
                                                <span class="font-mono text-slate-600">${supply.cups.slice(-12)}</span>
                                                <span class="font-bold text-green-600">${eur(indexedSavings)}</span>
                                            </div>
                                            <div class="text-slate-700">
                                                <span class="font-semibold">${indexedOffer ? indexedOffer.name : 'N/A'}</span>
                                            </div>
                                        </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- NOTA IMPORTANTE -->
                    <div class="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-4 mb-6">
                        <p class="text-sm text-yellow-900">
                            <strong>‚ö†Ô∏è Importante:</strong> El PDF y HTML incluir√°n el desarrollo detallado de c√°lculos para cada CUPS, 
                            mostrando las f√≥rmulas completas de potencia y energ√≠a tanto para tarifas fijas como indexadas.
                        </p>
                    </div>
                </div>
            `;
            
            // Configurar el bot√≥n existente (NO crear uno nuevo)
            const sendOfferBtn = document.getElementById('send-offer-btn');
            if (sendOfferBtn) {
                sendOfferBtn.style.display = 'flex'; // Asegurar que est√© visible
                sendOfferBtn.onclick = () => {
                    document.getElementById('send-offer-modal').classList.remove('hidden');
                    document.getElementById('send-offer-modal').classList.add('flex');
                    document.querySelectorAll('#send-offer-modal input').forEach(input => {
                        input.classList.remove('focus:ring-drk-500', 'focus:ring-powercup-500');
                        input.classList.add(activeBrand.NAME.includes('DRK') ? 'focus:ring-drk-500' : 'focus:ring-powercup-500');
                    });
                };
            }
            
            // Ocultar detalles
            document.getElementById('details-toggle-btn').style.display = 'none';
            document.getElementById('details-container').style.display = 'none';
            
            // IMPORTANTE: Asegurar que el bot√≥n "Realizar Nueva Comparaci√≥n" est√© visible y funcional
            const resetButton = document.querySelector('#results-view button[onclick="resetToLanding()"]');
            if (resetButton) {
                resetButton.style.display = 'flex';
                resetButton.style.visibility = 'visible';
                resetButton.classList.remove('hidden');
            }
        }
        /**
         * Rellena la vista de resultados con los datos acumulados para MULTICUPS.
         * @param {Object} res - Resultado final de la comparaci√≥n acumulada.
         */
        function renderMultiResultsUI(res) {
            // Si hay resultados indexados, usar vista de comparaci√≥n dual
            if (res.indexedTotals) {
                renderMultiDualComparisonUI(res);
                return;
            }
            
            // Si no hay resultados indexados, continuar con la vista normal
            const offer = res.offer;
            let brand = activeBrand; // Use activeBrand set by comparisonMode
            const individualResults = res.individualResults;
            const aggregatedData = res.aggregatedData;
            const isDrk = brand.NAME.includes('DRK');
            
            // FIX: Usar funciones robustas contra NaN
            const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
            
            // NUEVO: Generar banner de empresa din√°mico para MultiCups
            const companyBanner = document.getElementById('company-banner');
            if (isDrk) {
                // DRK - Banner mejorado
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-drk-900 via-drk-800 to-drk-700 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                            <div class="transform scale-125">
                                ${brand.LOGO_SVG}
                            </div>
                            <div class="text-center md:text-left">
                                <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">DRK ENERG√çA</h1>
                                <p class="text-drk-100 text-lg md:text-xl font-semibold">${tr('Liderando el ahorro y la eficiencia energ√©tica')}</p>
                            </div>
                        </div>
                        <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">üìä ESTUDIO DE AHORRO</p>
                            <p class="text-drk-100 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                            <p class="text-drk-100 text-base md:text-lg font-bold">${tr("PROFESIONAL")}</p>
                        </div>
                    </div>
                `;
            } else {
                // POWER CUP - Banner mejorado
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-powercup-700 via-powercup-600 to-powercup-500 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                            <div class="transform scale-125">
                                ${brand.LOGO_SVG}
                            </div>
                            <div class="text-center md:text-left">
                                <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">POWER CUP</h1>
                                <p class="text-powercup-50 text-lg md:text-xl font-semibold">Asesor√≠a Energ√©tica</p>
                            </div>
                        </div>
                        <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">üìä ESTUDIO DE AHORRO</p>
                            <p class="text-powercup-50 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                            <p class="text-powercup-50 text-base md:text-lg font-bold">${tr("PROFESIONAL")}</p>
                        </div>
                    </div>
                `;
            }
            
            // 1. Cabecera y Resumen Global
            document.getElementById('results-cups-list').innerHTML = `
                ${tr('CUPS Procesadas')}: ${individualResults.length}
            `;

            // MODIFICACI√ìN: Mostrar Nombre y Descripci√≥n.
            // Si el nombre es gen√©rico ("Tu Mejor Elecci√≥n"), solo mostramos el nombre en H2 y la descripci√≥n en el p√°rrafo.
            if (res.isMulti && res.savings > 0 && offer.name !== "Tu Tarifa Actual") {
                document.getElementById('best-offer-name').textContent = offer.name;
                document.getElementById('best-offer-desc').textContent = offer.description;
            } else {
                // Opci√≥n 'Tu Tarifa Actual' o individual (mantiene el formato combinado)
                document.getElementById('best-offer-name').textContent = `${offer.name || ''}`;
                document.getElementById('best-offer-desc').textContent = offer.description;
            }
            
            const savingsEl = document.getElementById('savings-estimate');
            const newCostLabelEl = document.getElementById('new-cost-label');
            const oldCostPeriodEl = document.getElementById('old-period-cost-display');
            const oldCostAnnualEl = document.getElementById('old-annual-cost-display');

            // Resetear clases de color din√°micas
            savingsEl.className = 'text-5xl font-black tracking-tight';
            oldCostPeriodEl.classList.remove('line-through', 'text-red-400', 'text-cta-green-500', 'decoration-red-400/50');
            oldCostAnnualEl.classList.remove('line-through', 'text-cta-red-500', 'text-cta-green-500', 'decoration-cta-red-500/50');

            if (res.savings <= 0) {
                // Mensaje especial cuando no hay ahorro
                document.getElementById('savings-label').textContent = "¬°ENHORABUENA!";
                savingsEl.innerHTML = `<div class="text-lg leading-tight font-bold">${tr("Actualmente est√°s en una buena tarifa.")}</div><div class="text-sm mt-3 leading-relaxed">${tr("Seguiremos estudiando el mercado y te avisaremos cuando encontremos alguna tarifa que se adapte a tu perfil de consumo.")}</div>`;
                const colorClass = brand.PRIMARY_TEXT.replace('text-', '');
                savingsEl.classList.add('text-' + colorClass);
                savingsEl.classList.remove('text-5xl', 'font-black');
                savingsEl.classList.add('text-base');
                
                // Ocultar columnas de precios
                document.getElementById('price-columns').style.display = 'none';
                
                // NUEVO: Mostrar bot√≥n para solicitar mejora a DRK
                document.getElementById('request-improvement-btn').style.display = 'flex';
                
                newCostLabelEl.textContent = "TU COSTE ACTUAL CONSOLIDADO";
                oldCostPeriodEl.classList.remove('line-through');
                oldCostPeriodEl.classList.add('text-cta-green-500');
                oldCostAnnualEl.classList.remove('line-through');
                oldCostAnnualEl.classList.add('text-cta-green-500');
            } else {
                document.getElementById('savings-label').textContent = "TU AHORRO ANUAL ESTIMADO";
                savingsEl.textContent = eur(res.savings);
                savingsEl.classList.add('text-cta-green-500');
                savingsEl.classList.add('text-5xl', 'font-black');
                savingsEl.classList.remove('text-base');
                
                // Mostrar columnas de precios
                document.getElementById('price-columns').style.display = 'grid';
                
                // Ocultar bot√≥n de solicitar mejora
                document.getElementById('request-improvement-btn').style.display = 'none';
                
                newCostLabelEl.textContent = `${tr('TU NUEVO COSTE')} ${brand.NAME.includes('DRK') ? 'DRK' : 'POWER CUP'} ${tr('CONSOLIDADO')}`;
                oldCostPeriodEl.classList.add('line-through', 'text-red-400', 'decoration-red-400/50');
                oldCostAnnualEl.classList.add('line-through', 'text-cta-red-500', 'decoration-cta-red-500/50');
            }
            
            document.getElementById('old-period-cost-display').textContent = eur(res.importe_total);
            document.getElementById('old-annual-cost-display').textContent = eur(res.originalBillAnnual) + tr('/a√±o');
            document.getElementById('old-period-days-label').textContent = `${tr('Total Periodo')} (${tr('Variado')})`; // D√≠as var√≠an por factura
            
            
            document.getElementById('new-monthly-cost-display').textContent = eur(res.totalAnnual / 12) + tr('/mes');
            document.getElementById('new-annual-cost-display').textContent = eur(res.totalAnnual) + tr('/a√±o');
            
            
            // 2. Nuevo: Resumen de Suministros (Tipo, CUPS, Ahorro Individual)
            let summaryListHTML = individualResults.map((resItem, index) => {
                // MODIFICACI√ìN #2: Eliminar "Sin Ahorro" en la vista interna, dejando un espacio.
                const savingsText = resItem.isNegativeSavings ? `&nbsp;` : `(${tr('Ahorro')}: ${eur(resItem.savings)})`;
                return `<div class="flex justify-between items-center py-1 border-b border-slate-100 last:border-b-0">
                    <span class="font-bold text-sm text-slate-700">${resItem.cups}</span>
                    <span class="text-xs text-drk-800 font-semibold">${resItem.originalTariffType}</span>
                    <span class="text-xs ${resItem.isNegativeSavings ? 'text-slate-500' : 'text-cta-green-600 font-medium'}">${savingsText}</span>
                </div>`;
            }).join('');

            const supplySummarySection = `
                <h3 class="text-lg font-bold text-slate-800 border-l-4 border-green-500 pl-3 mb-3" style="border-left-color: ${brand.QR_CENTER_BG};">${tr('Resumen de Suministros A√±adidos')}</h3>
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm text-sm mb-6 space-y-1">
                    ${summaryListHTML}
                </div>
            `;


            // 3. Datos Acumulados Agrupados por Tarifa
            let totalEnergy = 0;
            Object.keys(aggregatedData).forEach(type => {
                // Solo iteramos 2.0TD y 3.0TD, ya que 6.1TD ya no existe en el estado global
                Object.values(aggregatedData[type].energy).forEach(kwh => {
                    totalEnergy += kwh;
                });
            });
            
            // Helper para generar el HTML del grupo
            function generateGroupedDataHTML(type, data, powerPeriods, energyPeriods) {
                const is20TD = type === '2.0TD';
                
                const hasPower = Object.values(data.power).slice(0, powerPeriods).some(v => v > 0);
                const hasEnergy = Object.values(data.energy).slice(0, energyPeriods).some(v => v > 0);
                
                if (!hasPower && !hasEnergy) return '';  

                let energyRows = '';
                let totalGroupEnergy = 0;
                for (let i = 1; i <= energyPeriods; i++) {
                    const kwh = data.energy[`e${i}`] || 0;
                    if (kwh > 0) {
                        let label = `E${i}`;
                        if (is20TD) {
                            if (i === 1) label += ` (${tr('Punta')})`;
                            if (i === 2) label += ` (${tr('Llano')})`;
                            if (i === 3) label += ` (${tr('Valle')})`;
                        }
                        energyRows += `<div class="flex justify-between text-xs mb-1"><span>${label} (Acumulado)</span><span class="font-mono">${num(kwh, 0)} kWh</span></div>`;
                        totalGroupEnergy += kwh;
                    }
                }

                let powerRows = '';
                for (let i = 1; i <= powerPeriods; i++) {
                    const kw = data.power[`p${i}`] || 0;
                    if (kw > 0) {
                        powerRows += `<div class="flex justify-between text-xs mb-1"><span>P${i} (Acumulado)</span><span class="font-mono">${num(kw, 2)} kW</span></div>`;
                    }
                }

                // Eliminamos la referencia a 6.1 TD en el t√≠tulo, ya que el tipo 3.0TD ahora lo engloba todo
                const title = is20TD ? '2.0 TD (' + tr('Hogar/Negocio') + ')' : '3.0 TD (' + tr('Industria/Gran Consumo') + ')';

                return `
                    <div class="border-t pt-4 mt-4 first:border-t-0 first:pt-0 first:mt-0">
                        <p class="font-black text-base ${brand.PRIMARY_TEXT} mb-3">${title}</p>
                        
                        <p class="font-bold text-slate-700 mt-2 mb-1">${tr('Consumos (kWh)')}</p>
                        ${energyRows || `<p class="text-xs text-slate-400">${tr('No hay consumos para este tipo.')}</p>`}
                        ${totalGroupEnergy > 0 ? `<div class="flex justify-between font-bold ${brand.PRIMARY_TEXT} mt-1 border-t pt-1 border-slate-200"><span>${tr('Total Consumo')} ${type}</span><span>${num(totalGroupEnergy, 0)} kWh</span></div>` : ''}
                        
                        <p class="font-bold text-slate-700 mt-4 mb-1">${tr('Potencias (kW)')}</p>
                        ${powerRows || `<p class="text-xs text-slate-400">${tr('No hay potencias para este tipo.')}</p>`}
                    </div>
                `;
            }

            let accumulatedSectionsHTML = '';
            accumulatedSectionsHTML += generateGroupedDataHTML('2.0TD', aggregatedData['2.0TD'], 2, 3);  
            accumulatedSectionsHTML += generateGroupedDataHTML('3.0TD', aggregatedData['3.0TD'], 6, 6);  

            const correctedConsumptionHTML = `
                <div class="grid grid-cols-1 gap-4">
                    <div class="col-span-1 border-b pb-2 mb-2">
                        <div class="flex justify-between items-center ${brand.PRIMARY_TEXT}">
                            <span class="text-sm font-black uppercase">TOTAL ENERG√çA</span>
                            <span class="text-xl font-black">${num(totalEnergy, 0)} kWh</span>
                        </div>
                    </div>
                    ${accumulatedSectionsHTML}
                </div>
            `;

            // --- 4. Precios de la Oferta Consolidada (Dynamic Winner) ---
            const { winningOffers, hasDrkWinner } = getWinningOffersPerType(individualResults);
            let tariffPricesHTML = '';
            const consolidatedPrices = [];
            const brandPrimaryText = brand.PRIMARY_TEXT;
            const isPowerCupMode = comparisonMode === 'overall_best';

            // Determine the label for the price section
            let priceSectionLabel;
            if (hasDrkWinner && comparisonMode !== 'overall_best') {
                // Modo DRK con ofertas DRK
                priceSectionLabel = tr('Precios de las Ofertas Seleccionadas') + ' (DRK ENERG√çA)';
            } else if (!hasDrkWinner && comparisonMode === 'overall_best') {
                // Modo POWER CUP sin DRK
                priceSectionLabel = tr('Precios de las Ofertas Seleccionadas') + ' (POWER CUP GLOBAL)';
            } else {
                // Mixto o general
                priceSectionLabel = tr('Precios de las Ofertas Seleccionadas');
            }

            const basePrefix = brand.NAME.includes('DRK') ? 'drk' : 'powercup';
            const color800 = brand.PRIMARY_TEXT.replace('text-', ''); // Get dynamic color: text-drk-800 -> drk-800

            // Add 2.0TD Prices - TODAS las ofertas √∫nicas
            const offers20 = winningOffers['2.0TD'];
            const has20TD = individualResults.some(d => d.originalTariffType === '2.0TD');
            if (offers20 && offers20.length > 0 && has20TD) {
                offers20.forEach((offer20, index) => {
                    const fullTariffName20 = `${offer20.name || 'Tarifa 2.0TD'} - ${offer20.description || 'N/A'}`;
                    
                    const p1 = offer20.p_potencia_1 / 365;
                    const p2 = offer20.p_potencia_2 / 365;
                    const e1 = offer20.p1_price;
                    const e2 = offer20.p2_price;
                    const e3 = offer20.p3_price;

                    consolidatedPrices.push(`
                        <div class="mb-4 p-3 bg-white rounded-lg border border-${basePrefix}-100">
                            <h5 class="font-black text-sm text-${color800} border-b pb-1 mb-2">Tarifa 2.0 TD #${index + 1} - ${fullTariffName20}</h5>
                            <div class="grid grid-cols-2 gap-x-4 text-xs">
                                <p class="text-slate-500">P1 (‚Ç¨/kW/d√≠a):</p><p class="font-mono font-bold text-right">${numPriceFormula(p1)}</p>
                                <p class="text-slate-500">P2 (‚Ç¨/kW/d√≠a):</p><p class="font-mono font-bold text-right">${numPriceFormula(p2)}</p>
                                <p class="text-slate-500 mt-2 col-span-2 font-bold text-cta-green-600">${tr('ENERG√çA')} (‚Ç¨/kWh)</p>
                                <p class="text-slate-500">E1 (${tr('Punta')}):</p><p class="font-mono font-bold text-right">${numPriceFormula(e1)}</p>
                                <p class="text-slate-500">E2 (${tr('Llano')}):</p><p class="font-mono font-bold text-right">${numPriceFormula(e2)}</p>
                                <p class="text-slate-500">E3 (${tr('Valle')}):</p><p class="font-mono font-bold text-right">${numPriceFormula(e3)}</p>
                            </div>
                        </div>
                    `);
                });
            }

            // Add 3.0TD Prices - TODAS las ofertas √∫nicas
            const offers30 = winningOffers['3.0TD'];
            const has30TD = individualResults.some(d => d.originalTariffType === '3.0TD');
            if (offers30 && offers30.length > 0 && has30TD) {
                offers30.forEach((offer30, index) => {
                    let pRows = '';
                    for(let i=1; i<=6; i++) {
                        pRows += `<p class="text-slate-500">P${i}:</p><p class="font-mono font-bold text-right">${numPriceFormula(offer30[`p_potencia_${i}`] / 365)}</p>`;
                    }
                    let eRows = '';
                    for(let i=1; i<=6; i++) {
                        eRows += `<p class="text-slate-500">E${i}:</p><p class="font-mono font-bold text-right">${numPriceFormula(offer30[`p${i}_price`])}</p>`;
                    }
                    const fullTariffName30 = `${offer30.name || 'Tarifa 3.0TD'} - ${offer30.description || 'N/A'}`;

                    consolidatedPrices.push(`
                        <div class="mb-4 p-3 bg-white rounded-lg border border-${basePrefix}-100">
                            <h5 class="font-black text-sm text-${color800} border-b pb-1 mb-2">Tarifa 3.0 TD #${index + 1} - ${fullTariffName30}</h5>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-x-4 text-xs">
                                <div class="col-span-2 md:col-span-4 font-bold text-cta-red-500 mb-1">${tr('POTENCIA')} (‚Ç¨/kW/d√≠a)</div>
                                ${pRows}
                                <div class="col-span-2 md:col-span-4 font-bold text-cta-green-600 mt-2 mb-1 border-t pt-2">${tr('ENERG√çA')} (‚Ç¨/kWh)</div>
                                ${eRows}
                            </div>
                        </div>
                    `);
                });
            }

            if (consolidatedPrices.length > 0) {
                tariffPricesHTML = `
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-sm text-sm mb-6">
                        <h4 class="font-bold text-lg ${brandPrimaryText} mb-3">${priceSectionLabel}</h4>
                        ${consolidatedPrices.join('')}
                        <p class="text-xs text-slate-500 mt-2">*${tr('Los precios mostrados son de las ofertas ganadoras detectadas para cada tipo de tarifa y se aplican a las CUPS a√±adidas.')}</p>
                    </div>
                `;
            }

            // 5. Desglose detallado de CADA CUPS (Se mantiene)

            let allBreakdownsHTML = '';

            individualResults.forEach((resItem, index) => {
                const currentConfig = TARIFF_CONFIG[resItem.originalTariffType] || TARIFF_CONFIG['2.0TD'];
                const periods = currentConfig.periods;
                const powerPeriods = currentConfig.powerPeriods;
                
                // Determinar el nombre de la tarifa final aplicada
                // MODIFICACI√ìN: Usar el campo con m√°s informaci√≥n para DRK
                const appliedOfferName = resItem.offer.isDrk 
                    ? ((resItem.offer.description?.length > resItem.offer.name?.length) 
                        ? resItem.offer.description 
                        : resItem.offer.name)
                    : resItem.offer.name;

                let energyBreakdown = '';
                resItem.energyCosts.forEach(e => {
                    let label = `E${e.period}`;
                    if (resItem.originalTariffType === '2.0TD') {
                        if (e.period === 1) label += ` (${tr('Punta')})`;
                        if (e.period === 2) label += ` (${tr('Llano')})`;
                        if (e.period === 3) label += ` (${tr('Valle')})`;
                    }
                    
                    if (e.period <= periods) {
                        energyBreakdown += `<div class="flex justify-between"><span>${label} (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)} ‚Ç¨/kWh)</span><span>${num(e.cost, 2)} ‚Ç¨</span></div>`;
                    }
                });

                let powerBreakdown = '';
                resItem.powerCosts.forEach(p => {
                    if (p.period <= powerPeriods) {
                        powerBreakdown += `<div class="flex justify-between"><span>P${p.period} (${num(p.kw, 2)} kW x ${numPriceFormula(p.priceDay)} ‚Ç¨/d√≠a)</span><span>${num(p.cost, 2)} ‚Ç¨</span></div>`;
                    }
                });
                
                const statusText = resItem.isNegativeSavings ? 
                    `<p class="text-sm font-bold text-cta-red-600 mb-2">‚ö†Ô∏è ${tr('TU TARIFA ACTUAL es la mejor')}</p>` :
                    `<p class="text-sm font-bold text-cta-green-600 mb-2">üí∞ ${tr('AHORRO ANUAL')}: ${eur(resItem.savings)}</p>`;

                allBreakdownsHTML += `
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-lg text-sm">
                               <h4 class="text-lg font-black text-slate-800 border-b pb-2 mb-3">${tr('Suministro')} ${index + 1}: ${resItem.cups} (${resItem.originalTariffType})</h4>
                               ${statusText}
                               <p class="text-xs text-slate-500 mb-3">${tr('Tarifa aplicada en el c√°lculo')}: <span class="font-bold text-slate-700">${appliedOfferName}</span></p>
                               <div class="grid grid-cols-2 gap-4 border-b border-slate-200 pb-3 mb-3">
                                   <div class="text-center">
                                       <p class="text-slate-400 text-xs uppercase">${tr('Factura Actual Periodo')}</p>
                                       <p class="font-bold text-cta-red-500">${eur(resItem.importe_total)}</p>
                                   </div>
                                   <div class="text-center">
                                       <p class="text-slate-400 text-xs uppercase">${tr('Nuevo Coste Periodo')}</p>
                                       <p class="font-black ${brand.PRIMARY_TEXT}">${eur(resItem.totalPeriod)}</p>
                                   </div>
                               </div>

                               <p class="font-bold text-slate-800 mb-2">${tr('Desglose')} (${appliedOfferName}):</p>
                               
                               <div class="pl-2 space-y-2 font-mono text-xs">
                                   <p class="font-bold text-slate-700">${tr('POTENCIA')}</p>
                                   ${powerBreakdown}
                                   <div class="flex justify-between font-bold text-slate-800 border-t pt-1"><span>${tr('Subtotal Potencia')}</span><span>${num(resItem.subPower, 2)} ‚Ç¨</span></div>
                                   
                                   <p class="font-bold text-slate-700 pt-2">${tr('ENERG√çA')}</p>
                                   ${energyBreakdown}
                                   <div class="flex justify-between font-bold text-slate-800 border-t pt-1"><span>${tr('Subtotal Energ√≠a (Neto)')}</span><span>${num(resItem.subEnergyNet, 2)} ‚Ç¨</span></div>
                                   
                                   <div class="flex justify-between font-black ${brand.PRIMARY_TEXT} pt-2"><span>TOTAL CON IMPUESTOS</span><span>${eur(resItem.totalPeriod)}</span></div>
                               </div>
                    </div>
                `;
            });


            const detailsContainer = document.getElementById('details-container');

            detailsContainer.innerHTML = `
                ${supplySummarySection}
                <h3 id="extracted-data-header" class="text-lg font-bold text-slate-800 border-l-4 ${brand.BORDER.replace('border-', 'border-')} pl-3">Datos Acumulados</h3>
                <div id="user-consumption-details" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm text-sm">${correctedConsumptionHTML}</div>
                
                ${tariffPricesHTML}
                
                <h3 class="text-lg font-bold text-slate-800 border-l-4 border-green-500 pl-3" style="border-left-color: ${brand.QR_CENTER_BG};">${tr('Desglose Individual por Suministro')}</h3>
                <p class="text-sm text-slate-500 mb-4 pl-3">${tr('A continuaci√≥n, se muestra el c√°lculo detallado de la mejor oferta para cada CUPS, por orden de introducci√≥n:')}</p>
                <div id="cost-breakdown-multi" class="space-y-4">
                    ${allBreakdownsHTML}
                </div>
            `;
        }
        
        /**
         * Rellena la vista de resultados con los datos calculados (UNIDAD).
         * @param {Object} res - Resultado final de la comparaci√≥n.
         */
        // Nueva funci√≥n para renderizar comparaci√≥n dual (Fijo vs Indexado)
        function renderDualComparisonUI(resFijo, resIndexed) {
            console.log('üî•üî•üî• renderDualComparisonUI INICIADO üî•üî•üî•');
            console.log('renderDualComparisonUI llamada', resFijo, resIndexed);
            
            // IMPORTANTE: Asegurar que las variables globales est√©n guardadas
            if (!lastComparisonResult) {
                lastComparisonResult = resFijo;
            }
            if (!lastIndexedResult) {
                lastIndexedResult = resIndexed;
            }
            
            const brand = activeBrand;
            const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            
            // CR√çTICO: Colores din√°micos seg√∫n marca
            const isDrk = brand.NAME.includes('DRK');
            const brandPrefix = isDrk ? 'drk' : 'powercup';  // drk (azul) o powercup (verde)
            
            console.log('üé® Marca detectada:', brand.NAME, '| isDrk:', isDrk, '| Prefix:', brandPrefix);
            console.log('üé® Preparando para generar banner...');
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // BOT√ìN ROJO DE VOLVER (RECARGA P√ÅGINA)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            let backButtonContainer = document.getElementById('back-button-top-container');
            if (!backButtonContainer) {
                backButtonContainer = document.createElement('div');
                backButtonContainer.id = 'back-button-top-container';
                backButtonContainer.className = 'fixed top-0 left-0 right-0 z-[100] bg-white shadow-lg p-3 border-b-4 border-red-500';
                backButtonContainer.innerHTML = `
                    <div class="max-w-lg mx-auto">
                        <button id="force-back-button" class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-black py-4 px-6 rounded-xl shadow-2xl transform transition active:scale-95 flex items-center justify-center gap-3 text-lg">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                            <span>‚¨ÖÔ∏è VOLVER AL INICIO</span>
                        </button>
                    </div>
                `;
                document.body.insertBefore(backButtonContainer, document.body.firstChild);
                
                document.getElementById('force-back-button').addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üîÑ RECARGANDO P√ÅGINA...');
                    window.location.reload();
                });
            }
            backButtonContainer.style.display = 'block';
            
            const resultsView = document.getElementById('results-view');
            if (resultsView) {
                resultsView.style.paddingTop = '80px';
            }
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // FIN BOT√ìN ROJO
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            
            // Banner de empresa
            const companyBanner = document.getElementById('company-banner');
            
            // CR√çTICO: Usar colores din√°micos seg√∫n marca
            if (isDrk) {
                // DRK - Banner mejorado y m√°s grande
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-drk-900 via-drk-800 to-drk-700 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                            <div class="transform scale-125">
                                ${brand.LOGO_SVG}
                            </div>
                            <div class="text-center md:text-left">
                                <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">${brand.FULL_NAME}</h1>
                                <p class="text-drk-100 text-lg md:text-xl font-semibold">${tr('Liderando el ahorro y la eficiencia energ√©tica')}</p>
                            </div>
                        </div>
                        <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">üìä ESTUDIO DE AHORRO</p>
                            <p class="text-drk-100 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                            <p class="text-drk-100 text-base md:text-lg font-bold">${tr("PROFESIONAL")}</p>
                        </div>
                    </div>
                `;
            } else {
                // POWER CUP - Banner mejorado y m√°s grande
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-powercup-700 via-powercup-600 to-powercup-500 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                            <div class="transform scale-125">
                                ${brand.LOGO_SVG}
                            </div>
                            <div class="text-center md:text-left">
                                <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">${brand.FULL_NAME}</h1>
                                <p class="text-powercup-50 text-lg md:text-xl font-semibold">Asesor√≠a Energ√©tica</p>
                            </div>
                        </div>
                        <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">üìä ESTUDIO DE AHORRO</p>
                            <p class="text-powercup-50 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                            <p class="text-powercup-50 text-base md:text-lg font-bold">${tr("PROFESIONAL")}</p>
                        </div>
                    </div>
                `;
                console.log('‚úÖ Banner POWER CUP GENERADO en renderDualComparisonUI');
            }
            
            console.log('üé® Banner generado. Continuando con CUPS...');
            
            // CUPS
            document.getElementById('results-cups-list').innerHTML = `
                CUPS: <span class="font-mono text-slate-700">${resFijo.cups}</span>
            `;
            
            // Vista con TRES COLUMNAS
            const resultCard = document.getElementById('result-card');
            resultCard.innerHTML = `
                <div class="p-4">
                    <!-- TRES COLUMNAS -->
                    <div class="grid grid-cols-3 gap-3 mb-6">
                        <!-- COLUMNA 1: TU FACTURA ACTUAL -->
                        <div class="text-center">
                            <div class="bg-slate-600 text-white py-2 px-2 rounded-t-lg">
                                <p class="text-xs font-bold uppercase"${tr("TU FACTURA ACTUAL")}</p>
                            </div>
                            <div class="bg-white border-2 border-slate-300 rounded-b-lg p-3">
                                <p class="text-xs text-slate-500 mb-2 uppercase"${tr("TU FACTURA ACTUAL")}</p>
                                <p class="text-2xl font-black text-red-600 line-through mb-2">${eur(resFijo.originalBillPeriod || resFijo.importe_total)}</p>
                                <p class="text-xs text-slate-500 mb-3">${tr('Total Periodo')} (${resFijo.dias_facturados || 0} ${tr('d√≠as')})</p>
                                <p class="text-2xl font-black text-red-600">${eur(resFijo.originalBillAnnual)}${tr("/a√±o")}</p>
                            </div>
                        </div>
                        
                        <!-- COLUMNA 2: LA MEJOR OPCI√ìN - FIJO (Color de marca) -->
                        <div class="text-center">
                            <div class="${isDrk ? 'bg-drk-600' : 'bg-powercup-600'} text-white py-2 px-2 rounded-t-lg">
                                <p class="text-xs font-bold uppercase">LA MEJOR OPCI√ìN PARA TI ES ${isDrk ? 'DRK' : 'POWER CUP'}</p>
                            </div>
                            <div class="${isDrk ? 'bg-drk-50 border-drk-400' : 'bg-powercup-50 border-powercup-400'} border-2 rounded-b-lg p-3">
                                <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} mb-2 font-bold">${resFijo.offer.name}</p>
                                <p class="text-2xl font-black ${isDrk ? 'text-drk-900' : 'text-powercup-900'} mb-2">${eur(resFijo.totalAnnual / 12)}${tr("/mes")}</p>
                                <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} mb-3"${tr("Estimado Mensual")}</p>
                                <p class="text-2xl font-black ${isDrk ? 'text-drk-900' : 'text-powercup-900'}">${eur(resFijo.totalAnnual)}${tr("/a√±o")}</p>
                            </div>
                        </div>
                        
                        <!-- COLUMNA 3: LA MEJOR OPCI√ìN PARA TI ES [MARCA] (INDEXADO) -->
                        <div class="text-center">
                            <div class="bg-green-600 text-white py-2 px-2 rounded-t-lg">
                                <p class="text-xs font-bold uppercase">LA MEJOR OPCI√ìN PARA TI ES ${isDrk ? 'DRK' : 'POWER CUP'}</p>
                            </div>
                            <div class="bg-green-50 border-2 border-green-400 rounded-b-lg p-3">
                                <p class="text-xs text-green-700 mb-2 font-bold">${resIndexed.offer.name}</p>
                                <p class="text-2xl font-black text-green-900 mb-2">${eur(resIndexed.totalAnnual / 12)}${tr("/mes")}</p>
                                <p class="text-xs text-green-700 mb-3"${tr("Estimado Mensual")}</p>
                                <p class="text-2xl font-black text-green-900">${eur(resIndexed.totalAnnual)}${tr("/a√±o")}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AHORROS -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="${isDrk ? 'bg-drk-100 border-drk-400' : 'bg-powercup-100 border-powercup-400'} border-2 rounded-xl p-4 text-center">
                            <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} font-bold uppercase mb-2">üíº TU AHORRO CON TARIFA FIJA</p>
                            <p class="text-4xl font-black text-green-600">${eur(resFijo.savings)}</p>
                            <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} mt-1">Ahorro anual estimado</p>
                        </div>
                        <div class="bg-green-100 border-2 border-green-400 rounded-xl p-4 text-center">
                            <p class="text-xs text-green-700 font-bold uppercase mb-2">‚ö° TU AHORRO CON TARIFA INDEXADA</p>
                            <p class="text-4xl font-black text-green-600">${eur(resIndexed.savings)}</p>
                            <p class="text-xs text-green-700 mt-1">Ahorro anual estimado</p>
                        </div>
                    </div>
                    
                    <!-- NOTA IMPORTANTE -->
                    <div class="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-4 mb-6">
                        <p class="text-sm text-yellow-900">
                            <strong>‚ö†Ô∏è Importante:</strong> La tarifa indexada puede variar mensualmente seg√∫n el mercado el√©ctrico. 
                            Los valores mostrados son estimaciones basadas en precios actuales.
                        </p>
                    </div>
                </div>
            `;
            
            // Configurar el bot√≥n existente (NO crear uno nuevo)
            const sendOfferBtn = document.getElementById('send-offer-btn');
            if (sendOfferBtn) {
                sendOfferBtn.style.display = 'flex'; // Asegurar que est√© visible
                sendOfferBtn.onclick = () => {
                    document.getElementById('send-offer-modal').classList.remove('hidden');
                    document.getElementById('send-offer-modal').classList.add('flex');
                    document.querySelectorAll('#send-offer-modal input').forEach(input => {
                        input.classList.remove('focus:ring-drk-500', 'focus:ring-powercup-500');
                        input.classList.add(activeBrand.NAME.includes('DRK') ? 'focus:ring-drk-500' : 'focus:ring-powercup-500');
                    });
                };
            }
            
            // Ocultar detalles
            document.getElementById('details-toggle-btn').style.display = 'none';
            document.getElementById('details-container').style.display = 'none';
            
            // IMPORTANTE: Asegurar que el bot√≥n "Realizar Nueva Comparaci√≥n" est√© visible y funcional
            const resetButton = document.querySelector('#results-view button[onclick="resetToLanding()"]');
            if (resetButton) {
                resetButton.style.display = 'flex';
                resetButton.style.visibility = 'visible';
                resetButton.classList.remove('hidden');
            }
        }
        function renderResultsUI(res, resIndexed = null) {
            // Si hay resultado indexado, usar vista de comparaci√≥n dual
            if (resIndexed) {
                renderDualComparisonUI(res, resIndexed);
                return;
            }
            
            // Si no hay resultado indexado, renderizar como siempre
            try {
                console.log('renderResultsUI called with:', res);
                
                const offer = res.offer;
                const brand = activeBrand;
                const isDrk = brand.NAME.includes('DRK');
                const tariffType = res.tariffType || currentTariffType;
                // Usamos TARIFF_CONFIG[tariffType] y si no existe (ej: 6.1TD residual), se usa un fallback seguro, aunque ya hemos limpiado el estado
                const config = TARIFF_CONFIG[tariffType] || TARIFF_CONFIG['2.0TD']; 

                console.log('Rendering with tariffType:', tariffType, 'Brand:', brand.NAME);

            // FIX: Usar funciones robustas contra NaN
            const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
            
            // NUEVO: Generar banner de empresa din√°mico
            const companyBanner = document.getElementById('company-banner');
            if (isDrk) {
                // DRK - Banner mejorado
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-drk-900 via-drk-800 to-drk-700 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                            <div class="transform scale-125">
                                ${brand.LOGO_SVG}
                            </div>
                            <div class="text-center md:text-left">
                                <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">DRK ENERG√çA</h1>
                                <p class="text-drk-100 text-lg md:text-xl font-semibold">${tr('Liderando el ahorro y la eficiencia energ√©tica')}</p>
                            </div>
                        </div>
                        <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">üìä ESTUDIO DE AHORRO</p>
                            <p class="text-drk-100 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                            <p class="text-drk-100 text-base md:text-lg font-bold">${tr("PROFESIONAL")}</p>
                        </div>
                    </div>
                `;
            } else {
                // POWER CUP - Banner mejorado
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-powercup-700 via-powercup-600 to-powercup-500 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                            <div class="transform scale-125">
                                ${brand.LOGO_SVG}
                            </div>
                            <div class="text-center md:text-left">
                                <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">POWER CUP</h1>
                                <p class="text-powercup-50 text-lg md:text-xl font-semibold">Asesor√≠a Energ√©tica</p>
                            </div>
                        </div>
                        <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">üìä ESTUDIO DE AHORRO</p>
                            <p class="text-powercup-50 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                            <p class="text-powercup-50 text-base md:text-lg font-bold">${tr("PROFESIONAL")}</p>
                        </div>
                    </div>
                `;
            }
            
            // 1. Cabecera y Resumen
            document.getElementById('results-cups-list').innerHTML = `
                CUPS: <span class="font-mono text-slate-700" id="cups-value">${res.cups}</span>
            `;
            
            // MODIFICACI√ìN: Mostrar Comercializadora - Tarifa
            document.getElementById('best-offer-name').textContent = `${offer.name || ''}`;
            document.getElementById('best-offer-desc').textContent = offer.description;
            
            const savingsEl = document.getElementById('savings-estimate');
            const newCostLabelEl = document.getElementById('new-cost-label');
            const oldCostPeriodEl = document.getElementById('old-period-cost-display');
            const oldCostAnnualEl = document.getElementById('old-annual-cost-display');

            // Resetear clases de color din√°micas
            savingsEl.className = 'text-5xl font-black tracking-tight';
            oldCostPeriodEl.classList.remove('line-through', 'text-red-400', 'text-cta-green-500', 'decoration-red-400/50');
            oldCostAnnualEl.classList.remove('line-through', 'text-cta-red-500', 'text-cta-green-500', 'decoration-cta-red-500/50');

            if (res.isNegativeSavings) {
                // Mensaje especial cuando no hay ahorro
                document.getElementById('savings-label').textContent = "¬°ENHORABUENA!";
                savingsEl.innerHTML = `<div class="text-lg leading-tight font-bold">${tr("Actualmente est√°s en una buena tarifa.")}</div><div class="text-sm mt-3 leading-relaxed">${tr("Seguiremos estudiando el mercado y te avisaremos cuando encontremos alguna tarifa que se adapte a tu perfil de consumo.")}</div>`;
                const colorClass = brand.PRIMARY_TEXT.replace('text-', '');
                savingsEl.classList.add('text-' + colorClass);
                savingsEl.classList.remove('text-5xl', 'font-black');
                savingsEl.classList.add('text-base');
                
                // Ocultar columnas de precios
                document.getElementById('price-columns').style.display = 'none';
                
                // NUEVO: Mostrar bot√≥n para solicitar mejora a DRK
                document.getElementById('request-improvement-btn').style.display = 'flex';
                
                newCostLabelEl.textContent = "TU COSTE ACTUAL";
                
                // Si no hay ahorro, el coste actual es el "bueno", sin tachar
                oldCostPeriodEl.classList.remove('line-through');
                oldCostPeriodEl.classList.add('text-cta-green-500');
                oldCostAnnualEl.classList.remove('line-through');
                oldCostAnnualEl.classList.add('text-cta-green-500');

            } else {
                document.getElementById('savings-label').textContent = "TU AHORRO ANUAL ESTIMADO";
                savingsEl.textContent = eur(res.savings);
                savingsEl.classList.add('text-cta-green-500');
                savingsEl.classList.add('text-5xl', 'font-black');
                savingsEl.classList.remove('text-base');
                
                // Mostrar columnas de precios
                document.getElementById('price-columns').style.display = 'grid';
                
                // Ocultar bot√≥n de solicitar mejora
                document.getElementById('request-improvement-btn').style.display = 'none';
                
                newCostLabelEl.textContent = `TU NUEVO COSTE ${isDrk ? 'DRK' : 'POWER CUP'}`;
                
                // Tachar el coste antiguo
                oldCostPeriodEl.classList.add('line-through', 'text-cta-red-500', 'decoration-cta-red-500/50');
                oldCostAnnualEl.classList.add('line-through', 'text-cta-red-500', 'decoration-cta-red-500/50');
            }
            
            document.getElementById('old-period-cost-display').textContent = eur(res.importe_total);
            document.getElementById('old-annual-cost-display').textContent = eur(res.originalBillAnnual) + tr('/a√±o');
            document.getElementById('old-period-days-label').textContent = `${tr('Total Periodo')} (${res.dias_facturados} ${tr('d√≠as')})`;
            
            document.getElementById('new-monthly-cost-display').textContent = eur(res.totalAnnual / 12) + tr('/mes');
            document.getElementById('new-annual-cost-display').textContent = eur(res.totalAnnual) + tr('/a√±o');
            
            // 2. Desglose (Datos Extra√≠dos)
            let energyRows = '';
            res.energyCosts.forEach(e => {
                let label = `E${e.period}`;
                if (tariffType === '2.0TD') {
                    if (e.period === 1) label += ` (${tr('Punta')})`;
                    if (e.period === 2) label += ` (${tr('Llano')})`;
                    if (e.period === 3) label += ` (${tr('Valle')})`;
                }
                if(e.kwh > 0 || e.period <= config.periods) {
                    energyRows += `<div class="flex justify-between text-xs mb-1"><span>${label}</span><span class="font-mono">${num(e.kwh, 0)} kWh</span></div>`;
                }
            });
            const totalEnergy = res.energyCosts.reduce((sum, e) => sum + e.kwh, 0);

            let powerRows = '';
            res.powerCosts.forEach(p => {
                if(p.kw > 0 || p.period <= config.powerPeriods) {
                    powerRows += `<div class="flex justify-between text-xs mb-1"><span>P${p.period}</span><span class="font-mono">${num(p.kw, 2)} kW</span></div>`;
                }
            });

            const consumptionHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div><p class="text-xs text-slate-500">${tr('Periodo')}</p><p class="font-bold text-slate-700">${res.dias_facturados} ${tr('d√≠as')}</p></div>
                    <div><p class="text-xs text-slate-500">${tr('Fechas')}</p><p class="font-bold text-slate-700 text-xs">${res.fechas}</p></div>
                    <div class="col-span-2 border-t pt-2 mt-2">
                        <p class="font-bold ${brand.PRIMARY_TEXT} mb-2">${tr('Consumo por Periodo (kWh)')}</p>
                        ${energyRows}
                        <div class="flex justify-between font-bold ${brand.PRIMARY_TEXT} mt-1 border-t pt-1"><span>${tr('Total Consumo')}</span><span>${num(totalEnergy, 0)} kWh</span></div>  
                    </div>
                    <div class="col-span-2">
                        <p class="font-bold ${brand.PRIMARY_TEXT} mb-2">${tr('Potencia Contratada (kW)')}</p>
                        ${powerRows}
                    </div>
                </div>
            `;

            // 3. Desglose (C√°lculo Oficial)
            let powerBreakdown = '';
            res.powerCosts.forEach(p => {
                if (p.kw > 0 || p.period <= config.powerPeriods) {
                    powerBreakdown += `<div class="flex justify-between"><span>P${p.period} (${num(p.kw, 2)} kW x ${numPriceFormula(p.priceDay)} ‚Ç¨/d√≠a)</span><span>${num(p.cost, 2)} ‚Ç¨</span></div>`;
                }
                });
                
            let energyBreakdown = '';
            res.energyCosts.forEach(e => {
                if (e.kwh > 0 || e.period <= config.periods) {
                    let label = `E${e.period}`;
                    if (tariffType === '2.0TD') {
                        if (e.period === 1) label += ` (${tr('Punta')})`;
                        if (e.period === 2) label += ` (${tr('Llano')})`;
                        if (e.period === 3) label += ` (${tr('Valle')})`;
                    }
                    energyBreakdown += `<div class="flex justify-between"><span>${label} (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)} ‚Ç¨/kWh)</span><span>${num(e.cost, 2)} ‚Ç¨</span></div>`;
                }
                });

            let discountRowsHtml = res.discountAmount > 0 ? `
                <div class="flex justify-between font-bold text-cta-red-500 mt-2">
                    <span>Descuento Aplicado (${num(res.discountRate * 100, 0)}%)</span>
                    <span>-${num(res.discountAmount, 2)} ‚Ç¨</span>
                </div>
                <div class="flex justify-between font-bold text-slate-800 border-t border-dashed mt-1 pt-1">
                    <span>Subtotal Energ√≠a (Neto)</span>
                    <span>${num(res.subEnergyNet, 2)} ‚Ç¨</span>
                </div>
            ` : '';

            const breakdownHTML = `
                <div class="bg-white p-6 font-mono text-xs md:text-sm text-slate-600 leading-relaxed">
                    <div class="text-center border-b-2 border-dashed border-slate-300 pb-4 mb-4">
                        <h4 class="font-bold text-lg text-slate-800 uppercase">${offer.name}</h4>
                        <p>${tr('Simulaci√≥n')} ${res.dias_facturados} ${tr('d√≠as')}</p>
                    </div>
                    
                    <div class="mb-4">
                        <p class="font-bold text-slate-800 mb-1">${tr('POTENCIA')} (‚Ç¨/kW ${tr('D√≠a')})</p>
                        ${powerBreakdown}
                        <div class="flex justify-between font-bold ${brand.SECONDARY_TEXT} border-t mt-1 pt-1"><span>${tr('Subtotal Potencia')}</span><span>${num(res.subPower, 2)} ‚Ç¨</span></div>
                    </div>

                    <div class="mb-4">
                        <p class="font-bold text-slate-800 mb-1">${tr('ENERG√çA')} (‚Ç¨/kWh)</p>
                        ${energyBreakdown}
                        <div class="flex justify-between font-bold ${brand.SECONDARY_TEXT} border-t mt-1 pt-1"><span${tr("Subtotal Energ√≠a (Bruto)")}</span><span>${num(res.subEnergy, 2)} ‚Ç¨</span></div>
                        ${discountRowsHtml}
                    </div>

                    <div class="border-t border-slate-200 pt-2 mb-2">
                        <div class="flex justify-between font-bold text-slate-800"><span${tr("SUBTOTAL BASE (P+E)")}</span><span>${num(res.subBase, 2)} ‚Ç¨</span></div>
                        <div class="flex justify-between"><span>${tr('Imp. El√©c.')} (${num(res.ieRate * 100, 3)}%)</span><span>${num(res.costIE, 2)} ‚Ç¨</span></div>
                        <div class="flex justify-between font-bold text-lg border-t mt-1 pt-1"><span${tr("BASE IMPONIBLE")}</span><span>${num(res.baseImp, 2)} ‚Ç¨</span></div>
                        <div class="flex justify-between"><span>IVA (21%)</span><span>${num(res.costIVA, 2)} ‚Ç¨</span></div>
                    </div>
                    
                    <div class="bg-drk-900 text-white p-3 rounded-lg flex justify-between items-center text-md font-bold mb-1 mt-4"><span>${tr("TOTAL FACTURA")}</span><span>${eur(res.totalPeriod)}</span></div>
                    <div class="text-center mt-2 ${brand.PRIMARY_TEXT} font-bold">${tr("Total Anual Estimado")}: ${eur(res.totalAnnual)}</div>
                </div>
            `;
            
            // NUEVO: Generar resumen de precios consolidados
            let preciosHTML = '';
            if (offer.name !== 'Tu Tarifa Actual') {
                const nombreCompleto = offer.isDrk 
                    ? ((offer.description?.length > offer.name?.length) ? offer.description : offer.name)
                    : offer.name;
                
                if (tariffType === '2.0TD') {
                    preciosHTML = `
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-sm text-sm mb-6">
                            <h4 class="font-bold text-lg text-slate-800 mb-3">${tr('Precios de la Oferta Consolidada')}</h4>
                            <div class="p-3 bg-white rounded-lg border border-slate-200">
                                <h5 class="font-black text-sm text-slate-700 border-b pb-1 mb-2">${tr('Tarifa')} 2.0 TD - ${nombreCompleto}</h5>
                                <div class="grid grid-cols-2 gap-x-4 text-xs">
                                    <p class="text-slate-500">P1 (‚Ç¨/kW/${tr('d√≠a')}):</p>
                                    <p class="font-mono font-bold text-right">${numPriceFormula(res.powerCosts[0].priceDay)}</p>
                                    <p class="text-slate-500">P2 (‚Ç¨/kW/${tr('d√≠a')}):</p>
                                    <p class="font-mono font-bold text-right">${numPriceFormula(res.powerCosts[1].priceDay)}</p>
                                    <p class="text-slate-500 mt-2 col-span-2 font-bold text-green-600">${tr('ENERG√çA')} (‚Ç¨/kWh)</p>
                                    <p class="text-slate-500">E1 (${tr('Punta')}):</p>
                                    <p class="font-mono font-bold text-right">${numPriceFormula(res.energyCosts[0].price)}</p>
                                    <p class="text-slate-500">E2 (${tr('Llano')}):</p>
                                    <p class="font-mono font-bold text-right">${numPriceFormula(res.energyCosts[1].price)}</p>
                                    <p class="text-slate-500">E3 (${tr('Valle')}):</p>
                                    <p class="font-mono font-bold text-right">${numPriceFormula(res.energyCosts[2].price)}</p>
                                </div>
                            </div>
                            <p class="text-xs text-slate-500 mt-2">*${tr('Los precios mostrados son de la oferta ganadora.')}</p>
                        </div>
                    `;
                } else if (tariffType === '3.0TD') {
                    let filasPotencia = '';
                    for(let i = 0; i < 6; i++) {
                        filasPotencia += `<p class="text-slate-500">P${i+1}:</p><p class="font-mono font-bold text-right">${numPriceFormula(res.powerCosts[i].priceDay)}</p>`;
                    }
                    let filasEnergia = '';
                    for(let i = 0; i < 6; i++) {
                        filasEnergia += `<p class="text-slate-500">E${i+1}:</p><p class="font-mono font-bold text-right">${numPriceFormula(res.energyCosts[i].price)}</p>`;
                    }
                    
                    preciosHTML = `
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-sm text-sm mb-6">
                            <h4 class="font-bold text-lg text-slate-800 mb-3">Precios de la Oferta Consolidada</h4>
                            <div class="p-3 bg-white rounded-lg border border-slate-200">
                                <h5 class="font-black text-sm text-slate-700 border-b pb-1 mb-2">Tarifa 3.0 TD - ${nombreCompleto}</h5>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-x-4 text-xs">
                                    <div class="col-span-2 md:col-span-4 font-bold text-red-500 mb-1">${tr('POTENCIA')} (‚Ç¨/kW/d√≠a)</div>
                                    ${filasPotencia}
                                    <div class="col-span-2 md:col-span-4 font-bold text-green-600 mt-2 mb-1 border-t pt-2">${tr('ENERG√çA')} (‚Ç¨/kWh)</div>
                                    ${filasEnergia}
                                </div>
                            </div>
                            <p class="text-xs text-slate-500 mt-2">*Los precios mostrados son de la oferta ganadora.</p>
                        </div>
                    `;
                }
            }
            
            // NUEVO: Llenar las 3 pesta√±as con contenido
            document.getElementById('resumen-content').innerHTML = `
                <h3 class="text-lg font-bold text-slate-800 mb-4">${tr('Datos Extra√≠dos')}</h3>
                ${consumptionHTML}
            `;
            
            document.getElementById('precios-content').innerHTML = preciosHTML || '<p class="text-slate-500">No hay informaci√≥n de precios disponible.</p>';
            
            document.getElementById('calculo-content').innerHTML = `
                <h3 class="text-lg font-bold text-slate-800 mb-4">${tr('C√°lculo Oficial')}</h3>
                ${breakdownHTML}
            `;
            
            // Mantener detailsContainer oculto (ya no se usa)
            const detailsContainer = document.getElementById('details-container');
            detailsContainer.innerHTML = '';
            
            console.log('renderResultsUI completed successfully');
            } catch (error) {
                console.error('Error in renderResultsUI:', error);
                window.showErrorModal(`Error al mostrar resultados: ${error.message}`);
            }
        }
        
        // --- COPIA HTML MEJORADA ---

        async function handleCopyOffer() {
            console.log('handleCopyOffer llamada', {
                lastComparisonResult: lastComparisonResult,
                lastIndexedResult: lastIndexedResult,
                compareWithIndexed: compareWithIndexed
            });
            
            if (!lastComparisonResult) {
                console.error('ERROR: lastComparisonResult es null o undefined');
                return window.showErrorModal("Primero realice una comparaci√≥n.");
            }
            
            const currentLang = localStorage.getItem('appLanguage') || 'es';
            
            // NUEVO: Para TODOS LOS IDIOMAS, generar HTML con tablas traducidas
            console.log(`üåê Generando HTML traducido para idioma: ${currentLang}`);
            
            try {
                // Detectar marca activa
                const brand = activeBrand;
                const isDrk = brand.NAME.includes('DRK');
                const brandColor = isDrk ? '#2e5266' : '#3f6212'; // DRK azul, POWER CUP verde
                
                // Extraer datos principales del DOM
                const offerName = document.getElementById('best-offer-name')?.textContent || 'DRK FIJO 4';
                const savingsAmount = document.getElementById('savings-estimate')?.textContent || '0 ‚Ç¨';
                const oldCost = document.getElementById('old-annual-cost-display')?.textContent || '0 ‚Ç¨';
                const newCost = document.getElementById('new-annual-cost-display')?.textContent || '0 ‚Ç¨';
                const monthlyText = document.getElementById('new-monthly-cost-display')?.textContent || '0 ‚Ç¨';
                
                // Extraer datos del c√°lculo
                const res = lastComparisonResult;
                
                // Crear HTML ULTRA-SIMPLE para Outlook (compatible con TODOS los idiomas)
                const htmlContent = `
                    <!DOCTYPE html>
                    <html>
                    <head><meta charset="UTF-8"></head>
                    <body style="margin:0;padding:20px;font-family:Arial,sans-serif;background:#f1f5f9;">
                    
                    <table width="700" cellpadding="0" cellspacing="0" align="center" style="background:#ffffff;">
                        <!-- HEADER -->
                        <tr>
                            <td bgcolor="${brandColor}" style="padding:30px;text-align:center;">
                                <h1 style="margin:0;color:#ffffff;font-size:32px;">${brand.FULL_NAME}</h1>
                                <p style="margin:10px 0 0 0;color:#ffffff;font-size:15px;">${tr('Liderando el ahorro y la eficiencia energ√©tica')}</p>
                            </td>
                        </tr>
                        
                        <!-- OFERTA -->
                        <tr>
                            <td bgcolor="${brandColor}" style="padding:15px;text-align:center;">
                                <p style="margin:0;color:#ffffff;font-size:11px;">${tr('‰∏∫ÊÇ®Êèê‰æõÁöÑÊúÄ‰Ω≥ÈÄâÊã©')}</p>
                                <h2 style="margin:5px 0 0 0;color:#ffffff;font-size:22px;">${offerName}</h2>
                            </td>
                        </tr>
                        
                        <!-- AHORRO -->
                        <tr>
                            <td style="padding:25px;text-align:center;border-bottom:1px solid #e2e8f0;">
                                <p style="margin:0 0 8px 0;color:#64748b;font-size:11px;font-weight:bold;">${tr('ÊÇ®ÁöÑÈ¢ÑËÆ°Âπ¥Â∫¶ËäÇÁúÅ')}</p>
                                <p style="margin:0;color:#16a34a;font-size:42px;font-weight:bold;">${savingsAmount}</p>
                            </td>
                        </tr>
                        
                        <!-- COMPARATIVA -->
                        <tr>
                            <td style="padding:0;">
                                <table width="100%" cellpadding="0" cellspacing="0">
                                    <tr>
                                        <td width="50%" style="padding:20px;text-align:center;border-right:1px solid #e2e8f0;">
                                            <p style="margin:0 0 10px 0;color:#64748b;font-size:10px;font-weight:bold;">${tr('ÊÇ®ÁöÑÂΩìÂâçË¥¶Âçï')}</p>
                                            <p style="margin:0;color:#dc2626;font-size:18px;font-weight:bold;text-decoration:line-through;">${oldCost}</p>
                                        </td>
                                        <td width="50%" style="padding:20px;text-align:center;">
                                            <p style="margin:0 0 10px 0;color:${brandColor};font-size:10px;font-weight:bold;">${tr('ÊÇ®ÁöÑÊñ∞DRKÊàêÊú¨')}</p>
                                            <p style="margin:0 0 5px 0;color:#1e293b;font-size:20px;font-weight:bold;">${monthlyText}</p>
                                            <p style="margin:0;color:#1e293b;font-size:16px;font-weight:bold;">${newCost}</p>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        
                        <!-- DETALLES T√çTULO -->
                        <tr>
                            <td style="padding:20px 20px 10px 20px;">
                                <h3 style="margin:0;padding-left:10px;border-left:4px solid ${brandColor};color:#1e293b;font-size:16px;">${tr('ÊèêÂèñÊï∞ÊçÆ')}</h3>
                            </td>
                        </tr>
                        
                        <!-- PERIODO Y FECHAS -->
                        <tr>
                            <td style="padding:0 20px;">
                                <table width="100%" cellpadding="10" cellspacing="0" bgcolor="#f8fafc">
                                    <tr>
                                        <td width="50%">
                                            <p style="margin:0 0 5px 0;color:#64748b;font-size:11px;">${tr('ÊúüÈó¥')}</p>
                                            <p style="margin:0;color:#1e293b;font-size:14px;font-weight:bold;">${res.dias_facturados || 60} ${tr('Â§©')}</p>
                                        </td>
                                        <td width="50%">
                                            <p style="margin:0 0 5px 0;color:#64748b;font-size:11px;">${tr('Êó•Êúü')}</p>
                                            <p style="margin:0;color:#1e293b;font-size:12px;font-weight:bold;">${res.fechas || 'N/A'}</p>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        
                        <!-- CONSUMOS -->
                        <tr>
                            <td style="padding:15px 20px 5px 20px;">
                                <p style="margin:0;color:${brandColor};font-size:14px;font-weight:bold;">${tr('ÊúüÈó¥Ê∂àËÄó (kWh)')}</p>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding:0 20px;">
                                <table width="100%" cellpadding="5" cellspacing="0" border="0">
                                    ${res.energyCosts ? res.energyCosts.map((e, i) => `
                                    <tr>
                                        <td style="padding:5px 0;color:#64748b;font-size:12px;">E${e.period} (${i===0 ? tr('Â≥∞ÂÄº') : i===1 ? tr('Âπ≥ÊÆµ') : tr('Ë∞∑ÊÆµ')})</td>
                                        <td align="right" style="padding:5px 0;color:#1e293b;font-size:12px;font-weight:bold;">${e.kwh || 0} kWh</td>
                                    </tr>
                                    `).join('') : ''}
                                    <tr style="border-top:1px solid #e2e8f0;">
                                        <td style="padding:8px 0;color:${brandColor};font-size:13px;font-weight:bold;">${tr('ÊÄªÊ∂àËÄó')}</td>
                                        <td align="right" style="padding:8px 0;color:${brandColor};font-size:13px;font-weight:bold;">${res.energyCosts ? res.energyCosts.reduce((sum, e) => sum + (e.kwh || 0), 0) : 0} kWh</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        
                        <!-- POTENCIAS -->
                        <tr>
                            <td style="padding:15px 20px 5px 20px;">
                                <p style="margin:0;color:${brandColor};font-size:14px;font-weight:bold;">${tr('Á≠æÁ∫¶ÂäüÁéá (kW)')}</p>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding:0 20px 15px 20px;">
                                <table width="100%" cellpadding="5" cellspacing="0">
                                    ${res.powerCosts ? res.powerCosts.map(p => `
                                    <tr>
                                        <td style="padding:5px 0;color:#64748b;font-size:12px;">P${p.period}</td>
                                        <td align="right" style="padding:5px 0;color:#1e293b;font-size:12px;font-weight:bold;">${(p.kw || 0).toFixed(2)} kW</td>
                                    </tr>
                                    `).join('') : ''}
                                </table>
                            </td>
                        </tr>
                        
                        <!-- PRECIOS T√çTULO -->
                        <tr>
                            <td style="padding:20px 20px 10px 20px;">
                                <h3 style="margin:0;padding-left:10px;border-left:4px solid ${brandColor};color:#1e293b;font-size:16px;">${tr('ÂêàÂπ∂Êä•‰ª∑‰ª∑Ê†º')}</h3>
                            </td>
                        </tr>
                        
                        <!-- PRECIOS -->
                        <tr>
                            <td style="padding:0 20px;">
                                <table width="100%" cellpadding="10" cellspacing="0" bgcolor="#f8fafc">
                                    <tr>
                                        <td colspan="2">
                                            <p style="margin:0 0 10px 0;color:#1e293b;font-size:13px;font-weight:bold;">${tr('ËµÑË¥π 2.0 TD')} - ${offerName}</p>
                                        </td>
                                    </tr>
                                    ${res.powerCosts ? res.powerCosts.map(p => `
                                    <tr>
                                        <td style="padding:4px 0;color:#64748b;font-size:11px;">P${p.period} (‚Ç¨/kW/${tr('Êó•')}):</td>
                                        <td align="right" style="padding:4px 0;color:#1e293b;font-size:11px;font-family:monospace;font-weight:bold;">${(p.priceDay || 0).toFixed(6)}</td>
                                    </tr>
                                    `).join('') : ''}
                                    <tr>
                                        <td colspan="2" style="padding:8px 0 4px 0;color:#16a34a;font-size:12px;font-weight:bold;">${tr('ËÉΩÊ∫ê (‚Ç¨/kWh)')}</td>
                                    </tr>
                                    ${res.energyCosts ? res.energyCosts.map((e, i) => `
                                    <tr>
                                        <td style="padding:4px 0;color:#64748b;font-size:11px;">E${e.period} (${i===0 ? tr('Â≥∞ÂÄº') : i===1 ? tr('Âπ≥ÊÆµ') : tr('Ë∞∑ÊÆµ')}):</td>
                                        <td align="right" style="padding:4px 0;color:#1e293b;font-size:11px;font-family:monospace;font-weight:bold;">${(e.price || 0).toFixed(6)}</td>
                                    </tr>
                                    `).join('') : ''}
                                    <tr>
                                        <td colspan="2" style="padding:10px 0 0 0;color:#64748b;font-size:10px;font-style:italic;">*${tr('ÊòæÁ§∫ÁöÑ‰ª∑Ê†ºÊù•Ëá™‰∏≠Ê†áÊä•‰ª∑„ÄÇ')}</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        
                        <!-- C√ÅLCULO T√çTULO -->
                        <tr>
                            <td style="padding:20px 20px 10px 20px;">
                                <h3 style="margin:0;padding-left:10px;border-left:4px solid ${brandColor};color:#1e293b;font-size:16px;">${tr('ÂÆòÊñπËÆ°ÁÆó')}</h3>
                            </td>
                        </tr>
                        
                        <!-- C√ÅLCULO -->
                        <tr>
                            <td style="padding:0 20px 20px 20px;">
                                <table width="100%" cellpadding="10" cellspacing="0" border="1" bordercolor="#e2e8f0" style="border-collapse:collapse;font-family:monospace;font-size:11px;">
                                    <tr>
                                        <td colspan="2" bgcolor="#f8fafc" align="center" style="padding:10px;">
                                            <p style="margin:0;color:#1e293b;font-size:14px;font-weight:bold;">DRK</p>
                                            <p style="margin:5px 0 0 0;color:#64748b;font-size:12px;">${tr('Ê®°Êãü')} ${res.dias_facturados || 60} ${tr('Â§©')}</p>
                                        </td>
                                    </tr>
                                    
                                    <tr bgcolor="#f8fafc">
                                        <td colspan="2" style="padding:8px;color:#1e293b;font-size:12px;font-weight:bold;">${tr('ÂäüÁéá (‚Ç¨/kW Êó•)')}</td>
                                    </tr>
                                    ${res.powerCosts ? res.powerCosts.map(p => `
                                    <tr>
                                        <td style="padding:5px;color:#64748b;">P${p.period} (${(p.kw || 0).toFixed(2)} kW x ${(p.priceDay || 0).toFixed(6)} ‚Ç¨/d√≠a)</td>
                                        <td align="right" style="padding:5px;color:#1e293b;font-weight:bold;">${(p.cost || 0).toFixed(2)} ‚Ç¨</td>
                                    </tr>
                                    `).join('') : ''}
                                    <tr style="border-top:2px solid #e2e8f0;">
                                        <td style="padding:8px;color:#3b82f6;font-weight:bold;">${tr('ÂäüÁéáÂ∞èËÆ°')}</td>
                                        <td align="right" style="padding:8px;color:#3b82f6;font-weight:bold;">${(res.subPower || 0).toFixed(2)} ‚Ç¨</td>
                                    </tr>
                                    
                                    <tr bgcolor="#f8fafc">
                                        <td colspan="2" style="padding:8px;color:#1e293b;font-size:12px;font-weight:bold;">${tr('ËÉΩÊ∫ê (‚Ç¨/kWh)')}</td>
                                    </tr>
                                    ${res.energyCosts ? res.energyCosts.map((e, i) => `
                                    <tr>
                                        <td style="padding:5px;color:#64748b;">E${e.period} (${i===0 ? tr('Â≥∞ÂÄº') : i===1 ? tr('Âπ≥ÊÆµ') : tr('Ë∞∑ÊÆµ')}) (${e.kwh || 0} kWh x ${(e.price || 0).toFixed(6)} ‚Ç¨/kWh)</td>
                                        <td align="right" style="padding:5px;color:#1e293b;font-weight:bold;">${(e.cost || 0).toFixed(2)} ‚Ç¨</td>
                                    </tr>
                                    `).join('') : ''}
                                    
                                    <tr style="border-top:1px dashed #cbd5e1;">
                                        <td></td>
                                        <td align="right" style="padding:8px;color:#1e293b;font-weight:bold;">${(res.subEnergyNet || 0).toFixed(2)} ‚Ç¨</td>
                                    </tr>
                                    <tr style="border-top:1px dashed #cbd5e1;">
                                        <td></td>
                                        <td align="right" style="padding:8px;color:#1e293b;font-weight:bold;">${(res.subtotalNet || 0).toFixed(2)} ‚Ç¨</td>
                                    </tr>
                                    <tr>
                                        <td style="padding:5px;color:#64748b;">${tr('Imp. El√©c.')} (5,113%)</td>
                                        <td align="right" style="padding:5px;color:#1e293b;">${(res.costIE || 0).toFixed(2)} ‚Ç¨</td>
                                    </tr>
                                    <tr style="border-top:1px solid #cbd5e1;">
                                        <td></td>
                                        <td align="right" style="padding:8px;color:#1e293b;font-weight:bold;">${(res.totalSinIVA || 0).toFixed(2)} ‚Ç¨</td>
                                    </tr>
                                    <tr>
                                        <td style="padding:5px;color:#64748b;">${tr('Â¢ûÂÄºÁ®éÔºà21%Ôºâ')}</td>
                                        <td align="right" style="padding:5px;color:#1e293b;">${(res.costIVA || 0).toFixed(2)} ‚Ç¨</td>
                                    </tr>
                                    <tr style="border-top:3px solid #1e293b;" bgcolor="#f8fafc">
                                        <td style="padding:10px;color:#1e293b;font-size:13px;font-weight:bold;">${tr('ÊÄªË¥¶Âçï')}</td>
                                        <td align="right" style="padding:10px;color:#1e293b;font-size:13px;font-weight:bold;">${(res.totalPeriod || 0).toFixed(2)} ‚Ç¨</td>
                                    </tr>
                                    
                                    <tr bgcolor="${brandColor}">
                                        <td colspan="2" align="center" style="padding:15px;color:#ffffff;font-size:13px;font-weight:bold;">${tr('‰º∞ËÆ°Âπ¥Â∫¶ÊÄªÈ¢ù')}: ${(res.totalAnnual || 0).toFixed(2)} ‚Ç¨</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        
                        <!-- FOOTER -->
                        <tr>
                            <td bgcolor="#f8fafc" style="padding:15px;text-align:center;">
                                <p style="margin:0;color:#64748b;font-size:13px;">${tr('ÊâÄÊúâÊñáÊú¨Âùá‰∏∫‰∏≠Êñá ¬∑ ÂèØÁõ¥Êé•‰ΩøÁî®')}</p>
                            </td>
                        </tr>
                    </table>
                    
                    </body>
                    </html>
                `;
                
                // Copiar al portapapeles
                const tempElement = document.createElement('div');
                tempElement.contentEditable = true;
                tempElement.innerHTML = htmlContent;
                tempElement.style.position = 'fixed';
                tempElement.style.left = '-9999px';
                document.body.appendChild(tempElement);
                
                const range = document.createRange();
                range.selectNodeContents(tempElement);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                
                let success = document.execCommand('copy');
                document.body.removeChild(tempElement);
                
                if (success) {
                    window.showMessageModal(tr("‚úÖ ¬°Oferta copiada con √©xito! Ahora puede pegar (Ctrl+V o Cmd+V) el dise√±o visual en su correo de escritorio."));
                    document.getElementById('send-offer-modal').classList.add('hidden');
                    document.getElementById('send-offer-modal').classList.remove('flex');
                } else {
                    window.showErrorModal(tr("No se pudo copiar el dise√±o visual. Intente desde un PC o contacte a soporte."));
                }
                
                return;
            } catch (e) {
                console.error("Error al copiar HTML traducido:", e);
                window.showErrorModal(`Error: ${e.message}`);
                return;
            }
            
            // El c√≥digo anterior ya manej√≥ todos los idiomas y termin√≥ con return
            // Este c√≥digo nunca se ejecutar√° pero lo dejo por compatibilidad
            const commercialCode = document.getElementById('comercial-code-input').value.trim();
            if (!commercialCode) return window.showErrorModal("Indique el C√≥digo Comercial.");

            try {
                // 1. Generar el HTML
                let htmlContent = '';
                
                // IMPORTANTE: Detectar si hay resultado indexado para generar HTML dual
                if (lastIndexedResult && compareWithIndexed) {
                    // Si hay resultado indexado, generar HTML dual
                    if (lastComparisonResult.isMultiCups) {
                        // MULTICUPS con √≠ndice - generar HTML especial
                        htmlContent = generateMultiDualStyledHtmlOffer(commercialCode);
                    } else {
                        // Individual con √≠ndice - generar HTML especial
                        htmlContent = generateDualStyledHtmlOffer(commercialCode, lastComparisonResult, lastIndexedResult);
                    }
                } else {
                    // Modo normal (sin indexado)
                    if (lastComparisonResult.isMulti) {
                        htmlContent = generateMultiStyledHtmlOffer(commercialCode);
                    } else {
                        htmlContent = generateStyledHtmlOffer(commercialCode);
                    }
                }
                
                // 2. Crear un elemento temporal para la copia HTML enriquecida
                const tempElement = document.createElement('div');
                tempElement.contentEditable = true;
                tempElement.innerHTML = htmlContent;
                tempElement.style.position = 'fixed';
                tempElement.style.left = '-9999px';
                document.body.appendChild(tempElement);
                
                // Seleccionar y copiar
                const range = document.createRange();
                range.selectNodeContents(tempElement);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                
                let success = document.execCommand('copy');
                document.body.removeChild(tempElement);

                if (success) {
                    window.showMessageModal(tr("‚úÖ ¬°Oferta copiada con √©xito! Ahora puede pegar (Ctrl+V o Cmd+V) el dise√±o visual en su correo de escritorio."));
                    document.getElementById('send-offer-modal').classList.add('hidden');
                    document.getElementById('send-offer-modal').classList.remove('flex');
                } else {
                    window.showErrorModal(tr("No se pudo copiar el dise√±o visual. Intente desde un PC o contacte a soporte."));
                }
            } catch (e) {
                console.error("Error al copiar al portapapeles:", e);
                window.showErrorModal(`Error de Portapapeles: ${e.message}`);
            }
        }
        
        // --- GENERACI√ìN DE PDF CON COMPARACI√ìN DUAL (FIJO VS INDEXADO) CON DESARROLLO COMPLETO ---
        
        async function generatePDF_Dual(resFijo, resIndexed) {
            try {
                console.log('=== generatePDF_Dual INICIADO ===');
                console.log('resFijo:', resFijo);
                console.log('resFijo tiene powerCosts?:', !!resFijo.powerCosts);
                console.log('resFijo tiene energyCosts?:', !!resFijo.energyCosts);
                console.log('resIndexed:', resIndexed);
                console.log('resIndexed tiene powerCosts?:', !!resIndexed.powerCosts);
                console.log('resIndexed tiene energyCosts?:', !!resIndexed.energyCosts);
                
                // CR√çTICO: Si no tienen powerCosts/energyCosts, recalcularlos
                if (!resFijo.powerCosts || !resFijo.energyCosts) {
                    console.warn('resFijo no tiene powerCosts/energyCosts, recalculando...');
                    const recalculated = recalculateCostsForOffer(resFijo, resFijo.offer);
                    resFijo.powerCosts = recalculated.powerCosts;
                    resFijo.energyCosts = recalculated.energyCosts;
                    resFijo.subPower = recalculated.subPower;
                    resFijo.subEnergyNet = recalculated.subEnergyNet;
                    console.log('resFijo recalculado:', resFijo);
                }
                
                if (!resIndexed.powerCosts || !resIndexed.energyCosts) {
                    console.warn('resIndexed no tiene powerCosts/energyCosts, recalculando...');
                    const recalculated = recalculateCostsForOffer(resIndexed, resIndexed.offer);
                    resIndexed.powerCosts = recalculated.powerCosts;
                    resIndexed.energyCosts = recalculated.energyCosts;
                    resIndexed.subPower = recalculated.subPower;
                    resIndexed.subEnergyNet = recalculated.subEnergyNet;
                    console.log('resIndexed recalculado:', resIndexed);
                }
                
                window.showMessageModal("‚è≥ Generando PDF con comparaci√≥n Fijo vs Indexado... Por favor espere.");
                
                const { jsPDF } = window.jspdf;
                let doc = new jsPDF('p', 'mm', 'a4');
                
                // CR√çTICO: Activar traducci√≥n autom√°tica de textos
                if (window.setupPDFTranslation) {
                    doc = window.setupPDFTranslation(doc);
                }
                
                const brand = activeBrand;
                const tariffType = resFijo.originalTariffType || currentTariffType;
                const config = TARIFF_CONFIG[tariffType] || TARIFF_CONFIG['2.0TD'];
                
                const commercialCode = document.getElementById('comercial-code-input').value.trim();
                const clientName = document.getElementById('client-name-input').value.trim() || '[NOMBRE COMPLETO CLIENTE]';
                
                // Colores din√°micos seg√∫n la marca activa
                const darkColor = [107, 125, 142];
                const greenColor = [22, 163, 74];
                const redColor = [220, 38, 38];
                
                // CR√çTICO: Colores seg√∫n marca (DRK = azul, POWER CUP = verde)
                const isDrk = brand.NAME.includes('DRK');
                const brandColor = isDrk ? [59, 130, 246] : [132, 204, 22];  // Azul DRK o Verde POWER CUP
                const brandColorLight = isDrk ? [59, 130, 246] : [22, 163, 74];  // Para ahorros
                const blueColor = brandColor;  // Alias para compatibilidad (usado en P√°gina 2 y 3)
                const greenIndexColor = [22, 163, 74];  // Verde para INDEXADA (siempre verde)
                
                const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
                const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
                const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
                
                let yPos = 0;
                const pageWidth = 210;
                const margin = 12;
                const contentWidth = pageWidth - (2 * margin);
                
                // === P√ÅGINA 1: RESUMEN ===
                
                // CABECERA con degradado
                const headerHeight = 35;
                
                // CR√çTICO: Color del header seg√∫n marca
                const headerColor = isDrk ? [107, 125, 142] : [115, 130, 95]; // Gris azulado (DRK) o Verde oliva (POWER)
                
                for (let i = 0; i < pageWidth; i++) {
                    const ratio = i / pageWidth;
                    const r = Math.round(headerColor[0] + (240 - headerColor[0]) * ratio);
                    const g = Math.round(headerColor[1] + (245 - headerColor[1]) * ratio);
                    const b = Math.round(headerColor[2] + (250 - headerColor[2]) * ratio);
                    doc.setFillColor(r, g, b);
                    doc.rect(i, 0, 1, headerHeight, 'F');
                }
                
                // Logo seg√∫n marca
                const logoX = margin + 8;
                const logoY = 12;
                const logoRadius = 5;
                
                if (isDrk) {
                    // Logo DRK (anillo multicolor)
                    doc.setFillColor(219, 68, 55);
                    doc.circle(logoX - 1, logoY + 1, logoRadius * 0.8, 'F');
                    doc.setFillColor(66, 133, 244);
                    doc.circle(logoX + 1, logoY - 1, logoRadius * 0.8, 'F');
                    doc.setFillColor(244, 180, 0);
                    doc.circle(logoX - 1, logoY - 1, logoRadius * 0.7, 'F');
                    doc.setFillColor(15, 157, 88);
                    doc.circle(logoX + 1, logoY + 1, logoRadius * 0.7, 'F');
                    doc.setFillColor(255, 255, 255);
                    doc.circle(logoX, logoY, logoRadius * 0.4, 'F');
                } else {
                    // Logo POWER CUP (taza con rayo)
                    // Plato/base (verde oscuro)
                    doc.setFillColor(60, 90, 50);
                    doc.rect(logoX - 5, logoY + 4, 10, 1, 'F');
                    
                    // Borde de la taza (verde oscuro)
                    doc.setDrawColor(60, 90, 50);
                    doc.setLineWidth(1.2);
                    doc.roundedRect(logoX - 3.5, logoY - 2, 7, 6, 0.5, 0.5, 'S');
                    
                    // Asa de la taza
                    doc.setLineWidth(1);
                    doc.line(logoX + 3.5, logoY, logoX + 5, logoY - 0.5);
                    doc.line(logoX + 5, logoY - 0.5, logoX + 5.5, logoY + 1);
                    doc.line(logoX + 5.5, logoY + 1, logoX + 5, logoY + 2.5);
                    doc.line(logoX + 5, logoY + 2.5, logoX + 3.5, logoY + 2);
                    
                    // Rayo dentro de la taza (amarillo/oro)
                    doc.setFillColor(255, 215, 0);
                    doc.setLineWidth(0.3);
                    const rayoX = logoX - 0.5;
                    const rayoY = logoY;
                    doc.line(rayoX, rayoY - 1, rayoX - 0.7, rayoY + 0.5);
                    doc.line(rayoX - 0.7, rayoY + 0.5, rayoX + 0.3, rayoY + 0.3);
                    doc.line(rayoX + 0.3, rayoY + 0.3, rayoX, rayoY + 2);
                    doc.line(rayoX, rayoY + 2, rayoX + 0.7, rayoY + 0.2);
                    doc.line(rayoX + 0.7, rayoY + 0.2, rayoX - 0.3, rayoY + 0.5);
                }
                
                // Texto del nombre de marca
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(brand.NAME.toUpperCase(), logoX + 12, 14);
                
                // Subtexto seg√∫n marca
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                if (isDrk) {
                    doc.text(tr('Liderando el ahorro y la'), logoX + 12, 20);
                    doc.text(tr('eficiencia energ√©tica.'), logoX + 12, 24);
                } else {
                    doc.text(tr('Asesor√≠a Energ√©tica'), logoX + 12, 20);
                }
                
                // Texto derecha
                doc.setTextColor(40, 60, 80);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('ESTUDIO DE AHORRO'), pageWidth - margin, 12, { align: 'right' });
                
                doc.setFontSize(11);
                doc.setTextColor(255, 255, 255);
                doc.text('COMPARATIVA', pageWidth - margin, 18, { align: 'right' });
                
                doc.setFontSize(9);
                doc.setTextColor(100, 120, 140);
                doc.text('PROFESIONAL', pageWidth - margin, 24, { align: 'right' });
                
                yPos = headerHeight + 8;
                
                // === DATOS DEL CLIENTE ===
                
                // T√≠tulo "COMPARATIVA PROFESIONAL - DRK"
                doc.setTextColor(55, 65, 81);  // Gris oscuro
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('COMPARATIVA PROFESIONAL - ' + brand.NAME.toUpperCase(), margin, yPos);
                yPos += 8;
                
                // Info del cliente
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.setTextColor(75, 85, 99);
                doc.text(tr('CLIENTE:') + ' ' + clientName.toUpperCase(), margin, yPos);
                yPos += 6;
                doc.text('CUPS TOTALES: ' + (resFijo.isMulti ? resFijo.cups : '1'), margin, yPos);
                yPos += 12;
                
                // === CAJA GRANDE CON LA MEJOR OPCI√ìN ===
                
                const bigBoxY = yPos;
                const bigBoxHeight = 45;
                const bigBoxMargin = 20;
                const bigBoxWidth = contentWidth - (bigBoxMargin * 2);
                const bigBoxX = margin + bigBoxMargin;
                
                // CR√çTICO: Color de fondo seg√∫n marca
                const bigBoxColor = isDrk ? [100, 116, 139] : [115, 130, 95]; // Gris azulado (DRK) o Verde oliva (POWER)
                doc.setFillColor(...bigBoxColor);
                doc.roundedRect(bigBoxX, bigBoxY, bigBoxWidth, bigBoxHeight, 4, 4, 'F');
                
                // Texto "LA MEJOR OPCI√ìN PARA TI ES"
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.text(tr('LA MEJOR OPCI√ìN PARA TI ES'), pageWidth / 2, bigBoxY + 12, { align: 'center' });
                
                // Nombre de la marca en grande
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(30);
                doc.text(brand.NAME.toUpperCase(), pageWidth / 2, bigBoxY + 26, { align: 'center' });
                
                // Descripci√≥n
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                const descripcion = tr('Ofrece el mayor ahorro consolidado con') + ' ' + brand.FULL_NAME + '.';
                doc.text(descripcion, pageWidth / 2, bigBoxY + 37, { align: 'center' });
                
                yPos = bigBoxY + bigBoxHeight + 10;
                
                // === DISE√ëO LIMPIO SIN MARCOS (3 COLUMNAS) ===
                
                const col1X = margin;
                const col2X = margin + (contentWidth / 3);
                const col3X = margin + (contentWidth / 3) * 2;
                const colWidth = contentWidth / 3;
                
                // === COLUMNA 1: TU FACTURA ACTUAL (IZQUIERDA) - BAJADA AL MEDIO ===
                
                let y1 = yPos + 25;
                
                // T√≠tulo
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.setTextColor(107, 114, 128);
                doc.text(tr('TU FACTURA ACTUAL'), col1X, y1);
                y1 += 12;
                
                // Precio mensual (TACHADO)
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(22);
                doc.setTextColor(220, 38, 38);
                const precioMensualActual = eur(resFijo.originalBillPeriod || resFijo.importe_total);
                doc.text(precioMensualActual, col1X, y1);
                
                // L√≠nea tachada
                const tw1 = doc.getTextWidth(precioMensualActual);
                doc.setDrawColor(220, 38, 38);
                doc.setLineWidth(1.5);
                doc.line(col1X, y1 - 4, col1X + tw1, y1 - 4);
                y1 += 10;
                
                // Subtexto
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(156, 163, 175);
                doc.text(`${tr('Total Periodo')} (${resFijo.dias_facturados || 0} ${tr('d√≠as')})`, col1X, y1);
                y1 += 14;
                
                // Precio anual (TACHADO)
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(20);
                doc.setTextColor(220, 38, 38);
                const precioAnualActual = eur(resFijo.originalBillAnnual) + tr('/a√±o');
                doc.text(precioAnualActual, col1X, y1);
                
                // L√≠nea tachada
                const tw2 = doc.getTextWidth(precioAnualActual);
                doc.setDrawColor(220, 38, 38);
                doc.setLineWidth(1.5);
                doc.line(col1X, y1 - 3, col1X + tw2, y1 - 3);
                
                // === COLUMNA 2: AHORRO + NUEVO COSTE FIJO (CENTRO) - CAJA SUBIDA ===
                
                let y2 = yPos;
                
                // CR√çTICO: Color de caja seg√∫n marca
                const cajaHeaderColor = isDrk ? [100, 116, 139] : [115, 130, 95]; // Gris azulado (DRK) o Verde oliva (POWER)
                
                // Caja superior "TU AHORRO ANUAL FIJO"
                const boxHeaderHeight = 12;
                doc.setFillColor(...cajaHeaderColor);
                doc.roundedRect(col2X - 2, y2, colWidth - 8, boxHeaderHeight, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                doc.text('TU AHORRO ANUAL FIJO', col2X + (colWidth - 8) / 2 - 2, y2 + 8, { align: 'center' });
                y2 += boxHeaderHeight + 12;
                
                // Ahorro en verde GRANDE
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(30);
                doc.setTextColor(22, 163, 74);
                doc.text(eur(resFijo.savings), col2X, y2);
                y2 += 18;
                
                // "TU NUEVO COSTE [MARCA]"
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.setTextColor(107, 114, 128);
                doc.text(tr('TU NUEVO COSTE') + ' ' + brand.NAME.toUpperCase(), col2X, y2);
                y2 += 12;
                
                // Precio mensual nuevo (color de marca)
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(20);
                doc.setTextColor(...brandColor);
                doc.text(eur(resFijo.totalAnnual / 12) + tr('/mes'), col2X, y2);
                y2 += 10;
                
                // Subtexto "Estimado Mensual"
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(156, 163, 175);
                doc.text(tr('Estimado Mensual'), col2X, y2);
                y2 += 12;
                
                // Precio anual nuevo (color de marca)
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18);
                doc.setTextColor(...brandColor);
                doc.text(eur(resFijo.totalAnnual) + tr('/a√±o'), col2X, y2);
                
                // === COLUMNA 3: AHORRO + NUEVO COSTE INDEXADO (DERECHA) - CAJA SUBIDA ===
                
                let y3 = yPos;
                
                // Caja superior "TU AHORRO ANUAL INDEXADO" (con mismo color que FIJO)
                doc.setFillColor(...cajaHeaderColor);
                doc.roundedRect(col3X - 2, y3, colWidth - 8, boxHeaderHeight, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                doc.text('TU AHORRO ANUAL INDEXADO', col3X + (colWidth - 8) / 2 - 2, y3 + 8, { align: 'center' });
                y3 += boxHeaderHeight + 12;
                
                // Ahorro en verde GRANDE
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(30);
                doc.setTextColor(22, 163, 74);
                doc.text(eur(resIndexed.savings), col3X, y3);
                y3 += 18;
                
                // "TU NUEVO COSTE [MARCA]"
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.setTextColor(107, 114, 128);
                doc.text(tr('TU NUEVO COSTE') + ' ' + brand.NAME.toUpperCase(), col3X, y3);
                y3 += 12;
                
                // Precio mensual nuevo
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(20);
                doc.setTextColor(22, 163, 74);
                doc.text(eur(resIndexed.totalAnnual / 12) + tr('/mes'), col3X, y3);
                y3 += 10;
                
                // Subtexto "Estimado Mensual"
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(156, 163, 175);
                doc.text(tr('Estimado Mensual'), col3X, y3);
                y3 += 12;
                
                // Precio anual nuevo
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18);
                doc.setTextColor(22, 163, 74);
                doc.text(eur(resIndexed.totalAnnual) + tr('/a√±o'), col3X, y3);
                
                // Actualizar yPos al m√°ximo de las tres columnas
                const maxY = Math.max(y1, y2, y3);
                
                // L√çNEAS VERTICALES SEPARADORAS
                const lineStartY = yPos - 5;
                const lineEndY = maxY + 5;
                
                // L√≠nea entre columna 1 y 2
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.5);
                doc.line(col2X - 10, lineStartY, col2X - 10, lineEndY);
                
                // L√≠nea entre columna 2 y 3
                doc.line(col3X - 10, lineStartY, col3X - 10, lineEndY);
                
                yPos = maxY + 15;
                
                // === P√ÅGINA 2: DESGLOSE DETALLADO POR SUMINISTRO ===
                doc.addPage();
                yPos = 15;
                
                // T√≠tulo verde con bordes redondeados
                doc.setFillColor(34, 197, 94);
                doc.roundedRect(margin, yPos, contentWidth, 14, 4, 4, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('DESGLOSE DETALLADO POR SUMINISTRO', pageWidth / 2, yPos + 10, { align: 'center' });
                yPos += 22;
                
                const col2Width = (contentWidth - 6) / 2;
                const leftX = margin;
                const rightX = margin + col2Width + 6;
                
                // Funci√≥n para generar desglose con cajas grises
                function generarDesgloseConCajasGrises(res, x, width, esFijo) {
                    if (!res || !res.powerCosts || !res.energyCosts) {
                        console.error('ERROR: res no tiene la estructura necesaria', res);
                        return;
                    }
                    
                    let y = yPos;
                    
                    // === CABECERA GRIS OSCURA CON CUPS ===
                    doc.setFillColor(71, 85, 105);
                    doc.roundedRect(x, y, width, 14, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`[${res.cups || 'N/A'}]`, x + 3, y + 4);
                    doc.text(`Tipo: ${res.originalTariffType || tariffType}`, x + width - 3, y + 4, { align: 'right' });
                    doc.text(`D√≠as: ${res.dias_facturados || 0}`, x + width - 3, y + 8, { align: 'right' });
                    
                    // Nombre completo: Comercializadora - Tarifa
                    doc.setFontSize(6.5);
                    doc.setFont('helvetica', 'normal');
                    const comercializadora = res.offer.name || brand.NAME;
                    const nombreTarifa = res.offer.description || 'N/A';
                    const nombreCompleto = `${comercializadora} - ${nombreTarifa}`;
                    doc.text(nombreCompleto, x + 3, y + 11);
                    
                    y += 16;
                    
                    // === CAJA PRECIOS APLICADOS ===
                    doc.setFillColor(100, 116, 139);
                    doc.roundedRect(x, y, width, 8, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PRECIOS APLICADOS:', x + 3, y + 6);
                    y += 10;
                    
                    // Info de precios (Potencia y Energ√≠a)
                    doc.setFillColor(100, 116, 139);
                    doc.roundedRect(x, y, width, 16, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('POTENCIA:'), x + 3, y + 4);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(5.5);
                    
                    // Mostrar precios de potencia reales
                    if (res.powerCosts.length > 0) {
                        doc.text(`P1: ${num(res.powerCosts[0].priceDay || 0, 6)} ‚Ç¨/kW/d√≠a`, x + 3, y + 8);
                    }
                    if (res.powerCosts.length > 1) {
                        doc.text(`P2: ${num(res.powerCosts[1].priceDay || 0, 6)} ‚Ç¨/kW/d√≠a`, x + 3, y + 11);
                    }
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(6);
                    doc.text('ENERG√çA:', x + width/2, y + 4);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(5.5);
                    
                    // Mostrar precios de energ√≠a reales
                    if (res.energyCosts.length > 0) {
                        doc.text(`E1: ${num(res.energyCosts[0].price || 0, 6)} ‚Ç¨/kWh`, x + width/2, y + 8);
                    }
                    if (res.energyCosts.length > 1) {
                        doc.text(`E2: ${num(res.energyCosts[1].price || 0, 6)} ‚Ç¨/kWh`, x + width/2, y + 11);
                    }
                    if (res.energyCosts.length > 2) {
                        doc.text(`E3: ${num(res.energyCosts[2].price || 0, 6)} ‚Ç¨/kWh`, x + width/2, y + 14);
                    }
                    y += 20;
                    
                    // === SECCI√ìN POTENCIA ===
                    doc.setFillColor(100, 116, 139);
                    doc.roundedRect(x, y, width, 7, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('POTENCIA', x + 3, y + 5);
                    y += 9;
                    
                    // Desglose potencia
                    doc.setTextColor(55, 65, 81);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'normal');
                    res.powerCosts.forEach((p, i) => {
                        if (p.kw > 0) {
                            const texto = `P${i+1}: (${num(p.kw, 2)} kW x ${num(p.priceDay, 6)} ‚Ç¨/kW/d√≠a)`;
                            doc.text(texto, x + 3, y);
                            doc.text(eur(p.cost), x + width - 3, y, { align: 'right' });
                            y += 4;
                        }
                    });
                    y += 2;
                    
                    // === SECCI√ìN ENERG√çA ===
                    doc.setFillColor(100, 116, 139);
                    doc.roundedRect(x, y, width, 7, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('ENERG√çA', x + 3, y + 5);
                    y += 9;
                    
                    // Desglose energ√≠a
                    doc.setTextColor(55, 65, 81);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'normal');
                    res.energyCosts.forEach((e, i) => {
                        if (e.kwh > 0) {
                            let periodoNombre = '';
                            if (tariffType === '2.0TD') {
                                if (i === 0) periodoNombre = ` (${tr('Punta')})`;
                                else if (i === 1) periodoNombre = ` (${tr('Llano')})`;
                                else if (i === 2) periodoNombre = ` (${tr('Valle')})`;
                            }
                            const texto = `E${i+1}${periodoNombre}: (${num(e.kwh, 0)} kWh x ${num(e.price, 6)} ‚Ç¨/kWh)`;
                            doc.text(texto, x + 3, y);
                            doc.text(eur(e.cost), x + width - 3, y, { align: 'right' });
                            y += 4;
                        }
                    });
                    y += 2;
                    
                    // === TOTAL ===
                    doc.setFillColor(71, 85, 105);
                    doc.roundedRect(x, y, width, 9, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`TOTAL (${res.dias_facturados || 0} D√çAS)`, x + 3, y + 6);
                    doc.text(eur(res.totalPeriod || res.importe_total || 0), x + width - 3, y + 6, { align: 'right' });
                    y += 12;
                    
                    // === AHORRO ===
                    doc.setFillColor(220, 38, 38);
                    doc.roundedRect(x + width - 55, y, 52, 10, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('AHORRO:', x + width - 52, y + 4);
                    doc.setFontSize(9);
                    doc.text(eur(res.savings || 0), x + width - 28, y + 7, { align: 'center' });
                }
                
                // Generar desgloses en dos columnas
                generarDesgloseConCajasGrises(resFijo, leftX, col2Width, true);
                generarDesgloseConCajasGrises(resIndexed, rightX, col2Width, false);
                
                yPos += 120;
                
                // === P√ÅGINA 3: EXPLICACI√ìN ===
                doc.addPage();
                yPos = 15;
                
                // Definir variables para las dos columnas de la explicaci√≥n
                const colWidthPage3 = (contentWidth - 3) / 2;
                const leftXPage3 = margin;
                const rightXPage3 = margin + colWidthPage3 + 3;
                
                doc.setFillColor(245, 245, 245);
                doc.roundedRect(margin, yPos, contentWidth, 120, 2, 2, 'F');
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('CUAL ES LA DIFERENCIA?', pageWidth / 2, yPos + 8, { align: 'center' });
                
                yPos += 15;
                
                // Columna izquierda - Tarifa Fija
                let leftColY = yPos;
                doc.setFontSize(9);
                doc.setTextColor(...blueColor);
                doc.setFont('helvetica', 'bold');
                doc.text('POR QUE TARIFA FIJA?', leftXPage3 + 2, leftColY);
                leftColY += 6;
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                const fijaTextFull = [
                    '‚Ä¢ Implica un precio fijo por los kilovatios que',
                    '  consumes (kWh).',
                    '',
                    '‚Ä¢ El precio se mantiene estable,',
                    '  independientemente de c√≥mo se comporten los',
                    '  precios en el mercado el√©ctrico.',
                    '',
                    '‚Ä¢ Cuando el precio del mercado est√° alto, el',
                    '  cliente est√° protegido frente a sobresaltos.',
                    '',
                    '‚Ä¢ No tendr√°s que estar pendiente de las',
                    '  variaciones del mercado y podr√°s seguir',
                    '  usando la electricidad como siempre.'
                ];
                
                fijaTextFull.forEach(line => {
                    doc.text(line, leftXPage3 + 2, leftColY, { maxWidth: colWidthPage3 - 4 });
                    leftColY += 3.5;
                });
                
                // Columna derecha - Tarifa Indexada
                let rightColY = yPos;
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...greenColor);
                doc.text('POR QUE TARIFA INDEXADA?', rightXPage3 + 2, rightColY);
                rightColY += 6;
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                const indexadaTextFull = [
                    '‚Ä¢ Implica un precio variable por los kilovatios',
                    '  que consumes (kWh) cada mes.',
                    '',
                    '‚Ä¢ Es la tarifa m√°s justa, ya que pagas el coste',
                    '  real de la energ√≠a mes a mes.',
                    '',
                    '‚Ä¢ Al contratarla, el cliente evita pagar',
                    '  m√°rgenes adicionales cuando el precio de la',
                    '  electricidad es m√°s barato.',
                    '',
                    '‚Ä¢ A largo plazo, con un indexado 100%',
                    '  funcional, se puede obtener un ahorro',
                    '  aproximado de hasta un 20% en √©pocas de',
                    '  mejor precio.'
                ];
                
                indexadaTextFull.forEach(line => {
                    doc.text(line, rightXPage3 + 2, rightColY, { maxWidth: colWidthPage3 - 4 });
                    rightColY += 3.5;
                });
                
                // Guardar PDF
                const filename = `Comparacion_Fijo_vs_Indexado_${resFijo.cups.slice(-6)}.pdf`;
                doc.save(filename);
                
                window.showMessageModal(`‚úÖ PDF generado con √©xito: ${filename}`);
                
                // Cerrar modal
                document.getElementById('send-offer-modal').classList.add('hidden');
                document.getElementById('send-offer-modal').classList.remove('flex');
                
            } catch (error) {
                console.error('Error generando PDF dual:', error);
                window.showErrorModal(`Error al generar PDF: ${error.message}`);
            }
        }


        async function generateMultiPDF_Dual(res) {
            try {
                console.log('=== generateMultiPDF_Dual INICIADO ===');
                console.log('res recibido:', res);
                console.log('res.individualResults:', res.individualResults);
                
                if (res.individualResults && res.individualResults.length > 0) {
                    console.log('Primer supply:', res.individualResults[0]);
                    console.log('Primer supply tiene indexedComparison?:', !!res.individualResults[0].indexedComparison);
                    if (res.individualResults[0].indexedComparison) {
                        console.log('indexedComparison:', res.individualResults[0].indexedComparison);
                        console.log('indexedComparison.powerCosts?:', !!res.individualResults[0].indexedComparison.powerCosts);
                        console.log('indexedComparison.energyCosts?:', !!res.individualResults[0].indexedComparison.energyCosts);
                    }
                }
                
                console.log('üü¢ ANTES de showMessageModal');
                window.showMessageModal("‚è≥ Generando PDF MULTICUPS con comparaci√≥n Fijo vs Indexado... Por favor espere.");
                console.log('üü¢ DESPU√âS de showMessageModal');
                
                console.log('üü¢ ANTES de obtener jsPDF');
                const { jsPDF } = window.jspdf;
                console.log('üü¢ DESPU√âS de obtener jsPDF, creando documento...');
                let doc = new jsPDF('p', 'mm', 'a4');
                console.log('üü¢ Documento PDF creado exitosamente');
                
                // CR√çTICO: Activar traducci√≥n autom√°tica de textos
                if (window.setupPDFTranslation) {
                    doc = window.setupPDFTranslation(doc);
                }
                
                console.log('‚úÖ PASO 1: Objeto PDF creado');
                
                const darkColor = [107, 125, 142];
                const greenColor = [22, 163, 74];
                const redColor = [220, 38, 38];
                
                // CR√çTICO: Colores seg√∫n marca activa
                const brand = activeBrand;
                const isDrk = brand.NAME.includes('DRK');
                const brandColor = isDrk ? [59, 130, 246] : [132, 204, 22];  // Azul DRK o Verde POWER CUP
                const blueColor = brandColor;  // Alias para compatibilidad
                
                const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
                const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
                const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
                
                // Obtener nombre del cliente
                const clientName = document.getElementById('client-name-input').value.trim() || '[NOMBRE COMPLETO CLIENTE]';
                
                let yPos = 0;
                const pageWidth = 210;
                const margin = 12;
                const contentWidth = pageWidth - (2 * margin);
                const colWidth = (contentWidth / 2) - 3;
                const leftX = margin;
                const rightX = margin + colWidth + 6;
                
                console.log('‚úÖ PASO 2: Variables definidas - leftX:', leftX, 'rightX:', rightX, 'colWidth:', colWidth);
                
                // === P√ÅGINA 1: RESUMEN GENERAL ===
                const headerHeight = 35;
                
                // CR√çTICO: Color del header seg√∫n marca
                const headerColor = isDrk ? [107, 125, 142] : [115, 130, 95]; // Gris azulado (DRK) o Verde oliva (POWER)
                
                for (let i = 0; i < pageWidth; i++) {
                    const ratio = i / pageWidth;
                    const r = Math.round(headerColor[0] + (240 - headerColor[0]) * ratio);
                    const g = Math.round(headerColor[1] + (245 - headerColor[1]) * ratio);
                    const b = Math.round(headerColor[2] + (250 - headerColor[2]) * ratio);
                    doc.setFillColor(r, g, b);
                    doc.rect(i, 0, 1, headerHeight, 'F');
                }
                
                // Logo seg√∫n marca
                const logoX = margin + 8;
                const logoY = 12;
                const logoRadius = 5;
                
                if (isDrk) {
                    // Logo DRK (anillo multicolor)
                    doc.setFillColor(219, 68, 55);
                    doc.circle(logoX - 1, logoY + 1, logoRadius * 0.8, 'F');
                    doc.setFillColor(66, 133, 244);
                    doc.circle(logoX + 1, logoY - 1, logoRadius * 0.8, 'F');
                    doc.setFillColor(244, 180, 0);
                    doc.circle(logoX - 1, logoY - 1, logoRadius * 0.7, 'F');
                    doc.setFillColor(15, 157, 88);
                    doc.circle(logoX + 1, logoY + 1, logoRadius * 0.7, 'F');
                    doc.setFillColor(255, 255, 255);
                    doc.circle(logoX, logoY, logoRadius * 0.4, 'F');
                } else {
                    // Logo POWER CUP (taza con rayo)
                    // Plato/base (verde oscuro)
                    doc.setFillColor(60, 90, 50);
                    doc.rect(logoX - 5, logoY + 4, 10, 1, 'F');
                    
                    // Borde de la taza (verde oscuro)
                    doc.setDrawColor(60, 90, 50);
                    doc.setLineWidth(1.2);
                    doc.roundedRect(logoX - 3.5, logoY - 2, 7, 6, 0.5, 0.5, 'S');
                    
                    // Asa de la taza
                    doc.setLineWidth(1);
                    doc.line(logoX + 3.5, logoY, logoX + 5, logoY - 0.5);
                    doc.line(logoX + 5, logoY - 0.5, logoX + 5.5, logoY + 1);
                    doc.line(logoX + 5.5, logoY + 1, logoX + 5, logoY + 2.5);
                    doc.line(logoX + 5, logoY + 2.5, logoX + 3.5, logoY + 2);
                    
                    // Rayo dentro de la taza (amarillo/oro)
                    doc.setFillColor(255, 215, 0);
                    doc.setLineWidth(0.3);
                    const rayoX = logoX - 0.5;
                    const rayoY = logoY;
                    doc.line(rayoX, rayoY - 1, rayoX - 0.7, rayoY + 0.5);
                    doc.line(rayoX - 0.7, rayoY + 0.5, rayoX + 0.3, rayoY + 0.3);
                    doc.line(rayoX + 0.3, rayoY + 0.3, rayoX, rayoY + 2);
                    doc.line(rayoX, rayoY + 2, rayoX + 0.7, rayoY + 0.2);
                    doc.line(rayoX + 0.7, rayoY + 0.2, rayoX - 0.3, rayoY + 0.5);
                }
                
                // Texto del nombre de marca
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(brand.NAME.toUpperCase(), logoX + 12, 14);
                
                // Subtexto seg√∫n marca
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                if (isDrk) {
                    doc.text(tr('Liderando el ahorro y la'), logoX + 12, 20);
                    doc.text(tr('eficiencia energ√©tica.'), logoX + 12, 24);
                } else {
                    doc.text(tr('Asesor√≠a Energ√©tica'), logoX + 12, 20);
                }
                
                doc.setTextColor(40, 60, 80);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('MULTICUPS', pageWidth - margin, 12, { align: 'right' });
                doc.setFontSize(11);
                doc.setTextColor(255, 255, 255);
                doc.text('FIJO VS INDEXADO', pageWidth - margin, 18, { align: 'right' });
                doc.setFontSize(9);
                doc.setTextColor(100, 120, 140);
                doc.text(`Total: ${res.cups}`, pageWidth - margin, 24, { align: 'right' });
                
                console.log('‚úÖ PASO 3: Encabezado completo creado (logo + t√≠tulo + Total CUPS:', res.cups, ')');
                
                yPos = headerHeight + 8;
                
                // === P√ÅGINA 1: RESUMEN VISUAL MEJORADO MULTICUPS ===
                
                yPos = headerHeight + 8;
                
                // === DATOS DEL CLIENTE ===
                
                // T√≠tulo "COMPARATIVA PROFESIONAL - DRK"
                doc.setTextColor(55, 65, 81);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('COMPARATIVA PROFESIONAL - ' + brand.NAME.toUpperCase(), margin, yPos);
                yPos += 8;
                
                // Info del cliente
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.setTextColor(75, 85, 99);
                doc.text(tr('CLIENTE:') + ' ' + clientName.toUpperCase(), margin, yPos);
                yPos += 6;
                doc.text('CUPS TOTALES: ' + res.cups, margin, yPos);
                yPos += 12;
                
                // === CAJA GRANDE CON LA MEJOR OPCI√ìN ===
                
                const bigBoxY = yPos;
                const bigBoxHeight = 45;
                const bigBoxMargin = 20;
                const bigBoxWidth = contentWidth - (bigBoxMargin * 2);
                const bigBoxX = margin + bigBoxMargin;
                
                // CR√çTICO: Color de fondo seg√∫n marca
                const bigBoxColor = isDrk ? [100, 116, 139] : [115, 130, 95]; // Gris azulado (DRK) o Verde oliva (POWER)
                doc.setFillColor(...bigBoxColor);
                doc.roundedRect(bigBoxX, bigBoxY, bigBoxWidth, bigBoxHeight, 4, 4, 'F');
                
                // Texto "LA MEJOR OPCI√ìN PARA TI ES"
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.text(tr('LA MEJOR OPCI√ìN PARA TI ES'), pageWidth / 2, bigBoxY + 12, { align: 'center' });
                
                // Nombre de la marca en grande
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(30);
                doc.text(brand.NAME.toUpperCase(), pageWidth / 2, bigBoxY + 26, { align: 'center' });
                
                // Descripci√≥n
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                const descripcion = tr('Ofrece el mayor ahorro consolidado con') + ' ' + brand.FULL_NAME + '.';
                doc.text(descripcion, pageWidth / 2, bigBoxY + 37, { align: 'center' });
                
                yPos = bigBoxY + bigBoxHeight + 10;
                
                // === TRES CAJAS GRANDES ===
                const boxWidth = (contentWidth - 4) / 3;
                const box1X = margin;
                const box2X = margin + boxWidth + 2;
                const box3X = margin + (boxWidth + 2) * 2;
                const boxHeight = 60;
                
                // Calcular totales
                const totalIndexadoAnual = res.indexedTotals ? res.indexedTotals.totalAnnual : 0;
                const ahorroIndexado = res.indexedTotals ? res.indexedTotals.savings : 0;
                
                // Funci√≥n para dibujar caja (igual que en PDF individual)
                function drawVisualBox(x, headerColor, headerText, label, mainPrice, subLabel, bottomPrice, isCrossed = false) {
                    let y = yPos;
                    
                    // Cabecera de color
                    doc.setFillColor(...headerColor);
                    doc.roundedRect(x, y, boxWidth, 9, 1.5, 1.5, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(6.5);
                    doc.setFont('helvetica', 'bold');
                    const headerLines = doc.splitTextToSize(headerText, boxWidth - 2);
                    doc.text(headerLines, x + boxWidth / 2, y + 4, { align: 'center' });
                    y += 10;
                    
                    // Cuerpo de la caja
                    const bodyColor = headerColor[0] === 75 ? [248, 249, 250] : (headerColor[0] === 59 ? [239, 246, 255] : [240, 253, 244]);
                    doc.setFillColor(...bodyColor);
                    doc.setDrawColor(...headerColor);
                    doc.setLineWidth(1.5);
                    doc.roundedRect(x, y, boxWidth, boxHeight - 10, 1.5, 1.5, 'FD');
                    
                    // Label
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'bold');
                    doc.text(label.toUpperCase(), x + boxWidth / 2, y + 7, { align: 'center' });
                    
                    // Precio principal (grande)
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(isCrossed ? 220 : headerColor[0], isCrossed ? 38 : headerColor[1], isCrossed ? 38 : headerColor[2]);
                    const mainPriceText = mainPrice;
                    doc.text(mainPriceText, x + boxWidth / 2, y + 18, { align: 'center' });
                    
                    // Tachar si es necesario
                    if (isCrossed) {
                        const textWidth = doc.getTextWidth(mainPriceText);
                        doc.setDrawColor(220, 38, 38);
                        doc.setLineWidth(0.7);
                        doc.line(x + boxWidth / 2 - textWidth / 2, y + 17, x + boxWidth / 2 + textWidth / 2, y + 17);
                    }
                    
                    // Sublabel
                    doc.setFontSize(5.5);
                    doc.setTextColor(120, 120, 120);
                    doc.setFont('helvetica', 'normal');
                    doc.text(subLabel, x + boxWidth / 2, y + 24, { align: 'center' });
                    
                    // L√≠nea separadora
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.3);
                    doc.line(x + 5, y + 30, x + boxWidth - 5, y + 30);
                    
                    // Precio inferior (anual)
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(isCrossed ? 220 : headerColor[0], isCrossed ? 38 : headerColor[1], isCrossed ? 38 : headerColor[2]);
                    doc.text(bottomPrice, x + boxWidth / 2, y + 42, { align: 'center' });
                }
                
                // CAJA 1: TU FACTURA ACTUAL (GRIS) - REEMPLAZADA CON DISE√ëO LIMPIO
                
                console.log('‚úÖ PASO 4: Iniciando dibujo de 3 columnas (Factura Actual, Fijo, Indexado)');
                
                // === COLUMNA 1: TU FACTURA ACTUAL (DISE√ëO LIMPIO) ===
                let y1 = yPos + 25;
                
                // T√≠tulo
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.setTextColor(107, 114, 128);
                doc.text(tr('TU FACTURA ACTUAL'), margin, y1);
                y1 += 12;
                
                // Precio mensual (TACHADO)
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(22);
                doc.setTextColor(220, 38, 38);
                const precioMensualActual = eur(res.importe_total);
                doc.text(precioMensualActual, margin, y1);
                
                // L√≠nea tachada
                const tw1 = doc.getTextWidth(precioMensualActual);
                doc.setDrawColor(220, 38, 38);
                doc.setLineWidth(1.5);
                doc.line(margin, y1 - 4, margin + tw1, y1 - 4);
                y1 += 10;
                
                // Subtexto
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(156, 163, 175);
                doc.text('Total Periodo (varios d√≠as)', margin, y1);
                y1 += 14;
                
                // Precio anual (TACHADO)
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(20);
                doc.setTextColor(220, 38, 38);
                const precioAnualActual = eur(res.originalBillAnnual) + tr('/a√±o');
                doc.text(precioAnualActual, margin, y1);
                
                // L√≠nea tachada
                const tw2 = doc.getTextWidth(precioAnualActual);
                doc.setDrawColor(220, 38, 38);
                doc.setLineWidth(1.5);
                doc.line(margin, y1 - 3, margin + tw2, y1 - 3);
                
                // === COLUMNA 2: AHORRO + NUEVO COSTE FIJO (CENTRO) ===
                
                let y2 = yPos;
                const col2X = margin + (contentWidth / 3);
                
                // CR√çTICO: Color de caja seg√∫n marca
                const cajaHeaderColor = isDrk ? [100, 116, 139] : [115, 130, 95]; // Gris azulado (DRK) o Verde oliva (POWER)
                
                // Caja superior "TU AHORRO ANUAL FIJO"
                const boxHeaderHeight = 12;
                doc.setFillColor(...cajaHeaderColor);
                doc.roundedRect(col2X - 2, y2, (contentWidth / 3) - 8, boxHeaderHeight, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                doc.text('TU AHORRO ANUAL FIJO', col2X + ((contentWidth / 3) - 8) / 2 - 2, y2 + 8, { align: 'center' });
                y2 += boxHeaderHeight + 12;
                
                // Ahorro en verde GRANDE
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(30);
                doc.setTextColor(22, 163, 74);
                doc.text(eur(res.savings), col2X, y2);
                y2 += 18;
                
                // "TU NUEVO COSTE [MARCA]"
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.setTextColor(107, 114, 128);
                doc.text(tr('TU NUEVO COSTE') + ' ' + brand.NAME.toUpperCase(), col2X, y2);
                y2 += 12;
                
                // Precio mensual nuevo (color de marca)
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(20);
                doc.setTextColor(...brandColor);
                doc.text(eur(res.totalAnnual / 12) + tr('/mes'), col2X, y2);
                y2 += 10;
                
                // Subtexto "Estimado Mensual"
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(156, 163, 175);
                doc.text(tr('Estimado Mensual'), col2X, y2);
                y2 += 12;
                
                // Precio anual nuevo (color de marca)
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18);
                doc.setTextColor(...brandColor);
                doc.text(eur(res.totalAnnual) + tr('/a√±o'), col2X, y2);
                
                // === COLUMNA 3: AHORRO + NUEVO COSTE INDEXADO (DERECHA) ===
                
                let y3 = yPos;
                const col3X = margin + (contentWidth / 3) * 2;
                
                // Caja superior "TU AHORRO ANUAL INDEXADO" (con mismo color que FIJO)
                doc.setFillColor(...cajaHeaderColor);
                doc.roundedRect(col3X - 2, y3, (contentWidth / 3) - 8, boxHeaderHeight, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                doc.text('TU AHORRO ANUAL INDEXADO', col3X + ((contentWidth / 3) - 8) / 2 - 2, y3 + 8, { align: 'center' });
                y3 += boxHeaderHeight + 12;
                
                // Ahorro en verde GRANDE
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(30);
                doc.setTextColor(22, 163, 74);
                doc.text(eur(ahorroIndexado), col3X, y3);
                y3 += 18;
                
                // "TU NUEVO COSTE [MARCA]"
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.setTextColor(107, 114, 128);
                doc.text(tr('TU NUEVO COSTE') + ' ' + brand.NAME.toUpperCase(), col3X, y3);
                y3 += 12;
                
                // Precio mensual nuevo
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(20);
                doc.setTextColor(22, 163, 74);
                doc.text(eur(totalIndexadoAnual / 12) + tr('/mes'), col3X, y3);
                y3 += 10;
                
                // Subtexto "Estimado Mensual"
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(156, 163, 175);
                doc.text(tr('Estimado Mensual'), col3X, y3);
                y3 += 12;
                
                // Precio anual nuevo
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18);
                doc.setTextColor(22, 163, 74);
                doc.text(eur(totalIndexadoAnual) + tr('/a√±o'), col3X, y3);
                
                // Actualizar yPos al m√°ximo de las tres columnas
                const maxY = Math.max(y1, y2, y3);
                
                // L√çNEAS VERTICALES SEPARADORAS
                const lineStartY = yPos - 5;
                const lineEndY = maxY + 5;
                
                // L√≠nea entre columna 1 y 2
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.5);
                doc.line(col2X - 10, lineStartY, col2X - 10, lineEndY);
                
                // L√≠nea entre columna 2 y 3
                doc.line(col3X - 10, lineStartY, col3X - 10, lineEndY);
                
                yPos = maxY + 15;
                
                // Nota
                doc.setFillColor(255, 251, 235);
                doc.setDrawColor(245, 158, 11);
                doc.setLineWidth(0.3);
                doc.roundedRect(margin, yPos, contentWidth, 18, 1, 1, 'FD');
                
                doc.setTextColor(146, 64, 14);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.text('‚ö†Ô∏è IMPORTANTE:', margin + 2, yPos + 5);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(6.5);
                const noteText = doc.splitTextToSize(
                    'A continuaci√≥n encontrar√° el desarrollo detallado de c√°lculos para cada suministro, mostrando el desglose completo de costes tanto para tarifas fijas como indexadas.',
                    contentWidth - 4
                );
                let noteY = yPos + 10;
                noteText.forEach(line => {
                    doc.text(line, margin + 2, noteY);
                    noteY += 3;
                });
                
                // === P√ÅGINAS 2-N: DESARROLLO DETALLADO DE CADA CUPS ===
                
                // Funci√≥n auxiliar para generar desglose detallado
                function generarDesgloseDetalladoCUPS(supply, x, width, color, titulo, usarIndexado = false) {
                    const resultado = usarIndexado && supply.indexedComparison ? supply.indexedComparison : supply;
                    
                    // VERIFICACI√ìN CR√çTICA: Asegurar que resultado tiene los datos necesarios
                    if (!resultado || !resultado.powerCosts || !resultado.energyCosts) {
                        console.error('ERROR: resultado no tiene la estructura necesaria', resultado);
                        doc.setTextColor(220, 38, 38);
                        doc.setFontSize(8);
                        doc.text('Error: Datos incompletos para este suministro', x + 2, yPos + 10);
                        return;
                    }
                    
                    const tariffType = resultado.originalTariffType || currentTariffType;
                    const config = TARIFF_CONFIG[tariffType] || TARIFF_CONFIG['2.0TD'];
                    
                    // COLORES SEG√öN MARCA (PowerCup usa verde oliva en lugar de gris)
                    const headerDarkColor = isDrk ? [71, 85, 105] : [95, 110, 75];   // Gris oscuro DRK o Verde oliva oscuro PowerCup
                    const headerMedColor = isDrk ? [100, 116, 139] : [110, 125, 90]; // Gris medio DRK o Verde oliva medio PowerCup
                    
                    let y = yPos;
                    
                    // === CABECERA OSCURA CON CUPS ===
                    doc.setFillColor(...headerDarkColor);
                    doc.roundedRect(x, y, width, 14, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`[${supply.cups.slice(-12)}]`, x + 3, y + 4);
                    doc.text(`Tipo: ${tariffType}`, x + width - 3, y + 4, { align: 'right' });
                    doc.text(`D√≠as: ${resultado.dias_facturados || 0}`, x + width - 3, y + 8, { align: 'right' });
                    
                    // Nombre completo: Comercializadora - Tarifa
                    doc.setFontSize(6.5);
                    doc.setFont('helvetica', 'normal');
                    const comercializadora = resultado.offer.name || brand.NAME;
                    const nombreTarifa = resultado.offer.description || 'N/A';
                    const nombreCompleto = `${comercializadora} - ${nombreTarifa}`;
                    doc.text(nombreCompleto, x + 3, y + 11);
                    
                    y += 16;
                    
                    // === CAJA PRECIOS APLICADOS ===
                    doc.setFillColor(...headerMedColor);
                    doc.roundedRect(x, y, width, 8, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PRECIOS APLICADOS:', x + 3, y + 6);
                    y += 10;
                    
                    // Info de precios (Potencia y Energ√≠a)
                    doc.setFillColor(...headerMedColor);
                    doc.roundedRect(x, y, width, 16, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('POTENCIA:'), x + 3, y + 4);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(5.5);
                    
                    // Mostrar precios de potencia reales
                    if (resultado.powerCosts.length > 0) {
                        doc.text(`P1: ${num(resultado.powerCosts[0].priceDay || 0, 6)} ‚Ç¨/kW/d√≠a`, x + 3, y + 8);
                    }
                    if (resultado.powerCosts.length > 1) {
                        doc.text(`P2: ${num(resultado.powerCosts[1].priceDay || 0, 6)} ‚Ç¨/kW/d√≠a`, x + 3, y + 11);
                    }
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(6);
                    doc.text('ENERG√çA:', x + width/2, y + 4);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(5.5);
                    
                    // Mostrar precios de energ√≠a reales
                    if (resultado.energyCosts.length > 0) {
                        doc.text(`E1: ${num(resultado.energyCosts[0].price || 0, 6)} ‚Ç¨/kWh`, x + width/2, y + 8);
                    }
                    if (resultado.energyCosts.length > 1) {
                        doc.text(`E2: ${num(resultado.energyCosts[1].price || 0, 6)} ‚Ç¨/kWh`, x + width/2, y + 11);
                    }
                    if (resultado.energyCosts.length > 2) {
                        doc.text(`E3: ${num(resultado.energyCosts[2].price || 0, 6)} ‚Ç¨/kWh`, x + width/2, y + 14);
                    }
                    y += 20;
                    
                    // === SECCI√ìN POTENCIA ===
                    doc.setFillColor(...headerMedColor);
                    doc.roundedRect(x, y, width, 7, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('POTENCIA', x + 3, y + 5);
                    y += 9;
                    
                    // Desglose potencia
                    doc.setTextColor(55, 65, 81);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'normal');
                    resultado.powerCosts.forEach(p => {
                        if (p.kw > 0 || p.period <= config.powerPeriods) {
                            const formula = `P${p.period}: (${num(p.kw, 2)} kW x ${numPriceFormula(p.priceDay)} ‚Ç¨/kW/d√≠a)`;
                            doc.text(formula, x + 3, y);
                            doc.text(`${num(p.cost, 2)} ‚Ç¨`, x + width - 3, y, { align: 'right' });
                            y += 4;
                        }
                    });
                    y += 2;
                    
                    // === SECCI√ìN ENERG√çA ===
                    doc.setFillColor(...headerMedColor);
                    doc.roundedRect(x, y, width, 7, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('ENERG√çA', x + 3, y + 5);
                    y += 9;
                    
                    // Desglose energ√≠a
                    doc.setTextColor(55, 65, 81);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'normal');
                    resultado.energyCosts.forEach(e => {
                        if (e.kwh > 0 || e.period <= config.periods) {
                            let label = `E${e.period}`;
                            if (tariffType === '2.0TD') {
                                if (e.period === 1) label += ` (${tr('Punta')})`;
                                if (e.period === 2) label += ` (${tr('Llano')})`;
                                if (e.period === 3) label += ` (${tr('Valle')})`;
                            }
                            const formula = `${label}: (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)} ‚Ç¨/kWh)`;
                            doc.text(formula, x + 3, y);
                            doc.text(`${num(e.cost, 2)} ‚Ç¨`, x + width - 3, y, { align: 'right' });
                            y += 4;
                        }
                    });
                    y += 2;
                    
                    // === TOTAL ===
                    doc.setFillColor(...headerDarkColor);
                    doc.roundedRect(x, y, width, 9, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`TOTAL (${resultado.dias_facturados || 0} D√çAS)`, x + 3, y + 6);
                    doc.text(eur(resultado.totalPeriod || 0), x + width - 3, y + 6, { align: 'right' });
                    y += 12;
                    
                    // === AHORRO ===
                    doc.setFillColor(220, 38, 38);
                    doc.roundedRect(x + width - 55, y, 52, 10, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('AHORRO:', x + width - 52, y + 4);
                    doc.setFontSize(9);
                    doc.text(eur(resultado.savings || 0), x + width - 28, y + 7, { align: 'center' });
                }
                
                console.log('‚úÖ PASO 5: Funci√≥n generarDesgloseDetalladoCUPS definida');
                console.log('‚úÖ PASO 6: res.individualResults existe?', !!res.individualResults);
                console.log('‚úÖ PASO 6B: res.individualResults.length:', res.individualResults ? res.individualResults.length : 'undefined');
                
                // Generar p√°ginas de desarrollo para cada CUPS
                console.log('üîß Iniciando forEach de p√°ginas detalladas para', res.individualResults ? res.individualResults.length : 0, 'suministros');
                res.individualResults.forEach((supply, idx) => {
                    console.log(`  üìÑ Generando p√°gina detallada ${idx + 1}/${res.individualResults.length} para CUPS:`, supply.cups);
                    doc.addPage();
                    yPos = 15;
                    
                    // ENCABEZADO PROFESIONAL CON FONDO DE COLOR
                    const headerBgColor = isDrk ? [140, 150, 160] : [110, 125, 90]; // Gris para DRK, verde oliva para POWER CUP
                    const headerHeight = 12;
                    
                    doc.setFillColor(...headerBgColor);
                    doc.roundedRect(margin, yPos, contentWidth, headerHeight, 3, 3, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`DESARROLLO DETALLADO - SUMINISTRO ${idx + 1} DE ${res.individualResults.length}`, pageWidth / 2, yPos + 8, { align: 'center' });
                    
                    yPos += headerHeight + 4;
                    
                    // Dos columnas con desarrollo
                    generarDesgloseDetalladoCUPS(
                        supply,
                        leftX,
                        colWidth,
                        blueColor,
                        `TARIFA FIJA: ${supply.offer.name}`,
                        false
                    );
                    
                    generarDesgloseDetalladoCUPS(
                        supply,
                        rightX,
                        colWidth,
                        greenColor,
                        `TARIFA INDEXADA: ${supply.indexedComparison ? supply.indexedComparison.offer.name : 'N/A'}`,
                        true
                    );
                });
                
                // === NUEVA P√ÅGINA: RESUMEN DE TODOS LOS SUMINISTROS ===
                doc.addPage();
                yPos = 20;
                
                // Encabezado con color seg√∫n marca
                const headerBgColor = isDrk ? [140, 150, 160] : [110, 125, 90];
                doc.setFillColor(...headerBgColor);
                doc.roundedRect(margin, yPos, contentWidth, 14, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('RESUMEN DE TODOS LOS SUMINISTROS', pageWidth / 2, yPos + 9.5, { align: 'center' });
                yPos += 20;
                
                // Cabeceras de columnas (mismo color que el encabezado principal)
                doc.setFillColor(...headerBgColor);
                doc.roundedRect(leftX, yPos, colWidth, 8, 1, 1, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(8);
                doc.text('TARIFAS FIJAS', leftX + colWidth / 2, yPos + 5.5, { align: 'center' });
                
                doc.setFillColor(...headerBgColor);
                doc.roundedRect(rightX, yPos, colWidth, 8, 1, 1, 'F');
                doc.text('TARIFAS INDEXADAS', rightX + colWidth / 2, yPos + 5.5, { align: 'center' });
                yPos += 12;
                
                // Listar cada suministro
                let totalFijas = 0;
                let totalIndexadas = 0;
                
                res.individualResults.forEach((supply, idx) => {
                    // FIJO
                    doc.setFillColor(239, 246, 255);
                    doc.roundedRect(leftX, yPos, colWidth, 11, 1, 1, 'F');
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(6.5);
                    doc.setFont('helvetica', 'bold');
                    doc.text(supply.cups.slice(-12), leftX + 2, yPos + 4);
                    doc.setTextColor(22, 163, 74);
                    doc.setFontSize(7);
                    doc.text(eur(supply.savings), leftX + colWidth - 2, yPos + 4, { align: 'right' });
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(5.5);
                    doc.setFont('helvetica', 'normal');
                    const nombreFija = supply.offer.name || 'N/A';
                    doc.text(nombreFija.substring(0, 35), leftX + 2, yPos + 8.5);
                    
                    // INDEXADO
                    doc.setFillColor(240, 253, 244);
                    doc.roundedRect(rightX, yPos, colWidth, 11, 1, 1, 'F');
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(6.5);
                    doc.setFont('helvetica', 'bold');
                    doc.text(supply.cups.slice(-12), rightX + 2, yPos + 4);
                    const savingsIdx = supply.indexedComparison ? supply.indexedComparison.savings : 0;
                    doc.setTextColor(22, 163, 74);
                    doc.setFontSize(7);
                    doc.text(eur(savingsIdx), rightX + colWidth - 2, yPos + 4, { align: 'right' });
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(5.5);
                    doc.setFont('helvetica', 'normal');
                    const nombreIdx = supply.indexedComparison ? supply.indexedComparison.offer.name : 'N/A';
                    doc.text(nombreIdx.substring(0, 35), rightX + 2, yPos + 8.5);
                    
                    totalFijas += supply.savings || 0;
                    totalIndexadas += savingsIdx;
                    yPos += 13;
                });
                
                // Espacio antes de los totales
                yPos += 5;
                
                // CAJAS ROJAS CON TOTALES
                doc.setFillColor(220, 38, 38);
                doc.roundedRect(leftX, yPos, colWidth, 13, 2, 2, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('AHORRO TOTAL FIJAS:', leftX + 3, yPos + 6);
                doc.setFontSize(11);
                doc.text(eur(totalFijas), leftX + colWidth - 3, yPos + 9.5, { align: 'right' });
                
                doc.setFillColor(220, 38, 38);
                doc.roundedRect(rightX, yPos, colWidth, 13, 2, 2, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('AHORRO TOTAL INDEXADAS:', rightX + 3, yPos + 6);
                doc.setFontSize(11);
                doc.text(eur(totalIndexadas), rightX + colWidth - 3, yPos + 9.5, { align: 'right' });
                
                // === P√ÅGINA FINAL: EXPLICACI√ìN ===
                doc.addPage();
                yPos = 15;
                
                doc.setFillColor(245, 245, 245);
                doc.roundedRect(margin, yPos, contentWidth, 120, 2, 2, 'F');
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('CUAL ES LA DIFERENCIA?', pageWidth / 2, yPos + 8, { align: 'center' });
                
                yPos += 15;
                
                // Columna izquierda
                let leftColY = yPos;
                doc.setFontSize(9);
                doc.setTextColor(...blueColor);
                doc.setFont('helvetica', 'bold');
                doc.text('POR QUE TARIFA FIJA?', leftX + 2, leftColY);
                leftColY += 6;
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                const fijaExplText = [
                    '‚Ä¢ Implica un precio fijo por los kilovatios que',
                    '  consumes (kWh).',
                    '',
                    '‚Ä¢ El precio se mantiene estable,',
                    '  independientemente de c√≥mo se comporten los',
                    '  precios en el mercado el√©ctrico.',
                    '',
                    '‚Ä¢ Cuando el precio del mercado est√° alto, el',
                    '  cliente est√° protegido frente a sobresaltos.',
                    '',
                    '‚Ä¢ No tendr√°s que estar pendiente de las',
                    '  variaciones del mercado y podr√°s seguir',
                    '  usando la electricidad como siempre.'
                ];
                
                fijaExplText.forEach(line => {
                    doc.text(line, leftX + 2, leftColY, { maxWidth: colWidth - 4 });
                    leftColY += 3.5;
                });
                
                // Columna derecha
                let rightColY = yPos;
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...greenColor);
                doc.text('POR QUE TARIFA INDEXADA?', rightX + 2, rightColY);
                rightColY += 6;
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                const indexExplText = [
                    '‚Ä¢ Implica un precio variable por los kilovatios',
                    '  que consumes (kWh) cada mes.',
                    '',
                    '‚Ä¢ Es la tarifa m√°s justa, ya que pagas el coste',
                    '  real de la energ√≠a mes a mes.',
                    '',
                    '‚Ä¢ Al contratarla, el cliente evita pagar',
                    '  m√°rgenes adicionales cuando el precio de la',
                    '  electricidad es m√°s barato.',
                    '',
                    '‚Ä¢ A largo plazo, con un indexado 100%',
                    '  funcional, se puede obtener un ahorro',
                    '  aproximado de hasta un 20% en √©pocas de',
                    '  mejor precio.'
                ];
                
                indexExplText.forEach(line => {
                    doc.text(line, rightX + 2, rightColY, { maxWidth: colWidth - 4 });
                    rightColY += 3.5;
                });
                
                // Guardar
                const filename = `MULTICUPS_Fijo_vs_Indexado_${new Date().getTime()}.pdf`;
                doc.save(filename);
                
                window.showMessageModal(`‚úÖ PDF generado con √©xito: ${filename}`);
                
                // Cerrar modal
                document.getElementById('send-offer-modal').classList.add('hidden');
                document.getElementById('send-offer-modal').classList.remove('flex');
                
            } catch (error) {
                console.error('Error generando PDF MULTICUPS dual:', error);
                window.showErrorModal(`Error al generar PDF: ${error.message}`);
            }
        }

        
        // --- SOLICITAR MEJORA A DRK (SIN AHORRO) ---
        
        async function handleRequestImprovement() {
            console.log('handleRequestImprovement llamada');
            
            // Verificar si hay datos de ELECTRICIDAD, GAS o DUAL
            const hasElectricityData = lastComparisonResult !== null;
            const hasGasData = window.lastGasComparisonResult !== null;
            const hasDualData = window.dualGlobalResults !== null && typeof dualSupplies !== 'undefined' && dualSupplies && dualSupplies.length >= 2;
            
            console.log('Verificando datos:', {hasElectricityData, hasGasData, hasDualData});
            
            if (!hasElectricityData && !hasGasData && !hasDualData) {
                return window.showErrorModal("Primero realice una comparaci√≥n.");
            }
            
            // Validar campos obligatorios
            const commercialCode = document.getElementById('improvement-comercial-code').value.trim();
            const clientName = document.getElementById('improvement-client-name').value.trim();
            const cups = document.getElementById('improvement-client-cups').value.trim();
            const phone = document.getElementById('improvement-client-phone').value.trim();
            const email = document.getElementById('improvement-client-email').value.trim();
            const observations = document.getElementById('improvement-observations').value.trim();
            
            if (!commercialCode) {
                return window.showErrorModal("El C√≥digo Comercial es obligatorio.");
            }
            
            try {
                let htmlContent = '';
                let desglose = '';
                let tipoSuministro = '';
                
                // DETERMINAR QU√â TIPO DE C√ÅLCULO SE HIZO √öLTIMO
                // Prioridad: DUAL > ELECTRICIDAD > GAS
                // Esto evita errores cuando hay datos de m√∫ltiples tipos
                
                // CASO 1: Datos DUAL (M√ÅXIMA PRIORIDAD)
                if (hasDualData) {
                    console.log('‚úÖ Usando datos DUAL');
                    tipoSuministro = 'DUAL (ELECTRICIDAD + GAS)';
                    const dualResults = window.dualGlobalResults;
                    const isDrk = dualResults.comparisonMode !== 'overall_best';
                    const brandColor = isDrk ? '#0ea5e9' : '#84cc16';
                    const brandName = isDrk ? 'DRK' : 'POWER CUP';
                    
                    // Separar suministros de electricidad y gas
                    const electricitySupply = dualSupplies.find(s => s.type === 'electricidad');
                    const gasSupply = dualSupplies.find(s => s.type === 'gas');
                    
                    htmlContent = `
                        <div style="font-family: Arial, sans-serif; max-width: 900px;">
                            <h2 style="color: ${brandColor}; text-align: center;">‚ö°üî• RESULTADO COMPARATIVA DUAL</h2>
                            <div style="background: linear-gradient(135deg, ${isDrk ? '#f0f9ff' : '#f7fee7'} 0%, ${isDrk ? '#e0f2fe' : '#ecfccb'} 100%); border: 3px solid ${brandColor}; border-radius: 12px; padding: 24px; margin: 20px 0;">
                                <h3 style="color: ${brandColor}; text-align: center; font-size: 24px;"${tr("LA MEJOR OPCI√ìN PARA TI ES")}</h3>
                                <h2 style="color: ${isDrk ? '#0c4a6e' : '#365314'}; text-align: center; font-size: 36px; margin: 16px 0;">Tus Tarifas Actuales</h2>
                                <p style="text-align: center; color: ${brandColor}; font-size: 18px;">Es la mejor opci√≥n detectada</p>
                            </div>
                            
                            <div style="background-color: white; border: 2px solid ${isDrk ? '#bfdbfe' : '#d9f99d'}; border-radius: 12px; padding: 20px; margin: 16px 0;">
                                <h4 style="color: ${brandColor}; text-align: center; font-size: 20px;">¬°ENHORABUENA!</h4>
                                <p style="text-align: center; color: ${isDrk ? '#0c4a6e' : '#365314'}; font-weight: bold; font-size: 18px;">Actualmente est√°s en buenas tarifas</p>
                                <p style="text-align: center; color: ${brandColor}; margin-top: 8px;">Tanto en ELECTRICIDAD como en GAS tienes tarifas competitivas.</p>
                            </div>
                            
                            <!-- Detalle ELECTRICIDAD -->
                            <div style="background-color: #EFF6FF; border-left: 4px solid #3B82F6; border-radius: 8px; padding: 16px; margin: 16px 0;">
                                <h3 style="color: #1E40AF; margin-bottom: 12px;">‚ö° ELECTRICIDAD</h3>
                                <table style="width: 100%; border-collapse: collapse;">
                                    <tr style="border-bottom: 1px solid #BFDBFE;">
                                        <td style="padding: 8px; font-weight: bold;">Tarifa:</td>
                                        <td style="padding: 8px; text-align: right;">${electricitySupply?.tariff || 'N/A'}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #BFDBFE;">
                                        <td style="padding: 8px; font-weight: bold;"${tr("CUPS:")}</td>
                                        <td style="padding: 8px; text-align: right; font-family: monospace; font-size: 11px;">${electricitySupply?.cups || 'N/A'}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #BFDBFE;">
                                        <td style="padding: 8px; font-weight: bold;">Periodo:</td>
                                        <td style="padding: 8px; text-align: right;">${electricitySupply?.electricityBreakdown?.dias || 'N/A'} d√≠as</td>
                                    </tr>
                                </table>
                                
                                <!-- Consumos por periodo -->
                                <div style="background-color: #DBEAFE; border-radius: 6px; padding: 12px; margin: 12px 0;">
                                    <p style="font-weight: bold; color: #1E40AF; margin: 0 0 8px 0; font-size: 14px;">üìä CONSUMOS:</p>
                                    ${(() => {
                                        const eb = electricitySupply?.electricityBreakdown;
                                        if (!eb?.energyCosts || !Array.isArray(eb.energyCosts)) return '<p style="margin:0;font-size:12px;color:#64748B;">No disponible</p>';
                                        
                                        let html = '<table style="width:100%; font-size:12px;">';
                                        let total = 0;
                                        eb.energyCosts.forEach(item => {
                                            const kwh = item.kwh || 0;
                                            total += kwh;
                                            if (kwh > 0) {
                                                html += `<tr><td style="padding:4px;">P${item.period}:</td><td style="text-align:right; font-weight:bold;">${kwh.toFixed(0)} kWh</td></tr>`;
                                            }
                                        });
                                        html += `<tr style="border-top:2px solid #3B82F6;"><td style="padding:4px; font-weight:bold;">TOTAL:</td><td style="text-align:right; font-weight:bold; color:#1E40AF;">${total.toFixed(0)} kWh</td></tr>`;
                                        html += '</table>';
                                        return html;
                                    })()}
                                </div>
                                
                                <!-- Potencias contratadas -->
                                <div style="background-color: #DBEAFE; border-radius: 6px; padding: 12px; margin: 12px 0;">
                                    <p style="font-weight: bold; color: #1E40AF; margin: 0 0 8px 0; font-size: 14px;">‚ö° POTENCIAS CONTRATADAS:</p>
                                    ${(() => {
                                        const eb = electricitySupply?.electricityBreakdown;
                                        if (!eb?.powerCosts || !Array.isArray(eb.powerCosts)) return '<p style="margin:0;font-size:12px;color:#64748B;">No disponible</p>';
                                        
                                        let html = '<table style="width:100%; font-size:12px;">';
                                        eb.powerCosts.forEach(item => {
                                            const kw = item.kw || 0;
                                            if (kw > 0) {
                                                html += `<tr><td style="padding:4px;">P${item.period}:</td><td style="text-align:right; font-weight:bold;">${kw} kW</td></tr>`;
                                            }
                                        });
                                        html += '</table>';
                                        return html;
                                    })()}
                                </div>
                                
                                <!-- PRECIOS APLICADOS -->
                                <div style="background-color: #DBEAFE; border-radius: 6px; padding: 12px; margin: 12px 0;">
                                    <p style="font-weight: bold; color: #1E40AF; margin: 0 0 8px 0; font-size: 14px;">üìã PRECIOS APLICADOS:</p>
                                    ${(() => {
                                        const eb = electricitySupply?.electricityBreakdown;
                                        let html = '<div style="font-size:12px;">';
                                        
                                        // Precios de POTENCIA
                                        if (eb?.powerCosts && Array.isArray(eb.powerCosts)) {
                                            html += '<p style="margin:0 0 6px 0; font-weight:bold; color:#1E40AF; font-size:11px;">POTENCIA:</p>';
                                            html += '<table style="width:100%; margin-bottom:12px;">';
                                            eb.powerCosts.forEach(item => {
                                                if ((item.kw || 0) > 0 && item.priceDay) {
                                                    html += `<tr><td style="padding:2px;">P${item.period}:</td><td style="text-align:right;">${item.priceDay.toFixed(6)} ‚Ç¨/kW/d√≠a</td></tr>`;
                                                }
                                            });
                                            html += '</table>';
                                        }
                                        
                                        // Precios de ENERG√çA
                                        if (eb?.energyCosts && Array.isArray(eb.energyCosts)) {
                                            html += '<p style="margin:0 0 6px 0; font-weight:bold; color:#1E40AF; font-size:11px;">ENERG√çA:</p>';
                                            html += '<table style="width:100%;">';
                                            eb.energyCosts.forEach(item => {
                                                if ((item.kwh || 0) > 0 && item.price) {
                                                    html += `<tr><td style="padding:2px;">P${item.period}:</td><td style="text-align:right;">${item.price.toFixed(6)} ‚Ç¨/kWh</td></tr>`;
                                                }
                                            });
                                            html += '</table>';
                                        }
                                        
                                        html += '</div>';
                                        return html;
                                    })()}
                                </div>
                                
                                <!-- Costes del periodo -->
                                <div style="background-color: #DBEAFE; border-radius: 6px; padding: 12px; margin: 12px 0;">
                                    <p style="font-weight: bold; color: #1E40AF; margin: 0 0 8px 0; font-size: 14px;">üí∞ COSTES PERIODO:</p>
                                    <table style="width: 100%; font-size: 12px;">
                                        <tr><td style="padding:4px;">Potencia:</td><td style="text-align:right;">${(electricitySupply?.electricityBreakdown?.subPower || 0).toFixed(2)} ‚Ç¨</td></tr>
                                        <tr><td style="padding:4px;">Energ√≠a:</td><td style="text-align:right;">${(electricitySupply?.electricityBreakdown?.subEnergy || 0).toFixed(2)} ‚Ç¨</td></tr>
                                        <tr><td style="padding:4px;">Imp. el√©ctrico:</td><td style="text-align:right;">${(electricitySupply?.electricityBreakdown?.costIE || 0).toFixed(2)} ‚Ç¨</td></tr>
                                        <tr><td style="padding:4px;">IVA (21%):</td><td style="text-align:right;">${(electricitySupply?.electricityBreakdown?.costIVA || 0).toFixed(2)} ‚Ç¨</td></tr>
                                        <tr style="border-top:2px solid #3B82F6; font-weight:bold;">
                                            <td style="padding:8px 4px 4px 4px;">TOTAL:</td>
                                            <td style="text-align:right; padding:8px 4px 4px 4px; color:#1E40AF;">${(electricitySupply?.electricityBreakdown?.totalPeriod || 0).toFixed(2)} ‚Ç¨</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <table style="width: 100%; border-collapse: collapse; margin-top: 12px;">
                                    <tr style="background-color: #DBEAFE;">
                                        <td style="padding: 12px; font-size: 16px; font-weight: bold; color: #1E3A8A;">Coste actual anual:</td>
                                        <td style="padding: 12px; font-size: 18px; text-align: right; color: #1E3A8A; font-weight: bold;">${(electricitySupply?.originalBillAnnual || 0).toFixed(2)} ‚Ç¨</td>
                                    </tr>
                                    <tr style="background-color: #DBEAFE;">
                                        <td style="padding: 12px; font-size: 16px; font-weight: bold; color: #1E3A8A;">Con ${brandName}:</td>
                                        <td style="padding: 12px; font-size: 18px; text-align: right; color: #1E3A8A; font-weight: bold;">${(electricitySupply?.totalAnnual || 0).toFixed(2)} ‚Ç¨</td>
                                    </tr>
                                    <tr style="background-color: ${((electricitySupply?.originalBillAnnual || 0) - (electricitySupply?.totalAnnual || 0)) > 0 ? '#D1FAE5' : '#FEE2E2'};">
                                        <td style="padding: 12px; font-size: 16px; font-weight: bold; color: ${((electricitySupply?.originalBillAnnual || 0) - (electricitySupply?.totalAnnual || 0)) > 0 ? '#065F46' : '#991B1B'};">Ahorro anual:</td>
                                        <td style="padding: 12px; font-size: 18px; text-align: right; color: ${((electricitySupply?.originalBillAnnual || 0) - (electricitySupply?.totalAnnual || 0)) > 0 ? '#065F46' : '#991B1B'}; font-weight: bold;">${((electricitySupply?.originalBillAnnual || 0) - (electricitySupply?.totalAnnual || 0)).toFixed(2)} ‚Ç¨</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <!-- Detalle GAS -->
                            <div style="background-color: #FEE2E2; border-left: 4px solid #DC2626; border-radius: 8px; padding: 16px; margin: 16px 0;">
                                <h3 style="color: #991B1B; margin-bottom: 12px;">üî• GAS</h3>
                                <table style="width: 100%; border-collapse: collapse;">
                                    <tr style="border-bottom: 1px solid #FCA5A5;">
                                        <td style="padding: 8px; font-weight: bold;">Tarifa:</td>
                                        <td style="padding: 8px; text-align: right;">${gasSupply?.tariff || 'N/A'}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #FCA5A5;">
                                        <td style="padding: 8px; font-weight: bold;">Periodo:</td>
                                        <td style="padding: 8px; text-align: right;">${gasSupply?.gasBreakdown?.dias || gasSupply?.data?.dias || 'N/A'} d√≠as</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #FCA5A5;">
                                        <td style="padding: 8px; font-weight: bold;">Consumo total:</td>
                                        <td style="padding: 8px; text-align: right; font-weight: bold;">${gasSupply?.gasBreakdown?.kwh || gasSupply?.data?.kwh || '0'} kWh</td>
                                    </tr>
                                </table>
                                
                                <!-- Precios aplicados -->
                                <div style="background-color: #FECACA; border-radius: 6px; padding: 12px; margin: 12px 0;">
                                    <p style="font-weight: bold; color: #991B1B; margin: 0 0 8px 0; font-size: 14px;">üìã PRECIOS APLICADOS:</p>
                                    <table style="width: 100%; font-size: 12px;">
                                        <tr>
                                            <td style="padding:4px;">T√©rmino fijo:</td>
                                            <td style="text-align:right; font-weight:bold;">${(gasSupply?.gasBreakdown?.termino_fijo_diario || gasSupply?.offer?.p_fijo_diario || 0).toFixed(6)} ‚Ç¨/d√≠a</td>
                                        </tr>
                                        <tr>
                                            <td style="padding:4px;">Precio energ√≠a:</td>
                                            <td style="text-align:right; font-weight:bold;">${(gasSupply?.offer?.p1_price || 0).toFixed(6)} ‚Ç¨/kWh</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <!-- Costes del periodo -->
                                <div style="background-color: #FECACA; border-radius: 6px; padding: 12px; margin: 12px 0;">
                                    <p style="font-weight: bold; color: #991B1B; margin: 0 0 8px 0; font-size: 14px;">üí∞ COSTES PERIODO:</p>
                                    <table style="width: 100%; font-size: 12px;">
                                        <tr><td style="padding:4px;">T√©rmino fijo:</td><td style="text-align:right;">${(gasSupply?.gasBreakdown?.termino_fijo || 0).toFixed(2)} ‚Ç¨</td></tr>
                                        <tr><td style="padding:4px;">Energ√≠a:</td><td style="text-align:right;">${(gasSupply?.gasBreakdown?.energia || 0).toFixed(2)} ‚Ç¨</td></tr>
                                        <tr><td style="padding:4px;">Imp. hidrocarburos:</td><td style="text-align:right;">${(gasSupply?.gasBreakdown?.impuesto_hidrocarburos || 0).toFixed(2)} ‚Ç¨</td></tr>
                                        <tr><td style="padding:4px;">IVA (21%):</td><td style="text-align:right;">${(gasSupply?.gasBreakdown?.iva || 0).toFixed(2)} ‚Ç¨</td></tr>
                                        <tr style="border-top:2px solid #DC2626; font-weight:bold;">
                                            <td style="padding:8px 4px 4px 4px;">TOTAL:</td>
                                            <td style="text-align:right; padding:8px 4px 4px 4px; color:#991B1B;">${(gasSupply?.gasBreakdown?.total || 0).toFixed(2)} ‚Ç¨</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <table style="width: 100%; border-collapse: collapse; margin-top: 12px;">
                                    <tr style="background-color: #FECACA;">
                                        <td style="padding: 12px; font-size: 16px; font-weight: bold; color: #7F1D1D;">Coste actual anual:</td>
                                        <td style="padding: 12px; font-size: 18px; text-align: right; color: #7F1D1D; font-weight: bold;">${(gasSupply?.originalBillAnnual || 0).toFixed(2)} ‚Ç¨</td>
                                    </tr>
                                    <tr style="background-color: #FECACA;">
                                        <td style="padding: 12px; font-size: 16px; font-weight: bold; color: #7F1D1D;">Con ${brandName}:</td>
                                        <td style="padding: 12px; font-size: 18px; text-align: right; color: #7F1D1D; font-weight: bold;">${(gasSupply?.totalAnnual || 0).toFixed(2)} ‚Ç¨</td>
                                    </tr>
                                    <tr style="background-color: ${((gasSupply?.originalBillAnnual || 0) - (gasSupply?.totalAnnual || 0)) > 0 ? '#D1FAE5' : '#FEE2E2'};">
                                        <td style="padding: 12px; font-size: 16px; font-weight: bold; color: ${((gasSupply?.originalBillAnnual || 0) - (gasSupply?.totalAnnual || 0)) > 0 ? '#065F46' : '#991B1B'};">Ahorro anual:</td>
                                        <td style="padding: 12px; font-size: 18px; text-align: right; color: ${((gasSupply?.originalBillAnnual || 0) - (gasSupply?.totalAnnual || 0)) > 0 ? '#065F46' : '#991B1B'}; font-weight: bold;">${((gasSupply?.originalBillAnnual || 0) - (gasSupply?.totalAnnual || 0)).toFixed(2)} ‚Ç¨</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <!-- Total consolidado -->
                            <div style="background: linear-gradient(135deg, ${brandColor} 0%, ${isDrk ? '#0369a1' : '#65a30d'} 100%); border-radius: 12px; padding: 20px; margin-top: 20px;">
                                <h3 style="color: white; text-align: center; margin-bottom: 16px; font-size: 20px;">üìä RESUMEN CONSOLIDADO ANUAL</h3>
                                
                                <!-- Factura actual -->
                                <div style="background-color: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 2px solid ${brandColor};">
                                    <p style="color: ${brandColor}; font-weight: bold; margin: 0 0 8px 0; font-size: 14px;">FACTURA ACTUAL TOTAL:</p>
                                    <table style="width: 100%; color: ${isDrk ? '#0c4a6e' : '#365314'};">
                                        <tr>
                                            <td style="padding: 4px; font-size: 28px; font-weight: bold; text-align: center; color: ${brandColor};" colspan="2">${(dualResults.totalOriginalBill || 0).toFixed(2)} ‚Ç¨/a√±o</td>
                                        </tr>
                                        <tr style="border-top: 2px solid ${isDrk ? '#bfdbfe' : '#d9f99d'};">
                                            <td style="padding: 8px 4px 4px 4px;">‚ö° Electricidad:</td>
                                            <td style="padding: 8px 4px 4px 4px; text-align: right; font-weight: bold;">${(electricitySupply?.originalBillAnnual || 0).toFixed(2)} ‚Ç¨</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 4px;">üî• Gas:</td>
                                            <td style="padding: 4px; text-align: right; font-weight: bold;">${(gasSupply?.originalBillAnnual || 0).toFixed(2)} ‚Ç¨</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <!-- Con DRK/Power Cup -->
                                <div style="background-color: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 2px solid ${brandColor};">
                                    <p style="color: ${brandColor}; font-weight: bold; margin: 0 0 8px 0; font-size: 14px;">CON ${brandName.toUpperCase()}:</p>
                                    <table style="width: 100%; color: ${isDrk ? '#0c4a6e' : '#365314'};">
                                        <tr>
                                            <td style="padding: 4px; font-size: 28px; font-weight: bold; text-align: center; color: ${brandColor};" colspan="2">${((isDrk ? dualResults.totalDRK : dualResults.totalPowerCup) || 0).toFixed(2)} ‚Ç¨/a√±o</td>
                                        </tr>
                                        <tr style="border-top: 2px solid ${isDrk ? '#bfdbfe' : '#d9f99d'};">
                                            <td style="padding: 8px 4px 4px 4px;">‚ö° Electricidad:</td>
                                            <td style="padding: 8px 4px 4px 4px; text-align: right; font-weight: bold;">${(electricitySupply?.totalAnnual || 0).toFixed(2)} ‚Ç¨</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 4px;">üî• Gas:</td>
                                            <td style="padding: 4px; text-align: right; font-weight: bold;">${(gasSupply?.totalAnnual || 0).toFixed(2)} ‚Ç¨</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <!-- Ahorro total -->
                                <div style="background-color: ${(dualResults.totalSavings || 0) > 0 ? '#D1FAE5' : '#FEE2E2'}; border: 3px solid ${(dualResults.totalSavings || 0) > 0 ? '#10B981' : '#EF4444'}; border-radius: 8px; padding: 16px;">
                                    <p style="color: ${(dualResults.totalSavings || 0) > 0 ? '#065F46' : '#991B1B'}; font-weight: bold; margin: 0 0 8px 0; font-size: 14px; text-align: center;">${(dualResults.totalSavings || 0) > 0 ? 'üéâ AHORRO TOTAL ANUAL' : '‚ö†Ô∏è DIFERENCIA ANUAL'}:</p>
                                    <p style="color: ${(dualResults.totalSavings || 0) > 0 ? '#065F46' : '#991B1B'}; font-size: 32px; font-weight: bold; text-align: center; margin: 0;">${(dualResults.totalSavings || 0).toFixed(2)} ‚Ç¨</p>
                                    <p style="color: ${(dualResults.totalSavings || 0) > 0 ? '#065F46' : '#991B1B'}; font-size: 14px; text-align: center; margin: 8px 0 0 0;">(${((dualResults.totalSavings || 0) / 12).toFixed(2)} ‚Ç¨/mes)</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Generar desglose COMPLETO de DUAL
                    let desgloseElectricidad = '';
                    if (electricitySupply) {
                        const eb = electricitySupply.electricityBreakdown;
                        const data = electricitySupply.data;
                        
                        // Extraer consumos de energyCosts array
                        let consumoP1 = 0, consumoP2 = 0, consumoP3 = 0;
                        let consumoTotal = 0;
                        
                        if (eb?.energyCosts && Array.isArray(eb.energyCosts)) {
                            eb.energyCosts.forEach(item => {
                                if (item.period === 1) consumoP1 = item.kwh || 0;
                                else if (item.period === 2) consumoP2 = item.kwh || 0;
                                else if (item.period === 3) consumoP3 = item.kwh || 0;
                                consumoTotal += item.kwh || 0;
                            });
                        }
                        
                        // Extraer potencias de powerCosts array
                        let potenciaP1 = 0, potenciaP2 = 0, potenciaP3 = 0;
                        let preciosPotencia = '';
                        
                        if (eb?.powerCosts && Array.isArray(eb.powerCosts)) {
                            eb.powerCosts.forEach(item => {
                                if (item.period === 1) potenciaP1 = item.kw || 0;
                                else if (item.period === 2) potenciaP2 = item.kw || 0;
                                else if (item.period === 3) potenciaP3 = item.kw || 0;
                            });
                            
                            // Extraer precios de potencia
                            preciosPotencia = 'PRECIOS POTENCIA:\n';
                            eb.powerCosts.forEach(item => {
                                if ((item.kw || 0) > 0 && item.priceDay) {
                                    preciosPotencia += `  P${item.period}: ${item.priceDay.toFixed(6)} ‚Ç¨/kW/d√≠a\n`;
                                }
                            });
                        }
                        
                        // Extraer precios de energ√≠a
                        let preciosEnergia = '';
                        if (eb?.energyCosts && Array.isArray(eb.energyCosts)) {
                            preciosEnergia = 'PRECIOS ENERG√çA:\n';
                            eb.energyCosts.forEach(item => {
                                if ((item.kwh || 0) > 0 && item.price) {
                                    preciosEnergia += `  P${item.period}: ${item.price.toFixed(6)} ‚Ç¨/kWh\n`;
                                }
                            });
                        }
                        
                        desgloseElectricidad = `=== ELECTRICIDAD ===
Tarifa: ${electricitySupply.tariff || 'N/A'}
CUPS: ${electricitySupply.cups || data?.cups || 'N/A'}
Periodo: ${eb?.dias || data?.dias_facturados || 'N/A'} d√≠as

CONSUMOS:
${consumoP1 > 0 ? `  P1: ${consumoP1.toFixed(0)} kWh` : ''}
${consumoP2 > 0 ? `  P2: ${consumoP2.toFixed(0)} kWh` : ''}
${consumoP3 > 0 ? `  P3: ${consumoP3.toFixed(0)} kWh` : ''}
  TOTAL ENERG√çA: ${consumoTotal.toFixed(0)} kWh

POTENCIAS CONTRATADAS:
${potenciaP1 > 0 ? `  P1: ${potenciaP1} kW` : ''}
${potenciaP2 > 0 ? `  P2: ${potenciaP2} kW` : ''}
${potenciaP3 > 0 ? `  P3: ${potenciaP3} kW` : ''}

${preciosPotencia}
${preciosEnergia}
COSTES PERIODO:
  Potencia: ${eb?.subPower?.toFixed(2) || '0.00'} ‚Ç¨
  Energ√≠a: ${eb?.subEnergy?.toFixed(2) || '0.00'} ‚Ç¨
  Impuesto el√©ctrico (5.113%): ${eb?.costIE?.toFixed(2) || '0.00'} ‚Ç¨
  IVA (21%): ${eb?.costIVA?.toFixed(2) || '0.00'} ‚Ç¨
  TOTAL PERIODO: ${eb?.totalPeriod?.toFixed(2) || '0.00'} ‚Ç¨

COSTES ANUALES:
  Factura actual anual: ${(electricitySupply.originalBillAnnual || 0).toFixed(2)} ‚Ç¨
  Con ${brandName} pagar√≠as: ${(electricitySupply.totalAnnual || 0).toFixed(2)} ‚Ç¨
  Ahorro anual: ${((electricitySupply.originalBillAnnual || 0) - (electricitySupply.totalAnnual || 0)).toFixed(2)} ‚Ç¨`;
                    }
                    
                    let desgloseGas = '';
                    if (gasSupply) {
                        const gData = gasSupply.data;
                        const gBreakdown = gasSupply.gasBreakdown; // Usar gasBreakdown en lugar de results
                        
                        desgloseGas = `
=== GAS ===
Tarifa: ${gasSupply.tariff || 'N/A'}
Periodo: ${gData?.dias || gBreakdown?.dias || 'N/A'} d√≠as
Consumo: ${gData?.kwh || gBreakdown?.kwh || 0} kWh

PRECIOS APLICADOS:
  T√©rmino fijo: ${(gBreakdown?.termino_fijo_diario || gasSupply?.offer?.p_fijo_diario || 0).toFixed(6)} ‚Ç¨/d√≠a
  Precio energ√≠a: ${(gasSupply?.offer?.p1_price || 0).toFixed(6)} ‚Ç¨/kWh

COSTES PERIODO:
  T√©rmino fijo: ${gBreakdown?.termino_fijo?.toFixed(2) || 'N/A'} ‚Ç¨
  Energ√≠a: ${gBreakdown?.energia?.toFixed(2) || 'N/A'} ‚Ç¨
  Impuesto hidrocarburos: ${gBreakdown?.impuesto_hidrocarburos?.toFixed(2) || 'N/A'} ‚Ç¨
  IVA (21%): ${gBreakdown?.iva?.toFixed(2) || 'N/A'} ‚Ç¨
  TOTAL PERIODO: ${gBreakdown?.total?.toFixed(2) || 'N/A'} ‚Ç¨

COSTES ANUALES:
  Factura actual anual: ${(gasSupply.originalBillAnnual || 0).toFixed(2)} ‚Ç¨
  Con ${brandName} pagar√≠as: ${(gasSupply.totalAnnual || 0).toFixed(2)} ‚Ç¨
  Ahorro anual: ${((gasSupply.originalBillAnnual || 0) - (gasSupply.totalAnnual || 0)).toFixed(2)} ‚Ç¨`;
                    }
                    
                    desglose = `TIPO DE SUMINISTRO: DUAL (ELECTRICIDAD + GAS)
MODO: ${brandName}

${desgloseElectricidad}
${desgloseGas}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
=== RESUMEN CONSOLIDADO ===
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Factura actual total anual: ${(dualResults.totalOriginalBill || 0).toFixed(2)} ‚Ç¨
Con ${brandName} pagar√≠as: ${(isDrk ? dualResults.totalDRK : dualResults.totalPowerCup).toFixed(2)} ‚Ç¨
Ahorro total anual: ${(dualResults.totalSavings || 0).toFixed(2)} ‚Ç¨

${(dualResults.totalSavings || 0) <= 0 ? 'IMPORTANTE: El cliente ya est√° en buenas tarifas tanto en electricidad como en gas.' : ''}

Desglose mensual estimado:
  Factura actual: ${(dualResults.totalOriginalBill / 12).toFixed(2)} ‚Ç¨/mes
  Con ${brandName}: ${((isDrk ? dualResults.totalDRK : dualResults.totalPowerCup) / 12).toFixed(2)} ‚Ç¨/mes
  Ahorro mensual: ${(dualResults.totalSavings / 12).toFixed(2)} ‚Ç¨/mes
`;
                
                // CASO 2: Datos de ELECTRICIDAD (prioridad sobre GAS - m√°s com√∫n)
                } else if (hasElectricityData && !hasDualData) {
                    console.log('‚úÖ Usando datos ELECTRICIDAD individual');
                    tipoSuministro = 'ELECTRICIDAD';
                    
                    // VALIDACI√ìN: Verificar que lastComparisonResult existe y tiene las propiedades necesarias
                    if (!lastComparisonResult || !lastComparisonResult.dias_facturados || !lastComparisonResult.energyCosts) {
                        console.error('‚ùå ERROR: lastComparisonResult incompleto', lastComparisonResult);
                        return window.showErrorModal(tr("Error: Los datos de ELECTRICIDAD no est√°n completos. Por favor, realice el c√°lculo de nuevo."));
                    }
                    
                    // Verificar si hay ahorro o no
                    const hasPositiveSavings = lastComparisonResult && lastComparisonResult.savings > 0;
                    
                    if (!hasPositiveSavings || lastComparisonResult.isNegativeSavings) {
                        // NO HAY AHORRO: Generar HTML especial
                        const brand = activeBrand;
                        const isDrk = brand.NAME.includes('DRK');
                        const brandColor = isDrk ? '#0ea5e9' : '#84cc16';
                        const brandName = isDrk ? 'DRK' : 'POWER CUP';
                        
                        htmlContent = `
                            <div style="font-family: Arial, sans-serif; max-width: 800px;">
                                <h2 style="color: ${brandColor}; text-align: center;">‚ö° RESULTADO COMPARATIVA ELECTRICIDAD</h2>
                                <div style="background-color: ${isDrk ? '#f0f9ff' : '#f7fee7'}; border: 3px solid ${brandColor}; border-radius: 12px; padding: 24px; margin: 20px 0;">
                                    <h3 style="color: ${brandColor}; text-align: center; font-size: 24px;"${tr("LA MEJOR OPCI√ìN PARA TI ES")}</h3>
                                    <h2 style="color: ${isDrk ? '#0c4a6e' : '#365314'}; text-align: center; font-size: 36px; margin: 16px 0;">Tu Tarifa Actual</h2>
                                    <p style="text-align: center; color: ${brandColor}; font-size: 18px;">Es la mejor opci√≥n detectada</p>
                                </div>
                                
                                <div style="background-color: white; border: 2px solid ${isDrk ? '#bfdbfe' : '#d9f99d'}; border-radius: 12px; padding: 20px; margin: 16px 0;">
                                    <h4 style="color: ${brandColor}; text-align: center; font-size: 20px;">¬°ENHORABUENA!</h4>
                                    <p style="text-align: center; color: ${isDrk ? '#0c4a6e' : '#365314'}; font-weight: bold;">Actualmente est√°s en una buena tarifa.</p>
                                    <p style="text-align: center; color: ${brandColor};">Seguiremos estudiando el mercado y te avisaremos cuando encontremos alguna tarifa que se adapte a tu perfil de consumo.</p>
                                </div>
                                
                                <div style="background-color: ${isDrk ? '#f0f9ff' : '#f7fee7'}; border-radius: 12px; padding: 16px; margin-top: 16px;">
                                    <h3 style="color: ${brandColor}; margin-bottom: 12px;">üìä TU COSTE ACTUAL CONSOLIDADO</h3>
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tr style="border-bottom: 1px solid ${isDrk ? '#bfdbfe' : '#d9f99d'};">
                                            <td style="padding: 8px; font-weight: bold;">Periodo analizado:</td>
                                            <td style="padding: 8px; text-align: right;">${lastComparisonResult.dias_facturados || 0} d√≠as</td>
                                        </tr>
                                        <tr style="border-bottom: 1px solid ${isDrk ? '#bfdbfe' : '#d9f99d'};">
                                            <td style="padding: 8px; font-weight: bold;"${tr("CUPS:")}</td>
                                            <td style="padding: 8px; text-align: right; font-family: monospace; font-size: 11px;">${lastComparisonResult.cups || 'N/A'}</td>
                                        </tr>
                                        <tr style="border-bottom: 1px solid ${isDrk ? '#bfdbfe' : '#d9f99d'};">
                                            <td style="padding: 8px; font-weight: bold;">Tipo de tarifa:</td>
                                            <td style="padding: 8px; text-align: right;">${lastComparisonResult.tariffType || 'N/A'}</td>
                                        </tr>
                                        <tr style="border-bottom: 2px solid ${brandColor};">
                                            <td style="padding: 8px; font-weight: bold;">Consumo total energ√≠a:</td>
                                            <td style="padding: 8px; text-align: right; font-weight: bold;">${lastComparisonResult.energyCosts ? lastComparisonResult.energyCosts.reduce((sum, e) => sum + e.kwh, 0).toFixed(0) : 0} kWh</td>
                                        </tr>
                                        <tr style="background-color: ${isDrk ? '#dbeafe' : '#ecfccb'};">
                                            <td style="padding: 12px; font-size: 18px; font-weight: bold; color: ${isDrk ? '#0c4a6e' : '#365314'};">Total periodo:</td>
                                            <td style="padding: 12px; font-size: 24px; text-align: right; color: ${isDrk ? '#0c4a6e' : '#365314'}; font-weight: bold;">${(lastComparisonResult.importe_total || 0).toFixed(2)} ‚Ç¨</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 12px; font-size: 16px; font-weight: bold; color: ${isDrk ? '#0c4a6e' : '#365314'};">Estimaci√≥n anual:</td>
                                            <td style="padding: 12px; font-size: 20px; text-align: right; color: ${isDrk ? '#0c4a6e' : '#365314'}; font-weight: bold;">${(lastComparisonResult.originalBillAnnual || 0).toFixed(2)} ‚Ç¨/a√±o</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        `;
                    } else {
                        // S√ç HAY AHORRO: Usar funciones existentes
                        if (lastIndexedResult && compareWithIndexed) {
                            if (lastComparisonResult.isMultiCups) {
                                htmlContent = generateMultiDualStyledHtmlOffer(commercialCode);
                            } else {
                                htmlContent = generateDualStyledHtmlOffer(commercialCode, lastComparisonResult, lastIndexedResult);
                            }
                        } else {
                            if (lastComparisonResult.isMulti) {
                                htmlContent = generateMultiStyledHtmlOffer(commercialCode);
                            } else {
                                htmlContent = generateStyledHtmlOffer(commercialCode);
                            }
                        }
                    }
                    
                    // 2. Generar desglose detallado de c√°lculos
                    desglose = generateCalculationBreakdown(lastComparisonResult);
                }
                
                // 3. Preparar el contenido del email (MUY CORTO para evitar l√≠mites de mailto)
                const emailSubject = `Solicitud Mejora ${tipoSuministro} - ${clientName || 'Cliente'} - ${cups || 'Sin CUPS'}`;
                
                const emailBody = `SOLICITUD DE MEJORA - ${tipoSuministro}

Comercial: ${commercialCode}
Cliente: ${clientName || 'No proporcionado'}
CUPS: ${cups || 'No proporcionado'}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚ö†Ô∏è INSTRUCCIONES IMPORTANTES:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

1. PEGAR contenido completo (Ctrl+V) debajo de este texto
   ‚Üí El contenido est√° copiado en el portapapeles

2. ADJUNTAR facturas OBLIGATORIAS:
   üìÑ Factura usada para el estudio
   üìÑ Factura m√°s actualizada del cliente

3. ENVIAR email

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

[PEGAR AQU√ç EL CONTENIDO COMPLETO CON CTRL+V]

`;

                // 4. Crear mailto con m√∫ltiples destinatarios (LIMITADO para evitar cortes)
                const recipients = 'F.araujo@drk.es,rguerra@drk.es,l.grande@drk.es';
                const mailtoLink = `mailto:${recipients}?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody.substring(0, 900))}`;
                
                // 5. Copiar HTML completo al portapapeles para pegar en el email
                const tempElement = document.createElement('div');
                tempElement.contentEditable = true;
                tempElement.innerHTML = `
                    <div style="font-family: Arial, sans-serif;">
                        <h2 style="color: #E50000;">SOLICITUD DE MEJORA DE COMPARATIVO - ${tipoSuministro}</h2>
                        <p><strong>El comercial ${commercialCode} solicita una mejora de este comparativo.</strong></p>
                        
                        <div style="background-color: #E0F2FE; border-left: 4px solid #0EA5E9; padding: 12px; margin: 16px 0;">
                            <p style="margin: 0; font-weight: bold;">üìã TIPO DE SUMINISTRO: ${tipoSuministro}</p>
                        </div>
                        
                        <h3>DATOS DEL CLIENTE:</h3>
                        <ul>
                            <li><strong>Nombre:</strong> ${clientName || 'No proporcionado'}</li>
                            <li><strong${tr("CUPS:")}</strong> ${cups || 'No proporcionado'}</li>
                            <li><strong>Tel√©fono:</strong> ${phone || 'No proporcionado'}</li>
                            <li><strong>Email:</strong> ${email || 'No proporcionado'}</li>
                            ${observations ? `<li><strong>Observaciones:</strong> ${observations}</li>` : ''}
                        </ul>
                        
                        <div style="background-color: #FEF3C7; border: 2px solid #F59E0B; border-radius: 8px; padding: 16px; margin: 20px 0;">
                            <h3 style="margin: 0 0 12px 0; color: #92400E; font-size: 18px;">‚ö†Ô∏è IMPORTANTE - FACTURAS A ADJUNTAR:</h3>
                            <div style="background-color: white; padding: 12px; border-radius: 6px; margin-bottom: 8px;">
                                <p style="margin: 0; font-weight: bold; color: #92400E;">üìÑ 1. La factura UTILIZADA para realizar este estudio</p>
                                <p style="margin: 4px 0 0 0; font-size: 13px; color: #78350F;">Esta es la factura que el comercial ha analizado para hacer la comparativa</p>
                            </div>
                            <div style="background-color: white; padding: 12px; border-radius: 6px;">
                                <p style="margin: 0; font-weight: bold; color: #92400E;">üìÑ 2. La factura M√ÅS ACTUALIZADA del cliente</p>
                                <p style="margin: 4px 0 0 0; font-size: 13px; color: #78350F;">Si es la misma factura que la del estudio, adjuntar solo una vez</p>
                            </div>
                            <p style="margin: 12px 0 0 0; font-size: 12px; color: #92400E; font-style: italic;">
                                ‚ÑπÔ∏è Estas facturas son necesarias para que Back Office pueda verificar los datos y mejorar el comparativo
                            </p>
                        </div>
                        
                        <hr style="margin: 24px 0;">
                        
                        <h3>COMPARATIVO:</h3>
                        ${htmlContent}
                        
                        <hr style="margin: 24px 0;">
                        
                        <h3>DESGLOSE DETALLADO DE C√ÅLCULOS:</h3>
                        <pre style="background-color: #f5f5f5; padding: 16px; border-radius: 8px; overflow-x: auto; font-size: 12px;">${desglose}</pre>
                    </div>
                `;
                tempElement.style.position = 'fixed';
                tempElement.style.left = '-9999px';
                document.body.appendChild(tempElement);
                
                const range = document.createRange();
                range.selectNodeContents(tempElement);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                
                const success = document.execCommand('copy');
                document.body.removeChild(tempElement);
                
                // 6. Abrir cliente de correo
                window.location.href = mailtoLink;
                
                // 7. Mostrar mensaje de √©xito
                if (success) {
                    window.showMessageModal(`‚úÖ ¬°LISTO! Email abierto y contenido copiado.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìã PASOS PARA ENVIAR LA SOLICITUD:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

1Ô∏è‚É£ En el email que se acaba de abrir:
   ‚Üí Coloque el cursor debajo de "[PEGAR AQU√ç...]"
   ‚Üí Presione Ctrl+V (o Cmd+V en Mac)
   ‚Üí Se pegar√° TODO el comparativo completo

2Ô∏è‚É£ ADJUNTE LAS FACTURAS (OBLIGATORIO):
   üìÑ Factura usada para hacer el estudio
   üìÑ Factura m√°s actualizada del cliente
   (Si son la misma, adjuntar solo una vez)

3Ô∏è‚É£ Revise que todo est√© correcto y ENV√çE

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Destinatarios: F.araujo@drk.es, rguerra@drk.es, l.grande@drk.es

‚ö†Ô∏è IMPORTANTE: Sin las facturas adjuntas, Back Office NO podr√° procesar la solicitud.`);
                    
                    // Cerrar modal
                    document.getElementById('request-improvement-modal').classList.add('hidden');
                    document.getElementById('request-improvement-modal').classList.remove('flex');
                    
                    // Limpiar campos
                    document.getElementById('improvement-comercial-code').value = '';
                    document.getElementById('improvement-client-name').value = '';
                    document.getElementById('improvement-client-cups').value = '';
                    document.getElementById('improvement-client-phone').value = '';
                    document.getElementById('improvement-client-email').value = '';
                    document.getElementById('improvement-observations').value = '';
                } else {
                    window.showErrorModal("No se pudo copiar el contenido. Por favor, contacte a soporte.");
                }
                
            } catch (error) {
                console.error('Error en handleRequestImprovement:', error);
                window.showErrorModal(`Error al preparar la solicitud: ${error.message}`);
            }
        }
        
        // Funci√≥n auxiliar para generar desglose de c√°lculos
        function generateCalculationBreakdown(result) {
            let breakdown = '';
            
            breakdown += `TIPO: ${result.tariffType || 'N/A'}\n`;
            breakdown += `CUPS: ${result.cups || 'N/A'}\n`;
            breakdown += `D√çAS: ${result.dias_facturados || result.days || 'N/A'}\n\n`;
            
            breakdown += `COSTES DE POTENCIA:\n`;
            if (result.powerCosts && Array.isArray(result.powerCosts)) {
                result.powerCosts.forEach(item => {
                    if (item.kw > 0) {
                        breakdown += `  P${item.period}: ${(item.cost || 0).toFixed(2)} ‚Ç¨ (${item.kw} kW x ${(item.priceDay || 0).toFixed(6)} ‚Ç¨/d√≠a)\n`;
                    }
                });
                breakdown += `  TOTAL POTENCIA: ${(result.subPower || 0).toFixed(2)} ‚Ç¨\n\n`;
            }
            
            breakdown += `COSTES DE ENERG√çA:\n`;
            if (result.energyCosts && Array.isArray(result.energyCosts)) {
                result.energyCosts.forEach(item => {
                    if (item.kwh > 0) {
                        breakdown += `  E${item.period}: ${(item.cost || 0).toFixed(2)} ‚Ç¨ (${item.kwh} kWh x ${(item.price || 0).toFixed(6)} ‚Ç¨/kWh)\n`;
                    }
                });
                breakdown += `  TOTAL ENERG√çA: ${(result.subEnergyNet || 0).toFixed(2)} ‚Ç¨\n\n`;
            }
            
            breakdown += `IMPUESTOS Y OTROS:\n`;
            breakdown += `  Impuesto El√©ctrico: ${(result.elec_tax || 0).toFixed(2)} ‚Ç¨\n`;
            breakdown += `  IVA: ${(result.vat || 0).toFixed(2)} ‚Ç¨\n`;
            breakdown += `  Alquiler Contador: ${(result.rental || 0).toFixed(2)} ‚Ç¨\n\n`;
            
            breakdown += `TOTALES:\n`;
            breakdown += `  Subtotal: ${(result.subtotal || 0).toFixed(2)} ‚Ç¨\n`;
            breakdown += `  TOTAL PERIODO: ${(result.importe_total || 0).toFixed(2)} ‚Ç¨\n`;
            breakdown += `  TOTAL ANUAL: ${(result.totalAnnual || result.originalBillAnnual || 0).toFixed(2)} ‚Ç¨\n`;
            breakdown += `  AHORRO: ${(result.savings || 0).toFixed(2)} ‚Ç¨\n`;
            
            return breakdown;
        }

        
        // --- GENERACI√ìN DE PDF PROFESIONAL COMPLETO ---
        
        async function handleGeneratePDF() {
            // NUEVO: Mostrar advertencia si el idioma es chino
            if (window.showChinesePDFWarning && !window.showChinesePDFWarning()) {
                return; // Usuario cancel√≥
            }
            
            console.log('handleGeneratePDF llamada', {
                lastComparisonResult: lastComparisonResult,
                lastIndexedResult: lastIndexedResult,
                compareWithIndexed: compareWithIndexed
            });
            
            if (!lastComparisonResult) {
                console.error('ERROR: lastComparisonResult es null o undefined');
                return window.showErrorModal("Primero realice una comparaci√≥n.");
            }
            
            const commercialCode = document.getElementById('comercial-code-input').value.trim();
            const clientName = document.getElementById('client-name-input').value.trim() || '[NOMBRE COMPLETO CLIENTE]';
            const clientPhone = document.getElementById('client-phone-input').value.trim();
            const clientEmail = document.getElementById('client-email-input').value.trim();
            
            if (!commercialCode) return window.showErrorModal("Indique el C√≥digo Comercial.");
            
            // IMPORTANTE: Detectar si hay resultado indexado para generar PDF dual
            // Puede estar en lastIndexedResult (individual) o en indexedTotals (MULTICUPS)
            const hasIndexedData = (lastIndexedResult && compareWithIndexed) || 
                                    (lastComparisonResult.isMultiCups && lastComparisonResult.indexedTotals);
            
            console.log('üîç hasIndexedData:', hasIndexedData);
            console.log('üîç lastIndexedResult:', lastIndexedResult);
            console.log('üîç indexedTotals:', lastComparisonResult.indexedTotals);
            
            if (hasIndexedData) {
                // Si hay resultado indexado, generar PDF dual
                if (lastComparisonResult.isMultiCups) {
                    // MULTICUPS con √≠ndice
                    console.log('‚úÖ Generando PDF MULTICUPS DUAL');
                    await generateMultiPDF_Dual(lastComparisonResult);
                } else {
                    // Individual con √≠ndice
                    console.log('‚úÖ Generando PDF INDIVIDUAL DUAL');
                    await generatePDF_Dual(lastComparisonResult, lastIndexedResult);
                }
                
                // Cerrar modal
                document.getElementById('send-offer-modal').classList.add('hidden');
                document.getElementById('send-offer-modal').classList.remove('flex');
                return;
            }
            
            try {
                // Mostrar mensaje de carga
                window.showMessageModal("‚è≥ Generando PDF profesional... Por favor espere.");
                
                // Importar jsPDF
                const { jsPDF } = window.jspdf;
                let doc = new jsPDF('p', 'mm', 'a4');
                
                // CR√çTICO: Activar traducci√≥n autom√°tica de textos
                if (window.setupPDFTranslation) {
                    doc = window.setupPDFTranslation(doc);
                }
                
                const brand = activeBrand;
                const res = lastComparisonResult;
                const offer = res.offer;
                const isDrk = brand.NAME.includes('DRK');
                const tariffType = res.originalTariffType || currentTariffType;
                const config = TARIFF_CONFIG[tariffType];
                
                // Colores corporativos
                const primaryColor = isDrk ? [90, 120, 145] : [130, 145, 100]; // DRK: azul gris√°ceo | POWER: verde oliva claro
                const darkColor = isDrk ? [107, 125, 142] : [115, 130, 95]; // DRK: gris azulado | POWER: verde oliva oscuro
                const lightBg = isDrk ? [240, 245, 250] : [245, 248, 240];
                const greenColor = [22, 163, 74];
                const redColor = [220, 38, 38];
                const grayBg = [245, 245, 245];
                
                let yPos = 0;
                const pageWidth = 210;
                const margin = 15;
                const contentWidth = pageWidth - (2 * margin);
                
                // === NUEVA CABECERA CON DEGRADADO HORIZONTAL Y LOGO ===
                // Fondo con degradado de oscuro a claro (izquierda a derecha)
                const headerHeight = 45;
                for (let i = 0; i < pageWidth; i++) {
                    const ratio = i / pageWidth;
                    // De azul oscuro a azul claro/blanco
                    const r = Math.round(darkColor[0] + (240 - darkColor[0]) * ratio);
                    const g = Math.round(darkColor[1] + (245 - darkColor[1]) * ratio);
                    const b = Math.round(darkColor[2] + (250 - darkColor[2]) * ratio);
                    doc.setFillColor(r, g, b);
                    doc.rect(i, 0, 1, headerHeight, 'F');
                }
                
                // Logo seg√∫n marca
                const logoX = margin + 8;
                const logoY = 15;
                const logoRadius = 6;
                
                if (isDrk) {
                    // Logo circular DRK (anillo multicolor)
                    doc.setFillColor(219, 68, 55); // Rojo
                    doc.circle(logoX - 1, logoY + 1, logoRadius * 0.8, 'F');
                    doc.setFillColor(66, 133, 244); // Azul
                    doc.circle(logoX + 1, logoY - 1, logoRadius * 0.8, 'F');
                    doc.setFillColor(244, 180, 0); // Amarillo
                    doc.circle(logoX - 1, logoY - 1, logoRadius * 0.7, 'F');
                    doc.setFillColor(15, 157, 88); // Verde
                    doc.circle(logoX + 1, logoY + 1, logoRadius * 0.7, 'F');
                    
                    // C√≠rculo central blanco
                    doc.setFillColor(255, 255, 255);
                    doc.circle(logoX, logoY, logoRadius * 0.4, 'F');
                } else {
                    // Logo POWER CUP (taza con niveles de energ√≠a y rayo)
                    
                    // Plato/base (verde oscuro)
                    doc.setFillColor(60, 90, 50);
                    doc.rect(logoX - 5, logoY + 4, 10, 1, 'F');
                    
                    // Borde de la taza (verde oscuro)
                    doc.setDrawColor(60, 90, 50);
                    doc.setLineWidth(1.2);
                    doc.roundedRect(logoX - 3.5, logoY - 2, 7, 6, 0.5, 0.5, 'S');
                    
                    // Asa de la taza (usando l√≠nea curva)
                    doc.setLineWidth(1);
                    doc.line(logoX + 3.5, logoY, logoX + 5, logoY - 0.5);
                    doc.line(logoX + 5, logoY - 0.5, logoX + 5.5, logoY + 1);
                    doc.line(logoX + 5.5, logoY + 1, logoX + 5, logoY + 2.5);
                    doc.line(logoX + 5, logoY + 2.5, logoX + 3.5, logoY + 2);
                    
                    // Niveles de energ√≠a dentro de la taza (l√≠neas verdes horizontales)
                    doc.setFillColor(100, 150, 70);
                    doc.rect(logoX - 3, logoY + 2.5, 6, 0.8, 'F');  // Nivel 1
                    doc.rect(logoX - 3, logoY + 0.8, 6, 0.8, 'F');  // Nivel 2
                    doc.rect(logoX - 3, logoY - 0.9, 6, 0.8, 'F');  // Nivel 3
                    
                    // Rayo amarillo encima de la taza
                    doc.setFillColor(255, 200, 0);
                    const rayX = logoX;
                    const rayY = logoY - 7;
                    // Parte superior del rayo
                    doc.triangle(rayX - 1, rayY, rayX - 2, rayY + 2.5, rayX, rayY + 2, 'F');
                    // Parte inferior del rayo
                    doc.triangle(rayX, rayY + 2, rayX - 1, rayY + 4.5, rayX + 1.5, rayY + 4.5, 'F');
                }
                
                yPos = 12;
                
                // Texto "DRK ENERG√çA" a la derecha del logo
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                const brandText = isDrk ? 'DRK' : 'POWER CUP';
                doc.text(brandText, logoX + 12, yPos + 3);
                
                // "ENERG√çA" debajo
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text('ENERG√çA', logoX + 12, yPos + 11);
                
                // Tagline
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(200, 220, 240);
                doc.text(tr('Liderando el ahorro y la'), logoX + 12, yPos + 19);
                doc.text(tr('eficiencia energ√©tica.'), logoX + 12, yPos + 24);
                
                // Texto derecha "ESTUDIO DE AHORRO COMPARATIVA PROFESIONAL"
                doc.setTextColor(40, 60, 80);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('ESTUDIO DE AHORRO'), pageWidth - margin - 3, yPos + 5, { align: 'right' });
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('COMPARATIVA', pageWidth - margin - 3, yPos + 13, { align: 'right' });
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(100, 120, 140);
                doc.text('PROFESIONAL', pageWidth - margin - 3, yPos + 21, { align: 'right' });
                
                yPos = 50;
                
                // === INFORMACI√ìN DEL CLIENTE (REDISE√ëADA) ===
                // Barra superior verde
                doc.setFillColor(...greenColor); // VERDE
                doc.roundedRect(margin, yPos, contentWidth, 8, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('ESTUDIO DE AHORRO'), margin + 5, yPos + 5.5);
                
                // Caja blanca con borde azul
                doc.setFillColor(255, 255, 255);
                doc.setDrawColor(...darkColor);
                doc.setLineWidth(1);
                doc.roundedRect(margin, yPos + 8, contentWidth, 20, 3, 3, 'FD');
                
                doc.setTextColor(...darkColor);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text(`COMPARATIVA PROFESIONAL - ${isDrk ? 'DRK' : 'POWER CUP'}`, margin + 5, yPos + 14);
                
                doc.setTextColor(80, 80, 80);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text(`CLIENTE: ${clientName}`, margin + 5, yPos + 20);
                if (!res.isMulti) {
                    doc.text(`CUPS: ${res.cups}`, margin + 5, yPos + 25);
                } else {
                    doc.text(`CUPS TOTALES: ${res.individualResults.length}`, margin + 5, yPos + 25);
                }
                
                // Comercial en caja destacada
                doc.setFillColor(...lightBg);
                doc.roundedRect(pageWidth - margin - 45, yPos + 17, 45, 8, 2, 2, 'F');
                doc.setTextColor(...darkColor);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(8);
                doc.text(`COMERCIAL: ${commercialCode}`, pageWidth - margin - 43, yPos + 22.5);
                
                yPos += 35;
                
                // Definir savingsText para usarlo en la seccion comun al final
                const savingsText = res.savings > 0 ? eur(res.savings) : '0,00 ‚Ç¨';
                
                // Funcion auxiliar para nueva pagina (disponible para todos)
                const checkNewPage = function(neededSpace) {
                    if (yPos + neededSpace > 270) {
                        doc.addPage();
                        yPos = 20;
                        return true;
                    }
                    return false;
                };
                
                // ================================================================
                // BIFURCACION: Si es MultiCups, generar PDF especial MultiCups
                // ================================================================
                
                if (res.isMulti && res.individualResults && res.individualResults.length > 0) {
                    // === INICIO MULTICUPS - DISE√ëO COMPACTO TIPO TARJETA ===
                    
                    // === CABECERA AZUL (M√ÅS PEQUE√ëA) ===
                    doc.setFillColor(...primaryColor);
                    doc.roundedRect(margin, yPos, contentWidth, 32, 4, 4, 'F');
                    
                    // "LA MEJOR OPCI√ìN PARA TI ES"
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('LA MEJOR OPCI√ìN PARA TI ES'), pageWidth / 2, yPos + 8, { align: 'center' });
                    
                    // Marca o Tarifa
                    const brandNameMulti = isDrk ? 'DRK' : 'POWER CUP';
                    // Usar description si est√° disponible, sino name
                    const displayOfferName = (offer.description && offer.description !== 'N/A') ? offer.description : offer.name;
                    
                    if (!isDrk) {
                        // POWER CUP MultiCups: Solo mostrar "POWER CUP" (puede haber m√∫ltiples tarifas)
                        doc.setFontSize(32);
                        doc.setFont('helvetica', 'bold');
                        doc.text('POWER CUP', pageWidth / 2, yPos + 20, { align: 'center' });
                    } else {
                        // DRK: Mostrar DRK y nombre de tarifa
                        doc.setFontSize(26);
                        doc.setFont('helvetica', 'bold');
                        doc.text('DRK', pageWidth / 2, yPos + 18, { align: 'center' });
                        
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'normal');
                        doc.text(displayOfferName, pageWidth / 2, yPos + 27, { align: 'center' });
                    }
                    
                    yPos += 37;
                    
                    // === CAJA BLANCA COMPACTA ===
                    doc.setFillColor(255, 255, 255);
                    doc.setDrawColor(220, 220, 220);
                    doc.setLineWidth(0.3);
                    const boxHeight = res.savings > 0 ? 75 : 65; // Altura ajustada para mensaje
                    doc.roundedRect(margin, yPos, contentWidth, boxHeight, 4, 4, 'FD');
                    
                    if (res.savings > 0) {
                        // Ahorro positivo - dise√±o normal
                        doc.setTextColor(120, 120, 140);
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text(tr('TU AHORRO ANUAL ESTIMADO'), pageWidth / 2, yPos + 8, { align: 'center' });
                        
                        // Cifra de ahorro en VERDE (grande pero ajustado)
                        doc.setTextColor(...greenColor);
                        doc.setFontSize(32);
                        doc.setFont('helvetica', 'bold');
                        doc.text(savingsText, pageWidth / 2, yPos + 25, { align: 'center' });
                        
                        yPos += 32;
                    } else {
                        // Sin ahorro - mensaje grande centrado
                        doc.setTextColor(...primaryColor);
                        doc.setFontSize(16);
                        doc.setFont('helvetica', 'bold');
                        doc.text('¬°ENHORABUENA!', pageWidth / 2, yPos + 12, { align: 'center' });
                        
                        doc.setTextColor(60, 60, 60);
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Actualmente est√°s en una buena tarifa.', pageWidth / 2, yPos + 25, { align: 'center' });
                        
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'normal');
                        doc.text('Seguiremos estudiando el mercado y te avisaremos cuando', pageWidth / 2, yPos + 38, { align: 'center' });
                        doc.text('encontremos alguna tarifa que se adapte a tu perfil de consumo.', pageWidth / 2, yPos + 45, { align: 'center' });
                        
                        yPos += 67;
                        // Saltar la secci√≥n de precios - no mostrarlos
                        yPos += 50;
                    }
                    
                    // === DOS COLUMNAS COMPACTAS === (Solo si hay ahorro)
                    if (res.savings > 0) {
                    const colWidthMulti = (contentWidth - 20) / 2;
                    
                    // COLUMNA IZQUIERDA - TU FACTURA ACTUAL
                    const leftXMulti = margin + 10;
                    
                    doc.setTextColor(140, 150, 160);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('TU FACTURA ACTUAL'), leftXMulti + colWidthMulti / 2, yPos, { align: 'center' });
                    
                    // Precio mensual tachado en rojo
                    const oldPriceMulti = `${eur(res.originalBillAnnual / 12)}${tr('/mes')}`;
                    doc.setTextColor(...redColor);
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    const oldXMulti = leftXMulti + colWidthMulti / 2;
                    const oldYMulti = yPos + 12;
                    doc.text(oldPriceMulti, oldXMulti, oldYMulti, { align: 'center' });
                    
                    // L√≠nea tachada
                    const oldWidthMulti = doc.getTextWidth(oldPriceMulti);
                    doc.setDrawColor(...redColor);
                    doc.setLineWidth(1.5);
                    doc.line(oldXMulti - oldWidthMulti/2 - 2, oldYMulti - 3, oldXMulti + oldWidthMulti/2 + 2, oldYMulti - 3);
                    
                    // "Total Periodo (Variado)"
                    doc.setTextColor(140, 150, 160);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`${tr('Total Periodo')} (${tr('Variado')})`, leftXMulti + colWidthMulti / 2, yPos + 19, { align: 'center' });
                    
                    // Precio anual tachado
                    const oldAnnualMulti = eur(res.originalBillAnnual);
                    doc.setTextColor(...redColor);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    const oldAnnualXMulti = leftXMulti + colWidthMulti / 2;
                    const oldAnnualYMulti = yPos + 32;
                    doc.text(`${oldAnnualMulti}${tr('/a√±o')}`, oldAnnualXMulti, oldAnnualYMulti, { align: 'center' });
                    
                    // L√≠nea tachada
                    const oldAnnualWidthMulti = doc.getTextWidth(`${oldAnnualMulti}${tr('/a√±o')}`);
                    doc.setDrawColor(...redColor);
                    doc.setLineWidth(1.5);
                    doc.line(oldAnnualXMulti - oldAnnualWidthMulti/2 - 2, oldAnnualYMulti - 3, oldAnnualXMulti + oldAnnualWidthMulti/2 + 2, oldAnnualYMulti - 3);
                    
                    // SEPARADOR VERTICAL
                    doc.setDrawColor(220, 220, 220);
                    doc.setLineWidth(0.3);
                    doc.line(pageWidth / 2, yPos - 5, pageWidth / 2, yPos + 38);
                    
                    // COLUMNA DERECHA - TU NUEVO COSTE
                    const rightXMulti = margin + 10 + colWidthMulti + 10;
                    
                    doc.setTextColor(...primaryColor);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    const newLabelMulti = `TU NUEVO COSTE ${brandNameMulti}`;
                    doc.text(newLabelMulti, rightXMulti + colWidthMulti / 2, yPos, { align: 'center' });
                    
                    // Precio mensual en azul
                    doc.setTextColor(...primaryColor);
                    doc.setFontSize(20);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${eur(res.totalAnnual / 12)}${tr('/mes')}`, rightXMulti + colWidthMulti / 2, yPos + 13, { align: 'center' });
                    
                    // "Estimado Mensual"
                    doc.setTextColor(140, 150, 160);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'normal');
                    doc.text(tr('Estimado Mensual'), rightXMulti + colWidthMulti / 2, yPos + 19, { align: 'center' });
                    
                    // Precio anual en azul
                    doc.setTextColor(...primaryColor);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${eur(res.totalAnnual)}${tr('/a√±o')}`, rightXMulti + colWidthMulti / 2, yPos + 32, { align: 'center' });
                    
                    yPos += 50;
                    } // Fin del condicional de columnas de precios
                    
                    // === RESUMEN DE SUMINISTROS (DISE√ëO MEJORADO) ===
                    checkNewPage(50);
                    
                    // Titulo resumen (verde)
                    doc.setFillColor(...greenColor); // VERDE
                    doc.roundedRect(margin, yPos, contentWidth, 10, 3, 3, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    // Construir texto traducible
                    const resumenText = `${tr('RESUMEN DE')} ${res.individualResults.length} ${tr('SUMINISTROS')}`;
                    doc.text(resumenText, margin + 3, yPos + 6.5);
                    yPos += 14;
                    
                    // Cabecera tabla (azul oscuro con texto blanco)
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.setFillColor(...darkColor);
                    doc.roundedRect(margin, yPos, contentWidth, 7, 2, 2, 'F');
                    doc.text('N¬∫', margin + 2, yPos + 5);
                    doc.text('CUPS', margin + 12, yPos + 5);
                    doc.text('TIPO', margin + 95, yPos + 5);
                    doc.text('D√çAS', margin + 115, yPos + 5);
                    doc.text('AHORRO', pageWidth - margin - 28, yPos + 5);
                    yPos += 7;
                    
                    // Filas (alternadas con borde sutil)
                    doc.setFont('helvetica', 'normal');
                    res.individualResults.forEach((supply, idx) => {
                        checkNewPage(8);
                        
                        // Fondo alternado
                        if (idx % 2 === 0) {
                            doc.setFillColor(248, 250, 252); // Azul muy claro
                            doc.rect(margin, yPos, contentWidth, 7, 'F');
                        }
                        
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(8);
                        doc.text(`[${idx + 1}]`, margin + 2, yPos + 4.5);
                        doc.setFontSize(7);
                        doc.text(supply.cups.substring(0, 18) + '...', margin + 12, yPos + 4.5);
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'bold');
                        doc.text(supply.originalTariffType, margin + 95, yPos + 4.5);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`${supply.dias_facturados}`, margin + 118, yPos + 4.5, { align: 'center' });
                        
                        const savSupply = supply.isNegativeSavings ? '0,00 ‚Ç¨' : eur(supply.savings);
                        const colorSupply = supply.isNegativeSavings ? [150, 150, 150] : greenColor;
                        doc.setTextColor(...colorSupply);
                        doc.setFont('helvetica', 'bold');
                        doc.text(savSupply, pageWidth - margin - 2, yPos + 4.5, { align: 'right' });
                        yPos += 7;
                    });
                    
                    yPos += 10;
                    
                    // === NUEVA P√ÅGINA PARA DESGLOSE DETALLADO ===
                    doc.addPage();
                    yPos = 20;
                    
                    // T√≠tulo desglose detallado (en p√°gina 2) - VERDE
                    doc.setFillColor(...greenColor); // VERDE
                    doc.roundedRect(margin, yPos, contentWidth, 10, 3, 3, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text('DESGLOSE DETALLADO POR SUMINISTRO', margin + 3, yPos + 6.5);
                    yPos += 14;
                    
                    // Funci√≥n auxiliar para generar desglose en MULTICUPS (estilo dual)
                    function generarDesgloseMultiCups(supply, supplyIndexed, x, width, esColumnaIzq) {
                        const res = esColumnaIzq ? supply : supplyIndexed;
                        if (!res || !res.powerCosts || !res.energyCosts) {
                            console.error('ERROR: res no tiene la estructura necesaria', res);
                            return;
                        }
                        
                        let y = yPos;
                        
                        // === CABECERA GRIS OSCURA CON CUPS ===
                        doc.setFillColor(71, 85, 105);
                        doc.roundedRect(x, y, width, 14, 2, 2, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`[${res.cups || 'N/A'}]`, x + 3, y + 4);
                        doc.text(`Tipo: ${res.originalTariffType || ''}`, x + width - 3, y + 4, { align: 'right' });
                        doc.text(`D√≠as: ${res.dias_facturados || 0}`, x + width - 3, y + 8, { align: 'right' });
                        
                        // Nombre completo: Comercializadora - Tarifa
                        doc.setFontSize(6.5);
                        doc.setFont('helvetica', 'normal');
                        const comercializadora = res.offer.name || brand.NAME;
                        const nombreTarifa = res.offer.description || 'N/A';
                        const nombreCompleto = `${comercializadora} - ${nombreTarifa}`;
                        doc.text(nombreCompleto, x + 3, y + 11);
                        
                        y += 16;
                        
                        // === CAJA PRECIOS APLICADOS ===
                        doc.setFillColor(100, 116, 139);
                        doc.roundedRect(x, y, width, 8, 2, 2, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'bold');
                        doc.text('PRECIOS APLICADOS:', x + 3, y + 6);
                        y += 10;
                        
                        // Info de precios (Potencia y Energ√≠a)
                        doc.setFillColor(100, 116, 139);
                        doc.roundedRect(x, y, width, 16, 2, 2, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(6);
                        doc.setFont('helvetica', 'bold');
                        doc.text(tr('POTENCIA:'), x + 3, y + 4);
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(5.5);
                        
                        // Mostrar precios de potencia reales
                        if (res.powerCosts.length > 0) {
                            doc.text(`P1: ${num(res.powerCosts[0].priceDay || 0, 6)} ‚Ç¨/kW/d√≠a`, x + 3, y + 8);
                        }
                        if (res.powerCosts.length > 1) {
                            doc.text(`P2: ${num(res.powerCosts[1].priceDay || 0, 6)} ‚Ç¨/kW/d√≠a`, x + 3, y + 11);
                        }
                        
                        doc.setFont('helvetica', 'bold');
                        doc.setFontSize(6);
                        doc.text('ENERG√çA:', x + width/2, y + 4);
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(5.5);
                        
                        // Mostrar precios de energ√≠a reales
                        if (res.energyCosts.length > 0) {
                            doc.text(`E1: ${num(res.energyCosts[0].price || 0, 6)} ‚Ç¨/kWh`, x + width/2, y + 8);
                        }
                        if (res.energyCosts.length > 1) {
                            doc.text(`E2: ${num(res.energyCosts[1].price || 0, 6)} ‚Ç¨/kWh`, x + width/2, y + 11);
                        }
                        if (res.energyCosts.length > 2) {
                            doc.text(`E3: ${num(res.energyCosts[2].price || 0, 6)} ‚Ç¨/kWh`, x + width/2, y + 14);
                        }
                        y += 20;
                        
                        // === SECCI√ìN POTENCIA ===
                        doc.setFillColor(100, 116, 139);
                        doc.roundedRect(x, y, width, 7, 2, 2, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'bold');
                        doc.text('POTENCIA', x + 3, y + 5);
                        y += 9;
                        
                        // Desglose potencia
                        doc.setTextColor(55, 65, 81);
                        doc.setFontSize(6);
                        doc.setFont('helvetica', 'normal');
                        res.powerCosts.forEach((p, i) => {
                            if (p.kw > 0) {
                                const texto = `P${i+1}: (${num(p.kw, 2)} kW x ${num(p.priceDay, 6)} ‚Ç¨/kW/d√≠a)`;
                                doc.text(texto, x + 3, y);
                                doc.text(eur(p.cost), x + width - 3, y, { align: 'right' });
                                y += 4;
                            }
                        });
                        y += 2;
                        
                        // === SECCI√ìN ENERG√çA ===
                        doc.setFillColor(100, 116, 139);
                        doc.roundedRect(x, y, width, 7, 2, 2, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'bold');
                        doc.text('ENERG√çA', x + 3, y + 5);
                        y += 9;
                        
                        // Desglose energ√≠a
                        doc.setTextColor(55, 65, 81);
                        doc.setFontSize(6);
                        doc.setFont('helvetica', 'normal');
                        res.energyCosts.forEach((e, i) => {
                            if (e.kwh > 0) {
                                let periodoNombre = '';
                                if (res.originalTariffType === '2.0TD') {
                                    if (i === 0) periodoNombre = ` (${tr('Punta')})`;
                                    else if (i === 1) periodoNombre = ` (${tr('Llano')})`;
                                    else if (i === 2) periodoNombre = ` (${tr('Valle')})`;
                                }
                                const texto = `E${i+1}${periodoNombre}: (${num(e.kwh, 0)} kWh x ${num(e.price, 6)} ‚Ç¨/kWh)`;
                                doc.text(texto, x + 3, y);
                                doc.text(eur(e.cost), x + width - 3, y, { align: 'right' });
                                y += 4;
                            }
                        });
                        y += 2;
                        
                        // === TOTAL ===
                        doc.setFillColor(71, 85, 105);
                        doc.roundedRect(x, y, width, 9, 2, 2, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`TOTAL (${res.dias_facturados || 0} D√çAS)`, x + 3, y + 6);
                        doc.text(eur(res.totalPeriod || res.importe_total || 0), x + width - 3, y + 6, { align: 'right' });
                        y += 12;
                        
                        // === AHORRO ===
                        doc.setFillColor(220, 38, 38);
                        doc.roundedRect(x + width - 55, y, 52, 10, 2, 2, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'bold');
                        doc.text('AHORRO:', x + width - 52, y + 4);
                        doc.setFontSize(9);
                        doc.text(eur(res.savings || 0), x + width - 28, y + 7, { align: 'center' });
                    }
                    
                    // Por cada suministro
                    res.individualResults.forEach((supply, idx) => {
                        // Verificar si tiene comparaci√≥n indexada
                        const tieneIndexado = supply.indexedComparison && 
                                             supply.indexedComparison.powerCosts && 
                                             supply.indexedComparison.energyCosts;
                        
                        if (tieneIndexado) {
                            // DISE√ëO DUAL: DOS COLUMNAS (FIJO vs INDEXADO)
                            const col2Width = (contentWidth - 6) / 2;
                            const leftXDual = margin;
                            const rightXDual = margin + col2Width + 6;
                            
                            const neededSpace = 140;
                            checkNewPage(neededSpace);
                            
                            // T√≠tulo del suministro
                            doc.setFillColor(...darkColor);
                            doc.roundedRect(margin, yPos, contentWidth, 8, 2, 2, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(9);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`SUMINISTRO ${idx + 1}`, margin + 3, yPos + 5.5);
                            yPos += 12;
                            
                            // Generar desgloses en dos columnas
                            generarDesgloseMultiCups(supply, supply.indexedComparison, leftXDual, col2Width, true);
                            generarDesgloseMultiCups(supply, supply.indexedComparison, rightXDual, col2Width, false);
                            
                            yPos += 135;
                            
                        } else {
                            // DISE√ëO SIMPLE: UNA SOLA COLUMNA (solo FIJO)
                            const neededSpace = supply.originalTariffType === '3.0TD' ? 140 : 100;
                            checkNewPage(neededSpace);
                            
                            // === CABECERA DEL SUMINISTRO (AZUL OSCURO) ===
                            doc.setFillColor(...darkColor);
                            doc.setDrawColor(255, 255, 255);
                            doc.setLineWidth(2);
                            doc.roundedRect(margin, yPos, contentWidth, 12, 3, 3, 'FD');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(9);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`[${idx + 1}] ${supply.cups}`, margin + 3, yPos + 5);
                            doc.setFontSize(7);
                            doc.setFont('helvetica', 'normal');
                            
                            // Mostrar nombre completo: Comercializadora - Tarifa
                            const comercializadoraName = supply.offer.name || '';
                            const tarifaName = supply.offer.description || supply.offer.name;
                            const fullOfferName = isDrk 
                                ? tarifaName 
                                : `${comercializadoraName} - ${tarifaName}`;
                            doc.text(`Tipo: ${supply.originalTariffType} | D√≠as: ${supply.dias_facturados} | ${fullOfferName}`, margin + 3, yPos + 9);
                            yPos += 14;
                            
                            // === PRECIOS APLICADOS ARRIBA (DISE√ëO MEJORADO CON T√çTULOS) ===
                            const priceBoxH = supply.originalTariffType === '2.0TD' ? 38 : 52;
                            doc.setFillColor(...darkColor);
                            doc.setDrawColor(255, 255, 255);
                            doc.setLineWidth(1);
                            doc.roundedRect(margin, yPos, contentWidth, priceBoxH, 3, 3, 'FD');
                            
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(8);
                            doc.setFont('helvetica', 'bold');
                            doc.text('PRECIOS APLICADOS:', margin + 3, yPos + 5);
                            yPos += 10;
                            
                            // === POTENCIA (con t√≠tulo) ===
                            doc.setFontSize(7);
                            doc.setFont('helvetica', 'bold');
                            doc.text(tr('POTENCIA:'), margin + 5, yPos);
                            yPos += 4;
                            
                            doc.setFont('helvetica', 'normal');
                            if (supply.originalTariffType === '2.0TD') {
                                const p1S = supply.offer.p_potencia_1 / 365;
                                const p2S = supply.offer.p_potencia_2 / 365;
                                doc.text(`P1: ${numPriceFormula(p1S)} ‚Ç¨/kW/d√≠a`, margin + 8, yPos);
                                doc.text(`P2: ${numPriceFormula(p2S)} ‚Ç¨/kW/d√≠a`, margin + 70, yPos);
                                yPos += 6;
                            } else {
                                // 3.0TD - compacto
                                for (let i = 1; i <= 6; i++) {
                                    const pDS = (supply.offer[`p_potencia_${i}`] || 0) / 365;
                                    const col = i <= 3 ? margin + 8 : margin + 70;
                                    const row = i <= 3 ? i : i - 3;
                                    doc.text(`P${i}: ${numPriceFormula(pDS)} ‚Ç¨/kW/d√≠a`, col, yPos + (row - 1) * 3.5);
                                }
                                yPos += 12;
                            }
                            
                            // === ENERG√çA (con t√≠tulo) ===
                            doc.setFont('helvetica', 'bold');
                            doc.text('ENERG√çA:', margin + 5, yPos);
                            yPos += 4;
                            
                            doc.setFont('helvetica', 'bold');
                            if (supply.originalTariffType === '2.0TD') {
                                doc.text(`E1: ${numPriceFormula(supply.offer.p1_price)}`, margin + 8, yPos);
                                doc.text(`E2: ${numPriceFormula(supply.offer.p2_price)}`, margin + 50, yPos);
                                doc.text(`E3: ${numPriceFormula(supply.offer.p3_price)}`, margin + 95, yPos);
                                yPos += 8;
                            } else {
                                // 3.0TD - compacto
                                for (let i = 1; i <= 6; i++) {
                                    const col = i <= 3 ? margin + 8 : margin + 70;
                                    const row = i <= 3 ? i : i - 3;
                                    doc.text(`E${i}: ${numPriceFormula(supply.offer[`p${i}_price`] || 0)}`, col, yPos + (row - 1) * 3.5);
                                }
                                yPos += 12;
                            }
                            
                            // Espacio variable seg√∫n tarifa
                            yPos += supply.originalTariffType === '3.0TD' ? 12 : 8;
                            
                            // === DESGLOSE DE C√ÅLCULOS (FUERA DE LA CAJA AZUL) ===
                            // T√≠tulo POTENCIA
                            doc.setFillColor(...darkColor);
                            doc.roundedRect(margin, yPos, contentWidth / 2 - 2, 6, 2, 2, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(7);
                            doc.setFont('helvetica', 'bold');
                            doc.text('POTENCIA', margin + 2, yPos + 4);
                            yPos += 10;
                            
                            doc.setTextColor(0, 0, 0);
                            doc.setFont('helvetica', 'normal');
                            doc.setFontSize(7);
                            supply.powerCosts.forEach(p => {
                                if (p.kw > 0 || p.period <= 2) {
                                    checkNewPage(4);
                                    doc.text(`P${p.period} (${num(p.kw, 2)} kW x ${supply.dias_facturados}d x ${numPriceFormula(p.priceDay)})`, margin + 4, yPos);
                                    doc.text(`${num(p.cost, 2)} ‚Ç¨`, pageWidth - margin - 2, yPos, { align: 'right' });
                                    yPos += 3.5;
                                }
                            });
                            
                            yPos += 4;
                            
                            // T√≠tulo ENERG√çA
                            doc.setFillColor(...darkColor);
                            doc.roundedRect(margin, yPos, contentWidth / 2 - 2, 6, 2, 2, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(7);
                            doc.setFont('helvetica', 'bold');
                            doc.text('ENERG√çA', margin + 2, yPos + 4);
                            yPos += 10;
                            
                            doc.setTextColor(0, 0, 0);
                            doc.setFont('helvetica', 'normal');
                            doc.setFontSize(7);
                            supply.energyCosts.forEach(e => {
                                const maxPeriod = supply.originalTariffType === '2.0TD' ? 3 : 6;
                                if (e.kwh > 0 || e.period <= maxPeriod) {
                                    checkNewPage(4);
                                    let labelE = `E${e.period}`;
                                    if (supply.originalTariffType === '2.0TD') {
                                        if (e.period === 1) labelE += ` (${tr('Punta')})`;
                                        if (e.period === 2) labelE += ` (${tr('Llano')})`;
                                        if (e.period === 3) labelE += ` (${tr('Valle')})`;
                                    }
                                    doc.text(`${labelE} (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)})`, margin + 4, yPos);
                                    doc.text(`${num(e.cost, 2)} ‚Ç¨`, pageWidth - margin - 2, yPos, { align: 'right' });
                                    yPos += 3.5;
                                }
                            });
                            
                            yPos += 3;
                            
                            // Total del suministro
                            doc.setFillColor(...darkColor);
                            doc.rect(margin, yPos, contentWidth, 7, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(8);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`TOTAL (${supply.dias_facturados} D√çAS)`, margin + 2, yPos + 4.5);
                            doc.text(eur(supply.totalPeriod), pageWidth - margin - 2, yPos + 4.5, { align: 'right' });
                            yPos += 9;
                            
                            // === AHORRO INDIVIDUAL (DEBAJO DEL TOTAL) ===
                            if (!supply.isNegativeSavings) {
                                const ahorroWidth = 55;
                                const ahorroHeight = 8;
                                const ahorroX = pageWidth - margin - ahorroWidth;
                                
                                doc.setFillColor(...redColor);
                                doc.roundedRect(ahorroX, yPos, ahorroWidth, ahorroHeight, 2, 2, 'F');
                                doc.setTextColor(255, 255, 255);
                                doc.setFontSize(6);
                                doc.setFont('helvetica', 'bold');
                                doc.text('AHORRO:', ahorroX + 2, yPos + 3.5);
                                doc.setFontSize(10);
                                doc.text(eur(supply.savings), ahorroX + ahorroWidth - 2, yPos + 6, { align: 'right' });
                                yPos += ahorroHeight + 4;
                            } else {
                                yPos += 3;
                            }
                        }
                    });
                    
                    // === PRECIOS CONSOLIDADOS (REDISE√ëADO) ===
                    checkNewPage(35);
                    
                    // T√≠tulo principal con fondo verde
                    doc.setFillColor(...greenColor); // VERDE
                    doc.roundedRect(margin, yPos, contentWidth, 10, 3, 3, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PRECIOS DE LAS OFERTAS SELECCIONADAS', margin + 3, yPos + 6.5);
                    yPos += 14;
                    
                    const winningOffers = getWinningOffersPerType(res.individualResults);
                    const offers20MC = winningOffers.winningOffers['2.0TD'];
                    if (offers20MC && offers20MC.length > 0) {
                        offers20MC.forEach((offer20, index) => {
                            checkNewPage(35);
                            
                            // Caja con fondo azul oscuro y borde blanco
                            doc.setFillColor(...darkColor);
                            doc.setDrawColor(255, 255, 255);
                            doc.setLineWidth(2);
                            doc.roundedRect(margin, yPos, contentWidth, 32, 3, 3, 'FD');
                            
                            // T√≠tulo de la tarifa (blanco)
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(9);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`TARIFA 2.0TD #${index + 1}: ${offer20.description || offer20.name}`, margin + 3, yPos + 5);
                            yPos += 10;
                            
                            // POTENCIA (con t√≠tulo)
                            doc.setFontSize(7);
                            doc.text(tr('POTENCIA:'), margin + 3, yPos);
                            yPos += 4;
                            
                            doc.setFont('helvetica', 'normal');
                            const p120 = offer20.p_potencia_1 / 365;
                            const p220 = offer20.p_potencia_2 / 365;
                            doc.text(`P1: ${numPriceFormula(p120)} ‚Ç¨/kW/d√≠a`, margin + 5, yPos);
                            doc.text(`P2: ${numPriceFormula(p220)} ‚Ç¨/kW/d√≠a`, margin + 70, yPos);
                            yPos += 5;
                            
                            // ENERG√çA (con t√≠tulo)
                            doc.setFont('helvetica', 'bold');
                            doc.text('ENERG√çA:', margin + 3, yPos);
                            yPos += 4;
                            
                            doc.text(`E1: ${numPriceFormula(offer20.p1_price)}`, margin + 5, yPos);
                            doc.text(`E2: ${numPriceFormula(offer20.p2_price)}`, margin + 48, yPos);
                            doc.text(`E3: ${numPriceFormula(offer20.p3_price)}`, margin + 93, yPos);
                            
                            yPos += 20; // M√°s espacio entre tarifas (antes 12)
                        });
                    }
                    
                    const offers30MC = winningOffers.winningOffers['3.0TD'];
                    if (offers30MC && offers30MC.length > 0) {
                        offers30MC.forEach((offer30, index) => {
                            checkNewPage(60);
                            
                            // Caja con fondo azul oscuro y borde blanco
                            doc.setFillColor(...darkColor);
                            doc.setDrawColor(255, 255, 255);
                            doc.setLineWidth(2);
                            doc.roundedRect(margin, yPos, contentWidth, 56, 3, 3, 'FD');
                            
                            // T√≠tulo de la tarifa (blanco)
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(9);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`TARIFA 3.0TD #${index + 1}: ${offer30.description || offer30.name}`, margin + 3, yPos + 5);
                            yPos += 10;
                            
                            // POTENCIA (con t√≠tulo)
                            doc.setFontSize(7);
                            doc.text(tr('POTENCIA:'), margin + 3, yPos);
                            yPos += 4;
                            
                            doc.setFont('helvetica', 'normal');
                            for (let i = 1; i <= 6; i++) {
                                const pDay30 = (offer30[`p_potencia_${i}`] || 0) / 365;
                                const col = i <= 3 ? margin + 5 : margin + 70;
                                const row = i <= 3 ? i : i - 3;
                                doc.text(`P${i}: ${numPriceFormula(pDay30)} ‚Ç¨/kW/d√≠a`, col, yPos + (row - 1) * 3.5);
                            }
                            yPos += 12;
                            
                            // ENERG√çA (con t√≠tulo)
                            doc.setFont('helvetica', 'bold');
                            doc.text('ENERG√çA:', margin + 3, yPos);
                            yPos += 4;
                            
                            for (let i = 1; i <= 6; i++) {
                                const col = i <= 3 ? margin + 5 : margin + 70;
                                const row = i <= 3 ? i : i - 3;
                                doc.text(`E${i}: ${numPriceFormula(offer30[`p${i}_price`] || 0)}`, col, yPos + (row - 1) * 3.5);
                            }
                            
                            yPos += 20; // M√°s espacio despu√©s de 3.0TD (antes 18)
                        });
                    }
                    
                    // FIN SECCION MULTICUPS
                    
                } else {
                    // === INICIO INDIVIDUAL - DISE√ëO COMPACTO TIPO TARJETA ===
                
                // === CABECERA AZUL (M√ÅS PEQUE√ëA) ===
                doc.setFillColor(...primaryColor);
                doc.roundedRect(margin, yPos, contentWidth, 32, 4, 4, 'F');
                
                // "LA MEJOR OPCI√ìN PARA TI ES"
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('LA MEJOR OPCI√ìN PARA TI ES'), pageWidth / 2, yPos + 8, { align: 'center' });
                
                // Comercializadora y Tarifa
                const comercializadora = offer.name; // Nombre corto (ej: ELEIA)
                const tarifaCompleta = (offer.description && offer.description !== 'N/A') ? offer.description : offer.name;
                const brandName = isDrk ? 'DRK' : 'POWER CUP';
                
                if (!isDrk) {
                    // POWER CUP Individual: Solo mostrar comercializadora (nombre corto)
                    doc.setFontSize(32);
                    doc.setFont('helvetica', 'bold');
                    doc.text(comercializadora.toUpperCase(), pageWidth / 2, yPos + 18, { align: 'center' });
                    
                    // POWER CUP debajo
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text('POWER CUP', pageWidth / 2, yPos + 27, { align: 'center' });
                } else {
                    // DRK: Mostrar solo DRK y nombre de tarifa
                    doc.setFontSize(26);
                    doc.setFont('helvetica', 'bold');
                    doc.text('DRK', pageWidth / 2, yPos + 18, { align: 'center' });
                    
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text(tarifaCompleta, pageWidth / 2, yPos + 27, { align: 'center' });
                }
                
                yPos += 37;
                
                // === CAJA BLANCA COMPACTA ===
                doc.setFillColor(255, 255, 255);
                doc.setDrawColor(220, 220, 220);
                doc.setLineWidth(0.3);
                const boxHeightIndiv = res.savings > 0 ? 75 : 65;
                doc.roundedRect(margin, yPos, contentWidth, boxHeightIndiv, 4, 4, 'FD');
                
                if (res.savings > 0) {
                    // Ahorro positivo - dise√±o normal
                    doc.setTextColor(120, 120, 140);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('TU AHORRO ANUAL ESTIMADO'), pageWidth / 2, yPos + 8, { align: 'center' });
                    
                    // Cifra de ahorro en VERDE (grande pero ajustado)
                    doc.setTextColor(...greenColor);
                    doc.setFontSize(32);
                    doc.setFont('helvetica', 'bold');
                    doc.text(savingsText, pageWidth / 2, yPos + 25, { align: 'center' });
                    
                    yPos += 32;
                } else {
                    // Sin ahorro - mensaje grande centrado
                    doc.setTextColor(...primaryColor);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text('¬°ENHORABUENA!', pageWidth / 2, yPos + 12, { align: 'center' });
                    
                    doc.setTextColor(60, 60, 60);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Actualmente est√°s en una buena tarifa.', pageWidth / 2, yPos + 25, { align: 'center' });
                    
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Seguiremos estudiando el mercado y te avisaremos cuando', pageWidth / 2, yPos + 38, { align: 'center' });
                    doc.text('encontremos alguna tarifa que se adapte a tu perfil de consumo.', pageWidth / 2, yPos + 45, { align: 'center' });
                    
                    yPos += 67;
                }
                
                // === DOS COLUMNAS COMPACTAS === (Solo si hay ahorro)
                if (res.savings > 0) {
                const colWidthResumen = (contentWidth - 20) / 2;
                
                // COLUMNA IZQUIERDA - TU FACTURA ACTUAL
                const leftXResumen = margin + 10;
                
                doc.setTextColor(140, 150, 160);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('TU FACTURA ACTUAL'), leftXResumen + colWidthResumen / 2, yPos, { align: 'center' });
                
                // Precio periodo (mensual estimado) tachado en rojo
                const diasPeriodo = res.dias_facturados || 30;
                const precioMensualEstimado = (res.originalBillAnnual / 365) * 30;
                const oldPrice = `${eur(precioMensualEstimado)}/mes`;
                doc.setTextColor(...redColor);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                const oldX = leftXResumen + colWidthResumen / 2;
                const oldY = yPos + 12;
                doc.text(oldPrice, oldX, oldY, { align: 'center' });
                
                // L√≠nea tachada
                const oldWidth = doc.getTextWidth(oldPrice);
                doc.setDrawColor(...redColor);
                doc.setLineWidth(1.5);
                doc.line(oldX - oldWidth/2 - 2, oldY - 3, oldX + oldWidth/2 + 2, oldY - 3);
                
                // "Total Periodo"
                doc.setTextColor(140, 150, 160);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.text(`Total Periodo (${diasPeriodo} d√≠as)`, leftXResumen + colWidthResumen / 2, yPos + 19, { align: 'center' });
                
                // Precio anual tachado
                const oldAnnual = eur(res.originalBillAnnual);
                doc.setTextColor(...redColor);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                const oldAnnualX = leftXResumen + colWidthResumen / 2;
                const oldAnnualY = yPos + 32;
                doc.text(`${oldAnnual}/a√±o`, oldAnnualX, oldAnnualY, { align: 'center' });
                
                // L√≠nea tachada
                const oldAnnualWidth = doc.getTextWidth(`${oldAnnual}/a√±o`);
                doc.setDrawColor(...redColor);
                doc.setLineWidth(1.5);
                doc.line(oldAnnualX - oldAnnualWidth/2 - 2, oldAnnualY - 3, oldAnnualX + oldAnnualWidth/2 + 2, oldAnnualY - 3);
                
                // SEPARADOR VERTICAL
                doc.setDrawColor(220, 220, 220);
                doc.setLineWidth(0.3);
                doc.line(pageWidth / 2, yPos - 5, pageWidth / 2, yPos + 38);
                
                // COLUMNA DERECHA - TU NUEVO COSTE
                const rightXResumen = margin + 10 + colWidthResumen + 10;
                
                doc.setTextColor(...primaryColor);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                const newLabel = `TU NUEVO COSTE ${brandName}`;
                doc.text(newLabel, rightXResumen + colWidthResumen / 2, yPos, { align: 'center' });
                
                // Precio mensual en azul
                doc.setTextColor(...primaryColor);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(`${eur(res.totalAnnual / 12)}/mes`, rightXResumen + colWidthResumen / 2, yPos + 13, { align: 'center' });
                
                // "Estimado Mensual"
                doc.setTextColor(140, 150, 160);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.text(tr('Estimado Mensual'), rightXResumen + colWidthResumen / 2, yPos + 19, { align: 'center' });
                
                // Precio anual en azul
                doc.setTextColor(...primaryColor);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text(`${eur(res.totalAnnual)}/a√±o`, rightXResumen + colWidthResumen / 2, yPos + 32, { align: 'center' });
                
                yPos += 50;
                } // Fin del condicional de columnas de precios en Individual
                
                // === PRECIOS DE LA OFERTA EN P√ÅGINA 1 (sin check de espacio) ===
                if (!res.isMulti) {
                    // Titulo con fondo VERDE
                    doc.setFillColor(...greenColor); // VERDE
                    doc.roundedRect(margin, yPos, contentWidth, 10, 3, 3, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    // Mostrar Comercializadora - Tarifa completa
                    // Si description existe y es diferente de name, usar "Comercializadora - Descripci√≥n"
                    // Si no, solo mostrar el nombre
                    const fullOfferTitle = (tarifaCompleta !== comercializadora) 
                        ? `${comercializadora} - ${tarifaCompleta}` 
                        : comercializadora;
                    doc.text(`PRECIOS DE LA OFERTA: ${fullOfferTitle}`, margin + 5, yPos + 6.5);
                    yPos += 12;
                    
                    // Caja con FONDO AZUL OSCURO y BORDE BLANCO
                    doc.setFillColor(...darkColor);
                    doc.setDrawColor(255, 255, 255);
                    doc.setLineWidth(3);
                    const priceBoxHeight = tariffType === '2.0TD' ? 40 : 75;
                    doc.roundedRect(margin, yPos, contentWidth, priceBoxHeight, 3, 3, 'FD');
                    
                    // POTENCIA (texto blanco)
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('POTENCIA:'), margin + 5, yPos + 6);
                    yPos += 9;
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    
                    if (tariffType === '2.0TD') {
                        const p1 = offer.p_potencia_1 / 365;
                        const p2 = offer.p_potencia_2 / 365;
                        doc.text(`P1 (‚Ç¨/kW/dia):`, margin + 8, yPos);
                        doc.text(numPriceFormula(p1), pageWidth - margin - 8, yPos, { align: 'right' });
                        yPos += 5;
                        doc.text(`P2 (‚Ç¨/kW/dia):`, margin + 8, yPos);
                        doc.text(numPriceFormula(p2), pageWidth - margin - 8, yPos, { align: 'right' });
                        yPos += 7;
                    } else {
                        for (let i = 1; i <= 6; i++) {
                            const pDay = (offer[`p_potencia_${i}`] || 0) / 365;
                            doc.text(`P${i} (‚Ç¨/kW/dia):`, margin + 8, yPos);
                            doc.text(numPriceFormula(pDay), pageWidth - margin - 8, yPos, { align: 'right' });
                            yPos += 4.5;
                        }
                        yPos += 3;
                    }
                    
                    // ENERGIA (texto blanco)
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('ENERGIA:'), margin + 5, yPos);
                    yPos += 5;
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    
                    if (tariffType === '2.0TD') {
                        doc.text(`E1 - ${tr('Punta')} (‚Ç¨/kWh):`, margin + 8, yPos);
                        doc.text(numPriceFormula(offer.p1_price), pageWidth - margin - 8, yPos, { align: 'right' });
                        yPos += 5;
                        doc.text(`E2 - ${tr('Llano')} (‚Ç¨/kWh):`, margin + 8, yPos);
                        doc.text(numPriceFormula(offer.p2_price), pageWidth - margin - 8, yPos, { align: 'right' });
                        yPos += 5;
                        doc.text(`E3 - ${tr('Valle')} (‚Ç¨/kWh):`, margin + 8, yPos);
                        doc.text(numPriceFormula(offer.p3_price), pageWidth - margin - 8, yPos, { align: 'right' });
                        yPos += 7;
                    } else {
                        for (let i = 1; i <= 6; i++) {
                            doc.text(`E${i} (‚Ç¨/kWh):`, margin + 8, yPos);
                            doc.text(numPriceFormula(offer[`p${i}_price`] || 0), pageWidth - margin - 8, yPos, { align: 'right' });
                            yPos += 4.5;
                        }
                        yPos += 5;
                    }
                    
                    // === NUEVA P√ÅGINA PARA EL DESGLOSE ===
                    doc.addPage();
                    yPos = 20;
                }
                
                // === DESGLOSE DETALLADO ===
                if (!res.isMulti) {
                    // T√≠tulo del desglose (ahora en p√°gina 2) - VERDE
                    doc.setFillColor(...greenColor); // VERDE
                    doc.roundedRect(margin, yPos, contentWidth, 10, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    // Mostrar Comercializadora - Tarifa completa
                    // Si description existe y es diferente de name, usar "Comercializadora - Descripci√≥n"
                    // Si no, solo mostrar el nombre
                    const fullDesgloseTitle = (tarifaCompleta !== comercializadora) 
                        ? `${comercializadora} - ${tarifaCompleta}` 
                        : comercializadora;
                    doc.text(`${tr('DESGLOSE DETALLADO DE LA SIMULACI√ìN')} (${fullDesgloseTitle})`, margin + 3, yPos + 6.5);
                    
                    yPos += 14;
                    
                    // === T√âRMINO POTENCIA ===
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text('T√âRMINO POTENCIA (Precio en ‚Ç¨/kW D√≠a)', margin, yPos);
                    yPos += 6;
                    
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    
                    res.powerCosts.forEach((p, idx) => {
                        if (p.kw > 0 || p.period <= config.powerPeriods) {
                            const formula = `P${p.period} (${num(p.kw, 2)} kW x ${res.dias_facturados}d x ${numPriceFormula(p.priceDay)})`;
                            doc.text(formula, margin + 2, yPos);
                            doc.text(`${num(p.cost, 2)} ‚Ç¨`, pageWidth - margin - 2, yPos, { align: 'right' });
                            yPos += 5;
                        }
                    });
                    
                    // Subtotal potencia
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...primaryColor);
                    doc.text(tr('SUBTOTAL POTENCIA'), margin + 2, yPos);
                    doc.text(`${num(res.subPower, 2)} ‚Ç¨`, pageWidth - margin - 2, yPos, { align: 'right' });
                    yPos += 8;
                    
                    // === T√âRMINO ENERG√çA ===
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text('T√âRMINO ENERG√çA (Precios en ‚Ç¨/kWh)', margin, yPos);
                    yPos += 6;
                    
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    
                    res.energyCosts.forEach((e, idx) => {
                        if (e.kwh > 0 || e.period <= config.periods) {
                            let label = `E${e.period}`;
                            if (tariffType === '2.0TD') {
                                if (e.period === 1) label += ` - ${tr('Punta')}`;
                                if (e.period === 2) label += ` - ${tr('Llano')}`;
                                if (e.period === 3) label += ` - ${tr('Valle')}`;
                            }
                            const formula = `${label} (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)})`;
                            doc.text(formula, margin + 2, yPos);
                            doc.text(`${num(e.cost, 2)} ‚Ç¨`, pageWidth - margin - 2, yPos, { align: 'right' });
                            yPos += 5;
                        }
                    });
                    
                    // Subtotal energ√≠a bruto
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(80, 80, 80);
                    doc.text('Subtotal Energ√≠a (Bruto)', margin + 2, yPos);
                    doc.text(`${num(res.subEnergy, 2)} ‚Ç¨`, pageWidth - margin - 2, yPos, { align: 'right' });
                    yPos += 5;
                    
                    // Descuento si existe
                    if (res.discountAmount > 0) {
                        doc.setTextColor(...redColor);
                        doc.text(`Descuento Aplicado (${num(res.discountRate * 100, 0)}%)`, margin + 2, yPos);
                        doc.text(`-${num(res.discountAmount, 2)} ‚Ç¨`, pageWidth - margin - 2, yPos, { align: 'right' });
                        yPos += 5;
                        
                        doc.setTextColor(0, 0, 0);
                        doc.text('Subtotal Energ√≠a (Neto)', margin + 2, yPos);
                        doc.text(`${num(res.subEnergyNet, 2)} ‚Ç¨`, pageWidth - margin - 2, yPos, { align: 'right' });
                        yPos += 5;
                    }
                    
                    yPos += 3;
                    
                    // === TOTALES ===
                    // L√≠nea separadora
                    doc.setDrawColor(150, 150, 150);
                    doc.setLineWidth(0.3);
                    doc.line(margin, yPos, pageWidth - margin, yPos);
                    yPos += 5;
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(9);
                    
                    // Subtotal base
                    doc.text('SUBTOTAL BASE (P+E)', margin + 2, yPos);
                    doc.text(`${num(res.subBase, 2)} ‚Ç¨`, pageWidth - margin - 2, yPos, { align: 'right' });
                    yPos += 5;
                    
                    // Impuesto el√©ctrico
                    doc.setFont('helvetica', 'normal');
                    doc.text(`${tr('Imp. El√©c.')} (${num(res.ieRate * 100, 3)}%)`, margin + 2, yPos);
                    doc.text(`${num(res.costIE, 2)} ‚Ç¨`, pageWidth - margin - 2, yPos, { align: 'right' });
                    yPos += 5;
                    
                    // Base imponible
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    doc.text(tr('BASE IMPONIBLE'), margin + 2, yPos);
                    doc.text(`${num(res.baseImp, 2)} ‚Ç¨`, pageWidth - margin - 2, yPos, { align: 'right' });
                    yPos += 5;
                    
                    // IVA
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                    doc.text(tr('IVA (21%)'), margin + 2, yPos);
                    doc.text(`${num(res.costIVA, 2)} ‚Ç¨`, pageWidth - margin - 2, yPos, { align: 'right' });
                    yPos += 7;
                    
                    // TOTAL FACTURA
                    doc.setFillColor(...darkColor);
                    doc.roundedRect(margin, yPos, contentWidth, 10, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`TOTAL FACTURA (${res.dias_facturados} D√çAS)`, margin + 3, yPos + 6.5);
                    doc.text(eur(res.totalPeriod), pageWidth - margin - 3, yPos + 6.5, { align: 'right' });
                    yPos += 14;
                    
                    // Total a√±o
                    doc.setTextColor(...primaryColor);
                    doc.setFontSize(10);
                    doc.text(tr('TOTAL A√ëO (PROYECTADO)'), margin + 2, yPos);
                    doc.text(eur(res.totalAnnual), pageWidth - margin - 2, yPos, { align: 'right' });
                    yPos += 8;
                }
                
                } // FIN del else - cierre de seccion individual
                
                // === RESUMEN DE AHORRO FINAL (COM√öN PARA INDIVIDUAL Y MULTICUPS) ===
                if (yPos > 240) {
                    doc.addPage();
                    yPos = 20;
                } else {
                    yPos += 15; // Espacio antes de la caja verde (para que no se solape con tarifas consolidadas)
                }
                
                doc.setFillColor(...redColor); // ROJO
                doc.roundedRect(margin, yPos, contentWidth, 20, 3, 3, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('TU AHORRO ANUAL ESTIMADO ES:'), margin + 5, yPos + 7);
                
                doc.setFontSize(22);
                doc.text(`${savingsText} ${tr('/ A√ëO')}`, margin + 5, yPos + 16);
                
                yPos += 30; // M√°s espacio despu√©s de la caja verde (antes 25)
                
                // === CUADRO DE FORMALIZACION CON FONDO AZUL OSCURO ===
                checkNewPage(60);
                
                // Cuadro principal con FONDO AZUL OSCURO y BORDE BLANCO
                doc.setDrawColor(255, 255, 255);
                doc.setLineWidth(3);
                doc.setFillColor(...darkColor);
                doc.roundedRect(margin, yPos, contentWidth, 55, 3, 3, 'FD');
                
                // Encabezado (texto blanco)
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('PARA FORMALIZAR ESTE CONTRATO:', margin + 5, yPos + 8);
                
                yPos += 13;
                
                // Instruccion principal (texto blanco)
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                if (res.isMulti) {
                    doc.text(tr('Responde a este email adjuntando la documentaci√≥n de los') + ` ${res.individualResults.length} CUPS:`, margin + 5, yPos);
                } else {
                    doc.text(tr('Responde a este email adjuntando la siguiente documentaci√≥n:'), margin + 5, yPos);
                }
                
                yPos += 6;
                
                // Lista de documentos (texto blanco)
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(255, 255, 255);
                
                const docs = [
                    '1. Foto del DNI/CIF (anverso y reverso)',
                    '2. Ultima factura (minimo 3 meses de antiguedad)',
                    '3. Email de contacto para validacion',
                    '4. Telefono de contacto',
                    '5. Numero de cuenta bancaria (IBAN)'
                ];
                
                docs.forEach((docItem, idx) => {
                    doc.text(docItem, margin + 8, yPos);
                    yPos += 4.5;
                });
                
                yPos += 2;
                
                // Separador (blanco)
                doc.setDrawColor(255, 255, 255);
                doc.setLineWidth(0.5);
                doc.line(margin + 5, yPos, pageWidth - margin - 5, yPos);
                yPos += 4;
                
                // Email de contacto destacado (texto blanco)
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text('Envia la documentacion al comercial:', margin + 5, yPos);
                yPos += 4;
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(13);
                doc.setFont('helvetica', 'bold');
                doc.text(commercialCode, margin + 5, yPos);
                
                yPos += 10;
                
                // === PIE DE P√ÅGINA ===
                const footerY = 280;
                doc.setDrawColor(...primaryColor);
                doc.setLineWidth(1.5);
                doc.line(margin, footerY, pageWidth - margin, footerY);
                
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.setFont('helvetica', 'normal');
                doc.text(`[Colaborador: ${commercialCode}] | Este resumen es una simulacion ${res.isMulti ? `consolidada de ${res.individualResults.length} suministros` : 'basada en su ultima factura'}.`, margin, footerY + 5);
                
                doc.setFontSize(7);
                doc.setTextColor(150, 150, 150);
                doc.text(`Generado el ${new Date().toLocaleDateString('es-ES')}`, pageWidth - margin - 35, footerY + 5);
                
                // === GUARDAR PDF ===
                const fileName = res.isMulti 
                    ? `Comparativa_MultiCups_${clientName.replace(/[^a-z0-9]/gi, '_')}_${Date.now()}.pdf`
                    : `Comparativa_${res.cups.substring(0, 10)}_${clientName.replace(/[^a-z0-9]/gi, '_')}_${Date.now()}.pdf`;
                
                doc.save(fileName);
                
                // Cerrar modal y mostrar √©xito
                hideErrorModal();
                window.showMessageModal(`‚úÖ ¬°PDF generado con √©xito!\n\nSe ha descargado: ${fileName}\n\nPuedes adjuntarlo directamente en el email para tu cliente.`);
                document.getElementById('send-offer-modal').classList.add('hidden');
                document.getElementById('send-offer-modal').classList.remove('flex');
                
                // NUEVO: Restaurar idioma chino si es necesario
                if (window._wasChineseBeforePDF === true) {
                    // Solo preguntar si el usuario ORIGINALMENTE estaba en chino
                    setTimeout(() => {
                        const userWantsChineseBack = confirm(
                            '‚úÖ PDFÂ∑≤ÁîüÊàêÔºÅ\n' +
                            '‚úÖ PDF generated!\n\n' +
                            'ÊòØÂê¶Ë¶ÅÂàáÊç¢Âõû‰∏≠ÊñáÔºü\n' +
                            'Switch back to Chinese?\n\n' +
                            'ÁÇπÂáª"Á°ÆÂÆö"ÂàáÊç¢Âõû‰∏≠Êñá\n' +
                            'Click OK to switch back to Chinese'
                        );
                        
                        if (userWantsChineseBack && window.LANG) {
                            console.log('üá®üá≥ Restaurando idioma chino');
                            window.LANG.change('zh', true);
                        }
                        
                        // Limpiar flag
                        window._wasChineseBeforePDF = false;
                    }, 500);
                }
                
            } catch (e) {
                console.error("Error al generar PDF:", e);
                window.showErrorModal(`Error al generar PDF: ${e.message}`);
            }
        }
        
        // --- GENERACI√ìN DE HTML PARA COMPARACI√ìN DUAL (FIJO VS INDEXADO) ---
        
        function generateDualStyledHtmlOffer(commercialCode, resFijo, resIndexed) {
            const brand = activeBrand;
            
            const eur = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
            
            // DETECCI√ìN DE POWER CUP
            const isPowerCup = brand.NAME.includes('POWER');
            
            // Colores din√°micos
            const HEADER_BLUE = isPowerCup ? '#738257' : '#6B7D8E';
            const DRK_BLUE = isPowerCup ? '#84cc16' : '#0ea5e9';
            const GREEN_SAVE = '#16a34a';
            const RED_CTA = '#DC2626';
            const SLATE_DARK = isPowerCup ? '#5a6b47' : '#475569';
            const SLATE_MED = isPowerCup ? '#738257' : '#64748b';
            
            const BRAND_DISPLAY = isPowerCup ? 'POWER CUP' : 'DRK';
            
            const clientName = document.getElementById('client-name-input').value.trim() || '[NOMBRE COMPLETO CLIENTE]';
            const clientPhone = document.getElementById('client-phone-input').value.trim() || '[TEL√âFONO CLIENTE]';
            const clientEmail = document.getElementById('client-email-input').value.trim() || '[EMAIL CLIENTE]';
            
            const ahorroFijo = resFijo.savings;
            const ahorroIndexado = resIndexed.savings;
            
            // Generar desglose de precios FIJO
            let preciosFijoHtml = '';
            preciosFijoHtml += '<div><strong>POTENCIA:</strong></div>';
            resFijo.powerCosts.forEach((p, i) => {
                if (p.kw > 0) {
                    preciosFijoHtml += `<div style="font-size: 9px;">P${i+1}: ${numPriceFormula(p.priceDay)} ‚Ç¨/kW/d√≠a</div>`;
                }
            });
            preciosFijoHtml += '<div style="margin-top: 4px;"><strong>ENERG√çA:</strong></div>';
            resFijo.energyCosts.forEach((e, i) => {
                if (e.kwh > 0) {
                    preciosFijoHtml += `<div style="font-size: 9px;">E${i+1}: ${numPriceFormula(e.price)} ‚Ç¨/kWh</div>`;
                }
            });
            
            // Generar desglose de precios INDEXADO
            let preciosIndexadoHtml = '';
            preciosIndexadoHtml += '<div><strong>POTENCIA:</strong></div>';
            resIndexed.powerCosts.forEach((p, i) => {
                if (p.kw > 0) {
                    preciosIndexadoHtml += `<div style="font-size: 9px;">P${i+1}: ${numPriceFormula(p.priceDay)} ‚Ç¨/kW/d√≠a</div>`;
                }
            });
            preciosIndexadoHtml += '<div style="margin-top: 4px;"><strong>ENERG√çA:</strong></div>';
            resIndexed.energyCosts.forEach((e, i) => {
                if (e.kwh > 0) {
                    preciosIndexadoHtml += `<div style="font-size: 9px;">E${i+1}: ${numPriceFormula(e.price)} ‚Ç¨/kWh</div>`;
                }
            });
            
            // Generar desglose detallado FIJO
            let detallesFijoHtml = '';
            resFijo.powerCosts.forEach((p, i) => {
                if (p.kw > 0) {
                    detallesFijoHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; color: #374151;">
                            <span>P${i+1}: (${num(p.kw, 2)} kW x ${numPriceFormula(p.priceDay)} ‚Ç¨/kW/d√≠a)</span>
                            <span style="font-weight: bold;">${num(p.cost, 2)} ‚Ç¨</span>
                        </div>
                    `;
                }
            });
            
            let energiaFijoHtml = '';
            resFijo.energyCosts.forEach((e, i) => {
                if (e.kwh > 0) {
                    let label = `E${i+1}`;
                    if (resFijo.originalTariffType === '2.0TD') {
                        if (i === 0) label += ` (${tr('Punta')})`;
                        else if (i === 1) label += ` (${tr('Llano')})`;
                        else if (i === 2) label += ` (${tr('Valle')})`;
                    }
                    energiaFijoHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; color: #374151;">
                            <span>${label}: (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)} ‚Ç¨/kWh)</span>
                            <span style="font-weight: bold;">${num(e.cost, 2)} ‚Ç¨</span>
                        </div>
                    `;
                }
            });
            
            // Generar desglose detallado INDEXADO
            let detallesIndexadoHtml = '';
            resIndexed.powerCosts.forEach((p, i) => {
                if (p.kw > 0) {
                    detallesIndexadoHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; color: #374151;">
                            <span>P${i+1}: (${num(p.kw, 2)} kW x ${numPriceFormula(p.priceDay)} ‚Ç¨/kW/d√≠a)</span>
                            <span style="font-weight: bold;">${num(p.cost, 2)} ‚Ç¨</span>
                        </div>
                    `;
                }
            });
            
            let energiaIndexadoHtml = '';
            resIndexed.energyCosts.forEach((e, i) => {
                if (e.kwh > 0) {
                    let label = `E${i+1}`;
                    if (resIndexed.originalTariffType === '2.0TD') {
                        if (i === 0) label += ' (Punta)';
                        else if (i === 1) label += ' (Llano)';
                        else if (i === 2) label += ' (Valle)';
                    }
                    energiaIndexadoHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; color: #374151;">
                            <span>${label}: (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)} ‚Ç¨/kWh)</span>
                            <span style="font-weight: bold;">${num(e.cost, 2)} ‚Ç¨</span>
                        </div>
                    `;
                }
            });
            
            // EMAIL BODY con precios detallados
            const LB = '%0A';
            const emailBody = `‚úÖ CONFIRMACI√ìN DE ACEPTACI√ìN DE OFERTA COMPARATIVA${LB}${LB}` +
                             `Estimado equipo de ${brand.NAME.toUpperCase()},${LB}${LB}` +
                             `Confirmo mi aceptaci√≥n de la oferta energ√©tica que detallo a continuaci√≥n:${LB}${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                             `üìã DATOS DEL SUMINISTRO${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                             `üîå CUPS: ${resFijo.cups}${LB}` +
                             `üìä Tipo: ${resFijo.originalTariffType}${LB}` +
                             `üìÖ D√≠as facturados: ${resFijo.dias_facturados}${LB}${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                             `üí∞ COMPARACI√ìN DE AHORROS${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                             `üíº Ahorro con Tarifa FIJA: ${eur(ahorroFijo)}${LB}` +
                             `   Nuevo Coste: ${eur(resFijo.totalAnnual / 12)}/mes (${eur(resFijo.totalAnnual)}/a√±o)${LB}${LB}` +
                             `‚ö° Ahorro con Tarifa INDEXADA: ${eur(ahorroIndexado)}${LB}` +
                             `   Nuevo Coste: ${eur(resIndexed.totalAnnual / 12)}/mes (${eur(resIndexed.totalAnnual)}/a√±o)${LB}${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                             `üí° PRECIOS DETALLADOS${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                             `üìò OPCI√ìN FIJA (${resFijo.offer.name}):${LB}` +
                             `   Potencia:${LB}` +
                             resFijo.powerCosts.map((p, i) => p.kw > 0 ? `   ‚Ä¢ P${i+1}: ${numPriceFormula(p.priceDay)} ‚Ç¨/kW/d√≠a${LB}` : '').join('') +
                             `${LB}   Energ√≠a:${LB}` +
                             resFijo.energyCosts.map((e, i) => e.kwh > 0 ? `   ‚Ä¢ E${i+1}: ${numPriceFormula(e.price)} ‚Ç¨/kWh${LB}` : '').join('') +
                             `${LB}üìó OPCI√ìN INDEXADA (${resIndexed.offer.name}):${LB}` +
                             `   Potencia:${LB}` +
                             resIndexed.powerCosts.map((p, i) => p.kw > 0 ? `   ‚Ä¢ P${i+1}: ${numPriceFormula(p.priceDay)} ‚Ç¨/kW/d√≠a${LB}` : '').join('') +
                             `${LB}   Energ√≠a:${LB}` +
                             resIndexed.energyCosts.map((e, i) => e.kwh > 0 ? `   ‚Ä¢ E${i+1}: ${numPriceFormula(e.price)} ‚Ç¨/kWh${LB}` : '').join('') +
                             `${LB}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                             `‚úÖ MI DECISI√ìN (Marca con X):${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                             `[ ] ACEPTO TARIFA FIJA${LB}` +
                             `    Ahorro: ${eur(ahorroFijo)}${LB}` +
                             `    Coste mensual: ${eur(resFijo.totalAnnual / 12)}${LB}${LB}` +
                             `[ ] ACEPTO TARIFA INDEXADA${LB}` +
                             `    Ahorro: ${eur(ahorroIndexado)}${LB}` +
                             `    Coste mensual: ${eur(resIndexed.totalAnnual / 12)}${LB}${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                             `üë§ DATOS DEL TITULAR${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                             `üìõ Nombre: ${clientName}${LB}` +
                             `üì± Tel√©fono: ${clientPhone}${LB}` +
                             `üìß Email: ${clientEmail}${LB}${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                             `üìé DOCUMENTACI√ìN ADJUNTA${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                             `‚úì DNI/CIF (anverso y reverso)${LB}` +
                             `‚úì √öltima factura${LB}` +
                             `‚úì Email ¬∑ Tel√©fono ¬∑ IBAN${LB}${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                             `Quedo a la espera de confirmaci√≥n.${LB}${LB}` +
                             `Atentamente,${LB}${clientName}${LB}${LB}` +
                             `Comercial: ${commercialCode}`;
            
            const subject = `‚úÖ FORMALIZACI√ìN - ${resFijo.cups} - ${brand.NAME.toUpperCase()}`;
            const formalizationRecipients = 'f.araujo@drk.es,r.guerra@drk.es,s.caballero@drk.es';
            const formalizationLink = `mailto:${formalizationRecipients}?subject=${encodeURIComponent(subject)}&body=${emailBody}`;
            
            return `
                <div style="max-width: 900px; margin: 0 auto; font-family: Arial, sans-serif; background-color: #f8f9fa; padding: 20px;">
                    
                    <!-- HEADER ESTILO PDF -->
                    ${isPowerCup ? `
                        <!-- POWER CUP Header -->
                        <div style="border: 3px solid #84cc16; background-color: white; padding: 25px 30px; border-radius: 8px; margin-bottom: 20px;">
                            <table cellpadding="0" cellspacing="0" width="100%">
                                <tr>
                                    <td style="width: 50%; vertical-align: middle;">
                                        <h1 style="color: #3f6212; font-size: 42px; font-weight: bold; margin: 0; letter-spacing: -1px;">POWER CUP</h1>
                                        <p style="color: #65a30d; font-size: 16px; margin: 8px 0 0 0; font-weight: 600;">Asesor√≠a Energ√©tica</p>
                                    </td>
                                    <td style="width: 50%; text-align: right; vertical-align: middle;">
                                        <p style="color: #84cc16; font-size: 13px; margin: 0 0 5px 0; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px;">ESTUDIO DE AHORRO</p>
                                        <p style="color: #3f6212; font-size: 18px; margin: 0; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    ` : `
                        <!-- DRK Header -->
                        <div style="background-color: #2e5266; padding: 25px 30px; border-radius: 8px; margin-bottom: 20px;">
                            <table cellpadding="0" cellspacing="0" width="100%">
                                <tr>
                                    <td style="width: 50%; vertical-align: middle;">
                                        <h1 style="color: white; font-size: 42px; font-weight: bold; margin: 0; letter-spacing: -1px;">DRK ENERG√çA</h1>
                                        <p style="color: rgba(255,255,255,0.9); font-size: 16px; margin: 8px 0 0 0;">Liderando el ahorro y la eficiencia energ√©tica.</p>
                                    </td>
                                    <td style="width: 50%; text-align: right; vertical-align: middle;">
                                        <p style="color: rgba(255,255,255,0.8); font-size: 13px; margin: 0 0 5px 0; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px;">ESTUDIO DE AHORRO</p>
                                        <p style="color: white; font-size: 18px; margin: 0; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    `}
                    
                    <!-- CAJA PRINCIPAL -->
                    <div style="background-color: white; padding: 30px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="background-color: ${HEADER_BLUE}; color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 25px;">
                            <p style="margin: 0 0 8px 0; font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9;"${tr("LA MEJOR OPCI√ìN PARA TI ES")}</p>
                            <h2 style="margin: 0; font-size: 32px; font-weight: bold;">${BRAND_DISPLAY}</h2>
                            <p style="margin: 8px 0 0 0; font-size: 12px; opacity: 0.95;">${tr('Ofrece el mayor ahorro consolidado con')} ${brand.NAME.toUpperCase()}.</p>
                        </div>
                        
                        <!-- TRES COLUMNAS -->
                        <table cellpadding="0" cellspacing="0" width="100%" style="margin-bottom: 20px;">
                            <tr>
                                <!-- FACTURA ACTUAL -->
                                <td style="width: 30%; vertical-align: top; text-align: center; padding: 0 10px;">
                                    <div style="padding: 15px; border-right: 1px solid #e5e7eb;">
                                        <p style="margin: 0 0 8px 0; font-size: 10px; color: #6b7280; font-weight: 600; text-transform: uppercase;"${tr("TU FACTURA ACTUAL")}</p>
                                        <div style="margin: 10px 0;">
                                            <p style="margin: 0; font-size: 20px; font-weight: bold; color: ${RED_CTA}; text-decoration: line-through;">${eur(resFijo.originalBillPeriod)}</p>
                                            <p style="margin: 3px 0 0 0; font-size: 9px; color: #9ca3af;"${tr("Total Periodo")}</p>
                                        </div>
                                        <div style="margin-top: 12px;">
                                            <p style="margin: 0; font-size: 20px; font-weight: bold; color: ${RED_CTA}; text-decoration: line-through;">${eur(resFijo.originalBillAnnual)}${tr("/a√±o")}</p>
                                        </div>
                                    </div>
                                </td>
                                
                                <!-- AHORRO FIJO -->
                                <td style="width: 35%; vertical-align: top; text-align: center; padding: 0 10px;">
                                    <div style="background-color: ${DRK_BLUE}; color: white; padding: 10px 8px; border-radius: 8px 8px 0 0;">
                                        <p style="margin: 0; font-size: 9px; font-weight: bold; text-transform: uppercase;">${tr("TU AHORRO ANUAL FIJO")}</p>
                                    </div>
                                    <div style="padding: 15px 10px;">
                                        <p style="margin: 0; font-size: 32px; font-weight: bold; color: ${GREEN_SAVE};">${eur(ahorroFijo)}</p>
                                        <div style="margin: 15px 0 0 0;">
                                            <p style="margin: 0 0 3px 0; font-size: 10px; color: #6b7280; font-weight: 600;">${tr('TU NUEVO COSTE')} ${BRAND_DISPLAY}</p>
                                            <p style="margin: 0; font-size: 22px; font-weight: bold; color: ${DRK_BLUE};">${eur(resFijo.totalAnnual / 12)}${tr("/mes")}</p>
                                            <p style="margin: 3px 0 0 0; font-size: 8px; color: #9ca3af;"${tr("Estimado Mensual")}</p>
                                            <p style="margin: 10px 0 0 0; font-size: 20px; font-weight: bold; color: ${DRK_BLUE};">${eur(resFijo.totalAnnual)}${tr("/a√±o")}</p>
                                        </div>
                                    </div>
                                </td>
                                
                                <!-- AHORRO INDEXADO -->
                                <td style="width: 35%; vertical-align: top; text-align: center; padding: 0 10px;">
                                    <div style="background-color: ${GREEN_SAVE}; color: white; padding: 10px 8px; border-radius: 8px 8px 0 0;">
                                        <p style="margin: 0; font-size: 9px; font-weight: bold; text-transform: uppercase;">${tr("TU AHORRO ANUAL INDEXADO")}</p>
                                    </div>
                                    <div style="padding: 15px 10px;">
                                        <p style="margin: 0; font-size: 32px; font-weight: bold; color: ${GREEN_SAVE};">${eur(ahorroIndexado)}</p>
                                        <div style="margin: 15px 0 0 0;">
                                            <p style="margin: 0 0 3px 0; font-size: 10px; color: #6b7280; font-weight: 600;">${tr('TU NUEVO COSTE')} ${BRAND_DISPLAY}</p>
                                            <p style="margin: 0; font-size: 22px; font-weight: bold; color: ${GREEN_SAVE};">${eur(resIndexed.totalAnnual / 12)}${tr("/mes")}</p>
                                            <p style="margin: 3px 0 0 0; font-size: 8px; color: #9ca3af;"${tr("Estimado Mensual")}</p>
                                            <p style="margin: 10px 0 0 0; font-size: 20px; font-weight: bold; color: ${GREEN_SAVE};">${eur(resIndexed.totalAnnual)}${tr("/a√±o")}</p>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- DESGLOSE DETALLADO -->
                    <div style="background-color: ${HEADER_BLUE}; color: white; padding: 12px 20px; margin: 25px 0 15px 0; border-radius: 12px; text-align: center;">
                        <div style="font-size: 14px; font-weight: bold; letter-spacing: 1px;">DESGLOSE DETALLADO POR SUMINISTRO</div>
                    </div>
                    
                    <table cellpadding="0" cellspacing="0" width="100%" style="margin-bottom: 30px;">
                        <tr>
                            <!-- COLUMNA FIJO -->
                            <td style="width: 48%; vertical-align: top; padding-right: 10px;">
                                <div style="border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; background-color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.07);">
                                    <div style="background-color: ${SLATE_DARK}; color: white; padding: 12px;">
                                        <div style="font-size: 10px; font-weight: bold; margin-bottom: 3px;">[${resFijo.cups}]</div>
                                        <div style="font-size: 9px; opacity: 0.9;">Tipo: ${resFijo.originalTariffType} | D√≠as: ${resFijo.dias_facturados}</div>
                                        <div style="font-size: 9px; margin-top: 4px; opacity: 0.95;">${BRAND_DISPLAY} - ${resFijo.offer.name}</div>
                                    </div>
                                    
                                    <div style="background-color: ${SLATE_MED}; color: white; padding: 10px;">
                                        <div style="font-size: 10px; font-weight: bold; margin-bottom: 5px;">PRECIOS APLICADOS:</div>
                                        <div style="font-size: 9px;">${preciosFijoHtml}</div>
                                    </div>
                                    
                                    <div style="background-color: ${SLATE_MED}; color: white; padding: 8px; margin-top: 1px; font-size: 10px; font-weight: bold;">POTENCIA</div>
                                    <div style="padding: 10px; background-color: #f8fafc;">${detallesFijoHtml}</div>
                                    
                                    <div style="background-color: ${SLATE_MED}; color: white; padding: 8px; margin-top: 6px; font-size: 10px; font-weight: bold;">ENERG√çA</div>
                                    <div style="padding: 10px; background-color: #f8fafc;">${energiaFijoHtml}</div>
                                    
                                    <div style="background-color: ${SLATE_DARK}; color: white; padding: 12px; display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                                        <span style="font-size: 11px; font-weight: bold;">TOTAL (${resFijo.dias_facturados} D√çAS)</span>
                                        <span style="font-size: 13px; font-weight: bold;">${eur(resFijo.totalPeriod)}</span>
                                    </div>
                                    
                                    <div style="background-color: ${RED_CTA}; color: white; padding: 12px; text-align: center; border-radius: 0 0 12px 12px;">
                                        <div style="font-size: 10px; font-weight: bold; margin-bottom: 3px;">AHORRO:</div>
                                        <div style="font-size: 18px; font-weight: bold;">${eur(ahorroFijo)}</div>
                                    </div>
                                </div>
                            </td>
                            
                            <!-- COLUMNA INDEXADO -->
                            <td style="width: 48%; vertical-align: top; padding-left: 10px;">
                                <div style="border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; background-color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.07);">
                                    <div style="background-color: ${SLATE_DARK}; color: white; padding: 12px;">
                                        <div style="font-size: 10px; font-weight: bold; margin-bottom: 3px;">[${resIndexed.cups}]</div>
                                        <div style="font-size: 9px; opacity: 0.9;">Tipo: ${resIndexed.originalTariffType} | D√≠as: ${resIndexed.dias_facturados}</div>
                                        <div style="font-size: 9px; margin-top: 4px; opacity: 0.95;">${BRAND_DISPLAY} INDEX - ${resIndexed.offer.name}</div>
                                    </div>
                                    
                                    <div style="background-color: ${SLATE_MED}; color: white; padding: 10px;">
                                        <div style="font-size: 10px; font-weight: bold; margin-bottom: 5px;">PRECIOS APLICADOS:</div>
                                        <div style="font-size: 9px;">${preciosIndexadoHtml}</div>
                                    </div>
                                    
                                    <div style="background-color: ${SLATE_MED}; color: white; padding: 8px; margin-top: 1px; font-size: 10px; font-weight: bold;">POTENCIA</div>
                                    <div style="padding: 10px; background-color: #f8fafc;">${detallesIndexadoHtml}</div>
                                    
                                    <div style="background-color: ${SLATE_MED}; color: white; padding: 8px; margin-top: 6px; font-size: 10px; font-weight: bold;">ENERG√çA</div>
                                    <div style="padding: 10px; background-color: #f8fafc;">${energiaIndexadoHtml}</div>
                                    
                                    <div style="background-color: ${SLATE_DARK}; color: white; padding: 12px; display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                                        <span style="font-size: 11px; font-weight: bold;">TOTAL (${resIndexed.dias_facturados} D√çAS)</span>
                                        <span style="font-size: 13px; font-weight: bold;">${eur(resIndexed.totalPeriod)}</span>
                                    </div>
                                    
                                    <div style="background-color: ${RED_CTA}; color: white; padding: 12px; text-align: center; border-radius: 0 0 12px 12px;">
                                        <div style="font-size: 10px; font-weight: bold; margin-bottom: 3px;">AHORRO:</div>
                                        <div style="font-size: 18px; font-weight: bold;">${eur(ahorroIndexado)}</div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- EXPLICACI√ìN -->
                    <div style="background-color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.07);">
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: bold; text-align: center; color: #1f2937;">CUAL ES LA DIFERENCIA?</h3>
                        
                        <table cellpadding="0" cellspacing="0" width="100%">
                            <tr>
                                <td style="width: 48%; vertical-align: top; padding-right: 15px;">
                                    <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: bold; color: ${DRK_BLUE};">POR QUE TARIFA FIJA?</h4>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 12px; line-height: 1.8; color: #374151;">
                                        <li>Implica un precio fijo por los kilovatios que consumes (kWh).</li>
                                        <li>El precio se mantiene estable, independientemente de c√≥mo se comporten los precios en el mercado el√©ctrico.</li>
                                        <li>Cuando el precio del mercado est√° alto, el cliente est√° protegido frente a sobresaltos.</li>
                                        <li>No tendr√°s que estar pendiente de las variaciones del mercado y podr√°s seguir usando la electricidad como siempre.</li>
                                    </ul>
                                </td>
                                <td style="width: 4%;"></td>
                                <td style="width: 48%; vertical-align: top; padding-left: 15px;">
                                    <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: bold; color: ${GREEN_SAVE};">POR QUE TARIFA INDEXADA?</h4>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 12px; line-height: 1.8; color: #374151;">
                                        <li>Implica un precio variable por los kilovatios que consumes (kWh) cada mes.</li>
                                        <li>Es la tarifa m√°s justa, ya que pagas el coste real de la energ√≠a mes a mes.</li>
                                        <li>Al contratarla, el cliente evita pagar m√°rgenes adicionales cuando el precio de la electricidad es m√°s barato.</li>
                                        <li>A largo plazo, con un indexado 100% funcional, se puede obtener un ahorro aproximado de hasta un 20% en √©pocas de mejor precio.</li>
                                    </ul>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- BOT√ìN EMAIL -->
                    <div style="background-color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.07); border: 3px solid ${isPowerCup ? '#84cc16' : '#0ea5e9'};">
                        <div style="text-align: center;">
                            <div style="margin-bottom: 15px;">
                                <span style="font-size: 20px; margin-right: 8px;">üìä</span>
                                <span style="font-size: 16px; font-weight: bold; color: ${isPowerCup ? '#3f6212' : '#0c4a6e'};">
                                    Para formalizar esta oferta:
                                </span>
                            </div>
                            
                            <ol style="margin: 20px 0; padding-left: 20px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto; font-size: 14px; color: #374151; line-height: 2;">
                                <li>${tr('Haz clic en el bot√≥n de abajo')}</li>
                                <li>${tr('Se abrir√° tu cliente de email')}</li>
                                <li><strong style="color: ${isPowerCup ? '#3f6212' : '#0c4a6e'};">${tr('Adjunta la documentaci√≥n requerida')}</strong></li>
                                <li>${tr('Env√≠a el email')}</li>
                            </ol>
                            
                            <a href="${formalizationLink}" style="display: inline-block; background-color: ${RED_CTA}; color: white; padding: 18px 40px; border-radius: 12px; text-decoration: none; font-size: 16px; font-weight: bold; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3); margin: 20px 0;">
                                ${tr('‚úÖ CONFIRMAR Y ENVIAR')}
                            </a>
                            
                            <div style="margin-top: 20px; padding: 15px; background-color: #f3f4f6; border-radius: 8px;">
                                <p style="margin: 0 0 8px 0; font-size: 12px; color: #6b7280;">
                                    <strong>üìé Por cada CUPS adjuntar:</strong>
                                </p>
                                <p style="margin: 0; font-size: 11px; color: #6b7280;">
                                    DNI/CIF ¬∑ √öltima factura ¬∑ Email ¬∑ Tel√©fono ¬∑ IBAN
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- FOOTER -->
                    <div style="background-color: #f3f4f6; padding: 15px; border-radius: 8px; text-align: center;">
                        <p style="margin: 0 0 5px 0; font-size: 11px; color: #6b7280;">Comercial: <strong>${commercialCode}</strong></p>
                        <p style="margin: 0; font-size: 9px; color: #9ca3af;">Documento generado por ${brand.NAME.toUpperCase()}</p>
                    </div>
                    
                </div>
            `;
        }
        
        function generateMultiDualStyledHtmlOffer(commercialCode) {
            const res = lastComparisonResult;
            const brand = activeBrand;
            
            const eur = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
            
            // DETECCI√ìN DE POWER CUP para cambiar colores
            const isPowerCup = brand.NAME.includes('POWER');
            
            // Colores din√°micos seg√∫n la marca - TODO EN VERDE OLIVA PARA POWER CUP
            const HEADER_BLUE = isPowerCup ? '#738257' : '#6B7D8E';  // Verde oliva para PowerCup
            const DRK_BLUE = isPowerCup ? '#84cc16' : '#0ea5e9';     // Verde para PowerCup
            const GREEN_SAVE = '#16a34a';
            const RED_CTA = '#DC2626';
            const SLATE_DARK = isPowerCup ? '#5a6b47' : '#475569';   // Verde oliva oscuro para PowerCup
            const SLATE_MED = isPowerCup ? '#738257' : '#64748b';    // Verde oliva medio para PowerCup
            
            const BRAND_DISPLAY = isPowerCup ? 'POWER CUP' : 'DRK';  // Nombre a mostrar
            
            const clientName = document.getElementById('client-name-input').value.trim() || '[NOMBRE COMPLETO CLIENTE]';
            const clientPhone = document.getElementById('client-phone-input').value.trim() || '[TEL√âFONO CLIENTE]';
            const clientEmail = document.getElementById('client-email-input').value.trim() || '[EMAIL CLIENTE]';
            
            const ahorroFijo = res.savings;
            const ahorroIndexado = res.indexedTotals ? res.indexedTotals.savings : 0;
            
            let facturaActualTotal = 0;
            let nuevoCosteAnualFijo = 0;
            let nuevoCosteAnualIndexado = 0;
            
            res.individualResults.forEach(supply => {
                facturaActualTotal += supply.originalBillAnnual || 0;
                nuevoCosteAnualFijo += supply.totalAnnual || 0;
                if (supply.indexedComparison) {
                    nuevoCosteAnualIndexado += supply.indexedComparison.totalAnnual || 0;
                }
            });
            
            // Generar emailBody para MULTICUPS con PRECIOS DETALLADOS
            const LB = '%0A';
            let cupsList = '';
            res.individualResults.forEach((supply, idx) => {
                cupsList += `   ${idx + 1}. ${supply.cups}${LB}`;
            });
            
            // Generar desglose detallado de precios por cada CUPS
            let preciosDetalladosHtml = '';
            res.individualResults.forEach((supply, idx) => {
                const tieneIndexado = supply.indexedComparison && 
                                     supply.indexedComparison.powerCosts && 
                                     supply.indexedComparison.energyCosts;
                
                if (tieneIndexado) {
                    preciosDetalladosHtml += `${LB}‚îÅ‚îÅ‚îÅ CUPS ${idx + 1}: ${supply.cups} ‚îÅ‚îÅ‚îÅ${LB}${LB}`;
                    
                    // OPCI√ìN FIJA
                    preciosDetalladosHtml += `üìò OPCI√ìN FIJA (${supply.offer.name || 'DRK FIJO'}):${LB}`;
                    preciosDetalladosHtml += `   Potencia:${LB}`;
                    supply.powerCosts.forEach((p, i) => {
                        if (p.kw > 0) {
                            preciosDetalladosHtml += `   ‚Ä¢ P${i+1}: ${numPriceFormula(p.priceDay)} ‚Ç¨/kW/d√≠a${LB}`;
                        }
                    });
                    preciosDetalladosHtml += `${LB}   Energ√≠a:${LB}`;
                    supply.energyCosts.forEach((e, i) => {
                        if (e.kwh > 0) {
                            let label = `E${i+1}`;
                            if (supply.originalTariffType === '2.0TD') {
                                if (i === 0) label += ' (Punta)';
                                else if (i === 1) label += ' (Llano)';
                                else if (i === 2) label += ' (Valle)';
                            }
                            preciosDetalladosHtml += `   ‚Ä¢ ${label}: ${numPriceFormula(e.price)} ‚Ç¨/kWh${LB}`;
                        }
                    });
                    preciosDetalladosHtml += `${LB}   üìä Coste Anual: ${eur(supply.totalAnnual / 12)}/mes (${eur(supply.totalAnnual)}/a√±o)${LB}`;
                    preciosDetalladosHtml += `   üí∞ Ahorro: ${eur(supply.savings)}${LB}${LB}`;
                    
                    // OPCI√ìN INDEXADA
                    const indexData = supply.indexedComparison;
                    preciosDetalladosHtml += `üìó OPCI√ìN INDEXADA (${indexData.offer.name || 'DRK INDEX'}):${LB}`;
                    preciosDetalladosHtml += `   Potencia:${LB}`;
                    indexData.powerCosts.forEach((p, i) => {
                        if (p.kw > 0) {
                            preciosDetalladosHtml += `   ‚Ä¢ P${i+1}: ${numPriceFormula(p.priceDay)} ‚Ç¨/kW/d√≠a${LB}`;
                        }
                    });
                    preciosDetalladosHtml += `${LB}   Energ√≠a:${LB}`;
                    indexData.energyCosts.forEach((e, i) => {
                        if (e.kwh > 0) {
                            let label = `E${i+1}`;
                            if (supply.originalTariffType === '2.0TD') {
                                if (i === 0) label += ' (Punta)';
                                else if (i === 1) label += ' (Llano)';
                                else if (i === 2) label += ' (Valle)';
                            }
                            preciosDetalladosHtml += `   ‚Ä¢ ${label}: ${numPriceFormula(e.price)} ‚Ç¨/kWh${LB}`;
                        }
                    });
                    preciosDetalladosHtml += `${LB}   üìä Coste Anual: ${eur(indexData.totalAnnual / 12)}/mes (${eur(indexData.totalAnnual)}/a√±o)${LB}`;
                    preciosDetalladosHtml += `   üí∞ Ahorro: ${eur(indexData.savings)}${LB}${LB}`;
                }
            });
            
            const emailBody = `‚úÖ CONFIRMACI√ìN DE ACEPTACI√ìN DE OFERTA MULTICUPS${LB}${LB}` +
                             `Estimado equipo de ${brand.NAME.toUpperCase()},${LB}${LB}` +
                             `Confirmo mi aceptaci√≥n de la oferta energ√©tica consolidada que detallo a continuaci√≥n:${LB}${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                             `üìã DATOS DE LOS SUMINISTROS${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                             `üìä Total de CUPS: ${res.cups}${LB}${LB}` +
                             `üîå CUPS incluidos:${LB}${cupsList}${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                             `üí∞ COMPARACI√ìN DE AHORROS${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                             `üíº Ahorro Total con Tarifas FIJAS: ${eur(ahorroFijo)}${LB}` +
                             `   Nuevo Coste Anual: ${eur(nuevoCosteAnualFijo)} (${eur(nuevoCosteAnualFijo / 12)}/mes)${LB}${LB}` +
                             `‚ö° Ahorro Total con Tarifas INDEXADAS: ${eur(ahorroIndexado)}${LB}` +
                             `   Nuevo Coste Anual: ${eur(nuevoCosteAnualIndexado)} (${eur(nuevoCosteAnualIndexado / 12)}/mes)${LB}${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                             `üí° PRECIOS DETALLADOS POR CUPS${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${preciosDetalladosHtml}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                             `‚úÖ MI DECISI√ìN (Marca con X):${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                             `[ ] ACEPTO TARIFAS FIJAS para todos los CUPS${LB}` +
                             `    Ahorro total: ${eur(ahorroFijo)}${LB}` +
                             `    Coste mensual estimado: ${eur(nuevoCosteAnualFijo / 12)}${LB}${LB}` +
                             `[ ] ACEPTO TARIFAS INDEXADAS para todos los CUPS${LB}` +
                             `    Ahorro total: ${eur(ahorroIndexado)}${LB}` +
                             `    Coste mensual estimado: ${eur(nuevoCosteAnualIndexado / 12)}${LB}${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                             `üë§ DATOS DEL TITULAR${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                             `üìõ Nombre completo: ${clientName}${LB}` +
                             `üì± Tel√©fono: ${clientPhone}${LB}` +
                             `üìß Email: ${clientEmail}${LB}${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                             `üìé DOCUMENTACI√ìN ADJUNTA (Por cada CUPS)${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                             `Adjunto la siguiente documentaci√≥n para formalizar los ${res.cups} contratos:${LB}${LB}` +
                             `‚úì DNI/CIF (anverso y reverso)${LB}` +
                             `‚úì √öltima factura de cada CUPS${LB}` +
                             `‚úì Email ¬∑ Tel√©fono ¬∑ IBAN${LB}${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                             `üí¨ COMENTARIOS ADICIONALES${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                             `[Escriba aqu√≠ cualquier observaci√≥n o consulta adicional]${LB}${LB}` +
                             `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                             `Quedo a la espera de la confirmaci√≥n de la formalizaci√≥n de los contratos.${LB}${LB}` +
                             `Atentamente,${LB}` +
                             `${clientName}${LB}${LB}` +
                             `Comercial: ${commercialCode}`;
            
            const subject = `‚úÖ FORMALIZACI√ìN MULTICUPS - ${res.cups} CUPS - ${brand.NAME.toUpperCase()}`;
            const formalizationRecipients = 'f.araujo@drk.es,r.guerra@drk.es,s.caballero@drk.es';
            const formalizationLink = `mailto:${formalizationRecipients}?subject=${encodeURIComponent(subject)}&body=${emailBody}`;
            
            function generarColumnaDesglosePro(supply, isIndexed) {
                const data = isIndexed ? supply.indexedComparison : supply;
                if (!data || !data.powerCosts || !data.energyCosts) return '';
                
                // Usar el nombre correcto de la marca
                const marcaNombre = isPowerCup ? 'POWER CUP' : 'DRK';
                const nombreTarifa = isIndexed ? 
                    `${marcaNombre} INDEX - ${data.offer.name || (isPowerCup ? 'POWER CUP INDEX 4 2026' : 'DRK INDEX 4 2026')}` : 
                    `${marcaNombre} - ${data.offer.name || (isPowerCup ? 'POWER CUP FIJO 6 META 4' : 'DRK FIJO 6 META 4')}`;
                
                let htmlPotencia = '';
                data.powerCosts.forEach((p, idx) => {
                    if (p.kw > 0) {
                        htmlPotencia += `
                            <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; color: #374151;">
                                <span>P${idx+1}: (${num(p.kw, 2)} kW x ${numPriceFormula(p.priceDay)} ‚Ç¨/kW/d√≠a)</span>
                                <span style="font-weight: bold;">${num(p.cost, 2)} ‚Ç¨</span>
                            </div>
                        `;
                    }
                });
                
                let htmlEnergia = '';
                data.energyCosts.forEach((e, idx) => {
                    if (e.kwh > 0) {
                        let label = `E${idx+1}`;
                        if (supply.originalTariffType === '2.0TD') {
                            if (idx === 0) label += ' (Punta)';
                            else if (idx === 1) label += ' (Llano)';
                            else if (idx === 2) label += ' (Valle)';
                        }
                        htmlEnergia += `
                            <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; color: #374151;">
                                <span>${label}: (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)} ‚Ç¨/kWh)</span>
                                <span style="font-weight: bold;">${num(e.cost, 2)} ‚Ç¨</span>
                            </div>
                        `;
                    }
                });
                
                let preciosPotenciaHtml = '';
                data.powerCosts.forEach((p, idx) => {
                    preciosPotenciaHtml += `<div style="font-size: 9px;">P${idx+1}: ${numPriceFormula(p.priceDay)} ‚Ç¨/kW/d√≠a</div>`;
                });
                
                let preciosEnergiaHtml = '';
                data.energyCosts.forEach((e, idx) => {
                    preciosEnergiaHtml += `<div style="font-size: 9px;">E${idx+1}: ${numPriceFormula(e.price)} ‚Ç¨/kWh</div>`;
                });
                
                return `
                    <div style="border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; background-color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.07);">
                        <div style="background-color: ${SLATE_DARK}; color: white; padding: 12px; border-radius: 12px 12px 0 0;">
                            <div style="font-size: 10px; font-weight: bold; margin-bottom: 3px;">[${data.cups}]</div>
                            <div style="font-size: 9px; opacity: 0.9;">Tipo: ${data.originalTariffType} | D√≠as: ${data.dias_facturados}</div>
                            <div style="font-size: 9px; margin-top: 4px; opacity: 0.95;">${nombreTarifa}</div>
                        </div>
                        
                        <div style="background-color: ${SLATE_MED}; color: white; padding: 10px;">
                            <div style="font-size: 10px; font-weight: bold; margin-bottom: 5px;">PRECIOS APLICADOS:</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <div>
                                    <div style="font-size: 9px; font-weight: bold; margin-bottom: 3px;">POTENCIA:</div>
                                    ${preciosPotenciaHtml}
                                </div>
                                <div>
                                    <div style="font-size: 9px; font-weight: bold; margin-bottom: 3px;">ENERG√çA:</div>
                                    ${preciosEnergiaHtml}
                                </div>
                            </div>
                        </div>
                        
                        <div style="background-color: ${SLATE_MED}; color: white; padding: 8px; margin-top: 1px; font-size: 10px; font-weight: bold;">
                            POTENCIA
                        </div>
                        <div style="padding: 10px; background-color: #f8fafc;">
                            ${htmlPotencia}
                        </div>
                        
                        <div style="background-color: ${SLATE_MED}; color: white; padding: 8px; margin-top: 6px; font-size: 10px; font-weight: bold;">
                            ENERG√çA
                        </div>
                        <div style="padding: 10px; background-color: #f8fafc;">
                            ${htmlEnergia}
                        </div>
                        
                        <div style="background-color: ${SLATE_DARK}; color: white; padding: 12px; display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                            <span style="font-size: 11px; font-weight: bold;">TOTAL (${data.dias_facturados} D√çAS)</span>
                            <span style="font-size: 13px; font-weight: bold;">${eur(data.totalPeriod)}</span>
                        </div>
                        
                        <div style="background-color: ${RED_CTA}; color: white; padding: 12px; text-align: center; border-radius: 0 0 12px 12px;">
                            <div style="font-size: 10px; font-weight: bold; margin-bottom: 3px;">AHORRO:</div>
                            <div style="font-size: 18px; font-weight: bold;">${eur(data.savings)}</div>
                        </div>
                    </div>
                `;
            }
            
            let desarrolloDetalladoHtml = '';
            res.individualResults.forEach((supply, idx) => {
                const tieneIndexado = supply.indexedComparison && 
                                     supply.indexedComparison.powerCosts && 
                                     supply.indexedComparison.energyCosts;
                
                if (tieneIndexado) {
                    desarrolloDetalladoHtml += `
                        <div style="background-color: ${HEADER_BLUE}; color: white; padding: 12px 20px; margin: 25px 0 15px 0; border-radius: 12px; text-align: center;">
                            <div style="font-size: 14px; font-weight: bold; letter-spacing: 1px;">DESARROLLO DETALLADO - SUMINISTRO ${idx + 1} DE ${res.individualResults.length}</div>
                        </div>
                        
                        <table cellpadding="0" cellspacing="0" width="100%" style="margin-bottom: 30px;">
                            <tr>
                                <td style="width: 48%; vertical-align: top; padding-right: 10px;">
                                    ${generarColumnaDesglosePro(supply, false)}
                                </td>
                                <td style="width: 4%;"></td>
                                <td style="width: 48%; vertical-align: top; padding-left: 10px;">
                                    ${generarColumnaDesglosePro(supply, true)}
                                </td>
                            </tr>
                        </table>
                    `;
                }
            });
            
            let resumenTablaFijoHtml = '';
            let resumenTablaIndexadoHtml = '';
            
            res.individualResults.forEach((supply, idx) => {
                const ahorroFijoSupply = supply.savings || 0;
                const ahorroIndexadoSupply = supply.indexedComparison ? supply.indexedComparison.savings : 0;
                
                resumenTablaFijoHtml += `
                    <tr style="background-color: ${idx % 2 === 0 ? '#ffffff' : '#f9fafb'};">
                        <td style="padding: 8px; font-size: 11px; border-bottom: 1px solid #e5e7eb;">${supply.cups}</td>
                        <td style="padding: 8px; font-size: 11px; border-bottom: 1px solid #e5e7eb;">${BRAND_DISPLAY}</td>
                        <td style="padding: 8px; font-size: 12px; font-weight: bold; text-align: right; border-bottom: 1px solid #e5e7eb; color: ${GREEN_SAVE};">${eur(ahorroFijoSupply)}</td>
                    </tr>
                `;
                
                resumenTablaIndexadoHtml += `
                    <tr style="background-color: ${idx % 2 === 0 ? '#ffffff' : '#f9fafb'};">
                        <td style="padding: 8px; font-size: 11px; border-bottom: 1px solid #e5e7eb;">${supply.cups}</td>
                        <td style="padding: 8px; font-size: 11px; border-bottom: 1px solid #e5e7eb;">${BRAND_DISPLAY} INDEX</td>
                        <td style="padding: 8px; font-size: 12px; font-weight: bold; text-align: right; border-bottom: 1px solid #e5e7eb; color: ${GREEN_SAVE};">${eur(ahorroIndexadoSupply)}</td>
                    </tr>
                `;
            });
            
            return `
                <div style="max-width: 900px; margin: 0 auto; font-family: Arial, sans-serif; background-color: #f8f9fa; padding: 20px;">
                    
                    <table cellpadding="0" cellspacing="0" width="100%" style="background: linear-gradient(135deg, ${HEADER_BLUE} 0%, #8B9AA8 100%); border-radius: 16px 16px 0 0; margin-bottom: 0;">
                        <tr>
                            <td style="padding: 25px 30px;">
                                <table cellpadding="0" cellspacing="0" width="100%">
                                    <tr>
                                        <td style="vertical-align: middle; width: 60%;">
                                            <div style="background-color: white; width: 50px; height: 50px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 10px;">
                                                <span style="font-size: 24px;">‚ö°</span>
                                            </div>
                                            <h1 style="color: white; font-size: 16px; margin: 0 0 5px 0; font-weight: normal; letter-spacing: 0.5px;">
                                                ${brand.NAME.toUpperCase()}
                                            </h1>
                                            <p style="color: rgba(255,255,255,0.9); font-size: 11px; margin: 0;">Liderando el ahorro y la eficiencia energ√©tica.</p>
                                        </td>
                                        <td style="text-align: right; vertical-align: middle; width: 40%;">
                                            <p style="color: rgba(255,255,255,0.7); font-size: 9px; margin: 0 0 5px 0; text-transform: uppercase; font-weight: bold;">MULTICUPS</p>
                                            <p style="color: white; font-size: 12px; margin: 0; font-weight: bold;">FIJO VS INDEXADO</p>
                                            <p style="color: rgba(255,255,255,0.9); font-size: 10px; margin: 5px 0 0 0;">Total: ${res.cups} CUPS</p>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                    
                    <div style="background-color: white; padding: 15px 30px; border-bottom: 2px solid #e5e7eb;">
                        <p style="margin: 0; font-size: 12px; color: #374151;"><strong${tr("CLIENTE:")}</strong> ${clientName}</p>
                        <p style="margin: 5px 0 0 0; font-size: 11px; color: #6b7280;">CUPS TOTALES: ${res.cups} CUPS</p>
                    </div>
                    
                    <div style="background-color: white; padding: 30px; border-radius: 0 0 16px 16px; margin-bottom: 20px;">
                        <div style="background-color: ${HEADER_BLUE}; color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 25px;">
                            <p style="margin: 0 0 8px 0; font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9;"${tr("LA MEJOR OPCI√ìN PARA TI ES")}</p>
                            <h2 style="margin: 0; font-size: 32px; font-weight: bold;">${BRAND_DISPLAY}</h2>
                            <p style="margin: 8px 0 0 0; font-size: 12px; opacity: 0.95;">${tr('Ofrece el mayor ahorro consolidado con')} ${brand.NAME.toUpperCase()}.</p>
                        </div>
                        
                        <table cellpadding="0" cellspacing="0" width="100%" style="margin-bottom: 20px;">
                            <tr>
                                <td style="width: 30%; vertical-align: top; text-align: center; padding: 0 10px;">
                                    <div style="padding: 15px; border-right: 1px solid #e5e7eb;">
                                        <p style="margin: 0 0 8px 0; font-size: 10px; color: #6b7280; font-weight: 600; text-transform: uppercase;"${tr("TU FACTURA ACTUAL")}</p>
                                        <div style="margin: 10px 0;">
                                            <p style="margin: 0; font-size: 24px; font-weight: bold; color: ${RED_CTA}; text-decoration: line-through;">${eur(facturaActualTotal)}</p>
                                            <p style="margin: 3px 0 0 0; font-size: 9px; color: #9ca3af;"${tr("Total Periodo")}</p>
                                        </div>
                                        <div style="margin-top: 12px;">
                                            <p style="margin: 0; font-size: 20px; font-weight: bold; color: ${RED_CTA}; text-decoration: line-through;">${eur(facturaActualTotal)}${tr("/a√±o")}</p>
                                        </div>
                                    </div>
                                </td>
                                
                                <td style="width: 35%; vertical-align: top; text-align: center; padding: 0 10px;">
                                    <div style="background-color: ${DRK_BLUE}; color: white; padding: 10px 8px; border-radius: 8px 8px 0 0;">
                                        <p style="margin: 0; font-size: 9px; font-weight: bold; text-transform: uppercase;">${tr("TU AHORRO ANUAL FIJO")}</p>
                                    </div>
                                    <div style="padding: 15px 10px;">
                                        <p style="margin: 0; font-size: 32px; font-weight: bold; color: ${GREEN_SAVE};">${eur(ahorroFijo)}</p>
                                        <div style="margin: 15px 0 0 0;">
                                            <p style="margin: 0 0 3px 0; font-size: 10px; color: #6b7280; font-weight: 600;"${tr("TU NUEVO COSTE DRK")}</p>
                                            <p style="margin: 0; font-size: 22px; font-weight: bold; color: ${DRK_BLUE};">${eur(nuevoCosteAnualFijo / 12)}${tr("/mes")}</p>
                                            <p style="margin: 3px 0 0 0; font-size: 8px; color: #9ca3af;"${tr("Estimado Mensual")}</p>
                                            <p style="margin: 10px 0 0 0; font-size: 20px; font-weight: bold; color: ${DRK_BLUE};">${eur(nuevoCosteAnualFijo)}${tr("/a√±o")}</p>
                                        </div>
                                    </div>
                                </td>
                                
                                <td style="width: 35%; vertical-align: top; text-align: center; padding: 0 10px;">
                                    <div style="background-color: ${GREEN_SAVE}; color: white; padding: 10px 8px; border-radius: 8px 8px 0 0;">
                                        <p style="margin: 0; font-size: 9px; font-weight: bold; text-transform: uppercase;">${tr("TU AHORRO ANUAL INDEXADO")}</p>
                                    </div>
                                    <div style="padding: 15px 10px;">
                                        <p style="margin: 0; font-size: 32px; font-weight: bold; color: ${GREEN_SAVE};">${eur(ahorroIndexado)}</p>
                                        <div style="margin: 15px 0 0 0;">
                                            <p style="margin: 0 0 3px 0; font-size: 10px; color: #6b7280; font-weight: 600;"${tr("TU NUEVO COSTE DRK")}</p>
                                            <p style="margin: 0; font-size: 22px; font-weight: bold; color: ${GREEN_SAVE};">${eur(nuevoCosteAnualIndexado / 12)}${tr("/mes")}</p>
                                            <p style="margin: 3px 0 0 0; font-size: 8px; color: #9ca3af;"${tr("Estimado Mensual")}</p>
                                            <p style="margin: 10px 0 0 0; font-size: 20px; font-weight: bold; color: ${GREEN_SAVE};">${eur(nuevoCosteAnualIndexado)}${tr("/a√±o")}</p>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </table>
                        
                        <div style="background-color: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px 15px; margin: 20px 0; border-radius: 6px;">
                            <p style="margin: 0; font-size: 11px; color: #92400e; line-height: 1.5;">
                                <strong>‚ö†Ô∏è IMPORTANTE:</strong> A continuaci√≥n encontrar√°s el desglose detallado de c√°lculos para cada suministro, mostrando los desgloses completos de costes tanto para tarifas fijas como indexadas.
                            </p>
                        </div>
                    </div>
                    
                    ${desarrolloDetalladoHtml}
                    
                    <div style="background-color: ${HEADER_BLUE}; color: white; padding: 12px 20px; margin: 30px 0 15px 0; border-radius: 12px; text-align: center;">
                        <h2 style="margin: 0; font-size: 16px; font-weight: bold; letter-spacing: 0.5px;">RESUMEN DE TODOS LOS SUMINISTROS</h2>
                    </div>
                    
                    <table cellpadding="0" cellspacing="0" width="100%" style="margin-bottom: 30px; background-color: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.07);">
                        <tr>
                            <td style="width: 48%; vertical-align: top; padding: 20px;">
                                <div style="background-color: ${HEADER_BLUE}; color: white; padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                                    <h3 style="margin: 0; font-size: 13px; font-weight: bold;">TARIFAS FIJAS</h3>
                                </div>
                                <table cellpadding="0" cellspacing="0" width="100%">
                                    <tr style="background-color: #f3f4f6;">
                                        <th style="padding: 8px; font-size: 10px; text-align: left; color: #374151; font-weight: bold;">CUPS</th>
                                        <th style="padding: 8px; font-size: 10px; text-align: left; color: #374151; font-weight: bold;">TARIFA</th>
                                        <th style="padding: 8px; font-size: 10px; text-align: right; color: #374151; font-weight: bold;">AHORRO</th>
                                    </tr>
                                    ${resumenTablaFijoHtml}
                                </table>
                                <div style="background-color: ${RED_CTA}; color: white; padding: 15px; margin-top: 15px; border-radius: 8px; text-align: center;">
                                    <p style="margin: 0 0 5px 0; font-size: 12px; font-weight: bold;">AHORRO TOTAL FIJAS:</p>
                                    <p style="margin: 0; font-size: 24px; font-weight: bold;">${eur(ahorroFijo)}</p>
                                </div>
                            </td>
                            
                            <td style="width: 4%;"></td>
                            
                            <td style="width: 48%; vertical-align: top; padding: 20px;">
                                <div style="background-color: ${HEADER_BLUE}; color: white; padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                                    <h3 style="margin: 0; font-size: 13px; font-weight: bold;">TARIFAS INDEXADAS</h3>
                                </div>
                                <table cellpadding="0" cellspacing="0" width="100%">
                                    <tr style="background-color: #f3f4f6;">
                                        <th style="padding: 8px; font-size: 10px; text-align: left; color: #374151; font-weight: bold;">CUPS</th>
                                        <th style="padding: 8px; font-size: 10px; text-align: left; color: #374151; font-weight: bold;">TARIFA</th>
                                        <th style="padding: 8px; font-size: 10px; text-align: right; color: #374151; font-weight: bold;">AHORRO</th>
                                    </tr>
                                    ${resumenTablaIndexadoHtml}
                                </table>
                                <div style="background-color: ${RED_CTA}; color: white; padding: 15px; margin-top: 15px; border-radius: 8px; text-align: center;">
                                    <p style="margin: 0 0 5px 0; font-size: 12px; font-weight: bold;">AHORRO TOTAL INDEXADAS:</p>
                                    <p style="margin: 0; font-size: 24px; font-weight: bold;">${eur(ahorroIndexado)}</p>
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <div style="background-color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.07);">
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: bold; text-align: center; color: #1f2937;">CUAL ES LA DIFERENCIA?</h3>
                        
                        <table cellpadding="0" cellspacing="0" width="100%">
                            <tr>
                                <td style="width: 48%; vertical-align: top; padding-right: 15px;">
                                    <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: bold; color: ${DRK_BLUE};">POR QUE TARIFA FIJA?</h4>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 12px; line-height: 1.8; color: #374151;">
                                        <li>Implica un precio fijo por los kilovatios que consumes (kWh).</li>
                                        <li>El precio se mantiene estable, independientemente de c√≥mo se comporten los precios en el mercado el√©ctrico.</li>
                                        <li>Cuando el precio del mercado est√° alto, el cliente est√° protegido frente a sobresaltos.</li>
                                        <li>No tendr√°s que estar pendiente de las variaciones del mercado y podr√°s seguir usando la electricidad como siempre.</li>
                                    </ul>
                                </td>
                                <td style="width: 4%;"></td>
                                <td style="width: 48%; vertical-align: top; padding-left: 15px;">
                                    <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: bold; color: ${GREEN_SAVE};">POR QUE TARIFA INDEXADA?</h4>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 12px; line-height: 1.8; color: #374151;">
                                        <li>Implica un precio variable por los kilovatios que consumes (kWh) cada mes.</li>
                                        <li>Es la tarifa m√°s justa, ya que pagas el coste real de la energ√≠a mes a mes.</li>
                                        <li>Al contratarla, el cliente evita pagar m√°rgenes adicionales cuando el precio de la electricidad es m√°s barato.</li>
                                        <li>A largo plazo, con un indexado 100% funcional, se puede obtener un ahorro aproximado de hasta un 20% en √©pocas de mejor precio.</li>
                                    </ul>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- BOT√ìN DE CONFIRMACI√ìN POR EMAIL -->
                    <div style="background-color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.07); border: 3px solid ${isPowerCup ? '#84cc16' : '#0ea5e9'};">
                        <div style="text-align: center;">
                            <div style="margin-bottom: 15px;">
                                <span style="font-size: 20px; margin-right: 8px;">üìä</span>
                                <span style="font-size: 16px; font-weight: bold; color: ${isPowerCup ? '#3f6212' : '#0c4a6e'};">
                                    Para formalizar esta oferta consolidada:
                                </span>
                            </div>
                            
                            <ol style="margin: 20px 0; padding-left: 20px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto; font-size: 14px; color: #374151; line-height: 2;">
                                <li>${tr('Haz clic en el bot√≥n de abajo')}</li>
                                <li>${tr('Se abrir√° tu cliente de email')}</li>
                                <li><strong style="color: ${isPowerCup ? '#3f6212' : '#0c4a6e'};">${tr('Adjunta la documentaci√≥n requerida')}</strong></li>
                                <li>${tr('Env√≠a el email')}</li>
                            </ol>
                            
                            <a href="${formalizationLink}" style="display: inline-block; background-color: ${RED_CTA}; color: white; padding: 18px 40px; border-radius: 12px; text-decoration: none; font-size: 16px; font-weight: bold; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3); margin: 20px 0;">
                                ${tr('‚úÖ CONFIRMAR Y ENVIAR')}
                            </a>
                            
                            <div style="margin-top: 20px; padding: 15px; background-color: #f3f4f6; border-radius: 8px;">
                                <p style="margin: 0 0 8px 0; font-size: 12px; color: #6b7280;">
                                    <strong>üìé Por cada CUPS adjuntar:</strong>
                                </p>
                                <p style="margin: 0; font-size: 11px; color: #6b7280;">
                                    DNI/CIF ¬∑ √öltima factura ¬∑ Email ¬∑ Tel√©fono ¬∑ IBAN
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background-color: #f3f4f6; padding: 15px; border-radius: 8px; text-align: center;">
                        <p style="margin: 0 0 5px 0; font-size: 11px; color: #6b7280;">Comercial: <strong>${commercialCode}</strong></p>
                        <p style="margin: 0; font-size: 9px; color: #9ca3af;">Documento generado por ${brand.NAME.toUpperCase()}</p>
                    </div>
                    
                </div>
            `;
        }

        function generateStyledHtmlOffer(commercialCode) {
            const bd = lastComparisonResult;
            const offer = bd.offer;
            const brand = activeBrand;
            
            // FIX: Usar funciones robustas contra NaN
            const eur = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
            
            const DRK_DARK = '#0c4a6e'; const DRK_MED = '#075985'; const DRK_CTA = '#0284c7';
            const PC_DARK = '#3f6212'; const PC_MED = '#65a30d'; const PC_CTA = '#84cc16';

            // --- Dynamic Branding Setup ---
            // If activeBrand is POWER_CUP (comparisonMode === 'overall_best')
            const D_PRIMARY_DARK = brand.NAME.includes('DRK') ? DRK_DARK : PC_DARK;
            const D_PRIMARY_MED = brand.NAME.includes('DRK') ? DRK_MED : PC_MED;
            const D_ACCENT_CTA = brand.NAME.includes('DRK') ? DRK_CTA : PC_CTA;
            const D_BRAND_NAME = brand.NAME;
            const ZONA_GEOGRAFICA = "PENINSULA"; // HARDCODED AS REQUESTED

            const RED_CTA = '#CC0000';
            const BG_LIGHT = brand.NAME.includes('DRK') ? '#f0f9ff' : '#f7fee7';  
            const GREEN_SAVE = '#16a34a';
            
            // --- Shared Section Title Style (Removed margin-top: 10px) ---
            const sectionTitle = `background-color: ${D_PRIMARY_MED}; color: white; font-weight: bold; padding: 8px; font-size: 14px;`;


            const clientName = document.getElementById('client-name-input').value.trim() || '[NOMBRE COMPLETO CLIENTE]';
            const clientPhone = document.getElementById('client-phone-input').value.trim() || '[TEL√âFONO CLIENTE]';
            const clientEmail = document.getElementById('client-email-input').value.trim() || '[EMAIL CLIENTE]';
            
            const p1PricePerDay = bd.powerCosts.find(p => p.period === 1)?.priceDay || 0;
            const p2PricePerDay = bd.powerCosts.find(p => p.period === 2)?.priceDay || 0;
            const p3PricePerDay = bd.powerCosts.find(p => p.period === 3)?.priceDay || 0;
            const p4PricePerDay = bd.powerCosts.find(p => p.period === 4)?.priceDay || 0;
            const p5PricePerDay = bd.powerCosts.find(p => p.period === 5)?.priceDay || 0;
            const p6PricePerDay = bd.powerCosts.find(p => p.period === 6)?.priceDay || 0;
            const e1Price = bd.energyCosts.find(e => e.period === 1)?.price || 0;
            const e2Price = bd.energyCosts.find(e => e.period === 2)?.price || 0;
            const e3Price = bd.energyCosts.find(e => e.period === 3)?.price || 0;
            const e4Price = bd.energyCosts.find(e => e.period === 4)?.price || 0;
            const e5Price = bd.energyCosts.find(e => e.period === 5)?.price || 0;
            const e6Price = bd.energyCosts.find(e => e.period === 6)?.price || 0;

            const monthlyEstimate = eur(bd.totalAnnual / 12);
            const totalConsumption = num(bd.energyCosts.reduce((sum, e) => sum + e.kwh, 0), 0) + ' kWh';
            
            const LB = '%0A';
            const discountLine = bd.discountRate > 0 ? `Descuento: ${num(bd.discountRate * 100, 0)}% aplicado a Energ√≠a.${LB}` : '';

            // MODIFICACI√ìN: Nombre completo de la tarifa
            const commercialTariffName = bd.isNegativeSavings 
                ? "Tu Tarifa Actual" 
                : (offer.isDrk 
                    ? ((offer.description?.length > offer.name?.length) ? offer.description : offer.name)
                    : offer.name);
            const commercializadoraName = offer.isDrk ? offer.name?.toUpperCase() : (offer.name?.toUpperCase() === 'TU TARIFA ACTUAL' ? 'TU COMERCIALIZADORA' : offer.name?.toUpperCase());

            const emailBody = `‚úÖ CONFIRMACI√ìN DE ACEPTACI√ìN DE OFERTA${LB}${LB}` +
                                 `Estimado equipo de ${D_BRAND_NAME.toUpperCase()},${LB}${LB}` +
                                 `Confirmo mi aceptaci√≥n de la oferta energ√©tica que detallo a continuaci√≥n:${LB}${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                                 `üìã DATOS DEL SUMINISTRO${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `üîå CUPS:${LB}${bd.cups}${LB}${LB}` +
                                 `‚ö° TARIFA CONTRATADA:${LB}${commercialTariffName}${LB}${LB}` +
                                 `üåç Zona Geogr√°fica: ${ZONA_GEOGRAFICA}${LB}` +
                                 `üìä Consumo Facturado: ${totalConsumption}${LB}${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                                 `üí∞ BENEFICIO ECON√ìMICO${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `üíµ Ahorro Anual Estimado: ${eur(bd.savings)}${LB}` +
                                 `üìÖ Coste Mensual Estimado: ${monthlyEstimate}${LB}${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                                 `üí° PRECIOS CONTRATADOS${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `üî¥ POTENCIA:${LB}` +
                                 `   ‚Ä¢ P1: ${numPriceFormula(p1PricePerDay)} ‚Ç¨/kW/d√≠a${LB}` +
                                 `   ‚Ä¢ P2: ${numPriceFormula(p2PricePerDay)} ‚Ç¨/kW/d√≠a${LB}${LB}` +
                                 `üü¢ ENERG√çA:${LB}` +
                                 `   ‚Ä¢ E1 (Punta): ${numPriceFormula(e1Price)} ‚Ç¨/kWh${LB}` +
                                 `   ‚Ä¢ E2 (Llano): ${numPriceFormula(e2Price)} ‚Ç¨/kWh${LB}` +
                                 `   ‚Ä¢ E3 (Valle): ${numPriceFormula(e3Price)} ‚Ç¨/kWh${LB}${LB}` +
                                 `${discountLine}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                                 `üë§ DATOS DEL TITULAR${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `üìõ Nombre completo: ${clientName}${LB}` +
                                 `üì± Tel√©fono: ${clientPhone}${LB}` +
                                 `üìß Email: ${clientEmail}${LB}${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                                 `üìé DOCUMENTACI√ìN ADJUNTA${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `Adjunto la siguiente documentaci√≥n para formalizar el contrato:${LB}${LB}` +
                                 `‚úì 1. Foto DNI/CIF (anverso y reverso)${LB}` +
                                 `‚úì 2. √öltima factura de luz (m√≠n. 3 meses)${LB}` +
                                 `‚úì 3. Email de contacto${LB}` +
                                 `‚úì 4. Tel√©fono de contacto${LB}` +
                                 `‚úì 5. N√∫mero de cuenta bancaria (IBAN)${LB}${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                                 `üí¨ COMENTARIOS ADICIONALES${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `[Escriba aqu√≠ cualquier observaci√≥n o consulta adicional]${LB}${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `Quedo a la espera de la confirmaci√≥n de la formalizaci√≥n del contrato.${LB}${LB}` +
                                 `Atentamente,${LB}` +
                                 `${clientName}`;

            const subject = `‚úÖ FORMALIZACI√ìN CONTRATO - CUPS: ${bd.cups}`;
            const formalizationRecipients = 'f.araujo@drk.es,r.guerra@drk.es,s.caballero@drk.es';
            const formalizationLink = `mailto:${formalizationRecipients}?subject=${encodeURIComponent(subject)}&body=${emailBody}`;

            const tableMain = `width: 600px; max-width: 100%; border-collapse: collapse; font-family: Arial, sans-serif; border: 1px solid #ddd; margin: 0 auto; background: white; border-radius: 8px; overflow: hidden;`;
            const headerCell = `background-color: ${D_PRIMARY_DARK}; color: white; padding: 15px; text-align: center; border-radius: 8px 8px 0 0;`;
            const rowLabel = `padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; color: #555; vertical-align: top;`;
            const rowValue = `padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; font-weight: bold; color: #333; text-align: right; white-space: nowrap; vertical-align: top;`;
            const savingsBox = `background-color: ${D_ACCENT_CTA}; color: white; font-size: 20px; font-weight: bold; padding: 15px; text-align: center; border-radius: 8px; margin: 15px 0;`;
            const footerStyle = `background-color: ${D_PRIMARY_MED}; height: 5px; margin-top: 10px; border-radius: 0 0 8px 8px;`;
            const GREEN_SAVE_COLOR = '#16a34a';
            const btnStyle = `display: inline-block; background-color: ${RED_CTA}; color: white; padding: 12px 24px; text-decoration: none; font-weight: bold; border-radius: 6px; margin: 20px 0; font-size: 16px;`;

            // --- PLANTILLA PARA AHORRO NEGATIVO ---
            if (bd.isNegativeSavings) {
                const isDrkBrand = brand.NAME.includes('DRK');
                const companyBanner = isDrkBrand ? `
                    <table cellpadding="0" cellspacing="0" width="600" style="width: 600px; max-width: 100%; margin: 0 auto 20px auto; border-collapse: collapse; background-color: #075985; font-family: Arial, sans-serif;">
                        <tr>
                            <td style="padding: 20px 20px 20px 20px; vertical-align: middle; width: 60%;">
                                <p style="margin: 0; padding: 0; color: #ffffff; font-size: 28px; font-weight: bold; line-height: 1.2;">DRK ENERG√çA</p>
                                <p style="margin: 5px 0 0 0; padding: 0; color: #bae6fd; font-size: 13px; line-height: 1.3;">Liderando el ahorro y la eficiencia energ√©tica.</p>
                            </td>
                            <td style="padding: 20px 20px 20px 10px; text-align: right; vertical-align: middle; width: 40%;">
                                <p style="margin: 0; padding: 0; color: #e0f2fe; font-size: 9px; font-weight: bold; text-transform: uppercase;">ESTUDIO DE AHORRO</p>
                                <p style="margin: 3px 0 0 0; padding: 0; color: #ffffff; font-size: 14px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                            </td>
                        </tr>
                    </table>
                ` : `
                    <table cellpadding="0" cellspacing="0" width="600" style="width: 600px; max-width: 100%; margin: 0 auto 20px auto; border-collapse: collapse; background-color: #ffffff; border: 2px solid #84cc16; font-family: Arial, sans-serif;">
                        <tr>
                            <td style="padding: 20px 20px 20px 20px; vertical-align: middle; width: 60%;">
                                <p style="margin: 0; padding: 0; color: #365314; font-size: 28px; font-weight: bold; line-height: 1.2;">POWER CUP</p>
                                <p style="margin: 5px 0 0 0; padding: 0; color: #4d7c0f; font-size: 13px; font-weight: bold; line-height: 1.3;">Asesor√≠a Energ√©tica</p>
                            </td>
                            <td style="padding: 20px 20px 20px 10px; text-align: right; vertical-align: middle; width: 40%;">
                                <p style="margin: 0; padding: 0; color: #65a30d; font-size: 9px; font-weight: bold; text-transform: uppercase;">ESTUDIO DE AHORRO</p>
                                <p style="margin: 3px 0 0 0; padding: 0; color: #365314; font-size: 14px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                            </td>
                        </tr>
                    </table>
                `;
                
                return companyBanner + `<table cellpadding="0" cellspacing="0" style="${tableMain}">
                        <tr><td colspan="2" style="${headerCell}">
                            <h1 style="margin:0; font-size: 24px;">ESTUDIO DE AHORRO</h1>
                            <p style="margin:5px 0 0 0; font-size: 14px; opacity: 0.9;">TU TARIFA ACTUAL ES LA M√ÅS COMPETITIVA</p>
                        </td></tr>
                        <tr><td colspan="2" style="padding: 15px;">
                            <p style="margin: 0; font-size: 13px;"><strong${tr("CLIENTE:")}</strong> ${clientName}</p>
                            <p style="margin: 5px 0 0 0; font-size: 13px;"><strong${tr("CUPS:")}</strong> ${bd.cups}</p>
                            <p style="margin: 5px 0 0 0; font-size: 13px;"><strong${tr("COMERCIAL:")}</strong> ${commercialCode || 'N/A'}</p>
                        </td></tr>
                        <tr><td colspan="2" style="background-color: ${BG_LIGHT}; padding: 25px 20px; text-align: center; border-top: 2px solid ${D_PRIMARY_MED}; border-bottom: 2px solid ${D_PRIMARY_MED};">
                            <div style="font-size: 60px; color: ${GREEN_SAVE_COLOR}; margin-bottom: 10px; line-height: 1;">&#9989;</div>
                            <p style="margin: 0; color: ${D_PRIMARY_DARK}; font-size: 22px; font-weight: bold;">¬°Excelente Noticia!</p>
                            <h2 style="margin: 5px 0 0 0; color: ${D_PRIMARY_DARK}; font-size: 18px; font-weight: normal;">TU TARIFA ACTUAL ES LA M√ÅS COMPETITIVA DEL MERCADO</h2>
                            <p style="margin: 0; font-size: 14px; color: #555;">En este momento, no existe una oferta que mejore tu coste actual. Seguiremos estudiando.</p>
                        </td></tr>
                        <tr><td colspan="2" style="padding: 20px; text-align: center;">
                            <p style="font-size: 14px; font-weight: bold; color: ${D_PRIMARY_DARK}; margin-bottom: 5px;">COSTE ANUAL ESTIMADO (ACTUAL):</p>
                            <span style="font-size: 32px; font-weight: bold; color: ${GREEN_SAVE_COLOR}; display: block;">${eur(bd.originalBillAnnual)}</span>
                            <p style="font-size: 12px; color: #888;">${tr('/ A√ëO')} (${tr('basado en el consumo de')} ${bd.dias_facturados} ${tr('d√≠as')})</p>
                            <p style="margin-top: 15px; font-size: 14px; color: #555;">[Colaborador: ${commercialCode}] | Este resumen es una simulaci√≥n.</p>
                        </td></tr>
                        <tr><td colspan="2" style="padding: 0; height: 10px;"><div style="${footerStyle}"></div></td></tr>
                    </table>`;
            }

            // --- PLANTILLA EST√ÅNDAR (Ahorro Positivo) ---
            
            const currentTariffConfig = TARIFF_CONFIG[bd.tariffType];
            
            // Desglose: Potencia
            let desglosePotencia = bd.powerCosts.map(p => {
                if (p.period <= currentTariffConfig.powerPeriods) {
                    return `<tr><td style="${rowLabel} font-family: monospace; font-size: 12px;">P${p.period} (${num(p.kw,2)} kW x ${bd.dias_facturados}d x ${numPriceFormula(p.priceDay)})</td><td style="${rowValue} font-family: monospace; font-size: 12px; white-space: nowrap;">${num(p.cost, 2)} ‚Ç¨</td></tr>`;
                }
                return '';
            }).join('');
            
            // Desglose: Energ√≠a
            let desgloseEnergia = bd.energyCosts.map(e => {
                if (e.period <= currentTariffConfig.periods) {
                    return `<tr><td style="${rowLabel} font-family: monospace; font-size: 12px;">E${e.period} (${num(e.kwh,0)} kWh x ${numPriceFormula(e.price)})</td><td style="${rowValue} font-family: monospace; font-size: 12px; white-space: nowrap;">${num(e.cost, 2)} ‚Ç¨</td></tr>`;
                }
                return '';
            }).join('');
            
            const discountRowsHtml = bd.discountAmount > 0 ? `
                <tr><td style="${rowLabel} font-weight: bold; color: #CC0000;">DESCUENTO COMERCIAL (${num(bd.discountRate * 100, 0)}%)</td><td style="${rowValue} font-weight: bold; color: #CC0000; white-space: nowrap;">-${num(bd.discountAmount, 2)} ‚Ç¨</td></tr>
                <tr><td style="${rowLabel} background-color: #eee; font-weight: bold; color: ${D_PRIMARY_DARK};">SUBTOTAL ENERG√çA (Neto)</td><td style="${rowValue} background-color: #eee; font-weight: bold; color: ${D_PRIMARY_DARK}; white-space: nowrap;">${num(bd.subEnergyNet, 2)} ‚Ç¨</td></tr>
            ` : '';
            
            const desgloseRows = `
                <tr><td colspan="2"><div style="font-weight: bold; color: ${D_PRIMARY_MED}; padding: 5px 0 2px 0;">T√âRMINO POTENCIA (Precio en ‚Ç¨/kW D√≠a)</div></td></tr>
                ${desglosePotencia}
                <tr><td style="${rowLabel} border-bottom: 1px solid #eee; font-weight: bold; color: ${D_PRIMARY_DARK};"${tr("SUBTOTAL POTENCIA")}</td><td style="${rowValue} border-bottom: 1px solid #eee; font-weight: bold; color: ${D_PRIMARY_DARK}; white-space: nowrap;">${num(bd.subPower, 2)} ‚Ç¨</td></tr>
                
                <tr><td colspan="2"><div style="font-weight: bold; color: ${D_PRIMARY_MED}; padding: 10px 0 2px 0;">T√âRMINO ENERG√çA (Precios en ‚Ç¨/kWh)</div></td></tr>
                ${desgloseEnergia}
                <tr><td style="${rowLabel} border-bottom: 2px solid #333; font-weight: bold; color: #555;"${tr("Subtotal Energ√≠a (Bruto)")}</td><td style="${rowValue} border-bottom: 2px solid #333; font-weight: bold; color: #555; white-space: nowrap;">${num(bd.subEnergy, 2)} ‚Ç¨</td></tr>
                
                ${discountRowsHtml}
                
                <tr><td style="${rowLabel} border-top: 2px solid #333; font-weight: bold; color: ${D_PRIMARY_DARK};"${tr("SUBTOTAL BASE (P+E)")}</td><td style="${rowValue} border-top: 2px solid #333; font-weight: bold; color: ${D_PRIMARY_DARK}; white-space: nowrap;">${num(bd.subBase, 2)} ‚Ç¨</td></tr>
                <tr><td style="${rowLabel}">${tr('Imp. El√©c.')} (${num(bd.ieRate * 100, 3)}%)</td><td style="${rowValue} white-space: nowrap;">${num(bd.costIE, 2)} ‚Ç¨</td></tr>
                <tr><td style="${rowLabel} font-weight: bold;"${tr("BASE IMPONIBLE")}</td><td style="${rowValue} font-weight: bold; white-space: nowrap;">${num(bd.baseImp, 2)} ‚Ç¨</td></tr>
                <tr><td style="${rowLabel}">IVA (21%)</td><td style="${rowValue} white-space: nowrap;">${num(bd.costIVA, 2)} ‚Ç¨</td></tr>
                
                <tr><td style="${rowLabel} background-color: #eee; font-weight: bold;">TOTAL FACTURA (${bd.dias_facturados} D√çAS)</td><td style="${rowValue} background-color: #eee; font-size: 16px; white-space: nowrap;">${eur(bd.totalPeriod)}</td></tr>
                <tr><td style="${rowLabel} background-color: #eee; font-weight: bold;"${tr("TOTAL A√ëO (PROYECTADO)")}</td><td style="${rowValue} background-color: #eee; font-size: 16px; white-space: nowrap;">${eur(bd.totalAnnual)}</td></tr>
            `;

            const discountSummaryRow = bd.discountRate > 0 ? `
                <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee; font-weight: bold; color: #CC0000;">DESCUENTO ENERG√çA</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap; color: #CC0000;">${num(bd.discountRate * 100, 0)}%</td></tr>
            ` : '';
            
            const preciosResumenTable = `
                <tr><td colspan="2" style="padding-top: 20px;"><div style="${sectionTitle}">${tr('RESUMEN DE PRECIOS DE LA OFERTA √öNICA')}</div></td></tr>
                <tr><td colspan="2" style="padding: 0;">
                    <table width="100%" cellpadding="0" cellspacing="0" style="font-family: Arial, sans-serif; font-size: 12px; table-layout: fixed;">
                        <tr style="background-color: #f5f5f5;">
                            <th style="padding: 5px 8px; text-align: left; color: ${D_PRIMARY_DARK}; width: 60%;">CONCEPTO</th>
                            <th style="padding: 5px 8px; text-align: right; color: ${D_PRIMARY_DARK}; width: 40%;">PRECIO ${commercializadoraName}</th>
                        </tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Potencia P1 (‚Ç¨/kW/d√≠a)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">${numPriceFormula(p1PricePerDay)}</td></tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Potencia P2 (‚Ç¨/kW/d√≠a)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">${numPriceFormula(p2PricePerDay)}</td></tr>
                        ${bd.tariffType === '3.0TD' ? '<tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Potencia P3 (‚Ç¨/kW/d√≠a)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">' + numPriceFormula(p3PricePerDay) + '</td></tr>' : ''}
                        ${bd.tariffType === '3.0TD' ? '<tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Potencia P4 (‚Ç¨/kW/d√≠a)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">' + numPriceFormula(p4PricePerDay) + '</td></tr>' : ''}
                        ${bd.tariffType === '3.0TD' ? '<tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Potencia P5 (‚Ç¨/kW/d√≠a)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">' + numPriceFormula(p5PricePerDay) + '</td></tr>' : ''}
                        ${bd.tariffType === '3.0TD' ? '<tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Potencia P6 (‚Ç¨/kW/d√≠a)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">' + numPriceFormula(p6PricePerDay) + '</td></tr>' : ''}
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Energ√≠a E1 (‚Ç¨/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">${numPriceFormula(e1Price)}</td></tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Energ√≠a E2 (‚Ç¨/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">${numPriceFormula(e2Price)}</td></tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Energ√≠a E3 (‚Ç¨/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">${numPriceFormula(e3Price)}</td></tr>
                        ${bd.tariffType === '3.0TD' ? '<tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Energ√≠a E4 (‚Ç¨/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">' + numPriceFormula(e4Price) + '</td></tr>' : ''}
                        ${bd.tariffType === '3.0TD' ? '<tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Energ√≠a E5 (‚Ç¨/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">' + numPriceFormula(e5Price) + '</td></tr>' : ''}
                        ${bd.tariffType === '3.0TD' ? '<tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Energ√≠a E6 (‚Ç¨/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">' + numPriceFormula(e6Price) + '</td></tr>' : ''}
                        ${discountSummaryRow}
                        <tr style="background-color: #eee; font-weight: bold;"><td style="padding: 8px; color: ${D_PRIMARY_DARK};">AHORRO ANUAL</td><td style="padding: 8px; text-align: right; font-size: 14px; color: ${GREEN_SAVE_COLOR}; white-space: nowrap;">${eur(bd.savings)}</td></tr>
                        <tr style="background-color: white; height: 10px;"><td colspan="2"></td></tr>
                    </table>
                </td></tr>
            `;

            const finalSavingsSummary = `
                <tr><td colspan="2" style="padding: 0 20px 0 20px; text-align: center;">
                    ${bd.savings > 0 ? `
                    <div style="text-align: center; margin: 15px 0 5px 0;">
                        <p style="margin: 0; font-size: 16px; color: #555; font-weight: bold;">${tr('RESUMEN DE AHORRO FINAL')}</p>
                    </div>
                    <div style="background-color: ${BG_LIGHT}; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px;">
                        <p style="margin: 0; font-size: 14px; color: #555;">${tr('TU AHORRO ANUAL ESTIMADO ES:')}</p>
                        <span style="font-size: 32px; font-weight: bold; color: ${GREEN_SAVE_COLOR}; display: block; margin-top: 5px; white-space: nowrap;">${eur(bd.savings)}</span>
                        <p style="font-size: 12px; color: #888;">${tr('/ A√ëO')}</p>
                    </div>
                    ` : `
                    <div style="background-color: #f0f9ff; padding: 25px; border-radius: 8px; border: 2px solid ${D_PRIMARY_DARK}; margin-bottom: 20px; text-align: center;">
                        <p style="margin: 0 0 10px 0; font-size: 18px; color: ${D_PRIMARY_DARK}; font-weight: bold;">¬°ENHORABUENA!</p>
                        <p style="margin: 0 0 15px 0; font-size: 14px; color: #333; font-weight: bold;">Actualmente est√°s en una buena tarifa.</p>
                        <p style="margin: 0; font-size: 13px; color: #666; line-height: 1.6;">Seguiremos estudiando el mercado y te avisaremos cuando encontremos alguna tarifa que se adapte a tu perfil de consumo.</p>
                    </div>
                    `}
                </td></tr>
            `;

            // NUEVO: Banner de empresa para email
            const isDrkBrand = brand.NAME.includes('DRK');
            const companyBanner = isDrkBrand ? `
                <table cellpadding="0" cellspacing="0" width="600" style="width: 600px; max-width: 100%; margin: 0 auto 20px auto; border-collapse: collapse; background-color: #075985; font-family: Arial, sans-serif;">
                    <tr>
                        <td style="padding: 20px 20px 20px 20px; vertical-align: middle; width: 60%;">
                            <p style="margin: 0; padding: 0; color: #ffffff; font-size: 28px; font-weight: bold; line-height: 1.2;">DRK ENERG√çA</p>
                            <p style="margin: 5px 0 0 0; padding: 0; color: #bae6fd; font-size: 13px; line-height: 1.3;">Liderando el ahorro y la eficiencia energ√©tica.</p>
                        </td>
                        <td style="padding: 20px 20px 20px 10px; text-align: right; vertical-align: middle; width: 40%;">
                            <p style="margin: 0; padding: 0; color: #e0f2fe; font-size: 9px; font-weight: bold; text-transform: uppercase;">ESTUDIO DE AHORRO</p>
                            <p style="margin: 3px 0 0 0; padding: 0; color: #ffffff; font-size: 14px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                        </td>
                    </tr>
                </table>
            ` : `
                <table cellpadding="0" cellspacing="0" width="600" style="width: 600px; max-width: 100%; margin: 0 auto 20px auto; border-collapse: collapse; background-color: #ffffff; border: 2px solid #84cc16; font-family: Arial, sans-serif;">
                    <tr>
                        <td style="padding: 20px 20px 20px 20px; vertical-align: middle; width: 60%;">
                            <p style="margin: 0; padding: 0; color: #365314; font-size: 28px; font-weight: bold; line-height: 1.2;">POWER CUP</p>
                            <p style="margin: 5px 0 0 0; padding: 0; color: #4d7c0f; font-size: 13px; font-weight: bold; line-height: 1.3;">Asesor√≠a Energ√©tica</p>
                        </td>
                        <td style="padding: 20px 20px 20px 10px; text-align: right; vertical-align: middle; width: 40%;">
                            <p style="margin: 0; padding: 0; color: #65a30d; font-size: 9px; font-weight: bold; text-transform: uppercase;">ESTUDIO DE AHORRO</p>
                            <p style="margin: 3px 0 0 0; padding: 0; color: #365314; font-size: 14px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                        </td>
                    </tr>
                </table>
            `;

            return companyBanner + `<table cellpadding="0" cellspacing="0" style="${tableMain}">
                    <tr><td colspan="2" style="${headerCell}">
                        <h1 style="margin:0; font-size: 24px;">ESTUDIO DE AHORRO</h1>
                        <p style="margin:5px 0 0 0; font-size: 14px; opacity: 0.9;">COMPARATIVA PROFESIONAL - ${D_BRAND_NAME.toUpperCase()}</p>
                    </td></tr>
                    
                    <tr><td colspan="2" style="padding: 15px;">
                        <p style="margin: 0; font-size: 13px;"><strong${tr("CLIENTE:")}</strong> ${clientName}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;"><strong${tr("CUPS:")}</strong> ${bd.cups}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;"><strong${tr("COMERCIAL:")}</strong> ${commercialCode || 'N/A'}</p>
                    </td></tr>

                    <tr><td colspan="2" style="background-color: ${BG_LIGHT}; padding: 15px; text-align: center; border-top: 2px solid ${D_PRIMARY_MED}; border-bottom: 2px solid ${D_PRIMARY_MED};">
                        <p style="margin: 0; color: ${D_PRIMARY_MED}; font-size: 12px; font-weight: bold; letter-spacing: 1px;"${tr("LA MEJOR OPCI√ìN PARA TI ES")}</p>
                        <h2 style="margin: 5px 0 0 0; color: ${D_PRIMARY_DARK}; font-size: 22px;">${commercialTariffName}</h2>
                    </td></tr>

                    <tr><td colspan="2" style="padding: 0 20px;">
                        ${bd.savings > 0 ? `
                        <div style="text-align: center; margin: 25px 0 10px 0;">
                            <p style="margin: 0; font-size: 16px; color: #555; font-weight: bold;">${tr('TU AHORRO ANUAL ESTIMADO ES:')}</p>
                        </div>
                        <div style="${savingsBox}">
                            <span style="font-size: 38px; white-space: nowrap;">${eur(bd.savings)}</span>
                            <p style="margin: 5px 0 0 0; font-size: 18px; font-weight: bold;">${tr('¬°CONSIGUE TU AHORRO ANUAL!')}</p>
                        </div>
                        ` : `
                        <div style="background-color: #f0f9ff; padding: 25px; border-radius: 8px; border: 2px solid ${D_PRIMARY_DARK}; margin: 25px 0; text-align: center;">
                            <p style="margin: 0 0 10px 0; font-size: 18px; color: ${D_PRIMARY_DARK}; font-weight: bold;">¬°ENHORABUENA!</p>
                            <p style="margin: 0 0 15px 0; font-size: 14px; color: #333; font-weight: bold;">Actualmente est√°s en una buena tarifa.</p>
                            <p style="margin: 0; font-size: 13px; color: #666; line-height: 1.6;">Seguiremos estudiando el mercado y te avisaremos cuando encontremos alguna tarifa que se adapte a tu perfil de consumo.</p>
                        </div>
                        `}
                    </td></tr>

                    ${bd.savings > 0 ? `
                    <tr><td colspan="2" style="padding: 0 20px;">
                        <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom: 20px; table-layout: fixed;">
                            <tr>
                                <td style="width: 50%; padding: 15px; background-color: #f9fafb; border: 1px solid #ddd; text-align: center; vertical-align: top;">
                                    <div style="font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase;"${tr("TU FACTURA ACTUAL")}</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #ef4444; margin: 5px 0; text-decoration: line-through; white-space: nowrap;">${eur(bd.originalBillAnnual)}</div>
                                    <div style="font-size: 11px; color: #666;">${tr('/ A√ëO')}</div>
                                </td>
                                <td style="width: 50%; padding: 15px; background-color: ${BG_LIGHT}; border: 1px solid ${D_PRIMARY_MED}; text-align: center; vertical-align: top;">
                                    <div style="font-size: 11px; font-weight: bold; color: ${D_PRIMARY_MED}; text-transform: uppercase;">${tr('TU NUEVO COSTE')} ${commercializadoraName}</div>
                                    <div style="font-size: 24px; font-weight: bold; color: ${D_PRIMARY_DARK}; margin: 5px 0; white-space: nowrap;">${eur(bd.totalAnnual)}</div>
                                    <div style="font-size: 11px; color: ${D_PRIMARY_MED};">${tr('/ A√ëO')}</div>
                                    <div style="font-size: 13px; font-weight: bold; color: ${D_PRIMARY_DARK}; margin-top: 5px; white-space: nowrap;">${eur(bd.totalAnnual/12)} ${tr('/ MES')}</div>
                                </td>
                            </tr>
                        </table>
                    </td></tr>
                    ` : ''}
                    
                    ${preciosResumenTable}
                    
                    <tr><td colspan="2"><div style="${sectionTitle}">${tr('DESGLOSE DETALLADO DE LA SIMULACI√ìN')} (${commercialTariffName})</div></td></tr>
                    <tr><td colspan="2" style="padding: 0 20px;">
                        <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 10px; margin-bottom: 20px; table-layout: fixed;">
                            ${desgloseRows}
                        </table>
                    </td></tr>
                    
                    ${finalSavingsSummary}

                    <tr><td colspan="2" style="text-align: center; padding: 20px; background-color: #f8f9fa;">
                        <div style="max-width: 500px; margin: 0 auto; padding: 20px; background: white; border-radius: 10px; border: 2px solid ${D_PRIMARY_MED};">
                            <p style="margin: 0 0 15px 0; font-size: 16px; font-weight: bold; color: ${D_PRIMARY_DARK};">${tr('üìß Para confirmar esta oferta:')}</p>
                            <p style="margin: 0 0 15px 0; font-size: 13px; color: #555; line-height: 1.6;">
                                1. ${tr('Haz clic en el bot√≥n de abajo')}<br>
                                2. ${tr('Se abrir√° tu cliente de email')}<br>
                                3. <strong style="color: ${D_PRIMARY_DARK};">${tr('Adjunta la documentaci√≥n requerida')}</strong><br>
                                4. ${tr('Env√≠a el email')}
                            </p>
                            <a href="${formalizationLink}" style="${btnStyle}">${tr('‚úÖ CONFIRMAR Y ENVIAR')}</a>
                            <p style="margin: 15px 0 0 0; font-size: 11px; color: #666; line-height: 1.5;">
                                ${tr('üìÑ <strong>Documentaci√≥n necesaria:</strong><br>')}
                                ${tr('DNI/CIF ¬∑ √öltima factura ¬∑ Email ¬∑ Tel√©fono ¬∑ IBAN')}
                            </p>
                        </div>
                        <p style="font-size: 10px; color: #999; margin-top: 15px;">[Colaborador: ${commercialCode}] | ${tr('Este resumen es una simulacion')} ${tr('basada en su ultima factura')}.</p>
                    </td></tr>

                    <tr><td colspan="2" style="padding: 0; height: 10px;"><div style="${footerStyle}"></div></td></tr>
                </table>`;
        }


        function generateMultiStyledHtmlOffer(commercialCode) {
            const bd = lastComparisonResult; // Resultado acumulado
            const offer = bd.offer;
            const individualResults = bd.individualResults;
            
            // FIX: Usar funciones robustas contra NaN
            const eur = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
            
            const DRK_DARK = '#0c4a6e'; const DRK_MED = '#075985'; const DRK_CTA = '#0284c7';
            const PC_DARK = '#3f6212'; const PC_MED = '#65a30d'; const PC_CTA = '#84cc16';

            // --- Determine Dynamic Branding for Email Copy ---
            const { winningOffers, hasDrkWinner } = getWinningOffersPerType(individualResults);

            let dynamicBrand = activeBrand; // Use the current active brand (set by comparison mode)
            
            const D_PRIMARY_DARK = dynamicBrand.NAME.includes('DRK') ? DRK_DARK : PC_DARK;
            const D_PRIMARY_MED = dynamicBrand.NAME.includes('DRK') ? DRK_MED : PC_MED;
            const D_ACCENT_CTA = dynamicBrand.NAME.includes('DRK') ? DRK_CTA : PC_CTA;
            const D_BRAND_NAME = dynamicBrand.NAME;
            const BG_LIGHT = dynamicBrand.NAME.includes('DRK') ? '#f0f9ff' : '#f7fee7';  

            const ZONA_GEOGRAFICA = "PENINSULA"; // HARDCODED AS REQUESTED

            const RED_CTA = '#CC0000';
            const GREEN_SAVE = '#16a34a';
            
            // --- Shared Section Title Style (Removed margin-top: 10px) ---
            const sectionTitle = `background-color: ${D_PRIMARY_MED}; color: white; font-weight: bold; padding: 8px; font-size: 14px;`;


            const clientName = document.getElementById('client-name-input').value.trim() || '[NOMBRE COMPLETO CLIENTE]';
            const clientPhone = document.getElementById('client-phone-input').value.trim() || '[TEL√âFONO CLIENTE]';
            const clientEmail = document.getElementById('client-email-input').value.trim() || '[EMAIL CLIENTE]';

            // Generar tabla de desglose individual
            let individualBreakdowns = '';
            individualResults.forEach((resItem, index) => {
                // La l√≥gica de cu√°l es la mejor oferta ya se ha aplicado en saveSupply
                const isBest = resItem.isNegativeSavings === false;  
                const currentConfig = TARIFF_CONFIG[resItem.originalTariffType] || TARIFF_CONFIG['2.0TD'];
                const periods = currentConfig.periods;
                const powerPeriods = currentConfig.powerPeriods;
                
                // Determinar el nombre de la tarifa final aplicada
                const appliedOfferName = resItem.offer.isDrk  
                    ? ((resItem.offer.description?.length > resItem.offer.name?.length) 
                        ? resItem.offer.description 
                        : resItem.offer.name)
                    : resItem.offer.name;

                // Desglose: Potencia
                let desglosePotencia = resItem.powerCosts.map(p => {
                    if (p.period <= powerPeriods) {
                        return `<tr><td style="padding: 5px 8px; font-family: monospace; font-size: 11px; color: #555;">P${p.period} (${num(p.kw,2)} kW x ${resItem.dias_facturados}d x ${numPriceFormula(p.priceDay)})</td><td style="padding: 5px 8px; font-family: monospace; font-size: 11px; font-weight: bold; color: #333; text-align: right; white-space: nowrap;">${num(p.cost, 2)} ‚Ç¨</td></tr>`;
                    }
                    return '';
                }).join('');

                // Desglose: Energ√≠a
                let desgloseEnergia = resItem.energyCosts.map(e => {
                    if (e.period <= periods) {
                        let label = `E${e.period}`;
                        if (resItem.originalTariffType === '2.0TD') {
                            if (e.period === 1) label += ' (Punta)';
                            if (e.period === 2) label += ' (Llano)';
                            if (e.period === 3) label += ' (Valle)';
                            }
                        return `<tr><td style="padding: 5px 8px; font-family: monospace; font-size: 11px; color: #555;">${label} (${num(e.kwh,0)} kWh x ${numPriceFormula(e.price)})</td><td style="padding: 5px 8px; font-family: monospace; font-size: 11px; font-weight: bold; color: #333; text-align: right; white-space: nowrap;">${num(e.cost, 2)} ‚Ç¨</td></tr>`;
                    }
                    return '';
                }).join('');
                
                const discountRowsHtml = resItem.discountAmount > 0 ? `
                    <tr><td style="padding: 5px 8px; font-weight: bold; color: #CC0000;">DESCUENTO COMERCIAL (${num(resItem.discountRate * 100, 0)}%)</td><td style="padding: 5px 8px; text-align: right; font-weight: bold; color: #CC0000; white-space: nowrap;">-${num(resItem.discountAmount, 2)} ‚Ç¨</td></tr>
                    ` : '';

                // MODIFICACI√ìN #2: Ajuste para eliminar "Sin Ahorro" en el email copy si no hay ahorro, dejando solo el total.
                const ahorroAnualText = isBest
                    ? `. Ahorro Anual: <span style="color: ${GREEN_SAVE}; font-weight: bold;">${eur(resItem.savings)}</span>`
                    : '';

                individualBreakdowns += `
                    <tr><td colspan="2" style="padding: 15px 20px 0 20px; background-color: #f8fafc; border-top: 2px solid #ddd;">
                        <h4 style="margin: 0 0 10px 0; font-size: 16px; color: ${D_PRIMARY_DARK}; font-weight: bold;">[${index + 1}] CUPS: ${resItem.cups} (${resItem.originalTariffType})</h4>
                        <p style="margin: 0 0 5px 0; font-size: 12px; color: #555;">Tarifa Aplicada: <span style="font-weight: bold;">${appliedOfferName}</span></p>
                        <p style="margin: 0 0 10px 0; font-size: 12px; color: #555;">D√≠as Facturados: ${resItem.dias_facturados}${ahorroAnualText}</p>
                        
                        <table width="100%" cellpadding="0" cellspacing="0" style="table-layout: fixed; margin-bottom: 10px; background-color: white; border: 1px solid #eee;">
                            <tr style="background-color: #f5f5f5;">
                                <th colspan="2" style="padding: 5px 8px; text-align: left; font-size: 12px; color: ${D_PRIMARY_MED}; border-bottom: 1px solid #ddd;">SIMULACI√ìN DE COSTES POR PERIODO</th>
                            </tr>
                            <tr><td colspan="2" style="padding: 5px 8px; font-weight: bold; color: ${D_PRIMARY_MED};">POTENCIA</td></tr>
                            ${desglosePotencia}
                            <tr><td colspan="2" style="height: 5px;"></td></tr>
                            <tr><td colspan="2" style="padding: 5px 8px; font-weight: bold; color: ${D_PRIMARY_MED};">ENERG√çA</td></tr>
                            ${desgloseEnergia}
                            ${discountRowsHtml}
                            <tr><td colspan="2" style="height: 5px;"></td></tr>
                            <tr><td style="padding: 8px; background-color: ${BG_LIGHT}; font-weight: bold; color: ${D_PRIMARY_DARK};">TOTAL FACTURA (PERIODO)</td><td style="padding: 8px; background-color: ${BG_LIGHT}; font-weight: bold; color: ${D_PRIMARY_DARK}; text-align: right;">${eur(resItem.totalPeriod)}</td></tr>
                        </table>
                    </td></tr>
                `;
            });
            
            const tableMain = `width: 600px; max-width: 100%; border-collapse: collapse; font-family: Arial, sans-serif; border: 1px solid #ddd; margin: 0 auto; background: white; border-radius: 8px; overflow: hidden;`;
            const headerCell = `background-color: ${D_PRIMARY_DARK}; color: white; padding: 15px; text-align: center; border-radius: 8px 8px 0 0;`;
            const savingsBox = `background-color: ${D_ACCENT_CTA}; color: white; font-size: 20px; font-weight: bold; padding: 15px; text-align: center; border-radius: 8px; margin: 15px 0;`;
            const btnStyle = `display: inline-block; background-color: ${RED_CTA}; color: white; padding: 12px 24px; text-decoration: none; font-weight: bold; border-radius: 6px; margin: 20px 0; font-size: 16px;`;
            const footerStyle = `background-color: ${D_PRIMARY_MED}; height: 5px; margin-top: 10px; border-radius: 0 0 8px 8px;`;

            // URL para formalizaci√≥n
            const LB = '%0A';
            
            // MODIFICACI√ìN: Nombre completo de la oferta consolidada
            const consolidatedTariffName = (offer.description?.length > offer.name?.length) 
                ? offer.description 
                : offer.name;

            const emailBody = `‚úÖ CONFIRMACI√ìN OFERTA CONSOLIDADA - MULTICUPS${LB}${LB}` +
                                 `Estimado equipo de ${D_BRAND_NAME.toUpperCase()},${LB}${LB}` +
                                 `Confirmo mi aceptaci√≥n de la oferta energ√©tica consolidada para m√∫ltiples suministros:${LB}${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                                 `üìä RESUMEN CONSOLIDADO${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `‚ö° OFERTA:${LB}${consolidatedTariffName}${LB}${LB}` +
                                 `üåç Zona Geogr√°fica: ${ZONA_GEOGRAFICA}${LB}` +
                                 `üîå Total Suministros: ${individualResults.length} CUPS${LB}${LB}` +
                                 `üìã CUPS INCLUIDOS:${LB}${bd.multiCupsList}${LB}${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                                 `üí∞ BENEFICIO ECON√ìMICO TOTAL${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `üíµ Ahorro Anual Consolidado: ${eur(bd.savings)}${LB}` +
                                 `üìÖ Coste Mensual Total: ${eur(bd.totalAnnual / 12)}${LB}${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                                 `üë§ DATOS DEL TITULAR${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `üìõ Nombre completo: ${clientName}${LB}` +
                                 `üì± Tel√©fono: ${clientPhone}${LB}` +
                                 `üìß Email: ${clientEmail}${LB}${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                                 `üìé DOCUMENTACI√ìN POR CUPS${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `Adjunto la siguiente documentaci√≥n para cada CUPS:${LB}${LB}` +
                                 `‚úì 1. Foto DNI/CIF (anverso y reverso)${LB}` +
                                 `‚úì 2. √öltima factura de cada suministro (m√≠n. 3 meses)${LB}` +
                                 `‚úì 3. Email de contacto${LB}` +
                                 `‚úì 4. Tel√©fono de contacto${LB}` +
                                 `‚úì 5. N√∫mero de cuenta bancaria (IBAN)${LB}${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                                 `üí¨ COMENTARIOS ADICIONALES${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `[Escriba aqu√≠ cualquier observaci√≥n o consulta adicional]${LB}${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `Quedo a la espera de la confirmaci√≥n de la formalizaci√≥n del contrato consolidado.${LB}${LB}` +
                                 `Atentamente,${LB}` +
                                 `${clientName}`;

            const subject = `‚úÖ FORMALIZACI√ìN CONSOLIDADA - ${individualResults.length} CUPS`;
            const formalizationRecipients = 'f.araujo@drk.es,r.guerra@drk.es,s.caballero@drk.es';  
            const formalizationLink = `mailto:${formalizationRecipients}?subject=${encodeURIComponent(subject)}&body=${emailBody}`;

            // --- Precios de la Oferta Consolidada (Dynamic Winner) ---
            
            let preciosConsolidadosHTML = '';
            let priceSectionHeader;
            if (hasDrkWinner && comparisonMode !== 'overall_best') {
                priceSectionHeader = 'PRECIOS DE LAS OFERTAS SELECCIONADAS (DRK ENERG√çA)';
            } else if (!hasDrkWinner && comparisonMode === 'overall_best') {
                priceSectionHeader = 'PRECIOS DE LAS OFERTAS SELECCIONADAS (POWER CUP GLOBAL)';
            } else {
                priceSectionHeader = 'PRECIOS DE LAS OFERTAS SELECCIONADAS';
            }

            // 2.0TD Prices - TODAS las ofertas √∫nicas
            const offers20 = winningOffers['2.0TD'];
            const has20TD = individualResults.some(d => d.originalTariffType === '2.0TD');
            if (offers20 && offers20.length > 0 && has20TD) {
                offers20.forEach((offer20, index) => {
                    const fullTariffName20 = `${offer20.name || 'Tarifa 2.0TD'} - ${offer20.description || 'N/A'}`; 
                    const p1 = offer20.p_potencia_1 / 365;
                    const p2 = offer20.p_potencia_2 / 365;
                    const e1 = offer20.p1_price;
                    const e2 = offer20.p2_price;
                    const e3 = offer20.p3_price;
                    
                    preciosConsolidadosHTML += `
                        <div style="margin-top: 15px; padding: 10px; background-color: #ffffff; border: 1px solid #ddd; border-radius: 6px;">
                            <p style="margin: 0 0 5px 0; font-weight: bold; font-size: 13px; color: ${D_PRIMARY_DARK};">Tarifa 2.0 TD #${index + 1} - ${fullTariffName20}</p>
                            <table width="100%" cellpadding="0" cellspacing="0" style="font-family: Arial, sans-serif; font-size: 11px; table-layout: fixed;">
                                <tr><td style="padding: 2px 0; width: 60%; color: #555;">P1 (‚Ç¨/kW/d√≠a):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: #333;">${numPriceFormula(p1)}</td></tr>
                                <tr><td style="padding: 2px 0; color: #555;">P2 (‚Ç¨/kW/d√≠a):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: #333;">${numPriceFormula(p2)}</td></tr>
                                <tr style="height: 5px;"><td colspan="2"></td></tr>
                                <tr><td style="padding: 2px 0; font-weight: bold; color: ${GREEN_SAVE};">ENERG√çA E1 (Punta - ‚Ç¨/kWh):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: ${GREEN_SAVE};">${numPriceFormula(e1)}</td></tr>
                                <tr><td style="padding: 2px 0; font-weight: bold; color: ${GREEN_SAVE};">ENERG√çA E2 (Llano - ‚Ç¨/kWh):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: ${GREEN_SAVE};">${numPriceFormula(e2)}</td></tr>
                                <tr><td style="padding: 2px 0; font-weight: bold; color: ${GREEN_SAVE};">ENERG√çA E3 (Valle - ‚Ç¨/kWh):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: ${GREEN_SAVE};">${numPriceFormula(e3)}</td></tr>
                            </table>
                        </div>
                    `;
                });
            }

            // 3.0TD Prices - TODAS las ofertas √∫nicas  
            const offers30 = winningOffers['3.0TD'];
            const has30TD = individualResults.some(d => d.originalTariffType === '3.0TD');
            if (offers30 && offers30.length > 0 && has30TD) {
                offers30.forEach((offer30, index) => {
                    let pRows = '';
                    for(let i=1; i<=6; i++) {
                        pRows += `<tr><td style="padding: 2px 0; color: #555;">P${i} (‚Ç¨/kW/d√≠a):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: #333;">${numPriceFormula(offer30[`p_potencia_${i}`] / 365)}</td></tr>`;
                    }
                    let eRows = '';
                    for(let i=1; i<=6; i++) {
                        eRows += `<tr><td style="padding: 2px 0; font-weight: bold; color: ${GREEN_SAVE};">E${i} (‚Ç¨/kWh):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: ${GREEN_SAVE};">${numPriceFormula(offer30[`p${i}_price`])}</p></td></tr>`;
                    }
                    const fullTariffName30 = `${offer30.name || 'Tarifa 3.0TD'} - ${offer30.description || 'N/A'}`;

                    preciosConsolidadosHTML += `
                        <div style="margin-top: 15px; padding: 10px; background-color: #ffffff; border: 1px solid #ddd; border-radius: 6px;">
                            <p style="margin: 0 0 5px 0; font-weight: bold; font-size: 13px; color: ${D_PRIMARY_DARK};">Tarifa 3.0 TD #${index + 1} - ${fullTariffName30}</p>
                            <table width="100%" cellpadding="0" cellspacing="0" style="font-family: Arial, sans-serif; font-size: 11px; table-layout: fixed;">
                                <tr><td colspan="2" style="font-weight: bold; color: ${RED_CTA}; padding: 5px 0 2px 0;">POTENCIA</td></tr>
                                ${pRows}
                                <tr><td colspan="2" style="font-weight: bold; color: ${GREEN_SAVE}; padding: 5px 0 2px 0; border-top: 1px dashed #ccc; margin-top: 5px;">ENERG√çA</td></tr>
                                ${eRows}
                            </table>
                        </div>
                    `;
                });
            }
            
            const preciosResumenSection = preciosConsolidadosHTML ? `
                <tr><td colspan="2" style="padding: 20px 20px 0 20px;"><div style="${sectionTitle}">${priceSectionHeader}</div></td></tr>
                <tr><td colspan="2" style="padding: 0 20px 20px 20px;">
                    ${preciosConsolidadosHTML}
                </td></tr>
            ` : '';
            
            // FIX 2: NUEVO RESUMEN DE AHORRO CONSOLIDADO justo antes del bot√≥n
            const finalMultiSavingsSummary = `
                <tr><td colspan="2" style="padding: 0 20px 0 20px; text-align: center;">
                    <div style="text-align: center; margin: 15px 0 5px 0;">
                        <p style="margin: 0; font-size: 16px; color: #555; font-weight: bold;">${tr('AHORRO TOTAL CONSOLIDADO')}</p>
                    </div>
                    <div style="background-color: ${BG_LIGHT}; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px;">
                        <p style="margin: 0; font-size: 14px; color: #555;">${tr('TU AHORRO ANUAL ESTIMADO ES:')}</p>
                        <span style="font-size: 32px; font-weight: bold; color: ${GREEN_SAVE}; display: block; margin-top: 5px; white-space: nowrap;">${eur(bd.savings)}</span>
                        <p style="font-size: 12px; color: #888;">${tr('/ A√ëO')}</p>
                    </div>
                </td></tr>
            `;

            // NUEVO: Banner de empresa para email MultiCups
            const isDrkBrand = dynamicBrand.NAME.includes('DRK');
            const companyBanner = isDrkBrand ? `
                <table cellpadding="0" cellspacing="0" width="600" style="width: 600px; max-width: 100%; margin: 0 auto 20px auto; border-collapse: collapse; background-color: #075985; font-family: Arial, sans-serif;">
                    <tr>
                        <td style="padding: 20px 20px 20px 20px; vertical-align: middle; width: 60%;">
                            <p style="margin: 0; padding: 0; color: #ffffff; font-size: 28px; font-weight: bold; line-height: 1.2;">DRK ENERG√çA</p>
                            <p style="margin: 5px 0 0 0; padding: 0; color: #bae6fd; font-size: 13px; line-height: 1.3;">Liderando el ahorro y la eficiencia energ√©tica.</p>
                        </td>
                        <td style="padding: 20px 20px 20px 10px; text-align: right; vertical-align: middle; width: 40%;">
                            <p style="margin: 0; padding: 0; color: #e0f2fe; font-size: 9px; font-weight: bold; text-transform: uppercase;">ESTUDIO DE AHORRO</p>
                            <p style="margin: 3px 0 0 0; padding: 0; color: #ffffff; font-size: 14px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                        </td>
                    </tr>
                </table>
            ` : `
                <table cellpadding="0" cellspacing="0" width="600" style="width: 600px; max-width: 100%; margin: 0 auto 20px auto; border-collapse: collapse; background-color: #ffffff; border: 2px solid #84cc16; font-family: Arial, sans-serif;">
                    <tr>
                        <td style="padding: 20px 20px 20px 20px; vertical-align: middle; width: 60%;">
                            <p style="margin: 0; padding: 0; color: #365314; font-size: 28px; font-weight: bold; line-height: 1.2;">POWER CUP</p>
                            <p style="margin: 5px 0 0 0; padding: 0; color: #4d7c0f; font-size: 13px; font-weight: bold; line-height: 1.3;">Asesor√≠a Energ√©tica</p>
                        </td>
                        <td style="padding: 20px 20px 20px 10px; text-align: right; vertical-align: middle; width: 40%;">
                            <p style="margin: 0; padding: 0; color: #65a30d; font-size: 9px; font-weight: bold; text-transform: uppercase;">ESTUDIO DE AHORRO</p>
                            <p style="margin: 3px 0 0 0; padding: 0; color: #365314; font-size: 14px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                        </td>
                    </tr>
                </table>
            `;

            return companyBanner + `<table cellpadding="0" cellspacing="0" style="${tableMain}">
                    <tr><td colspan="2" style="${headerCell}">
                        <h1 style="margin:0; font-size: 24px;">ESTUDIO CONSOLIDADO DE AHORRO</h1>
                        <p style="margin:5px 0 0 0; font-size: 14px; opacity: 0.9;">AN√ÅLISIS DE ${individualResults.length} SUMINISTROS (2.0TD + 3.0TD)</p>
                    </td></tr>
                    
                    <tr><td colspan="2" style="padding: 15px;">
                        <p style="margin: 0; font-size: 13px;"><strong${tr("CLIENTE:")}</strong> ${clientName}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;"><strong>TOTAL CUPS:</strong> ${individualResults.length}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;"><strong>OFERTA CONSOLIDADA:</strong> ${consolidatedTariffName}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;"><strong${tr("COMERCIAL:")}</strong> ${commercialCode || 'N/A'}</p>
                    </td></tr>

                    <tr><td colspan="2" style="padding: 0 20px;">
                        <div style="text-align: center; margin: 25px 0 10px 0;">
                            <p style="margin: 0; font-size: 16px; color: #555; font-weight: bold;">AHORRO ANUAL CONSOLIDADO:</p>
                        </div>
                        <div style="${savingsBox}">
                            <span style="font-size: 38px; white-space: nowrap;">${eur(bd.savings)}</span>
                            <p style="margin: 5px 0 0 0; font-size: 18px; font-weight: bold;">¬°AHORRO TOTAL PARA ${individualResults.length} SUMINISTROS!</p>
                        </div>
                    </td></tr>

                    <tr><td colspan="2" style="padding: 0 20px;">
                        <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom: 20px; table-layout: fixed;">
                            <tr>
                                <td style="width: 50%; padding: 15px; background-color: #f9fafb; border: 1px solid #ddd; text-align: center; vertical-align: top;">
                                    <div style="font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase;">COSTE ACTUAL ANUAL</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #ef4444; margin: 5px 0; text-decoration: line-through; white-space: nowrap;">${eur(bd.originalBillAnnual)}</div>
                                    <div style="font-size: 11px; color: #666;">${tr('/ A√ëO')}</div>
                                </td>
                                <td style="width: 50%; padding: 15px; background-color: ${BG_LIGHT}; border: 1px solid ${D_PRIMARY_MED}; text-align: center; vertical-align: top;">
                                    <div style="font-size: 11px; font-weight: bold; color: ${D_PRIMARY_MED}; text-transform: uppercase;">NUEVO COSTE ${D_BRAND_NAME.toUpperCase()} ANUAL</div>
                                    <div style="font-size: 24px; font-weight: bold; color: ${D_PRIMARY_DARK}; margin: 5px 0; white-space: nowrap;">${eur(bd.totalAnnual)}</div>
                                    <div style="font-size: 11px; color: ${D_PRIMARY_MED};">${tr('/ A√ëO')}</div>
                                    <div style="font-size: 13px; font-weight: bold; color: ${D_PRIMARY_DARK}; margin-top: 5px; white-space: nowrap;">${eur(bd.totalAnnual/12)} ${tr('/ MES')}</div>
                                </td>
                            </tr>
                        </table>
                    </td></tr>
                    
                    ${preciosResumenSection}
                    
                    <tr><td colspan="2"><div style="background-color: ${D_PRIMARY_MED}; color: white; font-weight: bold; padding: 8px; font-size: 14px; margin-top: 10px;">DESGLOSE INDIVIDUAL DE AHORRO</div></td></tr>
                    ${individualBreakdowns}
                    
                    ${finalMultiSavingsSummary}

                    <tr><td colspan="2" style="text-align: center; padding: 20px; background-color: #f8f9fa;">
                        <div style="max-width: 500px; margin: 0 auto; padding: 20px; background: white; border-radius: 10px; border: 2px solid ${D_PRIMARY_MED};">
                            <p style="margin: 0 0 15px 0; font-size: 16px; font-weight: bold; color: ${D_PRIMARY_DARK};">${tr('üìß Para confirmar esta oferta:')}</p>
                            <p style="margin: 0 0 15px 0; font-size: 13px; color: #555; line-height: 1.6;">
                                1. ${tr('Haz clic en el bot√≥n de abajo')}<br>
                                2. ${tr('Se abrir√° tu cliente de email')}<br>
                                3. <strong style="color: ${D_PRIMARY_DARK};">${tr('Adjunta la documentaci√≥n requerida')}</strong><br>
                                4. ${tr('Env√≠a el email')}
                            </p>
                            <a href="${formalizationLink}" style="${btnStyle}">${tr('‚úÖ CONFIRMAR Y ENVIAR')}</a>
                            <p style="margin: 15px 0 0 0; font-size: 11px; color: #666; line-height: 1.5;">
                                ${tr('üìÑ <strong>Documentaci√≥n necesaria:</strong><br>')}
                                ${tr('DNI/CIF ¬∑ √öltima factura ¬∑ Email ¬∑ Tel√©fono ¬∑ IBAN')}
                            </p>
                        </div>
                        <p style="font-size: 10px; color: #999; margin-top: 15px;">[Colaborador: ${commercialCode}] | Este resumen es una simulaci√≥n consolidada de ${individualResults.length} suministros.</p>
                    </td></tr>

                    <tr><td colspan="2" style="padding: 0; height: 5px;"><div style="${footerStyle}"></div></td></tr>
                </table>`;
        }

        // --- MANEJO DE INPUTS MANUALES ---

        function handleManualInput() {
            try {
                console.log('handleManualInput called');
                console.log('currentTariffType:', currentTariffType);
                console.log('comparisonMode:', comparisonMode);
                
                const isMultiCupsMode = currentTariffType === 'MULTICUPS';

                // Usar multiCupsAddType o currentTariffType para el c√°lculo
                const tariffToUse = isMultiCupsMode ? multiCupsAddType : currentTariffType;
                console.log('tariffToUse:', tariffToUse);
                
                if (!tariffToUse) return window.showErrorModal("Error: Seleccione un tipo de tarifa (2.0TD o 3.0TD).");
                
                const getVal = id => parseFloat(document.getElementById(id).value.replace(',','.')) || 0;
                
                const data = {
                    cups: document.getElementById('input-cups').value || 'MANUAL',
                    dias_facturados: parseInt(document.getElementById('input-billing-days').value) || 30,
                    importe_total: getVal('input-total-bill'),
                    fechas: 'Entrada Manual',
                };

                for(let i=1; i<=6; i++) {
                    data[`potencia_p${i}_kw`] = getVal(`input-p${i}-kw`);
                    data[`consumo_p${i}`] = getVal(`input-e${i}-kwh`);
                }
                
                // Llenar consumo_punta/llano/valle para 2.0TD (basado en E1, E2, E3)
                data['consumo_punta'] = data.consumo_p1;
                data['consumo_llano'] = data.consumo_p2;
                data['consumo_valle'] = data.consumo_p3;
                
                console.log('Data prepared:', data);
                
                if (data.importe_total <= 0) return window.showErrorModal("Introduce el total de la factura.");
                
                closeManualInputModal();
                
                if (isMultiCupsMode) {
                    console.log('Saving supply for MultiCups');
                    saveSupply(data, tariffToUse);
                } else {
                    console.log('Comparing offers for single tariff');
                    compareOffers(data);
                }
            } catch (error) {
                console.error('Error in handleManualInput:', error);
                window.showErrorModal(`Error al procesar datos: ${error.message}`);
            }
        }
        
        function startManualInputFlow() {
            const isMultiCupsMode = currentTariffType === 'MULTICUPS';
            const tariffToConfigure = isMultiCupsMode ? multiCupsAddType : currentTariffType;
            
            if (isMultiCupsMode && !tariffToConfigure) return window.showErrorModal("Error interno: Seleccione primero 2.0 TD o 3.0 TD en la pantalla anterior.");
            
            // 1. Limpiar inputs
            clearManualInputs('input');
            
            // 2. Configurar el modal para modo Individual o Multi
            const selectorWrapper = document.getElementById('manual-tariff-selector-wrapper');
            const selectEl = document.getElementById('manual-input-tariff-select');
            const modalTitleEl = document.getElementById('manual-modal-title');
            
            if (isMultiCupsMode) {
                // MODO MULTICUPS: Ocultamos el selector ya que el tipo es conocido
                selectorWrapper.classList.add('hidden');
                modalTitleEl.textContent = tr('A√±adir Suministro') + ` #${multiCupsData.length + 1} (${tariffToConfigure} Manual)`;
                document.getElementById('execute-manual-input-btn').textContent = tr('A√ëADIR SUMINISTRO');
                
                // Forzar la selecci√≥n del tipo de CUPS seleccionado en la vista SAGA
                // Solo si el tipo existe en el selector (2.0TD o 3.0TD)
                if (selectEl.querySelector(`option[value="${tariffToConfigure}"]`)) {
                    selectEl.value = tariffToConfigure;
                }
                toggleMultiCupsInputPeriods(tariffToConfigure, 'input');

            } else {
                // MODO INDIVIDUAL: Ocultar selector (solo se usa la tarifa seleccionada en el landing)
                selectorWrapper.classList.add('hidden');
                modalTitleEl.textContent = `Entrada de Datos Manual (${currentTariffType})`;
                document.getElementById('execute-manual-input-btn').textContent = "CALCULAR";
                toggleMultiCupsInputPeriods(currentTariffType, 'input');
            }

            // 3. Mostrar Modal
            document.getElementById('manual-input-modal').classList.remove('hidden');
            document.getElementById('manual-input-modal').classList.add('flex');
            document.getElementById('input-cups').focus();
            
            // CR√çTICO: Traducir contenido del modal
            if (window.translateAll) {
                setTimeout(() => window.translateAll(), 50);
            }
        }

        function updateComparisonMode(newMode) {
            comparisonMode = newMode;
            let currentBrandForInput = BRANDS.DRK;
            if (newMode === 'overall_best') currentBrandForInput = BRANDS.POWER_CUP;
            // Aplicar estilos y branding a toda la app
            applyBrandStyles(currentBrandForInput);
            
            // Actualizar estilos espec√≠ficos de los selectores de modo
            document.querySelectorAll('input[name="comparison_mode"]').forEach(r => {
                const label = r.closest('label');
                const isSelected = r.value === newMode;
                const colorClass = r.value === 'overall_best' ? 'powercup' : 'drk';
                
                // Limpiar todas las clases de color
                label.className = 'mode-selector flex-1 px-2 py-2 rounded-lg cursor-pointer transition border-2';

                if (isSelected) {
                    // Bot√≥n SELECCIONADO: fondo de color, texto blanco
                    label.classList.add(`border-${colorClass}-500`, `bg-${colorClass}-500`, 'text-white', `hover:bg-${colorClass}-600`);
                    label.querySelector('.checkmark-icon').classList.remove('hidden');
                } else {
                    // Bot√≥n NO SELECCIONADO: fondo blanco, texto de color oscuro
                    label.classList.add(`border-${colorClass}-300`, 'bg-white', `text-${colorClass}-700`, `hover:bg-${colorClass}-100`, `hover:border-${colorClass}-400`);
                    label.querySelector('.checkmark-icon').classList.add('hidden');
                }
            });
        }
        
        // --- NUEVA FUNCIONALIDAD: Tipo de Selecci√≥n de Oferta ---
        
        function updateOfferSelectionType(newType) {
            offerSelectionType = newType;
            
            // Actualizar estilos de los botones de tipo de selecci√≥n
            document.querySelectorAll('input[name="offer_selection_type"]').forEach(r => {
                const container = r.closest('.offer-type-selector').querySelector('div');
                const isSelected = r.value === newType;
                
                if (isSelected) {
                    container.className = 'flex items-start gap-3 p-4 rounded-xl border-2 border-drk-500 bg-drk-500 text-white transition hover:bg-drk-600';
                } else {
                    container.className = 'flex items-start gap-3 p-4 rounded-xl border-2 border-slate-300 bg-white text-slate-700 transition hover:bg-slate-50 hover:border-drk-400';
                }
            });
        }
        
        // --- NUEVO: Modal de Decisi√≥n (Mejor vs Elegir) ---
        
        function showOfferDecisionModal() {
            // SIMPLIFICADO: En lugar de mostrar el modal, ejecutar directamente la mejor opci√≥n con tarifa FIJA
            console.log('Auto-ejecutando mejor opci√≥n con tarifa FIJA (saltando modal de decisi√≥n)');
            
            // Ocultar loading
            document.getElementById('loading-status').classList.add('hidden');
            
            // Configurar tarifa FIJA
            bestOptionTariffChoice = 'fija';
            
            // Ejecutar directamente la mejor opci√≥n
            selectBestOptionDirect();
        }
        
        function closeOfferDecisionModal() {
            document.getElementById('offer-decision-modal').classList.add('hidden');
            document.getElementById('offer-decision-modal').classList.remove('flex');
        }
        
        // NUEVA: Manejar click en VER MEJOR OPCI√ìN
        function handleBestOptionClick() {
            const selectorDiv = document.getElementById('best-option-tariff-selector');
            const checkboxContainer = document.getElementById('powercup-indexed-comparison-checkbox');
            
            // SIMPLIFICADO: Siempre seleccionar TARIFA FIJA y ejecutar directamente
            console.log('Auto-seleccionando TARIFA FIJA y ejecutando directamente');
            bestOptionTariffChoice = 'fija'; // Forzar tarifa FIJA
            selectorDiv?.classList.add('hidden'); // Ocultar selector
            if (checkboxContainer) checkboxContainer.classList.add('hidden'); // Ocultar checkbox
            selectBestOptionDirect(); // Ejecutar directamente con tarifa FIJA
        }
        
        // NUEVA: Actualizar elecci√≥n de tipo de tarifa
        function updateBestOptionTariffChoice(choice) {
            bestOptionTariffChoice = choice;
            console.log('Tipo de tarifa seleccionada en VER MEJOR OPCI√ìN:', choice);
            
            // Actualizar estilos visuales de los labels
            const fijaLabel = document.getElementById('best-fija-label');
            const indexadaLabel = document.getElementById('best-indexada-label');
            
            if (choice === 'fija') {
                fijaLabel.className = 'flex items-center gap-3 p-3 rounded-lg border-2 border-drk-500 bg-drk-50 cursor-pointer transition hover:bg-drk-100';
                indexadaLabel.className = 'flex items-center gap-3 p-3 rounded-lg border-2 border-slate-200 bg-white cursor-pointer transition hover:bg-green-50';
            } else {
                fijaLabel.className = 'flex items-center gap-3 p-3 rounded-lg border-2 border-slate-200 bg-white cursor-pointer transition hover:bg-drk-50';
                indexadaLabel.className = 'flex items-center gap-3 p-3 rounded-lg border-2 border-green-500 bg-green-50 cursor-pointer transition hover:bg-green-100';
            }
        }
        
        // NUEVA: Ejecutar VER MEJOR OPCI√ìN con la elecci√≥n de tarifa
        function selectBestOptionWithChoice() {
            console.log('=================================================');
            console.log('‚ö°‚ö°‚ö° selectBestOptionWithChoice LLAMADA ‚ö°‚ö°‚ö°');
            
            // PROTECCI√ìN: Prevenir llamadas concurrentes
            if (isProcessingBestOption) {
                console.warn('‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è LLAMADA CONCURRENTE DETECTADA Y BLOQUEADA');
                console.warn('Ya hay una ejecuci√≥n de selectBestOptionWithChoice en curso');
                return;
            }
            
            isProcessingBestOption = true;
            console.log('‚úÖ Bandera isProcessingBestOption activada');
            
            console.log('Elecci√≥n:', bestOptionTariffChoice);
            console.log('dualMode:', window.dualMode);
            console.log('lastComparisonResult exists:', !!lastComparisonResult);
            console.log('availableOffers.length:', availableOffers.length);
            console.log('=================================================');
            
            // CR√çTICO: Cerrar INMEDIATAMENTE el modal para prevenir eventos duplicados
            closeOfferDecisionModal();
            console.log('‚úÖ Modal cerrado inmediatamente');
            
            // Cerrar el selector
            document.getElementById('best-option-tariff-selector')?.classList.add('hidden');
            
            // CR√çTICO: Guardar el estado ORIGINAL del CHECK antes de modificarlo
            const checkboxOriginal = document.getElementById('compare-indexed-checkbox');
            const hadCheckMarked = checkboxOriginal ? checkboxOriginal.checked : compareWithIndexed;
            
            console.log('üîç CHECK estaba marcado originalmente:', hadCheckMarked ? 'S√ç' : 'NO');
            console.log('Usuario eligi√≥ tarifa:', bestOptionTariffChoice);
            
            // CR√çTICO: Preservar _multiCupsContext ANTES de reasignar lastComparisonResult
            const preservedContext = lastComparisonResult?._multiCupsContext 
                ? JSON.parse(JSON.stringify(lastComparisonResult._multiCupsContext))
                : null;
            
            console.log('üîç Contexto MULTICUPS preservado en selectBestOptionWithChoice:', preservedContext ? 'S√ç' : 'NO');
            
            // NUEVA L√ìGICA: Determinar si estamos en modo DRK o POWER CUP
            const isDrkMode = activeBrand.NAME.includes('DRK');
            console.log('üîç Modo activo:', isDrkMode ? 'DRK' : 'POWER CUP');
            
            // Filtrar availableOffers seg√∫n la elecci√≥n Y el modo
            let filteredOffersChosen = availableOffers.filter(offer => {
                const offerName = (offer.offer.name || '').toUpperCase();
                const offerDesc = (offer.offer.description || '').toUpperCase();
                const isIndexed = offerName.includes('INDEX') || offerDesc.includes('INDEX');
                const isDrkOffer = offer.offer.isDrk === true;
                
                if (bestOptionTariffChoice === 'indexada') {
                    // Usuario eligi√≥ INDEXADA ‚Üí Solo DRK INDEX (siempre)
                    return isIndexed && isDrkOffer;
                } else {
                    // Usuario eligi√≥ FIJA
                    if (isDrkMode) {
                        // Modo DRK ‚Üí Solo tarifas FIJAS de DRK
                        return !isIndexed && isDrkOffer;
                    } else {
                        // Modo POWER CUP ‚Üí Tarifas FIJAS de cualquier comercializadora
                        return !isIndexed;
                    }
                }
            });
            
            console.log('Ofertas filtradas del tipo elegido:', filteredOffersChosen.length, 'de', availableOffers.length);
            
            if (filteredOffersChosen.length === 0) {
                let mensaje;
                if (bestOptionTariffChoice === 'indexada') {
                    mensaje = 'No se encontraron tarifas INDEXADAS de DRK con ahorro positivo.';
                } else {
                    const origen = isDrkMode ? 'de DRK' : 'de cualquier comercializadora';
                    mensaje = `No se encontraron tarifas FIJAS ${origen} con ahorro positivo.`;
                }
                window.showErrorModal(mensaje);
                closeOfferDecisionModal();
                return;
            }
            
            // Seleccionar la mejor de las filtradas (del tipo elegido)
            let bestChosen = filteredOffersChosen.reduce((best, current) => {
                return (current.totalAnnual < best.totalAnnual) ? current : best;
            }, filteredOffersChosen[0]);
            
            console.log('‚úÖ Mejor tarifa del tipo elegido:', bestChosen.offer.name, 'Ahorro:', bestChosen.savings);
            
            // SI EL CHECK ESTABA MARCADO: Calcular tambi√©n la mejor del tipo contrario
            let bestOtherType = null;
            if (hadCheckMarked) {
                console.log('üîç CHECK estaba marcado ‚Üí Calculando mejor del tipo contrario para mantener comparaci√≥n dual');
                
                // Filtrar ofertas del tipo contrario
                let filteredOffersOther = availableOffers.filter(offer => {
                    const offerName = (offer.offer.name || '').toUpperCase();
                    const offerDesc = (offer.offer.description || '').toUpperCase();
                    const isIndexed = offerName.includes('INDEX') || offerDesc.includes('INDEX');
                    const isDrkOffer = offer.offer.isDrk === true;
                    
                    if (bestOptionTariffChoice === 'indexada') {
                        // Usuario eligi√≥ INDEXADA ‚Üí Calcular mejor FIJA
                        if (isDrkMode) {
                            // Modo DRK ‚Üí Solo tarifas FIJAS de DRK
                            return !isIndexed && isDrkOffer;
                        } else {
                            // Modo POWER CUP ‚Üí Tarifas FIJAS de cualquier comercializadora
                            return !isIndexed;
                        }
                    } else {
                        // Usuario eligi√≥ FIJA ‚Üí Calcular mejor INDEXADA (siempre DRK INDEX)
                        return isIndexed && isDrkOffer;
                    }
                });
                
                if (filteredOffersOther.length > 0) {
                    bestOtherType = filteredOffersOther.reduce((best, current) => {
                        return (current.totalAnnual < best.totalAnnual) ? current : best;
                    }, filteredOffersOther[0]);
                    
                    console.log('‚úÖ Mejor del tipo contrario:', bestOtherType.offer.name, 'Ahorro:', bestOtherType.savings);
                } else {
                    console.warn('‚ö†Ô∏è  No se encontraron ofertas del tipo contrario');
                }
            }
            
            // Decidir qu√© es FIJO y qu√© es INDEXADO seg√∫n lo que eligi√≥ el usuario
            let resFijo, resIndexado;
            if (bestOptionTariffChoice === 'indexada') {
                // Usuario eligi√≥ INDEXADA
                resIndexado = bestChosen;
                resFijo = bestOtherType;
            } else {
                // Usuario eligi√≥ FIJA
                resFijo = bestChosen;
                resIndexado = bestOtherType;
            }
            
            // Actualizar variables globales
            console.log('üîç Asignando lastComparisonResult...');
            
            lastComparisonResult = resFijo || bestChosen;
            
            console.log('‚úÖ lastComparisonResult asignada, continuando...');
            
            console.log('üîç Evaluando comparaci√≥n dual...');
            
            if (hadCheckMarked && resIndexado) {
                // Mantener comparaci√≥n dual
                lastIndexedResult = resIndexado;
                compareWithIndexed = true;
                console.log('‚úÖ Manteniendo comparaci√≥n DUAL: FIJO vs INDEXADO');
            } else {
                // Sin comparaci√≥n dual
                lastIndexedResult = null;
                compareWithIndexed = false;
                console.log('‚ö†Ô∏è  Sin comparaci√≥n dual (CHECK no estaba marcado o no hay tarifa del otro tipo)');
            }
            
            console.log('üöÄ Ejecutando continuaci√≥n...');
            
            try {
                console.log('üîç Restaurando contexto si existe...');
                
                // CR√çTICO: RESTAURAR el contexto preservado
                if (preservedContext) {
                    lastComparisonResult._multiCupsContext = preservedContext;
                    console.log('‚úÖ Contexto MULTICUPS restaurado');
                } else {
                    console.log('‚ö†Ô∏è  Sin contexto MULTICUPS');
                }
                
                console.log('‚úÖ Contexto procesado');
                
                // ‚ö°‚ö°‚ö° MODO DUAL - A√±adir directamente al array ‚ö°‚ö°‚ö°
                if (window.dualMode === true) {
                    console.log('===== üî• MODO DUAL - A√±adiendo directamente al array =====');
                    
                    // CREAR el objeto de suministro CON DESGLOSE COMPLETO
                    const newSupply = {
                        type: 'electricidad',
                        cups: lastComparisonResult.cups || '',
                        tariff: lastComparisonResult.tariffType || currentTariffType || '2.0TD',
                        offer: {
                            ...lastComparisonResult.offer,
                            p1_power_price: lastComparisonResult.powerCosts?.[0]?.priceDay || lastComparisonResult.powerCosts?.[0]?.price_euro_kw_day,
                            p2_power_price: lastComparisonResult.powerCosts?.[1]?.priceDay || lastComparisonResult.powerCosts?.[1]?.price_euro_kw_day,
                            p1_price: lastComparisonResult.energyCosts?.[0]?.price || lastComparisonResult.energyCosts?.[0]?.price_euro_kwh,
                            p2_price: lastComparisonResult.energyCosts?.[1]?.price || lastComparisonResult.energyCosts?.[1]?.price_euro_kwh,
                            p3_price: lastComparisonResult.energyCosts?.[2]?.price || lastComparisonResult.energyCosts?.[2]?.price_euro_kwh,
                            p4_price: lastComparisonResult.energyCosts?.[3]?.price || lastComparisonResult.energyCosts?.[3]?.price_euro_kwh,
                            p5_price: lastComparisonResult.energyCosts?.[4]?.price || lastComparisonResult.energyCosts?.[4]?.price_euro_kwh,
                            p6_price: lastComparisonResult.energyCosts?.[5]?.price || lastComparisonResult.energyCosts?.[5]?.price_euro_kwh
                        },
                        totalAnnual: lastComparisonResult.totalAnnual,
                        originalBillAnnual: lastComparisonResult.originalBillAnnual || (lastComparisonResult.importe_total || 0) * 12,
                        data: lastComparisonResult,
                        electricityBreakdown: {
                            energyCosts: lastComparisonResult.energyCosts || [],
                            powerCosts: lastComparisonResult.powerCosts || [],
                            subEnergy: lastComparisonResult.subEnergyNet || 0,
                            subPower: lastComparisonResult.subPower || 0,
                            subBase: lastComparisonResult.subBase || 0,
                            costIE: lastComparisonResult.costIE || 0,
                            baseImp: lastComparisonResult.baseImp || 0,
                            costIVA: lastComparisonResult.costIVA || 0,
                            totalPeriod: lastComparisonResult.totalPeriod || 0,
                            totalAnnual: lastComparisonResult.totalAnnual || 0,
                            ahorro_mensual: (lastComparisonResult.originalBillPeriod || 0) - (lastComparisonResult.totalPeriod || 0),
                            ahorro_anual: (lastComparisonResult.originalBillAnnual || 0) - (lastComparisonResult.totalAnnual || 0),
                            dias: lastComparisonResult.dias_facturados || 30
                        },
                        results: {
                            drk: comparisonMode === 'overall_best' ? {
                                total: 0,
                                total_anual: 0
                            } : {
                                total: lastComparisonResult.totalAnnual / 12,
                                total_anual: lastComparisonResult.totalAnnual
                            },
                            powercup: comparisonMode === 'overall_best' ? {
                                total: lastComparisonResult.totalAnnual / 12,
                                total_anual: lastComparisonResult.totalAnnual
                            } : {
                                total: 0,
                                total_anual: 0
                            }
                        }
                    };
                    
                    // A√ëADIR al array
                    dualSupplies.push(newSupply);
                    
                    console.log('‚úÖ Suministro a√±adido al array');
                    console.log('  - Total suministros:', dualSupplies.length);
                    console.log('  - CUPS:', newSupply.cups);
                    console.log('  - Tarifa:', newSupply.tariff);
                    console.log('  - Coste anual:', newSupply.totalAnnual);
                    
                    // Actualizar UI
                    updateDualSuppliesList();
                    console.log('‚úÖ UI actualizada');
                    
                    // Cerrar modales
                    const offerModal = document.getElementById('offer-decision-modal');
                    if (offerModal) {
                        offerModal.classList.add('hidden');
                        offerModal.classList.remove('flex');
                    }
                    
                    const tariffSelector = document.getElementById('best-option-tariff-selector');
                    if (tariffSelector) {
                        tariffSelector.classList.add('hidden');
                    }
                    
                    // Ocultar todas las pantallas
                    hideAllScreens();
                    
                    // Volver a pantalla DUAL
                    document.getElementById('screen-dual').classList.add('active');
                    
                    console.log('‚úÖ Usuario puede a√±adir m√°s suministros');
                    
                    // Resetear bandera
                    setTimeout(() => {
                        isProcessingBestOption = false;
                        console.log('‚úÖ Bandera reseteada');
                    }, 100);
                    
                    return; // CR√çTICO: Salir aqu√≠
                }
                
                console.log('üîç Ejecutando funci√≥n apropiada...');
                
                try {
                    console.log('üîç Verificando variables antes del if...');
                    
                    try {
                        console.log('  - hadCheckMarked:', hadCheckMarked);
                    } catch (e) {
                        console.error('  ‚ùå Error al acceder hadCheckMarked:', e.message);
                    }
                    
                    try {
                        console.log('  - resIndexado exists:', !!resIndexado);
                    } catch (e) {
                        console.error('  ‚ùå Error al acceder resIndexado:', e.message);
                    }
                    
                    console.log('üîç Variables verificadas, evaluando if...');
                    
                    // CR√çTICO: Ejecutar seg√∫n si hay comparaci√≥n dual o no
                    if (hadCheckMarked && resIndexado) {
                        // Con comparaci√≥n dual
                        console.log('‚Üí Rama: CON comparaci√≥n dual');
                        console.log('‚Üí Llamando selectBestOptionDirectDual');
                        try {
                            selectBestOptionDirectDual();
                            console.log('‚úÖ selectBestOptionDirectDual ejecutada');
                        } catch (e) {
                            console.error('‚ùå Error en selectBestOptionDirectDual:', e);
                        }
                    } else {
                        // Sin comparaci√≥n dual
                        console.log('‚Üí Rama: SIN comparaci√≥n dual');
                        console.log('‚Üí A punto de llamar selectBestOptionDirectSingle');
                        console.log('‚Üí typeof selectBestOptionDirectSingle:', typeof selectBestOptionDirectSingle);
                        
                        try {
                            console.log('‚Üí Ejecutando selectBestOptionDirectSingle()...');
                            selectBestOptionDirectSingle();
                            console.log('‚úÖ selectBestOptionDirectSingle ejecutada');
                        } catch (e) {
                            console.error('‚ùå Error al llamar selectBestOptionDirectSingle:', e);
                            console.error('Error stack:', e.stack);
                        }
                    }
                    
                    console.log('‚úÖ Funci√≥n lanzada');
                    
                    // Resetear bandera despu√©s de un peque√±o delay para permitir que las funciones terminen
                    setTimeout(() => {
                        isProcessingBestOption = false;
                        console.log('‚úÖ Bandera isProcessingBestOption reseteada');
                    }, 100);
                } catch (outerError) {
                    console.error('‚ùå‚ùå‚ùå ERROR AL EVALUAR IF O EJECUTAR FUNCIONES:');
                    console.error('Error message:', outerError.message);
                    console.error('Error stack:', outerError.stack);
                    console.error('Error completo:', outerError);
                    alert('Error cr√≠tico al ejecutar: ' + outerError.message);
                    
                    // Resetear bandera incluso si hay error
                    isProcessingBestOption = false;
                }
            } catch (error) {
                console.error('‚ùå‚ùå‚ùå ERROR CR√çTICO en selectBestOptionWithChoice:');
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                console.error('Error completo:', error);
                alert('Error cr√≠tico: ' + error.message);
                
                // Resetear bandera incluso si hay error
                isProcessingBestOption = false;
                console.log('‚úÖ Bandera isProcessingBestOption reseteada (despu√©s de error)');
            }
        }
        
        // Funci√≥n auxiliar: Extraer datos de consumo desde resultado
        function extractDataFromResult(result) {
            console.log('üì¶ extractDataFromResult INICIO');
            console.log('  - result.cups:', result?.cups);
            console.log('  - result.kwh_p1:', result?.kwh_p1);
            console.log('  - result.consumo_punta:', result?.consumo_punta);
            console.log('  - result.totalAnnual:', result?.totalAnnual);
            console.log('  - result.tariffType:', result?.tariffType);
            
            // Intentar m√∫ltiples ubicaciones
            let kwh_p1 = 0, kwh_p2 = 0, kwh_p3 = 0, kwh_p4 = 0, kwh_p5 = 0, kwh_p6 = 0;
            let p1 = 0, p2 = 0, p3 = 0, p4 = 0, p5 = 0, p6 = 0;
            let dias = 30;
            let originalBillAnnual = 0;
            
            // Opci√≥n 1: Desde result directamente
            if (result.kwh_p1 !== undefined) {
                console.log('  ‚úÖ Usando Opci√≥n 1: result.kwh_p1 existe');
                kwh_p1 = parseFloat(result.kwh_p1) || 0;
                kwh_p2 = parseFloat(result.kwh_p2) || 0;
                kwh_p3 = parseFloat(result.kwh_p3) || 0;
                kwh_p4 = parseFloat(result.kwh_p4) || 0;
                kwh_p5 = parseFloat(result.kwh_p5) || 0;
                kwh_p6 = parseFloat(result.kwh_p6) || 0;
                p1 = parseFloat(result.p1) || 0;
                p2 = parseFloat(result.p2) || 0;
                p3 = parseFloat(result.p3) || 0;
                p4 = parseFloat(result.p4) || 0;
                p5 = parseFloat(result.p5) || 0;
                p6 = parseFloat(result.p6) || 0;
                dias = parseInt(result.dias) || 30;
            }
            // Opci√≥n 2: Desde QR (nombres alternativos)
            else if (result.consumo_punta !== undefined) {
                console.log('  ‚úÖ Usando Opci√≥n 2: result.consumo_punta existe');
                kwh_p1 = parseFloat(result.consumo_punta) || 0;
                kwh_p2 = parseFloat(result.consumo_llano) || 0;
                kwh_p3 = parseFloat(result.consumo_valle) || 0;
                p1 = parseFloat(result.potencia_p1_kw) || parseFloat(result.p_potencia_1) || 0;
                p2 = parseFloat(result.potencia_p2_kw) || parseFloat(result.p_potencia_2) || 0;
                dias = parseInt(result.dias_facturados) || parseInt(result.dias) || 30;
                console.log('  - kwh_p1:', kwh_p1, 'kwh_p2:', kwh_p2, 'kwh_p3:', kwh_p3);
                console.log('  - p1:', p1, 'p2:', p2);
                console.log('  - dias:', dias);
            } else {
                console.error('  ‚ùå NO se encontr√≥ ninguna opci√≥n v√°lida');
            }
            
            // Capturar factura actual del cliente
            if (result.originalBillAnnual) {
                originalBillAnnual = parseFloat(result.originalBillAnnual);
                console.log('  - originalBillAnnual desde result.originalBillAnnual:', originalBillAnnual);
            } else if (result.factura_actual_anual) {
                originalBillAnnual = parseFloat(result.factura_actual_anual);
                console.log('  - originalBillAnnual desde result.factura_actual_anual:', originalBillAnnual);
            } else if (result.importe_total) {
                // Desde QR: calcular anualizado
                const diasFacturados = dias || 30;
                const factorAnual = 365 / diasFacturados;
                originalBillAnnual = parseFloat(result.importe_total) * factorAnual;
                console.log('  - originalBillAnnual calculado desde importe_total:', result.importe_total, '* factorAnual:', factorAnual, '=', originalBillAnnual);
            } else {
                console.warn('  ‚ö†Ô∏è  NO se pudo obtener originalBillAnnual');
            }
            
            const extracted = {
                tariff: result.tariffType || currentTariffType || '2.0TD',
                kwh_p1, kwh_p2, kwh_p3, kwh_p4, kwh_p5, kwh_p6,
                p1, p2, p3, p4, p5, p6,
                dias,
                originalBillAnnual
            };
            
            console.log('üì¶ extractDataFromResult RESULTADO:');
            console.log('  - tariff:', extracted.tariff);
            console.log('  - kwh_p1:', extracted.kwh_p1, 'kwh_p2:', extracted.kwh_p2, 'kwh_p3:', extracted.kwh_p3);
            console.log('  - p1:', extracted.p1, 'p2:', extracted.p2);
            console.log('  - dias:', extracted.dias);
            console.log('  - originalBillAnnual:', extracted.originalBillAnnual);
            
            return extracted;
        }
        
        // Nueva funci√≥n para ejecutar con COMPARACI√ìN DUAL (cuando CHECK estaba marcado)
        function selectBestOptionDirectDual() {
            closeOfferDecisionModal();
            
            if (!lastComparisonResult || !lastIndexedResult) {
                window.showErrorModal('No hay resultados disponibles para comparaci√≥n dual');
                return;
            }
            
            console.log('selectBestOptionDirectDual: Mostrando comparaci√≥n DUAL (FIJO vs INDEXADO)');
            
            // ‚ö° INTERCEPTAR MODO DUAL AQU√ç
            if (window.dualMode === true) {
                console.log('===== üî• MODO DUAL - A√±adiendo directamente al array =====');
                
                // CREAR el objeto de suministro CON DESGLOSE COMPLETO
                const newSupply = {
                    type: 'electricidad',
                    cups: lastComparisonResult.cups || '',
                    tariff: lastComparisonResult.tariffType || currentTariffType || '2.0TD',
                    offer: {
                        ...lastComparisonResult.offer,
                        p1_power_price: lastComparisonResult.powerCosts?.[0]?.priceDay || lastComparisonResult.powerCosts?.[0]?.price_euro_kw_day,
                        p2_power_price: lastComparisonResult.powerCosts?.[1]?.priceDay || lastComparisonResult.powerCosts?.[1]?.price_euro_kw_day,
                        p1_price: lastComparisonResult.energyCosts?.[0]?.price || lastComparisonResult.energyCosts?.[0]?.price_euro_kwh,
                        p2_price: lastComparisonResult.energyCosts?.[1]?.price || lastComparisonResult.energyCosts?.[1]?.price_euro_kwh,
                        p3_price: lastComparisonResult.energyCosts?.[2]?.price || lastComparisonResult.energyCosts?.[2]?.price_euro_kwh,
                        p4_price: lastComparisonResult.energyCosts?.[3]?.price || lastComparisonResult.energyCosts?.[3]?.price_euro_kwh,
                        p5_price: lastComparisonResult.energyCosts?.[4]?.price || lastComparisonResult.energyCosts?.[4]?.price_euro_kwh,
                        p6_price: lastComparisonResult.energyCosts?.[5]?.price || lastComparisonResult.energyCosts?.[5]?.price_euro_kwh
                    },
                    totalAnnual: lastComparisonResult.totalAnnual,
                    originalBillAnnual: lastComparisonResult.originalBillAnnual || (lastComparisonResult.importe_total || 0) * 12,
                    data: lastComparisonResult,
                    electricityBreakdown: {
                        energyCosts: lastComparisonResult.energyCosts || [],
                        powerCosts: lastComparisonResult.powerCosts || [],
                        subEnergy: lastComparisonResult.subEnergyNet || 0,
                        subPower: lastComparisonResult.subPower || 0,
                        subBase: lastComparisonResult.subBase || 0,
                        costIE: lastComparisonResult.costIE || 0,
                        baseImp: lastComparisonResult.baseImp || 0,
                        costIVA: lastComparisonResult.costIVA || 0,
                        totalPeriod: lastComparisonResult.totalPeriod || 0,
                        totalAnnual: lastComparisonResult.totalAnnual || 0,
                        ahorro_mensual: (lastComparisonResult.originalBillPeriod || 0) - (lastComparisonResult.totalPeriod || 0),
                        ahorro_anual: (lastComparisonResult.originalBillAnnual || 0) - (lastComparisonResult.totalAnnual || 0),
                        dias: lastComparisonResult.dias_facturados || 30
                    },
                    results: {
                        drk: comparisonMode === 'overall_best' ? {
                            total: 0,
                            total_anual: 0
                        } : {
                            total: lastComparisonResult.totalAnnual / 12,
                            total_anual: lastComparisonResult.totalAnnual
                        },
                        powercup: comparisonMode === 'overall_best' ? {
                            total: lastComparisonResult.totalAnnual / 12,
                            total_anual: lastComparisonResult.totalAnnual
                        } : {
                            total: 0,
                            total_anual: 0
                        }
                    }
                };
                
                // A√ëADIR al array
                dualSupplies.push(newSupply);
                
                console.log('‚úÖ Suministro a√±adido al array');
                console.log('  - Total suministros:', dualSupplies.length);
                
                // Actualizar UI
                updateDualSuppliesList();
                
                // Ocultar todas las pantallas
                hideAllScreens();
                
                // Volver a pantalla DUAL
                document.getElementById('screen-dual').classList.add('active');
                
                return;
            }
            
            // Verificar si estamos en contexto MultiCups
            if (lastComparisonResult._multiCupsContext) {
                // Contexto MultiCups: A√±adir a la lista CON comparaci√≥n indexada
                addSupplyToMultiCupsList(lastComparisonResult, lastIndexedResult);
            } else {
                // Contexto individual: Mostrar resultados CON comparaci√≥n indexada
                renderResultsUI(lastComparisonResult, lastIndexedResult);
                document.getElementById('screen-inicio').classList.remove('active'); // Ocultar pantalla inicio
                document.getElementById('initial-view').classList.add('hidden');
                document.getElementById('scanner-view').classList.add('hidden');
                document.getElementById('results-view').classList.remove('hidden');
                document.getElementById('results-view').classList.add('animate-fade-in-up');
                hideNavbar(); // Ocultar navbar al mostrar resultados
            }
        }
        
        // Nueva funci√≥n para ejecutar con UNA sola tarifa (sin comparativa)
        function selectBestOptionDirectSingle() {
            console.log('=================================================');
            console.log('‚ö°‚ö°‚ö° selectBestOptionDirectSingle LLAMADA ‚ö°‚ö°‚ö°');
            console.log('dualMode:', window.dualMode);
            console.log('lastComparisonResult exists:', !!lastComparisonResult);
            console.log('=================================================');
            
            console.log('üîç ANTES de closeOfferDecisionModal:');
            console.log('  - lastComparisonResult.offer.name:', lastComparisonResult?.offer?.name);
            console.log('  - lastComparisonResult.totalAnnual:', lastComparisonResult?.totalAnnual);
            
            closeOfferDecisionModal();
            
            console.log('‚úÖ DESPU√âS de closeOfferDecisionModal:');
            console.log('  - lastComparisonResult.offer.name:', lastComparisonResult?.offer?.name);
            console.log('  - lastComparisonResult.totalAnnual:', lastComparisonResult?.totalAnnual);
            
            if (!lastComparisonResult) {
                console.error('‚ùå No hay lastComparisonResult');
                window.showErrorModal('No hay resultado disponible');
                return;
            }
            
            console.log('‚úÖ lastComparisonResult OK, continuando...');
            
            // FORZAR: No mostrar comparativa indexada
            lastIndexedResult = null;
            compareWithIndexed = false;
            
            // Desmarcar checkbox f√≠sicamente
            const checkbox = document.getElementById('compare-indexed-checkbox');
            if (checkbox) {
                checkbox.checked = false;
            }
            
            console.log('selectBestOptionDirectSingle: Forzando vista SIMPLE (sin comparativa)');
            
            console.log('üîçüîçüîç ESTADO JUSTO ANTES DEL INTERCEPTOR DUAL:');
            console.log('  - lastComparisonResult.offer.name:', lastComparisonResult?.offer?.name);
            console.log('  - lastComparisonResult.totalAnnual:', lastComparisonResult?.totalAnnual);
            console.log('  - lastComparisonResult.tariffType:', lastComparisonResult?.tariffType);
            console.log('  - lastComparisonResult.consumo_punta:', lastComparisonResult?.consumo_punta);
            console.log('  - lastComparisonResult.cups:', lastComparisonResult?.cups);
            
            // ‚ö° INTERCEPTAR MODO DUAL AQU√ç
            if (window.dualMode === true) {
                console.log('===== üî• MODO DUAL - A√±adiendo directamente al array =====');
                
                try {
                    // CREAR el objeto de suministro CON DESGLOSE COMPLETO
                    const newSupply = {
                        type: 'electricidad',
                        cups: lastComparisonResult.cups || '',
                        tariff: lastComparisonResult.tariffType || currentTariffType || '2.0TD',
                        offer: {
                            ...lastComparisonResult.offer,
                            p1_power_price: lastComparisonResult.powerCosts?.[0]?.priceDay || lastComparisonResult.powerCosts?.[0]?.price_euro_kw_day,
                            p2_power_price: lastComparisonResult.powerCosts?.[1]?.priceDay || lastComparisonResult.powerCosts?.[1]?.price_euro_kw_day,
                            p1_price: lastComparisonResult.energyCosts?.[0]?.price || lastComparisonResult.energyCosts?.[0]?.price_euro_kwh,
                            p2_price: lastComparisonResult.energyCosts?.[1]?.price || lastComparisonResult.energyCosts?.[1]?.price_euro_kwh,
                            p3_price: lastComparisonResult.energyCosts?.[2]?.price || lastComparisonResult.energyCosts?.[2]?.price_euro_kwh,
                            p4_price: lastComparisonResult.energyCosts?.[3]?.price || lastComparisonResult.energyCosts?.[3]?.price_euro_kwh,
                            p5_price: lastComparisonResult.energyCosts?.[4]?.price || lastComparisonResult.energyCosts?.[4]?.price_euro_kwh,
                            p6_price: lastComparisonResult.energyCosts?.[5]?.price || lastComparisonResult.energyCosts?.[5]?.price_euro_kwh
                        },
                        totalAnnual: lastComparisonResult.totalAnnual,
                        originalBillAnnual: lastComparisonResult.originalBillAnnual || (lastComparisonResult.importe_total || 0) * 12,
                        data: lastComparisonResult,
                        electricityBreakdown: {
                            energyCosts: lastComparisonResult.energyCosts || [],
                            powerCosts: lastComparisonResult.powerCosts || [],
                            subEnergy: lastComparisonResult.subEnergyNet || 0,
                            subPower: lastComparisonResult.subPower || 0,
                            subBase: lastComparisonResult.subBase || 0,
                            costIE: lastComparisonResult.costIE || 0,
                            baseImp: lastComparisonResult.baseImp || 0,
                            costIVA: lastComparisonResult.costIVA || 0,
                            totalPeriod: lastComparisonResult.totalPeriod || 0,
                            totalAnnual: lastComparisonResult.totalAnnual || 0,
                            ahorro_mensual: (lastComparisonResult.originalBillPeriod || 0) - (lastComparisonResult.totalPeriod || 0),
                            ahorro_anual: (lastComparisonResult.originalBillAnnual || 0) - (lastComparisonResult.totalAnnual || 0),
                            dias: lastComparisonResult.dias_facturados || 30
                        },
                        results: {
                            drk: comparisonMode === 'overall_best' ? {
                                total: 0,
                                total_anual: 0
                            } : {
                                total: lastComparisonResult.totalAnnual / 12,
                                total_anual: lastComparisonResult.totalAnnual
                            },
                            powercup: comparisonMode === 'overall_best' ? {
                                total: lastComparisonResult.totalAnnual / 12,
                                total_anual: lastComparisonResult.totalAnnual
                            } : {
                                total: 0,
                                total_anual: 0
                            }
                        }
                    };
                    
                    // A√ëADIR al array
                    dualSupplies.push(newSupply);
                    
                    console.log('‚úÖ Suministro a√±adido al array');
                    console.log('  - Total suministros:', dualSupplies.length);
                    console.log('  - CUPS:', newSupply.cups);
                    console.log('  - Tarifa:', newSupply.tariff);
                    console.log('  - Coste anual:', newSupply.totalAnnual);
                    
                    // Actualizar UI
                    updateDualSuppliesList();
                    console.log('‚úÖ UI actualizada');
                    
                    // Cerrar modales
                    const offerModal = document.getElementById('offer-decision-modal');
                    if (offerModal) {
                        offerModal.classList.add('hidden');
                        offerModal.classList.remove('flex');
                    }
                    
                    // Ocultar todas las pantallas
                    hideAllScreens();
                    
                    // Volver a pantalla DUAL
                    document.getElementById('screen-dual').classList.add('active');
                    
                    console.log('‚úÖ Volviendo a pantalla DUAL');
                    return;
                } catch (error) {
                    console.error('‚ùå ERROR en interceptor DUAL:', error);
                    alert('Error al a√±adir suministro: ' + error.message);
                    return;
                }
            }
            
            // Verificar si estamos en contexto MultiCups
            if (lastComparisonResult._multiCupsContext) {
                // Contexto MultiCups: A√±adir a la lista (sin indexado)
                addSupplyToMultiCupsList(lastComparisonResult, null);
            } else {
                // Contexto individual: Mostrar resultados (sin indexado)
                renderResultsUI(lastComparisonResult, null);
                document.getElementById('screen-inicio').classList.remove('active'); // Ocultar pantalla inicio
                document.getElementById('initial-view').classList.add('hidden');
                document.getElementById('scanner-view').classList.add('hidden');
                document.getElementById('results-view').classList.remove('hidden');
                document.getElementById('results-view').classList.add('animate-fade-in-up');
                hideNavbar(); // Ocultar navbar al mostrar resultados
            }
        }
        
        function toggleIndexedComparison(checked) {
            compareWithIndexed = checked;
            console.log('Comparaci√≥n con indexadas:', compareWithIndexed ? 'ACTIVADA' : 'DESACTIVADA');
        }
        
        // Nueva funci√≥n para calcular la mejor oferta indexada (DRK INDEX)
        function calculateIndexedOffer(data, tariffType) {
            const tariffsToCompare = currentTariffs[tariffType] || [];
            
            // Filtrar solo tarifas DRK INDEX (SIEMPRE de DRK, independientemente del modo)
            const indexedTariffs = tariffsToCompare.filter(t => {
                const name = (t.name || '').toUpperCase();
                const description = (t.description || '').toUpperCase();
                const commercializer = (t.commercializer || '').toUpperCase();
                
                // CR√çTICO: Debe contener "INDEX" Y ser de DRK
                const hasIndex = name.includes('INDEX') || description.includes('INDEX') || commercializer.includes('INDEX');
                const isDrk = t.isDrk === true || commercializer.includes('DRK') || name.includes('DRK');
                
                return hasIndex && isDrk;
            });
            
            console.log(`üîç Tarifas DRK INDEX encontradas para ${tariffType}:`, indexedTariffs.length);
            if (indexedTariffs.length > 0) {
                console.log('üìã Tarifas DRK INDEX:', indexedTariffs.map(t => t.name).join(', '));
            }
            
            if (indexedTariffs.length === 0) {
                console.warn('‚ö†Ô∏è  No se encontraron tarifas DRK INDEX');
                return null;
            }
            
            // Calcular coste para cada tarifa indexada
            const indexedResults = indexedTariffs.map(t => {
                const result = calculateTariffCost(t, data, tariffType);
                // CR√çTICO: Asegurar que tiene originalTariffType
                if (!result.originalTariffType) {
                    result.originalTariffType = tariffType;
                }
                return result;
            });
            
            // Encontrar la mejor tarifa indexada (menor coste anual)
            let bestIndexed = null;
            indexedResults.forEach(r => {
                r.savings = r.originalBillAnnual - r.totalAnnual;
                if (r.savings > 0) {
                    if (!bestIndexed || r.totalAnnual < bestIndexed.totalAnnual) {
                        bestIndexed = r;
                    }
                }
            });
            
            if (bestIndexed) {
                bestIndexed.isIndexed = true; // Marcar como resultado indexado
                // CR√çTICO: Asegurar que tiene originalTariffType
                if (!bestIndexed.originalTariffType) {
                    bestIndexed.originalTariffType = tariffType;
                }
                console.log('‚úÖ Mejor tarifa DRK INDEX:', bestIndexed.offer.name, 'Ahorro:', bestIndexed.savings);
                console.log('‚úÖ originalTariffType asignado:', bestIndexed.originalTariffType);
            } else {
                console.warn('‚ö†Ô∏è  No se encontr√≥ ninguna tarifa DRK INDEX con ahorro positivo');
            }
            
            return bestIndexed;
        }
        
        function selectBestOptionDirect() {
            console.log('=================================================');
            console.log('‚ö°‚ö°‚ö° selectBestOptionDirect LLAMADA ‚ö°‚ö°‚ö°');
            console.log('dualMode:', window.dualMode);
            console.log('compareWithIndexed:', compareWithIndexed);
            console.log('lastComparisonResult exists:', !!lastComparisonResult);
            console.log('comparisonMode:', comparisonMode);
            console.log('=================================================');
            
            // Cerrar modal de decisi√≥n
            closeOfferDecisionModal();
            
            // Usar el resultado que ya estaba calculado (lastComparisonResult)
            if (!lastComparisonResult) {
                console.error('‚ùå No hay lastComparisonResult');
                window.showErrorModal('No hay resultado disponible');
                return;
            }
            
            console.log('‚úÖ lastComparisonResult OK, continuando...');
            
            // ‚ö°‚ö°‚ö° INTERCEPTOR MODO DUAL ‚ö°‚ö°‚ö°
            if (window.dualMode === true) {
                console.log('===== üî• MODO DUAL - A√±adiendo directamente al array =====');
                
                try {
                    // CREAR el objeto de suministro CON DESGLOSE COMPLETO
                    const newSupply = {
                        type: 'electricidad',
                        cups: lastComparisonResult.cups || '',
                        tariff: lastComparisonResult.tariffType || currentTariffType || '2.0TD',
                        offer: {
                            ...lastComparisonResult.offer,
                            p1_power_price: lastComparisonResult.powerCosts?.[0]?.priceDay || lastComparisonResult.powerCosts?.[0]?.price_euro_kw_day,
                            p2_power_price: lastComparisonResult.powerCosts?.[1]?.priceDay || lastComparisonResult.powerCosts?.[1]?.price_euro_kw_day,
                            p1_price: lastComparisonResult.energyCosts?.[0]?.price || lastComparisonResult.energyCosts?.[0]?.price_euro_kwh,
                            p2_price: lastComparisonResult.energyCosts?.[1]?.price || lastComparisonResult.energyCosts?.[1]?.price_euro_kwh,
                            p3_price: lastComparisonResult.energyCosts?.[2]?.price || lastComparisonResult.energyCosts?.[2]?.price_euro_kwh,
                            p4_price: lastComparisonResult.energyCosts?.[3]?.price || lastComparisonResult.energyCosts?.[3]?.price_euro_kwh,
                            p5_price: lastComparisonResult.energyCosts?.[4]?.price || lastComparisonResult.energyCosts?.[4]?.price_euro_kwh,
                            p6_price: lastComparisonResult.energyCosts?.[5]?.price || lastComparisonResult.energyCosts?.[5]?.price_euro_kwh
                        },
                        totalAnnual: lastComparisonResult.totalAnnual,
                        originalBillAnnual: lastComparisonResult.originalBillAnnual || (lastComparisonResult.importe_total || 0) * 12,
                        data: lastComparisonResult,
                        electricityBreakdown: {
                            energyCosts: lastComparisonResult.energyCosts || [],
                            powerCosts: lastComparisonResult.powerCosts || [],
                            subEnergy: lastComparisonResult.subEnergyNet || 0,
                            subPower: lastComparisonResult.subPower || 0,
                            subBase: lastComparisonResult.subBase || 0,
                            costIE: lastComparisonResult.costIE || 0,
                            baseImp: lastComparisonResult.baseImp || 0,
                            costIVA: lastComparisonResult.costIVA || 0,
                            totalPeriod: lastComparisonResult.totalPeriod || 0,
                            totalAnnual: lastComparisonResult.totalAnnual || 0,
                            ahorro_mensual: (lastComparisonResult.originalBillPeriod || 0) - (lastComparisonResult.totalPeriod || 0),
                            ahorro_anual: (lastComparisonResult.originalBillAnnual || 0) - (lastComparisonResult.totalAnnual || 0),
                            dias: lastComparisonResult.dias_facturados || 30
                        },
                        results: {
                            drk: comparisonMode === 'overall_best' ? {
                                total: 0,
                                total_anual: 0
                            } : {
                                total: lastComparisonResult.totalAnnual / 12,
                                total_anual: lastComparisonResult.totalAnnual
                            },
                            powercup: comparisonMode === 'overall_best' ? {
                                total: lastComparisonResult.totalAnnual / 12,
                                total_anual: lastComparisonResult.totalAnnual
                            } : {
                                total: 0,
                                total_anual: 0
                            }
                        }
                    };
                    
                    // A√ëADIR al array
                    dualSupplies.push(newSupply);
                    
                    console.log('‚úÖ Suministro a√±adido al array');
                    console.log('  - Total suministros:', dualSupplies.length);
                    console.log('  - CUPS:', newSupply.cups);
                    console.log('  - Tarifa:', newSupply.tariff);
                    console.log('  - Coste anual:', newSupply.totalAnnual);
                    
                    // Actualizar UI
                    updateDualSuppliesList();
                    console.log('‚úÖ UI actualizada');
                    
                    // Cerrar modales
                    const offerModal = document.getElementById('offer-decision-modal');
                    if (offerModal) {
                        offerModal.classList.add('hidden');
                        offerModal.classList.remove('flex');
                    }
                    
                    // Ocultar todas las pantallas
                    hideAllScreens();
                    
                    // Volver a pantalla DUAL
                    document.getElementById('screen-dual').classList.add('active');
                    
                    console.log('‚úÖ Volviendo a pantalla DUAL');
                    return; // CR√çTICO: Salir aqu√≠
                } catch (error) {
                    console.error('‚ùå ERROR en interceptor DUAL:', error);
                    alert('Error al a√±adir suministro: ' + error.message);
                    return;
                }
            }
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // ARREGLO: Cuando compareWithIndexed = true, calcular FIJO vs INDEXADO correctamente
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (compareWithIndexed) {
                console.log('üîß Comparaci√≥n FIJO vs INDEXADO activada');
                
                const tariffType = lastComparisonResult._multiCupsContext 
                    ? lastComparisonResult._multiCupsContext.tariffType 
                    : lastComparisonResult.originalTariffType || currentTariffType;
                
                const dataForCalc = lastComparisonResult._multiCupsContext 
                    ? lastComparisonResult._multiCupsContext.dataForCalc 
                    : lastComparisonResult;
                
                // CR√çTICO: Preservar _multiCupsContext ANTES de recalcular
                const preservedContext = lastComparisonResult._multiCupsContext 
                    ? JSON.parse(JSON.stringify(lastComparisonResult._multiCupsContext))
                    : null;
                
                console.log('üîç Contexto MULTICUPS preservado:', preservedContext ? 'S√ç' : 'NO');
                
                // PASO 1: Recalcular la MEJOR OFERTA FIJA (sin indexadas)
                console.log('üìä Calculando mejor oferta FIJA...');
                console.log('üîç Modo de comparaci√≥n actual:', comparisonMode);
                console.log('üîç Marca activa:', activeBrand.NAME);
                
                const tarifasDisponibles = currentTariffs[tariffType] || [];
                
                // Filtrar SOLO tarifas FIJAS (excluir indexadas)
                const tarifasFijas = tarifasDisponibles.filter(t => {
                    const name = (t.name || '').toUpperCase();
                    const desc = (t.description || '').toUpperCase();
                    return !name.includes('INDEX') && !desc.includes('INDEX');
                });
                
                console.log(`Tarifas FIJAS encontradas: ${tarifasFijas.length} de ${tarifasDisponibles.length}`);
                
                // NUEVA L√ìGICA: Filtrar seg√∫n DRK o POWER CUP
                const isDrkMode = activeBrand.NAME.includes('DRK');
                
                let tarifasFijasFiltradas;
                if (isDrkMode) {
                    // MODO DRK: Solo tarifas FIJAS de DRK
                    tarifasFijasFiltradas = tarifasFijas.filter(t => t.isDrk);
                    console.log('üîµ Modo DRK: Filtrando solo tarifas FIJAS de DRK');
                } else {
                    // MODO POWER CUP: Todas las tarifas FIJAS (cualquier comercializadora)
                    tarifasFijasFiltradas = tarifasFijas;
                    console.log('üü¢ Modo POWER CUP: Aceptando tarifas FIJAS de cualquier comercializadora');
                }
                
                console.log(`Tarifas FIJAS despu√©s de filtro DRK/POWER: ${tarifasFijasFiltradas.length}`);
                
                // Calcular la mejor oferta FIJA
                const resultadosFijos = tarifasFijasFiltradas.map(t => calculateTariffCost(t, dataForCalc, tariffType));
                let mejorFija = null;
                
                resultadosFijos.forEach(r => {
                    if (!mejorFija || r.totalAnnual < mejorFija.totalAnnual) {
                        mejorFija = r;
                    }
                });
                
                if (!mejorFija) {
                    const modoTexto = isDrkMode ? 'DRK' : 'cualquier comercializadora';
                    window.showErrorModal(`No se encontraron tarifas FIJAS de ${modoTexto}.`);
                    return;
                }
                
                console.log('‚úÖ Mejor oferta FIJA:', mejorFija.offer.name, mejorFija.totalAnnual);
                
                // PASO 2: Calcular la MEJOR OFERTA INDEXADA
                console.log('üìä Calculando mejor oferta INDEXADA...');
                lastIndexedResult = calculateIndexedOffer(dataForCalc, tariffType);
                
                if (!lastIndexedResult) {
                    window.showErrorModal('No se encontraron tarifas indexadas DRK INDEX para comparar.');
                    lastIndexedResult = null;
                    compareWithIndexed = false;
                    document.getElementById('compare-indexed-checkbox').checked = false;
                    return;
                }
                
                console.log('‚úÖ Mejor oferta INDEXADA:', lastIndexedResult.offer.name, lastIndexedResult.totalAnnual);
                
                // PASO 3: Actualizar lastComparisonResult con la mejor FIJA
                lastComparisonResult = mejorFija;
                
                // CR√çTICO: RESTAURAR el contexto preservado
                if (preservedContext) {
                    lastComparisonResult._multiCupsContext = preservedContext;
                    console.log('‚úÖ Contexto MULTICUPS restaurado correctamente');
                } else {
                    console.log('‚ö†Ô∏è  No hab√≠a contexto MULTICUPS que restaurar');
                }
            }
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // FIN ARREGLO
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            
            // Verificar si estamos en contexto MultiCups
            if (lastComparisonResult._multiCupsContext) {
                // Contexto MultiCups: A√±adir a la lista
                addSupplyToMultiCupsList(lastComparisonResult, lastIndexedResult);
            } else {
                // Contexto individual: Mostrar resultados
                renderResultsUI(lastComparisonResult, lastIndexedResult);
                document.getElementById('screen-inicio').classList.remove('active'); // Ocultar pantalla inicio
                document.getElementById('initial-view').classList.add('hidden');
                document.getElementById('scanner-view').classList.add('hidden');
                document.getElementById('results-view').classList.remove('hidden');
                document.getElementById('results-view').classList.add('animate-fade-in-up');
                hideNavbar(); // Ocultar navbar al mostrar resultados
            }
        }
        
        function selectFromResults() {
            // Cerrar modal de decisi√≥n
            closeOfferDecisionModal();
            
            // Mostrar modal de selecci√≥n de ofertas
            if (lastComparisonResult && availableOffers.length > 0) {
                showOfferSelectionModal(lastComparisonResult.cups);
            } else {
                window.showErrorModal('No hay ofertas disponibles para seleccionar');
            }
        }
        
        // NUEVA: Funci√≥n para hacer copia profunda de una oferta
        function deepCopyOffer(offer) {
            if (!offer) return offer;
            
            // Hacer copia profunda del objeto oferta
            return JSON.parse(JSON.stringify(offer));
        }
        
        // NUEVA: Funci√≥n para recalcular energyCosts y powerCosts correctamente
        function recalculateCostsForOffer(baseData, selectedOffer) {
            const tariffType = baseData.originalTariffType;
            
            console.log('Recalculating costs for:', selectedOffer.name, '(', tariffType, ')');
            
            // CR√çTICO: Buscar la tarifa ORIGINAL en currentTariffs
            // en lugar de usar selectedOffer que puede estar contaminado
            const originalTariff = currentTariffs[tariffType]?.find(t => 
                t.name === selectedOffer.name && t.description === selectedOffer.description
            );
            
            if (!originalTariff) {
                console.error('‚ùå Original tariff not found in currentTariffs for:', selectedOffer.name);
                // Fallback: usar selectedOffer si no se encuentra
                return recalculateCostsFromOffer(baseData, selectedOffer, tariffType);
            }
            
            console.log('‚úÖ Using original tariff from CSV');
            
            // Usar la tarifa ORIGINAL, no selectedOffer
            return recalculateCostsFromOffer(baseData, originalTariff, tariffType);
        }
        
        // Funci√≥n auxiliar que hace el c√°lculo real
        function recalculateCostsFromOffer(baseData, tariffOffer, tariffType) {
            const recalculatedEnergyCosts = [];
            const recalculatedPowerCosts = [];
            
            // CR√çTICO: Extraer valores primitivos ANTES de usarlos
            // Esto evita cualquier referencia compartida
            const offerPrices = {
                p1_price: Number(tariffOffer.p1_price) || 0,
                p2_price: Number(tariffOffer.p2_price) || 0,
                p3_price: Number(tariffOffer.p3_price) || 0,
                p4_price: Number(tariffOffer.p4_price) || 0,
                p5_price: Number(tariffOffer.p5_price) || 0,
                p6_price: Number(tariffOffer.p6_price) || 0,
                p_potencia_1: Number(tariffOffer.p_potencia_1) || 0,
                p_potencia_2: Number(tariffOffer.p_potencia_2) || 0,
                p_potencia_3: Number(tariffOffer.p_potencia_3) || 0,
                p_potencia_4: Number(tariffOffer.p_potencia_4) || 0,
                p_potencia_5: Number(tariffOffer.p_potencia_5) || 0,
                p_potencia_6: Number(tariffOffer.p_potencia_6) || 0
            };
            
            console.log('Extracted prices (primitives):', offerPrices);
            
            if (tariffType === '2.0TD') {
                // Calcular energ√≠a para 2.0TD (3 periodos)
                const consumos = [
                    baseData.consumo_punta || 0,
                    baseData.consumo_llano || 0,
                    baseData.consumo_valle || 0
                ];
                const preciosEnergia = [
                    offerPrices.p1_price,
                    offerPrices.p2_price,
                    offerPrices.p3_price
                ];
                
                console.log('2.0TD Consumos:', consumos);
                console.log('2.0TD Precios:', preciosEnergia);
                
                for (let i = 0; i < 3; i++) {
                    recalculatedEnergyCosts.push({
                        period: i + 1,
                        kwh: consumos[i],
                        price: preciosEnergia[i],
                        cost: consumos[i] * preciosEnergia[i]
                    });
                }
                
                // Calcular potencia para 2.0TD (2 periodos)
                const potencias = [
                    baseData.potencia_p1_kw || 0,
                    baseData.potencia_p2_kw || 0
                ];
                const preciosPotencia = [
                    offerPrices.p_potencia_1 / 365,
                    offerPrices.p_potencia_2 / 365
                ];
                const diasFacturados = baseData.dias_facturados || 30;
                
                for (let i = 0; i < 2; i++) {
                    recalculatedPowerCosts.push({
                        period: i + 1,
                        kw: potencias[i],
                        priceDay: preciosPotencia[i],
                        cost: potencias[i] * preciosPotencia[i] * diasFacturados
                    });
                }
            } else if (tariffType === '3.0TD') {
                // IMPORTANTE: Algunas tarifas 3.0TD solo tienen 3 precios definidos
                // Necesitamos propagar los precios existentes a los 6 periodos
                
                // Detectar si la tarifa tiene 6 precios o solo 3
                const hasFull6Periods = offerPrices.p4_price > 0;
                
                let prices = [];
                if (hasFull6Periods) {
                    // Tarifa con 6 periodos completos
                    prices = [
                        offerPrices.p1_price,
                        offerPrices.p2_price,
                        offerPrices.p3_price,
                        offerPrices.p4_price,
                        offerPrices.p5_price,
                        offerPrices.p6_price
                    ];
                } else {
                    // Tarifa con solo 3 precios: propagar P1->P1/P4, P2->P2/P5, P3->P3/P6
                    prices = [
                        offerPrices.p1_price,
                        offerPrices.p2_price,
                        offerPrices.p3_price,
                        offerPrices.p1_price,
                        offerPrices.p2_price,
                        offerPrices.p3_price
                    ];
                    console.log('3.0TD tariff has only 3 periods, propagating prices:', prices);
                }
                
                // Detectar si la tarifa tiene 6 precios de potencia o solo 2
                const hasFull6PowerPrices = offerPrices.p_potencia_3 > 0;
                
                let powerPrices = [];
                if (hasFull6PowerPrices) {
                    powerPrices = [
                        offerPrices.p_potencia_1 / 365,
                        offerPrices.p_potencia_2 / 365,
                        offerPrices.p_potencia_3 / 365,
                        offerPrices.p_potencia_4 / 365,
                        offerPrices.p_potencia_5 / 365,
                        offerPrices.p_potencia_6 / 365
                    ];
                } else {
                    // Solo tiene P1 y P2: propagar P1->P1/P3/P5, P2->P2/P4/P6
                    const p1 = offerPrices.p_potencia_1 / 365;
                    const p2 = offerPrices.p_potencia_2 / 365;
                    powerPrices = [p1, p2, p1, p2, p1, p2];
                    console.log('3.0TD tariff has only 2 power prices, propagating:', powerPrices);
                }
                
                // Calcular energ√≠a para 3.0TD (6 periodos)
                for (let i = 1; i <= 6; i++) {
                    const kwh = baseData[`consumo_p${i}`] || 0;
                    const price = prices[i - 1];
                    console.log(`Period ${i}: kwh=${kwh}, price=${price}`);
                    recalculatedEnergyCosts.push({
                        period: i,
                        kwh: kwh,
                        price: price,
                        cost: kwh * price
                    });
                }
                
                // Calcular potencia para 3.0TD (6 periodos)
                const diasFacturados = baseData.dias_facturados || 30;
                console.log('D√≠as facturados:', diasFacturados);
                
                for (let i = 1; i <= 6; i++) {
                    const kw = baseData[`potencia_p${i}_kw`] || 0;
                    const priceDay = powerPrices[i - 1];
                    console.log(`Power P${i}: kw=${kw}, priceDay=${priceDay}`);
                    recalculatedPowerCosts.push({
                        period: i,
                        kw: kw,
                        priceDay: priceDay,
                        cost: kw * priceDay * diasFacturados
                    });
                }
            }
            
            console.log('Recalculated energy costs periods:', recalculatedEnergyCosts.length);
            console.log('Recalculated power costs periods:', recalculatedPowerCosts.length);
            
            // Calcular subtotales
            const subPower = recalculatedPowerCosts.reduce((sum, p) => sum + p.cost, 0);
            const subEnergyNet = recalculatedEnergyCosts.reduce((sum, e) => sum + e.cost, 0);
            
            console.log('Recalculated subPower:', subPower);
            console.log('Recalculated subEnergyNet:', subEnergyNet);
            console.log('=== END RECALCULATE DEBUG ===');
            
            return {
                energyCosts: recalculatedEnergyCosts,
                powerCosts: recalculatedPowerCosts,
                subPower: subPower,
                subEnergyNet: subEnergyNet
            };
        }
        
        // Nueva funci√≥n para a√±adir suministro a MultiCups despu√©s de elegir
        function addSupplyToMultiCupsList(result, resultIndexed = null) {
            console.log('addSupplyToMultiCupsList called with result:', result);
            console.log('Result offer:', result.offer);
            console.log('Result originalTariffType:', result.originalTariffType);
            console.log('Result tiene indexedComparison?:', !!result.indexedComparison);
            
            if (result.indexedComparison) {
                console.log('indexedComparison encontrado en result:', result.indexedComparison);
                console.log('indexedComparison tiene powerCosts?:', !!result.indexedComparison.powerCosts);
                console.log('indexedComparison tiene energyCosts?:', !!result.indexedComparison.energyCosts);
            }
            
            if (resultIndexed) {
                console.log('Tambi√©n recibido resultado indexado como par√°metro:', resultIndexed.offer.name);
            }
            
            // IMPORTANTE: Preservar indexedComparison ANTES de recalcular
            // Usar copia profunda para evitar modificaciones por referencia
            const preservedIndexedComparison = result.indexedComparison 
                ? JSON.parse(JSON.stringify(result.indexedComparison))
                : null;
            
            // Asegurar que el originalTariffType est√© presente
            if (!result.originalTariffType && result._multiCupsContext) {
                result.originalTariffType = result._multiCupsContext.tariffType;
                console.log('Set originalTariffType from context:', result.originalTariffType);
            }
            
            // IMPORTANTE: Recalcular costes para asegurar que 3.0TD tenga 6 periodos
            if (result.offer && result.originalTariffType) {
                const recalculated = recalculateCostsForOffer(result, result.offer);
                result.energyCosts = recalculated.energyCosts;
                result.powerCosts = recalculated.powerCosts;
                result.subPower = recalculated.subPower;
                result.subEnergyNet = recalculated.subEnergyNet;
                console.log('Costs recalculated for', result.originalTariffType);
                console.log('New subPower:', result.subPower, 'New subEnergyNet:', result.subEnergyNet);
            }
            
            // RESTAURAR indexedComparison preservado
            if (preservedIndexedComparison) {
                result.indexedComparison = preservedIndexedComparison;
                console.log('Restaurado indexedComparison preservado');
            }
            
            // Si hay resultado indexado como par√°metro, tambi√©n recalcular sus costes
            if (resultIndexed && resultIndexed.offer && resultIndexed.originalTariffType) {
                console.log('üîç Recalculando costes para resultado INDEXADO:', resultIndexed.offer.name);
                console.log('üîç originalTariffType del indexado:', resultIndexed.originalTariffType);
                console.log('üîç totalAnnual del indexado ANTES de recalcular:', resultIndexed.totalAnnual);
                console.log('üîç savings del indexado ANTES de recalcular:', resultIndexed.savings);
                
                const recalculatedIndexed = recalculateCostsForOffer(resultIndexed, resultIndexed.offer);
                resultIndexed.energyCosts = recalculatedIndexed.energyCosts;
                resultIndexed.powerCosts = recalculatedIndexed.powerCosts;
                resultIndexed.subPower = recalculatedIndexed.subPower;
                resultIndexed.subEnergyNet = recalculatedIndexed.subEnergyNet;
                console.log('‚úÖ Costs recalculated for indexed:', resultIndexed.originalTariffType);
                console.log('‚úÖ subPower indexado:', resultIndexed.subPower);
                console.log('‚úÖ subEnergyNet indexado:', resultIndexed.subEnergyNet);
                console.log('‚úÖ Ahorro indexado:', resultIndexed.savings);
                console.log('‚úÖ Total anual indexado:', resultIndexed.totalAnnual);
                
                // A√±adirlo al resultado principal
                result.indexedComparison = resultIndexed;
                console.log('‚úÖ indexedComparison asignado a result');
                console.log('‚úÖ indexedComparison final:', {
                    offer: result.indexedComparison.offer.name,
                    totalAnnual: result.indexedComparison.totalAnnual,
                    savings: result.indexedComparison.savings,
                    originalTariffType: result.indexedComparison.originalTariffType
                });
            } else if (resultIndexed) {
                console.error('‚ùå‚ùå‚ùå resultIndexed no tiene offer o originalTariffType ‚ùå‚ùå‚ùå');
                console.error('resultIndexed recibido:', resultIndexed);
                console.error('Details:', {
                    hasOffer: !!resultIndexed.offer,
                    hasOriginalTariffType: !!resultIndexed.originalTariffType,
                    offer: resultIndexed.offer,
                    originalTariffType: resultIndexed.originalTariffType
                });
            } else {
                console.warn('‚ö†Ô∏è  resultIndexed es null/undefined - NO hay comparaci√≥n indexada');
            }
            
            // Limpiar el contexto temporal
            delete result._multiCupsContext;
            
            // LOGS FINALES antes de a√±adir
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üìã SUMINISTRO LISTO PARA A√ëADIR A multiCupsData:');
            console.log('  CUPS:', result.cups);
            console.log('  Oferta FIJA:', result.offer.name);
            console.log('  Total Annual FIJO:', result.totalAnnual);
            console.log('  Savings FIJO:', result.savings);
            console.log('  originalTariffType FIJO:', result.originalTariffType);
            if (result.indexedComparison) {
                console.log('  ‚úÖ TIENE indexedComparison:');
                console.log('    Oferta INDEXADA:', result.indexedComparison.offer.name);
                console.log('    Total Annual INDEXADO:', result.indexedComparison.totalAnnual);
                console.log('    Savings INDEXADO:', result.indexedComparison.savings);
                console.log('    originalTariffType INDEXADO:', result.indexedComparison.originalTariffType);
            } else {
                console.log('  ‚ùå NO tiene indexedComparison');
            }
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            // A√±adir a la lista
            multiCupsData.push(result);
            console.log('multiCupsData after push:', multiCupsData);
            
            // Actualizar UI y volver a la vista SAGA
            document.getElementById('tariff-display-badge').textContent = multiCupsData.length;
            
            window.showMessageModal(`Suministro ${result.cups} (${result.offer.name}) a√±adido. Total: ${multiCupsData.length}`, "Suministro A√±adido");
            
            document.getElementById('initial-view').classList.add('hidden');
            showMultiCupsSagaView();
        }
        
        // Funciones para el modal de selecci√≥n de ofertas
        function showOfferSelectionModal(cups) {
            // Mostrar CUPS en el modal
            document.getElementById('modal-selection-cups').textContent = cups;
            
            // Inicializar contadores y limpiar filtros
            document.getElementById('offers-total-count').textContent = availableOffers.length;
            document.getElementById('offers-visible-count').textContent = availableOffers.length;
            document.getElementById('offer-search-input').value = '';
            document.getElementById('offer-sort-select').value = 'savings_desc';
            
            // Renderizar ofertas
            renderOffersList();
            
            // Mostrar modal
            document.getElementById('offer-selection-modal').classList.remove('hidden');
            document.getElementById('offer-selection-modal').classList.add('flex');
            
            // CR√çTICO: Traducir contenido del modal
            if (window.translateAll) {
                setTimeout(() => window.translateAll(), 50);
            }
            
            // Deshabilitar bot√≥n de confirmar inicialmente
            document.getElementById('confirm-offer-selection-btn').disabled = true;
            manuallySelectedOffer = null;
        }
        
        // NUEVA: Funci√≥n para renderizar la lista de ofertas
        function renderOffersList() {
            const searchTerm = document.getElementById('offer-search-input').value.toLowerCase();
            const sortBy = document.getElementById('offer-sort-select').value;
            
            const container = document.getElementById('offers-radio-list');
            const noResultsMsg = document.getElementById('no-offers-message');
            
            // Filtrar ofertas
            let filteredOffers = availableOffers.map((offer, originalIndex) => ({
                offer: offer,
                originalIndex: originalIndex
            })).filter(item => {
                if (searchTerm === '') return true;
                
                const offerName = item.offer.offer.name.toLowerCase();
                const commercializer = item.offer.offer.isDrk ? 'drk energ√≠a' : (item.offer.offer.commercializer || '').toLowerCase();
                const description = (item.offer.offer.description || '').toLowerCase();
                
                return offerName.includes(searchTerm) || 
                       commercializer.includes(searchTerm) || 
                       description.includes(searchTerm);
            });
            
            // Ordenar ofertas filtradas
            filteredOffers.sort((a, b) => {
                switch(sortBy) {
                    case 'savings_desc':
                        return b.offer.savings - a.offer.savings;
                    case 'savings_asc':
                        return a.offer.savings - b.offer.savings;
                    case 'name_asc':
                        return a.offer.offer.name.localeCompare(b.offer.offer.name);
                    case 'name_desc':
                        return b.offer.offer.name.localeCompare(a.offer.offer.name);
                    default:
                        return 0;
                }
            });
            
            // Actualizar contador
            document.getElementById('offers-visible-count').textContent = filteredOffers.length;
            
            // Limpiar contenedor
            container.innerHTML = '';
            
            // Mostrar/ocultar mensaje de "no hay resultados"
            if (filteredOffers.length === 0) {
                noResultsMsg.classList.remove('hidden');
                container.classList.add('hidden');
                return;
            } else {
                noResultsMsg.classList.add('hidden');
                container.classList.remove('hidden');
            }
            
            // Renderizar ofertas
            const eur = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n || 0);
            
            filteredOffers.forEach(item => {
                const offer = item.offer;
                const originalIndex = item.originalIndex;
                const commercializer = offer.offer.isDrk ? 'DRK Energ√≠a' : (offer.offer.commercializer || 'Otra comercializadora');
                const description = offer.offer.description || '';
                const name = offer.offer.name || '';
                
                // Para DRK, usar el campo que tenga m√°s informaci√≥n como t√≠tulo
                let displayTitle, displaySubtitle;
                if (offer.offer.isDrk) {
                    // Si description es m√°s largo que name, usarlo como t√≠tulo
                    if (description.length > name.length) {
                        displayTitle = description;
                        displaySubtitle = name; // Usar name como subt√≠tulo
                    } else {
                        // Si name es m√°s largo o igual, usarlo como t√≠tulo
                        displayTitle = name;
                        displaySubtitle = description; // Usar description como subt√≠tulo
                    }
                } else {
                    displayTitle = name;
                    displaySubtitle = `${commercializer}${description && description !== name ? ' - ' + description : ''}`;
                }
                
                const offerCard = document.createElement('label');
                offerCard.className = 'offer-radio-card block cursor-pointer';
                offerCard.innerHTML = `
                    <input type="radio" name="selected_offer" value="${originalIndex}" class="hidden">
                    <div class="offer-card-content flex items-start gap-4 p-4 rounded-xl border-2 border-slate-300 bg-white transition hover:border-drk-400 hover:bg-drk-50">
                        <svg class="w-5 h-5 mt-0.5 flex-shrink-0 text-slate-400 checkmark-offer hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <div class="flex-1">
                            <p class="font-bold text-base text-slate-900">${displayTitle}</p>
                            <p class="text-sm text-slate-600">${displaySubtitle}</p>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <p class="text-xs text-slate-500">${tr('Ahorro anual')}</p>
                            <p class="text-xl font-black text-green-600">${eur(offer.savings)}</p>
                        </div>
                    </div>
                `;
                container.appendChild(offerCard);
            });
            
            // A√±adir event listeners a los radio buttons
            document.querySelectorAll('input[name="selected_offer"]').forEach(radio => {
                radio.addEventListener('change', handleOfferRadioChange);
            });
        }
        
        // NUEVAS FUNCIONES: Filtrado y ordenaci√≥n de ofertas
        function filterAndSortOffers() {
            renderOffersList();
        }
        
        function clearOfferFilters() {
            document.getElementById('offer-search-input').value = '';
            document.getElementById('offer-sort-select').value = 'savings_desc';
            renderOffersList();
        }
        
        function handleOfferRadioChange(e) {
            const selectedIndex = parseInt(e.target.value);
            
            // CR√çTICO: No guardar el objeto completo de availableOffers
            // Solo guardar la informaci√≥n necesaria para buscar la tarifa original despu√©s
            const selectedOffer = availableOffers[selectedIndex];
            manuallySelectedOffer = {
                ...selectedOffer,
                // Guardar identificadores para buscar la tarifa original
                _needsOriginalLookup: true,
                _tariffName: selectedOffer.offer.name,
                _tariffDescription: selectedOffer.offer.description,
                _tariffType: selectedOffer.originalTariffType || lastComparisonResult?.originalTariffType
            };
            
            // Actualizar estilos visuales
            document.querySelectorAll('.offer-radio-card').forEach((card) => {
                const radio = card.querySelector('input[type="radio"]');
                const radioValue = parseInt(radio.value);
                const content = card.querySelector('.offer-card-content');
                const check = card.querySelector('.checkmark-offer');
                
                // Comparar por el VALUE del radio, no por el √≠ndice del DOM
                if (radioValue === selectedIndex) {
                    content.className = 'offer-card-content flex items-start gap-4 p-4 rounded-xl border-2 border-drk-500 bg-drk-50 transition';
                    check.classList.remove('hidden');
                    check.classList.add('text-drk-600');
                } else {
                    content.className = 'offer-card-content flex items-start gap-4 p-4 rounded-xl border-2 border-slate-300 bg-white transition hover:border-drk-400 hover:bg-drk-50';
                    check.classList.add('hidden');
                }
            });
            
            // Habilitar bot√≥n de confirmar
            document.getElementById('confirm-offer-selection-btn').disabled = false;
        }
        
        function closeOfferSelectionModal() {
            document.getElementById('offer-selection-modal').classList.add('hidden');
            document.getElementById('offer-selection-modal').classList.remove('flex');
            // NO limpiar manuallySelectedOffer aqu√≠, se limpiar√° despu√©s de usarlo
        }
        
        function confirmOfferSelection() {
            if (!manuallySelectedOffer) return;
            
            // Cerrar modal
            document.getElementById('offer-selection-modal').classList.add('hidden');
            document.getElementById('offer-selection-modal').classList.remove('flex');
            
            // Continuar con el flujo normal mostrando el resultado
            continueWithSelectedOffer();
        }
        
        function continueWithSelectedOffer() {
            console.log('continueWithSelectedOffer called');
            console.log('manuallySelectedOffer:', manuallySelectedOffer);
            console.log('lastComparisonResult:', lastComparisonResult);
            
            // Usar la oferta seleccionada manualmente
            let result = manuallySelectedOffer;
            
            if (!result) {
                console.error('No result available!');
                return;
            }
            
            console.log('Result offer:', result.offer.name);
            
            // Verificar si estamos en contexto MultiCups
            const isMultiCupsContext = lastComparisonResult && lastComparisonResult._multiCupsContext;
            
            if (isMultiCupsContext) {
                // Contexto MultiCups: Necesitamos TODOS los datos de lastComparisonResult
                // pero con la OFERTA seleccionada manualmente
                console.log('MultiCups context: recalculating costs for selected offer');
                
                // CR√çTICO: Si la oferta viene de selecci√≥n manual, buscar la tarifa ORIGINAL
                let offerToUse = result.offer;
                
                if (result._needsOriginalLookup) {
                    const tariffType = lastComparisonResult.originalTariffType;
                    console.log('üîç Looking up original tariff in currentTariffs[' + tariffType + ']');
                    console.log('Searching for:', result.offer.name, '/', result.offer.description);
                    
                    const originalTariff = currentTariffs[tariffType]?.find(t => 
                        t.name === result.offer.name && t.description === result.offer.description
                    );
                    
                    if (originalTariff) {
                        console.log('‚úÖ Found original tariff, using it instead of contaminated offer');
                        offerToUse = originalTariff;
                    } else {
                        console.error('‚ùå Original tariff not found, using provided offer (may be contaminated)');
                    }
                }
                
                // Usar la funci√≥n centralizada para recalcular costes
                const recalculated = recalculateCostsForOffer(lastComparisonResult, offerToUse);
                
                // CR√çTICO: Recalcular totalAnnual y savings usando los costes recalculados
                // No usar result.totalAnnual que puede estar contaminado
                const IVA_RATE = 0.21;
                const IE_RATE = 0.05113;
                const diasFacturados = lastComparisonResult.dias_facturados || 30;
                const factorAnual = 365 / diasFacturados;
                
                const subBase = recalculated.subPower + recalculated.subEnergyNet;
                const costIE = subBase * IE_RATE;
                const baseImp = subBase + costIE;
                const costIVA = baseImp * IVA_RATE;
                const totalPeriod = baseImp + costIVA;
                const totalAnnual = totalPeriod * factorAnual;
                const originalBillAnnual = lastComparisonResult.originalBillAnnual;
                const savings = originalBillAnnual - totalAnnual;
                
                console.log('Recalculated totalAnnual:', totalAnnual, 'savings:', savings);
                
                // Crear un nuevo objeto combinando lastComparisonResult (datos base) 
                // con la oferta elegida manualmente y los costes recalculados
                const combinedResult = {
                    ...lastComparisonResult,  // Todos los datos base (CUPS, consumos, potencias, etc.)
                    offer: deepCopyOffer(offerToUse),  // COPIA PROFUNDA de la oferta ORIGINAL
                    totalAnnual: totalAnnual,  // Coste anual RECALCULADO
                    totalPeriod: totalPeriod,  // Coste periodo RECALCULADO
                    savings: savings,          // Ahorro RECALCULADO
                    energyCosts: recalculated.energyCosts,  // Desglose RECALCULADO de energ√≠a
                    powerCosts: recalculated.powerCosts,    // Desglose RECALCULADO de potencia
                    subPower: recalculated.subPower,        // Subtotal RECALCULADO de potencia
                    subEnergyNet: recalculated.subEnergyNet, // Subtotal RECALCULADO de energ√≠a
                    subBase: subBase,
                    costIE: costIE,
                    baseImp: baseImp,
                    costIVA: costIVA,
                    isNegativeSavings: savings <= 0
                };
                
                console.log('Combined result with recalculated costs:', combinedResult);
                console.log('Energy costs periods:', combinedResult.energyCosts.length);
                console.log('Power costs periods:', combinedResult.powerCosts.length);
                
                // IMPORTANTE: Si compareWithIndexed est√° activo, calcular resultado indexado ANTES de a√±adir a la lista
                if (compareWithIndexed) {
                    const tariffType = lastComparisonResult.originalTariffType;
                    const dataForCalc = lastComparisonResult;
                    const indexedResult = calculateIndexedOffer(dataForCalc, tariffType);
                    
                    if (indexedResult) {
                        // Recalcular costes para resultado indexado
                        const recalculatedIndexed = recalculateCostsForOffer(indexedResult, indexedResult.offer);
                        indexedResult.energyCosts = recalculatedIndexed.energyCosts;
                        indexedResult.powerCosts = recalculatedIndexed.powerCosts;
                        indexedResult.subPower = recalculatedIndexed.subPower;
                        indexedResult.subEnergyNet = recalculatedIndexed.subEnergyNet;
                        
                        // Calcular todos los costes adicionales para indexedResult
                        const subEnergyNetIndexed = indexedResult.subEnergyNet || 0;
                        const subPowerIndexed = indexedResult.subPower || 0;
                        const subBaseIndexed = subPowerIndexed + subEnergyNetIndexed;
                        const costIEIndexed = subBaseIndexed * IE_RATE;
                        const baseImpIndexed = subBaseIndexed + costIEIndexed;
                        const costIVAIndexed = baseImpIndexed * IVA_RATE;
                        const totalPeriodIndexed = baseImpIndexed + costIVAIndexed;
                        const totalAnnualIndexed = totalPeriodIndexed * factorAnual;
                        const savingsIndexed = originalBillAnnual - totalAnnualIndexed;
                        
                        // A√±adir los campos calculados al indexedResult
                        indexedResult.subBase = subBaseIndexed;
                        indexedResult.costIE = costIEIndexed;
                        indexedResult.baseImp = baseImpIndexed;
                        indexedResult.costIVA = costIVAIndexed;
                        indexedResult.totalPeriod = totalPeriodIndexed;
                        indexedResult.totalAnnual = totalAnnualIndexed;
                        indexedResult.savings = savingsIndexed;
                        indexedResult.dias_facturados = combinedResult.dias_facturados;
                        indexedResult.originalBillAnnual = originalBillAnnual;
                        indexedResult.originalBillPeriod = lastComparisonResult.originalBillPeriod;
                        indexedResult.cups = combinedResult.cups;
                        indexedResult.originalTariffType = combinedResult.originalTariffType; // CR√çTICO
                        indexedResult.ieRate = IE_RATE; // A√±adir la tasa del impuesto el√©ctrico
                        indexedResult.discountAmount = indexedResult.discountAmount || 0; // Preservar o inicializar
                        indexedResult.discountRate = indexedResult.discountRate || 0; // Preservar o inicializar
                        indexedResult.subEnergy = indexedResult.subEnergy || indexedResult.subEnergyNet; // Por compatibilidad
                        
                        console.log('indexedResult completo con todos los campos:', {
                            originalTariffType: indexedResult.originalTariffType,
                            powerCosts: indexedResult.powerCosts?.length,
                            energyCosts: indexedResult.energyCosts?.length,
                            dias_facturados: indexedResult.dias_facturados
                        });
                        
                        // A√±adir al resultado combinado ANTES de a√±adir a la lista
                        combinedResult.indexedComparison = indexedResult;
                        console.log('A√±adido resultado indexado completo al combinedResult:', indexedResult);
                    }
                }
                
                // Ahora s√≠, a√±adir a la lista (ya con indexedComparison si corresponde)
                addSupplyToMultiCupsList(combinedResult);
            } else {
                // Contexto individual: Mostrar resultados
                console.log('Individual context, showing results');
                
                // CR√çTICO: Aplicar branding seg√∫n el modo de comparaci√≥n
                // Si el usuario eligi√≥ "POWER CUP Global", SIEMPRE usar POWER CUP
                // Si eligi√≥ "DRK Prioritario", usar la marca de la tarifa ganadora
                let brand;
                if (comparisonMode === 'overall_best') {
                    // POWER CUP Global: SIEMPRE verde, independiente de qui√©n gane
                    brand = BRANDS.POWER_CUP;
                    console.log('Modo POWER CUP Global: Forzando branding POWER CUP (verde)');
                } else {
                    // DRK Prioritario: Usar marca de la tarifa ganadora
                    brand = result.offer.isDrk ? BRANDS.DRK : BRANDS.POWER_CUP;
                    console.log('Modo DRK Prioritario: Branding seg√∫n ganador:', brand.NAME);
                }
                
                console.log('Applying brand:', brand.NAME);
                applyBrandStyles(brand);
                activeBrand = brand;
                
                // Asignar como resultado final
                lastComparisonResult = result;
                lastComparisonResult.isMulti = false;
                
                // Si compareWithIndexed est√° activo, calcular resultado indexado
                let indexedResult = null;
                if (compareWithIndexed) {
                    const tariffType = result.originalTariffType || currentTariffType;
                    indexedResult = calculateIndexedOffer(result, tariffType);
                    
                    if (indexedResult) {
                        lastIndexedResult = indexedResult;
                        console.log('Calculado resultado indexado para contexto individual:', indexedResult.offer.name);
                    }
                }
                
                console.log('About to render results UI');
                
                // ‚ö°‚ö°‚ö° MODO DUAL - A√ëADIR AL ARRAY ‚ö°‚ö°‚ö°
                if (window.dualMode === true) {
                    console.log('===== üî• MODO DUAL - A√±adiendo suministro desde ELEGIR ENTRE RESULTADOS =====');
                    
                    // CREAR el objeto de suministro (igual que en selectBestOptionWithChoice)
                    const newSupply = {
                        type: 'electricidad',
                        cups: result.cups || '',
                        tariff: result.tariffType || result.originalTariffType || currentTariffType || '2.0TD',
                        offer: {
                            ...result.offer,
                            // Extraer precios de los arrays powerCosts y energyCosts
                            // CORREGIDO: Usar los nombres de propiedades correctos: priceDay y price
                            p1_power_price: result.powerCosts?.[0]?.priceDay || result.powerCosts?.[0]?.price_euro_kw_day,
                            p2_power_price: result.powerCosts?.[1]?.priceDay || result.powerCosts?.[1]?.price_euro_kw_day,
                            p1_price: result.energyCosts?.[0]?.price || result.energyCosts?.[0]?.price_euro_kwh,
                            p2_price: result.energyCosts?.[1]?.price || result.energyCosts?.[1]?.price_euro_kwh,
                            p3_price: result.energyCosts?.[2]?.price || result.energyCosts?.[2]?.price_euro_kwh,
                            p4_price: result.energyCosts?.[3]?.price || result.energyCosts?.[3]?.price_euro_kwh,
                            p5_price: result.energyCosts?.[4]?.price || result.energyCosts?.[4]?.price_euro_kwh,
                            p6_price: result.energyCosts?.[5]?.price || result.energyCosts?.[5]?.price_euro_kwh
                        },
                        totalAnnual: result.totalAnnual,
                        originalBillAnnual: result.originalBillAnnual || (result.importe_total || 0) * 12,
                        data: result,
                        // NUEVO: A√±adir desglose completo de electricidad
                        electricityBreakdown: {
                            energyCosts: result.energyCosts || [],
                            powerCosts: result.powerCosts || [],
                            subEnergy: result.subEnergyNet || 0,
                            subPower: result.subPower || 0,
                            subBase: result.subBase || 0,
                            costIE: result.costIE || 0,
                            baseImp: result.baseImp || 0,
                            costIVA: result.costIVA || 0,
                            totalPeriod: result.totalPeriod || 0,
                            totalAnnual: result.totalAnnual || 0,
                            ahorro_mensual: (result.originalBillPeriod || 0) - (result.totalPeriod || 0),
                            ahorro_anual: (result.originalBillAnnual || 0) - (result.totalAnnual || 0),
                            dias: result.dias_facturados || 30
                        },
                        results: {
                            drk: {
                                total: result.totalAnnual / 12,
                                total_anual: result.totalAnnual
                            },
                            powercup: {
                                total: indexedResult ? (indexedResult.totalAnnual / 12) : 0,
                                total_anual: indexedResult ? indexedResult.totalAnnual : 0
                            }
                        }
                    };
                    
                    // A√ëADIR al array
                    dualSupplies.push(newSupply);
                    
                    console.log('‚úÖ Suministro a√±adido al array desde selecci√≥n manual');
                    console.log('  - Total suministros:', dualSupplies.length);
                    console.log('  - CUPS:', newSupply.cups);
                    console.log('  - Tarifa:', newSupply.tariff);
                    console.log('  - Coste anual:', newSupply.totalAnnual);
                    
                    // Actualizar UI usando la funci√≥n existente
                    updateDualSuppliesList();
                    console.log('‚úÖ UI actualizada con updateDualSuppliesList()');
                    
                    // CR√çTICO: Cerrar todos los modales
                    const offerModal = document.getElementById('offer-decision-modal');
                    if (offerModal) {
                        offerModal.classList.add('hidden');
                        offerModal.classList.remove('flex');
                    }
                    
                    const selectionModal = document.getElementById('offer-selection-modal');
                    if (selectionModal) {
                        selectionModal.classList.add('hidden');
                        selectionModal.classList.remove('flex');
                    }
                    
                    const tariffSelector = document.getElementById('best-option-tariff-selector');
                    if (tariffSelector) {
                        tariffSelector.classList.add('hidden');
                    }
                    
                    // Ocultar TODAS las pantallas
                    console.log('Ocultando todas las pantallas...');
                    hideAllScreens();
                    
                    // Volver a la pantalla DUAL
                    console.log('Mostrando pantalla DUAL...');
                    document.getElementById('screen-dual').classList.add('active');
                    
                    console.log('‚úÖ Usuario puede a√±adir m√°s suministros o calcular');
                    
                    // Resetear bandera si existe
                    if (typeof isProcessingBestOption !== 'undefined') {
                        setTimeout(() => {
                            isProcessingBestOption = false;
                            console.log('‚úÖ Bandera reseteada');
                        }, 100);
                    }
                    
                    return; // FIN
                }
                
                // Mostrar resultados (pasando indexedResult si existe)
                renderResultsUI(result, indexedResult);
                
                console.log('Hiding initial-view and showing results-view');
                document.getElementById('loading-status').classList.add('hidden');
                document.getElementById('screen-inicio').classList.remove('active'); // Ocultar pantalla inicio
                document.getElementById('initial-view').classList.add('hidden');
                document.getElementById('scanner-view').classList.add('hidden');
                document.getElementById('results-view').classList.remove('hidden');
                document.getElementById('results-view').classList.add('animate-fade-in-up');
                hideNavbar(); // Ocultar navbar al mostrar resultados
                
                console.log('Done showing results');
            }
        }
        
        function populateOfferSelector() {
            // Esta funci√≥n ya no se usa, pero la mantenemos por compatibilidad
        }
        
        function handleManualOfferSelection(e) {
            // Esta funci√≥n ya no se usa, pero la mantenemos por compatibilidad
        }
        
        // --- FIX: Cancelaci√≥n del Esc√°ner ---
        function cancelScanner() {
            stopScanner(); // Detiene el stream de la c√°mara
            document.getElementById('scanner-view').classList.add('hidden');
            // Vuelve a la vista de selecci√≥n de entrada (initial-view)
            document.getElementById('initial-view').classList.remove('hidden');
            document.getElementById('loading-status').classList.add('hidden');
        }

        // --- INIT ---

        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar texto del bot√≥n de desglose
            const detailsToggleText = document.getElementById('details-toggle-text');
            if (detailsToggleText) {
                detailsToggleText.textContent = 'Ver desglose detallado del c√°lculo';
            }
            
            // Setup Event Listeners
            document.getElementById('manual-input-btn').onclick = startManualInputFlow;
            document.getElementById('execute-manual-input-btn').onclick = handleManualInput;
            
            // FIX APLICADO: El bot√≥n de cancelar del esc√°ner ahora vuelve a la vista de input, no a resetToLanding
            document.getElementById('stop-scan-btn').onclick = cancelScanner;  
            
            document.getElementById('start-scan-btn').onclick = startScanner;
            document.getElementById('capture-photo-btn').onclick = capturePhoto;
            
            // Modificaci√≥n del bot√≥n de volver para la vista de entrada
            document.querySelector('#initial-view button:first-child').onclick = () => {
                currentTariffType === 'MULTICUPS' ? showMultiCupsSagaView() : goBackFromInitialView();
            };
            
            document.getElementById('upload-menu-btn').onclick = () => {
                document.getElementById('qr-options-modal').classList.remove('hidden');
                document.getElementById('qr-options-modal').classList.add('flex');
            };
            
            // NUEVO: Bot√≥n Capturar Foto QR - Abre c√°mara nativa
            document.getElementById('camera-capture-btn').onclick = () => {
                document.getElementById('qr-options-modal').classList.add('hidden');
                document.getElementById('qr-options-modal').classList.remove('flex');
                document.getElementById('camera-capture-input').click();
            };
            
            document.getElementById('camera-capture-input').addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    console.log('üì∏ Imagen capturada desde c√°mara nativa');
                    decodeQRFromImage(e.target.files[0]);
                    e.target.value = ''; // Limpiar input
                }
            });
            
            // Bot√≥n de Finalizar MULTICUPS (en la nueva vista SAGA)
            document.getElementById('multicups-finalize-btn-saga').onclick = finalizeMultiCups;

            // Bot√≥n para subir imagen
            document.getElementById('modal-upload-file-btn').addEventListener('click', () => document.getElementById('image-file-input').click());
            document.getElementById('image-file-input').addEventListener('change', (e) => {
                document.getElementById('qr-options-modal').classList.add('hidden');
                document.getElementById('qr-options-modal').classList.remove('flex');
                if (e.target.files[0]) decodeQRFromImage(e.target.files[0]);
                e.target.value = '';
            });
            
            setupPasteCatcher(); // <-- Llamada ahora segura

            document.getElementById('send-offer-btn').onclick = () => {
                if (lastComparisonResult) {
                    document.getElementById('send-offer-modal').classList.remove('hidden');
                    document.getElementById('send-offer-modal').classList.add('flex');
                    // Aplicar focus ring de la marca a los inputs
                    document.querySelectorAll('#send-offer-modal input').forEach(input => {
                        input.classList.remove('focus:ring-drk-500', 'focus:ring-powercup-500');
                        input.classList.add(activeBrand.NAME.includes('DRK') ? 'focus:ring-drk-500' : 'focus:ring-powercup-500');
                    });
                } else {
                    window.showErrorModal("Por favor, analice una factura primero para generar una oferta.");
                }
            };
            
            document.getElementById('execute-send-offer-btn').addEventListener('click', handleCopyOffer);
            document.getElementById('execute-pdf-offer-btn').addEventListener('click', handleGeneratePDF);
            
            // NUEVO: Event listeners para solicitar mejora a DRK
            document.getElementById('request-improvement-btn').onclick = () => {
                if (lastComparisonResult) {
                    document.getElementById('request-improvement-modal').classList.remove('hidden');
                    document.getElementById('request-improvement-modal').classList.add('flex');
                } else {
                    window.showErrorModal("Por favor, analice una factura primero.");
                }
            };
            
            // NUEVO: Event listener para bot√≥n de solicitar mejora en GAS
            const gasImprovementBtn = document.getElementById('gas-request-improvement-btn');
            if (gasImprovementBtn) {
                gasImprovementBtn.onclick = () => {
                    if (window.lastGasComparisonResult) {
                        document.getElementById('request-improvement-modal').classList.remove('hidden');
                        document.getElementById('request-improvement-modal').classList.add('flex');
                    } else {
                        window.showErrorModal("Por favor, analice una factura primero.");
                    }
                };
            }
            
            // NUEVO: Event listener para bot√≥n de solicitar mejora en DUAL
            const dualImprovementBtn = document.getElementById('dual-request-improvement-btn');
            if (dualImprovementBtn) {
                dualImprovementBtn.onclick = () => {
                    if (window.dualGlobalResults && dualSupplies.length >= 2) {
                        document.getElementById('request-improvement-modal').classList.remove('hidden');
                        document.getElementById('request-improvement-modal').classList.add('flex');
                    } else {
                        window.showErrorModal("Por favor, realice una comparaci√≥n DUAL primero.");
                    }
                };
            }
            
            document.getElementById('execute-improvement-request-btn').addEventListener('click', handleRequestImprovement);

            document.getElementById('qr-toggle-checkbox').addEventListener('change', (e) => {
                const wrapper = document.getElementById('qr-content-wrapper');
                if (e.target.checked) {
                    generateQRCode(activeBrand);
                    wrapper.classList.add('active');
                } else {
                    wrapper.classList.remove('active');
                }
            });

            document.querySelectorAll('input[name="comparison_mode"]').forEach(r => {
                r.addEventListener('change', (e) => updateComparisonMode(e.target.value));
            });
            
            // Event listener para bot√≥n de confirmar selecci√≥n de oferta
            document.getElementById('confirm-offer-selection-btn').addEventListener('click', confirmOfferSelection);
            
            // Disparar evento de cambio inicial para aplicar el branding pre-seleccionado
            const initialModeInput = document.querySelector('input[name="comparison_mode"]:checked');
            if (initialModeInput) {
                updateComparisonMode(initialModeInput.value);
            }
        });
        
        // FUNCI√ìN MEJORADA: Preprocesar imagen para mejor detecci√≥n de QR
        function preprocessImage(imageData, options = {}) {
            const {
                brightness = 0,
                contrast = 1.0,
                sharpen = false,
                scale = 1.0
            } = options;
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = Math.floor(imageData.width * scale);
            canvas.height = Math.floor(imageData.height * scale);
            
            // Crear ImageData temporal
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = imageData.width;
            tempCanvas.height = imageData.height;
            tempCtx.putImageData(imageData, 0, 0);
            
            // Escalar si es necesario
            ctx.drawImage(tempCanvas, 0, 0, canvas.width, canvas.height);
            
            // Aplicar ajustes de brillo y contraste
            if (brightness !== 0 || contrast !== 1.0) {
                ctx.filter = `brightness(${1 + brightness}) contrast(${contrast})`;
                ctx.drawImage(canvas, 0, 0);
                ctx.filter = 'none';
            }
            
            const processedData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = processedData.data;
            
            // Aplicar nitidez (sharpening) si est√° habilitado
            if (sharpen) {
                const width = processedData.width;
                const height = processedData.height;
                const kernel = [-1, -1, -1, -1, 9, -1, -1, -1, -1]; // Kernel de nitidez
                const output = new Uint8ClampedArray(data.length);
                
                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        const idx = (y * width + x) * 4;
                        let r = 0, g = 0, b = 0;
                        
                        for (let ky = -1; ky <= 1; ky++) {
                            for (let kx = -1; kx <= 1; kx++) {
                                const kidx = ((y + ky) * width + (x + kx)) * 4;
                                const k = kernel[(ky + 1) * 3 + (kx + 1)];
                                r += data[kidx] * k;
                                g += data[kidx + 1] * k;
                                b += data[kidx + 2] * k;
                            }
                        }
                        
                        output[idx] = Math.min(255, Math.max(0, r));
                        output[idx + 1] = Math.min(255, Math.max(0, g));
                        output[idx + 2] = Math.min(255, Math.max(0, b));
                        output[idx + 3] = data[idx + 3];
                    }
                }
                
                for (let i = 0; i < data.length; i++) {
                    data[i] = output[i];
                }
            }
            
            return processedData;
        }
        
        // NUEVA FUNCI√ìN: Detectar autom√°ticamente regi√≥n del QR y recortar
        function detectAndCropQR(imageData) {
            const width = imageData.width;
            const height = imageData.height;
            const data = imageData.data;
            
            // Convertir a escala de grises y detectar bordes
            const gray = new Uint8ClampedArray(width * height);
            for (let i = 0; i < data.length; i += 4) {
                const idx = i / 4;
                gray[idx] = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
            }
            
            // Binarizar con threshold adaptativo m√°s sensible
            const binary = new Uint8ClampedArray(width * height);
            const threshold = 140; // M√°s sensible para detectar QR peque√±os
            for (let i = 0; i < gray.length; i++) {
                binary[i] = gray[i] < threshold ? 0 : 255;
            }
            
            // Encontrar l√≠mites del contenido (no blanco)
            let minX = width, maxX = 0, minY = height, maxY = 0;
            let darkPixels = 0;
            
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const idx = y * width + x;
                    // Si el p√≠xel es oscuro (parte del QR)
                    if (binary[idx] < 128) {
                        darkPixels++;
                        if (x < minX) minX = x;
                        if (x > maxX) maxX = x;
                        if (y < minY) minY = y;
                        if (y > maxY) maxY = y;
                    }
                }
            }
            
            // Si no hay suficiente contenido oscuro, devolver imagen original
            const darkPixelRatio = darkPixels / (width * height);
            if (darkPixels === 0 || maxX <= minX || maxY <= minY || darkPixelRatio < 0.01) {
                console.log('üîç No hay suficiente contenido oscuro para recortar');
                return imageData;
            }
            
            // A√±adir margen m√°s generoso (15% para screenshots)
            const marginX = Math.floor((maxX - minX) * 0.15);
            const marginY = Math.floor((maxY - minY) * 0.15);
            
            minX = Math.max(0, minX - marginX);
            maxX = Math.min(width - 1, maxX + marginX);
            minY = Math.max(0, minY - marginY);
            maxY = Math.min(height - 1, maxY + marginY);
            
            const cropWidth = maxX - minX + 1;
            const cropHeight = maxY - minY + 1;
            
            // Para screenshots: aceptar recortes m√°s peque√±os (5% en lugar de 20%)
            const minSize = Math.min(width, height) * 0.05;
            if (cropWidth < minSize || cropHeight < minSize) {
                console.log('üîç Recorte demasiado peque√±o, usando imagen completa');
                return imageData;
            }
            
            // Crear nueva imagen recortada
            const croppedCanvas = document.createElement('canvas');
            const croppedCtx = croppedCanvas.getContext('2d');
            croppedCanvas.width = cropWidth;
            croppedCanvas.height = cropHeight;
            
            // Copiar regi√≥n recortada
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = width;
            tempCanvas.height = height;
            tempCtx.putImageData(imageData, 0, 0);
            
            croppedCtx.drawImage(tempCanvas, minX, minY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
            
            const croppedData = croppedCtx.getImageData(0, 0, cropWidth, cropHeight);
            
            const reductionPercent = Math.round((1 - (cropWidth*cropHeight)/(width*height)) * 100);
            console.log(`üìê QR recortado: ${width}x${height} ‚Üí ${cropWidth}x${cropHeight} (-${reductionPercent}% √°rea)`);
            
            return croppedData;
        }
        
        // NUEVA FUNCI√ìN: Mejorar contraste con binarizaci√≥n adaptativa
        function enhanceQRContrast(imageData) {
            const width = imageData.width;
            const height = imageData.height;
            const data = new Uint8ClampedArray(imageData.data);
            
            // Convertir a escala de grises
            const gray = new Uint8ClampedArray(width * height);
            for (let i = 0; i < data.length; i += 4) {
                const idx = i / 4;
                gray[idx] = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
            }
            
            // Calcular threshold adaptativo (m√©todo de Otsu simplificado)
            let histogram = new Array(256).fill(0);
            for (let i = 0; i < gray.length; i++) {
                histogram[Math.floor(gray[i])]++;
            }
            
            let sum = 0;
            for (let i = 0; i < 256; i++) {
                sum += i * histogram[i];
            }
            
            let sumB = 0;
            let wB = 0;
            let wF = 0;
            let maxVariance = 0;
            let threshold = 0;
            
            for (let i = 0; i < 256; i++) {
                wB += histogram[i];
                if (wB === 0) continue;
                
                wF = gray.length - wB;
                if (wF === 0) break;
                
                sumB += i * histogram[i];
                const mB = sumB / wB;
                const mF = (sum - sumB) / wF;
                const variance = wB * wF * (mB - mF) * (mB - mF);
                
                if (variance > maxVariance) {
                    maxVariance = variance;
                    threshold = i;
                }
            }
            
            // Aplicar binarizaci√≥n
            for (let i = 0; i < gray.length; i++) {
                const binary = gray[i] < threshold ? 0 : 255;
                const idx = i * 4;
                data[idx] = binary;
                data[idx + 1] = binary;
                data[idx + 2] = binary;
                // Alpha no se toca
            }
            
            console.log(`üé® Binarizaci√≥n aplicada con threshold: ${threshold}`);
            
            return new ImageData(data, width, height);
        }

        // NUEVA FUNCI√ìN: Detectar regi√≥n del QR y recortar AGRESIVAMENTE
        function smartCropQRRegion(imageData) {
            const width = imageData.width;
            const height = imageData.height;
            const data = imageData.data;
            
            console.log(`üîç Buscando regi√≥n QR en imagen ${width}x${height}...`);
            
            // Convertir a escala de grises
            const gray = new Uint8ClampedArray(width * height);
            for (let i = 0; i < data.length; i += 4) {
                const idx = i / 4;
                gray[idx] = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
            }
            
            // Calcular threshold adaptativo (m√©todo Otsu)
            let histogram = new Array(256).fill(0);
            for (let i = 0; i < gray.length; i++) {
                histogram[gray[i]]++;
            }
            
            let total = gray.length;
            let sum = 0;
            for (let i = 0; i < 256; i++) {
                sum += i * histogram[i];
            }
            
            let sumB = 0;
            let wB = 0;
            let wF = 0;
            let maxVariance = 0;
            let threshold = 0;
            
            for (let i = 0; i < 256; i++) {
                wB += histogram[i];
                if (wB === 0) continue;
                
                wF = total - wB;
                if (wF === 0) break;
                
                sumB += i * histogram[i];
                let mB = sumB / wB;
                let mF = (sum - sumB) / wF;
                let variance = wB * wF * (mB - mF) * (mB - mF);
                
                if (variance > maxVariance) {
                    maxVariance = variance;
                    threshold = i;
                }
            }
            
            console.log(`üìä Threshold Otsu calculado: ${threshold}`);
            
            // Binarizar con threshold adaptativo
            const binary = new Uint8ClampedArray(width * height);
            for (let i = 0; i < gray.length; i++) {
                binary[i] = gray[i] < threshold ? 0 : 255;
            }
            
            // Detectar bloques con alta densidad de p√≠xeles oscuros (QR)
            const blockSize = Math.min(50, Math.floor(Math.min(width, height) / 10));
            const blocksX = Math.ceil(width / blockSize);
            const blocksY = Math.ceil(height / blockSize);
            const blockDensity = [];
            
            for (let by = 0; by < blocksY; by++) {
                for (let bx = 0; bx < blocksX; bx++) {
                    let darkPixels = 0;
                    let totalPixels = 0;
                    
                    for (let y = by * blockSize; y < Math.min((by + 1) * blockSize, height); y++) {
                        for (let x = bx * blockSize; x < Math.min((bx + 1) * blockSize, width); x++) {
                            const idx = y * width + x;
                            totalPixels++;
                            if (binary[idx] === 0) darkPixels++;
                        }
                    }
                    
                    const density = darkPixels / totalPixels;
                    blockDensity.push({ bx, by, density });
                }
            }
            
            // Encontrar bloques con densidad entre 15% y 70% (t√≠pico de QR)
            const qrBlocks = blockDensity.filter(b => b.density > 0.15 && b.density < 0.70);
            
            if (qrBlocks.length === 0) {
                console.log('‚ö†Ô∏è No se encontraron bloques QR, usando imagen completa');
                return imageData;
            }
            
            // Encontrar regi√≥n que contiene los bloques QR
            let minBx = Math.min(...qrBlocks.map(b => b.bx));
            let maxBx = Math.max(...qrBlocks.map(b => b.bx));
            let minBy = Math.min(...qrBlocks.map(b => b.by));
            let maxBy = Math.max(...qrBlocks.map(b => b.by));
            
            // Convertir bloques a p√≠xeles con margen generoso (30%)
            let minX = Math.max(0, minBx * blockSize - blockSize * 2);
            let maxX = Math.min(width - 1, (maxBx + 1) * blockSize + blockSize * 2);
            let minY = Math.max(0, minBy * blockSize - blockSize * 2);
            let maxY = Math.min(height - 1, (maxBy + 1) * blockSize + blockSize * 2);
            
            const cropWidth = maxX - minX;
            const cropHeight = maxY - minY;
            
            // Si el recorte es muy peque√±o (< 3% de la imagen), no recortar
            const cropArea = cropWidth * cropHeight;
            const totalArea = width * height;
            const cropPercent = (cropArea / totalArea) * 100;
            
            if (cropPercent < 3) {
                console.log(`‚ö†Ô∏è Regi√≥n QR muy peque√±a (${cropPercent.toFixed(1)}%), usando imagen completa`);
                return imageData;
            }
            
            // Crear canvas recortado
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = width;
            tempCanvas.height = height;
            tempCtx.putImageData(imageData, 0, 0);
            
            const croppedCanvas = document.createElement('canvas');
            const croppedCtx = croppedCanvas.getContext('2d');
            croppedCanvas.width = cropWidth;
            croppedCanvas.height = cropHeight;
            
            croppedCtx.drawImage(tempCanvas, minX, minY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
            
            const croppedData = croppedCtx.getImageData(0, 0, cropWidth, cropHeight);
            
            console.log(`‚úÇÔ∏è Regi√≥n QR recortada: ${width}x${height} ‚Üí ${cropWidth}x${cropHeight} (${cropPercent.toFixed(1)}% de imagen)`);
            
            return croppedData;
        }
        
        function decodeQRFromImage(imageFileOrBlob) {
            // Mostrar overlay grande
            const overlay = document.getElementById('qr-processing-overlay');
            const progressMsg = document.getElementById('qr-progress-message');
            const attemptCounter = document.getElementById('qr-attempt-counter');
            
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            progressMsg.textContent = 'Cargando imagen...';
            attemptCounter.textContent = '0 / 15';
            
            // TIMEOUT DE SEGURIDAD (60 segundos para im√°genes grandes)
            let processingComplete = false;
            const timeoutId = setTimeout(() => {
                if (!processingComplete) {
                    console.error('‚è±Ô∏è TIMEOUT: Procesamiento tom√≥ m√°s de 60s');
                    overlay.classList.add('hidden');
                    overlay.classList.remove('flex');
                    window.showErrorModal(
                        "‚è±Ô∏è El procesamiento tard√≥ demasiado.\n\n" +
                        "üí° Intenta:\n" +
                        "‚Ä¢ Usar el ESC√ÅNER EN VIVO\n" +
                        "‚Ä¢ Hacer nueva foto m√°s cerca del QR\n" +
                        "‚Ä¢ Capturar solo el QR (no toda la p√°gina)"
                    );
                }
            }, 60000); // 60 segundos
            
            const img = new Image();
            const url = URL.createObjectURL(imageFileOrBlob);
            
            img.onload = () => {
                try {
                    URL.revokeObjectURL(url);
                    
                    console.log(`üì∏ Imagen original: ${img.width}x${img.height}`);
                    
                    // OPTIMIZACI√ìN CR√çTICA: Reducir im√°genes muy grandes ANTES
                    const MAX_DIMENSION = 2000; // Tama√±o m√°ximo para procesamiento r√°pido
                    let workingCanvas = document.createElement('canvas');
                    let workingCtx = workingCanvas.getContext('2d');
                    
                    if (img.width > MAX_DIMENSION || img.height > MAX_DIMENSION) {
                        // Reducir imagen proporcionalmente
                        const scale = MAX_DIMENSION / Math.max(img.width, img.height);
                        workingCanvas.width = Math.floor(img.width * scale);
                        workingCanvas.height = Math.floor(img.height * scale);
                        console.log(`‚ö° Optimizando: ${img.width}x${img.height} ‚Üí ${workingCanvas.width}x${workingCanvas.height}`);
                        progressMsg.textContent = '‚ö° Optimizando imagen grande...';
                    } else {
                        workingCanvas.width = img.width;
                        workingCanvas.height = img.height;
                    }
                    
                    workingCtx.drawImage(img, 0, 0, workingCanvas.width, workingCanvas.height);
                    const baseImageData = workingCtx.getImageData(0, 0, workingCanvas.width, workingCanvas.height);
                    
                    // PASO CR√çTICO: Detectar y recortar regi√≥n QR PRIMERO
                    progressMsg.textContent = 'üîç Detectando regi√≥n QR...';
                    const croppedImageData = smartCropQRRegion(baseImageData);
                    
                    // Crear nuevo canvas con imagen recortada
                    const croppedCanvas = document.createElement('canvas');
                    const croppedCtx = croppedCanvas.getContext('2d');
                    croppedCanvas.width = croppedImageData.width;
                    croppedCanvas.height = croppedImageData.height;
                    croppedCtx.putImageData(croppedImageData, 0, 0);
                    
                    let attemptNum = 0;
                    
                    // FUNCI√ìN PARA PROBAR UN ESCALADO CON PROTECCI√ìN
                    const tryScale = (scale, label, canvas = croppedCanvas) => {
                        attemptNum++;
                        console.log(`üîç Intento ${attemptNum}: ${label} (escala ${scale}x)`);
                        
                        // Actualizar UI
                        progressMsg.textContent = label;
                        attemptCounter.textContent = `${attemptNum} / 12`;
                        
                        try {
                            // Calcular tama√±o resultante
                            const targetWidth = Math.floor(canvas.width * scale);
                            const targetHeight = Math.floor(canvas.height * scale);
                            
                            // L√çMITE DE SEGURIDAD: No m√°s de 6000x6000 (reducido para velocidad)
                            if (targetWidth > 6000 || targetHeight > 6000) {
                                console.warn(`‚ö†Ô∏è Escalado ${scale}x limitado para velocidad`);
                                const limitScale = Math.min(6000 / canvas.width, 6000 / canvas.height);
                                return tryScaleSafe(limitScale, label, canvas);
                            }
                            
                            return tryScaleSafe(scale, label, canvas);
                        } catch (e) {
                            console.error(`‚ùå Error en ${label}:`, e);
                            return false;
                        }
                    };
                    
                    // Funci√≥n interna segura
                    const tryScaleSafe = (scale, label, canvas) => {
                        try {
                            const scaledCanvas = document.createElement('canvas');
                            const scaledCtx = scaledCanvas.getContext('2d');
                            scaledCanvas.width = Math.floor(canvas.width * scale);
                            scaledCanvas.height = Math.floor(canvas.height * scale);
                            
                            scaledCtx.drawImage(canvas, 0, 0, scaledCanvas.width, scaledCanvas.height);
                            const scaledData = scaledCtx.getImageData(0, 0, scaledCanvas.width, scaledCanvas.height);
                            
                            // Intentar detectar
                            const code = jsQR(scaledData.data, scaledData.width, scaledData.height, {
                                inversionAttempts: "attemptBoth"
                            });
                            
                            if (code) {
                                processingComplete = true;
                                clearTimeout(timeoutId);
                                console.log(`‚úÖ ¬°QR ENCONTRADO! en intento ${attemptNum}`);
                                progressMsg.textContent = '‚úÖ ¬°QR Detectado!';
                                setTimeout(() => {
                                    overlay.classList.add('hidden');
                                    overlay.classList.remove('flex');
                                    handleQRRead(code.data);
                                }, 500);
                                return true;
                            }
                            return false;
                        } catch (e) {
                            console.error('Error en tryScaleSafe:', e);
                            return false;
                        }
                    };
                    
                    // SECUENCIA OPTIMIZADA (12 intentos, m√°s r√°pida)
                    const runAttempts = () => {
                        try {
                            // Intentos 1-6: Escalados progresivos sobre regi√≥n recortada
                            if (tryScale(1.0, "üì∑ Regi√≥n QR")) return;
                            
                            setTimeout(() => { try {
                                if (tryScale(2.0, "üîç 2x")) return;
                                
                                setTimeout(() => { try {
                                    if (tryScale(3.0, "üîé 3x")) return;
                                    
                                    setTimeout(() => { try {
                                        if (tryScale(4.0, "üî¨ 4x")) return;
                                        
                                        setTimeout(() => { try {
                                            if (tryScale(6.0, "üéØ 6x")) return;
                                            
                                            setTimeout(() => { try {
                                                if (tryScale(8.0, "üöÄ 8x")) return;
                                                
                                                setTimeout(() => { try {
                                                    // Intento 7: Escalado 10x (QR muy peque√±os)
                                                    if (tryScale(10.0, "üí™ 10x")) return;
                                                    
                                                    setTimeout(() => { try {
                                                        // Intento 8: Reducir desenfoque
                                                        attemptNum++;
                                                        progressMsg.textContent = 'üîß Reduciendo desenfoque...';
                                                        attemptCounter.textContent = '8 / 12';
                                                        
                                                        const reducedCanvas = document.createElement('canvas');
                                                        const reducedCtx = reducedCanvas.getContext('2d');
                                                        reducedCanvas.width = Math.floor(croppedCanvas.width / 2);
                                                        reducedCanvas.height = Math.floor(croppedCanvas.height / 2);
                                                        reducedCtx.drawImage(croppedCanvas, 0, 0, reducedCanvas.width, reducedCanvas.height);
                                                        
                                                        const reducedData = reducedCtx.getImageData(0, 0, reducedCanvas.width, reducedCanvas.height);
                                                        const code = jsQR(reducedData.data, reducedData.width, reducedData.height, {
                                                            inversionAttempts: "attemptBoth"
                                                        });
                                                        
                                                        if (code) {
                                                            processingComplete = true;
                                                            clearTimeout(timeoutId);
                                                            progressMsg.textContent = '‚úÖ ¬°QR Detectado!';
                                                            setTimeout(() => {
                                                                overlay.classList.add('hidden');
                                                                overlay.classList.remove('flex');
                                                                handleQRRead(code.data);
                                                            }, 500);
                                                            return;
                                                        }
                                                        
                                                        setTimeout(() => { try {
                                                            // Intentos 9-10: Imagen completa con escalados moderados
                                                            if (tryScale(2.0, "üì∏ Completa 2x", workingCanvas)) return;
                                                            
                                                            setTimeout(() => { try {
                                                                if (tryScale(4.0, "üì∏ Completa 4x", workingCanvas)) return;
                                                                
                                                                setTimeout(() => { try {
                                                                    // Intento 11: Original sin procesar
                                                                    attemptNum++;
                                                                    progressMsg.textContent = 'üì∑ Original...';
                                                                    attemptCounter.textContent = '11 / 12';
                                                                    
                                                                    const code = jsQR(baseImageData.data, baseImageData.width, baseImageData.height, {
                                                                        inversionAttempts: "attemptBoth"
                                                                    });
                                                                    
                                                                    if (code) {
                                                                        processingComplete = true;
                                                                        clearTimeout(timeoutId);
                                                                        progressMsg.textContent = '‚úÖ ¬°QR Detectado!';
                                                                        setTimeout(() => {
                                                                            overlay.classList.add('hidden');
                                                                            overlay.classList.remove('flex');
                                                                            handleQRRead(code.data);
                                                                        }, 500);
                                                                        return;
                                                                    }
                                                                    
                                                                    setTimeout(() => { try {
                                                                        // Intento 12: √öltimo recurso
                                                                        attemptNum++;
                                                                        progressMsg.textContent = 'üîß √öltimo intento...';
                                                                        attemptCounter.textContent = '12 / 12';
                                                                        
                                                                        const finalCanvas = document.createElement('canvas');
                                                                        const finalCtx = finalCanvas.getContext('2d');
                                                                        finalCanvas.width = Math.floor(workingCanvas.width / 2);
                                                                        finalCanvas.height = Math.floor(workingCanvas.height / 2);
                                                                        finalCtx.drawImage(workingCanvas, 0, 0, finalCanvas.width, finalCanvas.height);
                                                                        
                                                                        const finalData = finalCtx.getImageData(0, 0, finalCanvas.width, finalCanvas.height);
                                                                        const code = jsQR(finalData.data, finalData.width, finalData.height, {
                                                                            inversionAttempts: "attemptBoth"
                                                                        });
                                                                        
                                                                        processingComplete = true;
                                                                        clearTimeout(timeoutId);
                                                                        
                                                                        if (code) {
                                                                            progressMsg.textContent = '‚úÖ ¬°QR Detectado!';
                                                                            setTimeout(() => {
                                                                                overlay.classList.add('hidden');
                                                                                overlay.classList.remove('flex');
                                                                                handleQRRead(code.data);
                                                                            }, 500);
                                                                        } else {
                                                                            // NO ENCONTRADO
                                                                            console.log('‚ùå QR no detectado despu√©s de 12 intentos');
                                                                            overlay.classList.add('hidden');
                                                                            overlay.classList.remove('flex');
                                                                            window.showErrorModal(
                                                                                "‚ùå No se detect√≥ el c√≥digo QR.\n\n" +
                                                                                "üí° Para mejores resultados:\n\n" +
                                                                                "üì∏ Usa el ESC√ÅNER EN VIVO\n" +
                                                                                "üîç Haz foto CERCA del QR\n" +
                                                                                "üí° Buena iluminaci√≥n\n" +
                                                                                "‚úÇÔ∏è O recorta solo el QR"
                                                                            );
                                                                        }
                                                                    } catch (e) { handleFinalError(e); }
                                                                    }, 150);
                                                                } catch (e) { handleFinalError(e); }
                                                                }, 150);
                                                            } catch (e) { handleFinalError(e); }
                                                            }, 150);
                                                        } catch (e) { handleFinalError(e); }
                                                        }, 150);
                                                    } catch (e) { handleFinalError(e); }
                                                    }, 150);
                                                } catch (e) { handleFinalError(e); }
                                                }, 150);
                                            } catch (e) { handleFinalError(e); }
                                            }, 150);
                                        } catch (e) { handleFinalError(e); }
                                        }, 150);
                                    } catch (e) { handleFinalError(e); }
                                    }, 150);
                                } catch (e) { handleFinalError(e); }
                                }, 150);
                            } catch (e) { handleFinalError(e); }
                            }, 150);
                        } catch (e) {
                            handleFinalError(e);
                        }
                    };
                    
                    // Funci√≥n para manejar errores finales
                    const handleFinalError = (e) => {
                        processingComplete = true;
                        clearTimeout(timeoutId);
                        console.error('‚ùå Error cr√≠tico:', e);
                        overlay.classList.add('hidden');
                        overlay.classList.remove('flex');
                        window.showErrorModal(
                            "‚ùå Error al procesar la imagen.\n\n" +
                            "üí° Intenta:\n" +
                            "‚Ä¢ Usar el ESC√ÅNER EN VIVO\n" +
                            "‚Ä¢ Hacer una foto nueva\n" +
                            "‚Ä¢ Foto m√°s cerca del QR"
                        );
                    };
                    
                    runAttempts();
                    
                } catch (e) {
                    processingComplete = true;
                    clearTimeout(timeoutId);
                    URL.revokeObjectURL(url);
                    console.error('‚ùå Error al cargar:', e);
                    overlay.classList.add('hidden');
                    overlay.classList.remove('flex');
                    window.showErrorModal("‚ùå Error al procesar la imagen.");
                }
            };
            
            img.onerror = () => {
                processingComplete = true;
                clearTimeout(timeoutId);
                URL.revokeObjectURL(url);
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
                window.showErrorModal("‚ùå No se pudo cargar la imagen.");
            };
            
            img.src = url;
        }
        
        function startScanner() {
            // Use multiCupsAddType for the check if we are in MultiCups mode
            const currentTypeCheck = currentTariffType === 'MULTICUPS' ? multiCupsAddType : currentTariffType;

            if (currentTypeCheck !== '2.0TD') {
                return window.showErrorModal("El esc√°ner QR solo es compatible con la tarifa 2.0 TD.");
            }
            
            // Si las tarifas no est√°n cargadas, cargarlas silenciosamente y esperar
            if (currentTariffs['2.0TD'].length === 0) {
                console.log('‚è≥ Cargando tarifas 2.0TD...');
                
                // Cargar tarifas en segundo plano
                if (typeof fetchTariffsFromSheet === 'function') {
                    fetchTariffsFromSheet('2.0TD').then(() => {
                        console.log('‚úÖ Tarifas cargadas, iniciando esc√°ner...');
                        // Reintentar abrir el esc√°ner despu√©s de cargar
                        setTimeout(() => {
                            if (document.getElementById('start-scan-btn')) {
                                document.getElementById('start-scan-btn').click();
                            }
                        }, 500);
                    }).catch(err => {
                        console.error('‚ùå Error cargando tarifas:', err);
                        window.showErrorModal("Error al cargar las tarifas. Por favor, intenta de nuevo.");
                    });
                }
                return; // Salir sin mostrar modal molesto
            }
            
            if (scannerRunning) return;
            
            // FEEDBACK INMEDIATO: Mostrar que est√° cargando
            document.getElementById('screen-inicio').classList.remove('active'); // Ocultar pantalla inicio
            document.getElementById('initial-view').classList.add('hidden');
            document.getElementById('scanner-view').classList.remove('hidden');
            document.getElementById('scanner-view').classList.add('flex');
            
            // Mostrar mensaje de carga en el contenedor interactivo
            const interactive = document.getElementById('interactive');
            interactive.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; background: #1e293b;">
                    <div style="width: 60px; height: 60px; border: 4px solid #22c55e; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
                    <p style="color: white; margin-top: 20px; font-size: 16px; font-weight: 600;">üì∑ Abriendo c√°mara...</p>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
            
            scannerRunning = true;
            
            // Iniciar c√°mara con m√≠nimas opciones para m√°xima velocidad
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: "environment"
                    // Solo lo esencial - sin resoluci√≥n forzada para apertura r√°pida
                } 
            }).then(s => {
                stream = s; 
                
                // Crear video
                video = document.createElement('video');
                video.autoplay = true; 
                video.playsInline = true;
                video.srcObject = s;
                
                // Crear canvas
                canvas = document.createElement('canvas'); 
                canvasCtx = canvas.getContext('2d');
                
                // Limpiar el mensaje de carga y mostrar video
                interactive.innerHTML = '';
                interactive.appendChild(video);
                
                video.onloadedmetadata = () => { 
                    video.play(); 
                    // Iniciar escaneo inmediatamente
                    scanLoop(); 
                };
            }).catch(err => {
                console.error(err); 
                stopScanner(); 
                cancelScanner(); 
                window.showErrorModal("Error al acceder a la c√°mara. Intente subir una imagen.");
            });
        }
        function scanLoop() {
            if (!scannerRunning || !video || video.readyState !== video.HAVE_ENOUGH_DATA) { 
                animationFrameId = requestAnimationFrame(scanLoop); 
                return; 
            }
            
            if (canvas.width !== video.videoWidth) { 
                canvas.width = video.videoWidth; 
                canvas.height = video.videoHeight; 
            }
            
            canvasCtx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvasCtx.getImageData(0, 0, canvas.width, canvas.height);
            
            scanLoopCount++;
            
            // Actualizar barra de progreso
            const powerBar = document.getElementById('scan-power-bar');
            const powerLabel = document.getElementById('scan-power-label');
            
            if (!qrRegionDetected) {
                const progress = Math.min(80, (scanLoopCount / 60) * 80);
                powerBar.style.width = progress + '%';
                powerLabel.textContent = 'Buscando QR...';
                powerBar.className = 'bg-gradient-to-r from-blue-400 to-blue-600 h-full transition-all duration-500';
            }
            
            // ‚ö° DETECCI√ìN EN TIEMPO REAL con jsQR (como Google Lens)
            let code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "attemptBoth"
            });
            
            const frame = document.getElementById('qr-detection-frame');
            const container = document.getElementById('interactive');
            const captureBtn = document.getElementById('capture-photo-btn');
            
            // Si detecta el QR ‚Üí Incrementar contador de estabilidad
            if (code && code.location && frame && container) {
                qrStableFrames++;
                
                // Solo actualizar UI si llevamos 5 frames consecutivos detectando (estabilidad)
                if (qrStableFrames >= 5) {
                    const rect = container.getBoundingClientRect();
                    const scaleX = rect.width / canvas.width;
                    const scaleY = rect.height / canvas.height;
                    
                    // Calcular bounding box del QR
                    const points = code.location;
                    const minX = Math.min(points.topLeftCorner.x, points.bottomLeftCorner.x);
                    const maxX = Math.max(points.topRightCorner.x, points.bottomRightCorner.x);
                    const minY = Math.min(points.topLeftCorner.y, points.topRightCorner.y);
                    const maxY = Math.max(points.bottomLeftCorner.y, points.bottomRightCorner.y);
                    
                    // A√±adir margen 20%
                    const marginX = (maxX - minX) * 0.2;
                    const marginY = (maxY - minY) * 0.2;
                    
                    const qrX = Math.max(0, minX - marginX);
                    const qrY = Math.max(0, minY - marginY);
                    const qrWidth = (maxX - minX) + (marginX * 2);
                    const qrHeight = (maxY - minY) + (marginY * 2);
                    
                    // Posicionar marco exactamente donde est√° el QR
                    frame.style.left = (qrX * scaleX) + 'px';
                    frame.style.top = (qrY * scaleY) + 'px';
                    frame.style.width = (qrWidth * scaleX) + 'px';
                    frame.style.height = (qrHeight * scaleY) + 'px';
                    frame.style.opacity = '1';
                    frame.classList.remove('hidden');
                    
                    // Guardar regi√≥n detectada para cuando usuario pulse bot√≥n
                    if (!qrRegionDetected) {
                        qrRegionDetected = { x: qrX, y: qrY, width: qrWidth, height: qrHeight };
                        console.log('üéØ QR localizado estable - Listo para capturar');
                    }
                    
                    // Actualizar UI para indicar que se detect√≥ QR
                    powerBar.style.width = '100%';
                    powerLabel.textContent = '‚úÖ QR DETECTADO';
                    powerBar.className = 'bg-gradient-to-r from-green-500 to-green-600 h-full transition-all duration-300';
                    
                    // Cambiar bot√≥n flotante circular a verde - FORZAR SIEMPRE
                    if (captureBtn) {
                        const innerCircle = captureBtn.querySelector('div');
                        if (innerCircle) {
                            // Micro-delay para asegurar que el DOM est√© listo
                            setTimeout(() => {
                                // Forzar clase verde con animaci√≥n
                                innerCircle.className = 'w-16 h-16 rounded-full bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-center button-detected';
                                innerCircle.innerHTML = `
                                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                `;
                                console.log('‚úÖ Bot√≥n verde activado con animaci√≥n');
                            }, 10);
                        } else {
                            console.warn('‚ö†Ô∏è No se encontr√≥ innerCircle');
                        }
                    } else {
                        console.warn('‚ö†Ô∏è No se encontr√≥ captureBtn');
                    }
                }
            } else {
                // No detecta QR ‚Üí Resetear contador y ocultar UI
                if (qrStableFrames > 0) {
                    qrStableFrames--;  // Decrementar gradualmente
                }
                
                // Solo resetear UI si perdimos la detecci√≥n completamente
                if (qrStableFrames === 0) {
                    if (frame) {
                        frame.style.opacity = '0';
                        setTimeout(() => frame.classList.add('hidden'), 300);
                    }
                    qrRegionDetected = null;
                    
                    // Restaurar bot√≥n flotante circular a azul - SIEMPRE resetear
                    if (captureBtn) {
                        const innerCircle = captureBtn.querySelector('div');
                        if (innerCircle) {
                            // Resetear siempre, sin condiciones
                            innerCircle.className = 'w-16 h-16 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center';
                            innerCircle.innerHTML = `
                                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <path d="m21 21-4.35-4.35"></path>
                                </svg>
                            `;
                        }
                    }
                }
            }
            
            animationFrameId = requestAnimationFrame(scanLoop);
        }
        
        function increaseContrast(imageData, factor = 1.5) {
            const data = new Uint8ClampedArray(imageData.data);
            const intercept = 128 * (1 - factor);
            
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, Math.max(0, data[i] * factor + intercept));         // R
                data[i + 1] = Math.min(255, Math.max(0, data[i + 1] * factor + intercept)); // G
                data[i + 2] = Math.min(255, Math.max(0, data[i + 2] * factor + intercept)); // B
                // Alpha (i+3) no se toca
            }
            
            return new ImageData(data, imageData.width, imageData.height);
        }
        
        function stopScanner() {
            scannerRunning = false;
            scanLoopCount = 0; // Reset del contador de frames
            
            // Reset variables de tracking QR
            qrRegionDetected = null;
            qrDetectionFrame = 0;
            qrStableFrames = 0; // Reset contador de estabilidad
            
            // Ocultar marco Google Lens
            const frame = document.getElementById('qr-detection-frame');
            if (frame) frame.classList.add('hidden');
            
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            if (stream) stream.getTracks().forEach(t => t.stop());
            video = null; stream = null;
        }
        
        function capturePhoto() {
            if (!video || video.readyState !== video.HAVE_ENOUGH_DATA) return;
            
            console.log('üì∏ Usuario puls√≥ capturar');
            
            // Capturar frame actual del video
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            tempCtx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
            
            let captureCanvas, captureCtx;
            
            // Si hay regi√≥n QR detectada, capturar solo esa regi√≥n
            if (qrRegionDetected) {
                console.log('üì∏ Capturando regi√≥n QR detectada');
                
                captureCanvas = document.createElement('canvas');
                captureCtx = captureCanvas.getContext('2d');
                
                // A√±adir margen 30% para asegurar captura completa
                const marginX = qrRegionDetected.width * 0.3;
                const marginY = qrRegionDetected.height * 0.3;
                const captureX = Math.max(0, qrRegionDetected.x - marginX);
                const captureY = Math.max(0, qrRegionDetected.y - marginY);
                const captureWidth = Math.min(tempCanvas.width - captureX, qrRegionDetected.width + marginX * 2);
                const captureHeight = Math.min(tempCanvas.height - captureY, qrRegionDetected.height + marginY * 2);
                
                captureCanvas.width = captureWidth;
                captureCanvas.height = captureHeight;
                
                // Extraer regi√≥n con margen
                captureCtx.drawImage(
                    tempCanvas,
                    captureX, captureY, captureWidth, captureHeight,
                    0, 0, captureWidth, captureHeight
                );
                
                console.log(`üì∏ Regi√≥n QR capturada: ${captureWidth}x${captureHeight}px`);
            } else {
                // Capturar frame completo
                console.log('üì∏ Capturando frame completo (no hay regi√≥n detectada)');
                captureCanvas = tempCanvas;
            }
            
            // Convertir a Blob y procesar
            captureCanvas.toBlob((blob) => {
                if (!blob) {
                    window.showErrorModal("Error al capturar la foto.");
                    return;
                }
                
                console.log('üì∏ Procesando con motor potente (12 intentos)...');
                stopScanner(); // Detener esc√°ner
                
                // Usar el motor de fotos que funciona perfecto
                decodeQRFromImage(blob);
            }, 'image/jpeg', 0.95);
        }
        
        
        function handleQRRead(raw) {
            stopScanner();
            const p = {};
            raw.split('&').forEach(part => {  
                let [key, ...rest] = part.split('=');
                let value = rest.join('=');
                try { p[key] = decodeURIComponent(value || '').replace(',', '.'); } catch (e) { p[key] = value || ''; }
            });
            
            let billingDays = 30;  
            let dateRangeStr = "No disponible";  
            let startDateStr = null;  
            let endDateStr = null;
            const isoDateRegex = /(\d{4}-\d{2}-\d{2})/i;
            const dmyDateRegex = /(\d{2}\/\d{2}\/\d{4})/i;  
            
            const iniF_key = Object.keys(p).find(k => k.toLowerCase() === 'inif');
            const finF_key = Object.keys(p).find(k => k.toLowerCase() === 'finf');  
            const iniA_key = Object.keys(p).find(k => k.toLowerCase() === 'inia');  
            let rawStartDate = iniF_key ? p[iniF_key] : null;
            let rawEndDate = finF_key ? p[finF_key] : (iniA_key ? p[iniA_key] : null);  
            
            if (rawStartDate) { let match = rawStartDate.match(isoDateRegex); if (match) { startDateStr = formatIsoToDmy(match[1]); } else { match = rawStartDate.match(dmyDateRegex); if (match) startDateStr = match[1]; } }
            if (rawEndDate) { let match = rawEndDate.match(isoDateRegex); if (match) { endDateStr = formatIsoToDmy(match[1]); } else { match = rawEndDate.match(dmyDateRegex); if (match) endDateStr = match[1]; } }
            
            if (startDateStr && endDateStr) {
                billingDays = calculateDays(startDateStr, endDateStr);
                dateRangeStr = `${startDateStr} - ${endDateStr}`;
            }

            const directData = {
                cups: p.cups || 'QR SCAN',
                dias_facturados: billingDays,
                importe_total: parseFloat(p.imp || 0), // FIX: asegurar que es float, default a 0
                potencia_p1_kw: parseFloat(p.pP1 || 0),
                potencia_p2_kw: parseFloat(p.pP2 || 0),
                // Solo se reciben 3 consumos del QR de la CNMC (P1, P2, P3 -> Punta, Llano, Valle)
                consumo_punta: parseFloat(p.cfP1 || 0),
                consumo_llano: parseFloat(p.cfP2 || 0),
                consumo_valle: parseFloat(p.cfP3 || 0),
                fechas: dateRangeStr,
                rawQR: raw  
            };
            
            const isMultiCupsMode = currentTariffType === 'MULTICUPS';

            if (directData.importe_total <= 0) return window.showErrorModal("QR incompleto. No se detect√≥ el Importe Total de la factura.");

            document.getElementById('scanner-view').classList.add('hidden');
            document.getElementById('loading-status').classList.add('hidden');

            if (isMultiCupsMode) {
                // En modo MultiCups, el QR solo puede ser 2.0TD
                // Creamos un objeto que imita el input manual
                const dataForSave = { ...directData, originalTariffType: '2.0TD' };  

                // Forzamos 2.0TD para la confirmaci√≥n
                tempQrData = dataForSave;
                // El tipo de tarifa a sugerir para la confirmaci√≥n es el seleccionado en la vista saga (o 2.0TD por defecto si es QR)
                const defaultTariffForConfirmation = multiCupsAddType || '2.0TD';
                document.getElementById('confirm-tariff-select').value = defaultTariffForConfirmation;  
                document.getElementById('confirm-tariff-select').innerHTML = `<option value="2.0TD">2.0 TD (Punta, Llano, Valle)</option><option value="3.0TD">3.0 TD (6 Periodos - Se mapear√°n P1/P2/P3)</option>`;

                // Mostrar modal de confirmaci√≥n (permitiendo al usuario cambiar a 3.0TD si lo necesita)
                showQRConfirmationModal(dataForSave);
            } else {
                // Modo Individual: Precarga inputs y compara directamente si es 2.0TD
                document.getElementById('input-cups').value = directData.cups;
                document.getElementById('input-total-bill').value = directData.importe_total;
                document.getElementById('input-billing-days').value = directData.dias_facturados;
                document.getElementById('input-p1-kw').value = directData.potencia_p1_kw;
                document.getElementById('input-p2-kw').value = directData.potencia_p2_kw;
                document.getElementById('input-e1-kwh').value = directData.consumo_punta;
                document.getElementById('input-e2-kwh').value = directData.consumo_llano;
                document.getElementById('input-e3-kwh').value = directData.consumo_valle;
                
                // Aseguramos que los 6 periodos est√©n ocultos si es 2.0TD.
                toggleMultiCupsInputPeriods(currentTariffType, 'input');

                if (currentTariffType === '2.0TD' && currentTariffs['2.0TD'].length > 0) {
                    compareOffers(directData);
                } else if (currentTariffs[currentTariffType]?.length > 0) {
                     window.showMessageModal(`QR le√≠do. Por favor, revise y complete los datos faltantes para tarifas ${currentTariffType}.`, "Completar Datos Manuales");
                     document.getElementById('manual-input-modal').classList.remove('hidden');
                     document.getElementById('manual-input-modal').classList.add('flex');
                } else {
                    window.showErrorModal("Las tarifas no han cargado a√∫n. Por favor, intente de nuevo.");
                }
            }
        }

        // --- FUNCIONES MULTICUPS A√ëADIDAS ---

        function showQRConfirmationModal(data) {
            tempQrData = data;
            const modal = document.getElementById('qr-confirm-modal');
            const summaryEl = document.getElementById('qr-data-summary');
            const selectEl = document.getElementById('confirm-tariff-select');
            const selectorWrapper = document.getElementById('tariff-selector-wrapper');
            
            // Si estamos en MultiCups Mode, ocultamos el selector
            if (currentTariffType === 'MULTICUPS') {
                // OCULTAR el selector completo
                selectorWrapper.style.display = 'none';
                
                // Establecer el valor (aunque est√© oculto)
                selectEl.value = multiCupsAddType;
                
                // Actualizar t√≠tulo y descripci√≥n
                modal.querySelector('h3').textContent = `${tr('Confirmar Suministro MultiCups')} (${multiCupsAddType})`;
                modal.querySelector('p').textContent = tr('Revisa los datos extra√≠dos del QR antes de a√±adir este suministro a la lista.');
            } else {
                // Modo Individual: MOSTRAR el selector
                selectorWrapper.style.display = 'block';
                
                // Opciones del selector
                selectEl.innerHTML = `<option value="2.0TD">2.0 TD (Punta, Llano, Valle)</option><option value="3.0TD">3.0 TD (6 Periodos)</option>`;
                selectEl.value = data.originalTariffType && data.originalTariffType !== '6.1TD' ? data.originalTariffType : '2.0TD';
                
                // Textos originales
                modal.querySelector('h3').textContent = `Confirmar Suministro`;
                modal.querySelector('p').textContent = `Revisa los datos extra√≠dos y selecciona el tipo de tarifa para a√±adir a la lista.`;
            }

            summaryEl.innerHTML = `
                <p class="font-bold text-slate-800 mb-2">${tr('Datos Extra√≠dos del QR')}</p>
                <div class="grid grid-cols-2 gap-1 text-xs">
                    <span>${tr('CUPS:')}</span><span class="font-mono text-right">${data.cups}</span>
                    <span>${tr('D√≠as Fact:')}</span><span class="font-mono text-right">${data.dias_facturados}</span>
                    <span>${tr('Total')} ${tr('Factura:')}</span><span class="font-mono text-right">${data.importe_total.toFixed(2)} ‚Ç¨</span>
                    <span class="col-span-2 border-t pt-1 mt-1 font-bold">${tr('Potencias (kW)')}:</span>
                    <span>P1:</span><span class="font-mono text-right">${data.potencia_p1_kw.toFixed(2)}</span>
                    <span>P2:</span><span class="font-mono text-right">${data.potencia_p2_kw.toFixed(2)}</span>
                    <span class="col-span-2 border-t pt-1 mt-1 font-bold">${tr('Consumos (kWh)')}:</span>
                    <span>${tr('Punta')} (E1):</span><span class="font-mono text-right">${data.consumo_punta}</span>
                    <span>${tr('Llano')} (E2):</span><span class="font-mono text-right">${data.consumo_llano}</span>
                    <span>${tr('Valle')} (E3):</span><span class="font-mono text-right">${data.consumo_valle}</span>
                </div>
            `;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // CR√çTICO: Traducir contenido del modal
            if (window.translateAll) {
                setTimeout(() => window.translateAll(), 50);
            }
        }

        document.getElementById('confirm-save-supply-btn').onclick = () => {
            if (!tempQrData) return;
            const tariffType = document.getElementById('confirm-tariff-select').value;
            
            saveSupply(tempQrData, tariffType);
            
            document.getElementById('qr-confirm-modal').classList.add('hidden');
            tempQrData = null;  
        };

        function saveSupply(data, tariffType) {
            // CR√çTICO: Limpiar variables globales para evitar contaminaci√≥n de CUPS anteriores
            availableOffers = [];
            lastComparisonResult = null;
            manuallySelectedOffer = null;  // ‚Üê CR√çTICO: Limpiar selecci√≥n manual anterior
            
            console.log('=== VERIFICACI√ìN CURRENTTARIFFS ===');
            console.log('currentTariffs keys:', Object.keys(currentTariffs));
            console.log('currentTariffs[2.0TD] length:', currentTariffs['2.0TD']?.length);
            console.log('currentTariffs[3.0TD] length:', currentTariffs['3.0TD']?.length);
            if (currentTariffs['2.0TD']?.[0]) {
                console.log('Primera tarifa 2.0TD - name:', currentTariffs['2.0TD'][0].name);
                console.log('Primera tarifa 2.0TD - p1_price:', currentTariffs['2.0TD'][0].p1_price);
            }
            if (currentTariffs['3.0TD']?.[0]) {
                console.log('Primera tarifa 3.0TD - name:', currentTariffs['3.0TD'][0].name);
                console.log('Primera tarifa 3.0TD - p1_price:', currentTariffs['3.0TD'][0].p1_price);
            }
            
            const tariffsToCompare = currentTariffs[tariffType];
            if (!tariffsToCompare || tariffsToCompare.length === 0) {
                window.showErrorModal(`Las tarifas ${tariffType} no est√°n cargadas.`);
                return;
            }
            
            console.log('=== SAVE SUPPLY DEBUG ===');
            console.log('TariffType:', tariffType);
            console.log('Tarifas disponibles:', tariffsToCompare.length);
            console.log('Primera tarifa name:', tariffsToCompare[0]?.name);
            console.log('Primera tarifa p1_price:', tariffsToCompare[0]?.p1_price);
            console.log('Primera tarifa p_potencia_1:', tariffsToCompare[0]?.p_potencia_1);
            
            // Creamos un nuevo objeto de datos para el c√°lculo, ya que el c√°lculo interno necesita los campos correctos (consumo_p1, consumo_p2, etc.)
            let dataForCalc = { ...data };
            
            const p1_kw = data.potencia_p1_kw || 0;
            const p2_kw = data.potencia_p2_kw || 0;
            const p3_kw_input = data.potencia_p3_kw || 0;
            const e4_kwh_input = data.consumo_p4 || 0;

            // 1. Manejo de mapeo de Potencias y Consumos
            // Simplificamos la condici√≥n, ya que solo 3.0TD es de alto voltaje
            if (tariffType === '3.0TD') {
                // Verificar si se introdujeron manualmente los 6 periodos
                const isManual6PeriodInput = p3_kw_input > 0 || e4_kwh_input > 0 || (data.consumo_p4 > 0 || data.consumo_p5 > 0 || data.consumo_p6 > 0);
                
                if (!isManual6PeriodInput) {
                    // Si es QR o Input Manual simplificado (solo 3 consumos/2 potencias)
                    // IMPORTANTE: Para 3.0TD las facturas muestran solo Punta/Llano/Valle
                    // pero la tarifa tiene 6 periodos de precios
                    
                    // Potencias: Propagar P1 y P2 a los 6 periodos
                    dataForCalc.potencia_p1_kw = p1_kw;
                    dataForCalc.potencia_p2_kw = p2_kw;
                    dataForCalc.potencia_p3_kw = p1_kw;
                    dataForCalc.potencia_p4_kw = p2_kw;
                    dataForCalc.potencia_p5_kw = p1_kw;  
                    dataForCalc.potencia_p6_kw = p2_kw;  
                    
                    // Consumos: Distribuir Punta/Llano/Valle entre los 6 periodos
                    // Estrategia: Asignar cada consumo a 2 periodos (duplicar)
                    const punta = data.consumo_punta || 0;
                    const llano = data.consumo_llano || 0;
                    const valle = data.consumo_valle || 0;
                    
                    // Distribuci√≥n t√≠pica en tarifas 3.0TD:
                    // P1, P4 = Punta (horas m√°s caras)
                    // P2, P5 = Llano (horas medias)
                    // P3, P6 = Valle (horas m√°s baratas)
                    dataForCalc.consumo_p1 = punta / 2;  // Mitad de punta
                    dataForCalc.consumo_p2 = llano / 2;  // Mitad de llano
                    dataForCalc.consumo_p3 = valle / 2;  // Mitad de valle
                    dataForCalc.consumo_p4 = punta / 2;  // Otra mitad de punta
                    dataForCalc.consumo_p5 = llano / 2;  // Otra mitad de llano
                    dataForCalc.consumo_p6 = valle / 2;  // Otra mitad de valle
                    
                    console.log('3.0TD QR Mode: Distributing consumptions across 6 periods');
                    console.log('Original - Punta:', punta, 'Llano:', llano, 'Valle:', valle);
                    console.log('Distributed - P1:', dataForCalc.consumo_p1, 'P2:', dataForCalc.consumo_p2, 'P3:', dataForCalc.consumo_p3);
                    console.log('Distributed - P4:', dataForCalc.consumo_p4, 'P5:', dataForCalc.consumo_p5, 'P6:', dataForCalc.consumo_p6);
                    
                } else {
                    // Es una entrada manual completa de 6 periodos
                    for(let i=1; i<=6; i++) {
                        dataForCalc[`consumo_p${i}`] = data[`consumo_p${i}`] || 0;
                        dataForCalc[`potencia_p${i}_kw`] = data[`potencia_p${i}_kw`] || 0;
                    }
                }
            } else if (tariffType === '2.0TD') {
                 // Para 2.0TD, aseguramos que los campos 'consumo_punta/llano/valle' est√°n llenos.
                 dataForCalc.consumo_punta = data.consumo_punta !== undefined ? data.consumo_punta : (data.consumo_p1 || 0);
                 dataForCalc.consumo_llano = data.consumo_llano !== undefined ? data.consumo_llano : (data.consumo_p2 || 0);
                 dataForCalc.consumo_valle = data.consumo_valle !== undefined ? data.consumo_valle : (data.consumo_p3 || 0);
                 // Solo usamos potencias P1 y P2
                 dataForCalc.potencia_p1_kw = data.potencia_p1_kw || 0;
                 dataForCalc.potencia_p2_kw = data.potencia_p2_kw || 0;
            }
            
            // 2. Ejecutar la comparaci√≥n con el objeto de datos corregido
            const results = tariffsToCompare.map(t => calculateTariffCost(t, dataForCalc, tariffType));
            
            let bestOverall = null; // Absolute best (DRK or Power Cup)
            let bestDrk = null;  // Best DRK only
            
            results.forEach(r => {
                // Siempre comparamos por el coste anual
                const annualCost = r.totalAnnual;
                
                // Best overall is the one with the lowest annual cost
                if (!bestOverall || annualCost < bestOverall.totalAnnual) {
                    bestOverall = r;
                }

                // Best DRK is the DRK one with the lowest annual cost
                if (r.offer.isDrk && r.offer.name !== 'Tu Tarifa Actual') {
                    if (!bestDrk || annualCost < bestDrk.totalAnnual) {
                            bestDrk = r;
                    }
                }
            });
            
            let finalIndividualResult = bestOverall;
            
            // --- GUARDAR OFERTAS PARA SELECCI√ìN MANUAL ---
            // En MultiCups, permitir elegir entre TODAS las ofertas (con o sin ahorro)
            // para dar al usuario la m√°xima flexibilidad
            // CR√çTICO: Verificar currentTariffType (que indica el modo general)
            // NO tariffType (que es el tipo espec√≠fico del CUPS actual: 2.0TD o 3.0TD)
            const isInMultiCupsFlow = currentTariffType === 'MULTICUPS';
            
            console.log('=== FILTER AVAILABLE OFFERS ===');
            console.log('currentTariffType (flow):', currentTariffType);
            console.log('tariffType (this CUPS):', tariffType);
            console.log('isInMultiCupsFlow:', isInMultiCupsFlow);
            console.log('comparisonMode:', comparisonMode);
            console.log('Total results:', results.length);
            
            availableOffers = results.filter(r => {
                // Si modo es "DRK √öNICAMENTE", filtrar solo ofertas DRK
                if (comparisonMode === 'drk_only') {
                    // En MultiCups: mostrar TODAS las ofertas DRK (con o sin ahorro)
                    // En Individual: solo ofertas DRK con ahorro positivo
                    if (isInMultiCupsFlow) {
                        return r.offer.isDrk && r.offer.name !== 'Tu Tarifa Actual';
                    } else {
                        const hasPositiveSavings = r.savings > 0 && r.totalAnnual < r.originalBillAnnual;
                        return hasPositiveSavings && r.offer.isDrk;
                    }
                }
                
                // En otros modos, mostrar ofertas con ahorro
                const hasPositiveSavings = r.savings > 0 && r.totalAnnual < r.originalBillAnnual;
                return hasPositiveSavings;
            });
            
            console.log('Filtered availableOffers.length:', availableOffers.length);
            
            console.log('=== AVAILABLE OFFERS DEBUG ===');
            console.log('Total availableOffers:', availableOffers.length);
            availableOffers.forEach((offer, idx) => {
                console.log(`Offer ${idx}: ${offer.offer.name}, p1_price: ${offer.offer.p1_price}, p_potencia_1: ${offer.offer.p_potencia_1}`);
            });
            
            // --- L√ìGICA DE SELECCI√ìN INDIVIDUAL SEG√öN MODO DE COMPARACI√ìN ---
            let brand = activeBrand;
            
            // Si hay una oferta seleccionada manualmente (desde el modal), usarla
            if (manuallySelectedOffer) {
                finalIndividualResult = manuallySelectedOffer;
                
                // Aplicar branding seg√∫n la oferta seleccionada
                if (finalIndividualResult.offer.isDrk) {
                    brand = BRANDS.DRK;
                } else {
                    brand = BRANDS.POWER_CUP;
                }
            } else {
                // Modo autom√°tico seg√∫n el modo de comparaci√≥n
                if (comparisonMode === 'overall_best') {
                    // Modo POWER CUP: Buscar la mejor oferta absoluta (con o sin DRK)
                    finalIndividualResult = bestOverall;
                    
                    // Aplicar branding seg√∫n qui√©n gan√≥
                    if (finalIndividualResult.offer.isDrk) {
                        brand = BRANDS.DRK;
                    } else {
                        brand = BRANDS.POWER_CUP;
                    }
                } else {
                    // Modos DRK (drk_only, drk_prioritized)
                    if (comparisonMode === 'drk_only') {
                        finalIndividualResult = bestDrk || bestOverall;
                        // DRK √öNICAMENTE: SIEMPRE mantener branding DRK (azul)
                        brand = BRANDS.DRK;
                    } else if (comparisonMode === 'drk_prioritized') {
                        // Usar DRK si tiene ahorro, sino usar la mejor absoluta
                        finalIndividualResult = (bestDrk && bestDrk.totalAnnual < bestDrk.originalBillAnnual) ? bestDrk : bestOverall;
                        
                        // DRK PRIORITARIO: Solo cambiar a POWER_CUP si gan√≥ una comercializadora NO-DRK
                        if (finalIndividualResult.offer.isDrk) {
                            brand = BRANDS.DRK;
                        } else {
                            brand = BRANDS.POWER_CUP;
                        }
                    }
                }
            }

            if (!finalIndividualResult) return window.showErrorModal("No se pudo calcular el ahorro para esta CUPS.");
            
            // Recalcular el ahorro basado en el resultado final seleccionado
            finalIndividualResult.savings = finalIndividualResult.originalBillAnnual - finalIndividualResult.totalAnnual;
            
            // Manejar casos sin ahorro
            if (finalIndividualResult.savings <= 0) {
                finalIndividualResult.isNegativeSavings = true;
                finalIndividualResult.savings = 0;
                finalIndividualResult.totalAnnual = finalIndividualResult.originalBillAnnual;
                finalIndividualResult.offer = { 
                    name: "Tu Tarifa Actual", 
                    description: "Es la mejor opci√≥n detectada", 
                    isDrk: false 
                };
                // Mantener el branding seg√∫n el modo seleccionado
                brand = comparisonMode === 'overall_best' ? BRANDS.POWER_CUP : BRANDS.DRK;
            }

            // Apply branding here just for consistency before saving/showing modal
            applyBrandStyles(brand);
            
            // Ensure the correct tariff type used for calculation is stored
            finalIndividualResult.originalTariffType = tariffType;
            
            // Copiar datos base del suministro (CUPS, d√≠as facturados, importe, etc.)
            finalIndividualResult.cups = data.cups || '';
            finalIndividualResult.importe_total = data.importe_total || 0;
            finalIndividualResult.dias_facturados = data.dias_facturados || 30;

            // Copy back the 6-period power and consumption values in case they were generated (for 3.0TD)
            if (tariffType === '3.0TD') {
                for (let i = 1; i <= 6; i++) {
                    finalIndividualResult[`consumo_p${i}`] = dataForCalc[`consumo_p${i}`] || 0;
                    finalIndividualResult[`potencia_p${i}_kw`] = dataForCalc[`potencia_p${i}_kw`] || 0;
                }
            } else if (tariffType === '2.0TD') {
                // Para 2.0TD tambi√©n copiar los datos
                finalIndividualResult.consumo_punta = dataForCalc.consumo_punta || 0;
                finalIndividualResult.consumo_llano = dataForCalc.consumo_llano || 0;
                finalIndividualResult.consumo_valle = dataForCalc.consumo_valle || 0;
                finalIndividualResult.potencia_p1_kw = dataForCalc.potencia_p1_kw || 0;
                finalIndividualResult.potencia_p2_kw = dataForCalc.potencia_p2_kw || 0;
            }
            
            // --- NUEVA L√ìGICA: Modal de decisi√≥n en MultiCups (TODOS LOS MODOS) ---
            // Si hay m√°s de 1 oferta, permitir elegir (en cualquier modo)
            if (availableOffers.length > 1) {
                console.log('MultiCups: Showing decision modal with', availableOffers.length, 'offers');
                
                // Guardar temporalmente el resultado para usarlo despu√©s
                lastComparisonResult = finalIndividualResult;
                lastComparisonResult.isMulti = false;
                lastComparisonResult._multiCupsContext = {
                    tariffType: tariffType,
                    dataForCalc: dataForCalc
                };
                
                // Mostrar modal de decisi√≥n
                showOfferDecisionModal();
                return; // No a√±adir todav√≠a, esperar decisi√≥n del usuario
            }
            
            // A√±adir directamente si solo hay 1 oferta o ninguna
            // CR√çTICO: Asegurar que el resultado tenga el contexto MULTICUPS
            finalIndividualResult._multiCupsContext = {
                tariffType: tariffType,
                dataForCalc: dataForCalc
            };
            
            // IMPORTANTE: Usar addSupplyToMultiCupsList para que recalcule costes correctamente
            addSupplyToMultiCupsList(finalIndividualResult);
            
            // La funci√≥n addSupplyToMultiCupsList ya actualiza la UI, pero como estamos
            // en saveSupply, NO llamamos a showMultiCupsSagaView aqu√≠
            // (se llama dentro de addSupplyToMultiCupsList)
            return; // Salir para no ejecutar c√≥digo duplicado
        }

        // --- FETCH & PARSE (Actualizado para M√∫ltiples Tarifas) ---

        async function fetchTariffsForMultiCups() {
            const statusEl = document.getElementById('loading-status-saga');
            statusEl.textContent = `Cargando tarifas 2.0TD y 3.0TD...`;
            updateMultiCupsSagaView(); // Update visibility to show loading
            
            // Fetch 2.0TD and 3.0TD tariffs simultaneously
            await Promise.all([
                fetchTariffsFromSheet('2.0TD'),
                fetchTariffsFromSheet('3.0TD')  
            ]);
            
            updateMultiCupsSagaView(); // Update visibility to hide loading and enable buttons
            
            if (currentTariffs['2.0TD'].length === 0 || currentTariffs['3.0TD'].length === 0) {
                 // Use a more specific error message based on which failed
                 const failed = [];
                 if (currentTariffs['2.0TD'].length === 0) failed.push('2.0TD');
                 if (currentTariffs['3.0TD'].length === 0) failed.push('3.0TD');
                 window.showErrorModal(`Error: Las tarifas ${failed.join(' y ')} para MultiCups no se han cargado correctamente. Intente de nuevo.`);
            }
        }
        
        async function fetchTariffsFromSheet(tariffType) {
            const config = TARIFF_CONFIG[tariffType];
            const sheetId = config.sheetId;

            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=0&t=${Date.now()}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Error red para ${tariffType}`);
                const text = await response.text();
                currentTariffs[tariffType] = parseCSV(text, tariffType);
                
                if (currentTariffType !== 'MULTICUPS' && tariffType === currentTariffType) {
                    const count = currentTariffs[currentTariffType].length;
                    document.getElementById('tariff-display-badge').textContent = count;
                }

            } catch (e) {
                console.error(`Error al cargar ${tariffType}:`, e);
                currentTariffs[tariffType] = [];  
                if (currentTariffType !== 'MULTICUPS' && tariffType === currentTariffType) {
                    document.getElementById('tariff-display-badge').textContent = 'Error';
                }
            } finally {
                if (currentTariffType !== 'MULTICUPS' && tariffType === currentTariffType) {
                    document.getElementById('loading-status').classList.add('hidden');
                }
            }
        }

        function parseCSV(text, tariffType) {
             const lines = text.trim().split('\n');
             if (lines.length < 2) return [];
             
             const rawHeader = lines[0];
             const delimiter = rawHeader.includes(';') ? ';' : ',';
             
             const headers = rawHeader.split(delimiter).map(h => h.trim().toLowerCase().replace(/"/g, ''));
             const data = [];

             for(let i=1; i<lines.length; i++) {
                 const row = lines[i].trim();
                 if(!row) continue;
                 
                 const regex = new RegExp(`(?:^|${delimiter})(\"(?:[^\"]|\"\")*\"|[^${delimiter}]*)`,"g");
                 const values = [];
                 let match = null;
                 regex.lastIndex = 0;  
                 // Custom parsing to handle quoted fields correctly
                 let lastIndex = 0;
                 while(match = regex.exec(row)){
                      let val = match[1].replace(/^"|"$/g, '').replace(/""/g, '"');
                      // If the first capture group starts with the delimiter, it means the content is empty or the previous field was empty.
                      if (match.index > lastIndex) {
                           // Add empty string for missed fields
                           for (let j = 0; j < (match.index - lastIndex) / delimiter.length; j++) {
                                values.push('');
                           }
                      }
                      values.push(val.trim());
                      lastIndex = match.index + match[0].length;
                 }
                 // Add trailing empty fields
                 if (values.length < headers.length) {
                      for (let j = values.length; j < headers.length; j++) {
                           values.push('');
                      }
                 }


                 if(values.length < headers.length) continue;

                 let item = { cups_match: [tariffType] };
                 headers.forEach((h, idx) => {
                      let val = values[idx];
                       if (h.includes('price') || h.includes('potencia') || h === 'descuento') {
                            val = parseFloat(val?.replace(',', '.') || 0);
                             if(isNaN(val)) val = 0;
                       }
                       item[h] = val;
                 });

                 // Marcar como DRK si el nombre O la descripci√≥n O commercializer contienen "DRK"
                 item.isDrk = item.name?.toUpperCase().includes('DRK') || 
                              item.description?.toUpperCase().includes('DRK') ||
                              item.commercializer?.toUpperCase().includes('DRK');
                 
                 // Check a mandatory field to ensure it's a valid row (using p1_price as a key indicator)
                 if(item.p1_price !== undefined) {
                     data.push(item);
                 }
               }
               return data;
        }
        
        // ===== FUNCIONES DE NAVEGACI√ìN =====
        function hideAllScreens() {
            // Pantallas principales
            document.getElementById('screen-inicio').classList.remove('active');
            document.getElementById('screen-electricidad').classList.remove('active');
            document.getElementById('screen-gas').classList.remove('active');
            document.getElementById('screen-gas-results').classList.remove('active');
            
            // Pantallas DUAL
            document.getElementById('screen-dual').classList.remove('active');
            document.getElementById('screen-dual-add-type').classList.remove('active');
            document.getElementById('screen-dual-results').classList.remove('active');
            document.getElementById('screen-dual-confirm').classList.remove('active');
            
            // Vistas del flujo normal (initial-view, scanner-view, results-view, multicups-saga-view)
            const initialView = document.getElementById('initial-view');
            const scannerView = document.getElementById('scanner-view');
            const resultsView = document.getElementById('results-view');
            const multicupsSagaView = document.getElementById('multicups-saga-view');
            
            if (initialView) initialView.classList.add('hidden');
            if (scannerView) scannerView.classList.add('hidden');
            if (resultsView) resultsView.classList.add('hidden');
            if (multicupsSagaView) multicupsSagaView.classList.add('hidden');
        }

        function switchResultTab(tabId) {
            // Ocultar todos los contenidos de pesta√±as
            document.querySelectorAll('.tab-result-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Desactivar todos los botones de pesta√±as
            document.querySelectorAll('.tab-result-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar el contenido seleccionado
            document.getElementById(tabId).classList.remove('hidden');
            
            // Activar el bot√≥n correspondiente
            document.getElementById('btn-' + tabId).classList.add('active');
        }

        function goToInicio() {
            // Limpiar flag de modo DUAL
            window.dualMode = false;
            
            hideAllScreens();
            document.getElementById('screen-inicio').classList.add('active');
            // Mostrar el modo de comparaci√≥n
            document.getElementById('modo-comparacion-section').style.display = 'block';
        }

        function goToElectricidad() {
            // Desactivar modo DUAL (solo activo cuando se navega desde dualSelectTariff)
            window.dualMode = false;
            checkDualMode(); // Actualizar visibilidad del bot√≥n DUAL
            hideAllScreens();
            document.getElementById('screen-electricidad').classList.add('active');
            // Ocultar el modo de comparaci√≥n (ya est√° seleccionado)
            document.getElementById('modo-comparacion-section').style.display = 'none';
        }

        function goToGas() {
            // Desactivar modo DUAL (solo activo cuando se navega desde dualSelectTariff)
            window.dualMode = false;
            checkDualMode(); // Actualizar visibilidad del bot√≥n DUAL
            
            // Limpiar resultados anteriores de GAS
            window.lastGasComparisonResult = null;
            
            hideAllScreens();
            document.getElementById('screen-gas').classList.add('active');
            // Ocultar el modo de comparaci√≥n (ya est√° seleccionado)
            document.getElementById('modo-comparacion-section').style.display = 'none';
        }
        
        // ========================================
        // NUEVO: FUNCIONES M√ìDULO DUAL
        // ========================================
        
        // Variables globales para DUAL
        window.dualSupplies = window.dualSupplies || []; // Array para almacenar todos los suministros
        let dualSupplies = window.dualSupplies; // Mantener referencia local por compatibilidad
        let dualCurrentType = null; // 'electricidad' o 'gas'
        let dualTempData = null; // Datos temporales del suministro actual
        let dualTempSupply = null; // Suministro temporal pendiente de confirmaci√≥n
        
        // Funci√≥n: Ir a pantalla DUAL
        function goToDual() {
            hideAllScreens();
            document.getElementById('screen-dual').classList.add('active');
            // Ocultar el modo de comparaci√≥n cuando estamos en DUAL
            document.getElementById('modo-comparacion-section').style.display = 'none';
            updateDualSuppliesList();
        }
        
        // Funci√≥n: Volver al gestor DUAL
        function backToDualManager() {
            // IMPORTANTE: NO desactivar dualMode aqu√≠ - debe permanecer activo
            // Solo se desactiva cuando sales completamente del DUAL
            console.log('=== backToDualManager - Volviendo al gestor DUAL ===');
            console.log('- dualMode sigue activo:', window.dualMode);
            console.log('- Total suministros en lista:', dualSupplies.length);
            
            hideAllScreens();
            document.getElementById('screen-dual').classList.add('active');
            // Ocultar el modo de comparaci√≥n cuando estamos en DUAL
            document.getElementById('modo-comparacion-section').style.display = 'none';
            updateDualSuppliesList();
            
            console.log('=== Gestor DUAL mostrado correctamente ===');
        }
        
        // Funci√≥n: A√±adir suministro
        function dualAddSupply() {
            console.log('=== dualAddSupply - Iniciando nuevo suministro ===');
            console.log('Estado ANTES de limpiar:');
            console.log('- dualTempSupply:', dualTempSupply);
            console.log('- lastComparisonResult:', lastComparisonResult);
            console.log('- lastIndexedResult:', lastIndexedResult);
            console.log('- availableOffers:', availableOffers.length);
            console.log('- dualMode:', window.dualMode);
            
            // CR√çTICO: Activar modo DUAL
            window.dualMode = true;
            
            // Limpiar variables anteriores para empezar limpio
            dualTempSupply = null;
            lastComparisonResult = null;
            lastIndexedResult = null;
            availableOffers = [];
            compareWithIndexed = false;
            
            // Limpiar el checkbox de comparaci√≥n
            const checkbox = document.getElementById('compare-indexed-checkbox');
            if (checkbox) {
                checkbox.checked = false;
            }
            
            console.log('Estado DESPU√âS de limpiar:');
            console.log('- dualTempSupply:', dualTempSupply);
            console.log('- lastComparisonResult:', lastComparisonResult);
            console.log('- dualMode:', window.dualMode);
            console.log('=== FIN limpieza - estado listo para nuevo suministro ===');
            
            hideAllScreens();
            document.getElementById('screen-dual-add-type').classList.add('active');
        }
        
        // Funci√≥n: Seleccionar tipo de suministro (OBSOLETA - mantenida por compatibilidad)
        function dualSelectType(type) {
            dualCurrentType = type;
            
            if (type === 'electricidad') {
                // Redirigir a pantalla de electricidad en modo DUAL
                hideAllScreens();
                document.getElementById('screen-electricidad').classList.add('active');
                // Marcar que estamos en modo DUAL
                window.dualMode = true;
            } else if (type === 'gas') {
                // Redirigir a pantalla de gas en modo DUAL
                hideAllScreens();
                document.getElementById('screen-gas').classList.add('active');
                // Marcar que estamos en modo DUAL
                window.dualMode = true;
            }
        }
        
        // NUEVA: Funci√≥n para seleccionar tarifa directamente
        function dualSelectTariff(type, tariff) {
            console.log('=================================================');
            console.log('=== dualSelectTariff LLAMADA ===');
            console.log('Type:', type);
            console.log('Tariff:', tariff);
            console.log('Estado ANTES:');
            console.log('- dualMode:', window.dualMode);
            console.log('- lastComparisonResult:', lastComparisonResult ? 'EXISTS' : 'NULL');
            console.log('- availableOffers:', availableOffers.length);
            console.log('=================================================');
            
            dualCurrentType = type;
            window.dualMode = true;
            checkDualMode(); // Actualizar visibilidad del bot√≥n DUAL
            
            if (type === 'electricidad') {
                // Configurar el tipo de tarifa ANTES de cambiar pantallas
                currentTariffType = tariff;
                console.log('‚úÖ Tarifa configurada:', currentTariffType);
                
                // Ocultar todas las pantallas
                hideAllScreens();
                
                // Mostrar la pantalla de electricidad
                document.getElementById('screen-electricidad').classList.add('active');
                
                // Limpiar vistas internas de electricidad
                document.getElementById('landing-view').classList.add('hidden');
                document.getElementById('scanner-view').classList.add('hidden');
                document.getElementById('results-view').classList.add('hidden');
                document.getElementById('multicups-saga-view').classList.add('hidden');
                
                // Mostrar initial-view
                document.getElementById('initial-view').classList.remove('hidden');
                
                console.log('‚úÖ Pantallas configuradas, llamando a selectTariffType...');
                
                // IMPORTANTE: Llamar a selectTariffType DESPU√âS de configurar las pantallas
                setTimeout(() => {
                    selectTariffType(tariff);
                    console.log('‚úÖ selectTariffType ejecutado para:', tariff);
                }, 50);
                
            } else if (type === 'gas') {
                // Para gas, establecer la tarifa
                currentGasTariff = tariff;
                console.log('Tarifa gas configurada:', currentGasTariff);
                
                // Ocultar todas las pantallas
                hideAllScreens();
                
                // Mostrar la pantalla de gas
                document.getElementById('screen-gas').classList.add('active');
                
                // Abrir modal de entrada de gas con un peque√±o delay
                setTimeout(() => {
                    selectGasTariff(tariff);
                    console.log('Modal gas abierto para:', tariff);
                }, 100);
            }
        }
        
        // Funci√≥n: Actualizar lista de suministros
        function updateDualSuppliesList() {
            const container = document.getElementById('dual-supplies-container');
            const count = document.getElementById('dual-supplies-count');
            const calculateBtn = document.getElementById('dual-calculate-btn');
            
            count.textContent = dualSupplies.length;
            
            if (dualSupplies.length === 0) {
                container.innerHTML = `<p class="text-sm text-slate-400 text-center py-4">${tr('No hay suministros a√±adidos')}</p>`;
                calculateBtn.disabled = true;
                calculateBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                calculateBtn.disabled = false;
                calculateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                calculateBtn.classList.remove('bg-slate-600', 'hover:bg-slate-700');
                calculateBtn.style.background = 'linear-gradient(135deg, #0ea5e9 0%, #84cc16 100%)';
                
                container.innerHTML = dualSupplies.map((supply, index) => {
                    const monthlyPrice = (supply.totalAnnual / 12).toFixed(2);
                    const annualPrice = supply.totalAnnual.toFixed(2);
                    const displayInfo = supply.cups || `${monthlyPrice}‚Ç¨/mes`;
                    
                    // Calcular ahorro
                    const ahorro = (supply.originalBillAnnual || 0) - (supply.totalAnnual || 0);
                    const tieneAhorro = ahorro > 0;
                    
                    return `
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200">
                        <div class="flex items-center gap-3 flex-1">
                            <span class="text-2xl">${supply.type === 'electricidad' ? '‚ö°' : 'üî•'}</span>
                            <div class="flex-1">
                                <p class="text-sm font-bold text-slate-800">${supply.type === 'electricidad' ? 'Electricidad' : 'Gas'} - ${supply.tariff}</p>
                                <p class="text-xs text-slate-500">${displayInfo}</p>
                                ${!tieneAhorro ? '<p class="text-xs text-slate-400 mt-1">No hay ahorro</p>' : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-bold text-blue-600">${monthlyPrice}‚Ç¨/mes</p>
                            <p class="text-xs ${tieneAhorro ? 'text-green-600' : 'text-slate-400'}">${annualPrice}‚Ç¨/a√±o</p>
                        </div>
                    </div>
                `;
                }).join('');
            }
        }
        
        // Funci√≥n: Eliminar suministro
        function dualRemoveSupply(index) {
            dualSupplies.splice(index, 1);
            updateDualSuppliesList();
        }
        
        // Funci√≥n: Limpiar todo
        function dualReset() {
            if (confirm('¬øEst√°s seguro de que quieres eliminar todos los suministros?')) {
                window.dualSupplies = [];
                dualSupplies = window.dualSupplies; // Mantener referencia
                updateDualSuppliesList();
            }
        }
        
        // Funci√≥n: Calcular comparativa global
        function dualCalculate() {
            console.log('===== dualCalculate LLAMADA =====');
            console.log('Suministros en array:', dualSupplies.length);
            
            if (dualSupplies.length === 0) {
                window.showErrorModal('Debes a√±adir al menos un suministro antes de calcular.', '‚ö†Ô∏è No hay suministros');
                return;
            }
            
            // CORREGIDO: Si solo hay 1 suministro, avisar que falta el otro
            if (dualSupplies.length === 1) {
                console.log('‚ö†Ô∏è Solo 1 suministro detectado');
                const supply = dualSupplies[0];
                const tipoActual = supply.type;
                const tipoFaltante = tipoActual === 'electricidad' ? 'GAS' : 'ELECTRICIDAD';
                
                window.showErrorModal(
                    `Para hacer una comparativa DUAL necesitas a√±adir tanto ELECTRICIDAD como GAS.\n\n` +
                    `Actualmente solo tienes: ${tipoActual.toUpperCase()}\n\n` +
                    `Por favor, a√±ade un suministro de ${tipoFaltante}.`,
                    '‚ö†Ô∏è Falta a√±adir suministro'
                );
                console.log(`Usuario necesita a√±adir: ${tipoFaltante}`);
                return;
            }
            
            // NUEVO: Verificar que hay tanto electricidad como gas
            const hasElectricidad = dualSupplies.some(s => s.type === 'electricidad');
            const hasGas = dualSupplies.some(s => s.type === 'gas');
            
            if (!hasElectricidad || !hasGas) {
                const tipoFaltante = !hasElectricidad ? 'ELECTRICIDAD' : 'GAS';
                window.showErrorModal(
                    `Para hacer una comparativa DUAL necesitas a√±adir tanto ELECTRICIDAD como GAS.\n\n` +
                    `Falta a√±adir: ${tipoFaltante}\n\n` +
                    `Por favor, a√±ade un suministro de ${tipoFaltante}.`,
                    '‚ö†Ô∏è Falta tipo de suministro'
                );
                console.log(`Falta a√±adir: ${tipoFaltante}`);
                return;
            }
            
            // C√≥digo original para m√∫ltiples suministros (2 o m√°s)
            
            // Calcular totales DRK y Power Cup
            let totalDRK = 0;
            let totalPowerCup = 0;
            let totalDaysWeighted = 0;
            let totalOriginalBill = 0; // NUEVO: Total factura actual
            
            // NUEVO: Analizar ahorros individuales
            const suppliesWithSavings = [];
            const suppliesWithoutSavings = [];
            
            dualSupplies.forEach(supply => {
                if (supply.results) {
                    const drkCost = supply.results.drk?.total_anual || 0;
                    const powercupCost = supply.results.powercup?.total_anual || 0;
                    const originalBill = supply.originalBillAnnual || 0;
                    
                    totalDRK += drkCost;
                    totalPowerCup += powercupCost;
                    totalDaysWeighted += supply.data.dias || 30;
                    totalOriginalBill += originalBill;
                    
                    // Determinar si este suministro tiene ahorro
                    const isPowerCupMode = comparisonMode === 'overall_best';
                    const currentCost = isPowerCupMode ? powercupCost : drkCost;
                    const savings = originalBill - currentCost;
                    
                    if (savings > 0) {
                        suppliesWithSavings.push({...supply, savings});
                    } else {
                        suppliesWithoutSavings.push({...supply, savings});
                    }
                }
            });
            
            // Calcular ahorro total
            const isPowerCupMode = comparisonMode === 'overall_best';
            const totalNew = isPowerCupMode ? totalPowerCup : totalDRK;
            const totalSavings = Math.max(0, totalOriginalBill - totalNew); // Siempre >= 0
            
            console.log('üìä An√°lisis de ahorros:');
            console.log('- Con ahorro:', suppliesWithSavings.length);
            console.log('- Sin ahorro:', suppliesWithoutSavings.length);
            console.log('- Ahorro total:', totalSavings.toFixed(2), '‚Ç¨');
            
            // Guardar resultados globales (incluyendo an√°lisis de ahorros)
            window.dualGlobalResults = {
                comparisonMode: comparisonMode,
                totalDRK,
                totalPowerCup,
                totalOriginalBill,
                totalSavings,
                diff: totalPowerCup - totalDRK,
                supplies: dualSupplies.length,
                avgDays: Math.round(totalDaysWeighted / dualSupplies.length),
                suppliesWithSavings: suppliesWithSavings.length,
                suppliesWithoutSavings: suppliesWithoutSavings.length
            };
            
            // Mostrar resultados
            showDualResults();
        }
        
        // Funci√≥n: Mostrar resultados DUAL
        function showDualResults() {
            hideAllScreens();
            document.getElementById('screen-dual-results').classList.add('active');
            
            const container = document.getElementById('dual-results-container');
            const count = document.getElementById('dual-results-count');
            const results = window.dualGlobalResults;
            
            count.textContent = results.supplies;
            
            const formatEuro = (val) => val.toFixed(2).replace('.', ',') + ' ‚Ç¨';
            
            container.innerHTML = `
                <!-- Resumen por tipo -->
                <div class="bg-slate-50 rounded-xl p-4 mb-4">
                    <h3 class="text-sm font-bold text-slate-700 mb-3">${tr('Resumen de suministros')}</h3>
                    <div class="space-y-3">
                        ${dualSupplies.map((s, idx) => {
                            // CORREGIDO: Usar s.totalAnnual directamente (ya tiene la l√≥gica correcta)
                            const isPowerCupMode = results.comparisonMode === 'overall_best';
                            const currentCost = s.totalAnnual || 0; // Usar s.totalAnnual en lugar de results
                            const originalBill = s.originalBillAnnual || 0;
                            const savings = originalBill - currentCost;
                            
                            // DEBUG: Logging detallado
                            console.log(`üìä Suministro ${idx + 1} (${s.type}):`);
                            console.log('  - originalBillAnnual:', s.originalBillAnnual);
                            console.log('  - s.totalAnnual (USADO):', s.totalAnnual);
                            console.log('  - currentCost:', currentCost);
                            console.log('  - results.drk.total_anual:', s.results.drk?.total_anual);
                            console.log('  - results.powercup.total_anual:', s.results.powercup?.total_anual);
                            console.log('  - savings calculado:', savings);
                            
                            // Construir nombre completo de tarifa: COMERCIALIZADORA - TARIFA
                            const comercializadora = s.offer?.name || '';
                            const tarifa = s.offer?.description || '';
                            const tariffName = (comercializadora && tarifa && comercializadora !== tarifa) 
                                ? `${comercializadora} - ${tarifa}` 
                                : (tarifa || comercializadora || 'Tarifa DRK');
                            
                            // Para GAS, mostrar desglose completo
                            if (s.type === 'gas' && s.gasBreakdown) {
                                const gb = s.gasBreakdown;
                                return `
                                <div class="bg-white rounded-lg p-3 border border-slate-200">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center gap-2">
                                            <span class="text-lg">üî•</span>
                                            <span class="text-xs font-semibold text-slate-600">${s.tariff}</span>
                                        </div>
                                        <span class="text-sm font-bold text-slate-900">${formatEuro(currentCost)}</span>
                                    </div>
                                    <div class="text-xs text-slate-700 font-medium mb-2">${tariffName}</div>
                                    
                                    <!-- Desglose GAS -->
                                    <div class="bg-slate-50 rounded p-2 space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span>${tr('T√©rmino fijo (')}${gb.dias} ${tr('d√≠as')})</span>
                                            <span>${formatEuro(gb.termino_fijo)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>${tr('Energ√≠a')} (${gb.kwh} kWh)</span>
                                            <span>${formatEuro(gb.energia)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>${tr('Imp. hidrocarburos')}</span>
                                            <span>${formatEuro(gb.impuesto_hidrocarburos)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>IVA (21%)</span>
                                            <span>${formatEuro(gb.iva)}</span>
                                        </div>
                                        <div class="flex justify-between font-semibold pt-1 border-t border-slate-200">
                                            <span>${tr('TOTAL MENSUAL')}</span>
                                            <span>${formatEuro(gb.total)}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center justify-between mt-2 pt-2 border-t border-slate-200">
                                        <span class="text-xs text-slate-600">${tr('Factura actual:')} ${formatEuro(originalBill / 12)}${tr('/mes')}</span>
                                        <span class="text-xs font-semibold ${savings > 0 ? 'text-green-600' : 'text-slate-500'}">${tr('Ahorro:')} ${formatEuro(Math.max(0, savings))}${tr('/a√±o')}</span>
                                    </div>
                                </div>
                            `;
                            }
                            
                            // Para ELECTRICIDAD, mostrar desglose completo tambi√©n
                            if (s.type === 'electricidad' && s.electricityBreakdown) {
                                const eb = s.electricityBreakdown;
                                const totalKwh = eb.energyCosts?.reduce((sum, e) => sum + (e.kwh || 0), 0) || 0;
                                
                                return `
                                <div class="bg-white rounded-lg p-3 border border-slate-200">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center gap-2">
                                            <span class="text-lg">‚ö°</span>
                                            <span class="text-xs font-semibold text-slate-600">${s.tariff}</span>
                                        </div>
                                        <span class="text-sm font-bold text-slate-900">${formatEuro(currentCost)}</span>
                                    </div>
                                    <div class="text-xs text-slate-700 font-medium mb-2">${tariffName}</div>
                                    
                                    <!-- Desglose ELECTRICIDAD -->
                                    <div class="bg-slate-50 rounded p-2 space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span>${tr('Potencia')} (${eb.dias} ${tr('d√≠as')})</span>
                                            <span>${formatEuro(eb.subPower)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>${tr('Energ√≠a')} (${totalKwh.toFixed(0)} kWh)</span>
                                            <span>${formatEuro(eb.subEnergy)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>${tr('Imp. el√©ctrico (5.113%)')}</span>
                                            <span>${formatEuro(eb.costIE)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>IVA (21%)</span>
                                            <span>${formatEuro(eb.costIVA)}</span>
                                        </div>
                                        <div class="flex justify-between font-semibold pt-1 border-t border-slate-200">
                                            <span>${tr('TOTAL PERIODO')}</span>
                                            <span>${formatEuro(eb.totalPeriod)}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center justify-between mt-2 pt-2 border-t border-slate-200">
                                        <span class="text-xs text-slate-600">${tr('Factura actual:')} ${formatEuro(originalBill / 12)}${tr('/mes')}</span>
                                        <span class="text-xs font-semibold ${savings > 0 ? 'text-green-600' : 'text-slate-500'}">${tr('Ahorro:')} ${formatEuro(Math.max(0, savings))}${tr('/a√±o')}</span>
                                    </div>
                                </div>
                            `;
                            }
                            
                            // Fallback simple si no hay desglose
                            return `
                            <div class="bg-white rounded-lg p-3 border border-slate-200">
                                <div class="flex items-center justify-between mb-1">
                                    <div class="flex items-center gap-2">
                                        <span class="text-lg">${s.type === 'electricidad' ? '‚ö°' : 'üî•'}</span>
                                        <span class="text-xs font-semibold text-slate-600">${s.tariff}</span>
                                    </div>
                                    <span class="text-sm font-bold text-slate-900">${formatEuro(currentCost)}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-slate-700 font-medium">${tariffName}</span>
                                    <span class="text-xs font-semibold ${savings > 0 ? 'text-green-600' : 'text-slate-500'}">${tr('Ahorro')}: ${formatEuro(Math.max(0, savings))}</span>
                                </div>
                            </div>
                        `;
                        }).join('')}
                    </div>
                </div>
                
                <!-- Tarjeta AHORRO TOTAL (SOLO si NO es modo Power Cup) -->
                ${(() => {
                    // Verificar si TODOS los suministros tienen ahorro <= 0
                    let allWithoutSavings = true;
                    dualSupplies.forEach(s => {
                        const currentCost = s.totalAnnual || 0;
                        const originalBill = s.originalBillAnnual || 0;
                        const savings = originalBill - currentCost;
                        if (savings > 0) allWithoutSavings = false;
                    });
                    
                    if (results.comparisonMode !== 'overall_best' && results.totalSavings > 0 && !allWithoutSavings) {
                        return `
                <div class="rounded-2xl shadow-2xl p-6 mb-6" style="background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%); border: 2px solid #5BA3F5;">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-2xl font-bold text-white">üí∞ Ahorro Total</h3>
                        <div class="bg-white bg-opacity-20 p-3 rounded-xl">
                            <span class="text-2xl">üìä</span>
                        </div>
                    </div>
                    <div class="bg-white bg-opacity-10 rounded-xl p-4 mb-3">
                        <p class="text-sm text-white opacity-90 mb-2">Factura actual total:</p>
                        <p class="text-2xl font-bold text-white">${formatEuro(results.totalOriginalBill)}</p>
                    </div>
                    <div class="bg-white bg-opacity-10 rounded-xl p-4 mb-3">
                        <p class="text-sm text-white opacity-90 mb-2">Con DRK pagar√≠as:</p>
                        <p class="text-2xl font-bold text-white">${formatEuro(results.totalDRK)}</p>
                    </div>
                    <div class="rounded-xl p-4" style="background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.3);">
                        <p class="text-sm text-white opacity-90 mb-2">üéâ Ahorro anual generado:</p>
                        <p class="text-4xl font-bold text-white">${formatEuro(results.totalSavings)}</p>
                        <p class="text-sm text-white opacity-80 mt-2">${(results.totalSavings / 12).toFixed(2).replace('.', ',')} ‚Ç¨ al mes</p>
                    </div>
                </div>
                        `;
                    } else if (results.comparisonMode !== 'overall_best' && allWithoutSavings) {
                        return `
                <div class="rounded-2xl shadow-2xl p-6 mb-6" style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); border: 2px solid #0ea5e9;">
                    <div class="text-center text-white">
                        <h3 class="text-3xl font-bold mb-4">¬°ENHORABUENA!</h3>
                        <div class="bg-white bg-opacity-10 rounded-xl p-6 mb-4">
                            <p class="text-xl font-bold mb-3">Actualmente est√°s en buenas tarifas</p>
                            <p class="text-base opacity-90">Tanto en ELECTRICIDAD como en GAS tienes tarifas competitivas.</p>
                        </div>
                        <div class="bg-white bg-opacity-10 rounded-xl p-4">
                            <p class="text-sm opacity-80">üìä Factura actual total anual:</p>
                            <p class="text-3xl font-bold mt-2">${formatEuro(results.totalOriginalBill)}</p>
                        </div>
                    </div>
                </div>
                        `;
                    }
                    return '';
                })()}
                
                <!-- Tarjeta AHORRO TOTAL para Power Cup (SOLO si es modo Power Cup) -->
                ${(() => {
                    // Verificar si TODOS los suministros tienen ahorro <= 0
                    let allWithoutSavings = true;
                    dualSupplies.forEach(s => {
                        const currentCost = s.totalAnnual || 0;
                        const originalBill = s.originalBillAnnual || 0;
                        const savings = originalBill - currentCost;
                        if (savings > 0) allWithoutSavings = false;
                    });
                    
                    if (results.comparisonMode === 'overall_best' && results.totalSavings > 0 && !allWithoutSavings) {
                        return `
                <div class="bg-gradient-to-br from-powercup-600 to-powercup-800 text-white rounded-2xl shadow-2xl p-6 border-2 border-powercup-500 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-2xl font-bold">üí∞ Ahorro Total</h3>
                        <div class="bg-white bg-opacity-20 p-3 rounded-xl">
                            <span class="text-2xl">üìä</span>
                        </div>
                    </div>
                    <div class="bg-white bg-opacity-10 rounded-xl p-4 mb-3">
                        <p class="text-sm text-powercup-100 mb-2">Factura actual total:</p>
                        <p class="text-2xl font-bold">${formatEuro(results.totalOriginalBill)}</p>
                    </div>
                    <div class="bg-white bg-opacity-10 rounded-xl p-4 mb-3">
                        <p class="text-sm text-powercup-100 mb-2">Con Power Cup pagar√≠as:</p>
                        <p class="text-2xl font-bold">${formatEuro(results.totalPowerCup)}</p>
                    </div>
                    <div class="rounded-xl p-4" style="background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.3);">
                        <p class="text-sm text-powercup-100 mb-2">üéâ Ahorro anual generado:</p>
                        <p class="text-4xl font-bold">${formatEuro(results.totalSavings)}</p>
                        <p class="text-sm text-powercup-100 mt-2">${(results.totalSavings / 12).toFixed(2).replace('.', ',')} ‚Ç¨ al mes</p>
                    </div>
                </div>
                        `;
                    } else if (results.comparisonMode === 'overall_best' && allWithoutSavings) {
                        return `
                <div class="bg-gradient-to-br from-powercup-600 to-powercup-800 text-white rounded-2xl shadow-2xl p-6 border-2 border-powercup-500 mb-6">
                    <div class="text-center">
                        <h3 class="text-3xl font-bold mb-4">¬°ENHORABUENA!</h3>
                        <div class="bg-white bg-opacity-10 rounded-xl p-6 mb-4">
                            <p class="text-xl font-bold mb-3">Actualmente est√°s en buenas tarifas</p>
                            <p class="text-base opacity-90">Tanto en ELECTRICIDAD como en GAS tienes tarifas competitivas.</p>
                        </div>
                        <div class="bg-white bg-opacity-10 rounded-xl p-4">
                            <p class="text-sm opacity-80">üìä Factura actual total anual:</p>
                            <p class="text-3xl font-bold mt-2">${formatEuro(results.totalOriginalBill)}</p>
                        </div>
                    </div>
                </div>
                        `;
                    }
                    return '';
                })()}
            `;
            
            // NUEVO: Mostrar/ocultar bot√≥n de solicitar mejora
            // Verificar si AMBOS suministros tienen ahorro <= 0
            let allSuppliesWithoutSavings = true;
            
            dualSupplies.forEach(s => {
                const isPowerCupMode = results.comparisonMode === 'overall_best';
                const currentCost = s.totalAnnual || 0;
                const originalBill = s.originalBillAnnual || 0;
                const savings = originalBill - currentCost;
                
                if (savings > 0) {
                    allSuppliesWithoutSavings = false;
                }
            });
            
            const dualImprovementBtn = document.getElementById('dual-request-improvement-container');
            if (dualImprovementBtn) {
                if (allSuppliesWithoutSavings) {
                    dualImprovementBtn.style.display = 'block';
                    console.log('‚úÖ DUAL: Mostrando bot√≥n SOLICITAR MEJORA (ambos sin ahorro)');
                } else {
                    dualImprovementBtn.style.display = 'none';
                    console.log('‚ùå DUAL: Ocultando bot√≥n (al menos uno tiene ahorro)');
                }
            }
        }
        
        // Funci√≥n: Mostrar modal de datos del comercial y cliente
        function showClientDataModal() {
            if (!dualSupplies || dualSupplies.length === 0) {
                alert('No hay suministros para generar la propuesta.');
                return;
            }
            
            const results = window.dualGlobalResults;
            if (!results) {
                alert('Calcula la comparativa primero.');
                return;
            }
            
            // Mostrar el modal
            document.getElementById('client-data-modal').classList.remove('hidden');
            document.getElementById('client-data-modal').classList.add('flex');
        }
        
        // Funci√≥n: Cerrar modal de datos del cliente
        function closeClientDataModal() {
            document.getElementById('client-data-modal').classList.remove('flex');
            document.getElementById('client-data-modal').classList.add('hidden');
        }
        
        // Funci√≥n: Copiar HTML comparativo al portapapeles
        function copyDualHTML() {
            try {
                const currentLang = localStorage.getItem('appLanguage') || 'es';
                console.log('üîç copyDualHTML llamado, idioma:', currentLang);
                
                // NUEVO: Para CHINO, leer datos del DOM y construir HTML con tablas
                if (currentLang === 'zh') {
                    console.log('üá®üá≥ Modo chino detectado - extrayendo datos del DOM y construyendo tablas');
                    
                    // Detectar si es Power Cup o DRK
                    const results = window.dualGlobalResults || {};
                    const isPowerCup = results.comparisonMode === 'overall_best';
                    const bannerColor = isPowerCup ? '#84cc16' : '#0ea5e9'; // Verde Power Cup o Azul DRK
                    const savingsColor = isPowerCup ? '#4d7c0f' : '#16a34a'; // Verde oscuro Power Cup o Verde DRK
                    const brandName = isPowerCup ? 'POWER CUP' : 'DRK';
                    console.log('üè∑Ô∏è Marca detectada:', brandName, '| Color banner:', bannerColor);
                    
                    // Verificar que hay resultados renderizados en el DOM
                    const resultsContainer = document.getElementById('dual-results-container');
                    if (!resultsContainer || resultsContainer.innerHTML.trim().length < 100) {
                        console.error('‚ùå No hay resultados renderizados en el DOM');
                        alert('Ê≤°ÊúâË¶ÅÂ§çÂà∂ÁöÑÁªìÊûú / No results to copy\n\nËØ∑ÂÖàËÆ°ÁÆóÁªìÊûú / Please calculate results first');
                        return;
                    }
                    
                    // Extraer tarjetas de suministros del DOM
                    const supplyCards = resultsContainer.querySelectorAll('.bg-white.rounded-lg.border.border-slate-200');
                    console.log('üì¶ Tarjetas encontradas:', supplyCards.length);
                    
                    if (supplyCards.length === 0) {
                        alert('‚ùå No se encontraron tarjetas de suministros\n\nPlease try again');
                        return;
                    }
                    
                    let suppliesHTML = '';
                    
                    // Procesar cada tarjeta
                    supplyCards.forEach((card, index) => {
                        // Determinar tipo (electricidad o gas) por el icono
                        const iconElement = card.querySelector('.text-lg');
                        const iconText = iconElement ? iconElement.textContent.trim() : '';
                        const isElec = iconText.includes('‚ö°');
                        const icon = isElec ? '‚ö°' : 'üî•';
                        const bgColor = isElec ? '#f0fdf4' : '#fff7ed';
                        const borderColor = isElec ? '#86efac' : '#fed7aa';
                        
                        // Extraer datos de la tarjeta
                        const tariffElement = card.querySelector('.text-xs.font-semibold.text-slate-600');
                        const tariff = tariffElement ? tariffElement.textContent.trim() : '';
                        
                        const totalElement = card.querySelector('.text-sm.font-bold.text-slate-900');
                        const total = totalElement ? totalElement.textContent.trim() : '0,00 ‚Ç¨';
                        
                        const nameElement = card.querySelector('.text-xs.text-slate-700.font-medium');
                        const name = nameElement ? nameElement.textContent.trim() : 'DRK';
                        
                        // Extraer l√≠neas de desglose de la secci√≥n bg-slate-50
                        const detailsSection = card.querySelector('.bg-slate-50');
                        let detailsHTML = '';
                        
                        if (detailsSection) {
                            const detailRows = detailsSection.querySelectorAll('.flex.justify-between');
                            detailRows.forEach(row => {
                                const spans = row.querySelectorAll('span');
                                if (spans.length === 2) {
                                    const label = spans[0].textContent.trim();
                                    const value = spans[1].textContent.trim();
                                    
                                    const isBold = row.classList.contains('font-semibold') || label.includes('TOTAL');
                                    const style = isBold 
                                        ? 'padding: 8px 0; font-weight: bold; color: #1e293b; border-top: 2px solid #e2e8f0;'
                                        : 'padding: 4px 0; color: #64748b;';
                                    
                                    detailsHTML += `
                                        <tr>
                                            <td style="${style}">${label}</td>
                                            <td style="${style} text-align: right;">${value}</td>
                                        </tr>
                                    `;
                                }
                            });
                        }
                        
                        // Extraer ahorro de la secci√≥n inferior
                        const savingsSection = card.querySelector('.flex.items-center.justify-between.mt-2');
                        let currentBill = '0,00 ‚Ç¨/Êúà';
                        let savings = '0,00 ‚Ç¨/Âπ¥';
                        
                        if (savingsSection) {
                            const spans = savingsSection.querySelectorAll('span');
                            if (spans.length >= 2) {
                                const currentText = spans[0].textContent;
                                const savingsText = spans[1].textContent;
                                
                                const currentMatch = currentText.match(/([0-9,.]+\s*‚Ç¨\/[^)]+)/);
                                const savingsMatch = savingsText.match(/([0-9,.]+\s*‚Ç¨\/[^)]+)/);
                                
                                if (currentMatch) currentBill = currentMatch[1];
                                if (savingsMatch) savings = savingsMatch[1];
                            }
                        }
                        
                        // Construir HTML de la tarjeta
                        suppliesHTML += `
                            <!-- Tarjeta de suministro ${index + 1} -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background: white; border: 2px solid ${borderColor}; border-radius: 12px; margin-bottom: 20px;">
                                <tr>
                                    <td style="padding: 20px;">
                                        <!-- Encabezado del suministro -->
                                        <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom: 15px;">
                                            <tr>
                                                <td style="font-size: 32px; width: 50px;">${icon}</td>
                                                <td style="text-align: left; padding-left: 10px;">
                                                    <div style="font-size: 20px; font-weight: bold; color: #1e293b;">${tariff}</div>
                                                </td>
                                                <td style="text-align: right;">
                                                    <div style="font-size: 28px; font-weight: bold; color: #1e293b;">${total}</div>
                                                </td>
                                            </tr>
                                        </table>
                                        
                                        <!-- Nombre de tarifa -->
                                        <div style="font-size: 16px; font-weight: bold; color: #475569; margin-bottom: 15px;">
                                            ${name}
                                        </div>
                                        
                                        <!-- Detalles del breakdown -->
                                        <table width="100%" cellpadding="0" cellspacing="0" style="font-size: 14px; margin-bottom: 15px;">
                                            ${detailsHTML}
                                        </table>
                                        
                                        <!-- Ahorro -->
                                        <table width="100%" cellpadding="0" cellspacing="0" style="background: ${bgColor}; border-radius: 8px; padding: 12px;">
                                            <tr>
                                                <td style="font-size: 14px; color: #64748b; width: 50%;">ÂΩìÂâçË¥¶ÂçïÔºö</td>
                                                <td style="text-align: center; font-size: 16px; font-weight: bold; color: #1e293b; width: 25%;">${currentBill}</td>
                                                <td style="font-size: 14px; color: #16a34a; text-align: right; width: 12%;">ËäÇÁúÅÔºö</td>
                                                <td style="text-align: right; font-size: 16px; font-weight: bold; color: #16a34a; width: 13%;">${savings}</td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        `;
                    });
                    
                    // Extraer totales del resumen
                    const totalSavingsSection = resultsContainer.querySelector('.rounded-2xl.shadow-2xl');
                    let totalOriginal = '0,00 ‚Ç¨';
                    let totalNew = '0,00 ‚Ç¨';
                    let totalAhorro = '0,00 ‚Ç¨';
                    let ahorroMes = '0,00 ‚Ç¨';
                    
                    if (totalSavingsSection) {
                        const allParagraphs = totalSavingsSection.querySelectorAll('p');
                        allParagraphs.forEach(p => {
                            const text = p.textContent.trim();
                            
                            // Buscar "Factura actual total:" seguido del valor
                            if (text.includes('Factura actual total')) {
                                const nextP = p.nextElementSibling;
                                if (nextP && nextP.tagName === 'P') {
                                    totalOriginal = nextP.textContent.trim();
                                }
                            }
                            // Buscar "Con DRK pagar√≠as:"
                            else if (text.includes('Con DRK pagar√≠as')) {
                                const nextP = p.nextElementSibling;
                                if (nextP && nextP.tagName === 'P') {
                                    totalNew = nextP.textContent.trim();
                                }
                            }
                            // Buscar "Ahorro anual generado:"
                            else if (text.includes('Ahorro anual generado')) {
                                const nextP = p.nextElementSibling;
                                if (nextP && nextP.tagName === 'P') {
                                    totalAhorro = nextP.textContent.trim();
                                }
                                // El siguiente despu√©s del ahorro anual es el mensual
                                const mensualP = nextP ? nextP.nextElementSibling : null;
                                if (mensualP && mensualP.tagName === 'P') {
                                    // Extraer solo el valor num√©rico, sin "al mes"
                                    let mensualText = mensualP.textContent.trim();
                                    // Eliminar "al mes" si existe
                                    mensualText = mensualText.replace(/\s*al mes\s*/gi, '').trim();
                                    ahorroMes = mensualText;
                                }
                            }
                        });
                    }
                    
                    // Construir HTML completo
                    const htmlContent = `
                        <!DOCTYPE html>
                        <html lang="zh">
                        <head>
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <title>DRK ËÉΩÊ∫ê - DUAL ÊØîËæÉÁªìÊûú</title>
                        </head>
                        <body style="font-family: Arial, sans-serif; background: #f1f5f9; margin: 0; padding: 20px;">
                            <!-- Encabezado -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${bannerColor}; border-radius: 12px; margin-bottom: 20px;">
                                <tr>
                                    <td style="padding: 30px; text-align: center;">
                                        <div style="font-size: 48px; margin-bottom: 10px;">‚ö°üî•</div>
                                        <h1 style="margin: 0; font-size: 36px; font-weight: 900; color: #ffffff;">COMPARATIVA GLOBAL</h1>
                                        <p style="margin: 10px 0 0 0; font-size: 18px; color: #ffffff; opacity: 0.95;">Â§öÈáç‰æõÂ∫îÁÆ°ÁêÜ / Multi-supply Management</p>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- T√≠tulo de secci√≥n -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background: white; border-radius: 12px; margin-bottom: 20px;">
                                <tr>
                                    <td style="padding: 20px;">
                                        <h2 style="margin: 0; font-size: 24px; color: #1e293b; font-weight: bold;">‰æõÂ∫îÊëòË¶Å</h2>
                                    </td>
                                </tr>
                            </table>
                            
                            ${suppliesHTML}
                            
                            <!-- Resumen de ahorro total -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${savingsColor}; border-radius: 12px; margin-top: 30px;">
                                <tr>
                                    <td style="padding: 30px; text-align: center;">
                                        <div style="font-size: 48px; margin-bottom: 10px;">üí∞</div>
                                        <h2 style="margin: 0 0 20px 0; font-size: 28px; color: white; font-weight: bold;">ÊÄªËäÇÁúÅ</h2>
                                        
                                        <table width="100%" cellpadding="0" cellspacing="0" style="max-width: 500px; margin: 0 auto;">
                                            <tr>
                                                <td style="padding: 10px; text-align: left; font-size: 16px; color: white; opacity: 0.9;">üìä ÂΩìÂâçË¥¶ÂçïÊÄªÈ¢ùÔºö</td>
                                                <td style="padding: 10px; text-align: right; font-size: 20px; color: white; font-weight: bold;">${totalOriginal}</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 10px; text-align: left; font-size: 16px; color: white; opacity: 0.9;">‰ΩøÁî® DRK ÊÇ®Â∞ÜÊîØ‰ªòÔºö</td>
                                                <td style="padding: 10px; text-align: right; font-size: 20px; color: white; font-weight: bold;">${totalNew}</td>
                                            </tr>
                                            <tr style="border-top: 2px solid rgba(255,255,255,0.3);">
                                                <td style="padding: 15px 10px; text-align: left; font-size: 18px; color: white;">üéâ Âπ¥Â∫¶ËäÇÁúÅÈáëÈ¢ùÔºö</td>
                                                <td style="padding: 15px 10px; text-align: right; font-size: 32px; color: white; font-weight: bold;">${totalAhorro}</td>
                                            </tr>
                                            <tr>
                                                <td colspan="2" style="padding: 10px; text-align: center; font-size: 18px; color: white; opacity: 0.95;">${ahorroMes} ÊØèÊúà</td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        </body>
                        </html>
                    `;
                    
                    // Copiar al portapapeles
                    const tempContainer = document.createElement('div');
                    tempContainer.style.position = 'fixed';
                    tempContainer.style.left = '-9999px';
                    tempContainer.innerHTML = htmlContent;
                    document.body.appendChild(tempContainer);
                    
                    const range = document.createRange();
                    range.selectNodeContents(tempContainer);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                    
                    try {
                        const successful = document.execCommand('copy');
                        console.log('üìã execCommand copy result:', successful);
                        if (successful) {
                            alert('‚úÖ ÊàêÂäüÔºÅHTMLÂ∑≤Â§çÂà∂Ôºà‰∏≠ÊñáÔºâ\n‚úÖ Success! HTML copied (Chinese)\n\nÁé∞Âú®ÂèØ‰ª•Á≤òË¥¥Âà∞OutlookÔºÅ\nNow you can paste into Outlook!');
                            console.log('‚úÖ HTML DUAL copiado con tablas desde DOM');
                        } else {
                            throw new Error('execCommand fall√≥');
                        }
                    } catch (err) {
                        console.error('Error en execCommand:', err);
                        alert('‚ùå Â§çÂà∂Â§±Ë¥• / Copy failed\n\nError: ' + err.message);
                    } finally {
                        selection.removeAllRanges();
                        document.body.removeChild(tempContainer);
                    }
                    return;
                }
                
                // Para otros idiomas, proceso normal
                const comercialCode = document.getElementById('comercial-code').value.trim();
                if (!comercialCode) {
                    alert('Por favor, introduce el c√≥digo comercial (obligatorio)');
                    document.getElementById('comercial-code').focus();
                    return;
                }
            
                const clientName = document.getElementById('client-name').value.trim() || tr('[NOMBRE COMPLETO CLIENTE]');
                const clientPhone = document.getElementById('client-phone').value.trim() || '';
                const clientEmail = document.getElementById('client-email').value.trim() || '';
                
                // Cerrar el modal
                closeClientDataModal();
                
                // Llamar a la funci√≥n que genera el HTML (igual que el PDF)
                const html = generateDualHTMLContent(comercialCode, clientName, clientPhone, clientEmail);
                
                if (!html) {
                    return; // Ya se mostr√≥ el error en generateDualHTMLContent
                }
                
                // NUEVO: Copiar como HTML renderizado (no como texto)
                // Crear un contenedor temporal invisible
                const tempContainer = document.createElement('div');
                tempContainer.style.position = 'fixed';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '0';
                tempContainer.innerHTML = html;
                document.body.appendChild(tempContainer);
                
                // Seleccionar todo el contenido del contenedor
                const range = document.createRange();
                range.selectNodeContents(tempContainer);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                
                // Intentar copiar
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        alert('‚úÖ HTML copiado correctamente!\n\nAhora puedes:\n1. Abrir tu correo (Gmail/Outlook)\n2. Hacer clic en "Redactar"\n3. Pegar (Ctrl+V o Cmd+V)\n\nSe pegar√° el dise√±o completo, no el c√≥digo.');
                        console.log('‚úÖ HTML renderizado copiado');
                    } else {
                        throw new Error('execCommand fall√≥');
                    }
                } catch (err) {
                    console.error('Error al copiar:', err);
                    alert('‚ùå No se pudo copiar autom√°ticamente.\n\nPor favor, usa el bot√≥n "CREAR PDF COMPARATIVO" en su lugar.');
                } finally {
                    // Limpiar: deseleccionar y eliminar el contenedor temporal
                    selection.removeAllRanges();
                    document.body.removeChild(tempContainer);
                }
            } catch (globalError) {
                console.error('‚ùå Error global en copyDualHTML:', globalError);
                console.error('Stack:', globalError.stack);
                alert('‚ùå Error al copiar HTML\n\n' + globalError.message + '\n\nËØ∑Êü•ÁúãÊéßÂà∂Âè∞Ëé∑ÂèñËØ¶ÁªÜ‰ø°ÊÅØ\nPlease check console for details');
            }
        }
        
        // Funci√≥n auxiliar para formatear euros en email
        function formatEuroEmail(value) {
            return (value || 0).toFixed(2).replace('.', ',') + ' ‚Ç¨';
        }
        
        // Funci√≥n auxiliar para generar mailto link
        function generateMailtoLink(comercialCode, clientName, clientPhone, clientEmail, supplies, results, isPowerCup, brandName, totalSavings, totalOriginalBill, totalNew) {
            const recipients = 'f.araujo@drk.es;rguerra@drk.es;s.caballero@drk.es';
            const subject = `‚úÖ CONFIRMACI√ìN - DUAL ${brandName} - ${clientName}`;
            
            let emailBody = `‚úÖ CONFIRMACI√ìN DE ACEPTACI√ìN DE OFERTA DUAL

Estimado equipo de DRK,

Confirmo mi aceptaci√≥n de la oferta energ√©tica DUAL que detallo a continuaci√≥n:

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìã RESUMEN GENERAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üíº Comercial: ${comercialCode}
üéØ Modalidad: DUAL (Electricidad + Gas)
üìä Marca: ${brandName}
üìÖ Total Suministros: ${supplies.length}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üí∞ BENEFICIO ECON√ìMICO TOTAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üíµ Factura Actual Total: ${formatEuroEmail(totalOriginalBill)}/a√±o
üíö Con ${brandName} Total: ${formatEuroEmail(totalNew)}/a√±o
üéâ Ahorro Anual Total: ${formatEuroEmail(totalSavings)}
üìÖ Ahorro Mensual: ${formatEuroEmail(totalSavings / 12)}/mes

`;

            supplies.forEach((supply, index) => {
                const isElec = supply.type === 'electricidad';
                const emoji = isElec ? '‚ö°' : 'üî•';
                const tipo = isElec ? 'ELECTRICIDAD' : 'GAS';
                const currentCost = isPowerCup ? (supply.results.powercup?.total_anual || 0) : (supply.results.drk?.total_anual || 0);
                const ahorro = Math.max(0, (supply.originalBillAnnual || 0) - currentCost); // Mostrar 0 si negativo
                
                // Construir nombre completo de tarifa: COMERCIALIZADORA - TARIFA
                const comercializadora = supply.offer?.name || '';
                const tarifa = supply.offer?.description || '';
                const tarifaCompleta = (comercializadora && tarifa && comercializadora !== tarifa) 
                    ? `${comercializadora} - ${tarifa}` 
                    : (tarifa || comercializadora || 'N/A');
                
                emailBody += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
${emoji} SUMINISTRO ${index + 1}: ${tipo}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üîå CUPS: ${supply.cups}
‚ö° TARIFA CONTRATADA: ${tarifaCompleta}

üí∞ Ahorro Anual: ${formatEuroEmail(ahorro)}
üìÖ Coste Mensual: ${formatEuroEmail(currentCost / 12)}

`;
            });

            emailBody += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üë§ DATOS DEL TITULAR
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìõ Nombre: ${clientName}
üì± Tel√©fono: ${clientPhone}
üìß Email: ${clientEmail}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìé DOCUMENTACI√ìN ADJUNTA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

‚úì 1. Foto DNI/CIF (anverso y reverso)
‚úì 2. √öltimas facturas (m√≠n. 3 meses)
‚úì 3. Autorizaci√≥n cambio titular (si aplica)
‚úì 4. Tel√©fono de contacto
‚úì 5. IBAN

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Atentamente,
${clientName}
`;

            return `mailto:${recipients}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
        }
        
        // Funci√≥n auxiliar: Generar HTML DUAL (usada por PDF y copiar HTML)
        function generateDualHTMLContent(comercialCode, clientName, clientPhone = '', clientEmail = '') {
            console.log('üìÑ Generando HTML DUAL con datos capturados:');
            console.log('  - comercialCode:', comercialCode);
            console.log('  - clientName:', clientName);
            
            if (!dualSupplies || dualSupplies.length === 0) {
                alert('No hay suministros para generar la propuesta.');
                return null;
            }
            
            const results = window.dualGlobalResults;
            if (!results) {
                alert('Calcula la comparativa primero.');
                return null;
            }
            
            const isPowerCup = results.comparisonMode === 'overall_best';
            const brandName = isPowerCup ? 'POWER CUP' : 'DRK';
            const primaryColor = isPowerCup ? '#4d7c0f' : '#546e7a';
            const accentColor = isPowerCup ? '#84cc16' : '#607d8b';
            const bannerColor = isPowerCup ? '#84cc16' : '#0ea5e9'; // Verde Power Cup o Azul DRK
            
            // CAMBIO: Mostrar TODOS los suministros, no filtrar
            // Usar s.totalAnnual que ya tiene la l√≥gica correcta
            let totalOriginalBill = 0;
            let totalNew = 0;
            
            dualSupplies.forEach(s => {
                const currentCost = s.totalAnnual || 0; // Usar s.totalAnnual directamente
                totalOriginalBill += s.originalBillAnnual || 0;
                totalNew += currentCost;
            });
            
            const totalSavings = Math.max(0, totalOriginalBill - totalNew); // M√°ximo 0
            
            console.log('üìä Suministros en documento:', dualSupplies.length);
            console.log('üí∞ Ahorro total:', totalSavings.toFixed(2), '‚Ç¨');
            
            const eur = n => new Intl.NumberFormat('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(n || 0) + ' ‚Ç¨';
            
            // Generar desgloses detallados (USAR dualSupplies - TODOS)
            const desgloses = dualSupplies.map((s, i) => {
                // Construir nombre completo de tarifa: COMERCIALIZADORA - TARIFA
                const comercializadora = s.offer?.name || '';
                const tarifa = s.offer?.description || '';
                const tarifaCompleta = (comercializadora && tarifa && comercializadora !== tarifa) 
                    ? `${comercializadora} - ${tarifa}` 
                    : (tarifa || comercializadora || 'N/A');
                
                if (s.type === 'electricidad' && s.electricityBreakdown) {
                    const eb = s.electricityBreakdown;
                    return `
                        <div style="margin-bottom:20px">
                            <div style="background:${accentColor};color:white;padding:12px 20px;border-radius:8px 8px 0 0;font-weight:bold;font-size:13px">
                                [${i+1}] ${(s.cups||'N/A').substring(0,30)}...
                                <div style="font-size:11px;opacity:0.9;margin-top:3px">${tr('Tipo:')}: ${s.tariff} | ${tr('D√≠as:')}: ${eb.dias} ${tr('d√≠as')} | CUPS: [${i+1}]</div>
                                <div style="font-size:11px;opacity:0.95;margin-top:5px;background:rgba(0,0,0,0.15);padding:6px 10px;border-radius:4px">
                                    <strong>${tr('TARIFA:')}</strong> ${tarifaCompleta}
                                </div>
                            </div>
                            <div style="background:#f8fafc;padding:15px 20px;border:1px solid #e2e8f0;border-top:none">
                                <div style="margin-bottom:12px">
                                    <div style="font-weight:bold;color:${accentColor};margin-bottom:5px;font-size:12px">${tr('PRECIOS APLICADOS:')}</div>
                                    <div style="font-size:11px;color:#64748b">
                                        <strong>${tr('POTENCIA:')}</strong><br>
                                        ${s.offer ? [
                                            s.offer.p1_power_price ? `P1: ${s.offer.p1_power_price.toFixed(6)} ‚Ç¨/kW/d√≠a` : null,
                                            s.offer.p2_power_price ? `P2: ${s.offer.p2_power_price.toFixed(6)} ‚Ç¨/kW/d√≠a` : null
                                        ].filter(Boolean).join('<br>') : 'N/A'}
                                    </div>
                                    <div style="font-size:11px;color:#64748b;margin-top:8px">
                                        <strong>${tr('ENERG√çA:')}</strong><br>
                                        ${s.offer ? [
                                            s.offer.p1_price ? `E1: ${s.offer.p1_price.toFixed(6)} ‚Ç¨/kWh` : null,
                                            s.offer.p2_price ? `E2: ${s.offer.p2_price.toFixed(6)} ‚Ç¨/kWh` : null,
                                            s.offer.p3_price ? `E3: ${s.offer.p3_price.toFixed(6)} ‚Ç¨/kWh` : null,
                                            s.offer.p4_price ? `E4: ${s.offer.p4_price.toFixed(6)} ‚Ç¨/kWh` : null,
                                            s.offer.p5_price ? `E5: ${s.offer.p5_price.toFixed(6)} ‚Ç¨/kWh` : null,
                                            s.offer.p6_price ? `E6: ${s.offer.p6_price.toFixed(6)} ‚Ç¨/kWh` : null
                                        ].filter(Boolean).join('<br>') : 'N/A'}
                                    </div>
                                </div>
                                
                                <div style="background:${accentColor};color:white;padding:8px 12px;margin:10px 0;border-radius:4px;font-size:12px;font-weight:bold">${tr('POTENCIA')}</div>
                                ${(eb.powerCosts||[]).map((pc, idx) => {
                                    const priceKey = idx === 0 ? 'p1_power_price' : 'p2_power_price';
                                    const precio = s.offer?.[priceKey] || pc.priceDay || pc.price_euro_kw_day || 0;
                                    return `
                                    <div style="display:flex;justify-content:space-between;padding:5px 0;font-size:11px">
                                        <span>P${pc.period||'?'} (${pc.power_kw||0} kW x ${eb.dias} x ${precio.toFixed(6)})</span>
                                        <span style="font-weight:bold">${(pc.cost_euros||0).toFixed(2)} ‚Ç¨</span>
                                    </div>
                                `;}).join('')}
                                
                                <div style="background:${accentColor};color:white;padding:8px 12px;margin:10px 0;border-radius:4px;font-size:12px;font-weight:bold">${tr('ENERG√çA')}</div>
                                ${(eb.energyCosts||[]).map((ec, idx) => {
                                    const priceKey = `p${idx+1}_price`;
                                    const precio = s.offer?.[priceKey] || ec.price || ec.price_euro_kwh || 0;
                                    return `
                                    <div style="display:flex;justify-content:space-between;padding:5px 0;font-size:11px">
                                        <span>E${ec.period||'?'} (${ec.kwh||0} kWh x ${precio.toFixed(6)})</span>
                                        <span style="font-weight:bold">${(ec.cost_euros||0).toFixed(2)} ‚Ç¨</span>
                                    </div>
                                `;}).join('')}
                                
                                <div style="background:#e2e8f0;padding:10px;margin-top:10px;border-radius:4px;display:flex;justify-content:space-between;font-weight:bold">
                                    <span>${tr('TOTAL')} (${eb.dias} ${tr('D√çAS')})</span>
                                    <span>${(eb.totalPeriod||0).toFixed(2)} ‚Ç¨</span>
                                </div>
                                
                                <div style="background:#ef4444;color:white;padding:10px;margin-top:10px;border-radius:4px;text-align:center;font-weight:bold">
                                    ${tr('AHORRO:')}: ${(eb.ahorro_anual||0).toFixed(2)} ‚Ç¨
                                </div>
                            </div>
                        </div>
                    `;
                } else if (s.type === 'gas' && s.gasBreakdown) {
                    const gb = s.gasBreakdown;
                    return `
                        <div style="margin-bottom:20px">
                            <div style="background:${accentColor};color:white;padding:12px 20px;border-radius:8px 8px 0 0;font-weight:bold;font-size:13px">
                                [${i+1}] ${(s.cups||'N/A').substring(0,30)}...
                                <div style="font-size:11px;opacity:0.9;margin-top:3px">${tr('Tipo:')}: ${s.tariff} | ${tr('D√≠as:')}: ${gb.dias} ${tr('d√≠as')} | CUPS: [${i+1}]</div>
                                <div style="font-size:11px;opacity:0.95;margin-top:5px;background:rgba(0,0,0,0.15);padding:6px 10px;border-radius:4px">
                                    <strong>${tr('TARIFA:')}</strong> ${tarifaCompleta}
                                </div>
                            </div>
                            <div style="background:#f8fafc;padding:15px 20px;border:1px solid #e2e8f0;border-top:none">
                                <div style="margin-bottom:12px">
                                    <div style="font-weight:bold;color:${accentColor};margin-bottom:5px;font-size:12px">${tr('PRECIOS APLICADOS:')}</div>
                                    <div style="font-size:11px;color:#64748b">
                                        ${tr('T√©rmino fijo:')}: ${(s.offer?.p_fijo_diario||0).toFixed(6)} ‚Ç¨/d√≠a<br>
                                        ${tr('Energ√≠a:')}: ${(s.offer?.p1_price||0).toFixed(6)} ‚Ç¨/kWh
                                    </div>
                                </div>
                                
                                <div style="background:${accentColor};color:white;padding:8px 12px;margin:10px 0;border-radius:4px;font-size:12px;font-weight:bold">${tr('DESGLOSE GAS')}</div>
                                <div style="display:flex;justify-content:space-between;padding:5px 0;font-size:11px">
                                    <span>${tr('T√©rmino fijo')} (${gb.dias} ${tr('d√≠as')})</span>
                                    <span style="font-weight:bold">${(gb.termino_fijo||0).toFixed(2)} ‚Ç¨</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;padding:5px 0;font-size:11px">
                                    <span>${tr('Energ√≠a')} (${gb.kwh||0} kWh)</span>
                                    <span style="font-weight:bold">${(gb.energia||0).toFixed(2)} ‚Ç¨</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;padding:5px 0;font-size:11px">
                                    <span>${tr('Impuesto hidrocarburos')}</span>
                                    <span style="font-weight:bold">${(gb.impuesto_hidrocarburos||0).toFixed(2)} ‚Ç¨</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;padding:5px 0;font-size:11px">
                                    <span>${tr('Subtotal')}</span>
                                    <span style="font-weight:bold">${(gb.subtotal||0).toFixed(2)} ‚Ç¨</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;padding:5px 0;font-size:11px">
                                    <span>IVA (21%)</span>
                                    <span style="font-weight:bold">${(gb.iva||0).toFixed(2)} ‚Ç¨</span>
                                </div>
                                
                                <div style="background:#e2e8f0;padding:10px;margin-top:10px;border-radius:4px;display:flex;justify-content:space-between;font-weight:bold">
                                    <span>${tr('TOTAL')} (${gb.dias} ${tr('D√çAS')})</span>
                                    <span>${(gb.total||0).toFixed(2)} ‚Ç¨</span>
                                </div>
                                
                                <div style="background:#ef4444;color:white;padding:10px;margin-top:10px;border-radius:4px;text-align:center;font-weight:bold">
                                    ${tr('AHORRO:')}: ${(gb.ahorro_anual||0).toFixed(2)} ‚Ç¨
                                </div>
                            </div>
                        </div>
                    `;
                }
                return '';
            }).join('');
            
            const html = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Propuesta ${brandName}</title>
</head>
<body style="margin:0;padding:0;font-family:Arial,sans-serif;background-color:#f5f5f5">
    <div style="max-width:600px;margin:0 auto;background:white">
        
        <!-- BANNER SUPERIOR MEJORADO -->
        <table width="100%" cellpadding="0" cellspacing="0" style="background:${bannerColor}">
            <tr>
                <td style="padding:25px 30px;vertical-align:middle;width:60%">
                    <h1 style="margin:0 0 8px 0;font-size:32px;font-weight:900;color:white;letter-spacing:1px">${brandName} ${tr('ENERG√çA')}</h1>
                    <p style="margin:0;font-size:13px;color:white;opacity:0.95;line-height:1.4">${tr('Liderando el ahorro y la eficiencia energ√©tica.')}</p>
                </td>
                <td style="padding:25px 30px;text-align:right;vertical-align:middle;width:40%">
                    <p style="margin:0 0 5px 0;font-size:12px;color:white;font-weight:600;letter-spacing:0.5px">${tr('ESTUDIO DE AHORRO')}</p>
                    <p style="margin:0;font-size:15px;font-weight:bold;color:white;letter-spacing:1px">${tr('COMPARATIVA PROFESIONAL')}</p>
                </td>
            </tr>
        </table>
        
        <!-- T√çTULO ESTUDIO DE AHORRO -->
        <div style="background:${bannerColor};padding:20px 30px;text-align:center;border-top:2px solid rgba(255,255,255,0.2)">
            <h2 style="margin:0 0 5px 0;font-size:24px;font-weight:bold;color:white;letter-spacing:1.5px">${tr('ESTUDIO DE AHORRO')}</h2>
            <p style="margin:0;font-size:13px;color:white;font-weight:600;letter-spacing:0.5px">${tr('COMPARATIVA PROFESIONAL')} - ${brandName}</p>
        </div>
        
        <!-- DATOS CLIENTE -->
        <div style="padding:15px 30px;background:#f8f9fa">
            <p style="margin:0 0 5px 0;font-size:11px;color:#1e293b"><strong>${tr("CLIENTE:")}</strong> ${clientName}</p>
            <p style="margin:0 0 5px 0;font-size:11px;color:#1e293b"><strong>${tr("CUPS:")}</strong> ${dualSupplies[0].cups}</p>
            <p style="margin:0;font-size:11px;color:#1e293b"><strong>${tr("COMERCIAL:")}</strong> ${comercialCode}</p>
        </div>
        
        <!-- LA MEJOR OPCI√ìN -->
        <div style="padding:15px 30px;background:white;text-align:center">
            <p style="margin:0 0 5px 0;font-size:11px;color:#546e7a;font-weight:600;letter-spacing:0.5px">${tr("LA MEJOR OPCI√ìN PARA TI ES")}</p>
            <p style="margin:0;font-size:18px;color:#546e7a;font-weight:bold;letter-spacing:1px">${brandName}</p>
        </div>
        
        <!-- RESUMEN TABLA -->
        <div style="margin:25px 30px;padding:20px;background:white;border:3px solid #e5e7eb;border-radius:10px">
            <p style="margin:0 0 15px 0;font-size:14px;color:#1e293b;font-weight:bold;text-align:center;text-transform:uppercase">${tr("RESUMEN DE SUMINISTROS INCLUIDOS")}</p>
            <table width="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse">
                <thead>
                    <tr style="background:#f1f5f9">
                        <th style="padding:10px 8px;font-size:10px;color:#475569;text-align:left;border-bottom:2px solid #cbd5e1">#</th>
                        <th style="padding:10px 8px;font-size:10px;color:#475569;text-align:left;border-bottom:2px solid #cbd5e1">CUPS</th>
                        <th style="padding:10px 8px;font-size:10px;color:#475569;text-align:center;border-bottom:2px solid #cbd5e1">${tr('Tipo')}</th>
                        <th style="padding:10px 8px;font-size:10px;color:#475569;text-align:center;border-bottom:2px solid #cbd5e1">${tr('Tarifa')}</th>
                        <th style="padding:10px 8px;font-size:10px;color:#475569;text-align:right;border-bottom:2px solid #cbd5e1">${tr('Ahorro Anual')}</th>
                    </tr>
                </thead>
                <tbody>
                ${dualSupplies.map((s, i) => {
                    const ahorro = Math.max(0, (s.originalBillAnnual||0) - (s.totalAnnual||0)); // Mostrar 0 si es negativo
                    const emoji = s.type === 'electricidad' ? '‚ö°' : 'üî•';
                    const tipo = s.type === 'electricidad' ? tr('Electricidad') : tr('Gas');
                    return `
                    <tr style="border-bottom:1px solid #f1f5f9">
                        <td style="padding:12px 8px;font-size:11px;color:#1e293b;font-weight:bold">${i+1}</td>
                        <td style="padding:12px 8px;font-size:9px;color:#64748b">${s.cups.substring(0,17)}...</td>
                        <td style="padding:12px 8px;font-size:10px;color:#1e293b;text-align:center">${emoji} ${tipo}</td>
                        <td style="padding:12px 8px;font-size:11px;color:#1e293b;text-align:center;font-weight:bold">${s.tariff}</td>
                        <td style="padding:12px 8px;font-size:12px;color:${ahorro > 0 ? '#22c55e' : '#9ca3af'};text-align:right;font-weight:bold">${ahorro.toFixed(2)} ‚Ç¨</td>
                    </tr>
                    `;
                }).join('')}
                </tbody>
                <tfoot>
                    <tr style="background:#f1f5f9">
                        <td colspan="4" style="padding:15px 8px;font-size:13px;color:#1e293b;text-align:right;font-weight:bold;border-top:3px solid #cbd5e1">${tr('TOTAL AHORRO:')}</td>
                        <td style="padding:15px 8px;font-size:14px;color:#22c55e;text-align:right;font-weight:bold;border-top:3px solid #cbd5e1">${totalSavings.toFixed(2)} ‚Ç¨</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <!-- AHORRO ANUAL - DISE√ëO LIMPIO -->
        <div style="padding:50px 30px 20px 30px;margin:20px 0;background:#ffffff;text-align:center">
            <p style="margin:0 0 20px 0;font-size:13px;color:#9ca3af;font-weight:600;text-transform:uppercase;letter-spacing:1px">${totalSavings > 0 ? tr('TU AHORRO ANUAL ESTIMADO') : tr('RESULTADO DE LA COMPARATIVA')}</p>
            <p style="margin:0;font-size:52px;color:${totalSavings > 0 ? '#22c55e' : '#9ca3af'};font-weight:600;letter-spacing:-1px">${totalSavings.toFixed(2)} ‚Ç¨</p>
            ${totalSavings === 0 ? `<p style="margin:10px 0 0 0;font-size:14px;color:#9ca3af;">${tr('Sin ahorro conseguido')}</p>` : ''}
        </div>
        
        <!-- TABLA COMPARATIVA - DISE√ëO LIMPIO -->
        <div style="padding:30px 30px 40px 30px;margin:0;background:#ffffff;border-top:1px solid #f3f4f6">
            <table width="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse">
                <tr>
                    <!-- TU FACTURA ACTUAL -->
                    <td style="width:45%;padding:0;text-align:center;vertical-align:top">
                        <p style="margin:0 0 15px 0;font-size:11px;color:#9ca3af;font-weight:600;text-transform:uppercase;letter-spacing:0.5px">${tr("TU FACTURA ACTUAL")}</p>
                        <p style="margin:0;font-size:24px;color:#dc2626;font-weight:normal;text-decoration:line-through">${(totalOriginalBill/12).toFixed(2)} ${tr('‚Ç¨/mes')}</p>
                        <p style="margin:8px 0 0 0;font-size:10px;color:#cbd5e1">${tr("Total Periodo")} (31 ${tr('d√≠as')})</p>
                        <p style="margin:20px 0 0 0;font-size:24px;color:#dc2626;font-weight:normal;text-decoration:line-through">${totalOriginalBill.toFixed(2)} ${tr('‚Ç¨/a√±o')}</p>
                    </td>
                    
                    <!-- SEPARADOR VERTICAL -->
                    <td style="width:10%;padding:0;text-align:center">
                        <div style="width:1px;height:150px;background:#e5e7eb;margin:0 auto"></div>
                    </td>
                    
                    <!-- TU NUEVO COSTE -->
                    <td style="width:45%;padding:0;text-align:center;vertical-align:top">
                        <p style="margin:0 0 15px 0;font-size:11px;color:#9ca3af;font-weight:600;text-transform:uppercase;letter-spacing:0.5px">${tr('TU NUEVO COSTE')} ${brandName}</p>
                        <p style="margin:0;font-size:28px;color:#475569;font-weight:500">${(totalNew/12).toFixed(2)} ${tr('‚Ç¨/mes')}</p>
                        <p style="margin:8px 0 0 0;font-size:10px;color:#cbd5e1">${tr("Estimado Mensual")}</p>
                        <p style="margin:20px 0 0 0;font-size:28px;color:#475569;font-weight:500">${totalNew.toFixed(2)} ${tr('‚Ç¨/a√±o')}</p>
                    </td>
                </tr>
            </table>
        </div>
        
        <!-- BANDA VERDE DESGLOSE -->
        <div style="background:#22c55e;padding:10px 30px">
            <p style="margin:0;font-size:12px;color:white;font-weight:bold;text-transform:uppercase">${tr('DESGLOSE DETALLADO POR SUMINISTRO')}</p>
        </div>
        
        <!-- DESGLOSES -->
        <div style="padding:0">
            ${dualSupplies.map((s, i) => {
                const eb = s.electricityBreakdown;
                const gb = s.gasBreakdown;
                const isElec = s.type === 'electricidad';
                const dias = isElec ? eb?.dias : gb?.dias || 30;
                const totalPeriod = isElec ? eb?.totalPeriod : gb?.total || 0;
                const ahorroAnual = Math.max(0, (s.originalBillAnnual || 0) - (s.totalAnnual || 0)); // Mostrar 0 si negativo
                
                // Construir nombre completo de tarifa: COMERCIALIZADORA - TARIFA
                const comercializadora = s.offer?.name || '';
                const tarifa = s.offer?.description || '';
                const tarifaCompleta = (comercializadora && tarifa && comercializadora !== tarifa) 
                    ? `${comercializadora} - ${tarifa}` 
                    : (tarifa || comercializadora || 'N/A');
                
                return `
                <div style="margin:15px 30px;background:${primaryColor};padding:12px;border-radius:5px">
                    <p style="margin:0 0 5px 0;font-size:11px;color:white;font-weight:bold">[${i+1}] ${s.cups.substring(0,25)}...</p>
                    <p style="margin:0;font-size:10px;color:white">${tr('Tipo:')}: ${s.tariff} | ${tr('D√≠as:')}: ${dias} ${tr('d√≠as')} | CUPS: [${i+1}]</p>
                    <p style="margin:5px 0 0 0;font-size:10px;color:white"><strong>${tr('TARIFA:')}</strong> ${tarifaCompleta}</p>
                </div>
                
                <div style="margin:0 30px 15px 30px;padding:15px;background:#f8f9fa;border:1px solid #e2e8f0">
                    <p style="margin:0 0 8px 0;font-size:11px;color:#1e293b;font-weight:bold">${tr('PRECIOS APLICADOS:')}</p>
                    
                    ${isElec ? `
                    <p style="margin:0 0 3px 0;font-size:10px;color:#64748b"><strong>${tr('POTENCIA:')}</strong></p>
                    ${s.offer?.p1_power_price ? `<p style="margin:0 0 2px 0;font-size:9px;color:#64748b">P1: ${s.offer.p1_power_price.toFixed(6)} ‚Ç¨/kW/d√≠a</p>` : ''}
                    ${s.offer?.p2_power_price ? `<p style="margin:0 0 2px 0;font-size:9px;color:#64748b">P2: ${s.offer.p2_power_price.toFixed(6)} ‚Ç¨/kW/d√≠a</p>` : ''}
                    
                    <p style="margin:8px 0 3px 0;font-size:10px;color:#64748b"><strong>${tr('ENERG√çA:')}</strong></p>
                    ${s.offer?.p1_price ? `<p style="margin:0 0 2px 0;font-size:9px;color:#64748b">E1: ${s.offer.p1_price.toFixed(6)} ‚Ç¨/kWh</p>` : ''}
                    ${s.offer?.p2_price ? `<p style="margin:0 0 2px 0;font-size:9px;color:#64748b">E2: ${s.offer.p2_price.toFixed(6)} ‚Ç¨/kWh</p>` : ''}
                    ${s.offer?.p3_price ? `<p style="margin:0 0 2px 0;font-size:9px;color:#64748b">E3: ${s.offer.p3_price.toFixed(6)} ‚Ç¨/kWh</p>` : ''}
                    ` : `
                    <p style="margin:0 0 2px 0;font-size:9px;color:#64748b">${tr('T√©rmino fijo:')}: ${(s.offer?.p_fijo_diario||0).toFixed(6)} ‚Ç¨/d√≠a</p>
                    <p style="margin:0 0 2px 0;font-size:9px;color:#64748b">${tr('Energ√≠a:')}: ${(s.offer?.p1_price||0).toFixed(6)} ‚Ç¨/kWh</p>
                    `}
                    
                    ${isElec ? `
                    <!-- ELECTRICIDAD: POTENCIA -->
                    <div style="margin-top:12px;padding:10px;background:${primaryColor};color:white;border-radius:5px">
                        <p style="margin:0;font-size:11px;font-weight:bold">${tr('POTENCIA')}</p>
                    </div>
                    ${eb?.powerCosts ? eb.powerCosts.map(pc => `
                        <div style="padding:8px 10px;background:white;border-bottom:1px solid #e2e8f0">
                            <div style="display:table;width:100%">
                                <div style="display:table-cell;font-size:10px;color:#1e293b">P${pc.period} (${pc.kw||0} kW x ${dias}d x ${(pc.priceDay||0).toFixed(6)} ‚Ç¨/kW/d√≠a)</div>
                                <div style="display:table-cell;text-align:right;font-size:10px;color:#1e293b;font-weight:bold">${(pc.cost||0).toFixed(2)} ‚Ç¨</div>
                            </div>
                        </div>
                    `).join('') : `<div style="padding:8px 10px;background:white;font-size:10px;color:#64748b">${tr('No hay datos de potencia')}</div>`}
                    
                    <!-- ELECTRICIDAD: ENERG√çA -->
                    <div style="margin-top:12px;padding:10px;background:${primaryColor};color:white;border-radius:5px">
                        <p style="margin:0;font-size:11px;font-weight:bold">${tr('ENERG√çA')}</p>
                    </div>
                    ${eb?.energyCosts ? eb.energyCosts.map(ec => `
                        <div style="padding:8px 10px;background:white;border-bottom:1px solid #e2e8f0">
                            <div style="display:table;width:100%">
                                <div style="display:table-cell;font-size:10px;color:#1e293b">E${ec.period} (${ec.kwh||0} kWh x ${(ec.price||0).toFixed(6)} ‚Ç¨/kWh)</div>
                                <div style="display:table-cell;text-align:right;font-size:10px;color:#1e293b;font-weight:bold">${(ec.cost||0).toFixed(2)} ‚Ç¨</div>
                            </div>
                        </div>
                    `).join('') : `<div style="padding:8px 10px;background:white;font-size:10px;color:#64748b">${tr('No hay datos de energ√≠a')}</div>`}
                    ` : `
                    <!-- GAS: DESGLOSE (sin secci√≥n POTENCIA) -->
                    <div style="margin-top:12px;padding:10px;background:${primaryColor};color:white;border-radius:5px">
                        <p style="margin:0;font-size:11px;font-weight:bold">${tr('DESGLOSE DE COSTES')}</p>
                    </div>
                    ${gb ? `
                        <div style="padding:8px 10px;background:white;border-bottom:1px solid #e2e8f0">
                            <div style="display:table;width:100%">
                                <div style="display:table-cell;font-size:10px;color:#1e293b">${tr('T√©rmino fijo')} (${dias} ${tr('d√≠as')} x ${(gb.termino_fijo_diario||0).toFixed(6)} ‚Ç¨/d√≠a)</div>
                                <div style="display:table-cell;text-align:right;font-size:10px;color:#1e293b;font-weight:bold">${(gb.termino_fijo||0).toFixed(2)} ‚Ç¨</div>
                            </div>
                        </div>
                        <div style="padding:8px 10px;background:white;border-bottom:1px solid #e2e8f0">
                            <div style="display:table;width:100%">
                                <div style="display:table-cell;font-size:10px;color:#1e293b">${tr('Energ√≠a')} (${gb.kwh||0} kWh x ${(s.offer?.p1_price||0).toFixed(6)} ‚Ç¨/kWh)</div>
                                <div style="display:table-cell;text-align:right;font-size:10px;color:#1e293b;font-weight:bold">${(gb.energia||0).toFixed(2)} ‚Ç¨</div>
                            </div>
                        </div>
                    ` : `<div style="padding:8px 10px;background:white;font-size:10px;color:#64748b">${tr('No hay datos')}</div>`}
                    `}
                    
                    <div style="margin-top:12px;padding:10px;background:#e2e8f0">
                        <div style="display:table;width:100%">
                            <div style="display:table-cell;font-size:11px;color:#1e293b;font-weight:bold">${tr('TOTAL')} (${dias} ${tr('D√çAS')}):</div>
                            <div style="display:table-cell;text-align:right;font-size:11px;color:#1e293b;font-weight:bold">${totalPeriod.toFixed(2)} ‚Ç¨</div>
                        </div>
                    </div>
                    
                    <div style="margin-top:8px;padding:12px;background:#ef4444;text-align:center;border-radius:5px">
                        <p style="margin:0;font-size:12px;color:white;font-weight:bold">${tr('AHORRO:')}: ${ahorroAnual.toFixed(2)} ‚Ç¨</p>
                    </div>
                </div>
                `;
            }).join('')}
        </div>
        
        <!-- AHORRO FINAL EN ROJO -->
        <div style="margin:25px 30px 30px 30px;padding:30px;background:${primaryColor};border-radius:10px;text-align:center">
            <p style="margin:0 0 15px 0;font-size:15px;color:white;font-weight:bold;text-transform:uppercase;letter-spacing:1px">üéâ ${tr('TU AHORRO ANUAL TOTAL')} üéâ</p>
            <p style="margin:0 0 15px 0;font-size:48px;color:white;font-weight:bold">${eur(totalSavings)}</p>
            <p style="margin:0;font-size:15px;color:white;font-weight:bold;text-transform:uppercase">${tr('¬°AHORRA')} ${(totalSavings/12).toFixed(2).replace('.', ',')} ‚Ç¨ ${tr('CADA MES!')} </p>
        </div>
        
        <!-- FOOTER INSTRUCCIONES -->
        <div style="background:${primaryColor};padding:20px 30px;margin-top:20px">
            <p style="margin:0 0 10px 0;font-size:11px;color:white;font-weight:bold">${tr('PARA FORMALIZAR ESTE CONTRATO:')}</p>
            <p style="margin:0 0 8px 0;font-size:10px;color:white">${tr('Responde a este email adjuntando la documentaci√≥n de los')} ${dualSupplies.length} CUPS:</p>
            <ol style="margin:0;padding-left:20px;font-size:10px;color:white;line-height:1.6">
                <li>${tr('Foto del DNI/CIF (anverso y reverso)')}</li>
                <li>${tr('√öltima factura (menos de 3 meses de antig√ºedad)')}</li>
                <li>${tr('Autorizaci√≥n de cambio de titular (si aplica)')}</li>
                <li>${tr('Tel√©fono de contacto')}</li>
                <li>${tr('N√∫mero de cuenta bancaria (IBAN)')}</li>
            </ol>
            <div style="margin-top:12px;padding:10px;background:rgba(255,255,255,0.2);border-radius:4px;text-align:center">
                <p style="margin:0;font-size:10px;color:white">${tr('Env√≠a la documentaci√≥n al comercial:')}<strong>${comercialCode}</strong></p>
            </div>
        </div>
        
        <!-- BOT√ìN CONFIRMAR Y ENVIAR -->
        <div style="background:#ffffff;padding:30px;margin:30px;border-radius:8px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.1)">
            <p style="margin:0 0 20px 0;font-size:18px;color:#1e293b;font-weight:bold">${tr('üìã Para confirmar esta oferta:')}</p>
            <p style="margin:0 0 10px 0;font-size:14px;color:#64748b">${tr('Haz clic en el bot√≥n de abajo')}</p>
            <p style="margin:0 0 20px 0;font-size:14px;color:#64748b">${tr('Se abrir√° tu cliente de email')}</p>
            <p style="margin:0 0 20px 0;font-size:14px;color:#64748b;font-weight:bold">${tr('Adjunta la documentaci√≥n requerida')}</p>
            <p style="margin:0 0 25px 0;font-size:14px;color:#64748b">${tr('Env√≠a el email')}</p>
            
            <a href="${generateMailtoLink(comercialCode, clientName, clientPhone, clientEmail, dualSupplies, results, isPowerCup, brandName, totalSavings, totalOriginalBill, totalNew)}" 
               style="display:inline-block;background:#22c55e;color:white;text-decoration:none;padding:16px 40px;border-radius:8px;font-size:16px;font-weight:bold;box-shadow:0 4px 6px rgba(34,197,94,0.3)">
                ${tr('‚úÖ CONFIRMAR Y ENVIAR')}
            </a>
        </div>
        
    </div>
</body>
</html>`;
            
            return html;
        }
        
        // Funci√≥n: Generar PDF con datos capturados
        function generateDualPDF() {
            const comercialCode = document.getElementById('comercial-code').value.trim();
            if (!comercialCode) {
                alert('Por favor, introduce el c√≥digo comercial (obligatorio)');
                document.getElementById('comercial-code').focus();
                return;
            }
            
            const clientName = document.getElementById('client-name').value.trim() || tr('[NOMBRE COMPLETO CLIENTE]');
            const clientPhone = document.getElementById('client-phone').value.trim() || '';
            const clientEmail = document.getElementById('client-email').value.trim() || '';
            
            // Cerrar el modal
            closeClientDataModal();
            
            // Generar PDF
            dualGeneratePDF(comercialCode, clientName, clientPhone, clientEmail);
        }
        
        // Funci√≥n: Generar PDF DUAL
        function dualGeneratePDF(comercialCode = 'D=00', clientName = '', clientPhone = '', clientEmail = '') {
            // Si clientName est√° vac√≠o, usar el placeholder traducido
            if (!clientName) {
                clientName = tr('[NOMBRE COMPLETO CLIENTE]');
            }
            console.log('üìÑ Generando PDF DUAL con datos capturados:');
            console.log('  - comercialCode:', comercialCode);
            console.log('  - clientName:', clientName);
            
            // Detectar si est√° en modo chino
            const currentLang = localStorage.getItem('appLanguage') || 'es';
            const wasChineseMode = currentLang === 'zh';
            
            // Si est√° en chino, mostrar mensaje y cambiar temporalmente a ingl√©s
            if (wasChineseMode) {
                console.log('üá®üá≥ Idioma chino detectado en DUAL - cambiando a ingl√©s para PDF');
                // Informar al usuario en chino e ingl√©s
                alert('üá®üá≥ ÁîüÊàêPDFÊñá‰ª∂‰∏≠...\n‰∏∫‰∫ÜÁ°Æ‰øùÂ≠óÁ¨¶Ê≠£Á°ÆÊòæÁ§∫ÔºåPDFÂ∞Ü‰ΩøÁî®Ëã±ËØ≠ÁîüÊàê„ÄÇ\n\nüá¨üáß Generating PDF...\nTo ensure correct character display, the PDF will be generated in English.');
                // Cambiar temporalmente a ingl√©s
                window.LANG.change('en', true); // skipReload = true
                
                // Re-traducir clientName si es el placeholder
                if (!document.getElementById('client-name').value.trim()) {
                    clientName = tr('[NOMBRE COMPLETO CLIENTE]');
                }
            }
            
            // Generar HTML usando la funci√≥n auxiliar
            let html = generateDualHTMLContent(comercialCode, clientName, clientPhone, clientEmail);
            
            if (!html) {
                // Restaurar idioma chino si es necesario
                if (wasChineseMode) {
                    window.LANG.change('zh', true);
                }
                return; // Ya se mostr√≥ el error en generateDualHTMLContent
            }
            
            // NOTA: NO es necesario llamar a window.translateHTML() porque generateDualHTMLContent()
            // ya usa tr() que devuelve textos en el idioma correcto seg√∫n lang
            console.log('‚úÖ HTML generado en idioma:', localStorage.getItem('appLanguage') || 'es');
            
            // Abrir en ventana nueva
            const w = window.open('','_blank');
            if(!w){
                // Restaurar idioma chino si es necesario
                if (wasChineseMode) {
                    window.LANG.change('zh', true);
                }
                alert('‚ö†Ô∏è Ventana bloqueada. Permite ventanas emergentes.');
                return;
            }
            w.document.write(html);
            w.document.close();
            console.log('‚úÖ PDF completo generado');
            
            // Restaurar el idioma chino despu√©s de generar el PDF
            if (wasChineseMode) {
                setTimeout(() => {
                    console.log('üîÑ Restaurando idioma chino');
                    window.LANG.change('zh', true);
                }, 500);
            }
        }
        
        function showDualConfirm(type, tariff, data, results) {
            // DEPRECATED: Esta funci√≥n ya no deber√≠a usarse en modo DUAL
            // Si se llama, es porque falta a√±adir el otro tipo de suministro
            console.error('‚ö†Ô∏è showDualConfirm fue llamada incorrectamente');
            console.error('Esta funci√≥n est√° obsoleta para modo DUAL');
            window.showErrorModal(
                'Esta funcionalidad ya no est√° disponible.\n\n' +
                'Por favor, a√±ade tanto ELECTRICIDAD como GAS antes de calcular.',
                '‚ö†Ô∏è Funci√≥n obsoleta'
            );
            return;
            
            // C√≥digo antiguo comentado (por si se necesita en el futuro)
            /*
            console.log('=== showDualConfirm ===');
            console.log('Type:', type);
            console.log('Tariff:', tariff);
            console.log('Data:', data);
            console.log('Results:', results);
            
            // Guardar datos temporalmente
            dualTempSupply = { type, tariff, data, results };
            
            // Actualizar UI
            const formatEuro = (val) => val.toFixed(2).replace('.', ',') + ' ‚Ç¨';
            
            document.getElementById('dual-confirm-icon').textContent = type === 'electricidad' ? '‚ö°' : 'üî•';
            document.getElementById('dual-confirm-type').textContent = type === 'electricidad' ? 'Electricidad' : 'Gas';
            document.getElementById('dual-confirm-tariff').textContent = tariff;
            
            let totalKwh = 0;
            if (type === 'electricidad') {
                totalKwh = (parseFloat(data.kwh_p1) || 0) + 
                          (parseFloat(data.kwh_p2) || 0) + 
                          (parseFloat(data.kwh_p3) || 0) + 
                          (parseFloat(data.kwh_p4) || 0) + 
                          (parseFloat(data.kwh_p5) || 0) + 
                          (parseFloat(data.kwh_p6) || 0);
                console.log('Total kWh electricidad:', totalKwh);
            } else {
                totalKwh = parseFloat(data.kwh) || 0;
                console.log('Total kWh gas:', totalKwh);
            }
            
            document.getElementById('dual-confirm-consumption').textContent = totalKwh.toFixed(0) + ' kWh';
            document.getElementById('dual-confirm-days').textContent = data.dias + ' d√≠as';
            document.getElementById('dual-confirm-drk').textContent = formatEuro(results.drk.total_anual);
            document.getElementById('dual-confirm-powercup').textContent = formatEuro(results.powercup.total_anual);
            
            // NUEVO: Calcular y mostrar el ahorro anual estimado
            // El mejor coste es el menor entre DRK y PowerCup (o solo DRK si PowerCup es 0)
            let mejorCoste = results.drk.total_anual;
            if (results.powercup.total_anual > 0 && results.powercup.total_anual < mejorCoste) {
                mejorCoste = results.powercup.total_anual;
            }
            
            // Buscar la factura actual del cliente
            // Puede venir de m√∫ltiples lugares seg√∫n el flujo
            let facturaActual = 0;
            
            if (data.originalBillAnnual) {
                facturaActual = parseFloat(data.originalBillAnnual);
            } else if (data.factura_actual_anual) {
                facturaActual = parseFloat(data.factura_actual_anual);
            } else if (results.originalBillAnnual) {
                facturaActual = parseFloat(results.originalBillAnnual);
            } else if (lastComparisonResult && lastComparisonResult.originalBillAnnual) {
                facturaActual = parseFloat(lastComparisonResult.originalBillAnnual);
            }
            
            const ahorroAnual = facturaActual - mejorCoste;
            
            console.log('C√°lculo de ahorro:');
            console.log('- Factura actual anual:', facturaActual);
            console.log('- Mejor coste DRK/PowerCup:', mejorCoste);
            console.log('- Ahorro anual:', ahorroAnual);
            
            // Mostrar ahorro (puede ser negativo si no hay ahorro)
            if (ahorroAnual > 0) {
                document.getElementById('dual-confirm-savings').textContent = formatEuro(ahorroAnual);
                document.getElementById('dual-confirm-savings').classList.remove('text-red-600');
                document.getElementById('dual-confirm-savings').classList.add('text-green-600');
            } else if (ahorroAnual < 0) {
                document.getElementById('dual-confirm-savings').textContent = formatEuro(Math.abs(ahorroAnual)) + ' m√°s';
                document.getElementById('dual-confirm-savings').classList.remove('text-green-600');
                document.getElementById('dual-confirm-savings').classList.add('text-red-600');
            } else {
                document.getElementById('dual-confirm-savings').textContent = '0,00 ‚Ç¨';
            }
            
            // CR√çTICO: Ocultar TODAS las pantallas y vistas
            hideAllScreens();
            
            // Ocultar tambi√©n las vistas internas de electricidad
            document.getElementById('landing-view')?.classList.add('hidden');
            document.getElementById('initial-view')?.classList.add('hidden');
            document.getElementById('scanner-view')?.classList.add('hidden');
            document.getElementById('results-view')?.classList.add('hidden');
            document.getElementById('multicups-saga-view')?.classList.add('hidden');
            
            // Ocultar modal de decisi√≥n si est√° abierto
            const decisionModal = document.getElementById('offer-decision-modal');
            if (decisionModal) {
                decisionModal.classList.remove('flex');
                decisionModal.classList.add('hidden');
                decisionModal.style.display = 'none'; // Forzar tambi√©n con style
                console.log('Modal de decisi√≥n FORZADO a oculto');
            }
            
            // Mostrar pantalla de confirmaci√≥n DUAL
            document.getElementById('screen-dual-confirm').classList.add('active');
            
            // CR√çTICO: Usar setTimeout para asegurar que el modal se oculte DESPU√âS de cualquier c√≥digo as√≠ncrono
            setTimeout(() => {
                const modal = document.getElementById('offer-decision-modal');
                if (modal) {
                    modal.classList.remove('flex');
                    modal.classList.add('hidden');
                    modal.style.display = 'none';
                    console.log('Modal ocultado con setTimeout');
                }
            }, 50);
            
            console.log('Pantalla de confirmaci√≥n DUAL mostrada');
            */
        }
        
        // Funci√≥n: Confirmar y a√±adir a DUAL
        function dualConfirmAdd() {
            if (!dualTempSupply) {
                alert('Error: No hay datos para a√±adir');
                return;
            }
            
            const { type, tariff, data, results } = dualTempSupply;
            window.dualAddFromResults(type, tariff, data, results);
            
            // Limpiar temporal
            dualTempSupply = null;
        }
        
        // Funci√≥n: Cancelar y volver al gestor
        function dualCancelAdd() {
            dualTempSupply = null;
            backToDualManager();
        }
        
        // Funci√≥n: Confirmar y enviar email
        
        // Funci√≥n auxiliar: A√±adir suministro desde resultados
        window.dualAddFromResults = function(type, tariff, data, results) {
            console.log('=== dualAddFromResults ===');
            console.log('Type:', type);
            console.log('Tariff:', tariff);
            console.log('Data:', data);
            console.log('Results:', results);
            console.log('Results.drk.total_anual:', results.drk.total_anual);
            console.log('Results.powercup.total_anual:', results.powercup.total_anual);
            
            if (results.drk.total_anual === 0 && results.powercup.total_anual === 0) {
                console.error('‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è PROBLEMA: Ambos costes son 0 al a√±adir suministro');
                console.error('Results completo:', JSON.stringify(results, null, 2));
            }
            
            // Calcular descripci√≥n seg√∫n el tipo
            let description = '';
            let totalKwh = 0;
            
            if (type === 'electricidad') {
                totalKwh = (parseFloat(data.kwh_p1) || 0) + 
                          (parseFloat(data.kwh_p2) || 0) + 
                          (parseFloat(data.kwh_p3) || 0) + 
                          (parseFloat(data.kwh_p4) || 0) + 
                          (parseFloat(data.kwh_p5) || 0) + 
                          (parseFloat(data.kwh_p6) || 0);
                description = `${totalKwh.toFixed(0)} kWh, ${data.dias} d√≠as`;
            } else {
                totalKwh = parseFloat(data.kwh) || 0;
                description = `${totalKwh.toFixed(0)} kWh, ${data.dias} d√≠as`;
            }
            
            const supply = {
                type: type, // 'electricidad' o 'gas'
                cups: data.cups || 'N/A', // CUPS del suministro
                tariff: tariff,
                data: data,
                results: results,
                description: description,
                totalKwh: totalKwh,
                // CR√çTICO: Calcular totalAnnual desde el resultado correspondiente (DRK o Power Cup)
                totalAnnual: (results.drk.total_anual > 0) ? results.drk.total_anual : results.powercup.total_anual,
                // CR√çTICO: Guardar factura original para c√°lculo de ahorro
                originalBillAnnual: data.originalBillAnnual || 0,
                timestamp: new Date().getTime()
            };
            
            console.log('Suministro a a√±adir:', supply);
            console.log('Verificaci√≥n - DRK:', supply.results.drk.total_anual, 'PowerCup:', supply.results.powercup.total_anual);
            
            // A√±adir al array
            dualSupplies.push(supply);
            console.log('Total suministros:', dualSupplies.length);
            console.log('Array completo:', dualSupplies);
            
            // Volver al gestor DUAL
            backToDualManager();
            
            // Mostrar mensaje de confirmaci√≥n
            setTimeout(() => {
                const drkCost = supply.results.drk.total_anual;
                const pcCost = supply.results.powercup.total_anual;
                alert(`‚úÖ Suministro a√±adido correctamente\n\nTipo: ${type === 'electricidad' ? 'Electricidad' : 'Gas'}\nTarifa: ${tariff}\n${description}\n\nDRK anual: ${drkCost.toFixed(2)} ‚Ç¨\nPowerCup anual: ${pcCost.toFixed(2)} ‚Ç¨\n\nTotal: ${dualSupplies.length} suministro(s)`);
            }, 100);
        };
        
        // Funci√≥n: A√±adir resultado actual a DUAL
        window.addCurrentToDual = function() {
            console.log('=== A√ëADIENDO A DUAL ===');
            console.log('lastComparisonResult:', window.lastComparisonResult);
            console.log('gasCalculationParams:', window.gasCalculationParams);
            
            let type, tariff, data, results;
            
            // Intentar detectar si es electricidad
            if (window.lastComparisonResult) {
                const result = window.lastComparisonResult;
                console.log('Tipo de resultado:', result);
                
                // Es electricidad
                type = 'electricidad';
                tariff = result.tariffType || currentTariffType || '2.0TD';
                
                // Construir data desde lastComparisonResult
                data = {
                    tariff: tariff,
                    kwh_p1: parseFloat(result.kwh_p1) || 0,
                    kwh_p2: parseFloat(result.kwh_p2) || 0,
                    kwh_p3: parseFloat(result.kwh_p3) || 0,
                    kwh_p4: parseFloat(result.kwh_p4) || 0,
                    kwh_p5: parseFloat(result.kwh_p5) || 0,
                    kwh_p6: parseFloat(result.kwh_p6) || 0,
                    p1: parseFloat(result.p1) || 0,
                    p2: parseFloat(result.p2) || 0,
                    p3: parseFloat(result.p3) || 0,
                    p4: parseFloat(result.p4) || 0,
                    p5: parseFloat(result.p5) || 0,
                    p6: parseFloat(result.p6) || 0,
                    dias: parseInt(result.dias) || 30
                };
                
                console.log('Data construida:', data);
                
                // Construir results
                let drkCost = 0;
                let powercupCost = 0;
                
                // Intentar obtener costos de diferentes fuentes
                if (result.bestOffer) {
                    drkCost = parseFloat(result.bestOffer.annual_cost) || parseFloat(result.bestOffer.total_cost_period) * 12 || 0;
                    console.log('DRK cost from bestOffer:', drkCost);
                }
                
                if (result.indexedResult) {
                    powercupCost = parseFloat(result.indexedResult.annual_cost) || parseFloat(result.indexedResult.total_cost_period) * 12 || 0;
                    console.log('PowerCup cost from indexedResult:', powercupCost);
                }
                
                // Si no hay costos, intentar calcular desde aggregatedData
                if (drkCost === 0 && result.aggregatedData) {
                    drkCost = parseFloat(result.aggregatedData.total_anual_drk) || 0;
                    console.log('DRK cost from aggregatedData:', drkCost);
                }
                
                if (powercupCost === 0 && result.aggregatedData) {
                    powercupCost = parseFloat(result.aggregatedData.total_anual_powercup) || 0;
                    console.log('PowerCup cost from aggregatedData:', powercupCost);
                }
                
                // Si a√∫n no hay costos, usar offer directamente
                if (drkCost === 0 && result.offer) {
                    drkCost = parseFloat(result.offer.annual_cost) || 0;
                    console.log('DRK cost from offer:', drkCost);
                }
                
                results = {
                    drk: {
                        total: drkCost / 12,
                        total_anual: drkCost
                    },
                    powercup: {
                        total: powercupCost / 12,
                        total_anual: powercupCost
                    }
                };
                
                console.log('Results construidos:', results);
                
            } else if (window.gasCalculationParams && window.gasCalculationParams.kwh) {
                // Es gas
                type = 'gas';
                tariff = currentGasTariff;
                data = window.gasCalculationParams;
                
                console.log('Es GAS - data:', data);
                
                // Obtener resultados de gas desde las variables globales
                results = {
                    drk: window.lastGasDRKResult || { total: 0, total_anual: 0 },
                    powercup: window.lastGasPowerCupResult || { total: 0, total_anual: 0 }
                };
                
                console.log('Results de gas:', results);
            } else {
                console.error('No se pudo determinar el tipo de suministro');
                alert('‚ùå No se pudo determinar el tipo de suministro. Por favor, calcula primero una comparativa.');
                return;
            }
            
            // Validar que tenemos datos v√°lidos
            if (results.drk.total_anual === 0 && results.powercup.total_anual === 0) {
                console.error('No hay costos v√°lidos para a√±adir');
                alert('‚ùå No se pudieron obtener los costos. Por favor, calcula primero una comparativa.');
                return;
            }
            
            console.log('A√±adiendo suministro:', { type, tariff, data, results });
            window.dualAddFromResults(type, tariff, data, results);
        };
        
        // Funci√≥n espec√≠fica para a√±adir gas a DUAL
        window.addCurrentGasToDual = function() {
            if (!window.gasCalculationParams || !window.gasCalculationParams.kwh) {
                alert('No hay datos de gas para a√±adir');
                return;
            }
            
            const type = 'gas';
            const tariff = currentGasTariff;
            const data = window.gasCalculationParams;
            
            // Obtener resultados de gas desde las variables globales
            const results = {
                drk: window.lastGasDRKResult || { total: 0, total_anual: 0 },
                powercup: window.lastGasPowerCupResult || { total: 0, total_anual: 0 }
            };
            
            window.dualAddFromResults(type, tariff, data, results);
        };
        
        // Funci√≥n: Detectar y mostrar bot√≥n DUAL si estamos en modo DUAL
        window.checkDualMode = function() {
            const dualBtn = document.getElementById('add-to-dual-btn');
            if (dualBtn) {
                if (window.dualMode === true) {
                    dualBtn.style.display = 'flex';
                } else {
                    dualBtn.style.display = 'none';
                }
            }
            
            // Para gas
            const gasDualContainer = document.getElementById('gas-dual-button-container');
            if (gasDualContainer) {
                if (window.dualMode === true) {
                    gasDualContainer.style.display = 'block';
                } else {
                    gasDualContainer.style.display = 'none';
                }
            }
        };
        
        // FIN FUNCIONES M√ìDULO DUAL
        
        // ===== CALCULADOR DE GAS =====
        
        // Variables globales para GAS
        let currentGasTariff = '';
        let gasTariffsData = [];
        let gasCalculationParams = {}; // Guardar par√°metros de c√°lculo
        const GAS_SHEET_ID = '1P_OSzj-sqDgT7_3KAdp7Y6ySA3ytsFHQKFvfZjAjsjE';
        
        // Funci√≥n: Actualizar UI seg√∫n modo de selecci√≥n
        function updateGasSelectionUI() {
            const selectionMode = document.querySelector('input[name="gas-selection-mode"]:checked').value;
            const compareChecked = document.getElementById('gas-compare-indexed-fixed').checked;
            const typeButtons = document.getElementById('gas-type-buttons');
            const calculateBtn = document.getElementById('gas-calculate-btn');
            const bestDescription = document.getElementById('gas-best-description');
            
            if (selectionMode === 'best') {
                // Modo "Mejores tarifas"
                if (compareChecked) {
                    // Comparar indexada vs fija: mostrar bot√≥n calcular
                    typeButtons.style.display = 'none';
                    calculateBtn.style.display = 'block'; // MOSTRAR el bot√≥n
                    calculateBtn.textContent = 'Calcular';
                    bestDescription.textContent = 'Comparar√° autom√°ticamente la mejor tarifa indexada DRK vs la mejor tarifa fija DRK.';
                } else {
                    // Usuario elige tipo: mostrar botones
                    typeButtons.style.display = 'block';
                    calculateBtn.style.display = 'none'; // Ocultar bot√≥n principal
                    bestDescription.textContent = 'Elige si quieres ver la mejor tarifa fija o indexada.';
                }
            } else {
                // Modo "Elegir entre resultados"
                typeButtons.style.display = 'none';
                calculateBtn.style.display = 'block';
                calculateBtn.textContent = 'Ver tarifas disponibles';
            }
        }
        
        // Funci√≥n: Toggle modo de comparaci√≥n
        function toggleGasComparisonMode() {
            updateGasSelectionUI();
        }
        
        // Funci√≥n: Calcular con tipo espec√≠fico (fija o indexada)
        function calculateGasWithType(type) {
            // Validar inputs
            const cups = document.getElementById('gas-cups').value.trim();
            const dias = parseFloat(document.getElementById('gas-dias').value);
            const kwh = parseFloat(document.getElementById('gas-kwh').value);
            const totalCliente = parseFloat(document.getElementById('gas-total-cliente').value);
            
            if (!dias || !kwh || !totalCliente) {
                alert(tr('Por favor, completa todos los campos'));
                return;
            }
            
            if (dias <= 0 || kwh <= 0 || totalCliente <= 0) {
                alert('Los valores deben ser mayores a 0');
                return;
            }
            
            // Guardar par√°metros (CR√çTICO: tambi√©n en window para modo DUAL)
            gasCalculationParams = { cups, dias, kwh, totalCliente, type, mode: 'best' };
            window.gasCalculationParams = gasCalculationParams;
            console.log('‚úÖ gasCalculationParams guardado en window:', window.gasCalculationParams);
            
            // Cerrar modal y calcular
            closeGasModal();
            performGasCalculation();
        }
        
        // Funci√≥n: Proceder a c√°lculo seg√∫n configuraci√≥n
        function proceedToGasCalculation() {
            // Validar inputs
            const cups = document.getElementById('gas-cups').value.trim();
            const dias = parseFloat(document.getElementById('gas-dias').value);
            const kwh = parseFloat(document.getElementById('gas-kwh').value);
            const totalCliente = parseFloat(document.getElementById('gas-total-cliente').value);
            
            if (!dias || !kwh || !totalCliente) {
                alert(tr('Por favor, completa todos los campos'));
                return;
            }
            
            if (dias <= 0 || kwh <= 0 || totalCliente <= 0) {
                alert('Los valores deben ser mayores a 0');
                return;
            }
            
            const selectionMode = document.querySelector('input[name="gas-selection-mode"]:checked').value;
            const compareChecked = document.getElementById('gas-compare-indexed-fixed').checked;
            
            // Guardar par√°metros (CR√çTICO: tambi√©n en window para modo DUAL)
            gasCalculationParams = {
                cups,
                dias,
                kwh,
                totalCliente,
                mode: selectionMode,
                compareIndexedVsFixed: compareChecked
            };
            window.gasCalculationParams = gasCalculationParams;
            console.log('‚úÖ gasCalculationParams guardado en window:', window.gasCalculationParams);
            
            // Cerrar modal
            closeGasModal();
            
            if (selectionMode === 'best') {
                // Modo "Mejores tarifas"
                if (compareChecked) {
                    // Comparar indexada vs fija autom√°ticamente
                    performGasCalculation();
                }
            } else {
                // Modo "Elegir entre resultados" - mostrar selector de tarifas
                showGasTariffSelector();
            }
        }
        
        // Funci√≥n: Realizar c√°lculo de GAS
        function performGasCalculation() {
            const { dias, kwh, totalCliente, type, mode, compareIndexedVsFixed } = gasCalculationParams;
            const comparisonMode = document.querySelector('input[name="comparison_mode"]:checked').value;
            
            // Convertir RL1 ‚Üí RL.1 para buscar en el Excel
            const searchTariff = currentGasTariff.replace(/RL(\d)/, 'RL.$1');
            
            console.log(`üîç Buscando tarifa: ${currentGasTariff} ‚Üí ${searchTariff}`);
            console.log(`üìã Modo: ${mode}, Tipo: ${type || 'auto'}, Comparar: ${compareIndexedVsFixed}`);
            
            // Buscar en la columna "Tarifa"
            let filteredTariffs = gasTariffsData.filter(t => {
                const tariffValue = (t.Tarifa || '').trim().toUpperCase();
                const searchValue = searchTariff.toUpperCase();
                return tariffValue === searchValue;
            });
            
            console.log(`üìä Tarifas encontradas para ${searchTariff}: ${filteredTariffs.length}`);
            
            // Aplicar filtro DRK si corresponde
            if (comparisonMode === 'drk_only' || comparisonMode === 'drk_prioritized') {
                filteredTariffs = filteredTariffs.filter(t => {
                    const name = (t.name || t.Name || '').toLowerCase();
                    return name.includes('drk') || name.includes('direct');
                });
                console.log(`üìä Despu√©s de filtro DRK: ${filteredTariffs.length}`);
            }
            
            if (filteredTariffs.length === 0) {
                alert(`No se encontraron tarifas DRK para ${searchTariff}`);
                return;
            }
            
            let results = [];
            
            if (compareIndexedVsFixed) {
                // MODO: Comparar Indexada vs Fija
                // Indexada = name contiene "INDEX" o "DRK INDEX"
                // Fija = name NO contiene "INDEX" o description contiene "FIJO"/"FIJA"
                const indexedTariffs = filteredTariffs.filter(t => {
                    const name = (t.name || t.Name || '').toUpperCase();
                    return name.includes('INDEX');
                });
                
                const fixedTariffs = filteredTariffs.filter(t => {
                    const name = (t.name || t.Name || '').toUpperCase();
                    const desc = (t.description || t.Description || '').toUpperCase();
                    // Es FIJA si NO tiene INDEX en name, o si tiene FIJO/FIJA en descripci√≥n
                    return !name.includes('INDEX') || desc.includes('FIJO') || desc.includes('FIJA');
                });
                
                console.log(`üü† Indexadas: ${indexedTariffs.length}, üîµ Fijas: ${fixedTariffs.length}`);
                
                // Encontrar mejor indexada (normalmente solo hay 1 DRK INDEX por categor√≠a)
                if (indexedTariffs.length > 0) {
                    const bestIndexed = indexedTariffs[0]; // Primera DRK INDEX
                    results.push(calculateGasTariff(bestIndexed, dias, kwh, totalCliente));
                }
                
                // Encontrar mejor fija
                if (fixedTariffs.length > 0) {
                    const calculatedFixed = fixedTariffs.map(t => calculateGasTariff(t, dias, kwh, totalCliente));
                    const bestFixed = calculatedFixed.sort((a, b) => b.ahorro_anual - a.ahorro_anual)[0];
                    results.push(bestFixed);
                }
                
            } else if (mode === 'best' && type) {
                // MODO: Mejores tarifas - Usuario eligi√≥ Fija o Indexada
                let targetTariffs;
                
                if (type === 'fija') {
                    // Buscar FIJAS: name NO contiene INDEX, o description contiene FIJO
                    targetTariffs = filteredTariffs.filter(t => {
                        const name = (t.name || t.Name || '').toUpperCase();
                        const desc = (t.description || t.Description || '').toUpperCase();
                        return !name.includes('INDEX') || desc.includes('FIJO') || desc.includes('FIJA');
                    });
                } else {
                    // Buscar INDEXADAS: name contiene INDEX
                    targetTariffs = filteredTariffs.filter(t => {
                        const name = (t.name || t.Name || '').toUpperCase();
                        return name.includes('INDEX');
                    });
                }
                
                console.log(`üìä Tarifas ${type}: ${targetTariffs.length}`);
                
                if (targetTariffs.length === 0) {
                    alert(`No se encontraron tarifas ${type} para esta categor√≠a`);
                    return;
                }
                
                // Calcular todas y encontrar la mejor
                const calculated = targetTariffs.map(t => calculateGasTariff(t, dias, kwh, totalCliente));
                const best = calculated.sort((a, b) => b.ahorro_anual - a.ahorro_anual)[0];
                results = [best];
            }
            
            if (results.length === 0) {
                alert('No se pudieron calcular resultados');
                return;
            }
            
            // Mostrar resultados
            showGasResults(results, dias, kwh, totalCliente);
        }
        
        // Funci√≥n: Seleccionar tarifa de GAS y abrir modal
        function selectGasTariff(tariff) {
            currentGasTariff = tariff;
            // Mostrar con formato correcto (Rl1 en lugar de RL1)
            const displayTariff = tariff.charAt(0).toUpperCase() + tariff.charAt(1).toLowerCase() + tariff.slice(2);
            document.getElementById('gas-selected-tariff').textContent = displayTariff;
            
            // Resetear formulario
            document.getElementById('gas-cups').value = '';
            document.getElementById('gas-dias').value = '';
            document.getElementById('gas-kwh').value = '';
            document.getElementById('gas-total-cliente').value = '';
            document.getElementById('gas-compare-indexed-fixed').checked = false;
            document.querySelector('input[name="gas-selection-mode"][value="best"]').checked = true;
            
            // Actualizar UI
            updateGasSelectionUI();
            
            // CR√çTICO: Verificar modo DUAL para ocultar/mostrar bot√≥n DUAL
            if (window.checkDualMode) {
                window.checkDualMode();
            }
            
            // Mostrar modal
            document.getElementById('gas-manual-input-modal').classList.remove('hidden');
            document.getElementById('gas-manual-input-modal').classList.add('flex');
            
            // Cargar datos si no est√°n cargados
            if (gasTariffsData.length === 0) {
                loadGasData();
            }
            
            console.log(`üìã Tarifa seleccionada: ${tariff} (buscar√°: ${tariff.toLowerCase()})`);
            console.log(`üîç Modo DUAL: ${window.dualMode}`);
        }
        
        // Funci√≥n: Mostrar selector de tarifas manual
        function showGasTariffSelector() {
            const { dias, kwh, totalCliente, compareIndexedVsFixed } = gasCalculationParams;
            const comparisonMode = document.querySelector('input[name="comparison_mode"]:checked').value;
            const searchTariff = currentGasTariff.replace(/RL(\d)/, 'RL.$1');
            
            // Filtrar tarifas disponibles
            let filteredTariffs = gasTariffsData.filter(t => {
                const tariffValue = (t.Tarifa || '').trim().toUpperCase();
                return tariffValue === searchTariff.toUpperCase();
            });
            
            // Aplicar filtro DRK si corresponde
            if (comparisonMode === 'drk_only' || comparisonMode === 'drk_prioritized') {
                filteredTariffs = filteredTariffs.filter(t => {
                    const name = (t.name || t.Name || '').toLowerCase();
                    return name.includes('drk') || name.includes('direct');
                });
            }
            
            // Si comparar indexada vs fija, solo mostrar FIJAS para selecci√≥n manual
            if (compareIndexedVsFixed) {
                filteredTariffs = filteredTariffs.filter(t => {
                    const name = (t.name || t.Name || '').toUpperCase();
                    const desc = (t.description || t.Description || '').toUpperCase();
                    // Es FIJA si NO tiene INDEX en name, o si tiene FIJO/FIJA en descripci√≥n
                    return !name.includes('INDEX') || desc.includes('FIJO') || desc.includes('FIJA');
                });
            }
            
            if (filteredTariffs.length === 0) {
                alert('No hay tarifas disponibles para selecci√≥n manual');
                return;
            }
            
            // CALCULAR TODAS LAS TARIFAS PARA MOSTRAR AHORRO
            const calculatedTariffs = filteredTariffs.map(tariff => {
                const result = calculateGasTariff(tariff, dias, kwh, totalCliente);
                return {
                    tariff: tariff,
                    calculation: result,
                    name: tariff.name || tariff.Name,
                    description: tariff.description || tariff.Description || (tariff.name || tariff.Name),
                    isIndexed: (tariff.name || tariff.Name || '').toUpperCase().includes('INDEX'),
                    ahorro: result.ahorro_anual
                };
            });
            
            console.log(`üí∞ Tarifas calculadas: ${calculatedTariffs.length}`);
            
            // Guardar para usar en ordenamiento
            window.gasCalculatedTariffs = calculatedTariffs;
            
            // Renderizar UI con ordenamiento por defecto (mayor ahorro)
            renderGasTariffSelector('ahorro-desc');
            
            // Mostrar pantalla de resultados
            hideAllScreens();
            document.getElementById('screen-gas-results').classList.add('active');
            
            // NO mostrar bot√≥n DUAL aqu√≠ - esta es la pantalla de selecci√≥n manual
            // Ocultar expl√≠citamente el bot√≥n DUAL
            const gasDualContainer = document.getElementById('gas-dual-button-container');
            if (gasDualContainer) {
                gasDualContainer.style.display = 'none';
            }
        }
        
        // Funci√≥n: Renderizar selector de tarifas con ordenamiento
        function renderGasTariffSelector(sortBy = 'ahorro-desc') {
            const calculatedTariffs = window.gasCalculatedTariffs;
            const compareIndexedVsFixed = gasCalculationParams.compareIndexedVsFixed;
            
            // Ordenar seg√∫n criterio
            let sortedTariffs = [...calculatedTariffs];
            
            if (sortBy === 'ahorro-desc') {
                sortedTariffs.sort((a, b) => b.ahorro - a.ahorro);
            } else if (sortBy === 'ahorro-asc') {
                sortedTariffs.sort((a, b) => a.ahorro - b.ahorro);
            } else if (sortBy === 'nombre') {
                sortedTariffs.sort((a, b) => a.name.localeCompare(b.name));
            }
            
            // Crear UI de selecci√≥n
            const container = document.getElementById('gas-results-container');
            let html = `
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-drk-900 mb-4">Selecciona las tarifas a comparar:</h3>
                    <p class="text-sm text-slate-600 mb-4">
                        ${compareIndexedVsFixed ? 'La tarifa indexada DRK se comparar√° autom√°ticamente con las tarifas fijas que selecciones.' : 'Selecciona una o m√°s tarifas para comparar.'}
                    </p>
                    
                    <!-- Buscador de texto -->
                    <div class="mb-4 p-4 bg-slate-50 rounded-lg">
                        <label class="block text-sm font-bold text-slate-700 mb-2">üîç Buscar comercializadora:</label>
                        <div class="flex gap-2">
                            <input 
                                type="text" 
                                id="gas-search-input"
                                placeholder="Escribe el nombre de la comercializadora..."
                                onkeyup="applyGasSearch()"
                                class="flex-1 px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-red-500 focus:outline-none"
                            >
                            <button 
                                onclick="clearGasSearch()"
                                class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-bold hover:bg-slate-300 transition"
                                title="Limpiar b√∫squeda"
                            >
                                ‚úï
                            </button>
                        </div>
                        <p class="text-xs text-slate-500 mt-2" id="gas-search-count"></p>
                    </div>
                    
                    <!-- Filtros de ordenamiento -->
                    <div class="mb-4 p-4 bg-slate-50 rounded-lg">
                        <label class="block text-sm font-bold text-slate-700 mb-2">Ordenar por:</label>
                        <div class="flex gap-2 flex-wrap">
                            <button 
                                onclick="renderGasTariffSelector('ahorro-desc')"
                                class="px-4 py-2 rounded-lg text-sm font-bold transition ${sortBy === 'ahorro-desc' ? 'bg-green-500 text-white' : 'bg-white text-slate-700 border-2 border-slate-200 hover:border-green-300'}"
                            >
                                üí∞ Mayor ahorro primero
                            </button>
                            <button 
                                onclick="renderGasTariffSelector('ahorro-asc')"
                                class="px-4 py-2 rounded-lg text-sm font-bold transition ${sortBy === 'ahorro-asc' ? 'bg-red-500 text-white' : 'bg-white text-slate-700 border-2 border-slate-200 hover:border-red-300'}"
                            >
                                üìâ Menor ahorro primero
                            </button>
                            <button 
                                onclick="renderGasTariffSelector('nombre')"
                                class="px-4 py-2 rounded-lg text-sm font-bold transition ${sortBy === 'nombre' ? 'bg-blue-500 text-white' : 'bg-white text-slate-700 border-2 border-slate-200 hover:border-blue-300'}"
                            >
                                üî§ Por nombre
                            </button>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
            `;
            
            sortedTariffs.forEach((item, index) => {
                const typeLabel = item.isIndexed ? 'üü† INDEXADA' : 'üîµ FIJA';
                const ahorroAnual = item.ahorro;
                const isPositive = ahorroAnual > 0;
                const ahorroClass = isPositive ? 'text-green-600' : 'text-red-600';
                const ahorroSign = isPositive ? '+' : '';
                
                html += `
                    <label class="flex items-center gap-3 p-4 border-2 ${isPositive ? 'border-green-200 bg-green-50' : 'border-slate-200'} rounded-lg hover:border-red-300 cursor-pointer transition">
                        <input 
                            type="checkbox" 
                            class="gas-tariff-checkbox w-5 h-5 text-red-600 rounded flex-shrink-0"
                            data-index="${index}"
                        >
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-drk-900">${item.name}</span>
                                <span class="text-xs px-2 py-1 rounded ${item.isIndexed ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}">${typeLabel}</span>
                            </div>
                            <p class="text-sm text-slate-600">${item.description}</p>
                        </div>
                        <div class="flex flex-col items-end text-right flex-shrink-0 ml-2">
                            <span class="text-xs text-slate-500 font-semibold">Ahorro anual:</span>
                            <span class="text-lg font-black ${ahorroClass}">${ahorroSign}${ahorroAnual.toFixed(2)}‚Ç¨</span>
                        </div>
                    </label>
                `;
            });
            
            html += `
                    </div>
                    
                    <button 
                        onclick="calculateSelectedGasTariffs()"
                        class="w-full mt-6 px-6 py-3 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600 transition"
                    >
                        Calcular tarifas seleccionadas
                    </button>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Ocultar bot√≥n DUAL en selector manual
            const gasDualContainer = document.getElementById('gas-dual-button-container');
            if (gasDualContainer) {
                gasDualContainer.style.display = 'none';
            }
            
            // Guardar ordenamiento actual
            window.gasSortedTariffs = sortedTariffs;
        }
        
        // Funci√≥n: Calcular tarifas seleccionadas manualmente
        function calculateSelectedGasTariffs() {
            const checkboxes = document.querySelectorAll('.gas-tariff-checkbox:checked');
            
            if (checkboxes.length === 0) {
                alert('Selecciona al menos una tarifa');
                return;
            }
            
            const { dias, kwh, totalCliente, compareIndexedVsFixed } = gasCalculationParams;
            
            // Usar las tarifas ya ordenadas
            const sortedTariffs = window.gasSortedTariffs || window.gasCalculatedTariffs;
            
            const selectedCalculations = Array.from(checkboxes).map(cb => {
                const index = parseInt(cb.dataset.index);
                return sortedTariffs[index].calculation;
            });
            
            let results = selectedCalculations;
            
            // Si comparar indexada vs fija, agregar la indexada DRK al inicio
            if (compareIndexedVsFixed) {
                const comparisonMode = document.querySelector('input[name="comparison_mode"]:checked').value;
                const searchTariff = currentGasTariff.replace(/RL(\d)/, 'RL.$1');
                
                let allTariffs = gasTariffsData.filter(t => {
                    const tariffValue = (t.Tarifa || '').trim().toUpperCase();
                    return tariffValue === searchTariff.toUpperCase();
                });
                
                if (comparisonMode === 'drk_only' || comparisonMode === 'drk_prioritized') {
                    allTariffs = allTariffs.filter(t => {
                        const name = (t.name || t.Name || '').toLowerCase();
                        return name.includes('drk') || name.includes('direct');
                    });
                }
                
                // Buscar indexada por name (contiene INDEX)
                const indexedTariff = allTariffs.find(t => {
                    const name = (t.name || t.Name || '').toUpperCase();
                    return name.includes('INDEX');
                });
                
                if (indexedTariff) {
                    results.unshift(calculateGasTariff(indexedTariff, dias, kwh, totalCliente));
                }
            }
            
            // Mostrar resultados
            showGasResults(results, dias, kwh, totalCliente);
        }
        
        // Funci√≥n: Cerrar modal
        function closeGasModal() {
            document.getElementById('gas-manual-input-modal').classList.add('hidden');
            document.getElementById('gas-manual-input-modal').classList.remove('flex');
        }
        
        // Funci√≥n: Cargar datos del Google Sheets de GAS
        async function loadGasData() {
            console.log('üîÑ Cargando datos de GAS desde Google Sheets...');
            const url = `https://docs.google.com/spreadsheets/d/${GAS_SHEET_ID}/export?format=csv&gid=0&t=${Date.now()}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                
                if (!text || text.length < 10) {
                    throw new Error('El archivo CSV est√° vac√≠o o no se pudo cargar');
                }
                
                console.log('üì• CSV recibido, primeras 200 caracteres:', text.substring(0, 200));
                
                gasTariffsData = parseGasCSV(text);
                
                if (gasTariffsData.length === 0) {
                    console.error('‚ùå No se pudieron parsear datos del CSV');
                    alert('Error: No se encontraron datos en el Excel de GAS');
                } else {
                    console.log(`‚úÖ Cargadas ${gasTariffsData.length} tarifas de GAS`);
                }
            } catch (error) {
                console.error('‚ùå Error al cargar datos de GAS:', error);
                gasTariffsData = [];
                alert('Error al cargar datos de GAS. Verifica la conexi√≥n y permisos del Excel.');
            }
        }
        
        // Funci√≥n: Parsear CSV de GAS
        function parseGasCSV(csvText) {
            const lines = csvText.split('\n');
            if (lines.length === 0) return [];
            
            // Limpiar y extraer headers (mantener nombres exactos)
            const headerLine = lines[0];
            const headers = headerLine.split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            
            console.log('üìã Headers del Excel:', headers);
            
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Parsear CSV manejando comillas
                const values = [];
                let currentValue = '';
                let insideQuotes = false;
                
                for (let char of line) {
                    if (char === '"') {
                        insideQuotes = !insideQuotes;
                    } else if (char === ',' && !insideQuotes) {
                        values.push(currentValue.trim().replace(/^"|"$/g, ''));
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                values.push(currentValue.trim().replace(/^"|"$/g, ''));
                
                // Crear objeto manteniendo nombres exactos de headers
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                
                // Verificar que tenga datos v√°lidos
                // Columnas cr√≠ticas: name, p1_price, Tarifa
                const hasName = row.name || row.Name;
                const hasPrice = row.p1_price || row.P1_price;
                const hasTarifa = row.Tarifa;
                
                if (hasName && hasPrice && hasTarifa) {
                    data.push(row);
                    
                    // Log de las primeras 3 filas para debug
                    if (data.length <= 3) {
                        console.log(`üìä Fila ${data.length}:`, {
                            name: row.name || row.Name,
                            description: row.description || row.Description,
                            Tarifa: row.Tarifa,
                            p1_price: row.p1_price,
                            p_fijo_1: row.p_fijo_1
                        });
                    }
                }
            }
            
            console.log(`‚úÖ Parseadas ${data.length} tarifas de GAS`);
            
            // Mostrar las tarifas √∫nicas encontradas
            const uniqueTariffs = [...new Set(data.map(d => d.Tarifa))].sort();
            console.log('üè∑Ô∏è Tarifas √∫nicas encontradas:', uniqueTariffs);
            
            return data;
        }
        
        /* FUNCI√ìN ANTIGUA - YA NO SE USA
        // Funci√≥n: Realizar c√°lculos de GAS
        function calculateGas() {
            // ... c√≥digo comentado ...
        }
        */
        
        // Funci√≥n: Calcular una tarifa espec√≠fica de GAS
        function calculateGasTariff(tariff, dias, kwh, totalCliente) {
            // Funci√≥n auxiliar para convertir string europeo a n√∫mero
            const parseEuropeanNumber = (value) => {
                if (!value) return 0;
                // Convertir coma a punto y luego parsear
                const cleanValue = String(value).replace(',', '.');
                return parseFloat(cleanValue) || 0;
            };
            
            // Extraer datos de la tarifa (usando nombres exactos del Excel)
            const p1_price = parseEuropeanNumber(tariff.p1_price || tariff.P1_price);
            const descuento_energia = parseEuropeanNumber(tariff.Descuento_Energia) / 100;
            const p_fijo_anual = parseEuropeanNumber(tariff.p_fijo_1 || tariff.P_fijo_1);
            const descuento_potencia = parseEuropeanNumber(tariff.Descuento_Potencia) / 100;
            
            console.log('üßÆ Calculando:', {
                name: tariff.name || tariff.Name,
                p1_price: p1_price + ' (original: ' + (tariff.p1_price || tariff.P1_price) + ')',
                descuento_energia: (descuento_energia * 100) + '%',
                p_fijo_anual: p_fijo_anual + ' (original: ' + (tariff.p_fijo_1 || tariff.P_fijo_1) + ')',
                descuento_potencia: (descuento_potencia * 100) + '%',
                dias: dias
            });
            
            // 1. T√âRMINO FIJO
            const p_fijo_diario = p_fijo_anual / 365;
            const p_fijo_descuento = p_fijo_diario * descuento_potencia;
            const p_fijo_diario_final = p_fijo_diario - p_fijo_descuento;
            const total_fijo = p_fijo_diario_final * dias;
            
            console.log('üìä T√©rmino fijo:', {
                'p_fijo_anual': p_fijo_anual.toFixed(6),
                'p_fijo_diario': p_fijo_diario.toFixed(6),
                'descuento_por_dia': p_fijo_descuento.toFixed(6),
                'p_fijo_diario_final': p_fijo_diario_final.toFixed(6),
                'dias': dias,
                'total_fijo': total_fijo.toFixed(2)
            });
            
            // 2. ENERG√çA
            const p1_descuento = p1_price * descuento_energia;
            const total_energia = kwh * (p1_price - p1_descuento);
            
            // 3. IMPUESTO DE HIDROCARBUROS
            const impuesto_hidrocarburo = 0.00234 * kwh;
            
            // 4. ALQUILER DE CONTADOR - QUITADO (ya no se incluye)
            // const alquiler_contador = 1.07;
            
            // 5. SUBTOTAL (antes de IVA) - SIN alquiler contador
            const subtotal = total_fijo + total_energia + impuesto_hidrocarburo;
            
            // 6. IVA
            const iva = 0.21 * subtotal;
            
            // 7. TOTAL FINAL
            const total = subtotal + iva;
            
            // 8. AHORRO
            const ahorro_periodo = totalCliente - total;
            const ahorro_mensual = dias !== 30 ? (ahorro_periodo * 30) / dias : ahorro_periodo;
            const ahorro_anual = ahorro_mensual * 12;
            
            console.log('üí∞ Resultado:', {
                total_fijo: total_fijo.toFixed(2) + '‚Ç¨',
                total_energia: total_energia.toFixed(2) + '‚Ç¨',
                subtotal: subtotal.toFixed(2) + '‚Ç¨',
                iva: iva.toFixed(2) + '‚Ç¨',
                total: total.toFixed(2) + '‚Ç¨',
                ahorro_anual: ahorro_anual.toFixed(2) + '‚Ç¨'
            });
            
            return {
                name: tariff.name || tariff.Name,
                descripcion: tariff.description || tariff.Description || tariff.name || tariff.Name,
                tarifa: tariff.Tarifa,
                // Desglose
                p_fijo_diario: p_fijo_diario,
                p_fijo_descuento: p_fijo_descuento,
                total_fijo: total_fijo,
                p1_price: p1_price,
                p1_descuento: p1_descuento,
                total_energia: total_energia,
                impuesto_hidrocarburo: impuesto_hidrocarburo,
                alquiler_contador: 0, // Quitado
                subtotal: subtotal,
                iva: iva,
                total: total,
                // Ahorro
                ahorro_periodo: ahorro_periodo,
                ahorro_mensual: ahorro_mensual,
                ahorro_anual: ahorro_anual
            };
        }
        
        // Funci√≥n: Mostrar resultados de GAS
        function showGasResults(results, dias, kwh, totalCliente) {
            console.log('=== showGasResults ===');
            console.log('Mode DUAL:', window.dualMode);
            console.log('Results:', results);
            console.log('Params:', { dias, kwh, totalCliente });
            
            // CR√çTICO: Interceptar DUAL AL PRINCIPIO, antes de procesar HTML
            if (window.dualMode === true) {
                console.log('‚ö° Modo DUAL detectado en GAS - a√±adiendo al array');
                
                try {
                    // Ordenar por mejor ahorro
                    results.sort((a, b) => b.ahorro_anual - a.ahorro_anual);
                    
                    // Extraer mejor resultado para DUAL
                    const bestResult = results[0];
                    console.log('===== DEBUG GAS =====');
                    console.log('Best gas result:', bestResult);
                    console.log('Propiedades de bestResult:', Object.keys(bestResult));
                    console.log('  - name:', bestResult.name);
                    console.log('  - descripcion:', bestResult.descripcion);
                    console.log('  - tarifa:', bestResult.tarifa);
                    console.log('  - total (mensual):', bestResult.total);
                    console.log('  - total * 12 (anual):', bestResult.total * 12);
                    console.log('  - ahorro_anual:', bestResult.ahorro_anual);
                    console.log('====================');
                    
                    const data = window.gasCalculationParams || {};
                    console.log('Gas calculation params:', data);
                    
                    // Calcular anual desde el mensual
                    const totalMensual = bestResult.total || 0;
                    const totalAnual = totalMensual * 12;
                    
                    // Obtener factura original desde gasCalculationParams
                    // NOTA: gasCalculationParams usa 'totalCliente', no 'importe_factura'
                    const importeFacturaMensual = data.totalCliente || data.importe_factura || 0;
                    const originalBillAnnual = importeFacturaMensual * 12;
                    
                    console.log('C√°lculos:');
                    console.log('  - Total mensual DRK:', totalMensual);
                    console.log('  - Total anual DRK:', totalAnual);
                    console.log('  - Factura original mensual:', importeFacturaMensual);
                    console.log('  - Factura original anual:', originalBillAnnual);
                    console.log('  - Ahorro anual:', originalBillAnnual - totalAnual);
                    console.log('  - Ahorro mensual:', importeFacturaMensual - totalMensual);
                    
                    // Parsear valores correctamente (pueden venir como "11.18‚Ç¨" o "11,18")
                    const parseGasValue = (val) => {
                        if (!val) return 0;
                        if (typeof val === 'number') return val;
                        // Eliminar s√≠mbolo ‚Ç¨ y convertir comas a puntos
                        return parseFloat(val.toString().replace('‚Ç¨', '').replace(',', '.').trim()) || 0;
                    };
                    
                    console.log('Valores parseados:');
                    console.log('  - total_fijo:', parseGasValue(bestResult.total_fijo));
                    console.log('  - total_energia:', parseGasValue(bestResult.total_energia));
                    console.log('  - impuesto_hidrocarburos:', parseGasValue(bestResult.impuesto_hidrocarburos));
                    
                    // CREAR el objeto de suministro para GAS (con DESGLOSE COMPLETO)
                    const newSupply = {
                        type: 'gas',
                        cups: data.cups || 'N/A', // CUPS de GAS capturado del formulario
                        tariff: currentGasTariff || bestResult.tarifa || 'Gas',
                        offer: {
                            name: bestResult.name || 'DRK',
                            description: bestResult.descripcion || bestResult.name || 'DRK Gas',  // ‚úÖ DESCRIPTION
                            isDrk: true,
                            // A√±adir precios para mostrar en PDF
                            p_fijo_diario: parseFloat(bestResult.p_fijo_diario) || 0,
                            p1_price: parseFloat(bestResult.p1_price) || 0
                        },
                        totalAnnual: totalAnual,
                        originalBillAnnual: originalBillAnnual,
                        // NUEVO: A√±adir desglose completo (PROPIEDADES CORREGIDAS)
                        gasBreakdown: {
                            termino_fijo: parseGasValue(bestResult.total_fijo),      // ‚úÖ CORREGIDO: total_fijo
                            termino_fijo_diario: parseFloat(bestResult.p_fijo_diario) || 0,
                            energia: parseGasValue(bestResult.total_energia),         // ‚úÖ CORREGIDO: total_energia
                            impuesto_hidrocarburos: parseGasValue(bestResult.impuesto_hidrocarburos), // ‚úÖ
                            subtotal: parseGasValue(bestResult.subtotal),
                            iva: parseGasValue(bestResult.iva),
                            total: parseGasValue(bestResult.total),
                            total_anual: totalAnual,
                            ahorro_mensual: importeFacturaMensual - totalMensual,
                            ahorro_anual: originalBillAnnual - totalAnual,
                            kwh: data.kwh || 0,
                            dias: data.dias || 30
                        },
                        data: {
                            kwh: data.kwh || 0,
                            kwh_p1: 0,
                            kwh_p2: 0,
                            kwh_p3: 0,
                            consumo_anual_kwh: data.kwh || 0,
                            importe_factura: importeFacturaMensual,
                            dias: data.dias || 30
                        },
                        results: {
                            drk: {
                                total: totalMensual,
                                total_anual: totalAnual
                            },
                            powercup: {
                                // Para GAS, usar el mismo valor que DRK si no hay segunda tarifa
                                total: results.length > 1 ? results[1].total : totalMensual,
                                total_anual: results.length > 1 ? results[1].total_anual : totalAnual
                            }
                        }
                    };
                    
                    // A√ëADIR al array
                    dualSupplies.push(newSupply);
                    
                    console.log('‚úÖ Suministro GAS a√±adido al array');
                    console.log('  - Total suministros:', dualSupplies.length);
                    console.log('  - Tarifa:', newSupply.tariff);
                    console.log('  - Coste anual (totalAnnual):', newSupply.totalAnnual);
                    console.log('  - Coste mensual:', newSupply.totalAnnual / 12);
                    console.log('  - Objeto completo:', newSupply);
                    
                    // Actualizar UI
                    updateDualSuppliesList();
                    console.log('‚úÖ UI actualizada');
                    
                    // Cerrar modal de gas si est√° abierto
                    const gasModal = document.getElementById('gas-modal');
                    if (gasModal) {
                        gasModal.classList.add('hidden');
                    }
                    
                    // Ocultar TODAS las pantallas
                    hideAllScreens();
                    
                    // Volver a la pantalla DUAL
                    document.getElementById('screen-dual').classList.add('active');
                    
                    console.log('‚úÖ Usuario puede a√±adir m√°s suministros o calcular');
                    
                    return; // IMPORTANTE: Salir aqu√≠
                } catch (error) {
                    console.error('Error en modo DUAL para GAS:', error);
                    console.error('Error stack:', error.stack);
                    alert('Error al procesar el suministro de gas: ' + error.message);
                    backToDualManager();
                    return;
                }
            }
            
            // FLUJO NORMAL (no DUAL) - continuar con el procesamiento normal
            const container = document.getElementById('gas-results-container');
            
            // Ordenar por mejor ahorro
            results.sort((a, b) => b.ahorro_anual - a.ahorro_anual);
            
            // NUEVO: Detectar si NO hay ahorro en ninguna tarifa
            const bestSaving = results.length > 0 ? results[0].ahorro_anual : 0;
            const noSavings = bestSaving <= 0;
            
            let html = '';
            
            // NUEVO: Si no hay ahorro, mostrar mensaje especial
            if (noSavings) {
                html += `
                <div class="mb-6 p-6 border-4 border-red-500 bg-red-50 rounded-2xl">
                    <div class="text-center mb-6">
                        <h3 class="text-3xl font-black text-red-600 mb-4"${tr("LA MEJOR OPCI√ìN PARA TI ES")}</h3>
                        <h2 class="text-5xl font-black text-red-700 mb-3">Tu Tarifa Actual</h2>
                        <p class="text-lg text-red-600 font-semibold">Es la mejor opci√≥n detectada</p>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl border-2 border-red-200">
                        <h4 class="text-2xl font-bold text-red-600 mb-3 text-center">¬°ENHORABUENA!</h4>
                        <p class="text-lg leading-tight font-bold text-red-700 text-center mb-3">Actualmente est√°s en una buena tarifa.</p>
                        <p class="text-base text-red-600 text-center leading-relaxed">Seguiremos estudiando el mercado y te avisaremos cuando encontremos alguna tarifa que se adapte a tu perfil de consumo.</p>
                    </div>
                    
                    <div class="mt-6 p-4 bg-red-100 rounded-xl">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-red-800">TU COSTE ACTUAL CONSOLIDADO</span>
                        </div>
                        <div class="flex justify-between items-center text-2xl">
                            <span class="font-bold text-red-700">Total factura:</span>
                            <span class="font-bold text-red-700">${totalCliente.toFixed(2)} ‚Ç¨</span>
                        </div>
                        <div class="flex justify-between items-center mt-2 text-xl">
                            <span class="font-bold text-red-700">Estimaci√≥n anual:</span>
                            <span class="font-bold text-red-700">${(totalCliente * 365 / dias).toFixed(2)} ‚Ç¨/a√±o</span>
                        </div>
                    </div>
                </div>
                `;
                
                // Mostrar bot√≥n "SOLICITAR MEJORA A DRK" para GAS
                const gasImprovementContainer = document.getElementById('gas-request-improvement-container');
                if (gasImprovementContainer) {
                    gasImprovementContainer.style.display = 'block';
                }
                
            } else {
                // HAY AHORRO: Mostrar comparativo normal
                
                // Ocultar bot√≥n de solicitar mejora para GAS
                const gasImprovementContainer = document.getElementById('gas-request-improvement-container');
                if (gasImprovementContainer) {
                    gasImprovementContainer.style.display = 'none';
                }
                
                results.forEach((result, index) => {
                    const isPositiveSaving = result.ahorro_anual > 0;
                    const savingClass = isPositiveSaving ? 'text-green-600' : 'text-red-600';
                    
                    html += `
                    <div class="mb-6 p-4 border-2 ${isPositiveSaving ? 'border-green-200 bg-green-50' : 'border-slate-200'} rounded-xl">
                        <h3 class="text-xl font-bold text-drk-900 mb-2">${result.name}</h3>
                        <p class="text-sm text-slate-600 mb-4">${result.descripcion}</p>
                    
                    <table class="w-full text-sm">
                        <tr class="border-b">
                            <td class="py-2">T√©rmino fijo (${dias} d√≠as)</td>
                            <td class="text-right font-bold">${result.total_fijo.toFixed(2)} ‚Ç¨</td>
                        </tr>
                        ${result.p_fijo_descuento > 0 ? `
                        <tr class="border-b text-green-600">
                            <td class="py-2 pl-4">‚Ü≥ Descuento potencia</td>
                            <td class="text-right font-bold">-${(dias * result.p_fijo_descuento).toFixed(2)} ‚Ç¨</td>
                        </tr>
                        ` : ''}
                        <tr class="border-b">
                            <td class="py-2">Energ√≠a (${kwh} kWh)</td>
                            <td class="text-right font-bold">${result.total_energia.toFixed(2)} ‚Ç¨</td>
                        </tr>
                        ${result.p1_descuento > 0 ? `
                        <tr class="border-b text-green-600">
                            <td class="py-2 pl-4">‚Ü≥ Descuento energ√≠a</td>
                            <td class="text-right font-bold">-${(kwh * result.p1_descuento).toFixed(2)} ‚Ç¨</td>
                        </tr>
                        ` : ''}
                        <tr class="border-b">
                            <td class="py-2">Impuesto hidrocarburos</td>
                            <td class="text-right">${result.impuesto_hidrocarburo.toFixed(2)} ‚Ç¨</td>
                        </tr>
                        <tr class="border-b">
                            <td class="py-2">IVA (21%)</td>
                            <td class="text-right">${result.iva.toFixed(2)} ‚Ç¨</td>
                        </tr>
                        <tr class="border-t-2 border-drk-500 font-bold text-lg">
                            <td class="py-2">TOTAL</td>
                            <td class="text-right">${result.total.toFixed(2)} ‚Ç¨</td>
                        </tr>
                    </table>
                    
                    <div class="mt-4 p-3 bg-slate-100 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="font-bold">Tu factura actual:</span>
                            <span class="font-bold">${totalCliente.toFixed(2)} ‚Ç¨</span>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <span class="font-bold">Con esta tarifa:</span>
                            <span class="font-bold">${result.total.toFixed(2)} ‚Ç¨</span>
                        </div>
                        <div class="flex justify-between items-center mt-2 text-lg ${savingClass}">
                            <span class="font-bold">Ahorro mensual:</span>
                            <span class="font-bold">${isPositiveSaving ? '+' : ''}${result.ahorro_mensual.toFixed(2)} ‚Ç¨</span>
                        </div>
                        <div class="flex justify-between items-center mt-1 text-xl ${savingClass}">
                            <span class="font-bold">Ahorro anual:</span>
                            <span class="font-bold">${isPositiveSaving ? '+' : ''}${result.ahorro_anual.toFixed(2)} ‚Ç¨</span>
                        </div>
                    </div>
                </div>
                `;
            });
            
            } // FIN del else (cuando HAY ahorro)
            
            // GUARDAR DATOS PARA EXPORTAR (NUEVO)
            const comparisonMode = document.querySelector('input[name="comparison_mode"]:checked')?.value || 'drk_only';
            window.gasExportData = { results, dias, kwh, totalCliente, comparisonMode };
            console.log('üíæ Guardando gasExportData:', {results: results.map(r => ({name: r.name, ahorro: r.ahorro_anual})), comparisonMode});
            
            // NUEVO: Guardar resultado para solicitud de mejora cuando no hay ahorro
            if (noSavings) {
                window.lastGasComparisonResult = {
                    isGas: true,
                    results: results,
                    dias: dias,
                    kwh: kwh,
                    totalCliente: totalCliente,
                    tariffType: currentGasTariff,
                    bestSaving: bestSaving
                };
                console.log('üíæ Guardando lastGasComparisonResult para solicitud de mejora:', window.lastGasComparisonResult);
            }
            
            // NUEVO: Guardar resultados para DUAL
            // Identificar si hay DRK y PowerCup
            let drkResult = null;
            let powercupResult = null;
            
            results.forEach(r => {
                const name = (r.name || '').toUpperCase();
                if (name.includes('INDEX')) {
                    powercupResult = r;
                } else {
                    drkResult = r;
                }
            });
            
            // Si no se identificaron correctamente, usar el primer resultado para DRK
            if (!drkResult && results.length > 0) {
                drkResult = results[0];
            }
            
            // Guardar en variables globales
            window.lastGasDRKResult = drkResult ? {
                total: drkResult.total,
                total_anual: drkResult.total_anual
            } : { total: 0, total_anual: 0 };
            
            window.lastGasPowerCupResult = powercupResult ? {
                total: powercupResult.total,
                total_anual: powercupResult.total_anual
            } : { total: 0, total_anual: 0 };
            
            console.log('üíæ Guardando para DUAL:', {
                drk: window.lastGasDRKResult,
                powercup: window.lastGasPowerCupResult
            });
            
            // AGREGAR BOTONES DE EXPORTAR (solo si HAY ahorro)
            if (!noSavings) {
                html += `
                    <div class="mt-8 p-6 bg-gradient-to-r from-slate-50 to-slate-100 rounded-xl border-2 border-slate-200">
                        <h3 class="text-xl font-bold text-drk-900 mb-4 text-center">üì§ Exportar Presentaci√≥n</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Bot√≥n PDF -->
                            <button
                                onclick="generateGasPDF()"
                                class="flex items-center justify-center gap-3 px-6 py-4 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600 transition shadow-lg"
                            >
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                </svg>
                                <span>Generar PDF</span>
                            </button>
                            
                            <!-- Bot√≥n HTML -->
                            <button
                                onclick="generateGasHTML()"
                                class="flex items-center justify-center gap-3 px-6 py-4 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition shadow-lg"
                            >
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                                <span>Generar HTML para Email</span>
                            </button>
                        </div>
                        
                        <p class="text-xs text-slate-500 text-center mt-4">
                            Genera documentos profesionales para presentar al cliente
                        </p>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            // Mostrar pantalla de resultados
            hideAllScreens();
            document.getElementById('screen-gas-results').classList.add('active');
            
            // Detectar modo DUAL y mostrar bot√≥n si corresponde (para flujo no-DUAL)
            if (window.checkDualMode) window.checkDualMode();
        }
        
        // ===== FUNCIONES DE B√öSQUEDA (filtran DOM sin re-renderizar) =====
        
        function applyGasSearch() {
            const searchInput = document.getElementById('gas-search-input');
            if (!searchInput) return;
            
            const searchText = searchInput.value.toLowerCase();
            const checkboxes = document.querySelectorAll('.gas-tariff-checkbox');
            let visibleCount = 0;
            let totalCount = checkboxes.length;
            
            checkboxes.forEach(checkbox => {
                const label = checkbox.closest('label');
                if (!label) return;
                
                const name = label.querySelector('.font-bold')?.textContent.toLowerCase() || '';
                const desc = label.querySelector('.text-sm.text-slate-600')?.textContent.toLowerCase() || '';
                
                if (searchText === '' || name.includes(searchText) || desc.includes(searchText)) {
                    label.style.display = '';
                    visibleCount++;
                } else {
                    label.style.display = 'none';
                }
            });
            
            // Actualizar contador
            const countEl = document.getElementById('gas-search-count');
            if (countEl) {
                if (searchText === '') {
                    countEl.textContent = '';
                } else {
                    countEl.textContent = `Mostrando ${visibleCount} de ${totalCount} tarifas`;
                }
            }
        }
        
        function clearGasSearch() {
            const searchInput = document.getElementById('gas-search-input');
            if (searchInput) {
                searchInput.value = '';
                applyGasSearch();
            }
        }
        
        // ========== FUNCIONES DE EXPORTACI√ìN PDF PARA GAS ==========
        
        async function generateGasPDF() {
            if (!window.gasExportData) {
                alert(window.tr('No hay datos para exportar'));
                return;
            }
            
            // Detectar si est√° en chino
            const currentLang = window.LANG ? window.LANG.getCurrentLang() : 'es';
            const wasChineseMode = currentLang === 'zh';
            
            // IMPORTANTE: Pedir datos PRIMERO (en el idioma actual, chino si corresponde)
            const comercialCode = prompt(window.tr('C√ìDIGO COMERCIAL (Obligatorio):'), 'D=00');
            if (!comercialCode || comercialCode.trim() === '') {
                alert(window.tr('El c√≥digo comercial es obligatorio'));
                return;
            }
            
            const clientName = prompt(window.tr('NOMBRE DEL CLIENTE:'), window.tr('[NOMBRE COMPLETO CLIENTE]')) || window.tr('[NOMBRE COMPLETO CLIENTE]');
            
            // AHORA S√ç: Si est√° en chino, cambiar temporalmente a ingl√©s para el PDF
            if (wasChineseMode) {
                console.log('üá®üá≥ Idioma chino detectado - cambiando a ingl√©s para PDF');
                // Informar al usuario en chino e ingl√©s
                alert('üá®üá≥ ÁîüÊàêPDFÊñá‰ª∂‰∏≠...\n‰∏∫‰∫ÜÁ°Æ‰øùÂ≠óÁ¨¶Ê≠£Á°ÆÊòæÁ§∫ÔºåPDFÂ∞Ü‰ΩøÁî®Ëã±ËØ≠ÁîüÊàê„ÄÇ\n\nüá¨üáß Generating PDF...\nTo ensure correct character display, the PDF will be generated in English.');
                // Cambiar temporalmente a ingl√©s
                window.LANG.change('en', true); // skipReload = true
            }
            
            const { results, dias, kwh, totalCliente, comparisonMode } = window.gasExportData;
            
            try {
                // Detectar si es POWER CUP o DRK basado en comparisonMode
                const isPowerCup = comparisonMode === 'overall_best';
                
                const isDual = results.length === 2 && 
                              results.some(r => r.name.toUpperCase().includes('INDEX')) &&
                              results.some(r => !r.name.toUpperCase().includes('INDEX'));
                
                if (isDual) {
                    const resIndexed = results.find(r => r.name.toUpperCase().includes('INDEX'));
                    const resFijo = results.find(r => !r.name.toUpperCase().includes('INDEX'));
                    
                    if (isPowerCup) {
                        await generateGasPDF_Dual_PowerCup(resFijo, resIndexed, dias, kwh, totalCliente, clientName, comercialCode);
                    } else {
                        await generateGasPDF_Dual(resFijo, resIndexed, dias, kwh, totalCliente, clientName, comercialCode);
                    }
                } else {
                    if (isPowerCup) {
                        await generateGasPDF_Simple_PowerCup(results[0], dias, kwh, totalCliente, clientName, comercialCode);
                    } else {
                        await generateGasPDF_Simple(results[0], dias, kwh, totalCliente, clientName, comercialCode);
                    }
                }
                
                // NUEVO: Restaurar idioma chino despu√©s de generar el PDF
                if (wasChineseMode) {
                    setTimeout(() => {
                        console.log('üá®üá≥ Restaurando idioma chino');
                        window.LANG.change('zh', true);
                    }, 1000);
                }
            } catch (error) {
                console.error('Error generando PDF:', error);
                window.showMessageModal("‚ùå Error: " + error.message, false);
                
                // Restaurar idioma si hubo error
                if (wasChineseMode) {
                    window.LANG.change('zh', true);
                }
            }
        }
        
        async function generateGasHTML() {
            if (!window.gasExportData) {
                window.showMessageModal("‚ö†Ô∏è No hay datos para exportar", false);
                return;
            }
            
            const { results, dias, kwh, totalCliente } = window.gasExportData;
            console.log('üìß Generando HTML - results:', results.map(r => ({name: r.name, ahorro: r.ahorro_anual})));
            
            // Detectar si es modo comparativo (Fija vs Indexada)
            const isComparisonMode = document.getElementById('gas-compare-indexed-fixed') && 
                                     document.getElementById('gas-compare-indexed-fixed').checked;
            
            if (isComparisonMode && results.length === 2) {
                // Modo comparativo: mostrar ambas tarifas lado a lado
                generateGasHTMLComparison(results, dias, kwh, totalCliente);
            } else {
                // Modo individual: mostrar solo la mejor tarifa
                generateGasHTMLSingle(results[0], dias, kwh, totalCliente);
            }
        }
        
        // Funci√≥n espec√≠fica para generar HTML en CHINO (GAS - Tarifa √∫nica)
        function generateGasHTMLSingle_Chinese(result, dias, kwh, totalCliente, isDrk, primaryColor, accentColor, brandName) {
            const eur = n => new Intl.NumberFormat('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(n || 0) + ' ‚Ç¨';
            const num = (n, d=6) => new Intl.NumberFormat('es-ES', {minimumFractionDigits: d, maximumFractionDigits: d}).format(n || 0);
            
            const tariffName = result.descripcion ? `${result.name} - ${result.descripcion}` : result.name;
            const ahorroAnual = result.ahorro_anual;
            const facturaActualAnio = totalCliente * 365 / dias;
            const nuevoAnio = result.total * 365 / dias;
            const nuevoMes = result.total * 30 / dias;
            
            const htmlContent = `
            <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; background: white;">
                
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white;">
                    <tr>
                        <td style="padding: 30px 40px;">
                            <h1 style="margin: 0; font-size: 32px; font-weight: bold;">${brandName} ËÉΩÊ∫ê</h1>
                            <p style="margin: 8px 0 0 0; font-size: 14px;">ÂºïÈ¢ÜËäÇÁúÅÂíåËÉΩÊ∫êÊïàÁéá</p>
                        </td>
                        <td style="padding: 30px 40px; text-align: right;">
                            <p style="margin: 0; font-size: 14px; font-weight: bold;">ËäÇÁúÅÁ†îÁ©∂</p>
                            <p style="margin: 4px 0 0 0; font-size: 16px; font-weight: bold;">‰∏ì‰∏öÊØîËæÉ</p>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${accentColor}; color: white;">
                    <tr>
                        <td style="padding: 15px 40px; text-align: center;">
                            <h2 style="margin: 0; font-size: 20px; font-weight: bold;">ËäÇÁúÅÁ†îÁ©∂ - Â§©ÁÑ∂Ê∞î</h2>
                            <p style="margin: 4px 0 0 0; font-size: 14px;">‰∏ì‰∏öÊØîËæÉ - ${brandName}</p>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 20px;">
                    <tr>
                        <td style="padding: 30px 40px; text-align: center;">
                            <p style="margin: 0 0 10px 0; font-size: 16px;">ÊúÄÈÄÇÂêàÊÇ®ÁöÑÈÄâÈ°πÊòØ</p>
                            <h2 style="margin: 0; font-size: 36px; font-weight: bold;">${tariffName}</h2>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 20px;">
                    <tr>
                        <td style="padding: 20px 40px; text-align: center;">
                            <p style="margin: 0 0 10px 0; font-size: 16px; color: #666; font-weight: bold;">ÊÇ®ÁöÑÈ¢ÑËÆ°Âπ¥Â∫¶ËäÇÁúÅ‰∏∫Ôºö</p>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${accentColor}; border-radius: 12px; margin: 0 40px; width: calc(100% - 80px);">
                    <tr>
                        <td style="padding: 30px; text-align: center;">
                            <h1 style="margin: 0; font-size: 48px; font-weight: bold; color: white;">${eur(ahorroAnual)}</h1>
                            <p style="margin: 10px 0 0 0; font-size: 18px; color: white; font-weight: bold;">ÂÆûÁé∞ÊÇ®ÁöÑÂπ¥Â∫¶ËäÇÁúÅÔºÅ</p>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 30px;">
                    <tr>
                        <td style="width: 48%; padding: 20px; border: 2px solid #e0e0e0; text-align: center;">
                            <p style="margin: 0 0 15px 0; font-size: 14px; color: #888; font-weight: bold;">ÊÇ®ÂΩìÂâçÁöÑË¥¶Âçï</p>
                            <h2 style="margin: 0; font-size: 32px; font-weight: bold; color: #dc2626; text-decoration: line-through;">${eur(facturaActualAnio)}</h2>
                            <p style="margin: 8px 0 0 0; font-size: 14px; color: #666;">/ Âπ¥</p>
                        </td>
                        <td style="width: 4%;"></td>
                        <td style="width: 48%; padding: 20px; border: 2px solid #e0e0e0; text-align: center;">
                            <p style="margin: 0 0 15px 0; font-size: 14px; color: #888; font-weight: bold;">ÊÇ®ÁöÑÊñ∞${brandName}ÊàêÊú¨</p>
                            <h2 style="margin: 0; font-size: 32px; font-weight: bold; color: ${primaryColor};">${eur(nuevoAnio)}</h2>
                            <p style="margin: 8px 0 0 0; font-size: 14px; color: #666;">/ Âπ¥</p>
                            <p style="margin: 8px 0 0 0; font-size: 16px; color: ${primaryColor}; font-weight: bold;">${eur(nuevoMes)} / Êúà</p>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 30px;">
                    <tr>
                        <td style="padding: 15px 40px;">
                            <h3 style="margin: 0; font-size: 16px; font-weight: bold;">‰ª∑Ê†ºÊëòË¶Å</h3>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="border: 1px solid #e0e0e0; border-top: none;">
                    <tr style="background-color: #f5f5f5;">
                        <td style="padding: 12px 40px; font-weight: bold; font-size: 14px;">Ê¶ÇÂøµ</td>
                        <td style="padding: 12px 40px; font-weight: bold; font-size: 14px; text-align: right;">${brandName}‰ª∑Ê†º</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px 40px; border-top: 1px solid #e0e0e0; font-size: 13px;">Âõ∫ÂÆö‰ª∑Ê†º (‚Ç¨/Â§©)</td>
                        <td style="padding: 10px 40px; border-top: 1px solid #e0e0e0; font-size: 13px; text-align: right;">${num(result.p_fijo_diario / 365)}</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px 40px; border-top: 1px solid #e0e0e0; font-size: 13px;">ËÉΩÊ∫ê (‚Ç¨/kWh)</td>
                        <td style="padding: 10px 40px; border-top: 1px solid #e0e0e0; font-size: 13px; text-align: right;">${num(result.p1_price)}</td>
                    </tr>
                    <tr style="background-color: #f0fdf4;">
                        <td style="padding: 12px 40px; border-top: 2px solid ${accentColor}; font-weight: bold; font-size: 14px;">Âπ¥Â∫¶ËäÇÁúÅ</td>
                        <td style="padding: 12px 40px; border-top: 2px solid ${accentColor}; font-weight: bold; font-size: 14px; text-align: right; color: #16a34a;">${eur(ahorroAnual)}</td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 30px;">
                    <tr>
                        <td style="padding: 15px 40px;">
                            <h3 style="margin: 0; font-size: 16px; font-weight: bold;">ËØ¶ÁªÜÊòéÁªÜ (${tariffName})</h3>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="border: 1px solid #e0e0e0; border-top: none;">
                    <tr>
                        <td style="padding: 15px 40px;" colspan="2">
                            <p style="margin: 0 0 10px 0; font-size: 15px; font-weight: bold; color: ${primaryColor};">Âõ∫ÂÆöÊúüÈôêÔºà‚Ç¨/Â§©Ôºâ</p>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 40px; padding-left: 60px; font-size: 13px;">Âõ∫ÂÆö‰ª∑Ê†º (${dias} Â§© x ${num(result.p_fijo_diario / 365)})</td>
                        <td style="padding: 8px 40px; font-size: 13px; text-align: right; font-weight: bold;">${eur(result.total_fijo)}</td>
                    </tr>
                    <tr style="background-color: #f9f9f9;">
                        <td style="padding: 10px 40px; font-size: 14px; font-weight: bold;">Â∞èËÆ°ÂäüÁéá</td>
                        <td style="padding: 10px 40px; font-size: 14px; text-align: right; font-weight: bold;">${eur(result.total_fijo)}</td>
                    </tr>
                    
                    <tr>
                        <td style="padding: 15px 40px; padding-top: 20px;" colspan="2">
                            <p style="margin: 0 0 10px 0; font-size: 15px; font-weight: bold; color: ${primaryColor};">ËÉΩÊ∫êÊúüÈôêÔºà‚Ç¨/kWhÔºâ</p>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 40px; padding-left: 60px; font-size: 13px;">ËÉΩÊ∫ê (${kwh} kWh x ${num(result.p1_price)})</td>
                        <td style="padding: 8px 40px; font-size: 13px; text-align: right; font-weight: bold;">${eur(result.total_energia)}</td>
                    </tr>
                    <tr style="background-color: #f9f9f9;">
                        <td style="padding: 10px 40px; font-size: 14px; font-weight: bold;">Â∞èËÆ°ËÉΩÊ∫êÔºàÊØõÈ¢ùÔºâ</td>
                        <td style="padding: 10px 40px; font-size: 14px; text-align: right; font-weight: bold;">${eur(result.total_energia)}</td>
                    </tr>
                    
                    <tr>
                        <td style="padding: 15px 40px; padding-top: 20px; font-size: 15px; font-weight: bold; color: ${primaryColor};" colspan="2">Â∞èËÆ°Âü∫Á°Ä (P+E)</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 40px; padding-left: 60px; font-size: 13px;">Á¢≥Ê∞¢ÂåñÂêàÁâ©Á®é (‚Ç¨0,00234 x ${kwh} kWh)</td>
                        <td style="padding: 8px 40px; font-size: 13px; text-align: right;">${eur(result.impuesto_hidrocarburo)}</td>
                    </tr>
                    <tr style="background-color: #f9f9f9;">
                        <td style="padding: 10px 40px; font-size: 14px; font-weight: bold;">Â∫îÁ®éÂü∫Á°Ä</td>
                        <td style="padding: 10px 40px; font-size: 14px; text-align: right; font-weight: bold;">${eur(result.total_fijo + result.total_energia + result.impuesto_hidrocarburo)}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 40px; padding-left: 60px; font-size: 13px;">Â¢ûÂÄºÁ®é (21%)</td>
                        <td style="padding: 8px 40px; font-size: 13px; text-align: right;">${eur(result.iva)}</td>
                    </tr>
                    <tr style="background-color: ${primaryColor}; color: white;">
                        <td style="padding: 15px 40px; font-size: 16px; font-weight: bold;">ÊÄªËÆ°Ë¥¶Âçï (${dias} Â§©)</td>
                        <td style="padding: 15px 40px; font-size: 16px; text-align: right; font-weight: bold;">${eur(result.total)}</td>
                    </tr>
                    <tr style="background-color: #f0f0f0;">
                        <td style="padding: 12px 40px; font-size: 14px; font-weight: bold;">Âπ¥Â∫¶ÊÄªËÆ°ÔºàÈ¢ÑËÆ°Ôºâ</td>
                        <td style="padding: 12px 40px; font-size: 14px; text-align: right; font-weight: bold;">${eur(nuevoAnio)}</td>
                    </tr>
                </table>
                
            </div>
            `;
            
            showHTMLPreview(htmlContent);
        }
        
        // Funci√≥n para generar HTML individual (una sola tarifa)
        function generateGasHTMLSingle(result, dias, kwh, totalCliente) {
            const eur = n => new Intl.NumberFormat('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(n || 0) + ' ‚Ç¨';
            const num = (n, d=6) => new Intl.NumberFormat('es-ES', {minimumFractionDigits: d, maximumFractionDigits: d}).format(n || 0);
            
            // Determinar marca (DRK o POWER CUP)
            const comparisonMode = document.querySelector('input[name="comparison_mode"]:checked').value;
            const isDrk = (comparisonMode === 'drk_only' || comparisonMode === 'drk_prioritized');
            
            // Colores seg√∫n marca
            const primaryColor = isDrk ? '#3b5875' : '#4d7c0f';
            const accentColor = isDrk ? '#4a90e2' : '#84cc16';
            const lightBg = isDrk ? '#e8f4fd' : '#f0fdf4';
            const brandName = isDrk ? 'DRK' : 'POWER CUP';
            
            // NUEVO: Detectar si est√° en chino y llamar a versi√≥n espec√≠fica
            const currentLang = window.LANG ? window.LANG.getCurrentLang() : 'es';
            if (currentLang === 'zh') {
                generateGasHTMLSingle_Chinese(result, dias, kwh, totalCliente, isDrk, primaryColor, accentColor, brandName);
                return;
            }
            
            const tariffName = result.descripcion ? `${result.name} - ${result.descripcion}` : result.name;
            console.log('üîç DEBUG HTML GAS - tariffName:', tariffName, 'result completo:', result);
            const ahorroAnual = result.ahorro_anual;
            const ahorroMensual = result.ahorro_mensual;
            
            // Calcular valores anuales y mensuales
            const facturaActualMes = totalCliente * 30 / dias;
            const facturaActualAnio = totalCliente * 365 / dias;
            const nuevoMes = result.total * 30 / dias;
            const nuevoAnio = result.total * 365 / dias;
            
            const htmlContent = `
            <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; background: white;">
                
                <!-- HEADER -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white;">
                    <tr>
                        <td style="padding: 30px 40px;">
                            <h1 style="margin: 0; font-size: 32px; font-weight: bold;">${brandName} ENERG√çA</h1>
                            <p style="margin: 8px 0 0 0; font-size: 14px;">${tr('Liderando el ahorro y la eficiencia energ√©tica.')}</p>
                        </td>
                        <td style="padding: 30px 40px; text-align: right;">
                            <p style="margin: 0; font-size: 14px; font-weight: bold;">${tr('ESTUDIO DE AHORRO')}</p>
                            <p style="margin: 4px 0 0 0; font-size: 16px; font-weight: bold;">${tr('COMPARATIVA PROFESIONAL')}</p>
                        </td>
                    </tr>
                </table>
                
                <!-- BANNER ESTUDIO DE AHORRO -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${accentColor}; color: white;">
                    <tr>
                        <td style="padding: 15px 40px; text-align: center;">
                            <h2 style="margin: 0; font-size: 20px; font-weight: bold;">${tr('ESTUDIO DE AHORRO')} - GAS</h2>
                            <p style="margin: 4px 0 0 0; font-size: 14px;">${tr('COMPARATIVA PROFESIONAL')} - ${brandName}</p>
                        </td>
                    </tr>
                </table>
                
                <!-- DATOS DEL CLIENTE -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: white; border: 1px solid #e0e0e0; margin-top: 20px;">
                    <tr>
                        <td style="padding: 20px 40px;">
                            <p style="margin: 0 0 8px 0; font-size: 14px;"><strong${tr("CLIENTE:")}</strong> [NOMBRE COMPLETO CLIENTE]</p>
                            <p style="margin: 0 0 8px 0; font-size: 14px;"><strong${tr("CUPS:")}</strong> ES0021000020679723GY</p>
                            <p style="margin: 0; font-size: 14px;"><strong${tr("COMERCIAL:")}</strong> zdvxzc</p>
                        </td>
                    </tr>
                </table>
                
                <!-- LA MEJOR OPCI√ìN -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 20px;">
                    <tr>
                        <td style="padding: 30px 40px; text-align: center;">
                            <p style="margin: 0 0 10px 0; font-size: 16px;"${tr("LA MEJOR OPCI√ìN PARA TI ES")}</p>
                            <h2 style="margin: 0; font-size: 36px; font-weight: bold;">${tariffName}</h2>
                        </td>
                    </tr>
                </table>
                
                <!-- TU AHORRO ANUAL -->
                <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 20px;">
                    <tr>
                        <td style="padding: 20px 40px; text-align: center;">
                            <p style="margin: 0 0 10px 0; font-size: 16px; color: #666; font-weight: bold;">${tr('TU AHORRO ANUAL ESTIMADO ES:')}</p>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${accentColor}; border-radius: 12px; margin: 0 40px; width: calc(100% - 80px);">
                    <tr>
                        <td style="padding: 30px; text-align: center;">
                            <h1 style="margin: 0; font-size: 48px; font-weight: bold; color: white;">${eur(ahorroAnual)}</h1>
                            <p style="margin: 10px 0 0 0; font-size: 18px; color: white; font-weight: bold;">${tr('¬°CONSIGUE TU AHORRO ANUAL!')}</p>
                        </td>
                    </tr>
                </table>
                
                <!-- COMPARATIVA FACTURA ACTUAL VS NUEVO COSTE -->
                <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 30px;">
                    <tr>
                        <td style="width: 48%; padding: 20px; border: 2px solid #e0e0e0; text-align: center; vertical-align: top;">
                            <p style="margin: 0 0 15px 0; font-size: 14px; color: #888; font-weight: bold;">${tr("TU FACTURA ACTUAL")}</p>
                            <h2 style="margin: 0; font-size: 32px; font-weight: bold; color: #dc2626; text-decoration: line-through;">${eur(facturaActualAnio)}</h2>
                            <p style="margin: 8px 0 0 0; font-size: 14px; color: #666;">${tr('/a√±o')}</p>
                        </td>
                        <td style="width: 4%;"></td>
                        <td style="width: 48%; padding: 20px; border: 2px solid #e0e0e0; text-align: center; vertical-align: top;">
                            <p style="margin: 0 0 15px 0; font-size: 14px; color: #888; font-weight: bold;">${tr('TU NUEVO COSTE')} ${brandName}</p>
                            <h2 style="margin: 0; font-size: 32px; font-weight: bold; color: ${primaryColor};">${eur(nuevoAnio)}</h2>
                            <p style="margin: 8px 0 0 0; font-size: 14px; color: #666;">${tr('/a√±o')}</p>
                            <p style="margin: 8px 0 0 0; font-size: 16px; color: ${primaryColor}; font-weight: bold;">${eur(nuevoMes)} ${tr('/mes')}</p>
                        </td>
                    </tr>
                </table>
                
                <!-- RESUMEN DE PRECIOS -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 30px;">
                    <tr>
                        <td style="padding: 15px 40px;">
                            <h3 style="margin: 0; font-size: 16px; font-weight: bold;">${tr('RESUMEN DE PRECIOS DE LA OFERTA √öNICA')}</h3>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="border: 1px solid #e0e0e0; border-top: none;">
                    <tr style="background-color: #f5f5f5;">
                        <td style="padding: 12px 40px; font-weight: bold; font-size: 14px;">CONCEPTO</td>
                        <td style="padding: 12px 40px; font-weight: bold; font-size: 14px; text-align: right;">PRECIO ${brandName}</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px 40px; border-top: 1px solid #e0e0e0; font-size: 13px;">Precio fijo (‚Ç¨/d√≠a)</td>
                        <td style="padding: 10px 40px; border-top: 1px solid #e0e0e0; font-size: 13px; text-align: right;">${num(result.p_fijo_diario / 365)}</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px 40px; border-top: 1px solid #e0e0e0; font-size: 13px;">Energ√≠a (‚Ç¨/kWh)</td>
                        <td style="padding: 10px 40px; border-top: 1px solid #e0e0e0; font-size: 13px; text-align: right;">${num(result.p1_price)}</td>
                    </tr>
                    <tr style="background-color: #f0fdf4;">
                        <td style="padding: 12px 40px; border-top: 2px solid ${accentColor}; font-weight: bold; font-size: 14px;">AHORRO ANUAL</td>
                        <td style="padding: 12px 40px; border-top: 2px solid ${accentColor}; font-weight: bold; font-size: 14px; text-align: right; color: #16a34a;">${eur(ahorroAnual)}</td>
                    </tr>
                </table>
                
                <!-- DESGLOSE DETALLADO -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 30px;">
                    <tr>
                        <td style="padding: 15px 40px;">
                            <h3 style="margin: 0; font-size: 16px; font-weight: bold;">${tr('DESGLOSE DETALLADO DE LA SIMULACI√ìN')} (${tariffName})</h3>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="border: 1px solid #e0e0e0; border-top: none;">
                    <tr>
                        <td style="padding: 15px 40px;" colspan="2">
                            <p style="margin: 0 0 10px 0; font-size: 15px; font-weight: bold; color: ${primaryColor};">T√âRMINO FIJO (Precio en ‚Ç¨/d√≠a)</p>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 40px; padding-left: 60px; font-size: 13px;">Precio fijo (${dias} d√≠as x ${num(result.p_fijo_diario / 365)})</td>
                        <td style="padding: 8px 40px; font-size: 13px; text-align: right; font-weight: bold;">${eur(result.total_fijo)}</td>
                    </tr>
                    <tr style="background-color: #f9f9f9;">
                        <td style="padding: 10px 40px; font-size: 14px; font-weight: bold;"${tr("SUBTOTAL POTENCIA")}</td>
                        <td style="padding: 10px 40px; font-size: 14px; text-align: right; font-weight: bold;">${eur(result.total_fijo)}</td>
                    </tr>
                    
                    <tr>
                        <td style="padding: 15px 40px; padding-top: 20px;" colspan="2">
                            <p style="margin: 0 0 10px 0; font-size: 15px; font-weight: bold; color: ${primaryColor};">T√âRMINO ENERG√çA (Precio en ‚Ç¨/kWh)</p>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 40px; padding-left: 60px; font-size: 13px;">Energ√≠a (${kwh} kWh x ${num(result.p1_price)})</td>
                        <td style="padding: 8px 40px; font-size: 13px; text-align: right; font-weight: bold;">${eur(result.total_energia)}</td>
                    </tr>
                    <tr style="background-color: #f9f9f9;">
                        <td style="padding: 10px 40px; font-size: 14px; font-weight: bold;"${tr("Subtotal Energ√≠a (Bruto)")}</td>
                        <td style="padding: 10px 40px; font-size: 14px; text-align: right; font-weight: bold;">${eur(result.total_energia)}</td>
                    </tr>
                    
                    <tr>
                        <td style="padding: 15px 40px; padding-top: 20px; font-size: 15px; font-weight: bold; color: ${primaryColor};" colspan="2"${tr("SUBTOTAL BASE (P+E)")}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 40px; padding-left: 60px; font-size: 13px;">Imp. Hidrocarburos (‚Ç¨0,00234 x ${kwh} kWh)</td>
                        <td style="padding: 8px 40px; font-size: 13px; text-align: right;">${eur(result.impuesto_hidrocarburo)}</td>
                    </tr>
                    <tr style="background-color: #f9f9f9;">
                        <td style="padding: 10px 40px; font-size: 14px; font-weight: bold;"${tr("BASE IMPONIBLE")}</td>
                        <td style="padding: 10px 40px; font-size: 14px; text-align: right; font-weight: bold;">${eur(result.total_fijo + result.total_energia + result.impuesto_hidrocarburo)}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 40px; padding-left: 60px; font-size: 13px;">IVA (21%)</td>
                        <td style="padding: 8px 40px; font-size: 13px; text-align: right;">${eur(result.iva)}</td>
                    </tr>
                    <tr style="background-color: ${primaryColor}; color: white;">
                        <td style="padding: 15px 40px; font-size: 16px; font-weight: bold;">TOTAL FACTURA (${dias} D√çAS)</td>
                        <td style="padding: 15px 40px; font-size: 16px; text-align: right; font-weight: bold;">${eur(result.total)}</td>
                    </tr>
                    <tr style="background-color: #f0f0f0;">
                        <td style="padding: 12px 40px; font-size: 14px; font-weight: bold;"${tr("TOTAL A√ëO (PROYECTADO)")}</td>
                        <td style="padding: 12px 40px; font-size: 14px; text-align: right; font-weight: bold;">${eur(nuevoAnio)}</td>
                    </tr>
                </table>
                
                <!-- RESUMEN DE AHORRO FINAL -->
                <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 30px;">
                    <tr>
                        <td style="padding: 20px 40px; text-align: center;">
                            <h2 style="margin: 0 0 20px 0; font-size: 24px; color: #333;">${tr('RESUMEN DE AHORRO FINAL')}</h2>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${lightBg}; border: 2px solid ${accentColor}; border-radius: 12px; margin: 0 40px 30px 40px; width: calc(100% - 80px);">
                    <tr>
                        <td style="padding: 30px; text-align: center;">
                            <p style="margin: 0 0 15px 0; font-size: 16px; color: #666;">${tr('TU AHORRO ANUAL ESTIMADO ES:')}</p>
                            <h1 style="margin: 0; font-size: 42px; font-weight: bold; color: #16a34a;">${eur(ahorroAnual)}</h1>
                            <p style="margin: 10px 0 0 0; font-size: 14px; color: #666;">${tr('/ A√ëO')}</p>
                        </td>
                    </tr>
                </table>
                
                <!-- PARA CONFIRMAR ESTA OFERTA -->
                <table width="100%" cellpadding="0" cellspacing="0" style="border: 3px solid ${primaryColor}; border-radius: 12px; margin: 30px 40px; width: calc(100% - 80px);">
                    <tr>
                        <td style="padding: 30px; text-align: center;">
                            <p style="margin: 0 0 20px 0; font-size: 18px; font-weight: bold; color: ${primaryColor};">${tr('üìß Para confirmar esta oferta:')}</p>
                            <ol style="text-align: left; display: inline-block; font-size: 14px; line-height: 1.8; color: #333;">
                                <li>${tr('Haz clic en el bot√≥n de abajo')}</li>
                                <li>${tr('Se abrir√° tu cliente de email')}</li>
                                <li><strong style="color: ${primaryColor};">${tr('Adjunta la documentaci√≥n requerida')}</strong></li>
                                <li>${tr('Env√≠a el email')}</li>
                            </ol>
                            
                            <table cellpadding="0" cellspacing="0" style="margin: 20px auto;">
                                <tr>
                                    <td style="background-color: #dc2626; border-radius: 8px; text-align: center;">
                                        <a href="mailto:contratacion@example.com?subject=Confirmaci√≥n Oferta GAS - ${tariffName}&body=Adjunto documentaci√≥n requerida para confirmar la oferta." style="display: inline-block; padding: 15px 40px; color: white; text-decoration: none; font-weight: bold; font-size: 16px;">
                                            ${tr('‚úÖ CONFIRMAR Y ENVIAR')}
                                        </a>
                                    </td>
                                </tr>
                            </table>
                            
                            <p style="margin: 20px 0 0 0; font-size: 12px; color: #888;">üìé <strong>Documentaci√≥n necesaria:</strong><br>DNI/CIF ¬∑ √öltima factura ¬∑ Email ¬∑ Tel√©fono ¬∑ IBAN</p>
                        </td>
                    </tr>
                </table>
                
                <!-- FOOTER -->
                <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 30px; padding: 20px 40px; background-color: #f5f5f5;">
                    <tr>
                        <td style="text-align: center; font-size: 12px; color: #888;">
                            <p style="margin: 0;">[Colaborador: zdvxzc] | Este resumen es una simulaci√≥n basada en su √∫ltima factura.</p>
                        </td>
                    </tr>
                </table>
                
            </div>
            `;
            
            showHTMLPreview(htmlContent);
        }
        
        // Funci√≥n para generar HTML comparativo (Fija vs Indexada)
        function generateGasHTMLComparison(results, dias, kwh, totalCliente) {
            const eur = n => new Intl.NumberFormat('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(n || 0) + ' ‚Ç¨';
            const num = (n, d=6) => new Intl.NumberFormat('es-ES', {minimumFractionDigits: d, maximumFractionDigits: d}).format(n || 0);
            
            // Determinar marca (DRK o POWER CUP)
            const comparisonMode = document.querySelector('input[name="comparison_mode"]:checked').value;
            const isDrk = (comparisonMode === 'drk_only' || comparisonMode === 'drk_prioritized');
            
            // Colores seg√∫n marca
            const primaryColor = isDrk ? '#3b5875' : '#4d7c0f';
            const accentColor = isDrk ? '#4a90e2' : '#84cc16';
            const lightBg = isDrk ? '#e8f4fd' : '#f0fdf4';
            const brandName = isDrk ? 'DRK' : 'POWER CUP';
            
            // Identificar cu√°l es fija y cu√°l indexada
            const resFijo = results.find(r => r.name.includes('FIJO') || r.name.includes('META')) || results[0];
            const resIndexed = results.find(r => r.name.includes('INDEX')) || results[1];
            
            console.log('üîç DEBUG HTML GAS COMPARATIVO - resFijo.name:', resFijo.name, 'resIndexed.name:', resIndexed.name);
            
            // Calcular valores anuales
            const facturaActualAnio = totalCliente * 365 / dias;
            
            const htmlContent = `
            <div style="font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; background: white;">
                
                <!-- HEADER -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white;">
                    <tr>
                        <td style="padding: 30px 40px;">
                            <h1 style="margin: 0; font-size: 32px; font-weight: bold;">${brandName} ENERG√çA</h1>
                            <p style="margin: 8px 0 0 0; font-size: 14px;">${tr('Liderando el ahorro y la eficiencia energ√©tica.')}</p>
                        </td>
                        <td style="padding: 30px 40px; text-align: right;">
                            <p style="margin: 0; font-size: 14px; font-weight: bold;">${tr('ESTUDIO DE AHORRO')}</p>
                            <p style="margin: 4px 0 0 0; font-size: 16px; font-weight: bold;">${tr('COMPARATIVA PROFESIONAL')}</p>
                        </td>
                    </tr>
                </table>
                
                <!-- SECCI√ìN 1: LA MEJOR OPCI√ìN Y COMPARATIVA 3 COLUMNAS -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 20px;">
                    <tr>
                        <td style="padding: 25px 40px; text-align: center;">
                            <p style="margin: 0 0 10px 0; font-size: 16px;"${tr("LA MEJOR OPCI√ìN PARA TI ES")}</p>
                            <h2 style="margin: 0; font-size: 36px; font-weight: bold;">${brandName}</h2>
                            <p style="margin: 10px 0 0 0; font-size: 14px;">${tr('Ofrece el mayor ahorro consolidado con')} ${brandName}.</p>
                        </td>
                    </tr>
                </table>
                
                <!-- COMPARATIVA 3 COLUMNAS: FACTURA ACTUAL vs FIJO vs INDEXADO -->
                <table width="100%" cellpadding="20" cellspacing="0" style="margin-top: 30px;">
                    <tr>
                        <!-- COLUMNA 1: FACTURA ACTUAL -->
                        <td style="width: 30%; vertical-align: top; text-align: center;">
                            <p style="margin: 0 0 15px 0; font-size: 13px; color: #888; font-weight: bold;"${tr("TU FACTURA ACTUAL")}</p>
                            <h2 style="margin: 0; font-size: 24px; font-weight: bold; color: #dc2626; text-decoration: line-through;">${eur(totalCliente)}</h2>
                            <p style="margin: 8px 0; font-size: 11px; color: #888;"${tr("Total Periodo")}</p>
                            <h2 style="margin: 0; font-size: 22px; font-weight: bold; color: #dc2626; text-decoration: line-through;">${eur(facturaActualAnio)}/a√±o</h2>
                        </td>
                        
                        <!-- COLUMNA 2: AHORRO FIJO -->
                        <td style="width: 35%; vertical-align: top;">
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${accentColor}; border-radius: 8px;">
                                <tr>
                                    <td style="padding: 10px; text-align: center; color: white;">
                                        <p style="margin: 0; font-size: 11px; font-weight: bold;">${tr("TU AHORRO ANUAL FIJO")}</p>
                                    </td>
                                </tr>
                            </table>
                            <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 10px;">
                                <tr>
                                    <td style="text-align: center;">
                                        <h2 style="margin: 0; font-size: 28px; font-weight: bold; color: #16a34a;">${eur(resFijo.ahorro_anual)}</h2>
                                    </td>
                                </tr>
                            </table>
                            <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 10px;">
                                <tr>
                                    <td style="text-align: center;">
                                        <p style="margin: 0 0 5px 0; font-size: 11px; color: #666;">${tr('TU NUEVO COSTE')} ${brandName}</p>
                                        <p style="margin: 0; font-size: 18px; font-weight: bold; color: ${primaryColor};">${eur(resFijo.total * 30 / dias)}${tr("/mes")}</p>
                                        <p style="margin: 5px 0 0 0; font-size: 10px; color: #888;"${tr("Estimado Mensual")}</p>
                                        <p style="margin: 5px 0 0 0; font-size: 16px; font-weight: bold; color: ${primaryColor};">${eur(resFijo.total * 365 / dias)}${tr("/a√±o")}</p>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        
                        <!-- COLUMNA 3: AHORRO INDEXADO -->
                        <td style="width: 35%; vertical-align: top;">
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #16a34a; border-radius: 8px;">
                                <tr>
                                    <td style="padding: 10px; text-align: center; color: white;">
                                        <p style="margin: 0; font-size: 11px; font-weight: bold;">${tr("TU AHORRO ANUAL INDEXADO")}</p>
                                    </td>
                                </tr>
                            </table>
                            <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 10px;">
                                <tr>
                                    <td style="text-align: center;">
                                        <h2 style="margin: 0; font-size: 28px; font-weight: bold; color: #16a34a;">${eur(resIndexed.ahorro_anual)}</h2>
                                    </td>
                                </tr>
                            </table>
                            <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 10px;">
                                <tr>
                                    <td style="text-align: center;">
                                        <p style="margin: 0 0 5px 0; font-size: 11px; color: #666;">${tr('TU NUEVO COSTE')} ${brandName}</p>
                                        <p style="margin: 0; font-size: 18px; font-weight: bold; color: #16a34a;">${eur(resIndexed.total * 30 / dias)}${tr("/mes")}</p>
                                        <p style="margin: 5px 0 0 0; font-size: 10px; color: #888;"${tr("Estimado Mensual")}</p>
                                        <p style="margin: 5px 0 0 0; font-size: 16px; font-weight: bold; color: #16a34a;">${eur(resIndexed.total * 365 / dias)}${tr("/a√±o")}</p>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
                
                <!-- SECCI√ìN 2: DESGLOSE DETALLADO POR SUMINISTRO -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 40px;">
                    <tr>
                        <td style="padding: 15px 40px; text-align: center;">
                            <h2 style="margin: 0; font-size: 18px; font-weight: bold;">DESGLOSE DETALLADO POR SUMINISTRO</h2>
                        </td>
                    </tr>
                </table>
                
                <!-- COMPARATIVA LADO A LADO -->
                <table width="100%" cellpadding="20" cellspacing="0" style="margin-top: 20px;">
                    <tr>
                        <!-- COLUMNA IZQUIERDA: FIJA -->
                        <td style="width: 48%; vertical-align: top;">
                            
                            <!-- Header Fija -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; border-radius: 8px; margin-bottom: 15px;">
                                <tr>
                                    <td style="padding: 15px;">
                                        <p style="margin: 0 0 5px 0; font-size: 11px;">[ES0021000020679723GY]</p>
                                        <p style="margin: 0 0 5px 0; font-size: 13px; font-weight: bold;">Tipo: 2.0TD | D√≠as: ${dias}</p>
                                        <p style="margin: 0; font-size: 12px; font-weight: bold;">${resFijo.descripcion ? resFijo.name + ' - ' + resFijo.descripcion : resFijo.name}</p>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- Precios Aplicados Fija -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #6c7a89; color: white; margin-bottom: 10px;">
                                <tr>
                                    <td style="padding: 10px; font-size: 12px; font-weight: bold;">PRECIOS APLICADOS:</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f8fafc; padding: 10px; border: 1px solid #e0e0e0;">
                                <tr>
                                    <td style="font-size: 11px; font-weight: bold; padding: 5px;">POTENCIA:</td>
                                </tr>
                                <tr>
                                    <td style="font-size: 10px; padding: 2px 5px;">P1: ${num(resFijo.p_fijo_diario / 365)} ‚Ç¨/kW/d√≠a</td>
                                </tr>
                                <tr>
                                    <td style="font-size: 11px; font-weight: bold; padding: 5px; padding-top: 10px;">ENERG√çA:</td>
                                </tr>
                                <tr>
                                    <td style="font-size: 10px; padding: 2px 5px;">E1: ${num(resFijo.p1_price)} ‚Ç¨/kWh</td>
                                </tr>
                            </table>
                            
                            <!-- Desglose Fija -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #6c7a89; color: white; margin-top: 10px;">
                                <tr>
                                    <td style="padding: 10px; font-size: 12px; font-weight: bold;">POTENCIA</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f8fafc; border: 1px solid #e0e0e0; border-top: none;">
                                <tr>
                                    <td style="padding: 8px; font-size: 11px;">Precio fijo (${dias} d√≠as)</td>
                                    <td style="padding: 8px; font-size: 11px; text-align: right; font-weight: bold;">${eur(resFijo.total_fijo)}</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #6c7a89; color: white; margin-top: 10px;">
                                <tr>
                                    <td style="padding: 10px; font-size: 12px; font-weight: bold;">ENERG√çA</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f8fafc; border: 1px solid #e0e0e0; border-top: none;">
                                <tr>
                                    <td style="padding: 8px; font-size: 11px;">Energ√≠a (${kwh} kWh)</td>
                                    <td style="padding: 8px; font-size: 11px; text-align: right; font-weight: bold;">${eur(resFijo.total_energia)}</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 10px;">
                                <tr>
                                    <td style="padding: 12px; font-size: 13px; font-weight: bold;">TOTAL (${dias} D√çAS)</td>
                                    <td style="padding: 12px; font-size: 13px; text-align: right; font-weight: bold;">${eur(resFijo.total)}</td>
                                </tr>
                            </table>
                            
                            <!-- Ahorro Anual Fija -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #dc2626; border-radius: 8px; margin-top: 15px;">
                                <tr>
                                    <td style="padding: 15px; text-align: center; color: white;">
                                        <p style="margin: 0 0 8px 0; font-size: 11px; font-weight: bold;">AHORRO:</p>
                                        <p style="margin: 0; font-size: 20px; font-weight: bold;">${eur(resFijo.ahorro_anual)}</p>
                                    </td>
                                </tr>
                            </table>
                            
                        </td>
                        
                        <!-- COLUMNA DERECHA: INDEXADA -->
                        <td style="width: 48%; vertical-align: top;">
                            
                            <!-- Header Indexada -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; border-radius: 8px; margin-bottom: 15px;">
                                <tr>
                                    <td style="padding: 15px;">
                                        <p style="margin: 0 0 5px 0; font-size: 11px;">[ES0021000020679723GY]</p>
                                        <p style="margin: 0 0 5px 0; font-size: 13px; font-weight: bold;">Tipo: 2.0TD | D√≠as: ${dias}</p>
                                        <p style="margin: 0; font-size: 12px; font-weight: bold;">${resIndexed.descripcion ? resIndexed.name + ' - ' + resIndexed.descripcion : resIndexed.name}</p>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- Precios Aplicados Indexada -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #6c7a89; color: white; margin-bottom: 10px;">
                                <tr>
                                    <td style="padding: 10px; font-size: 12px; font-weight: bold;">PRECIOS APLICADOS:</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f8fafc; padding: 10px; border: 1px solid #e0e0e0;">
                                <tr>
                                    <td style="font-size: 11px; font-weight: bold; padding: 5px;">POTENCIA:</td>
                                </tr>
                                <tr>
                                    <td style="font-size: 10px; padding: 2px 5px;">P1: ${num(resIndexed.p_fijo_diario / 365)} ‚Ç¨/kW/d√≠a</td>
                                </tr>
                                <tr>
                                    <td style="font-size: 11px; font-weight: bold; padding: 5px; padding-top: 10px;">ENERG√çA:</td>
                                </tr>
                                <tr>
                                    <td style="font-size: 10px; padding: 2px 5px;">E1: ${num(resIndexed.p1_price)} ‚Ç¨/kWh</td>
                                </tr>
                            </table>
                            
                            <!-- Desglose Indexada -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #6c7a89; color: white; margin-top: 10px;">
                                <tr>
                                    <td style="padding: 10px; font-size: 12px; font-weight: bold;">POTENCIA</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f8fafc; border: 1px solid #e0e0e0; border-top: none;">
                                <tr>
                                    <td style="padding: 8px; font-size: 11px;">Precio fijo (${dias} d√≠as)</td>
                                    <td style="padding: 8px; font-size: 11px; text-align: right; font-weight: bold;">${eur(resIndexed.total_fijo)}</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #6c7a89; color: white; margin-top: 10px;">
                                <tr>
                                    <td style="padding: 10px; font-size: 12px; font-weight: bold;">ENERG√çA</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f8fafc; border: 1px solid #e0e0e0; border-top: none;">
                                <tr>
                                    <td style="padding: 8px; font-size: 11px;">Energ√≠a (${kwh} kWh)</td>
                                    <td style="padding: 8px; font-size: 11px; text-align: right; font-weight: bold;">${eur(resIndexed.total_energia)}</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 10px;">
                                <tr>
                                    <td style="padding: 12px; font-size: 13px; font-weight: bold;">TOTAL (${dias} D√çAS)</td>
                                    <td style="padding: 12px; font-size: 13px; text-align: right; font-weight: bold;">${eur(resIndexed.total)}</td>
                                </tr>
                            </table>
                            
                            <!-- Ahorro Anual Indexada -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #dc2626; border-radius: 8px; margin-top: 15px;">
                                <tr>
                                    <td style="padding: 15px; text-align: center; color: white;">
                                        <p style="margin: 0 0 8px 0; font-size: 11px; font-weight: bold;">AHORRO:</p>
                                        <p style="margin: 0; font-size: 20px; font-weight: bold;">${eur(resIndexed.ahorro_anual)}</p>
                                    </td>
                                </tr>
                            </table>
                            
                        </td>
                    </tr>
                </table>
                
                <!-- SECCI√ìN 3: CUAL ES LA DIFERENCIA -->
                <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 40px;">
                    <tr>
                        <td style="padding: 20px 40px; text-align: center;">
                            <h2 style="margin: 0; font-size: 24px; font-weight: bold;">CUAL ES LA DIFERENCIA?</h2>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="20" cellspacing="0">
                    <tr>
                        <!-- COLUMNA IZQUIERDA: POR QUE TARIFA FIJA -->
                        <td style="width: 48%; vertical-align: top;">
                            <h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: bold; color: ${accentColor};">POR QUE TARIFA FIJA?</h3>
                            <ul style="margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.8; color: #333;">
                                <li>Implica un precio fijo por los kilovatios que consumes (kWh).</li>
                                <li>El precio se mantiene estable, independientemente de c√≥mo se comporten los precios en el mercado el√©ctrico.</li>
                                <li>Cuando el precio del mercado est√° alto, el cliente est√° protegido frente a sobresaltos.</li>
                                <li>No tendr√°s que estar pendiente de las variaciones del mercado y podr√°s seguir usando la electricidad como siempre.</li>
                            </ul>
                        </td>
                        
                        <!-- COLUMNA DERECHA: POR QUE TARIFA INDEXADA -->
                        <td style="width: 48%; vertical-align: top;">
                            <h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: bold; color: #16a34a;">POR QUE TARIFA INDEXADA?</h3>
                            <ul style="margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.8; color: #333;">
                                <li>Implica un precio variable por los kilovatios que consumes (kWh) cada mes.</li>
                                <li>Es la tarifa m√°s justa, ya que pagas el coste real de la energ√≠a mes a mes.</li>
                                <li>Al contratarla, el cliente evita pagar m√°rgenes adicionales cuando el precio de la electricidad es m√°s barato.</li>
                                <li>A largo plazo, con un indexado 100% funcional, se puede obtener un ahorro aproximado de hasta un 20% en √©pocas de mejor precio.</li>
                            </ul>
                        </td>
                    </tr>
                </table>
                
                <!-- SECCI√ìN 4: PARA FORMALIZAR ESTA OFERTA -->
                <table width="100%" cellpadding="0" cellspacing="0" style="border: 3px solid ${accentColor}; border-radius: 12px; margin: 30px 40px 40px 40px; width: calc(100% - 80px);">
                    <tr>
                        <td style="padding: 30px; text-align: center;">
                            <p style="margin: 0 0 20px 0; font-size: 18px; font-weight: bold; color: ${primaryColor};">${tr('üìß Para confirmar esta oferta:')}</p>
                            <ol style="text-align: left; display: inline-block; font-size: 14px; line-height: 2; color: #333; margin: 0 0 20px 0;">
                                <li>${tr('Haz clic en el bot√≥n de abajo')}</li>
                                <li>${tr('Se abrir√° tu cliente de email')}</li>
                                <li><strong style="color: ${primaryColor};">${tr('Adjunta la documentaci√≥n requerida')}</strong></li>
                                <li>${tr('Env√≠a el email')}</li>
                            </ol>
                            
                            <table cellpadding="0" cellspacing="0" style="margin: 20px auto;">
                                <tr>
                                    <td style="background-color: #dc2626; border-radius: 8px; text-align: center;">
                                        <a href="mailto:contratacion@example.com?subject=Confirmaci√≥n Oferta GAS Comparativa&body=Adjunto documentaci√≥n requerida." style="display: inline-block; padding: 15px 40px; color: white; text-decoration: none; font-weight: bold; font-size: 16px;">
                                            ${tr('‚úÖ CONFIRMAR Y ENVIAR')}
                                        </a>
                                    </td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f5f5f5; border-radius: 8px; margin-top: 20px;">
                                <tr>
                                    <td style="padding: 15px; text-align: center;">
                                        <p style="margin: 0; font-size: 11px; color: #888;">üìé Por cada CUPS adjuntar:</p>
                                        <p style="margin: 5px 0 0 0; font-size: 12px; color: #333;">DNI/CIF ¬∑ √öltima factura ¬∑ Email ¬∑ Tel√©fono ¬∑ IBAN</p>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
                
            </div>
            `;
            
            showHTMLPreview(htmlContent);
        }
        
        // Funci√≥n para mostrar el preview HTML y permitir copiar
        function showHTMLPreview(htmlContent) {
            // Detectar idioma actual
            const currentLang = window.LANG ? window.LANG.getCurrentLang() : 'es';
            const isChineseMode = currentLang === 'zh';
            
            // Crear modal si no existe
            let modal = document.getElementById('html-preview-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'html-preview-modal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: none; overflow: auto; padding: 20px;';
                document.body.appendChild(modal);
            }
            
            // Construir HTML seg√∫n idioma
            if (isChineseMode) {
                // MODO CHINO: Solo bot√≥n "Seleccionar Todo"
                modal.innerHTML = `
                    <div style="max-width: 900px; margin: 0 auto; position: relative;">
                        <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h2 style="margin: 0; color: #0c4a6e;">üìß HTMLÈÇÆ‰ª∂Ê†ºÂºè - Â§©ÁÑ∂Ê∞î</h2>
                                <button onclick="closeHTMLPreview()" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px;">‚úï ÂÖ≥Èó≠</button>
                            </div>
                            <p style="margin: 0 0 15px 0; color: #64748b; font-size: 14px; line-height: 1.6;">
                                <strong>üìã ËØ¥ÊòéÔºö</strong><br>
                                ÁÇπÂáªÊåâÈíÆÈÄâÊã©ÊâÄÊúâÂÜÖÂÆπÔºåÁÑ∂ÂêéÊåâCtrl+CÔºàWindows/LinuxÔºâÊàñCmd+CÔºàMacÔºâËøõË°åÂ§çÂà∂
                            </p>
                            <button onclick="selectAllContent()" style="background: #f59e0b; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; width: 100%;">
                                ‚ú® ÂÖ®ÈÄâ
                            </button>
                        </div>
                        
                        <!-- Preview del HTML -->
                        <div id="html-preview-content" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                            ${htmlContent}
                        </div>
                    </div>
                `;
            } else {
                // MODO NORMAL: Ambos botones (como estaba antes)
                modal.innerHTML = `
                    <div style="max-width: 900px; margin: 0 auto; position: relative;">
                        <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h2 style="margin: 0; color: #0c4a6e;">üìß HTML para Email - GAS</h2>
                                <button onclick="closeHTMLPreview()" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px;">‚úï Cerrar</button>
                            </div>
                            <p style="margin: 0 0 15px 0; color: #64748b; font-size: 14px; line-height: 1.6;">
                                <strong>üìã Instrucciones:</strong><br>
                                <span style="color: #16a34a; font-weight: bold;">OPCI√ìN 1:</span> Haz clic en "Copiar HTML" (autom√°tico)<br>
                                <span style="color: #f59e0b; font-weight: bold;">OPCI√ìN 2:</span> Si no funciona, usa "Seleccionar Todo" y luego Ctrl+C
                            </p>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <button onclick="copyHTMLToClipboard()" style="background: #0ea5e9; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">
                                    üìã Copiar HTML
                                </button>
                                <button onclick="selectAllContent()" style="background: #f59e0b; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">
                                    ‚ú® Seleccionar Todo
                                </button>
                            </div>
                        </div>
                        
                        <!-- Preview del HTML -->
                        <div id="html-preview-content" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                            ${htmlContent}
                        </div>
                    </div>
                `;
            }
            
            modal.style.display = 'block';
            
            // Guardar el HTML content para copiar
            window.currentHTMLContent = htmlContent;
        }
        
        // Funci√≥n para seleccionar todo el contenido
        window.selectAllContent = function() {
            const contentDiv = document.getElementById('html-preview-content');
            if (!contentDiv) return;
            
            const range = document.createRange();
            range.selectNodeContents(contentDiv);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            // Cambiar el bot√≥n para indicar que ya est√° seleccionado
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úÖ ¬°Seleccionado! Ahora Ctrl+C';
            btn.style.background = '#16a34a';
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '#f59e0b';
            }, 3000);
            
            // Mostrar alerta con instrucciones
            setTimeout(() => {
                alert('‚úÖ Contenido seleccionado\n\nüìã Ahora presiona:\n‚Ä¢ Ctrl+C (Windows/Linux)\n‚Ä¢ Cmd+C (Mac)\n\nLuego pega en tu correo con Ctrl+V');
            }, 100);
        };
        
        // Funci√≥n para cerrar el preview
        window.closeHTMLPreview = function() {
            const modal = document.getElementById('html-preview-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        };
        
        // Funci√≥n para copiar HTML al portapapeles
        window.copyHTMLToClipboard = async function() {
            try {
                const currentLang = localStorage.getItem('appLanguage') || 'es';
                let htmlContent;
                
                // NUEVO: Para CHINO, copiar directamente el DOM visible (ya traducido)
                if (currentLang === 'zh') {
                    console.log('üá®üá≥ Modo chino detectado - copiando DOM visible');
                    
                    // Detectar si estamos en pantalla de GAS o ELECTRICIDAD
                    const gasContainer = document.getElementById('gas-results-container');
                    const isGasScreen = gasContainer && gasContainer.innerHTML.trim().length > 100;
                    
                    if (isGasScreen) {
                        // ===== MODO GAS =====
                        console.log('üî• Pantalla GAS detectada');
                        
                        if (!gasContainer || gasContainer.innerHTML.trim().length < 100) {
                            alert('Ê≤°ÊúâË¶ÅÂ§çÂà∂ÁöÑÁªìÊûú / No results to copy');
                            return;
                        }
                        
                        // Crear HTML completo para GAS con estilos embebidos
                        htmlContent = `
                            <!DOCTYPE html>
                            <html lang="zh">
                            <head>
                                <meta charset="UTF-8">
                                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                                <title>DRK ËÉΩÊ∫ê - GAS ÊØîËæÉÁªìÊûú</title>
                                <style>
                                    body { font-family: Arial, sans-serif; padding: 20px; background: #f1f5f9; }
                                    .container { max-width: 900px; margin: 0 auto; }
                                    .header { background: linear-gradient(135deg, #f97316 0%, #dc2626 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
                                    .content { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
                                    h1 { margin: 0; font-size: 36px; font-weight: 900; }
                                    h2 { color: #1e293b; font-size: 24px; font-weight: bold; margin: 20px 0 10px 0; }
                                    h3 { color: #1e293b; font-size: 18px; font-weight: bold; border-left: 4px solid #f97316; padding-left: 12px; margin: 20px 0 10px 0; }
                                    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
                                    .text-sm { font-size: 14px; }
                                    .text-xs { font-size: 12px; }
                                    .font-bold { font-weight: bold; }
                                    .text-slate-500 { color: #64748b; }
                                    .text-slate-600 { color: #475569; }
                                    .text-slate-700 { color: #334155; }
                                    .text-slate-800 { color: #1e293b; }
                                    .text-slate-900 { color: #0f172a; }
                                    .text-green-600 { color: #16a34a; }
                                    .text-red-600 { color: #dc2626; }
                                    .text-orange-600 { color: #ea580c; }
                                    .border-t { border-top: 1px solid #e2e8f0; padding-top: 8px; margin-top: 8px; }
                                    .flex { display: flex; justify-content: space-between; margin-bottom: 4px; }
                                    .mono { font-family: 'Courier New', monospace; }
                                    .text-center { text-align: center; }
                                    .mb-2 { margin-bottom: 8px; }
                                    .mb-3 { margin-bottom: 12px; }
                                    .mb-4 { margin-bottom: 16px; }
                                    .mb-6 { margin-bottom: 24px; }
                                    .mt-4 { margin-top: 16px; }
                                    .p-4 { padding: 16px; }
                                    .p-6 { padding: 24px; }
                                    .rounded { border-radius: 8px; }
                                    .rounded-lg { border-radius: 10px; }
                                    .rounded-xl { border-radius: 12px; }
                                    .shadow { box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
                                    .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
                                    .bg-white { background-color: white; }
                                    .bg-slate-50 { background-color: #f8fafc; }
                                    .bg-orange-50 { background-color: #fff7ed; }
                                    .bg-green-50 { background-color: #f0fdf4; }
                                    .border { border: 1px solid #e2e8f0; }
                                    .border-2 { border: 2px solid #e2e8f0; }
                                    .border-orange-200 { border-color: #fed7aa; }
                                    .border-green-200 { border-color: #bbf7d0; }
                                </style>
                            </head>
                            <body>
                                <div class="container">
                                    <div class="header">
                                        <h1>üî• DRK ËÉΩÊ∫ê - GAS</h1>
                                        <p style="margin: 10px 0 0 0; opacity: 0.9; font-size: 18px;">ÁáÉÊ∞îÊØîËæÉÁªìÊûú / Gas Comparison Results</p>
                                    </div>
                                    <div class="content">
                                        ${gasContainer.innerHTML}
                                    </div>
                                </div>
                            </body>
                            </html>
                        `;
                    } else {
                        // ===== MODO ELECTRICIDAD =====
                        console.log('‚ö° Pantalla ELECTRICIDAD detectada');
                        
                        const resultCard = document.getElementById('result-card');
                        const detailsContainer = document.getElementById('details-container');
                        
                        if (!resultCard && !detailsContainer) {
                            alert('Ê≤°ÊúâË¶ÅÂ§çÂà∂ÁöÑÁªìÊûú / No results to copy');
                            return;
                        }
                        
                        // Crear HTML completo con estilos embebidos para ELECTRICIDAD
                        htmlContent = `
                            <!DOCTYPE html>
                            <html lang="zh">
                            <head>
                                <meta charset="UTF-8">
                                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                                <title>DRK ËÉΩÊ∫ê - ÊØîËæÉÁªìÊûú</title>
                                <style>
                                    body { font-family: Arial, sans-serif; padding: 20px; background: #f1f5f9; }
                                    .container { max-width: 800px; margin: 0 auto; }
                                    .header { background: linear-gradient(to right, #16a34a, #15803d); color: white; padding: 30px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
                                    .content { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
                                    h1 { margin: 0; font-size: 32px; font-weight: 900; }
                                    h2 { color: #1e293b; font-size: 24px; font-weight: bold; margin: 20px 0 10px 0; }
                                    h3 { color: #1e293b; font-size: 18px; font-weight: bold; border-left: 4px solid #16a34a; padding-left: 12px; margin: 20px 0 10px 0; }
                                    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
                                    .text-sm { font-size: 14px; }
                                    .text-xs { font-size: 12px; }
                                    .font-bold { font-weight: bold; }
                                    .text-slate-500 { color: #64748b; }
                                    .text-slate-700 { color: #334155; }
                                    .text-slate-800 { color: #1e293b; }
                                    .border-t { border-top: 1px solid #e2e8f0; padding-top: 8px; margin-top: 8px; }
                                    .flex { display: flex; justify-content: space-between; margin-bottom: 4px; }
                                    .mono { font-family: 'Courier New', monospace; }
                                    .text-center { text-align: center; }
                                    .mb-4 { margin-bottom: 16px; }
                                    .mb-6 { margin-bottom: 24px; }
                                    .p-6 { padding: 24px; }
                                    .rounded-xl { border-radius: 12px; }
                                    .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
                                </style>
                            </head>
                            <body>
                                <div class="container">
                                    <div class="header">
                                        <h1>DRK ËÉΩÊ∫ê</h1>
                                        <p style="margin: 10px 0 0 0; opacity: 0.9;">ÂºïÈ¢ÜËäÇÁúÅÂíåËÉΩÊ∫êÊïàÁéá</p>
                                    </div>
                                    ${resultCard ? `<div class="content">${resultCard.outerHTML}</div>` : ''}
                                    ${detailsContainer ? `<div class="content">${detailsContainer.outerHTML}</div>` : ''}
                                </div>
                            </body>
                            </html>
                        `;
                    }
                } else {
                    // Para otros idiomas, usar el HTML generado como antes
                    htmlContent = window.currentHTMLContent;
                }
                
                // M√âTODO 1: Intentar con ClipboardItem (navegadores modernos)
                try {
                    const blob = new Blob([htmlContent], { type: 'text/html' });
                    const clipboardItem = new ClipboardItem({
                        'text/html': blob
                    });
                    await navigator.clipboard.write([clipboardItem]);
                    
                    // Mostrar mensaje de √©xito (traducido)
                    const btn = event.target;
                    const originalText = btn.textContent;
                    
                    // Mensaje espec√≠fico para chino
                    if (currentLang === 'zh') {
                        btn.textContent = '‚úÖ Â∑≤Â§çÂà∂‰∏≠ÊñáHTMLÔºÅÁ≤òË¥¥Âà∞ÈÇÆ‰ª∂';
                        alert('‚úÖ ÊàêÂäüÔºÅ\n\n' +
                              'HTMLÂ∑≤Â§çÂà∂ÔºàÊâÄÊúâÊñáÊú¨Âùá‰∏∫‰∏≠ÊñáÔºâ\n' +
                              'HTML copied (all text in Chinese)\n\n' +
                              'ÊÇ®ÂèØ‰ª•Ôºö\n' +
                              'You can:\n' +
                              '‚Ä¢ Á≤òË¥¥Âà∞ÁîµÂ≠êÈÇÆ‰ª∂\n' +
                              '  Paste into email\n' +
                              '‚Ä¢ Âú®ÊµèËßàÂô®‰∏≠Êü•Áúã\n' +
                              '  View in browser\n' +
                              '‚Ä¢ ÊâìÂç∞‰∏∫PDF\n' +
                              '  Print as PDF\n\n' +
                              'Â¶ÇÈúÄÁîüÊàêPDFÊñá‰ª∂ÔºåËØ∑ÂàáÊç¢Âà∞Ëã±ËØ≠ üá¨üáß\n' +
                              'For PDF file, switch to English üá¨üáß');
                    } else {
                        btn.textContent = tr('‚úÖ ¬°Copiado! Pega en tu email');
                    }
                    
                    btn.style.background = '#16a34a';
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#0ea5e9';
                    }, 3000);
                    
                    return;
                } catch (clipboardError) {
                    console.log('ClipboardItem fall√≥, intentando m√©todo alternativo...');
                }
                
                // M√âTODO 2: Usar execCommand (m√°s compatible)
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;
                tempDiv.style.position = 'fixed';
                tempDiv.style.left = '-9999px';
                tempDiv.contentEditable = true;
                document.body.appendChild(tempDiv);
                
                // Seleccionar el contenido
                const range = document.createRange();
                range.selectNodeContents(tempDiv);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                
                // Copiar
                const success = document.execCommand('copy');
                
                // Limpiar
                selection.removeAllRanges();
                document.body.removeChild(tempDiv);
                
                if (success) {
                    // Mostrar mensaje de √©xito
                    const btn = event.target;
                    const originalText = btn.textContent;
                    
                    // Mensaje espec√≠fico para chino
                    if (currentLang === 'zh') {
                        btn.textContent = '‚úÖ Â∑≤Â§çÂà∂‰∏≠ÊñáHTMLÔºÅ';
                        alert('‚úÖ ÊàêÂäüÔºÅ\n\n' +
                              'HTMLÂ∑≤Â§çÂà∂ÔºàÊâÄÊúâÊñáÊú¨Âùá‰∏∫‰∏≠ÊñáÔºâ\n' +
                              'HTML copied (all text in Chinese)\n\n' +
                              'ÊÇ®ÂèØ‰ª•Ôºö\n' +
                              'You can:\n' +
                              '‚Ä¢ Á≤òË¥¥Âà∞ÁîµÂ≠êÈÇÆ‰ª∂\n' +
                              '  Paste into email\n' +
                              '‚Ä¢ Âú®ÊµèËßàÂô®‰∏≠Êü•Áúã\n' +
                              '  View in browser\n' +
                              '‚Ä¢ ÊâìÂç∞‰∏∫PDF\n' +
                              '  Print as PDF\n\n' +
                              'Â¶ÇÈúÄÁîüÊàêPDFÊñá‰ª∂ÔºåËØ∑ÂàáÊç¢Âà∞Ëã±ËØ≠ üá¨üáß\n' +
                              'For PDF file, switch to English üá¨üáß');
                    } else {
                        btn.textContent = tr('‚úÖ ¬°Copiado! Pega en tu email');
                    }
                    
                    btn.style.background = '#16a34a';
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#0ea5e9';
                    }, 3000);
                } else {
                    throw new Error('execCommand fall√≥');
                }
                
            } catch (err) {
                console.error('Error al copiar:', err);
                
                // Mostrar instrucciones al usuario
                alert('No se pudo copiar autom√°ticamente.\n\n‚úÖ SOLUCI√ìN:\n\n1. Haz clic derecho sobre el contenido abajo\n2. Selecciona "Copiar"\n3. Pega en tu correo electr√≥nico\n\nO usa Ctrl+A para seleccionar todo y luego Ctrl+C para copiar.');
            }
        };

        
        // PDF INDIVIDUAL
        async function generateGasPDF_Simple(bestResult, dias, kwh, totalCliente, clientName = '[NOMBRE COMPLETO CLIENTE]', comercialCode = 'D=00') {
            window.showMessageModal("‚è≥ Generando PDF... Por favor espere.");
            
            const { jsPDF } = window.jspdf;
            let doc = new jsPDF('p', 'mm', 'a4');
            
            // CR√çTICO: Activar traducci√≥n autom√°tica de textos
            if (window.setupPDFTranslation) {
                doc = window.setupPDFTranslation(doc);
            }
            
            const comparisonMode = document.querySelector('input[name="comparison_mode"]:checked').value;
            const isDrk = (comparisonMode === 'drk_only' || comparisonMode === 'drk_prioritized');
            
            const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            
            const pageWidth = 210;
            const margin = 12;
            let yPos = 0;
            
            // === P√ÅGINA 1: RESUMEN ===
            
            // CABECERA con degradado gris azulado
            const headerHeight = 55;
            for (let i = 0; i < pageWidth; i++) {
                const ratio = i / pageWidth;
                const r = Math.round(107 + (180 - 107) * ratio);
                const g = Math.round(125 + (190 - 125) * ratio);
                const b = Math.round(142 + (200 - 142) * ratio);
                doc.setFillColor(r, g, b);
                doc.rect(i, 0, 1, headerHeight, 'F');
            }
            
            // Logo DRK (anillo multicolor)
            const logoX = margin + 15;
            const logoY = 18;
            const logoRadius = 8;
            
            doc.setFillColor(219, 68, 55);
            doc.circle(logoX - 1.5, logoY + 1.5, logoRadius * 0.8, 'F');
            doc.setFillColor(66, 133, 244);
            doc.circle(logoX + 1.5, logoY - 1.5, logoRadius * 0.8, 'F');
            doc.setFillColor(244, 180, 0);
            doc.circle(logoX - 1.5, logoY - 1.5, logoRadius * 0.7, 'F');
            doc.setFillColor(15, 157, 88);
            doc.circle(logoX + 1.5, logoY + 1.5, logoRadius * 0.7, 'F');
            doc.setFillColor(255, 255, 255);
            doc.circle(logoX, logoY, logoRadius * 0.4, 'F');
            
            // Texto DRK ENERG√çA
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(24);
            doc.text('DRK', logoX + logoRadius + 6, logoY - 4);
            doc.text('ENERG√çA', logoX + logoRadius + 6, logoY + 5);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text(tr('Liderando el ahorro y la'), logoX + logoRadius + 6, logoY + 13);
            doc.text(tr('eficiencia energ√©tica.'), logoX + logoRadius + 6, logoY + 18);
            
            // Texto derecha
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(40, 60, 80);
            doc.text(tr('ESTUDIO DE AHORRO'), pageWidth - margin, 15, { align: 'right' });
            doc.setFontSize(16);
            doc.setTextColor(255, 255, 255);
            doc.text('COMPARATIVA', pageWidth - margin, 25, { align: 'right' });
            doc.setFontSize(12);
            doc.setTextColor(100, 120, 140);
            doc.text('PROFESIONAL', pageWidth - margin, 35, { align: 'right' });
            
            yPos = headerHeight + 8;
            
            // CAJA VERDE "ESTUDIO DE AHORRO"
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 10, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text(tr('ESTUDIO DE AHORRO'), margin + 5, yPos + 7);
            
            yPos += 12;
            
            // Info del cliente (caja con borde)
            doc.setDrawColor(76, 175, 80);
            doc.setLineWidth(1.5);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 22, 2, 2, 'S');
            
            doc.setTextColor(75, 85, 99);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('COMPARATIVA PROFESIONAL GAS - DRK', margin + 5, yPos + 7);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text(tr('CLIENTE:') + ' ' + clientName, margin + 5, yPos + 13);
            doc.text('TARIFA: ' + currentGasTariff, margin + 5, yPos + 18);
            
            doc.setFont('helvetica', 'bold');
            doc.text('COMERCIAL: zdc', pageWidth - margin - 45, yPos + 13);
            
            yPos += 28;
            
            // CAJA GRIS "LA MEJOR OPCI√ìN"
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 35, 3, 3, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(11);
            doc.text(tr('LA MEJOR OPCI√ìN PARA TI ES'), pageWidth / 2, yPos + 10, { align: 'center' });
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(20);
            doc.text(bestResult.name.toUpperCase(), pageWidth / 2, yPos + 20, { align: 'center' });
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text(bestResult.descripcion, pageWidth / 2, yPos + 28, { align: 'center' });
            
            yPos += 42;
            
            // AHORRO ANUAL
            doc.setFillColor(255, 255, 255);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 35, 2, 2, 'F');
            
            doc.setTextColor(100, 120, 140);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text(tr('TU AHORRO ANUAL ESTIMADO'), pageWidth / 2, yPos + 8, { align: 'center' });
            
            doc.setTextColor(76, 175, 80);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(36);
            doc.text(eur(bestResult.ahorro_anual), pageWidth / 2, yPos + 25, { align: 'center' });
            
            yPos += 40;
            
            // COMPARATIVA ACTUAL VS NUEVA
            const colWidth = (pageWidth - (2 * margin) - 10) / 2;
            
            // Izquierda: Factura actual
            doc.setTextColor(100, 120, 140);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text(tr('TU FACTURA ACTUAL'), margin + colWidth / 2, yPos, { align: 'center' });
            
            doc.setTextColor(220, 38, 38);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            const facturaActualMes = totalCliente * 30 / dias;
            doc.text(eur(facturaActualMes) + tr('/mes'), margin + colWidth / 2, yPos + 10, { align: 'center' });
            
            // L√≠nea tachada
            const textWidth = doc.getTextWidth(eur(facturaActualMes) + tr('/mes'));
            doc.setDrawColor(220, 38, 38);
            doc.setLineWidth(1.2);
            doc.line(
                margin + (colWidth - textWidth) / 2,
                yPos + 7,
                margin + (colWidth + textWidth) / 2,
                yPos + 7
            );
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.text(tr('Total Periodo') + ' (' + dias + ' ' + tr('d√≠as') + ')', margin + colWidth / 2, yPos + 16, { align: 'center' });
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            const facturaActualAnio = totalCliente * 365 / dias;
            doc.text(eur(facturaActualAnio) + tr('/a√±o'), margin + colWidth / 2, yPos + 24, { align: 'center' });
            
            const textWidth2 = doc.getTextWidth(eur(facturaActualAnio) + tr('/a√±o'));
            doc.line(
                margin + (colWidth - textWidth2) / 2,
                yPos + 21,
                margin + (colWidth + textWidth2) / 2,
                yPos + 21
            );
            
            // Derecha: Nuevo coste
            doc.setTextColor(100, 120, 140);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text(tr('TU NUEVO COSTE DRK'), margin + colWidth + 10 + colWidth / 2, yPos, { align: 'center' });
            
            doc.setTextColor(59, 130, 246);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            const nuevaCosteMes = bestResult.total * 30 / dias;
            doc.text(eur(nuevaCosteMes) + tr('/mes'), margin + colWidth + 10 + colWidth / 2, yPos + 10, { align: 'center' });
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.text(tr('Estimado Mensual'), margin + colWidth + 10 + colWidth / 2, yPos + 16, { align: 'center' });
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            const nuevaCosteAnio = bestResult.total * 365 / dias;
            doc.text(eur(nuevaCosteAnio) + tr('/a√±o'), margin + colWidth + 10 + colWidth / 2, yPos + 24, { align: 'center' });
            
            yPos += 32;
            
            // PRECIOS DE LA OFERTA
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 10, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('PRECIOS DE LA OFERTA: DRK - ' + bestResult.descripcion.toUpperCase(), margin + 5, yPos + 7);
            
            yPos += 13;
            
            // TABLA PRECIOS
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 35, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('T√âRMINO FIJO:', margin + 5, yPos + 8);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text('Precio fijo diario (‚Ç¨/d√≠a):', margin + 10, yPos + 15);
            doc.text(num(bestResult.p_fijo_diario / 365, 6), pageWidth - margin - 5, yPos + 15, { align: 'right' });
            
            yPos += 20;
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('ENERG√çA:', margin + 5, yPos);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text('Precio energ√≠a (‚Ç¨/kWh):', margin + 10, yPos + 7);
            doc.text(num(bestResult.p1_price, 6), pageWidth - margin - 5, yPos + 7, { align: 'right' });
            
            // === P√ÅGINA 2: DESGLOSE ===
            doc.addPage();
            yPos = 15;
            
            // T√≠tulo verde
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 12, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text(tr('DESGLOSE DETALLADO DE LA SIMULACI√ìN') + ' (DRK - ' + bestResult.descripcion.toUpperCase() + ')', margin + 5, yPos + 8);
            
            yPos += 18;
            
            // T√âRMINO FIJO
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('T√âRMINO FIJO (Precio en ‚Ç¨/d√≠a)', margin, yPos);
            yPos += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            const p_fijo_diario = bestResult.p_fijo_diario / 365;
            doc.text(tr('Precio fijo') + ' (' + dias + ' ' + tr('d√≠as') + ' x ' + num(p_fijo_diario, 6) + ')', margin + 5, yPos);
            doc.text(eur(bestResult.total_fijo), pageWidth - margin - 5, yPos, { align: 'right' });
            yPos += 6;
            
            doc.setFont('helvetica', 'bold');
            doc.text(tr('SUBTOTAL POTENCIA'), margin + 5, yPos);
            doc.text(eur(bestResult.total_fijo), pageWidth - margin - 5, yPos, { align: 'right' });
            yPos += 10;
            
            // T√âRMINO ENERG√çA
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('T√âRMINO ENERG√çA (Precios en ‚Ç¨/kWh)', margin, yPos);
            yPos += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text('Energ√≠a (' + kwh + ' kWh x ' + num(bestResult.p1_price, 6) + ')', margin + 5, yPos);
            doc.text(eur(bestResult.total_energia), pageWidth - margin - 5, yPos, { align: 'right' });
            yPos += 6;
            
            doc.setFont('helvetica', 'bold');
            doc.text('Subtotal Energ√≠a (Bruto)', margin + 5, yPos);
            doc.text(eur(bestResult.total_energia), pageWidth - margin - 5, yPos, { align: 'right' });
            yPos += 10;
            
            // SUBTOTAL BASE
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            const subtotalBase = bestResult.total_fijo + bestResult.total_energia;
            doc.text('SUBTOTAL BASE (P+E)', margin, yPos);
            doc.text(eur(subtotalBase), pageWidth - margin - 5, yPos, { align: 'right' });
            yPos += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text('Imp. Hidrocarburos (‚Ç¨0,00234 x ' + kwh + ' kWh)', margin, yPos);
            doc.text(eur(bestResult.impuesto_hidrocarburo), pageWidth - margin - 5, yPos, { align: 'right' });
            yPos += 6;
            
            doc.setFont('helvetica', 'bold');
            doc.text(tr('BASE IMPONIBLE'), margin, yPos);
            doc.text(eur(subtotalBase + bestResult.impuesto_hidrocarburo), pageWidth - margin - 5, yPos, { align: 'right' });
            yPos += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.text(tr('IVA (21%)'), margin, yPos);
            doc.text(eur(bestResult.iva), pageWidth - margin - 5, yPos, { align: 'right' });
            yPos += 10;
            
            // TOTAL FACTURA
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(margin, yPos - 3, pageWidth - (2 * margin), 12, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text('TOTAL FACTURA (' + dias + ' D√çAS)', margin + 5, yPos + 5);
            doc.text(eur(bestResult.total), pageWidth - margin - 5, yPos + 5, { align: 'right' });
            
            yPos += 14;
            
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text(tr('TOTAL A√ëO (PROYECTADO)'), margin, yPos);
            doc.text(eur(bestResult.total * 365 / dias), pageWidth - margin - 5, yPos, { align: 'right' });
            
            yPos += 15;
            
            // AHORRO
            doc.setFillColor(211, 47, 47);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 25, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text(tr('TU AHORRO ANUAL ESTIMADO ES:'), margin + 5, yPos + 10);
            
            doc.setFontSize(20);
            doc.text(eur(bestResult.ahorro_anual) + tr('/ A√ëO'), margin + 5, yPos + 20);
            
            yPos += 35;
            
            // FORMALIZAR CONTRATO
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 60, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text(tr('PARA FORMALIZAR ESTE CONTRATO:'), margin + 5, yPos + 8);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text(tr('Responde a este email adjuntando la siguiente documentaci√≥n:'), margin + 5, yPos + 15);
            
            const docList = [
                tr('1. Foto del DNI/CIF (anverso y reverso)'),
                tr('2. √öltima factura (m√≠nimo 3 meses de antig√ºedad)'),
                tr('3. Email de contacto para validaci√≥n'),
                tr('4. Tel√©fono de contacto'),
                tr('5. N√∫mero de cuenta bancaria (IBAN)')
            ];
            
            let listY = yPos + 22;
            docList.forEach(item => {
                doc.text(item, margin + 8, listY);
                listY += 5;
            });
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text(tr('Env√≠a la documentaci√≥n al comercial:'), margin + 5, listY + 5);
            doc.setFontSize(11);
            doc.text('zdc', margin + 5, listY + 11);
            
            // Pie de p√°gina
            doc.setFont('helvetica', 'italic');
            doc.setFontSize(7);
            doc.setTextColor(120, 120, 120);
            doc.text(tr('Documento generado autom√°ticamente - DRK Energ√≠a'), pageWidth / 2, 285, { align: 'center' });
            doc.text('Fecha: ' + new Date().toLocaleDateString('es-ES'), pageWidth / 2, 290, { align: 'center' });
            
            // Descargar
            doc.save('Comparativa_GAS_' + currentGasTariff + '_DRK_' + new Date().toISOString().slice(0,10) + '.pdf');
            
            window.showMessageModal("‚úÖ PDF generado correctamente", false);
        }
        
        // PDF DUAL
        async function generateGasPDF_Dual(resFijo, resIndexed, dias, kwh, totalCliente, clientName = '[NOMBRE COMPLETO CLIENTE]', comercialCode = 'D=00') {
            window.showMessageModal("‚è≥ Generando PDF comparativo...");
            const { jsPDF } = window.jspdf;
            let doc = new jsPDF('p', 'mm', 'a4');
            
            // CR√çTICO: Activar traducci√≥n autom√°tica de textos
            if (window.setupPDFTranslation) {
                doc = window.setupPDFTranslation(doc);
            }
            
            const eur = n => new Intl.NumberFormat('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(n || 0) + ' ‚Ç¨';
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', {minimumFractionDigits: d, maximumFractionDigits: d}).format(n || 0);
            
            // P√ÅGINA 1: DISE√ëO PROFESIONAL BONITO
            const pageWidth = 210;
            const pageHeight = 297;
            let y = 0;
            
            // HEADER CON RAYAS VERTICALES (fondo gris con patr√≥n)
            doc.setFillColor(107, 125, 142);
            doc.rect(0, 0, pageWidth, 40, 'F');
            
            // Rayas verticales m√°s claras
            doc.setDrawColor(120, 140, 155);
            doc.setLineWidth(0.3);
            for (let i = 0; i < pageWidth; i += 2) {
                doc.line(i, 0, i, 40);
            }
            
            // Logo DRK multicolor (izquierda)
            const logoX = 25;
            const logoY = 20;
            const logoR = 8;
            doc.setFillColor(219, 68, 55); // Rojo
            doc.circle(logoX - 2, logoY + 2, logoR * 0.75, 'F');
            doc.setFillColor(66, 133, 244); // Azul
            doc.circle(logoX + 2, logoY - 2, logoR * 0.75, 'F');
            doc.setFillColor(244, 180, 0); // Amarillo
            doc.circle(logoX - 2, logoY - 2, logoR * 0.65, 'F');
            doc.setFillColor(15, 157, 88); // Verde
            doc.circle(logoX + 2, logoY + 2, logoR * 0.65, 'F');
            doc.setFillColor(255, 255, 255); // Centro blanco
            doc.circle(logoX, logoY, logoR * 0.35, 'F');
            
            // Texto DRK ENERG√çA (derecha del logo)
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(24);
            doc.text('DRK', logoX + 15, 16);
            doc.setFontSize(22);
            doc.text('ENERG√çA', logoX + 15, 25);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            doc.text(tr('Liderando el ahorro y la'), logoX + 15, 30);
            doc.text(tr('eficiencia energ√©tica.'), logoX + 15, 34);
            
            // Texto derecha del header
            doc.setTextColor(40, 60, 80);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text(tr('ESTUDIO DE AHORRO'), pageWidth - 12, 12, { align: 'right' });
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.text('COMPARATIVA', pageWidth - 12, 20, { align: 'right' });
            
            doc.setTextColor(100, 120, 140);
            doc.setFontSize(9);
            doc.text('PROFESIONAL', pageWidth - 12, 28, { align: 'right' });
            
            // === INFORMACI√ìN DEL CLIENTE (DISE√ëO PROFESIONAL) ===
            y = 50;
            
            // Barra superior verde
            doc.setFillColor(76, 175, 80); // Verde
            doc.roundedRect(12, y, 186, 8, 3, 3, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text(tr('ESTUDIO DE AHORRO'), 17, y + 5.5);
            
            // Caja blanca con borde
            doc.setFillColor(255, 255, 255);
            doc.setDrawColor(107, 125, 142);
            doc.setLineWidth(1);
            doc.roundedRect(12, y + 8, 186, 20, 3, 3, 'FD');
            
            // T√≠tulo principal
            doc.setTextColor(107, 125, 142);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(tr('COMPARATIVA PROFESIONAL') + ' - DRK', 17, y + 14);
            
            // Info del cliente
            doc.setTextColor(80, 80, 80);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text(`CLIENTE: ${clientName}`, 17, y + 20);
            doc.text(`CUPS: ${dualSupplies.length > 1 ? dualSupplies[0].cups.substring(0,20) + '...' : dualSupplies[0].cups}`, 17, y + 25);
            
            // Comercial en caja destacada (derecha)
            doc.setFillColor(240, 245, 248);
            doc.roundedRect(pageWidth - 12 - 45, y + 17, 45, 8, 2, 2, 'F');
            doc.setTextColor(107, 125, 142);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text(`COMERCIAL: ${comercialCode}`, pageWidth - 12 - 43, y + 22.5);
            
            y += 35;
            
            // CAJA GRIS "LA MEJOR OPCI√ìN"
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(40, y, 130, 38, 4, 4, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text(tr('LA MEJOR OPCI√ìN PARA TI ES'), pageWidth / 2, y + 10, { align: 'center' });
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(28);
            doc.text('DRK', pageWidth / 2, y + 24, { align: 'center' });
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.text(tr('Ofrece el mayor ahorro consolidado con') + ' DRK ENERG√çA.', pageWidth / 2, y + 33, { align: 'center' });
            
            y += 55;
            
            // C√ÅLCULOS
            const factMes = totalCliente * 30 / dias;
            const factAnio = totalCliente * 365 / dias;
            const fijoMes = resFijo.total * 30 / dias;
            const fijoAnio = resFijo.total * 365 / dias;
            const indexMes = resIndexed.total * 30 / dias;
            const indexAnio = resIndexed.total * 365 / dias;
            
            // LAYOUT 3 COLUMNAS CON SEPARADORES VERTICALES
            const col1X = 12;
            const col2X = 75;
            const col3X = 145;
            
            // L√≠neas separadoras verticales (muy suaves)
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.3);
            doc.line(70, y - 5, 70, y + 90);
            doc.line(140, y - 5, 140, y + 90);
            
            // COLUMNA 1: TU FACTURA ACTUAL (izquierda)
            doc.setTextColor(70, 80, 90);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text(tr('TU FACTURA ACTUAL'), col1X, y);
            
            y += 10;
            doc.setTextColor(220, 38, 38);
            doc.setFontSize(18);
            const txtMes = eur(factMes);
            doc.text(txtMes, col1X, y);
            
            // L√≠nea tachada
            const wMes = doc.getTextWidth(txtMes);
            doc.setDrawColor(220, 38, 38);
            doc.setLineWidth(1.8);
            doc.line(col1X, y - 5, col1X + wMes, y - 5);
            
            y += 6;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(6.5);
            doc.setTextColor(120, 130, 140);
            doc.text(tr('Total Periodo') + ' (' + dias + ' ' + tr('d√≠as') + ')', col1X, y);
            
            y += 10;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(15);
            doc.setTextColor(220, 38, 38);
            const txtAnio = eur(factAnio) + tr('/a√±o');
            doc.text(txtAnio, col1X, y);
            
            const wAnio = doc.getTextWidth(txtAnio);
            doc.setDrawColor(220, 38, 38);
            doc.setLineWidth(1.8);
            doc.line(col1X, y - 4, col1X + wAnio, y - 4);
            
            y -= 26;
            
            // COLUMNA 2: TU AHORRO ANUAL FIJO (centro)
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(col2X, y - 4, 60, 9, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(7.5);
            doc.text('TU AHORRO ANUAL FIJO', col2X + 30, y + 2, { align: 'center' });
            
            y += 12;
            doc.setTextColor(76, 175, 80);
            doc.setFontSize(22);
            doc.text(eur(resFijo.ahorro_anual), col2X + 30, y, { align: 'center' });
            
            y += 10;
            doc.setTextColor(100, 110, 120);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text(tr('TU NUEVO COSTE DRK'), col2X + 30, y, { align: 'center' });
            
            y += 8;
            doc.setTextColor(59, 130, 246);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(15);
            doc.text(eur(fijoMes) + tr('/mes'), col2X + 30, y, { align: 'center' });
            
            y += 5;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(6.5);
            doc.setTextColor(120, 130, 140);
            doc.text(tr('Estimado Mensual'), col2X + 30, y, { align: 'center' });
            
            y += 9;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(13);
            doc.setTextColor(59, 130, 246);
            doc.text(eur(fijoAnio) + tr('/a√±o'), col2X + 30, y, { align: 'center' });
            
            y -= 44;
            
            // COLUMNA 3: TU AHORRO ANUAL INDEXADO (derecha)
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(col3X, y - 4, 60, 9, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(7.5);
            doc.text('TU AHORRO ANUAL INDEXADO', col3X + 30, y + 2, { align: 'center' });
            
            y += 12;
            doc.setTextColor(76, 175, 80);
            doc.setFontSize(22);
            doc.text(eur(resIndexed.ahorro_anual), col3X + 30, y, { align: 'center' });
            
            y += 10;
            doc.setTextColor(100, 110, 120);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text(tr('TU NUEVO COSTE DRK'), col3X + 30, y, { align: 'center' });
            
            y += 8;
            doc.setTextColor(76, 175, 80);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(15);
            doc.text(eur(indexMes) + tr('/mes'), col3X + 30, y, { align: 'center' });
            
            y += 5;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(6.5);
            doc.setTextColor(120, 130, 140);
            doc.text(tr('Estimado Mensual'), col3X + 30, y, { align: 'center' });
            
            y += 9;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(13);
            doc.setTextColor(76, 175, 80);
            doc.text(eur(indexAnio) + tr('/a√±o'), col3X + 30, y, { align: 'center' });
            
            // P√ÅGINA 2: DESGLOSE DETALLADO
            doc.addPage();
            y = 15;
            
            // T√≠tulo verde
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(12, y, 186, 12, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('DESGLOSE DETALLADO POR SUMINISTRO', 105, y + 8, { align: 'center' });
            
            y += 18;
            const colW = 90;
            const leftX = 12;
            const rightX = 110;
            
            // COLUMNA IZQUIERDA: FIJA
            let leftY = y;
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(leftX, leftY, colW, 18, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.text('[ES0021000020679723GY]', leftX + 3, leftY + 5);
            doc.text('Tipo: ' + currentGasTariff, leftX + colW - 3, leftY + 5, { align: 'right' });
            doc.text('D√≠as: ' + dias, leftX + colW - 3, leftY + 10, { align: 'right' });
            doc.setFontSize(8);
            doc.text('DRK - ' + resFijo.name, leftX + 3, leftY + 13);
            
            leftY += 22;
            // T√âRMINO FIJO
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('T√âRMINO FIJO (Precio en ‚Ç¨/d√≠a)', leftX, leftY);
            leftY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            const pFijoDiario = resFijo.p_fijo_diario / 365;
            doc.text(tr('Precio fijo') + ' (' + dias + ' ' + tr('d√≠as') + ' x ' + num(pFijoDiario, 6) + ')', leftX + 3, leftY);
            doc.text(eur(resFijo.total_fijo), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text(tr('SUBTOTAL POTENCIA'), leftX + 3, leftY);
            doc.text(eur(resFijo.total_fijo), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 10;
            
            // T√âRMINO ENERG√çA
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('T√âRMINO ENERG√çA (Precios en ‚Ç¨/kWh)', leftX, leftY);
            leftY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('Energ√≠a (' + kwh + ' kWh x ' + num(resFijo.p1_price, 6) + ')', leftX + 3, leftY);
            doc.text(eur(resFijo.total_energia), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text('Subtotal Energ√≠a (Bruto)', leftX + 3, leftY);
            doc.text(eur(resFijo.total_energia), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 10;
            
            // SUBTOTAL BASE
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            const subtotalBase = resFijo.total_fijo + resFijo.total_energia;
            doc.text('SUBTOTAL BASE (P+E)', leftX, leftY);
            doc.text(eur(subtotalBase), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('Imp. Hidrocarburos (‚Ç¨0,00234 x ' + kwh + ' kWh)', leftX, leftY);
            doc.text(eur(resFijo.impuesto_hidrocarburo), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text(tr('BASE IMPONIBLE'), leftX, leftY);
            doc.text(eur(subtotalBase + resFijo.impuesto_hidrocarburo), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 5;
            
            doc.setFont('helvetica', 'normal');
            doc.text(tr('IVA (21%)'), leftX, leftY);
            doc.text(eur(resFijo.iva), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 10;
            
            // TOTAL
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(leftX, leftY - 3, colW, 12, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('TOTAL FACTURA (' + dias + ' D√çAS)', leftX + 3, leftY + 5);
            doc.text(eur(resFijo.total), leftX + colW - 3, leftY + 5, { align: 'right' });
            
            leftY += 14;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text(tr('TOTAL A√ëO (PROYECTADO)'), leftX, leftY);
            doc.text(eur(resFijo.total * 365 / dias), leftX + colW - 2, leftY, { align: 'right' });
            
            leftY += 12;
            doc.setFillColor(211, 47, 47);
            doc.roundedRect(leftX, leftY, colW, 18, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.text(tr('TU AHORRO ANUAL ESTIMADO ES:'), leftX + 3, leftY + 8);
            doc.setFontSize(13);
            doc.text(eur(resFijo.ahorro_anual) + tr('/ A√ëO'), leftX + 3, leftY + 15);
            
            // COLUMNA DERECHA: INDEXADA
            let rightY = y;
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(rightX, rightY, colW, 18, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.text('[ES0021000020679723GY]', rightX + 3, rightY + 5);
            doc.text('Tipo: ' + currentGasTariff, rightX + colW - 3, rightY + 5, { align: 'right' });
            doc.text('D√≠as: ' + dias, rightX + colW - 3, rightY + 10, { align: 'right' });
            doc.setFontSize(8);
            doc.text('DRK INDEX - ' + resIndexed.name, rightX + 3, rightY + 13);
            
            rightY += 22;
            // T√âRMINO FIJO
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('T√âRMINO FIJO (Precio en ‚Ç¨/d√≠a)', rightX, rightY);
            rightY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            const pIndexDiario = resIndexed.p_fijo_diario / 365;
            doc.text(tr('Precio fijo') + ' (' + dias + ' ' + tr('d√≠as') + ' x ' + num(pIndexDiario, 6) + ')', rightX + 3, rightY);
            doc.text(eur(resIndexed.total_fijo), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text(tr('SUBTOTAL POTENCIA'), rightX + 3, rightY);
            doc.text(eur(resIndexed.total_fijo), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 10;
            
            // T√âRMINO ENERG√çA
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('T√âRMINO ENERG√çA (Precios en ‚Ç¨/kWh)', rightX, rightY);
            rightY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('Energ√≠a (' + kwh + ' kWh x ' + num(resIndexed.p1_price, 6) + ')', rightX + 3, rightY);
            doc.text(eur(resIndexed.total_energia), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text('Subtotal Energ√≠a (Bruto)', rightX + 3, rightY);
            doc.text(eur(resIndexed.total_energia), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 10;
            
            // SUBTOTAL BASE
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            const subtotalBaseIndex = resIndexed.total_fijo + resIndexed.total_energia;
            doc.text('SUBTOTAL BASE (P+E)', rightX, rightY);
            doc.text(eur(subtotalBaseIndex), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('Imp. Hidrocarburos (‚Ç¨0,00234 x ' + kwh + ' kWh)', rightX, rightY);
            doc.text(eur(resIndexed.impuesto_hidrocarburo), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text(tr('BASE IMPONIBLE'), rightX, rightY);
            doc.text(eur(subtotalBaseIndex + resIndexed.impuesto_hidrocarburo), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 5;
            
            doc.setFont('helvetica', 'normal');
            doc.text(tr('IVA (21%)'), rightX, rightY);
            doc.text(eur(resIndexed.iva), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 10;
            
            // TOTAL
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(rightX, rightY - 3, colW, 12, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('TOTAL FACTURA (' + dias + ' D√çAS)', rightX + 3, rightY + 5);
            doc.text(eur(resIndexed.total), rightX + colW - 3, rightY + 5, { align: 'right' });
            
            rightY += 14;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text(tr('TOTAL A√ëO (PROYECTADO)'), rightX, rightY);
            doc.text(eur(resIndexed.total * 365 / dias), rightX + colW - 2, rightY, { align: 'right' });
            
            rightY += 12;
            doc.setFillColor(211, 47, 47);
            doc.roundedRect(rightX, rightY, colW, 18, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.text(tr('TU AHORRO ANUAL ESTIMADO ES:'), rightX + 3, rightY + 8);
            doc.setFontSize(13);
            doc.text(eur(resIndexed.ahorro_anual) + tr('/ A√ëO'), rightX + 3, rightY + 15);
            
            // P√ÅGINA 3: CUAL ES LA DIFERENCIA
            doc.addPage();
            y = 40;
            
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            doc.text('CUAL ES LA DIFERENCIA?', 105, y, { align: 'center' });
            
            y += 15;
            
            // Columna izquierda: FIJA
            doc.setTextColor(59, 130, 246);
            doc.setFontSize(12);
            doc.text('POR QUE TARIFA FIJA?', leftX, y);
            
            y += 8;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            const fijaTexts = [
                '‚Ä¢ Implica un precio fijo por los kilovatios que',
                '  consumes (kWh).',
                '',
                '‚Ä¢ El precio se mantiene estable,',
                '  independientemente de c√≥mo se comporten los',
                '  precios en el mercado el√©ctrico.',
                '',
                '‚Ä¢ Cuando el precio del mercado est√° alto, el',
                '  cliente est√° protegido frente a sobresaltos.',
                '',
                '‚Ä¢ No tendr√°s que estar pendiente de las',
                '  variaciones del mercado y podr√°s seguir',
                '  usando la electricidad como siempre.'
            ];
            
            fijaTexts.forEach(line => {
                doc.text(line, leftX, y);
                y += 4;
            });
            
            y = 55;
            
            // Columna derecha: INDEXADA
            doc.setTextColor(76, 175, 80);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text('POR QUE TARIFA INDEXADA?', rightX, y);
            
            y += 8;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            const indexTexts = [
                '‚Ä¢ Implica un precio variable por los kilovatios',
                '  que consumes (kWh) cada mes.',
                '',
                '‚Ä¢ Es la tarifa m√°s justa, ya que pagas el coste',
                '  real de la energ√≠a mes a mes.',
                '',
                '‚Ä¢ Al contratarla, el cliente evita pagar',
                '  m√°rgenes adicionales cuando el precio de la',
                '  electricidad es m√°s barato.',
                '',
                '‚Ä¢ A largo plazo, con un indexado 100%',
                '  funcional, se puede obtener un ahorro',
                '  aproximado de hasta un 20% en √©pocas de',
                '  mejor precio.'
            ];
            
            indexTexts.forEach(line => {
                doc.text(line, rightX, y);
                y += 4;
            });
            
            doc.save('GAS_Dual_' + currentGasTariff + '.pdf');
            window.showMessageModal("‚úÖ PDF generado", false);
        }
        
        // ============================================
        // FUNCIONES PDF PARA POWER CUP
        // ============================================
        
        // PDF INDIVIDUAL POWER CUP
        async function generateGasPDF_Simple_PowerCup(bestResult, dias, kwh, totalCliente, clientName = '[NOMBRE COMPLETO CLIENTE]', comercialCode = 'D=00') {
            window.showMessageModal("‚è≥ Generando PDF POWER CUP...");
            
            const { jsPDF } = window.jspdf;
            let doc = new jsPDF('p', 'mm', 'a4');
            
            // CR√çTICO: Activar traducci√≥n autom√°tica de textos
            if (window.setupPDFTranslation) {
                doc = window.setupPDFTranslation(doc);
            }
            
            const eur = n => new Intl.NumberFormat('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(n || 0) + ' ‚Ç¨';
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', {minimumFractionDigits: d, maximumFractionDigits: d}).format(n || 0);
            
            const pageWidth = 210;
            const pageHeight = 297;
            let y = 0;
            
            // HEADER VERDE OLIVA CON RAYAS (est√©tica mejorada)
            doc.setFillColor(119, 132, 109);
            doc.rect(0, 0, pageWidth, 55, 'F');
            
            // Rayas verticales sutiles y elegantes
            doc.setDrawColor(130, 145, 120);
            doc.setLineWidth(0.5);
            for (let i = 0; i < pageWidth; i += 2.5) {
                doc.line(i, 0, i, 55);
            }
            
            // LOGO TAZA DE CAF√â PROFESIONAL
            const logoX = 40;
            const logoY = 27.5;
            
            // Cuerpo de la taza (rectangular con bordes redondeados)
            doc.setFillColor(70, 80, 65);
            doc.roundedRect(logoX - 12, logoY - 8, 24, 16, 2, 2, 'F');
            
            // Interior de la taza (caf√©) - color m√°s claro
            doc.setFillColor(95, 108, 90);
            doc.roundedRect(logoX - 10, logoY - 6, 20, 10, 1.5, 1.5, 'F');
            
            // Asa de la taza (l√≠neas elegantes)
            doc.setDrawColor(70, 80, 65);
            doc.setLineWidth(2.2);
            doc.line(logoX + 12, logoY - 3, logoX + 16, logoY - 1);
            doc.line(logoX + 16, logoY - 1, logoX + 16.5, logoY + 2);
            doc.line(logoX + 16.5, logoY + 2, logoX + 12, logoY + 3);
            
            // Vapor (l√≠neas sutiles amarillas/naranjas)
            doc.setDrawColor(255, 190, 50);
            doc.setLineWidth(1.5);
            
            // Vapor izquierda
            doc.line(logoX - 4, logoY - 10, logoX - 3, logoY - 14);
            
            // Vapor centro
            doc.line(logoX, logoY - 10, logoX, logoY - 15);
            
            // Vapor derecha  
            doc.line(logoX + 4, logoY - 10, logoX + 3, logoY - 14);
            
            // TEXTO "POWER CUP ENERG√çA"
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(24);
            doc.text('POWER CUP', logoX + 30, 20);
            
            doc.setFontSize(22);
            doc.text('ENERG√çA', logoX + 30, 32);
            
            // Subt√≠tulo descriptivo
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.setTextColor(230, 240, 230);
            doc.text(tr('Liderando el ahorro y la'), logoX + 30, 40);
            doc.text(tr('eficiencia energ√©tica.'), logoX + 30, 44.5);
            
            // TEXTO DERECHA DEL HEADER
            doc.setTextColor(40, 60, 80);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text(tr('ESTUDIO DE AHORRO'), pageWidth - 12, 16, { align: 'right' });
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(13);
            doc.text('COMPARATIVA', pageWidth - 12, 27, { align: 'right' });
            
            doc.setTextColor(100, 120, 140);
            doc.setFontSize(11);
            doc.text('PROFESIONAL', pageWidth - 12, 37, { align: 'right' });
            
            // Banner verde "ESTUDIO DE AHORRO"
            y = 63;
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(20, y, 170, 12, 4, 4, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text(tr('ESTUDIO DE AHORRO'), 105, y + 8, { align: 'center' });
            
            // Recuadro con borde verde oliva para info del cliente
            y += 18;
            doc.setDrawColor(119, 132, 109);
            doc.setLineWidth(2);
            doc.roundedRect(20, y, 170, 25, 3, 3, 'D');
            
            doc.setFillColor(255, 255, 255);
            doc.roundedRect(20, y, 170, 25, 3, 3, 'F');
            
            y += 8;
            doc.setTextColor(70, 80, 70);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(13);
            doc.text('COMPARATIVA PROFESIONAL - POWER CUP', 25, y);
            
            y += 7;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.setTextColor(100, 110, 100);
            doc.text(tr('CLIENTE:') + ' ' + clientName + '', 25, y);
            
            y += 5;
            doc.text('CUPS: ES0021000020679723GY', 25, y);
            
            // Texto "COMERCIAL: <cz" en la esquina derecha
            doc.setTextColor(130, 140, 130);
            doc.setFontSize(8);
            doc.text(tr('COMERCIAL:') + ' ' + comercialCode + '', 185, y, { align: 'right' });
            
            y += 15;
            
            // Caja verde oliva "LA MEJOR OPCI√ìN" (m√°s grande)
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(20, y, 170, 50, 5, 5, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text(tr('LA MEJOR OPCI√ìN PARA TI ES'), pageWidth / 2, y + 13, { align: 'center' });
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(32);
            const tariffName = bestResult.name.split('-')[0].trim();
            doc.text(tariffName, pageWidth / 2, y + 30, { align: 'center' });
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text('POWER CUP', pageWidth / 2, y + 42, { align: 'center' });
            
            y += 63;
            
            // Caja blanca con borde gris suave para ahorro y comparaci√≥n
            doc.setDrawColor(220, 220, 220);
            doc.setLineWidth(1.5);
            doc.setFillColor(255, 255, 255);
            doc.roundedRect(20, y, 170, 95, 5, 5, 'FD');
            
            y += 15;
            doc.setTextColor(120, 130, 120);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text(tr('TU AHORRO ANUAL ESTIMADO'), pageWidth / 2, y, { align: 'center' });
            
            y += 18;
            doc.setTextColor(76, 175, 80);
            doc.setFontSize(34);
            doc.text(eur(bestResult.ahorro_anual), pageWidth / 2, y, { align: 'center' });
            
            y += 18;
            
            // Separador vertical
            doc.setDrawColor(220, 220, 220);
            doc.setLineWidth(1);
            doc.line(pageWidth / 2, y - 30, pageWidth / 2, y + 35);
            
            // Columna izquierda: Factura actual
            doc.setTextColor(110, 120, 110);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text(tr('TU FACTURA ACTUAL'), 57, y, { align: 'center' });
            
            y += 10;
            const factMes = totalCliente * 30 / dias;
            doc.setTextColor(220, 38, 38);
            doc.setFontSize(18);
            const txtMes = eur(factMes);
            doc.text(txtMes, 57, y, { align: 'center' });
            
            // L√≠nea tachada
            const wMes = doc.getTextWidth(txtMes);
            doc.setDrawColor(220, 38, 38);
            doc.setLineWidth(2);
            doc.line(57 - wMes/2, y - 5, 57 + wMes/2, y - 5);
            
            y += 7;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            doc.setTextColor(140, 150, 140);
            doc.text(tr('Total Periodo') + ' (' + dias + ' ' + tr('d√≠as') + ')', 57, y, { align: 'center' });
            
            y += 11;
            const factAnio = totalCliente * 365 / dias;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(15);
            doc.setTextColor(220, 38, 38);
            const txtAnio = eur(factAnio) + tr('/a√±o');
            doc.text(txtAnio, 57, y, { align: 'center' });
            
            const wAnio = doc.getTextWidth(txtAnio);
            doc.setLineWidth(2);
            doc.line(57 - wAnio/2, y - 4, 57 + wAnio/2, y - 4);
            
            y -= 28;
            
            // Columna derecha: Nuevo coste POWER CUP
            doc.setTextColor(110, 120, 110);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text(tr('TU NUEVO COSTE POWER CUP'), 153, y, { align: 'center' });
            
            y += 10;
            const nuevoMes = bestResult.total * 30 / dias;
            doc.setTextColor(119, 132, 109);
            doc.setFontSize(18);
            doc.text(eur(nuevoMes) + tr('/mes'), 153, y, { align: 'center' });
            
            y += 7;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            doc.setTextColor(140, 150, 140);
            doc.text(tr('Estimado Mensual'), 153, y, { align: 'center' });
            
            y += 11;
            const nuevoAnio = bestResult.total * 365 / dias;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(15);
            doc.setTextColor(119, 132, 109);
            doc.text(eur(nuevoAnio) + tr('/a√±o'), 153, y, { align: 'center' });
            
            // P√ÅGINA 2: DESGLOSE
            doc.addPage();
            y = 15;
            
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(12, y, 186, 12, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text(tr('DESGLOSE DETALLADO DE LA SIMULACI√ìN') + ' (' + tariffName + ')', 105, y + 8, { align: 'center' });
            
            y += 18;
            
            // T√âRMINO FIJO
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('T√âRMINO FIJO (Precio en ‚Ç¨/d√≠a)', 12, y);
            y += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            const pFijoDiario = bestResult.p_fijo_diario / 365;
            doc.text(tr('Precio fijo') + ' (' + dias + ' ' + tr('d√≠as') + ' x ' + num(pFijoDiario, 6) + ')', 15, y);
            doc.text(eur(bestResult.total_fijo), 195, y, { align: 'right' });
            y += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text(tr('SUBTOTAL POTENCIA'), 15, y);
            doc.text(eur(bestResult.total_fijo), 195, y, { align: 'right' });
            y += 10;
            
            // T√âRMINO ENERG√çA
            doc.setFontSize(10);
            doc.text('T√âRMINO ENERG√çA (Precios en ‚Ç¨/kWh)', 12, y);
            y += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.text('Energ√≠a (' + kwh + ' kWh x ' + num(bestResult.p1_price, 6) + ')', 15, y);
            doc.text(eur(bestResult.total_energia), 195, y, { align: 'right' });
            y += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text('Subtotal Energ√≠a (Bruto)', 15, y);
            doc.text(eur(bestResult.total_energia), 195, y, { align: 'right' });
            y += 10;
            
            // SUBTOTAL BASE
            const subtotalBase = bestResult.total_fijo + bestResult.total_energia;
            doc.setFontSize(10);
            doc.text('SUBTOTAL BASE (P+E)', 12, y);
            doc.text(eur(subtotalBase), 195, y, { align: 'right' });
            y += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.text('Imp. Hidrocarburos (‚Ç¨0,00234 x ' + kwh + ' kWh)', 12, y);
            doc.text(eur(bestResult.impuesto_hidrocarburo), 195, y, { align: 'right' });
            y += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text(tr('BASE IMPONIBLE'), 12, y);
            doc.text(eur(subtotalBase + bestResult.impuesto_hidrocarburo), 195, y, { align: 'right' });
            y += 5;
            
            doc.setFont('helvetica', 'normal');
            doc.text(tr('IVA (21%)'), 12, y);
            doc.text(eur(bestResult.iva), 195, y, { align: 'right' });
            y += 10;
            
            // TOTAL
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(12, y - 3, 186, 12, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('TOTAL FACTURA (' + dias + ' D√çAS)', 15, y + 5);
            doc.text(eur(bestResult.total), 195, y + 5, { align: 'right' });
            
            y += 14;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(9);
            doc.text(tr('TOTAL A√ëO (PROYECTADO)'), 12, y);
            doc.text(eur(bestResult.total * 365 / dias), 195, y, { align: 'right' });
            
            y += 12;
            doc.setFillColor(211, 47, 47);
            doc.roundedRect(12, y, 186, 20, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.text(tr('TU AHORRO ANUAL ESTIMADO ES:'), 15, y + 8);
            doc.setFontSize(16);
            doc.text(eur(bestResult.ahorro_anual) + tr('/ A√ëO'), 15, y + 16);
            
            doc.save('GAS_PowerCup_' + tariffName + '_' + new Date().toISOString().slice(0,10) + '.pdf');
            window.showMessageModal("‚úÖ PDF POWER CUP generado", false);
        }
        
        // PDF DUAL POWER CUP
        async function generateGasPDF_Dual_PowerCup(resFijo, resIndexed, dias, kwh, totalCliente, clientName = '[NOMBRE COMPLETO CLIENTE]', comercialCode = 'D=00') {
            window.showMessageModal("‚è≥ Generando PDF comparativo POWER CUP...");
            const { jsPDF} = window.jspdf;
            let doc = new jsPDF('p', 'mm', 'a4');
            
            // CR√çTICO: Activar traducci√≥n autom√°tica de textos
            if (window.setupPDFTranslation) {
                doc = window.setupPDFTranslation(doc);
            }
            
            const eur = n => new Intl.NumberFormat('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(n || 0) + ' ‚Ç¨';
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', {minimumFractionDigits: d, maximumFractionDigits: d}).format(n || 0);
            
            const pageWidth = 210;
            let y = 0;
            
            // HEADER VERDE OLIVA CON RAYAS (est√©tica mejorada - Dual)
            doc.setFillColor(119, 132, 109);
            doc.rect(0, 0, pageWidth, 55, 'F');
            
            // Rayas verticales sutiles y elegantes
            doc.setDrawColor(130, 145, 120);
            doc.setLineWidth(0.5);
            for (let i = 0; i < pageWidth; i += 2.5) {
                doc.line(i, 0, i, 55);
            }
            
            // LOGO TAZA DE CAF√â PROFESIONAL
            const logoX = 40;
            const logoY = 27.5;
            
            // Cuerpo de la taza (rectangular con bordes redondeados)
            doc.setFillColor(70, 80, 65);
            doc.roundedRect(logoX - 12, logoY - 8, 24, 16, 2, 2, 'F');
            
            // Interior de la taza (caf√©) - color m√°s claro
            doc.setFillColor(95, 108, 90);
            doc.roundedRect(logoX - 10, logoY - 6, 20, 10, 1.5, 1.5, 'F');
            
            // Asa de la taza (l√≠neas elegantes)
            doc.setDrawColor(70, 80, 65);
            doc.setLineWidth(2.2);
            doc.line(logoX + 12, logoY - 3, logoX + 16, logoY - 1);
            doc.line(logoX + 16, logoY - 1, logoX + 16.5, logoY + 2);
            doc.line(logoX + 16.5, logoY + 2, logoX + 12, logoY + 3);
            
            // Vapor (l√≠neas sutiles amarillas/naranjas)
            doc.setDrawColor(255, 190, 50);
            doc.setLineWidth(1.5);
            
            // Vapor izquierda
            doc.line(logoX - 4, logoY - 10, logoX - 3, logoY - 14);
            
            // Vapor centro
            doc.line(logoX, logoY - 10, logoX, logoY - 15);
            
            // Vapor derecha  
            doc.line(logoX + 4, logoY - 10, logoX + 3, logoY - 14);
            
            // TEXTO "POWER CUP ENERG√çA"
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(24);
            doc.text('POWER CUP', logoX + 30, 20);
            
            doc.setFontSize(22);
            doc.text('ENERG√çA', logoX + 30, 32);
            
            // Subt√≠tulo descriptivo
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.setTextColor(230, 240, 230);
            doc.text(tr('Liderando el ahorro y la'), logoX + 30, 40);
            doc.text(tr('eficiencia energ√©tica.'), logoX + 30, 44.5);
            
            // TEXTO DERECHA DEL HEADER
            doc.setTextColor(40, 60, 80);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text(tr('ESTUDIO DE AHORRO'), pageWidth - 12, 16, { align: 'right' });
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(13);
            doc.text('COMPARATIVA', pageWidth - 12, 27, { align: 'right' });
            
            doc.setTextColor(100, 120, 140);
            doc.setFontSize(11);
            doc.text('PROFESIONAL', pageWidth - 12, 37, { align: 'right' });
            
            // Banner verde "ESTUDIO DE AHORRO"
            y = 63;
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(20, y, 170, 8, 3, 3, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text(tr('ESTUDIO DE AHORRO'), 25, y + 5.5);
            
            y += 8;
            
            // Caja blanca con borde para info del cliente
            doc.setFillColor(255, 255, 255);
            doc.setDrawColor(119, 132, 109);
            doc.setLineWidth(1);
            doc.roundedRect(20, y, 170, 20, 3, 3, 'FD');
            
            // T√≠tulo principal
            doc.setTextColor(119, 132, 109);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text('COMPARATIVA PROFESIONAL - POWER CUP', 25, y + 6);
            
            // Info del cliente
            doc.setTextColor(80, 80, 80);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text(tr('CLIENTE:') + ' ' + clientName, 25, y + 12);
            doc.text('CUPS: ES0021000020679723GY', 25, y + 17);
            
            // Comercial en caja destacada (derecha)
            doc.setFillColor(240, 245, 240);
            doc.roundedRect(pageWidth - 20 - 45, y + 9, 45, 8, 2, 2, 'F');
            doc.setTextColor(119, 132, 109);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text(tr('COMERCIAL:') + ' ' + comercialCode, pageWidth - 20 - 43, y + 14.5);
            
            y += 25;
            
            
            // Caja verde oliva "LA MEJOR OPCI√ìN" (m√°s grande)
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(20, y, 170, 50, 5, 5, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text(tr('LA MEJOR OPCI√ìN PARA TI ES'), pageWidth / 2, y + 13, { align: 'center' });
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(32);
            // Extraer el nombre de la tarifa (ej: "ELEIA" de "ELEIA - Tarifa XYZ")
            const bestTariff = resFijo.ahorro_anual > resIndexed.ahorro_anual ? resFijo : resIndexed;
            const tariffName = bestTariff.name.split('-')[0].trim();
            doc.text(tariffName, pageWidth / 2, y + 30, { align: 'center' });
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text('POWER CUP', pageWidth / 2, y + 42, { align: 'center' });
            
            y += 63;
            
            const factMes = totalCliente * 30 / dias;
            const factAnio = totalCliente * 365 / dias;
            const fijoMes = resFijo.total * 30 / dias;
            const fijoAnio = resFijo.total * 365 / dias;
            const indexMes = resIndexed.total * 30 / dias;
            const indexAnio = resIndexed.total * 365 / dias;
            
            const col1X = 12;
            const col2X = 75;
            const col3X = 145;
            
            // Separadores verticales
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.3);
            doc.line(70, y - 5, 70, y + 85);
            doc.line(140, y - 5, 140, y + 85);
            
            // COLUMNA 1: ACTUAL
            doc.setTextColor(70, 80, 70);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text(tr('TU FACTURA ACTUAL'), col1X, y);
            
            y += 9;
            doc.setTextColor(220, 38, 38);
            doc.setFontSize(16);
            const txtMes = eur(factMes);
            doc.text(txtMes, col1X, y);
            const wMes = doc.getTextWidth(txtMes);
            doc.setDrawColor(220, 38, 38);
            doc.setLineWidth(1.5);
            doc.line(col1X, y - 4, col1X + wMes, y - 4);
            
            y += 5;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(6);
            doc.setTextColor(120, 130, 120);
            doc.text(tr('Total Periodo') + ' (' + dias + ' ' + tr('d√≠as') + ')', col1X, y);
            
            y += 9;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(13);
            doc.setTextColor(220, 38, 38);
            const txtAnio = eur(factAnio) + tr('/a√±o');
            doc.text(txtAnio, col1X, y);
            const wAnio = doc.getTextWidth(txtAnio);
            doc.line(col1X, y - 3, col1X + wAnio, y - 3);
            
            y -= 23;
            
            // COLUMNA 2: FIJO
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(col2X, y - 3, 60, 8, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(7);
            doc.text('TU AHORRO ANUAL FIJO', col2X + 30, y + 2, { align: 'center' });
            
            y += 11;
            doc.setTextColor(76, 175, 80);
            doc.setFontSize(20);
            doc.text(eur(resFijo.ahorro_anual), col2X + 30, y, { align: 'center' });
            
            y += 9;
            doc.setTextColor(100, 110, 100);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            doc.text(tr('TU NUEVO COSTE POWER CUP'), col2X + 30, y, { align: 'center' });
            
            y += 7;
            doc.setTextColor(119, 132, 109);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text(eur(fijoMes) + tr('/mes'), col2X + 30, y, { align: 'center' });
            
            y += 4;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(6);
            doc.setTextColor(120, 130, 120);
            doc.text(tr('Estimado Mensual'), col2X + 30, y, { align: 'center' });
            
            y += 8;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(119, 132, 109);
            doc.text(eur(fijoAnio) + tr('/a√±o'), col2X + 30, y, { align: 'center' });
            
            y -= 39;
            
            // COLUMNA 3: INDEXADO
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(col3X, y - 3, 60, 8, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(7);
            doc.text('TU AHORRO ANUAL INDEXADO', col3X + 30, y + 2, { align: 'center' });
            
            y += 11;
            doc.setTextColor(76, 175, 80);
            doc.setFontSize(20);
            doc.text(eur(resIndexed.ahorro_anual), col3X + 30, y, { align: 'center' });
            
            y += 9;
            doc.setTextColor(100, 110, 100);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            doc.text(tr('TU NUEVO COSTE POWER CUP'), col3X + 30, y, { align: 'center' });
            
            y += 7;
            doc.setTextColor(76, 175, 80);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text(eur(indexMes) + tr('/mes'), col3X + 30, y, { align: 'center' });
            
            y += 4;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(6);
            doc.setTextColor(120, 130, 120);
            doc.text(tr('Estimado Mensual'), col3X + 30, y, { align: 'center' });
            
            y += 8;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(76, 175, 80);
            doc.text(eur(indexAnio) + tr('/a√±o'), col3X + 30, y, { align: 'center' });
            
            // P√ÅGINA 2: DESGLOSE DETALLADO
            doc.addPage();
            y = 15;
            
            // T√≠tulo verde
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(12, y, 186, 12, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('DESGLOSE DETALLADO POR SUMINISTRO', 105, y + 8, { align: 'center' });
            
            y += 18;
            const colW = 90;
            const leftX = 12;
            const rightX = 110;
            
            // COLUMNA IZQUIERDA: FIJA
            let leftY = y;
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(leftX, leftY, colW, 18, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.text('[ES0021000020679723GY]', leftX + 3, leftY + 5);
            doc.text('Tipo: ' + currentGasTariff, leftX + colW - 3, leftY + 5, { align: 'right' });
            doc.text('D√≠as: ' + dias, leftX + colW - 3, leftY + 10, { align: 'right' });
            doc.setFontSize(8);
            doc.text('POWER CUP - ' + resFijo.name, leftX + 3, leftY + 13);
            
            leftY += 22;
            // T√âRMINO FIJO
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('T√âRMINO FIJO (Precio en ‚Ç¨/d√≠a)', leftX, leftY);
            leftY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            const pFijoDiario = resFijo.p_fijo_diario / 365;
            doc.text(tr('Precio fijo') + ' (' + dias + ' ' + tr('d√≠as') + ' x ' + num(pFijoDiario, 6) + ')', leftX + 3, leftY);
            doc.text(eur(resFijo.total_fijo), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text(tr('SUBTOTAL POTENCIA'), leftX + 3, leftY);
            doc.text(eur(resFijo.total_fijo), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 10;
            
            // T√âRMINO ENERG√çA
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('T√âRMINO ENERG√çA (Precios en ‚Ç¨/kWh)', leftX, leftY);
            leftY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('Energ√≠a (' + kwh + ' kWh x ' + num(resFijo.p1_price, 6) + ')', leftX + 3, leftY);
            doc.text(eur(resFijo.total_energia), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text('Subtotal Energ√≠a (Bruto)', leftX + 3, leftY);
            doc.text(eur(resFijo.total_energia), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 10;
            
            // SUBTOTAL BASE
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            const subtotalBase = resFijo.total_fijo + resFijo.total_energia;
            doc.text('SUBTOTAL BASE (P+E)', leftX, leftY);
            doc.text(eur(subtotalBase), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('Imp. Hidrocarburos (‚Ç¨0,00234 x ' + kwh + ' kWh)', leftX, leftY);
            doc.text(eur(resFijo.impuesto_hidrocarburo), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text(tr('BASE IMPONIBLE'), leftX, leftY);
            doc.text(eur(subtotalBase + resFijo.impuesto_hidrocarburo), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 5;
            
            doc.setFont('helvetica', 'normal');
            doc.text(tr('IVA (21%)'), leftX, leftY);
            doc.text(eur(resFijo.iva), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 10;
            
            // TOTAL
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(leftX, leftY - 3, colW, 12, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('TOTAL FACTURA (' + dias + ' D√çAS)', leftX + 3, leftY + 5);
            doc.text(eur(resFijo.total), leftX + colW - 3, leftY + 5, { align: 'right' });
            
            leftY += 14;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text(tr('TOTAL A√ëO (PROYECTADO)'), leftX, leftY);
            doc.text(eur(resFijo.total * 365 / dias), leftX + colW - 2, leftY, { align: 'right' });
            
            leftY += 12;
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(leftX, leftY, colW, 18, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.text(tr('TU AHORRO ANUAL ESTIMADO ES:'), leftX + 3, leftY + 8);
            doc.setFontSize(13);
            doc.text(eur(resFijo.ahorro_anual) + tr('/ A√ëO'), leftX + 3, leftY + 15);
            
            // COLUMNA DERECHA: INDEXADA
            let rightY = y;
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(rightX, rightY, colW, 18, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.text('[ES0021000020679723GY]', rightX + 3, rightY + 5);
            doc.text('Tipo: ' + currentGasTariff, rightX + colW - 3, rightY + 5, { align: 'right' });
            doc.text('D√≠as: ' + dias, rightX + colW - 3, rightY + 10, { align: 'right' });
            doc.setFontSize(8);
            doc.text('POWER CUP INDEX - ' + resIndexed.name, rightX + 3, rightY + 13);
            
            rightY += 22;
            // T√âRMINO FIJO
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('T√âRMINO FIJO (Precio en ‚Ç¨/d√≠a)', rightX, rightY);
            rightY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            const pIndexDiario = resIndexed.p_fijo_diario / 365;
            doc.text(tr('Precio fijo') + ' (' + dias + ' ' + tr('d√≠as') + ' x ' + num(pIndexDiario, 6) + ')', rightX + 3, rightY);
            doc.text(eur(resIndexed.total_fijo), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text(tr('SUBTOTAL POTENCIA'), rightX + 3, rightY);
            doc.text(eur(resIndexed.total_fijo), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 10;
            
            // T√âRMINO ENERG√çA
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('T√âRMINO ENERG√çA (Precios en ‚Ç¨/kWh)', rightX, rightY);
            rightY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('Energ√≠a (' + kwh + ' kWh x ' + num(resIndexed.p1_price, 6) + ')', rightX + 3, rightY);
            doc.text(eur(resIndexed.total_energia), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text('Subtotal Energ√≠a (Bruto)', rightX + 3, rightY);
            doc.text(eur(resIndexed.total_energia), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 10;
            
            // SUBTOTAL BASE
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            const subtotalBaseIndex = resIndexed.total_fijo + resIndexed.total_energia;
            doc.text('SUBTOTAL BASE (P+E)', rightX, rightY);
            doc.text(eur(subtotalBaseIndex), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('Imp. Hidrocarburos (‚Ç¨0,00234 x ' + kwh + ' kWh)', rightX, rightY);
            doc.text(eur(resIndexed.impuesto_hidrocarburo), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text(tr('BASE IMPONIBLE'), rightX, rightY);
            doc.text(eur(subtotalBaseIndex + resIndexed.impuesto_hidrocarburo), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 5;
            
            doc.setFont('helvetica', 'normal');
            doc.text(tr('IVA (21%)'), rightX, rightY);
            doc.text(eur(resIndexed.iva), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 10;
            
            // TOTAL
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(rightX, rightY - 3, colW, 12, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('TOTAL FACTURA (' + dias + ' D√çAS)', rightX + 3, rightY + 5);
            doc.text(eur(resIndexed.total), rightX + colW - 3, rightY + 5, { align: 'right' });
            
            rightY += 14;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text(tr('TOTAL A√ëO (PROYECTADO)'), rightX, rightY);
            doc.text(eur(resIndexed.total * 365 / dias), rightX + colW - 2, rightY, { align: 'right' });
            
            rightY += 12;
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(rightX, rightY, colW, 18, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.text(tr('TU AHORRO ANUAL ESTIMADO ES:'), rightX + 3, rightY + 8);
            doc.setFontSize(13);
            doc.text(eur(resIndexed.ahorro_anual) + tr('/ A√ëO'), rightX + 3, rightY + 15);
            
            // P√ÅGINA 3: CUAL ES LA DIFERENCIA
            doc.addPage();
            y = 40;
            
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            doc.text('CUAL ES LA DIFERENCIA?', 105, y, { align: 'center' });
            
            y += 15;
            
            // Columna izquierda: FIJA
            doc.setTextColor(59, 130, 246);
            doc.setFontSize(12);
            doc.text('POR QUE TARIFA FIJA?', leftX, y);
            
            y += 8;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            const fijaTexts = [
                '‚Ä¢ Implica un precio fijo por los kilovatios que',
                '  consumes (kWh).',
                '',
                '‚Ä¢ El precio se mantiene estable,',
                '  independientemente de c√≥mo se comporten los',
                '  precios en el mercado el√©ctrico.',
                '',
                '‚Ä¢ Cuando el precio del mercado est√° alto, el',
                '  cliente est√° protegido frente a sobresaltos.',
                '',
                '‚Ä¢ No tendr√°s que estar pendiente de las',
                '  variaciones del mercado y podr√°s seguir',
                '  usando la electricidad como siempre.'
            ];
            
            fijaTexts.forEach(line => {
                doc.text(line, leftX, y);
                y += 4;
            });
            
            y = 55;
            
            // Columna derecha: INDEXADA
            doc.setTextColor(76, 175, 80);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text('POR QUE TARIFA INDEXADA?', rightX, y);
            
            y += 8;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            const indexTexts = [
                '‚Ä¢ Implica un precio variable por los kilovatios',
                '  que consumes (kWh) cada mes.',
                '',
                '‚Ä¢ Es la tarifa m√°s justa, ya que pagas el coste',
                '  real de la energ√≠a mes a mes.',
                '',
                '‚Ä¢ Al contratarla, el cliente evita pagar',
                '  m√°rgenes adicionales cuando el precio de la',
                '  electricidad es m√°s barato.',
                '',
                '‚Ä¢ A largo plazo, con un indexado 100%',
                '  funcional, se puede obtener un ahorro',
                '  aproximado de hasta un 20% en √©pocas de',
                '  mejor precio.'
            ];
            
            indexTexts.forEach(line => {
                doc.text(line, rightX, y);
                y += 4;
            });
            
            doc.save('GAS_PowerCup_Dual_' + currentGasTariff + '.pdf');
            window.showMessageModal("‚úÖ PDF comparativo POWER CUP generado", false);
        }

        // ============================================================================
        // SISTEMA ULTRA-COMPLETO DE TRADUCCI√ìN MULTIIDIOMA
        // Traduce TODO: Pantallas, Modales, Botones, Mensajes
        // ============================================================================

        (function() {
            // Mapa COMPLETO de traducciones - TODOS los textos visibles
            const TR = {
                "Analizar Factura": { en: "Analyze Invoice", zh: "ÂàÜÊûêË¥¶Âçï", de: "Rechnung analysieren", fr: "Analyser la Facture" },
                "Escanea el c√≥digo QR o introduce datos manualmente.": { en: "Scan the QR code or enter data manually.", zh: "Êâ´Êèè‰∫åÁª¥Á†ÅÊàñÊâãÂä®ËæìÂÖ•Êï∞ÊçÆ„ÄÇ", de: "Scannen Sie den QR-Code oder geben Sie Daten manuell ein.", fr: "Scannez le code QR ou saisissez les donn√©es manuellement." },
                "ESCANEAR QR AHORA": { en: "SCAN QR NOW", zh: "Á´ãÂç≥Êâ´Êèè‰∫åÁª¥Á†Å", de: "QR JETZT SCANNEN", fr: "SCANNER QR MAINTENANT" },
                "OTRAS OPCIONES DE CAPTURA": { en: "OTHER CAPTURE OPTIONS", zh: "ÂÖ∂‰ªñÊçïËé∑ÈÄâÈ°π", de: "ANDERE AUFNAHMEOPTIONEN", fr: "AUTRES OPTIONS DE CAPTURE" },
                "DATOS A MANO": { en: "MANUAL DATA", zh: "ÊâãÂä®Êï∞ÊçÆ", de: "MANUELLE DATEN", fr: "DONN√âES MANUELLES" },
                "Volver a selecci√≥n": { en: "Back to selection", zh: "ËøîÂõûÈÄâÊã©", de: "Zur√ºck zur Auswahl", fr: "Retour √† la s√©lection" },
                "Seleccione Opci√≥n QR": { en: "Select QR Option", zh: "ÈÄâÊã©‰∫åÁª¥Á†ÅÈÄâÈ°π", de: "QR-Option w√§hlen", fr: "S√©lectionner l'Option QR" },
                "Capturar Foto": { en: "Capture Photo", zh: "ÊãçÁÖß", de: "Foto aufnehmen", fr: "Capturer une Photo" },
                "Subir Imagen": { en: "Upload Image", zh: "‰∏ä‰º†ÂõæÁâá", de: "Bild hochladen", fr: "T√©l√©charger une Image" },
                "Pegar Imagen (CTRL+V)": { en: "Paste Image (CTRL+V)", zh: "Á≤òË¥¥ÂõæÁâá (CTRL+V)", de: "Bild einf√ºgen (STRG+V)", fr: "Coller l'Image (CTRL+V)" },
                "Cancelar": { en: "Cancel", zh: "ÂèñÊ∂à", de: "Abbrechen", fr: "Annuler" },
                "Selecciona la tarifa que deseas analizar.": { en: "Select the rate you want to analyze.", zh: "ÈÄâÊã©ÊÇ®ÊÉ≥ÂàÜÊûêÁöÑË¥πÁéá„ÄÇ", de: "W√§hlen Sie den Tarif, den Sie analysieren m√∂chten.", fr: "S√©lectionnez le tarif que vous souhaitez analyser." },
                "Gestor de m√∫ltiples contratos (2.0TD + 3.0TD)": { en: "Multiple contracts manager (2.0TD + 3.0TD)", zh: "Â§öÂêàÂêåÁÆ°ÁêÜÂô® (2.0TD + 3.0TD)", de: "Mehrfachvertrags-Manager (2.0TD + 3.0TD)", fr: "Gestionnaire de contrats multiples (2.0TD + 3.0TD)" },
                "Hogar / Peque√±o Negocio (Individual)": { en: "Home / Small Business (Individual)", zh: "ÂÆ∂Â∫≠ / Â∞èÂûã‰ºÅ‰∏öÔºàÂçïÁã¨Ôºâ", de: "Zuhause / Kleinunternehmen (Einzeln)", fr: "Maison / Petite Entreprise (Individuel)" },
                "Empresa / Negocio (Individual)": { en: "Company / Business (Individual)", zh: "ÂÖ¨Âè∏ / ‰ºÅ‰∏öÔºàÂçïÁã¨Ôºâ", de: "Unternehmen / Gesch√§ft (Einzeln)", fr: "Entreprise / Commerce (Individuel)" },
                "Industria / Gran Consumo (Individual)": { en: "Industry / Large Consumption (Individual)", zh: "Â∑•‰∏ö / Â§ßÂûãÊ∂àË¥πÔºàÂçïÁã¨Ôºâ", de: "Industrie / Gro√üverbrauch (Einzeln)", fr: "Industrie / Grande Consommation (Individuel)" },
                "ABRIR EN EL M√ìVIL": { en: "OPEN ON MOBILE", zh: "Âú®ÊâãÊú∫‰∏äÊâìÂºÄ", de: "AUF MOBIL √ñFFNEN", fr: "OUVRIR SUR MOBILE" },
                "C√°lculo Completado": { en: "Calculation Complete", zh: "ËÆ°ÁÆóÂÆåÊàê", de: "Berechnung abgeschlossen", fr: "Calcul Termin√©" },
                "‚úÖ C√°lculo Completado": { en: "‚úÖ Calculation Complete", zh: "‚úÖ ËÆ°ÁÆóÂÆåÊàê", de: "‚úÖ Berechnung abgeschlossen", fr: "‚úÖ Calcul Termin√©" },
                "Hemos encontrado ofertas con ahorro. ¬øC√≥mo quieres continuar?": { en: "We found offers with savings. How do you want to continue?", zh: "Êàë‰ª¨ÊâæÂà∞‰∫ÜËäÇÁúÅ‰ºòÊÉ†„ÄÇÊÇ®ÊÉ≥Â¶Ç‰ΩïÁªßÁª≠Ôºü", de: "Wir haben Angebote mit Einsparungen gefunden. Wie m√∂chten Sie fortfahren?", fr: "Nous avons trouv√© des offres avec des √©conomies. Comment souhaitez-vous continuer ?" },
                "Comparar FIJO vs INDEXADO": { en: "Compare FIXED vs INDEXED", zh: "ÊØîËæÉÂõ∫ÂÆö‰∏éÊåáÊï∞", de: "FEST vs INDEXIERT vergleichen", fr: "Comparer FIXE vs INDEX√â" },
                "Genera comparativa dual: tarifa fija y tarifa indexada DRK INDEX (precio variable del mercado).": { en: "Generate dual comparison: fixed rate and DRK INDEX indexed rate (variable market price).", zh: "ÁîüÊàêÂèåÈáçÊØîËæÉÔºöÂõ∫ÂÆöË¥πÁéáÂíåDRK INDEXÊåáÊï∞Ë¥πÁéáÔºàÂ∏ÇÂú∫ÂèØÂèò‰ª∑Ê†ºÔºâ„ÄÇ", de: "Dualer Vergleich generieren: Festpreis und DRK INDEX indexierter Tarif (variabler Marktpreis).", fr: "G√©n√©rer une comparaison duale : tarif fixe et tarif index√© DRK INDEX (prix variable du march√©)." },
                "VER MEJOR OPCI√ìN": { en: "SEE BEST OPTION", zh: "Êü•ÁúãÊúÄ‰Ω≥ÈÄâÈ°π", de: "BESTE OPTION SEHEN", fr: "VOIR LA MEILLEURE OPTION" },
                "Muestra autom√°ticamente la oferta con mayor ahorro y genera la comparativa": { en: "Automatically shows the offer with the highest savings and generates the comparison", zh: "Ëá™Âä®ÊòæÁ§∫ËäÇÁúÅÊúÄÂ§öÁöÑ‰ºòÊÉ†Âπ∂ÁîüÊàêÊØîËæÉ", de: "Zeigt automatisch das Angebot mit den h√∂chsten Einsparungen und generiert den Vergleich", fr: "Affiche automatiquement l'offre avec les √©conomies les plus √©lev√©es et g√©n√®re la comparaison" },
                "ELEGIR ENTRE RESULTADOS": { en: "CHOOSE FROM RESULTS", zh: "‰ªéÁªìÊûú‰∏≠ÈÄâÊã©", de: "AUS ERGEBNISSEN W√ÑHLEN", fr: "CHOISIR PARMI LES R√âSULTATS" },
                "Revisa todas las ofertas con ahorro positivo y elige la que prefieras": { en: "Review all offers with positive savings and choose your preferred one", zh: "Êü•ÁúãÊâÄÊúâÊ≠£ËäÇÁúÅÁöÑ‰ºòÊÉ†Âπ∂ÈÄâÊã©ÊÇ®ÂñúÊ¨¢ÁöÑ", de: "√úberpr√ºfen Sie alle Angebote mit positiven Einsparungen und w√§hlen Sie Ihr bevorzugtes", fr: "Examinez toutes les offres avec des √©conomies positives et choisissez celle que vous pr√©f√©rez" },
                "Consejo:": { en: "Advice:", zh: "Âª∫ËÆÆÔºö", de: "Rat:", fr: "Conseil :" },
                "¬øQu√© tipo de tarifa DRK quieres ver?": { en: "What type of DRK rate do you want to see?", zh: "ÊÇ®ÊÉ≥Êü•ÁúãÂì™ÁßçÁ±ªÂûãÁöÑDRKË¥πÁéáÔºü", de: "Welchen DRK-Tariftyp m√∂chten Sie sehen?", fr: "Quel type de tarif DRK souhaitez-vous voir ?" },
                "üéØ ¬øQu√© tipo de tarifa DRK quieres ver?": { en: "üéØ What type of DRK rate do you want to see?", zh: "üéØ ÊÇ®ÊÉ≥Êü•ÁúãÂì™ÁßçÁ±ªÂûãÁöÑDRKË¥πÁéáÔºü", de: "üéØ Welchen DRK-Tariftyp m√∂chten Sie sehen?", fr: "üéØ Quel type de tarif DRK souhaitez-vous voir ?" },
                "Tarifa FIJA": { en: "FIXED Rate", zh: "Âõ∫ÂÆöË¥πÁéá", de: "FESTPREIS-Tarif", fr: "Tarif FIXE" },
                "‚ö° Tarifa FIJA": { en: "‚ö° FIXED Rate", zh: "‚ö° Âõ∫ÂÆöË¥πÁéá", de: "‚ö° FESTPREIS-Tarif", fr: "‚ö° Tarif FIXE" },
                "Precio fijo estable (excluye DRK INDEX)": { en: "Stable fixed price (excludes DRK INDEX)", zh: "Á®≥ÂÆöÂõ∫ÂÆö‰ª∑Ê†ºÔºà‰∏çÂåÖÊã¨DRK INDEXÔºâ", de: "Stabiler Festpreis (ohne DRK INDEX)", fr: "Prix fixe stable (exclut DRK INDEX)" },
                "Tarifa INDEXADA (DRK INDEX)": { en: "INDEXED Rate (DRK INDEX)", zh: "ÊåáÊï∞Ë¥πÁéáÔºàDRK INDEXÔºâ", de: "INDEXIERTER Tarif (DRK INDEX)", fr: "Tarif INDEX√â (DRK INDEX)" },
                "üå± Tarifa INDEXADA (DRK INDEX)": { en: "üå± INDEXED Rate (DRK INDEX)", zh: "üå± ÊåáÊï∞Ë¥πÁéáÔºàDRK INDEXÔºâ", de: "üå± INDEXIERTER Tarif (DRK INDEX)", fr: "üå± Tarif INDEX√â (DRK INDEX)" },
                "Solo muestra DRK INDEX del mercado": { en: "Only shows market DRK INDEX", zh: "‰ªÖÊòæÁ§∫Â∏ÇÂú∫DRK INDEX", de: "Zeigt nur Markt-DRK INDEX", fr: "Affiche uniquement le DRK INDEX du march√©" },
                "Continuar con esta opci√≥n ‚Üí": { en: "Continue with this option ‚Üí", zh: "ÁªßÁª≠Ê≠§ÈÄâÈ°π ‚Üí", de: "Mit dieser Option fortfahren ‚Üí", fr: "Continuer avec cette option ‚Üí" },
                "DRK ENERG√çA": { en: "DRK ENERGY", zh: "DRK ËÉΩÊ∫ê", de: "DRK ENERGIE", fr: "DRK √âNERGIE" },
                "Liderando el ahorro y la eficiencia energ√©tica": { en: "Leading savings and energy efficiency", zh: "ÂºïÈ¢ÜËäÇÁúÅÂíåËÉΩÊ∫êÊïàÁéá", de: "F√ºhrend bei Einsparungen und Energieeffizienz", fr: "Leader des √©conomies et de l'efficacit√© √©nerg√©tique" },
                "An√°lisis Completado": { en: "Analysis Complete", zh: "ÂàÜÊûêÂÆåÊàê", de: "Analyse abgeschlossen", fr: "Analyse Termin√©e" },
                "Resultado del Estudio": { en: "Study Result", zh: "Á†îÁ©∂ÁªìÊûú", de: "Studienergebnis", fr: "R√©sultat de l'√âtude" },
                "LA MEJOR OPCI√ìN PARA TI ES": { en: "THE BEST OPTION FOR YOU IS", zh: "ÊúÄÈÄÇÂêàÊÇ®ÁöÑÈÄâÊã©ÊòØ", de: "DIE BESTE OPTION F√úR SIE IST", fr: "LA MEILLEURE OPTION POUR VOUS EST" },
                "TU AHORRO ANUAL ESTIMADO": { en: "YOUR ESTIMATED ANNUAL SAVINGS", zh: "ÊÇ®ÁöÑÈ¢ÑËÆ°Âπ¥Â∫¶ËäÇÁúÅ", de: "IHRE GESCH√ÑTZTE J√ÑHRLICHE ERSPARNIS", fr: "VOS √âCONOMIES ANNUELLES ESTIM√âES" },
                "TU FACTURA ACTUAL": { en: "YOUR CURRENT BILL", zh: "ÊÇ®ÂΩìÂâçÁöÑË¥¶Âçï", de: "IHRE AKTUELLE RECHNUNG", fr: "VOTRE FACTURE ACTUELLE" },
                "Total Periodo": { en: "Period Total", zh: "ÊúüÈó¥ÊÄªÈ¢ù", de: "Periodensumme", fr: "Total de la P√©riode" },
                "TU NUEVO COSTE DRK": { en: "YOUR NEW DRK COST", zh: "ÊÇ®ÁöÑÊñ∞DRKÊàêÊú¨", de: "IHRE NEUEN DRK-KOSTEN", fr: "VOTRE NOUVEAU CO√õT DRK" },
                "Estimado Mensual": { en: "Monthly Estimate", zh: "ÊØèÊúà‰º∞ÁÆó", de: "Monatliche Sch√§tzung", fr: "Estimation Mensuelle" },
                "Datos del Comercial y Cliente": { en: "Sales Representative and Client Data", zh: "ÈîÄÂîÆ‰ª£Ë°®ÂíåÂÆ¢Êà∑Êï∞ÊçÆ", de: "Vertriebs- und Kundendaten", fr: "Donn√©es du Commercial et du Client" },
                "Rellene sus datos. El resumen profesional de la oferta se copiar√° a su portapapeles (Ctrl+V).": { en: "Fill in your details. The professional offer summary will be copied to your clipboard (Ctrl+V).", zh: "Â°´ÂÜôÊÇ®ÁöÑËØ¶ÁªÜ‰ø°ÊÅØ„ÄÇ‰∏ì‰∏ö‰ºòÊÉ†ÊëòË¶ÅÂ∞ÜÂ§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºàCtrl+VÔºâ„ÄÇ", de: "F√ºllen Sie Ihre Daten aus. Die professionelle Angebots√ºbersicht wird in Ihre Zwischenablage kopiert (Strg+V).", fr: "Remplissez vos donn√©es. Le r√©sum√© professionnel de l'offre sera copi√© dans votre presse-papiers (Ctrl+V)." },
                "C√ìDIGO COMERCIAL (Obligatorio)": { en: "SALES CODE (Required)", zh: "ÈîÄÂîÆ‰ª£Á†ÅÔºàÂøÖÂ°´Ôºâ", de: "VERTRIEBSCODE (Erforderlich)", fr: "CODE COMMERCIAL (Obligatoire)" },
                "Nombre Cliente": { en: "Client Name", zh: "ÂÆ¢Êà∑ÂßìÂêç", de: "Kundenname", fr: "Nom du Client" },
                "Tel√©fono": { en: "Phone", zh: "ÁîµËØù", de: "Telefon", fr: "T√©l√©phone" },
                "NOTA PARA USUARIOS DE iPHONE:": { en: "NOTE FOR iPHONE USERS:", zh: "iPHONEÁî®Êà∑Ê≥®ÊÑèÔºö", de: "HINWEIS F√úR iPHONE-BENUTZER:", fr: "NOTE POUR LES UTILISATEURS D'iPHONE :" },
                "COPIAR COMPARATIVO (HTML)": { en: "COPY COMPARISON (HTML)", zh: "Â§çÂà∂ÊØîËæÉÔºàHTMLÔºâ", de: "VERGLEICH KOPIEREN (HTML)", fr: "COPIER LA COMPARAISON (HTML)" },
                "CREAR PDF COMPARATIVO": { en: "CREATE PDF COMPARISON", zh: "ÂàõÂª∫PDFÊØîËæÉ", de: "PDF-VERGLEICH ERSTELLEN", fr: "CR√âER UN PDF COMPARATIF" },
                "MODO DE COMPARACI√ìN": { en: "COMPARISON MODE", zh: "ÊØîËæÉÊ®°Âºè", de: "VERGLEICHSMODUS", fr: "MODE DE COMPARAISON" },
                "DRK √önicamente": { en: "DRK Only", zh: "‰ªÖDRK", de: "Nur DRK", fr: "DRK Uniquement" },
                "DRK Prioritario": { en: "DRK Prioritized", zh: "DRK‰ºòÂÖà", de: "DRK Priorit√§t", fr: "DRK Prioritaire" },
                "Global": { en: "Global", zh: "ÂÖ®ÁêÉ", de: "Global", fr: "Global" },
                "DRK COMPARADOR": { en: "DRK COMPARATOR", zh: "DRK ÊØîËæÉÂô®", de: "DRK VERGLEICHER", fr: "COMPARATEUR DRK" },
                "Selecciona el tipo de suministro.": { en: "Select the type of supply.", zh: "ÈÄâÊã©‰æõÂ∫îÁ±ªÂûã„ÄÇ", de: "W√§hlen Sie die Art der Versorgung.", fr: "S√©lectionnez le type d'approvisionnement." },
                "TIPO DE SUMINISTRO": { en: "SUPPLY TYPE", zh: "‰æõÂ∫îÁ±ªÂûã", de: "VERSORGUNGSTYP", fr: "TYPE D'APPROVISIONNEMENT" },
                "ELECTRICIDAD": { en: "ELECTRICITY", zh: "ÁîµÂäõ", de: "ELEKTRIZIT√ÑT", fr: "√âLECTRICIT√â" },
                "MULTICUPS ¬∑ 2.0 TD ¬∑ 3.0 TD": { en: "MULTICUPS ¬∑ 2.0 TD ¬∑ 3.0 TD", zh: "Â§öÂêàÂêå ¬∑ 2.0 TD ¬∑ 3.0 TD", de: "MULTICUPS ¬∑ 2.0 TD ¬∑ 3.0 TD", fr: "MULTICUPS ¬∑ 2.0 TD ¬∑ 3.0 TD" },
                "RL1 ¬∑ RL2 ¬∑ RL3 ¬∑ RL4 ¬∑ RL5 ¬∑ RL6": { en: "RL1 ¬∑ RL2 ¬∑ RL3 ¬∑ RL4 ¬∑ RL5 ¬∑ RL6", zh: "RL1 ¬∑ RL2 ¬∑ RL3 ¬∑ RL4 ¬∑ RL5 ¬∑ RL6", de: "RL1 ¬∑ RL2 ¬∑ RL3 ¬∑ RL4 ¬∑ RL5 ¬∑ RL6", fr: "RL1 ¬∑ RL2 ¬∑ RL3 ¬∑ RL4 ¬∑ RL5 ¬∑ RL6" },
                "ELECTRICIDAD + GAS": { en: "ELECTRICITY + GAS", zh: "ÁîµÂäõ + Â§©ÁÑ∂Ê∞î", de: "ELEKTRIZIT√ÑT + GAS", fr: "√âLECTRICIT√â + GAZ" },
                "M√∫ltiples suministros ¬∑ Comparativa global": { en: "Multiple supplies ¬∑ Global comparison", zh: "Â§ö‰∏™‰æõÂ∫î ¬∑ ÂÖ®Èù¢ÊØîËæÉ", de: "Mehrere Versorgungen ¬∑ Globaler Vergleich", fr: "Multiples approvisionnements ¬∑ Comparaison globale" },
                "Continuar": { en: "Continue", zh: "ÁªßÁª≠", de: "Fortfahren", fr: "Continuer" },
                "Volver": { en: "Back", zh: "ËøîÂõû", de: "Zur√ºck", fr: "Retour" },
                "Calcular Ahorro": { en: "Calculate Savings", zh: "ËÆ°ÁÆóËäÇÁúÅ", de: "Ersparnis berechnen", fr: "Calculer les √âconomies" },
                "Energ√≠a": { en: "Energy", zh: "ËÉΩÊ∫ê", de: "Energie", fr: "√ânergie" },
                "ËÉΩÊ∫ê": { es: "Energ√≠a", en: "Energy", zh: "ËÉΩÊ∫ê", de: "Energie", fr: "√ânergie" },
                "ÂºïÈ¢ÜËäÇÁúÅÂíåËÉΩÊ∫êÊïàÁéá": { es: "Liderando el ahorro y la eficiencia energ√©tica", en: "Leading savings and energy efficiency", zh: "ÂºïÈ¢ÜËäÇÁúÅÂíåËÉΩÊ∫êÊïàÁéá", de: "F√ºhrend bei Einsparungen und Energieeffizienz", fr: "Leader en √©conomies et efficacit√© √©nerg√©tique" },
                "‰∏∫ÊÇ®Êèê‰æõÁöÑÊúÄ‰Ω≥ÈÄâÊã©": { es: "La mejor opci√≥n para ti", en: "The best option for you", zh: "‰∏∫ÊÇ®Êèê‰æõÁöÑÊúÄ‰Ω≥ÈÄâÊã©", de: "Die beste Option f√ºr Sie", fr: "La meilleure option pour vous" },
                "ÊÇ®ÁöÑÈ¢ÑËÆ°Âπ¥Â∫¶ËäÇÁúÅ": { es: "Tu ahorro anual estimado", en: "Your estimated annual savings", zh: "ÊÇ®ÁöÑÈ¢ÑËÆ°Âπ¥Â∫¶ËäÇÁúÅ", de: "Ihre gesch√§tzte j√§hrliche Ersparnis", fr: "Vos √©conomies annuelles estim√©es" },
                "ÊÇ®ÁöÑÂΩìÂâçË¥¶Âçï": { es: "Tu factura actual", en: "Your current bill", zh: "ÊÇ®ÁöÑÂΩìÂâçË¥¶Âçï", de: "Ihre aktuelle Rechnung", fr: "Votre facture actuelle" },
                "ÊÇ®ÁöÑÊñ∞DRKÊàêÊú¨": { es: "Tu nuevo coste DRK", en: "Your new DRK cost", zh: "ÊÇ®ÁöÑÊñ∞DRKÊàêÊú¨", de: "Ihre neuen DRK-Kosten", fr: "Votre nouveau co√ªt DRK" },
                "ÊèêÂèñÊï∞ÊçÆ": { es: "Datos extra√≠dos", en: "Extracted data", zh: "ÊèêÂèñÊï∞ÊçÆ", de: "Extrahierte Daten", fr: "Donn√©es extraites" },
                "ÊúüÈó¥": { es: "Periodo", en: "Period", zh: "ÊúüÈó¥", de: "Zeitraum", fr: "P√©riode" },
                "Â§©": { es: "d√≠as", en: "days", zh: "Â§©", de: "Tage", fr: "jours" },
                "Êó•Êúü": { es: "Fecha", en: "Date", zh: "Êó•Êúü", de: "Datum", fr: "Date" },
                "ÊúüÈó¥Ê∂àËÄó (kWh)": { es: "Consumo del periodo (kWh)", en: "Period consumption (kWh)", zh: "ÊúüÈó¥Ê∂àËÄó (kWh)", de: "Verbrauch im Zeitraum (kWh)", fr: "Consommation de la p√©riode (kWh)" },
                "Â≥∞ÂÄº": { es: "Punta", en: "Peak", zh: "Â≥∞ÂÄº", de: "Spitzenlast", fr: "Pointe" },
                "Âπ≥ÊÆµ": { es: "Llano", en: "Mid-peak", zh: "Âπ≥ÊÆµ", de: "Mittellast", fr: "Heures pleines" },
                "Ë∞∑ÊÆµ": { es: "Valle", en: "Off-peak", zh: "Ë∞∑ÊÆµ", de: "Schwachlast", fr: "Heures creuses" },
                "ÊÄªÊ∂àËÄó": { es: "Consumo total", en: "Total consumption", zh: "ÊÄªÊ∂àËÄó", de: "Gesamtverbrauch", fr: "Consommation totale" },
                "Á≠æÁ∫¶ÂäüÁéá (kW)": { es: "Potencia contratada (kW)", en: "Contracted power (kW)", zh: "Á≠æÁ∫¶ÂäüÁéá (kW)", de: "Vertragsleistung (kW)", fr: "Puissance contract√©e (kW)" },
                "ÂêàÂπ∂Êä•‰ª∑‰ª∑Ê†º": { es: "Precios de la oferta combinada", en: "Combined offer prices", zh: "ÂêàÂπ∂Êä•‰ª∑‰ª∑Ê†º", de: "Kombinierte Angebotspreise", fr: "Prix de l'offre combin√©e" },
                "ËµÑË¥π 2.0 TD": { es: "Tarifa 2.0 TD", en: "Tariff 2.0 TD", zh: "ËµÑË¥π 2.0 TD", de: "Tarif 2.0 TD", fr: "Tarif 2.0 TD" },
                "Êó•": { es: "d√≠a", en: "day", zh: "Êó•", de: "Tag", fr: "jour" },
                "ËÉΩÊ∫ê (‚Ç¨/kWh)": { es: "Energ√≠a (‚Ç¨/kWh)", en: "Energy (‚Ç¨/kWh)", zh: "ËÉΩÊ∫ê (‚Ç¨/kWh)", de: "Energie (‚Ç¨/kWh)", fr: "√ânergie (‚Ç¨/kWh)" },
                "ÊòæÁ§∫ÁöÑ‰ª∑Ê†ºÊù•Ëá™‰∏≠Ê†áÊä•‰ª∑„ÄÇ": { es: "Los precios mostrados son de la oferta ganadora.", en: "Displayed prices are from the winning offer.", zh: "ÊòæÁ§∫ÁöÑ‰ª∑Ê†ºÊù•Ëá™‰∏≠Ê†áÊä•‰ª∑„ÄÇ", de: "Angezeigte Preise stammen aus dem Gewinner-Angebot.", fr: "Les prix affich√©s proviennent de l'offre gagnante." },
                "ÂÆòÊñπËÆ°ÁÆó": { es: "C√°lculo oficial", en: "Official calculation", zh: "ÂÆòÊñπËÆ°ÁÆó", de: "Offizielle Berechnung", fr: "Calcul officiel" },
                "Ê®°Êãü": { es: "Simulaci√≥n", en: "Simulation", zh: "Ê®°Êãü", de: "Simulation", fr: "Simulation" },
                "ÂäüÁéá (‚Ç¨/kW Êó•)": { es: "Potencia (‚Ç¨/kW d√≠a)", en: "Power (‚Ç¨/kW day)", zh: "ÂäüÁéá (‚Ç¨/kW Êó•)", de: "Leistung (‚Ç¨/kW Tag)", fr: "Puissance (‚Ç¨/kW jour)" },
                "ÂäüÁéáÂ∞èËÆ°": { es: "Subtotal potencia", en: "Power subtotal", zh: "ÂäüÁéáÂ∞èËÆ°", de: "Leistung Zwischensumme", fr: "Sous-total puissance" },
                "Â¢ûÂÄºÁ®éÔºà21%Ôºâ": { es: "IVA (21%)", en: "VAT (21%)", zh: "Â¢ûÂÄºÁ®éÔºà21%Ôºâ", de: "MwSt. (21%)", fr: "TVA (21%)" },
                "ÊÄªË¥¶Âçï": { es: "Factura total", en: "Total bill", zh: "ÊÄªË¥¶Âçï", de: "Gesamtrechnung", fr: "Facture totale" },
                "‰º∞ËÆ°Âπ¥Â∫¶ÊÄªÈ¢ù": { es: "Total anual estimado", en: "Estimated annual total", zh: "‰º∞ËÆ°Âπ¥Â∫¶ÊÄªÈ¢ù", de: "Gesch√§tzte Jahressumme", fr: "Total annuel estim√©" },
                "ÊâÄÊúâÊñáÊú¨Âùá‰∏∫‰∏≠Êñá ¬∑ ÂèØÁõ¥Êé•‰ΩøÁî®": { es: "Todo el texto en idioma actual ¬∑ Listo para usar", en: "All text in current language ¬∑ Ready to use", zh: "ÊâÄÊúâÊñáÊú¨Âùá‰∏∫‰∏≠Êñá ¬∑ ÂèØÁõ¥Êé•‰ΩøÁî®", de: "Alle Texte in aktueller Sprache ¬∑ Sofort einsatzbereit", fr: "Tout le texte dans la langue actuelle ¬∑ Pr√™t √† l'emploi" },
                "Selector": { en: "Selector", zh: "ÈÄâÊã©Âô®", de: "Auswahl", fr: "S√©lecteur" },
                "MULTICUPS": { en: "MULTICUPS", zh: "Â§öÂêàÂêå", de: "MULTICUPS", fr: "MULTICUPS" },
                "GAS": { en: "GAS", zh: "Â§©ÁÑ∂Ê∞î", de: "GAS", fr: "GAZ" },
                "DUAL": { en: "DUAL", zh: "ÂèåÈáç", de: "DUAL", fr: "DUAL" },
                "d√≠as": { en: "days", zh: "Â§©", de: "Tage", fr: "jours" },
                
                // Botones y acciones PDF/Copiar
                "Descargar PDF Global": { en: "Download Global PDF", zh: "‰∏ãËΩΩÂÖ®Â±ÄPDF", de: "Globales PDF herunterladen", fr: "T√©l√©charger PDF Global" },
                "Copiar HTML": { en: "Copy HTML", zh: "Â§çÂà∂HTML", de: "HTML kopieren", fr: "Copier HTML" },
                "COPIAR COMPARATIVO": { en: "COPY COMPARISON", zh: "Â§çÂà∂ÊØîËæÉ", de: "VERGLEICH KOPIEREN", fr: "COPIER LA COMPARAISON" },
                "üìã COPIAR COMPARATIVO (HTML)": { en: "üìã COPY COMPARISON (HTML)", zh: "üìã Â§çÂà∂ÊØîËæÉÔºàHTMLÔºâ", de: "üìã VERGLEICH KOPIEREN (HTML)", fr: "üìã COPIER LA COMPARAISON (HTML)" },
                "üìÑ CREAR PDF COMPARATIVO": { en: "üìÑ CREATE PDF COMPARISON", zh: "üìÑ ÂàõÂª∫PDFÊØîËæÉ", de: "üìÑ PDF-VERGLEICH ERSTELLEN", fr: "üìÑ CR√âER UN PDF COMPARATIF" },
                "üìß COPIAR COMPARATIVO (HTML)": { en: "üìß COPY COMPARISON (HTML)", zh: "üìß Â§çÂà∂ÊØîËæÉÔºàHTMLÔºâ", de: "üìß VERGLEICH KOPIEREN (HTML)", fr: "üìß COPIER LA COMPARAISON (HTML)" },
                
                // Modales y mensajes
                "Entendido": { en: "Understood", zh: "ÊòéÁôΩ", de: "Verstanden", fr: "Compris" },
                "√âxito": { en: "Success", zh: "ÊàêÂäü", de: "Erfolg", fr: "Succ√®s" },
                "¬°Atenci√≥n!": { en: "Attention!", zh: "Ê≥®ÊÑèÔºÅ", de: "Achtung!", fr: "Attention!" },
                
                // Mensajes de error y validaci√≥n
                "No se detect√≥ ninguna imagen en el portapapeles.": { en: "No image detected in clipboard.", zh: "Êú™Âú®Ââ™Ë¥¥Êùø‰∏≠Ê£ÄÊµãÂà∞ÂõæÂÉè„ÄÇ", de: "Kein Bild in der Zwischenablage erkannt.", fr: "Aucune image d√©tect√©e dans le presse-papiers." },
                "A√±ada al menos un suministro.": { en: "Add at least one supply.", zh: "Ëá≥Â∞ëÊ∑ªÂä†‰∏Ä‰∏™‰æõÂ∫î„ÄÇ", de: "F√ºgen Sie mindestens eine Versorgung hinzu.", fr: "Ajoutez au moins un approvisionnement." },
                "No hay suministros para comparar.": { en: "No supplies to compare.", zh: "Ê≤°ÊúâË¶ÅÊØîËæÉÁöÑ‰æõÂ∫î„ÄÇ", de: "Keine Versorgungen zum Vergleichen.", fr: "Aucun approvisionnement √† comparer." },
                "Primero realice una comparaci√≥n.": { en: "First perform a comparison.", zh: "ËØ∑ÂÖàËøõË°åÊØîËæÉ„ÄÇ", de: "F√ºhren Sie zuerst einen Vergleich durch.", fr: "Effectuez d'abord une comparaison." },
                "Indique el C√≥digo Comercial.": { en: "Enter the Sales Code.", zh: "ËæìÂÖ•ÈîÄÂîÆ‰ª£Á†Å„ÄÇ", de: "Geben Sie den Vertriebscode ein.", fr: "Indiquez le Code Commercial." },
                "No se pudo copiar el dise√±o visual. Intente desde un PC o contacte a soporte.": { en: "Could not copy visual design. Try from a PC or contact support.", zh: "Êó†Ê≥ïÂ§çÂà∂ËßÜËßâËÆæËÆ°„ÄÇËØ∑‰ªéPCÂ∞ùËØïÊàñËÅîÁ≥ªÊîØÊåÅ„ÄÇ", de: "Visuelles Design konnte nicht kopiert werden. Versuchen Sie es von einem PC aus oder kontaktieren Sie den Support.", fr: "Impossible de copier le design visuel. Essayez depuis un PC ou contactez le support." },
                "No se pudo copiar el contenido. Por favor, contacte a soporte.": { en: "Could not copy content. Please contact support.", zh: "Êó†Ê≥ïÂ§çÂà∂ÂÜÖÂÆπ„ÄÇËØ∑ËÅîÁ≥ªÊîØÊåÅ„ÄÇ", de: "Inhalt konnte nicht kopiert werden. Bitte kontaktieren Sie den Support.", fr: "Impossible de copier le contenu. Veuillez contacter le support." },
                
                // Mensajes de generaci√≥n de PDF
                "‚è≥ Generando PDF con comparaci√≥n Fijo vs Indexado... Por favor espere.": { en: "‚è≥ Generating PDF with Fixed vs Indexed comparison... Please wait.", zh: "‚è≥ Ê≠£Âú®ÁîüÊàêÂõ∫ÂÆö‰∏éÊåáÊï∞ÊØîËæÉPDF...ËØ∑Á®çÂÄô„ÄÇ", de: "‚è≥ PDF mit Vergleich Fest vs. Indexiert wird erstellt... Bitte warten.", fr: "‚è≥ G√©n√©ration du PDF avec comparaison Fixe vs Index√©... Veuillez patienter." },
                "‚è≥ Generando PDF MULTICUPS con comparaci√≥n Fijo vs Indexado... Por favor espere.": { en: "‚è≥ Generating MULTICUPS PDF with Fixed vs Indexed comparison... Please wait.", zh: "‚è≥ Ê≠£Âú®ÁîüÊàêÂ§öÂêàÂêåÂõ∫ÂÆö‰∏éÊåáÊï∞ÊØîËæÉPDF...ËØ∑Á®çÂÄô„ÄÇ", de: "‚è≥ MULTICUPS-PDF mit Vergleich Fest vs. Indexiert wird erstellt... Bitte warten.", fr: "‚è≥ G√©n√©ration du PDF MULTICUPS avec comparaison Fixe vs Index√©... Veuillez patienter." },
                "‚è≥ Generando PDF profesional... Por favor espere.": { en: "‚è≥ Generating professional PDF... Please wait.", zh: "‚è≥ Ê≠£Âú®ÁîüÊàê‰∏ì‰∏öPDF...ËØ∑Á®çÂÄô„ÄÇ", de: "‚è≥ Professionelles PDF wird erstellt... Bitte warten.", fr: "‚è≥ G√©n√©ration du PDF professionnel... Veuillez patienter." },
                "‚è≥ Generando PDF... Por favor espere.": { en: "‚è≥ Generating PDF... Please wait.", zh: "‚è≥ Ê≠£Âú®ÁîüÊàêPDF...ËØ∑Á®çÂÄô„ÄÇ", de: "‚è≥ PDF wird erstellt... Bitte warten.", fr: "‚è≥ G√©n√©ration du PDF... Veuillez patienter." },
                "‚è≥ Generando PDF comparativo...": { en: "‚è≥ Generating comparison PDF...", zh: "‚è≥ Ê≠£Âú®ÁîüÊàêÊØîËæÉPDF...", de: "‚è≥ Vergleichs-PDF wird erstellt...", fr: "‚è≥ G√©n√©ration du PDF comparatif..." },
                "‚è≥ Generando PDF POWER CUP...": { en: "‚è≥ Generating POWER CUP PDF...", zh: "‚è≥ Ê≠£Âú®ÁîüÊàêPOWER CUP PDF...", de: "‚è≥ POWER CUP PDF wird erstellt...", fr: "‚è≥ G√©n√©ration du PDF POWER CUP..." },
                "‚è≥ Generando PDF comparativo POWER CUP...": { en: "‚è≥ Generating POWER CUP comparison PDF...", zh: "‚è≥ Ê≠£Âú®ÁîüÊàêPOWER CUPÊØîËæÉPDF...", de: "‚è≥ POWER CUP Vergleichs-PDF wird erstellt...", fr: "‚è≥ G√©n√©ration du PDF comparatif POWER CUP..." },
                
                // Mensajes de alertas
                "‚ùå No se pudo copiar autom√°ticamente.\\n\\nPor favor, usa el bot√≥n \"CREAR PDF COMPARATIVO\" en su lugar.": { en: "‚ùå Could not copy automatically.\\n\\nPlease use the \"CREATE PDF COMPARISON\" button instead.", zh: "‚ùå Êó†Ê≥ïËá™Âä®Â§çÂà∂„ÄÇ\\n\\nËØ∑ÊîπÁî®\"ÂàõÂª∫PDFÊØîËæÉ\"ÊåâÈíÆ„ÄÇ", de: "‚ùå Automatisches Kopieren fehlgeschlagen.\\n\\nBitte verwenden Sie stattdessen die Schaltfl√§che \"PDF-VERGLEICH ERSTELLEN\".", fr: "‚ùå Impossible de copier automatiquement.\\n\\nVeuillez utiliser le bouton \"CR√âER UN PDF COMPARATIF\" √† la place." },
                "No se pudo copiar autom√°ticamente.\\n\\n‚úÖ SOLUCI√ìN:\\n\\n1. Haz clic derecho sobre el contenido abajo\\n2. Selecciona \"Copiar\"\\n3. Pega en tu correo electr√≥nico\\n\\nO usa Ctrl+A para seleccionar todo y luego Ctrl+C para copiar.": { en: "Could not copy automatically.\\n\\n‚úÖ SOLUTION:\\n\\n1. Right-click on the content below\\n2. Select \"Copy\"\\n3. Paste into your email\\n\\nOr use Ctrl+A to select all and then Ctrl+C to copy.", zh: "Êó†Ê≥ïËá™Âä®Â§çÂà∂„ÄÇ\\n\\n‚úÖ Ëß£ÂÜ≥ÊñπÊ°àÔºö\\n\\n1. Âè≥ÈîÆÂçïÂáª‰∏ãÈù¢ÁöÑÂÜÖÂÆπ\\n2. ÈÄâÊã©\"Â§çÂà∂\"\\n3. Á≤òË¥¥Âà∞ÊÇ®ÁöÑÁîµÂ≠êÈÇÆ‰ª∂\\n\\nÊàñ‰ΩøÁî®Ctrl+AÈÄâÊã©ÂÖ®ÈÉ®ÔºåÁÑ∂Âêé‰ΩøÁî®Ctrl+CÂ§çÂà∂„ÄÇ", de: "Automatisches Kopieren fehlgeschlagen.\\n\\n‚úÖ L√ñSUNG:\\n\\n1. Rechtsklick auf den Inhalt unten\\n2. \"Kopieren\" ausw√§hlen\\n3. In Ihre E-Mail einf√ºgen\\n\\nOder verwenden Sie Strg+A zum Ausw√§hlen und dann Strg+C zum Kopieren.", fr: "Impossible de copier automatiquement.\\n\\n‚úÖ SOLUTION :\\n\\n1. Clic droit sur le contenu ci-dessous\\n2. S√©lectionnez \"Copier\"\\n3. Collez dans votre e-mail\\n\\nOu utilisez Ctrl+A pour tout s√©lectionner puis Ctrl+C pour copier." },
                "<span style=\"color: #16a34a; font-weight: bold;\">OPCI√ìN 1:</span> Haz clic en \"Copiar HTML\" (autom√°tico)": { en: "<span style=\"color: #16a34a; font-weight: bold;\">OPTION 1:</span> Click \"Copy HTML\" (automatic)", zh: "<span style=\"color: #16a34a; font-weight: bold;\">ÈÄâÈ°π1Ôºö</span> ÁÇπÂáª\"Â§çÂà∂HTML\"ÔºàËá™Âä®Ôºâ", de: "<span style=\"color: #16a34a; font-weight: bold;\">OPTION 1:</span> Klicken Sie auf \"HTML kopieren\" (automatisch)", fr: "<span style=\"color: #16a34a; font-weight: bold;\">OPTION 1 :</span> Cliquez sur \"Copier HTML\" (automatique)" },
                
                // Textos del PDF y visualizador comparativo
                "üìä ESTUDIO DE AHORRO": { en: "üìä SAVINGS STUDY", zh: "üìä ËäÇÁúÅÁ†îÁ©∂", de: "üìä EINSPARUNGSSTUDIE", fr: "üìä √âTUDE D'√âCONOMIES" },
                "ESTUDIO DE AHORRO": { en: "SAVINGS STUDY", zh: "ËäÇÁúÅÁ†îÁ©∂", de: "EINSPARUNGSSTUDIE", fr: "√âTUDE D'√âCONOMIES" },
                "COMPARATIVA PROFESIONAL": { en: "PROFESSIONAL COMPARISON", zh: "‰∏ì‰∏öÊØîËæÉ", de: "PROFESSIONELLER VERGLEICH", fr: "COMPARAISON PROFESSIONNELLE" },
                "Asesor√≠a Energ√©tica": { en: "Energy Consulting", zh: "ËÉΩÊ∫êÂí®ËØ¢", de: "Energieberatung", fr: "Conseil √ânerg√©tique" },
                "Liderando el ahorro y la eficiencia energ√©tica.": { en: "Leading savings and energy efficiency.", zh: "ÂºïÈ¢ÜËäÇÁúÅÂíåËÉΩÊ∫êÊïàÁéá„ÄÇ", de: "F√ºhrend bei Einsparungen und Energieeffizienz.", fr: "Leader des √©conomies et de l'efficacit√© √©nerg√©tique." },
                "Ofrece el mayor ahorro consolidado con": { en: "Offers the highest consolidated savings with", zh: "Êèê‰æõÊúÄÈ´òÁöÑÁªºÂêàËäÇÁúÅ‰∏é", de: "Bietet die h√∂chsten konsolidierten Einsparungen mit", fr: "Offre les √©conomies consolid√©es les plus √©lev√©es avec" },
                "TU FACTURA ACTUAL": { en: "YOUR CURRENT BILL", zh: "ÊÇ®ÂΩìÂâçÁöÑË¥¶Âçï", de: "IHRE AKTUELLE RECHNUNG", fr: "VOTRE FACTURE ACTUELLE" },
                "TU AHORRO ANUAL FIJO": { en: "YOUR ANNUAL FIXED SAVINGS", zh: "ÊÇ®ÁöÑÂπ¥Â∫¶Âõ∫ÂÆöËäÇÁúÅ", de: "IHRE J√ÑHRLICHEN FESTEN EINSPARUNGEN", fr: "VOS √âCONOMIES ANNUELLES FIXES" },
                "TU AHORRO ANUAL INDEXADO": { en: "YOUR ANNUAL INDEXED SAVINGS", zh: "ÊÇ®ÁöÑÂπ¥Â∫¶ÊåáÊï∞ËäÇÁúÅ", de: "IHRE J√ÑHRLICHEN INDEXIERTEN EINSPARUNGEN", fr: "VOS √âCONOMIES ANNUELLES INDEX√âES" },
                "Tu Ahorro Anual Estimado": { en: "Your Estimated Annual Savings", zh: "ÊÇ®ÁöÑÈ¢ÑËÆ°Âπ¥Â∫¶ËäÇÁúÅ", de: "Ihre gesch√§tzten j√§hrlichen Einsparungen", fr: "Vos √âconomies Annuelles Estim√©es" },
                "üí∞ Ahorro Total": { en: "üí∞ Total Savings", zh: "üí∞ ÊÄªËäÇÁúÅ", de: "üí∞ Gesamtersparnis", fr: "üí∞ √âconomies Totales" },
                "Ahorro Anual": { en: "Annual Savings", zh: "Âπ¥Â∫¶ËäÇÁúÅ", de: "J√§hrliche Einsparungen", fr: "√âconomies Annuelles" },
                "üíµ Ahorro Anual Estimado:": { en: "üíµ Estimated Annual Savings:", zh: "üíµ È¢ÑËÆ°Âπ¥Â∫¶ËäÇÁúÅÔºö", de: "üíµ Gesch√§tzte j√§hrliche Einsparungen:", fr: "üíµ √âconomies Annuelles Estim√©es :" },
                "üíµ Ahorro Anual Consolidado:": { en: "üíµ Consolidated Annual Savings:", zh: "üíµ ÁªºÂêàÂπ¥Â∫¶ËäÇÁúÅÔºö", de: "üíµ Konsolidierte j√§hrliche Einsparungen:", fr: "üíµ √âconomies Annuelles Consolid√©es :" },
                "üéâ Ahorro Anual Total:": { en: "üéâ Total Annual Savings:", zh: "üéâ Âπ¥Â∫¶ÊÄªËäÇÁúÅÔºö", de: "üéâ J√§hrliche Gesamtersparnis:", fr: "üéâ √âconomies Annuelles Totales :" },
                "üíº Ahorro Total con Tarifas FIJAS:": { en: "üíº Total Savings with FIXED Rates:", zh: "üíº Âõ∫ÂÆöË¥πÁéáÊÄªËäÇÁúÅÔºö", de: "üíº Gesamtersparnis mit FESTEN Tarifen:", fr: "üíº √âconomies Totales avec Tarifs FIXES :" },
                "‚ö° Ahorro Total con Tarifas INDEXADAS:": { en: "‚ö° Total Savings with INDEXED Rates:", zh: "‚ö° ÊåáÊï∞Ë¥πÁéáÊÄªËäÇÁúÅÔºö", de: "‚ö° Gesamtersparnis mit INDEXIERTEN Tarifen:", fr: "‚ö° √âconomies Totales avec Tarifs INDEX√âS :" },
                "CUPS:": { en: "CUPS:", zh: "CUPSÔºö", de: "CUPS:", fr: "CUPS :" },
                "üîå CUPS:": { en: "üîå CUPS:", zh: "üîå CUPSÔºö", de: "üîå CUPS:", fr: "üîå CUPS :" },
                "a√±o": { en: "year", zh: "Âπ¥", de: "Jahr", fr: "an" },
                "/a√±o": { en: "/year", zh: "/Âπ¥", de: "/Jahr", fr: "/an" },
                "basado en el consumo de": { en: "based on consumption of", zh: "Âü∫‰∫éÊ∂àËÄó", de: "basierend auf einem Verbrauch von", fr: "bas√© sur une consommation de" },
                "üìä Total de CUPS:": { en: "üìä Total CUPS:", zh: "üìä ÊÄªCUPSÔºö", de: "üìä Gesamt-CUPS:", fr: "üìä Total CUPS :" },
                "TOTAL CUPS:": { en: "TOTAL CUPS:", zh: "ÊÄªCUPSÔºö", de: "GESAMT-CUPS:", fr: "TOTAL CUPS :" },
                "üìä COMPARATIVA MULTICUPS:": { en: "üìä MULTICUPS COMPARISON:", zh: "üìä Â§öÂêàÂêåÊØîËæÉÔºö", de: "üìä MULTICUPS-VERGLEICH:", fr: "üìä COMPARAISON MULTICUPS :" },
                
                // Textos adicionales del PDF
                "CLIENTE:": { en: "CLIENT:", zh: "ÂÆ¢Êà∑Ôºö", de: "KUNDE:", fr: "CLIENT :" },
                "COMERCIAL:": { en: "SALES REP:", zh: "ÈîÄÂîÆ‰ª£Ë°®Ôºö", de: "VERTRIEB:", fr: "COMMERCIAL :" },
                "PRECIOS DE LA OFERTA:": { en: "OFFER PRICES:", zh: "Êä•‰ª∑‰ª∑Ê†ºÔºö", de: "ANGEBOTSPREISE:", fr: "PRIX DE L'OFFRE :" },
                "POTENCIA:": { en: "POWER:", zh: "ÂäüÁéáÔºö", de: "LEISTUNG:", fr: "PUISSANCE :" },
                "ENERGIA:": { en: "ENERGY:", zh: "ËÉΩÊ∫êÔºö", de: "ENERGIE:", fr: "√âNERGIE :" },
                "DESGLOSE DETALLADO POR SUMINISTRO": { en: "DETAILED BREAKDOWN BY SUPPLY", zh: "Êåâ‰æõÂ∫îËØ¶ÁªÜÂàÜÁ±ª", de: "DETAILLIERTE AUFSCHL√úSSELUNG NACH VERSORGUNG", fr: "R√âPARTITION D√âTAILL√âE PAR APPROVISIONNEMENT" },
                "DESGLOSE DETALLADO DE LA SIMULACI√ìN": { en: "DETAILED SIMULATION BREAKDOWN", zh: "ËØ¶ÁªÜÊ®°ÊãüÂàÜÁ±ª", de: "DETAILLIERTE SIMULATIONSAUFSCHL√úSSELUNG", fr: "R√âPARTITION D√âTAILL√âE DE LA SIMULATION" },
                "T√âRMINO POTENCIA (Precio en ‚Ç¨/kW D√≠a)": { en: "POWER TERM (Price in ‚Ç¨/kW Day)", zh: "ÂäüÁéáÊù°Ê¨æÔºà‰ª∑Ê†º‚Ç¨/kWÊó•Ôºâ", de: "LEISTUNGSTERM (Preis in ‚Ç¨/kW Tag)", fr: "TERME PUISSANCE (Prix en ‚Ç¨/kW Jour)" },
                "T√âRMINO ENERG√çA (Precios en ‚Ç¨/kWh)": { en: "ENERGY TERM (Prices in ‚Ç¨/kWh)", zh: "ËÉΩÊ∫êÊù°Ê¨æÔºà‰ª∑Ê†º‚Ç¨/kWhÔºâ", de: "ENERGIETERM (Preise in ‚Ç¨/kWh)", fr: "TERME √âNERGIE (Prix en ‚Ç¨/kWh)" },
                "SUBTOTAL POTENCIA": { en: "POWER SUBTOTAL", zh: "ÂäüÁéáÂ∞èËÆ°", de: "LEISTUNG ZWISCHENSUMME", fr: "SOUS-TOTAL PUISSANCE" },
                "Subtotal Energ√≠a (Bruto)": { en: "Energy Subtotal (Gross)", zh: "ËÉΩÊ∫êÂ∞èËÆ°ÔºàÊØõÈ¢ùÔºâ", de: "Energie Zwischensumme (Brutto)", fr: "Sous-total √ânergie (Brut)" },
                "Subtotal Energ√≠a (Neto)": { en: "Energy Subtotal (Net)", zh: "ËÉΩÊ∫êÂ∞èËÆ°ÔºàÂáÄÈ¢ùÔºâ", de: "Energie Zwischensumme (Netto)", fr: "Sous-total √ânergie (Net)" },
                "SUBTOTAL BASE (P+E)": { en: "BASE SUBTOTAL (P+E)", zh: "Âü∫Á°ÄÂ∞èËÆ°ÔºàP+EÔºâ", de: "BASIS ZWISCHENSUMME (P+E)", fr: "SOUS-TOTAL BASE (P+E)" },
                "BASE IMPONIBLE": { en: "TAXABLE BASE", zh: "Â∫îÁ®éÂü∫Êï∞", de: "STEUERBEMESSUNGSGRUNDLAGE", fr: "BASE IMPOSABLE" },
                "Imp. El√©c.": { en: "Elec. Tax", zh: "ÁîµÂäõÁ®é", de: "Strom-Steuer", fr: "Taxe √âlec." },
                "IVA (21%)": { en: "VAT (21%)", zh: "Â¢ûÂÄºÁ®éÔºà21%Ôºâ", de: "MwSt. (21%)", fr: "TVA (21%)" },
                "TOTAL FACTURA": { en: "TOTAL BILL", zh: "ÊÄªË¥¶Âçï", de: "GESAMTRECHNUNG", fr: "FACTURE TOTALE" },
                "TOTAL A√ëO (PROYECTADO)": { en: "TOTAL YEAR (PROJECTED)", zh: "Âπ¥Â∫¶ÊÄªËÆ°ÔºàÈ¢ÑËÆ°Ôºâ", de: "GESAMTJAHR (PROGNOSTIZIERT)", fr: "TOTAL ANN√âE (PROJET√â)" },
                "TOTAL FACTURA ACTUAL:": { en: "CURRENT TOTAL BILL:", zh: "ÂΩìÂâçÊÄªË¥¶ÂçïÔºö", de: "AKTUELLE GESAMTRECHNUNG:", fr: "FACTURE TOTALE ACTUELLE :" },
                "TU AHORRO ANUAL ESTIMADO ES:": { en: "YOUR ESTIMATED ANNUAL SAVINGS IS:", zh: "ÊÇ®ÁöÑÈ¢ÑËÆ°Âπ¥Â∫¶ËäÇÁúÅ‰∏∫Ôºö", de: "IHRE GESCH√ÑTZTEN J√ÑHRLICHEN EINSPARUNGEN BETRAGEN:", fr: "VOS √âCONOMIES ANNUELLES ESTIM√âES SONT :" },
                "¬°CONSIGUE TU AHORRO ANUAL!": { en: "GET YOUR ANNUAL SAVINGS!", zh: "Ëé∑ÂèñÊÇ®ÁöÑÂπ¥Â∫¶ËäÇÁúÅÔºÅ", de: "HOLEN SIE SICH IHRE J√ÑHRLICHEN EINSPARUNGEN!", fr: "OBTENEZ VOS √âCONOMIES ANNUELLES !" },
                "AHORRO TOTAL CONSOLIDADO": { en: "TOTAL CONSOLIDATED SAVINGS", zh: "ÂêàÂπ∂ÊÄªËäÇÁúÅ", de: "KONSOLIDIERTE GESAMTEINSPARUNGEN", fr: "√âCONOMIES TOTALES CONSOLID√âES" },
                "RESUMEN DE AHORRO FINAL": { en: "FINAL SAVINGS SUMMARY", zh: "ÊúÄÁªàËäÇÁúÅÊëòË¶Å", de: "ENDG√úLTIGE EINSPARUNGSZUSAMMENFASSUNG", fr: "R√âSUM√â FINAL DES √âCONOMIES" },
                "RESUMEN DE PRECIOS DE LA OFERTA √öNICA": { en: "SINGLE OFFER PRICE SUMMARY", zh: "Âçï‰∏ÄÊä•‰ª∑‰ª∑Ê†ºÊëòË¶Å", de: "PREISZUSAMMENFASSUNG DES EINZELANGEBOTS", fr: "R√âSUM√â DES PRIX DE L'OFFRE UNIQUE" },
                "/ A√ëO": { en: "/ YEAR", zh: "/ Âπ¥", de: "/ JAHR", fr: "/ AN" },
                
                // Documentaci√≥n y formalizaci√≥n
                "PARA FORMALIZAR ESTE CONTRATO:": { en: "TO FORMALIZE THIS CONTRACT:", zh: "‰∏∫‰∫ÜÊ≠£ÂºèÁ≠æËÆ¢Êú¨ÂêàÂêåÔºö", de: "UM DIESEN VERTRAG ZU FORMALISIEREN:", fr: "POUR FORMALISER CE CONTRAT :" },
                "Responde a este email adjuntando la siguiente documentacion:": { en: "Reply to this email attaching the following documentation:", zh: "ÂõûÂ§çÊ≠§ÈÇÆ‰ª∂Âπ∂ÈôÑ‰∏ä‰ª•‰∏ãÊñá‰ª∂Ôºö", de: "Antworten Sie auf diese E-Mail mit folgenden Unterlagen:", fr: "R√©pondez √† cet e-mail en joignant les documents suivants :" },
                "Responde a este email adjuntando la siguiente documentaci√≥n:": { en: "Reply to this email attaching the following documentation:", zh: "ÂõûÂ§çÊ≠§ÈÇÆ‰ª∂Âπ∂ÈôÑ‰∏ä‰ª•‰∏ãÊñá‰ª∂Ôºö", de: "Antworten Sie auf diese E-Mail mit folgenden Unterlagen:", fr: "R√©pondez √† cet e-mail en joignant les documents suivants :" },
                "1. Foto del DNI/CIF (anverso y reverso)": { en: "1. Photo of ID/Tax ID (front and back)", zh: "1. Ë∫´‰ªΩËØÅ/Á®éÂè∑ÁÖßÁâáÔºàÊ≠£ÂèçÈù¢Ôºâ", de: "1. Foto des Personalausweises/Steuernummer (Vorder- und R√ºckseite)", fr: "1. Photo de la carte d'identit√©/num√©ro fiscal (recto et verso)" },
                "2. Ultima factura (minimo 3 meses de antiguedad)": { en: "2. Latest invoice (minimum 3 months old)", zh: "2. ÊúÄÊñ∞Ë¥¶ÂçïÔºàËá≥Â∞ë3‰∏™ÊúàÂâçÔºâ", de: "2. Letzte Rechnung (mindestens 3 Monate alt)", fr: "2. Derni√®re facture (minimum 3 mois d'anciennet√©)" },
                "2. √öltima factura (m√≠nimo 3 meses de antig√ºedad)": { en: "2. Latest invoice (minimum 3 months old)", zh: "2. ÊúÄÊñ∞Ë¥¶ÂçïÔºàËá≥Â∞ë3‰∏™ÊúàÂâçÔºâ", de: "2. Letzte Rechnung (mindestens 3 Monate alt)", fr: "2. Derni√®re facture (minimum 3 mois d'anciennet√©)" },
                "3. Email de contacto para validacion": { en: "3. Contact email for validation", zh: "3. È™åËØÅËÅîÁ≥ªÈÇÆÁÆ±", de: "3. Kontakt-E-Mail zur Validierung", fr: "3. E-mail de contact pour validation" },
                "3. Email de contacto para validaci√≥n": { en: "3. Contact email for validation", zh: "3. È™åËØÅËÅîÁ≥ªÈÇÆÁÆ±", de: "3. Kontakt-E-Mail zur Validierung", fr: "3. E-mail de contact pour validation" },
                "4. Telefono de contacto": { en: "4. Contact phone", zh: "4. ËÅîÁ≥ªÁîµËØù", de: "4. Kontakttelefon", fr: "4. T√©l√©phone de contact" },
                "4. Tel√©fono de contacto": { en: "4. Contact phone", zh: "4. ËÅîÁ≥ªÁîµËØù", de: "4. Kontakttelefon", fr: "4. T√©l√©phone de contact" },
                "5. Numero de cuenta bancaria (IBAN)": { en: "5. Bank account number (IBAN)", zh: "5. Èì∂Ë°åË¥¶Âè∑ÔºàIBANÔºâ", de: "5. Bankkontonummer (IBAN)", fr: "5. Num√©ro de compte bancaire (IBAN)" },
                "5. N√∫mero de cuenta bancaria (IBAN)": { en: "5. Bank account number (IBAN)", zh: "5. Èì∂Ë°åË¥¶Âè∑ÔºàIBANÔºâ", de: "5. Bankkontonummer (IBAN)", fr: "5. Num√©ro de compte bancaire (IBAN)" },
                "Envia la documentacion al comercial:": { en: "Send the documentation to the sales rep:", zh: "Â∞ÜÊñá‰ª∂ÂèëÈÄÅÁªôÈîÄÂîÆ‰ª£Ë°®Ôºö", de: "Senden Sie die Unterlagen an den Vertrieb:", fr: "Envoyez la documentation au commercial :" },
                "Env√≠a la documentaci√≥n al comercial:": { en: "Send the documentation to the sales rep:", zh: "Â∞ÜÊñá‰ª∂ÂèëÈÄÅÁªôÈîÄÂîÆ‰ª£Ë°®Ôºö", de: "Senden Sie die Unterlagen an den Vertrieb:", fr: "Envoyez la documentation au commercial :" },
                "Responde a este email adjuntando la documentaci√≥n de los": { en: "Reply to this email attaching the documentation of the", zh: "ÂõûÂ§çÊ≠§ÈÇÆ‰ª∂Âπ∂ÈôÑ‰∏ä‰ª•‰∏ã", de: "Antworten Sie auf diese E-Mail mit den Unterlagen der", fr: "R√©pondez √† cet e-mail en joignant la documentation des" },
                "√öltima factura (menos de 3 meses de antig√ºedad)": { en: "Latest invoice (less than 3 months old)", zh: "ÊúÄÊñ∞Ë¥¶ÂçïÔºà‰∏çË∂ÖËøá3‰∏™ÊúàÔºâ", de: "Letzte Rechnung (weniger als 3 Monate alt)", fr: "Derni√®re facture (moins de 3 mois d'anciennet√©)" },
                "Autorizaci√≥n de cambio de titular (si aplica)": { en: "Authorization to change holder (if applicable)", zh: "Êõ¥Êç¢ÊåÅÊúâ‰∫∫ÊéàÊùÉÔºàÂ¶ÇÈÄÇÁî®Ôºâ", de: "Genehmigung zur √Ñnderung des Inhabers (falls zutreffend)", fr: "Autorisation de changement de titulaire (le cas √©ch√©ant)" },
                "Documento generado autom√°ticamente - DRK Energ√≠a": { en: "Automatically generated document - DRK Energy", zh: "Ëá™Âä®ÁîüÊàêÁöÑÊñá‰ª∂ - DRK ËÉΩÊ∫ê", de: "Automatisch generiertes Dokument - DRK Energie", fr: "Document g√©n√©r√© automatiquement - DRK √ânergie" },
                "Para confirmar esta oferta:": { en: "To confirm this offer:", zh: "Á°ÆËÆ§Ê≠§Êä•‰ª∑Ôºö", de: "Um dieses Angebot zu best√§tigen:", fr: "Pour confirmer cette offre :" },
                "üìã Para confirmar esta oferta:": { en: "üìã To confirm this offer:", zh: "üìã Á°ÆËÆ§Ê≠§Êä•‰ª∑Ôºö", de: "üìã Um dieses Angebot zu best√§tigen:", fr: "üìã Pour confirmer cette offre :" },
                "üìß Para confirmar esta oferta:": { en: "üìß To confirm this offer:", zh: "üìß Á°ÆËÆ§Ê≠§Êä•‰ª∑Ôºö", de: "üìß Um dieses Angebot zu best√§tigen:", fr: "üìß Pour confirmer cette offre :" },
                "Haz clic en el bot√≥n de abajo": { en: "Click the button below", zh: "ÁÇπÂáª‰∏ãÊñπÊåâÈíÆ", de: "Klicken Sie auf die Schaltfl√§che unten", fr: "Cliquez sur le bouton ci-dessous" },
                "Se abrir√° tu cliente de email": { en: "Your email client will open", zh: "Â∞ÜÊâìÂºÄÊÇ®ÁöÑÁîµÂ≠êÈÇÆ‰ª∂ÂÆ¢Êà∑Á´Ø", de: "Ihr E-Mail-Client wird ge√∂ffnet", fr: "Votre client de messagerie s'ouvrira" },
                "Adjunta la documentaci√≥n requerida": { en: "Attach the required documentation", zh: "ÈôÑ‰∏äÊâÄÈúÄÊñá‰ª∂", de: "F√ºgen Sie die erforderlichen Unterlagen bei", fr: "Joignez la documentation requise" },
                "Env√≠a el email": { en: "Send the email", zh: "ÂèëÈÄÅÁîµÂ≠êÈÇÆ‰ª∂", de: "E-Mail senden", fr: "Envoyez l'e-mail" },
                "‚úÖ CONFIRMAR Y ENVIAR": { en: "‚úÖ CONFIRM AND SEND", zh: "‚úÖ Á°ÆËÆ§Âπ∂ÂèëÈÄÅ", de: "‚úÖ BEST√ÑTIGEN UND SENDEN", fr: "‚úÖ CONFIRMER ET ENVOYER" },
                "CONFIRMAR Y ENVIAR": { en: "CONFIRM AND SEND", zh: "Á°ÆËÆ§Âπ∂ÂèëÈÄÅ", de: "BEST√ÑTIGEN UND SENDEN", fr: "CONFIRMER ET ENVOYER" },
                "üìÑ <strong>Documentaci√≥n necesaria:</strong><br>": { en: "üìÑ <strong>Required documentation:</strong><br>", zh: "üìÑ <strong>ÊâÄÈúÄÊñá‰ª∂Ôºö</strong><br>", de: "üìÑ <strong>Erforderliche Unterlagen:</strong><br>", fr: "üìÑ <strong>Documentation n√©cessaire :</strong><br>" },
                "DNI/CIF ¬∑ √öltima factura ¬∑ Email ¬∑ Tel√©fono ¬∑ IBAN": { en: "ID/Tax ID ¬∑ Latest invoice ¬∑ Email ¬∑ Phone ¬∑ IBAN", zh: "Ë∫´‰ªΩËØÅ/Á®éÂè∑ ¬∑ ÊúÄÊñ∞Ë¥¶Âçï ¬∑ ÁîµÂ≠êÈÇÆ‰ª∂ ¬∑ ÁîµËØù ¬∑ IBAN", de: "Personalausweis/Steuernummer ¬∑ Letzte Rechnung ¬∑ E-Mail ¬∑ Telefon ¬∑ IBAN", fr: "Carte d'identit√©/n¬∞ fiscal ¬∑ Derni√®re facture ¬∑ E-mail ¬∑ T√©l√©phone ¬∑ IBAN" },
                "Este resumen es una simulacion": { en: "This summary is a simulation", zh: "Ê≠§ÊëòË¶Å‰∏∫Ê®°Êãü", de: "Diese Zusammenfassung ist eine Simulation", fr: "Ce r√©sum√© est une simulation" },
                "basada en su ultima factura": { en: "based on your latest invoice", zh: "Âü∫‰∫éÊÇ®ÁöÑÊúÄÊñ∞Ë¥¶Âçï", de: "basierend auf Ihrer letzten Rechnung", fr: "bas√©e sur votre derni√®re facture" },
                "Foto del DNI/CIF (anverso y reverso)": { en: "Photo of ID/Tax ID (front and back)", zh: "Ë∫´‰ªΩËØÅ/Á®éÂè∑ÁÖßÁâáÔºàÊ≠£ÂèçÈù¢Ôºâ", de: "Foto des Personalausweises/Steuernummer (Vorder- und R√ºckseite)", fr: "Photo de la carte d'identit√©/num√©ro fiscal (recto et verso)" },
                "Ultima factura (minimo 3 meses de antiguedad)": { en: "Latest invoice (minimum 3 months old)", zh: "ÊúÄÊñ∞Ë¥¶ÂçïÔºàËá≥Â∞ë3‰∏™ÊúàÂâçÔºâ", de: "Letzte Rechnung (mindestens 3 Monate alt)", fr: "Derni√®re facture (minimum 3 mois d'anciennet√©)" },
                "Email de contacto para validaci√≥n": { en: "Contact email for validation", zh: "È™åËØÅËÅîÁ≥ªÈÇÆÁÆ±", de: "Kontakt-E-Mail zur Validierung", fr: "E-mail de contact pour validation" },
                "Telefono de contacto": { en: "Contact phone", zh: "ËÅîÁ≥ªÁîµËØù", de: "Kontakttelefon", fr: "T√©l√©phone de contact" },
                "Numero de cuenta bancaria (IBAN)": { en: "Bank account number (IBAN)", zh: "Èì∂Ë°åË¥¶Âè∑ÔºàIBANÔºâ", de: "Bankkontonummer (IBAN)", fr: "Num√©ro de compte bancaire (IBAN)" },
                
                // M√°s textos del PDF
                "DATOS DEL CLIENTE:": { en: "CLIENT DATA:", zh: "ÂÆ¢Êà∑Êï∞ÊçÆÔºö", de: "KUNDENDATEN:", fr: "DONN√âES DU CLIENT :" },
                "DESGLOSE DETALLADO DE C√ÅLCULOS:": { en: "DETAILED CALCULATION BREAKDOWN:", zh: "ËØ¶ÁªÜËÆ°ÁÆóÊòéÁªÜÔºö", de: "DETAILLIERTE BERECHNUNGSAUFSCHL√úSSELUNG:", fr: "R√âPARTITION D√âTAILL√âE DES CALCULS :" },
                "COSTES DE POTENCIA:": { en: "POWER COSTS:", zh: "ÂäüÁéáÊàêÊú¨Ôºö", de: "LEISTUNGSKOSTEN:", fr: "CO√õTS DE PUISSANCE :" },
                "TOTAL POTENCIA:": { en: "TOTAL POWER:", zh: "ÊÄªÂäüÁéáÔºö", de: "GESAMTLEISTUNG:", fr: "PUISSANCE TOTALE :" },
                "PRECIOS POTENCIA:": { en: "POWER PRICES:", zh: "ÂäüÁéá‰ª∑Ê†ºÔºö", de: "LEISTUNGSPREISE:", fr: "PRIX PUISSANCE :" },
                "Generado el": { en: "Generated on", zh: "ÁîüÊàê‰∫é", de: "Erstellt am", fr: "G√©n√©r√© le" },
                "Colaborador:": { en: "Collaborator:", zh: "Âêà‰ΩúËÄÖÔºö", de: "Mitarbeiter:", fr: "Collaborateur :" },
                "consolidada de": { en: "consolidated from", zh: "ÂêàÂπ∂Ëá™", de: "konsolidiert von", fr: "consolid√©e de" },
                "suministros": { en: "supplies", zh: "‰æõÂ∫î", de: "Versorgungen", fr: "approvisionnements" },
                "Total Periodo (60 d√≠as)": { en: "Period Total (60 days)", zh: "ÊúüÈó¥ÊÄªÈ¢ùÔºà60Â§©Ôºâ", de: "Periodensumme (60 Tage)", fr: "Total de la P√©riode (60 jours)" },
                "Total Periodo": { en: "Period Total", zh: "ÊúüÈó¥ÊÄªÈ¢ù", de: "Periodensumme", fr: "Total de la P√©riode" },
                "Estimado Mensual": { en: "Monthly Estimate", zh: "ÊØèÊúà‰º∞ÁÆó", de: "Monatliche Sch√§tzung", fr: "Estimation Mensuelle" },
                "[NOMBRE COMPLETO CLIENTE]": { en: "[FULL CLIENT NAME]", zh: "[ÂÆ¢Êà∑ÂÖ®Âêç]", de: "[VOLLST√ÑNDIGER KUNDENNAME]", fr: "[NOM COMPLET DU CLIENT]" },
                "Responde a este email adjuntando la documentacion de los": { en: "Reply to this email attaching the documentation of the", zh: "ÂõûÂ§çÊ≠§ÈÇÆ‰ª∂Âπ∂ÈôÑ‰∏ä‰ª•‰∏ãÊñá‰ª∂", de: "Antworten Sie auf diese E-Mail mit den Unterlagen der", fr: "R√©pondez √† cet e-mail en joignant la documentation des" },
                "Adjunto la siguiente documentaci√≥n para cada CUPS:": { en: "Attached is the following documentation for each CUPS:", zh: "ÈôÑ‰∏äÊØè‰∏™CUPSÁöÑ‰ª•‰∏ãÊñá‰ª∂Ôºö", de: "Anbei die folgenden Unterlagen f√ºr jede CUPS:", fr: "Ci-joint la documentation suivante pour chaque CUPS :" },
                "‚úì 3. Email de contacto": { en: "‚úì 3. Contact email", zh: "‚úì 3. ËÅîÁ≥ªÈÇÆÁÆ±", de: "‚úì 3. Kontakt-E-Mail", fr: "‚úì 3. E-mail de contact" },
                
                // Formulario de GAS
                "Datos de la Factura de GAS": { en: "GAS Invoice Data", zh: "Â§©ÁÑ∂Ê∞îË¥¶ÂçïÊï∞ÊçÆ", de: "GAS-Rechnungsdaten", fr: "Donn√©es de la Facture de GAZ" },
                "Tarifa:": { en: "Rate:", zh: "Ë¥πÁéáÔºö", de: "Tarif:", fr: "Tarif :" },
                "CUPS (Opcional)": { en: "CUPS (Optional)", zh: "CUPSÔºàÂèØÈÄâÔºâ", de: "CUPS (Optional)", fr: "CUPS (Optionnel)" },
                "Se incluir√° en el PDF si lo proporcionas": { en: "Will be included in the PDF if you provide it", zh: "Â¶ÇÊûúÊÇ®Êèê‰æõÔºåÂ∞ÜÂåÖÂê´Âú®PDF‰∏≠", de: "Wird in das PDF aufgenommen, wenn Sie es angeben", fr: "Sera inclus dans le PDF si vous le fournissez" },
                "D√≠as de facturaci√≥n": { en: "Billing days", zh: "ËÆ°Ë¥πÂ§©Êï∞", de: "Abrechnungstage", fr: "Jours de facturation" },
                "kWh consumidos": { en: "kWh consumed", zh: "Ê∂àËÄóÁöÑkWh", de: "Verbrauchte kWh", fr: "kWh consomm√©s" },
                "Total factura actual (‚Ç¨)": { en: "Current total bill (‚Ç¨)", zh: "ÂΩìÂâçÊÄªË¥¶ÂçïÔºà‚Ç¨Ôºâ", de: "Aktuelle Gesamtrechnung (‚Ç¨)", fr: "Facture totale actuelle (‚Ç¨)" },
                "Comparar Indexada vs Fija": { en: "Compare Indexed vs Fixed", zh: "ÊØîËæÉÊåáÊï∞‰∏éÂõ∫ÂÆö", de: "Indexiert vs. Fest vergleichen", fr: "Comparer Index√© vs Fixe" },
                "Activa para comparar autom√°ticamente tarifa indexada DRK contra tarifas fijas.": { en: "Activate to automatically compare DRK indexed rate against fixed rates.", zh: "ÊøÄÊ¥ª‰ª•Ëá™Âä®ÊØîËæÉDRKÊåáÊï∞Ë¥πÁéá‰∏éÂõ∫ÂÆöË¥πÁéá„ÄÇ", de: "Aktivieren Sie, um den DRK-Indexierten Tarif automatisch mit festen Tarifen zu vergleichen.", fr: "Activez pour comparer automatiquement le tarif index√© DRK avec les tarifs fixes." },
                "Modo de selecci√≥n:": { en: "Selection mode:", zh: "ÈÄâÊã©Ê®°ÂºèÔºö", de: "Auswahlmodus:", fr: "Mode de s√©lection :" },
                "Mejores tarifas": { en: "Best rates", zh: "ÊúÄ‰Ω≥Ë¥πÁéá", de: "Beste Tarife", fr: "Meilleurs tarifs" },
                "Elige si quieres ver la mejor tarifa fija o indexada.": { en: "Choose if you want to see the best fixed or indexed rate.", zh: "ÈÄâÊã©ÊÇ®ÊòØÂê¶ÊÉ≥Êü•ÁúãÊúÄ‰Ω≥Âõ∫ÂÆöÊàñÊåáÊï∞Ë¥πÁéá„ÄÇ", de: "W√§hlen Sie, ob Sie den besten festen oder indexierten Tarif sehen m√∂chten.", fr: "Choisissez si vous souhaitez voir le meilleur tarif fixe ou index√©." },
                
                // Modal de resultados "Tu Tarifa Actual"
                "Tu Tarifa Actual": { en: "Your Current Rate", zh: "ÊÇ®ÁöÑÂΩìÂâçË¥πÁéá", de: "Ihr aktueller Tarif", fr: "Votre Tarif Actuel" },
                "Es la mejor opci√≥n detectada": { en: "It's the best option detected", zh: "ËøôÊòØÊ£ÄÊµãÂà∞ÁöÑÊúÄ‰Ω≥ÈÄâÊã©", de: "Es ist die beste erkannte Option", fr: "C'est la meilleure option d√©tect√©e" },
                "Es la mejor opci√≥n consolidada": { en: "It's the best consolidated option", zh: "ËøôÊòØÊúÄ‰Ω≥ÁªºÂêàÈÄâÊã©", de: "Es ist die beste konsolidierte Option", fr: "C'est la meilleure option consolid√©e" },
                "¬°ENHORABUENA!": { en: "CONGRATULATIONS!", zh: "ÊÅ≠ÂñúÔºÅ", de: "GL√úCKWUNSCH!", fr: "F√âLICITATIONS !" },
                "Actualmente est√°s en una buena tarifa.": { en: "You are currently on a good rate.", zh: "ÊÇ®ÁõÆÂâç‰ΩøÁî®ÁöÑÊòØ‰∏Ä‰∏™Â•ΩÁöÑË¥πÁéá„ÄÇ", de: "Sie haben derzeit einen guten Tarif.", fr: "Vous √™tes actuellement sur un bon tarif." },
                "Seguiremos estudiando el mercado y te avisaremos cuando encontremos alguna tarifa que se adapte a tu perfil de consumo.": { en: "We will continue studying the market and notify you when we find a rate that suits your consumption profile.", zh: "Êàë‰ª¨Â∞ÜÁªßÁª≠Á†îÁ©∂Â∏ÇÂú∫ÔºåÂΩìÊâæÂà∞ÈÄÇÂêàÊÇ®Ê∂àË¥πÊÉÖÂÜµÁöÑË¥πÁéáÊó∂‰ºöÈÄöÁü•ÊÇ®„ÄÇ", de: "Wir werden den Markt weiter untersuchen und Sie benachrichtigen, wenn wir einen Tarif finden, der zu Ihrem Verbrauchsprofil passt.", fr: "Nous continuerons √† √©tudier le march√© et vous informerons lorsque nous trouverons un tarif adapt√© √† votre profil de consommation." },
                "TU COSTE ACTUAL CONSOLIDADO": { en: "YOUR CURRENT CONSOLIDATED COST", zh: "ÊÇ®ÂΩìÂâçÁöÑÁªºÂêàÊàêÊú¨", de: "IHRE AKTUELLEN KONSOLIDIERTEN KOSTEN", fr: "VOTRE CO√õT CONSOLID√â ACTUEL" },
                "Total factura:": { en: "Total bill:", zh: "ÊÄªË¥¶ÂçïÔºö", de: "Gesamtrechnung:", fr: "Facture totale :" },
                "Estimaci√≥n anual:": { en: "Annual estimate:", zh: "Âπ¥Â∫¶‰º∞ÁÆóÔºö", de: "J√§hrliche Sch√§tzung:", fr: "Estimation annuelle :" },
                "üìä TU COSTE ACTUAL CONSOLIDADO": { en: "üìä YOUR CURRENT CONSOLIDATED COST", zh: "üìä ÊÇ®ÂΩìÂâçÁöÑÁªºÂêàÊàêÊú¨", de: "üìä IHRE AKTUELLEN KONSOLIDIERTEN KOSTEN", fr: "üìä VOTRE CO√õT CONSOLID√â ACTUEL" },
                
                // Textos de GAS y resultados
                "Tipo de tarifa:": { en: "Rate type:", zh: "Ë¥πÁéáÁ±ªÂûãÔºö", de: "Tariftyp:", fr: "Type de tarif :" },
                "üîµ Tarifa Fija": { en: "üîµ Fixed Rate", zh: "üîµ Âõ∫ÂÆöË¥πÁéá", de: "üîµ Fester Tarif", fr: "üîµ Tarif Fixe" },
                "üü† Tarifa Indexada": { en: "üü† Indexed Rate", zh: "üü† ÊåáÊï∞Ë¥πÁéá", de: "üü† Indexierter Tarif", fr: "üü† Tarif Index√©" },
                "Resultados GAS": { en: "GAS Results", zh: "Â§©ÁÑ∂Ê∞îÁªìÊûú", de: "GAS-Ergebnisse", fr: "R√©sultats GAZ" },
                "Comparativa de tarifas": { en: "Rate comparison", zh: "Ë¥πÁéáÊØîËæÉ", de: "Tarifvergleich", fr: "Comparaison des tarifs" },
                "T√©rmino fijo": { en: "Fixed term", zh: "Âõ∫ÂÆöÊù°Ê¨æ", de: "Feste Laufzeit", fr: "Terme fixe" },
                "T√©rmino fijo (30 d√≠as)": { en: "Fixed term (30 days)", zh: "Âõ∫ÂÆöÊù°Ê¨æÔºà30Â§©Ôºâ", de: "Feste Laufzeit (30 Tage)", fr: "Terme fixe (30 jours)" },
                "T√©rmino fijo:": { en: "Fixed term:", zh: "Âõ∫ÂÆöÊù°Ê¨æÔºö", de: "Feste Laufzeit:", fr: "Terme fixe :" },
                "Energ√≠a": { en: "Energy", zh: "ËÉΩÊ∫ê", de: "Energie", fr: "√ânergie" },
                "Impuesto hidrocarburos": { en: "Hydrocarbon tax", zh: "Á¢≥Ê∞¢ÂåñÂêàÁâ©Á®é", de: "Kohlenwasserstoffsteuer", fr: "Taxe sur les hydrocarbures" },
                "VAT (21%)": { en: "VAT (21%)", zh: "Â¢ûÂÄºÁ®éÔºà21%Ôºâ", de: "MwSt. (21%)", fr: "TVA (21%)" },
                "TOTAL": { en: "TOTAL", zh: "ÊÄªËÆ°", de: "GESAMT", fr: "TOTAL" },
                "Tu factura actual:": { en: "Your current bill:", zh: "ÊÇ®ÂΩìÂâçÁöÑË¥¶ÂçïÔºö", de: "Ihre aktuelle Rechnung:", fr: "Votre facture actuelle :" },
                "Con esta tarifa:": { en: "With this rate:", zh: "‰ΩøÁî®Ê≠§Ë¥πÁéáÔºö", de: "Mit diesem Tarif:", fr: "Avec ce tarif :" },
                "Ahorro mensual:": { en: "Monthly savings:", zh: "ÊØèÊúàËäÇÁúÅÔºö", de: "Monatliche Einsparungen:", fr: "√âconomies mensuelles :" },
                "Ahorro anual:": { en: "Annual savings:", zh: "Âπ¥Â∫¶ËäÇÁúÅÔºö", de: "J√§hrliche Einsparungen:", fr: "√âconomies annuelles :" },
                "üì§ Exportar Presentaci√≥n": { en: "üì§ Export Presentation", zh: "üì§ ÂØºÂá∫ÊºîÁ§∫ÊñáÁ®ø", de: "üì§ Pr√§sentation exportieren", fr: "üì§ Exporter la Pr√©sentation" },
                "Exportar Presentaci√≥n": { en: "Export Presentation", zh: "ÂØºÂá∫ÊºîÁ§∫ÊñáÁ®ø", de: "Pr√§sentation exportieren", fr: "Exporter la Pr√©sentation" },
                "Generar PDF": { en: "Generate PDF", zh: "ÁîüÊàêPDF", de: "PDF erstellen", fr: "G√©n√©rer PDF" },
                "üìÑ Generar PDF": { en: "üìÑ Generate PDF", zh: "üìÑ ÁîüÊàêPDF", de: "üìÑ PDF erstellen", fr: "üìÑ G√©n√©rer PDF" },
                "Generar HTML para": { en: "Generate HTML for", zh: "ÁîüÊàêHTMLÁî®‰∫é", de: "HTML generieren f√ºr", fr: "G√©n√©rer HTML pour" },
                "üìß Generar HTML para": { en: "üìß Generate HTML for", zh: "üìß ÁîüÊàêHTMLÁî®‰∫é", de: "üìß HTML generieren f√ºr", fr: "üìß G√©n√©rer HTML pour" },
                "Cancelar": { en: "Cancel", zh: "ÂèñÊ∂à", de: "Abbrechen", fr: "Annuler" },
                "Aceptar": { en: "Accept", zh: "Êé•Âèó", de: "Akzeptieren", fr: "Accepter" },
                "Cancelar Pegado": { en: "Cancel Paste", zh: "ÂèñÊ∂àÁ≤òË¥¥", de: "Einf√ºgen abbrechen", fr: "Annuler le Collage" },
                "TOTAL ENERG√çA": { en: "TOTAL ENERGY", zh: "ÊÄªËÉΩÊ∫ê", de: "GESAMTENERGIE", fr: "√âNERGIE TOTALE" },
                "TOTAL CON IMPUESTOS": { en: "TOTAL WITH TAXES", zh: "Âê´Á®éÊÄªËÆ°", de: "GESAMT MIT STEUERN", fr: "TOTAL AVEC TAXES" },
                "CUPS TOTALES:": { en: "TOTAL CUPS:", zh: "ÊÄªCUPSÔºö", de: "GESAMT-CUPS:", fr: "CUPS TOTAUX :" },
                "AHORRO TOTAL FIJAS:": { en: "TOTAL FIXED SAVINGS:", zh: "ÊÄªÂõ∫ÂÆöËäÇÁúÅÔºö", de: "GESAMTE FESTE EINSPARUNGEN:", fr: "√âCONOMIES TOTALES FIXES :" },
                "AHORRO TOTAL INDEXADAS:": { en: "TOTAL INDEXED SAVINGS:", zh: "ÊÄªÊåáÊï∞ËäÇÁúÅÔºö", de: "GESAMTE INDEXIERTE EINSPARUNGEN:", fr: "√âCONOMIES TOTALES INDEX√âES :" },
                "FACTURA ACTUAL TOTAL:": { en: "CURRENT TOTAL BILL:", zh: "ÂΩìÂâçÊÄªË¥¶ÂçïÔºö", de: "AKTUELLE GESAMTRECHNUNG:", fr: "FACTURE TOTALE ACTUELLE :" },
                "TOTAL:": { en: "TOTAL:", zh: "ÊÄªËÆ°Ôºö", de: "GESAMT:", fr: "TOTAL :" },
                
                // Traducciones adicionales para PDFs
                "COMPARATIVA": { en: "COMPARISON", zh: "ÊØîËæÉ", de: "VERGLEICH", fr: "COMPARAISON" },
                "mes": { en: "month", zh: "Êúà", de: "Monat", fr: "mois" },
                "D√çAS": { en: "DAYS", zh: "Â§©", de: "TAGE", fr: "JOURS" },
                "TU AHORRO ANUAL TOTAL": { en: "YOUR TOTAL ANNUAL SAVINGS", zh: "ÊÇ®ÁöÑÂπ¥Â∫¶ÊÄªËäÇÁúÅ", de: "IHRE GESAMTEN J√ÑHRLICHEN EINSPARUNGEN", fr: "VOS √âCONOMIES ANNUELLES TOTALES" },
                "¬°AHORRA": { en: "SAVE", zh: "ËäÇÁúÅ", de: "SPAREN SIE", fr: "√âCONOMISEZ" },
                "CADA MES!": { en: "EVERY MONTH!", zh: "ÊØèÊúàÔºÅ", de: "JEDEN MONAT!", fr: "CHAQUE MOIS !" },
                "AHORRO:": { en: "SAVINGS:", zh: "ËäÇÁúÅÔºö", de: "EINSPARUNGEN:", fr: "√âCONOMIES :" },
                "TOTAL AHORRO:": { en: "TOTAL SAVINGS:", zh: "ÊÄªËäÇÁúÅÔºö", de: "GESAMTEINSPARUNGEN:", fr: "√âCONOMIES TOTALES :" },
                "PRECIOS APLICADOS:": { en: "APPLIED PRICES:", zh: "Â∫îÁî®‰ª∑Ê†ºÔºö", de: "ANGEWANDTE PREISE:", fr: "PRIX APPLIQU√âS :" },
                "DESGLOSE DE COSTES": { en: "COST BREAKDOWN", zh: "ÊàêÊú¨ÊòéÁªÜ", de: "KOSTENAUFSCHL√úSSELUNG", fr: "R√âPARTITION DES CO√õTS" },
                "DESGLOSE GAS": { en: "GAS BREAKDOWN", zh: "ÁáÉÊ∞îÊòéÁªÜ", de: "GASAUFSCHL√úSSELUNG", fr: "R√âPARTITION GAZ" },
                "No hay datos": { en: "No data", zh: "Êó†Êï∞ÊçÆ", de: "Keine Daten", fr: "Pas de donn√©es" },
                "No hay datos de potencia": { en: "No power data", zh: "Êó†ÂäüÁéáÊï∞ÊçÆ", de: "Keine Leistungsdaten", fr: "Pas de donn√©es de puissance" },
                "No hay datos de energ√≠a": { en: "No energy data", zh: "Êó†ËÉΩÊ∫êÊï∞ÊçÆ", de: "Keine Energiedaten", fr: "Pas de donn√©es d'√©nergie" },
                "Tipo:": { en: "Type:", zh: "Á±ªÂûãÔºö", de: "Typ:", fr: "Type :" },
                "D√≠as:": { en: "Days:", zh: "Â§©Êï∞Ôºö", de: "Tage:", fr: "Jours :" },
                "Subtotal": { en: "Subtotal", zh: "Â∞èËÆ°", de: "Zwischensumme", fr: "Sous-total" },
                "Sin ahorro conseguido": { en: "No savings achieved", zh: "Êú™ÂÆûÁé∞ËäÇÁúÅ", de: "Keine Einsparungen erzielt", fr: "Aucune √©conomie r√©alis√©e" },
                "RESULTADO DE LA COMPARATIVA": { en: "COMPARISON RESULT", zh: "ÊØîËæÉÁªìÊûú", de: "VERGLEICHSERGEBNIS", fr: "R√âSULTAT DE LA COMPARAISON" },
                "Liderando el ahorro y la eficiencia energ√©tica.": { en: "Leading savings and energy efficiency.", zh: "È¢ÜÂÖàÁöÑËäÇËÉΩÂíåËÉΩÊ∫êÊïàÁéá„ÄÇ", de: "F√ºhrend bei Einsparungen und Energieeffizienz.", fr: "Leader en √©conomies et efficacit√© √©nerg√©tique." },
                "TU NUEVO COSTE": { en: "YOUR NEW COST", zh: "ÊÇ®ÁöÑÊñ∞Ë¥πÁî®", de: "IHRE NEUEN KOSTEN", fr: "VOTRE NOUVEAU CO√õT" },
                "CONSOLIDADO": { en: "CONSOLIDATED", zh: "ÂêàÂπ∂", de: "KONSOLIDIERT", fr: "CONSOLID√â" },
                "CUPS Procesadas": { en: "CUPS Processed", zh: "Â∑≤Â§ÑÁêÜÁöÑCUPS", de: "Verarbeitete CUPS", fr: "CUPS Trait√©es" },
                
                // M√°s traducciones del PDF
                "POWER SUBTOTAL": { en: "POWER SUBTOTAL", zh: "ÂäüÁéáÂ∞èËÆ°", de: "LEISTUNG ZWISCHENSUMME", fr: "SOUS-TOTAL PUISSANCE" },
                "TAXABLE BASE": { en: "TAXABLE BASE", zh: "Â∫îÁ®éÂü∫Êï∞", de: "STEUERBEMESSUNGSGRUNDLAGE", fr: "BASE IMPOSABLE" },
                "TOTAL FACTURA (60 D√çAS)": { en: "TOTAL BILL (60 DAYS)", zh: "ÊÄªË¥¶ÂçïÔºà60Â§©Ôºâ", de: "GESAMTRECHNUNG (60 TAGE)", fr: "FACTURE TOTALE (60 JOURS)" },
                "TOTAL YEAR (PROJECTED)": { en: "TOTAL YEAR (PROJECTED)", zh: "Âπ¥Â∫¶ÊÄªËÆ°ÔºàÈ¢ÑËÆ°Ôºâ", de: "GESAMTJAHR (PROGNOSTIZIERT)", fr: "TOTAL ANN√âE (PROJET√â)" },
                "E1 - Punta": { en: "E1 - Peak", zh: "E1 - Â≥∞ÂÄº", de: "E1 - Spitze", fr: "E1 - Pointe" },
                "E2 - Llano": { en: "E2 - Standard", zh: "E2 - Ê†áÂáÜ", de: "E2 - Standard", fr: "E2 - Standard" },
                "E3 - Valle": { en: "E3 - Valley", zh: "E3 - Ë∞∑ÂÄº", de: "E3 - Tal", fr: "E3 - Vall√©e" },
                "PRECIOS DE LA OFERTA:": { en: "OFFER PRICES:", zh: "Êä•‰ª∑‰ª∑Ê†ºÔºö", de: "ANGEBOTSPREISE:", fr: "PRIX DE L'OFFRE :" },
                "R≈∏s‚Ä°√ø": { en: "POWER:", zh: "ÂäüÁéáÔºö", de: "LEISTUNG:", fr: "PUISSANCE :" },
                "‚Ç¨/m-√ø": { en: "ENERGY:", zh: "ËÉΩÊ∫êÔºö", de: "ENERGIE:", fr: "√âNERGIE :" },
                
                // Visor de QR
                "üîç Analizando QR": { en: "üîç Analyzing QR", zh: "üîç ÂàÜÊûê‰∫åÁª¥Á†Å", de: "üîç QR analysieren", fr: "üîç Analyse du QR" },
                "Progreso de an√°lisis": { en: "Analysis progress", zh: "ÂàÜÊûêËøõÂ∫¶", de: "Analysefortschritt", fr: "Progression de l'analyse" },
                "Estamos probando diferentes t√©cnicas para detectar tu c√≥digo QR. Esto puede tardar unos segundos...": { en: "We are trying different techniques to detect your QR code. This may take a few seconds...", zh: "Êàë‰ª¨Ê≠£Âú®Â∞ùËØï‰∏çÂêåÁöÑÊäÄÊúØÊù•Ê£ÄÊµãÊÇ®ÁöÑ‰∫åÁª¥Á†Å„ÄÇËøôÂèØËÉΩÈúÄË¶ÅÂá†ÁßíÈíü...", de: "Wir testen verschiedene Techniken, um Ihren QR-Code zu erkennen. Dies kann einige Sekunden dauern...", fr: "Nous testons diff√©rentes techniques pour d√©tecter votre code QR. Cela peut prendre quelques secondes..." },
                "üì∏ Completa 2x": { en: "üì∏ Complete 2x", zh: "üì∏ ÂÆåÊàê 2x", de: "üì∏ Abgeschlossen 2x", fr: "üì∏ Complet 2x" },
                
                // GAS - Interfaz completa
                "Selection mode:": { en: "Selection mode:", zh: "ÈÄâÊã©Ê®°ÂºèÔºö", de: "Auswahlmodus:", fr: "Mode de s√©lection :" },
                "Best rates": { en: "Best rates", zh: "ÊúÄ‰ºòÊÉ†Ë¥πÁéá", de: "Beste Tarife", fr: "Meilleurs tarifs" },
                "Choose if you want to see the best fixed or indexed rate.": { en: "Choose if you want to see the best fixed or indexed rate.", zh: "ÈÄâÊã©ÊòØÂê¶Ë¶ÅÊü•ÁúãÊúÄ‰Ω≥Âõ∫ÂÆöÊàñÊåáÊï∞Ë¥πÁéá„ÄÇ", de: "W√§hlen Sie, ob Sie den besten festen oder indexierten Tarif sehen m√∂chten.", fr: "Choisissez si vous voulez voir le meilleur tarif fixe ou index√©." },
                "Elegir entre resultados": { en: "Choose from results", zh: "‰ªéÁªìÊûú‰∏≠ÈÄâÊã©", de: "Aus Ergebnissen w√§hlen", fr: "Choisir parmi les r√©sultats" },
                "Selecciona manualmente las tarifas que deseas comparar.": { en: "Manually select the rates you want to compare.", zh: "ÊâãÂä®ÈÄâÊã©Ë¶ÅÊØîËæÉÁöÑË¥πÁéá„ÄÇ", de: "W√§hlen Sie manuell die Tarife aus, die Sie vergleichen m√∂chten.", fr: "S√©lectionnez manuellement les tarifs que vous souhaitez comparer." },
                "Cancel": { en: "Cancel", zh: "ÂèñÊ∂à", de: "Abbrechen", fr: "Annuler" },
                "Ver tarifas disponibles": { en: "See available rates", zh: "Êü•ÁúãÂèØÁî®Ë¥πÁéá", de: "Verf√ºgbare Tarife anzeigen", fr: "Voir les tarifs disponibles" },
                "Selecciona las tarifas a comparar:": { en: "Select rates to compare:", zh: "ÈÄâÊã©Ë¶ÅÊØîËæÉÁöÑË¥πÁéáÔºö", de: "W√§hlen Sie Tarife zum Vergleichen:", fr: "S√©lectionnez les tarifs √† comparer :" },
                "Selecciona una o m√°s tarifas para comparar.": { en: "Select one or more rates to compare.", zh: "ÈÄâÊã©‰∏Ä‰∏™ÊàñÂ§ö‰∏™Ë¥πÁéáËøõË°åÊØîËæÉ„ÄÇ", de: "W√§hlen Sie einen oder mehrere Tarife zum Vergleichen.", fr: "S√©lectionnez un ou plusieurs tarifs √† comparer." },
                "üîç Buscar comercializadora:": { en: "üîç Search provider:", zh: "üîç ÊêúÁ¥¢‰æõÂ∫îÂïÜÔºö", de: "üîç Anbieter suchen:", fr: "üîç Rechercher un fournisseur :" },
                "Escribe el nombre de la comercializadora": { en: "Enter provider name", zh: "ËæìÂÖ•‰æõÂ∫îÂïÜÂêçÁß∞", de: "Anbieternamen eingeben", fr: "Entrez le nom du fournisseur" },
                "Ordenar por:": { en: "Sort by:", zh: "ÊéíÂ∫èÊñπÂºèÔºö", de: "Sortieren nach:", fr: "Trier par :" },
                "üí∞ Mayor ahorro primero": { en: "üí∞ Highest savings first", zh: "üí∞ ÊúÄÈ´òËäÇÁúÅ‰ºòÂÖà", de: "üí∞ H√∂chste Einsparungen zuerst", fr: "üí∞ √âconomies les plus √©lev√©es d'abord" },
                "üîª Menor ahorro primero": { en: "üîª Lowest savings first", zh: "üîª ÊúÄ‰ΩéËäÇÁúÅ‰ºòÂÖà", de: "üîª Niedrigste Einsparungen zuerst", fr: "üîª √âconomies les plus faibles d'abord" },
                "üìã Por nombre": { en: "üìã By name", zh: "üìã ÊåâÂêçÁß∞", de: "üìã Nach Name", fr: "üìã Par nom" },
                "Annual savings:": { en: "Annual savings:", zh: "Âπ¥Â∫¶ËäÇÁúÅÔºö", de: "J√§hrliche Einsparungen:", fr: "√âconomies annuelles :" },
                "Calcular tarifas seleccionadas": { en: "Calculate selected rates", zh: "ËÆ°ÁÆóÊâÄÈÄâË¥πÁéá", de: "Ausgew√§hlte Tarife berechnen", fr: "Calculer les tarifs s√©lectionn√©s" },
                
                // GAS - Resultados
                "Fixed term (30 days)": { en: "Fixed term (30 days)", zh: "Âõ∫ÂÆöÊúüÈôêÔºà30Â§©Ôºâ", de: "Feste Laufzeit (30 Tage)", fr: "Terme fixe (30 jours)" },
                "Energ√≠a (500 kWh)": { en: "Energy (500 kWh)", zh: "ËÉΩÊ∫êÔºà500ÂçÉÁì¶Êó∂Ôºâ", de: "Energie (500 kWh)", fr: "√ânergie (500 kWh)" },
                "Hydrocarbon tax": { en: "Hydrocarbon tax", zh: "Á¢≥Ê∞¢ÂåñÂêàÁâ©Á®é", de: "Kohlenwasserstoffsteuer", fr: "Taxe sur les hydrocarbures" },
                "Your current bill:": { en: "Your current bill:", zh: "ÊÇ®ÂΩìÂâçÁöÑË¥¶ÂçïÔºö", de: "Ihre aktuelle Rechnung:", fr: "Votre facture actuelle :" },
                "With this rate:": { en: "With this rate:", zh: "‰ΩøÁî®Ê≠§Ë¥πÁéáÔºö", de: "Mit diesem Tarif:", fr: "Avec ce tarif :" },
                "Monthly savings:": { en: "Monthly savings:", zh: "ÊØèÊúàËäÇÁúÅÔºö", de: "Monatliche Einsparungen:", fr: "√âconomies mensuelles :" },
                
                // GAS - PDF
                "SAVINGS STUDY": { en: "SAVINGS STUDY", zh: "ËäÇÁúÅÁ†îÁ©∂", de: "EINSPARUNGSSTUDIE", fr: "√âTUDE D'√âCONOMIES" },
                "COMPARATIVA PROFESIONAL GAS - DRK": { en: "PROFESSIONAL GAS COMPARISON - DRK", zh: "‰∏ì‰∏öÂ§©ÁÑ∂Ê∞îÊØîËæÉ - DRK", de: "PROFESSIONELLER GASVERGLEICH - DRK", fr: "COMPARAISON PROFESSIONNELLE GAZ - DRK" },
                "TARIFA:": { en: "RATE:", zh: "Ë¥πÁéáÔºö", de: "TARIF:", fr: "TARIF :" },
                "PRECIOS DE LA OFERTA: DRK - DRK 1": { en: "OFFER PRICES: DRK - DRK 1", zh: "Êä•‰ª∑‰ª∑Ê†ºÔºöDRK - DRK 1", de: "ANGEBOTSPREISE: DRK - DRK 1", fr: "PRIX DE L'OFFRE : DRK - DRK 1" },
                "T√âRMINO FIJO:": { en: "FIXED TERM:", zh: "Âõ∫ÂÆöÊúüÈôêÔºö", de: "FESTE LAUFZEIT:", fr: "TERME FIXE :" },
                "ENERG√çA:": { en: "ENERGY:", zh: "ËÉΩÊ∫êÔºö", de: "ENERGIE:", fr: "√âNERGIE :" },
                "Precio fijo diario (‚Ç¨/d√≠a):": { en: "Daily fixed price (‚Ç¨/day):", zh: "ÊØèÊó•Âõ∫ÂÆö‰ª∑Ê†ºÔºà‚Ç¨/Â§©ÔºâÔºö", de: "T√§glicher Festpreis (‚Ç¨/Tag):", fr: "Prix fixe journalier (‚Ç¨/jour) :" },
                "Precio energ√≠a (‚Ç¨/kWh):": { en: "Energy price (‚Ç¨/kWh):", zh: "ËÉΩÊ∫ê‰ª∑Ê†ºÔºà‚Ç¨/ÂçÉÁì¶Êó∂ÔºâÔºö", de: "Energiepreis (‚Ç¨/kWh):", fr: "Prix de l'√©nergie (‚Ç¨/kWh) :" },
                "DESGLOSE DETALLADO DE LA SIMULACI√ìN (DRK - DRK 1)": { en: "DETAILED BREAKDOWN OF SIMULATION (DRK - DRK 1)", zh: "Ê®°ÊãüËØ¶ÁªÜÂàÜËß£ÔºàDRK - DRK 1Ôºâ", de: "DETAILLIERTE AUFSCHL√úSSELUNG DER SIMULATION (DRK - DRK 1)", fr: "D√âTAIL DE LA SIMULATION (DRK - DRK 1)" },
                "T√âRMINO FIJO (Precio en ‚Ç¨/d√≠a)": { en: "FIXED TERM (Price in ‚Ç¨/day)", zh: "Âõ∫ÂÆöÊúüÈôêÔºà‰ª∑Ê†º‚Ç¨/Â§©Ôºâ", de: "FESTE LAUFZEIT (Preis in ‚Ç¨/Tag)", fr: "TERME FIXE (Prix en ‚Ç¨/jour)" },
                "Precio fijo (30 d√≠as x 0,001021)": { en: "Fixed price (30 days x 0.001021)", zh: "Âõ∫ÂÆö‰ª∑Ê†ºÔºà30Â§© x 0.001021Ôºâ", de: "Festpreis (30 Tage x 0,001021)", fr: "Prix fixe (30 jours x 0,001021)" },
                "T√âRMINO ENERG√çA (Precios en ‚Ç¨/kWh)": { en: "ENERGY TERM (Prices in ‚Ç¨/kWh)", zh: "ËÉΩÊ∫êÊù°Ê¨æÔºà‰ª∑Ê†º‚Ç¨/ÂçÉÁì¶Êó∂Ôºâ", de: "ENERGIETERM (Preise in ‚Ç¨/kWh)", fr: "TERME √âNERGIE (Prix en ‚Ç¨/kWh)" },
                "Energ√≠a (500 kWh x 0,099369)": { en: "Energy (500 kWh x 0.099369)", zh: "ËÉΩÊ∫êÔºà500ÂçÉÁì¶Êó∂ x 0.099369Ôºâ", de: "Energie (500 kWh x 0,099369)", fr: "√ânergie (500 kWh x 0,099369)" },
                "Subtotal Energ√≠a (Bruto)": { en: "Energy Subtotal (Gross)", zh: "ËÉΩÊ∫êÂ∞èËÆ°ÔºàÊÄªËÆ°Ôºâ", de: "Energie Zwischensumme (Brutto)", fr: "Sous-total √ânergie (Brut)" },
                "Imp. Hidrocarburos": { en: "Hydrocarbon Tax", zh: "Á¢≥Ê∞¢ÂåñÂêàÁâ©Á®é", de: "Kohlenwasserstoffsteuer", fr: "Taxe Hydrocarbures" },
                "TOTAL FACTURA (30 D√çAS)": { en: "TOTAL BILL (30 DAYS)", zh: "ÊÄªË¥¶ÂçïÔºà30Â§©Ôºâ", de: "GESAMTRECHNUNG (30 TAGE)", fr: "FACTURE TOTALE (30 JOURS)" },
                "Precio fijo": { en: "Fixed price", zh: "Âõ∫ÂÆö‰ª∑Ê†º", de: "Festpreis", fr: "Prix fixe" },
                
                // Variaciones con par√©ntesis completos (muy importantes para PDFs)
                "T√âRMINO POTENCIA (Precio en ‚Ç¨/kW D√≠a)": { en: "POWER TERM (Price in ‚Ç¨/kW Day)", zh: "ÂäüÁéáÊù°Ê¨æÔºà‰ª∑Ê†º‚Ç¨/ÂçÉÁì¶Â§©Ôºâ", de: "LEISTUNGSTERM (Preis in ‚Ç¨/kW Tag)", fr: "TERME PUISSANCE (Prix en ‚Ç¨/kW Jour)" },
                "T√âRMINO ENERG√çA (Precios en ‚Ç¨/kWh)": { en: "ENERGY TERM (Prices in ‚Ç¨/kWh)", zh: "ËÉΩÊ∫êÊù°Ê¨æÔºà‰ª∑Ê†º‚Ç¨/ÂçÉÁì¶Êó∂Ôºâ", de: "ENERGIETERM (Preise in ‚Ç¨/kWh)", fr: "TERME √âNERGIE (Prix en ‚Ç¨/kWh)" },
                "TOTAL FACTURA (60 D√çAS)": { en: "TOTAL BILL (60 DAYS)", zh: "ÊÄªË¥¶ÂçïÔºà60Â§©Ôºâ", de: "GESAMTRECHNUNG (60 TAGE)", fr: "FACTURE TOTALE (60 JOURS)" },
                "Liderando el ahorro y la": { es: "Liderando el ahorro y la", en: "Leading in savings and", zh: "ÂºïÈ¢ÜËäÇÁúÅÂíå", de: "F√ºhrend bei Einsparungen und", fr: "Leader de l'√©pargne et de" },
                "eficiencia energ√©tica.": { es: "eficiencia energ√©tica.", en: "energy efficiency.", zh: "ËÉΩÊ∫êÊïàÁéá„ÄÇ", de: "Energieeffizienz.", fr: "efficacit√© √©nerg√©tique." },
                "Asesor√≠a Energ√©tica": { es: "Asesor√≠a Energ√©tica", en: "Energy Consulting", zh: "ËÉΩÊ∫êÂí®ËØ¢", de: "Energieberatung", fr: "Conseil en √©nergie" },
                "60d": { en: "60d", zh: "60Â§©", de: "60T", fr: "60j" },
                
                // MULTICUPS - Interfaz completa
                "A√±adir Suministro": { en: "Add Supply", zh: "Ê∑ªÂä†‰æõÂ∫î", de: "Versorgung hinzuf√ºgen", fr: "Ajouter l'approvisionnement" },
                "Datos Generales": { en: "General Data", zh: "‰∏ÄËà¨Êï∞ÊçÆ", de: "Allgemeine Daten", fr: "Donn√©es g√©n√©rales" },
                "N√∫mero CUPS": { en: "CUPS Number", zh: "CUPSÂè∑Á†Å", de: "CUPS-Nummer", fr: "Num√©ro CUPS" },
                "D√≠as Facturados": { en: "Billed Days", zh: "ËÆ°Ë¥πÂ§©Êï∞", de: "Berechnete Tage", fr: "Jours factur√©s" },
                "Potencias (kW)": { en: "Power (kW)", zh: "ÂäüÁéá (kW)", de: "Leistung (kW)", fr: "Puissance (kW)" },
                "Energ√≠a (kWh)": { en: "Energy (kWh)", zh: "ËÉΩÊ∫ê (kWh)", de: "Energie (kWh)", fr: "√ânergie (kWh)" },
                "Total Factura (‚Ç¨)": { en: "Total Bill (‚Ç¨)", zh: "ÊÄªË¥¶Âçï (‚Ç¨)", de: "Gesamtrechnung (‚Ç¨)", fr: "Facture totale (‚Ç¨)" },
                "A√ëADIR SUMINISTRO MANUAL": { en: "ADD MANUAL SUPPLY", zh: "Ê∑ªÂä†ÊâãÂä®‰æõÂ∫î", de: "MANUELLE VERSORGUNG HINZUF√úGEN", fr: "AJOUTER L'APPROVISIONNEMENT MANUEL" },
                "A√ëADIR SUMINISTRO": { en: "ADD SUPPLY", zh: "Ê∑ªÂä†‰æõÂ∫î", de: "VERSORGUNG HINZUF√úGEN", fr: "AJOUTER L'APPROVISIONNEMENT" },
                "Cancelar": { en: "Cancel", zh: "ÂèñÊ∂à", de: "Abbrechen", fr: "Annuler" },
                
                // Modal Request Improvement
                "Request Improvement from DRK": { en: "Request Improvement from DRK", zh: "ÂêëDRKËØ∑Ê±ÇÊîπËøõ", de: "Verbesserung von DRK anfordern", fr: "Demander une am√©lioration √† DRK" },
                "Solicitar Mejora a DRK": { en: "Request Improvement from DRK", zh: "ÂêëDRKËØ∑Ê±ÇÊîπËøõ", de: "Verbesserung von DRK anfordern", fr: "Demander une am√©lioration √† DRK" },
                "Complete los datos para que el equipo de Back Office pueda revisar este comparativo y buscar una mejor opci√≥n.": { 
                    en: "Complete the data so that the Back Office team can review this comparison and find a better option.", 
                    zh: "Â°´ÂÜôÊï∞ÊçÆÔºå‰ª•‰æøÂêéÂè∞Âõ¢ÈòüÂÆ°Êü•Ê≠§ÊØîËæÉÂπ∂ÊâæÂà∞Êõ¥Â•ΩÁöÑÈÄâÊã©„ÄÇ", 
                    de: "Vervollst√§ndigen Sie die Daten, damit das Back-Office-Team diesen Vergleich √ºberpr√ºfen und eine bessere Option finden kann.", 
                    fr: "Compl√©tez les donn√©es pour que l'√©quipe du Back Office puisse examiner cette comparaison et trouver une meilleure option." 
                },
                "C√ìDIGO COMERCIAL (Obligatorio)": { en: "COMMERCIAL CODE (Required)", zh: "ÂïÜ‰∏ö‰ª£Á†ÅÔºàÂøÖÂ°´Ôºâ", de: "HANDELSCODE (Erforderlich)", fr: "CODE COMMERCIAL (Obligatoire)" },
                "Nombre Cliente": { en: "Client Name", zh: "ÂÆ¢Êà∑ÂêçÁß∞", de: "Kundenname", fr: "Nom du client" },
                "CUPS": { en: "CUPS", zh: "CUPS", de: "CUPS", fr: "CUPS" },
                "Tel√©fono": { en: "Phone", zh: "ÁîµËØù", de: "Telefon", fr: "T√©l√©phone" },
                "Email": { en: "Email", zh: "ÈÇÆÁÆ±", de: "E-Mail", fr: "Email" },
                "Observaciones (opcional)": { en: "Observations (optional)", zh: "Â§áÊ≥®ÔºàÂèØÈÄâÔºâ", de: "Anmerkungen (optional)", fr: "Observations (facultatif)" },
                "RECORDATORIO:": { en: "REMINDER:", zh: "ÊèêÈÜíÔºö", de: "ERINNERUNG:", fr: "RAPPEL :" },
                "Por favor, adjunte las facturas del cliente en su respuesta al email autom√°tico que recibir√°.": { 
                    en: "Please attach the client's invoices in your reply to the automatic email you will receive.", 
                    zh: "ËØ∑Âú®ÊÇ®Êî∂Âà∞ÁöÑËá™Âä®ÁîµÂ≠êÈÇÆ‰ª∂ÂõûÂ§ç‰∏≠ÈôÑ‰∏äÂÆ¢Êà∑ÁöÑÂèëÁ•®„ÄÇ", 
                    de: "Bitte f√ºgen Sie die Rechnungen des Kunden in Ihrer Antwort auf die automatische E-Mail bei, die Sie erhalten werden.", 
                    fr: "Veuillez joindre les factures du client dans votre r√©ponse √† l'e-mail automatique que vous recevrez." 
                },
                "üìß ENVIAR SOLICITUD": { en: "üìß SEND REQUEST", zh: "üìß ÂèëÈÄÅËØ∑Ê±Ç", de: "üìß ANFRAGE SENDEN", fr: "üìß ENVOYER LA DEMANDE" },
                
                // Mensajes de error
                "Error: Los datos de GAS no est√°n completos. Por favor, realice el c√°lculo de nuevo.": { 
                    en: "Error: GAS data is incomplete. Please recalculate.", 
                    zh: "ÈîôËØØÔºöGASÊï∞ÊçÆ‰∏çÂÆåÊï¥„ÄÇËØ∑ÈáçÊñ∞ËÆ°ÁÆó„ÄÇ", 
                    de: "Fehler: GAS-Daten sind unvollst√§ndig. Bitte neu berechnen.", 
                    fr: "Erreur : Les donn√©es GAS sont incompl√®tes. Veuillez recalculer." 
                },
                "Error: Los datos de ELECTRICIDAD no est√°n completos. Por favor, realice el c√°lculo de nuevo.": { 
                    en: "Error: ELECTRICITY data is incomplete. Please recalculate.", 
                    zh: "ÈîôËØØÔºöÁîµÂäõÊï∞ÊçÆ‰∏çÂÆåÊï¥„ÄÇËØ∑ÈáçÊñ∞ËÆ°ÁÆó„ÄÇ", 
                    de: "Fehler: ELEKTRIZIT√ÑT-Daten sind unvollst√§ndig. Bitte neu berechnen.", 
                    fr: "Erreur : Les donn√©es √âLECTRICIT√â sont incompl√®tes. Veuillez recalculer." 
                },
                
                // Modales de resultados
                "C√°lculo Completado": { en: "Calculation Completed", zh: "ËÆ°ÁÆóÂÆåÊàê", de: "Berechnung abgeschlossen", fr: "Calcul termin√©" },
                "‚úÖ C√°lculo Completado": { en: "‚úÖ Calculation Completed", zh: "‚úÖ ËÆ°ÁÆóÂÆåÊàê", de: "‚úÖ Berechnung abgeschlossen", fr: "‚úÖ Calcul termin√©" },
                "We found offers with savings. How do you want to continue?": { en: "We found offers with savings. How do you want to continue?", zh: "Êàë‰ª¨ÂèëÁé∞‰∫ÜËäÇÁúÅ‰ºòÊÉ†„ÄÇÊÇ®ÊÉ≥Â¶Ç‰ΩïÁªßÁª≠Ôºü", de: "Wir haben Angebote mit Einsparungen gefunden. Wie m√∂chten Sie fortfahren?", fr: "Nous avons trouv√© des offres avec des √©conomies. Comment voulez-vous continuer ?" },
                "Comparar FIJO vs INDEXADO": { en: "Compare FIXED vs INDEXED", zh: "ÊØîËæÉÂõ∫ÂÆö‰∏éÊåáÊï∞", de: "FEST vs INDEXIERT vergleichen", fr: "Comparer FIXE vs INDEX√â" },
                "Generate dual comparison: fixed rate and DRK INDEX indexed rate (variable market price).": { en: "Generate dual comparison: fixed rate and DRK INDEX indexed rate (variable market price).", zh: "ÁîüÊàêÂèåÈáçÊØîËæÉÔºöÂõ∫ÂÆöË¥πÁéáÂíåDRK INDEXÊåáÊï∞Ë¥πÁéáÔºàÂèØÂèòÂ∏ÇÂú∫‰ª∑Ê†ºÔºâ„ÄÇ", de: "Dual-Vergleich generieren: Festpreis und DRK INDEX indexierter Preis (variabler Marktpreis).", fr: "G√©n√©rer une comparaison double : tarif fixe et tarif index√© DRK INDEX (prix de march√© variable)." },
                "SEE BEST OPTION": { en: "SEE BEST OPTION", zh: "Êü•ÁúãÊúÄ‰Ω≥ÈÄâÈ°π", de: "BESTE OPTION SEHEN", fr: "VOIR LA MEILLEURE OPTION" },
                "Automatically shows the offer with the highest savings and generates the comparison": { en: "Automatically shows the offer with the highest savings and generates the comparison", zh: "Ëá™Âä®ÊòæÁ§∫ËäÇÁúÅÊúÄÂ§öÁöÑ‰ºòÊÉ†Âπ∂ÁîüÊàêÊØîËæÉ", de: "Zeigt automatisch das Angebot mit den h√∂chsten Einsparungen und erstellt den Vergleich", fr: "Affiche automatiquement l'offre avec les √©conomies les plus √©lev√©es et g√©n√®re la comparaison" },
                "CHOOSE FROM RESULTS": { en: "CHOOSE FROM RESULTS", zh: "‰ªéÁªìÊûú‰∏≠ÈÄâÊã©", de: "AUS ERGEBNISSEN W√ÑHLEN", fr: "CHOISIR PARMI LES R√âSULTATS" },
                "Review all offers with positive savings and choose your preferred one": { en: "Review all offers with positive savings and choose your preferred one", zh: "Êü•ÁúãÊâÄÊúâÂÖ∑ÊúâÊ≠£ËäÇÁúÅÁöÑ‰ºòÊÉ†Âπ∂ÈÄâÊã©ÊÇ®ÂñúÊ¨¢ÁöÑ‰ºòÊÉ†", de: "√úberpr√ºfen Sie alle Angebote mit positiven Einsparungen und w√§hlen Sie Ihr bevorzugtes", fr: "Examinez toutes les offres avec des √©conomies positives et choisissez celle que vous pr√©f√©rez" },
                "Advice:": { en: "Advice:", zh: "Âª∫ËÆÆÔºö", de: "Rat:", fr: "Conseil :" },
                "Si quieres ver r√°pidamente la mejor oferta, elige la primera opci√≥n. Si necesitas comparar varias opciones o el cliente tiene preferencias espec√≠ficas, elige la segunda.": { en: "If you want to quickly see the best offer, choose the first option. If you need to compare multiple options or the client has specific preferences, choose the second.", zh: "Â¶ÇÊûúÊÇ®ÊÉ≥Âø´ÈÄüÊü•ÁúãÊúÄ‰Ω≥‰ºòÊÉ†ÔºåËØ∑ÈÄâÊã©Á¨¨‰∏Ä‰∏™ÈÄâÈ°π„ÄÇÂ¶ÇÊûúÊÇ®ÈúÄË¶ÅÊØîËæÉÂ§ö‰∏™ÈÄâÈ°πÊàñÂÆ¢Êà∑ÊúâÁâπÂÆöÂÅèÂ•ΩÔºåËØ∑ÈÄâÊã©Á¨¨‰∫å‰∏™„ÄÇ", de: "Wenn Sie schnell das beste Angebot sehen m√∂chten, w√§hlen Sie die erste Option. Wenn Sie mehrere Optionen vergleichen m√ºssen oder der Kunde spezifische Pr√§ferenzen hat, w√§hlen Sie die zweite.", fr: "Si vous voulez voir rapidement la meilleure offre, choisissez la premi√®re option. Si vous devez comparer plusieurs options ou si le client a des pr√©f√©rences sp√©cifiques, choisissez la seconde." },
                
                // Confirmaci√≥n de suministro a√±adido
                "Suministro A√±adido": { en: "Supply Added", zh: "‰æõÂ∫îÂ∑≤Ê∑ªÂä†", de: "Versorgung hinzugef√ºgt", fr: "Approvisionnement ajout√©" },
                "Suministro ES (DRK) a√±adido. Total:": { en: "Supply ES (DRK) added. Total:", zh: "‰æõÂ∫îESÔºàDRKÔºâÂ∑≤Ê∑ªÂä†„ÄÇÊÄªËÆ°Ôºö", de: "Versorgung ES (DRK) hinzugef√ºgt. Gesamt:", fr: "Approvisionnement ES (DRK) ajout√©. Total :" },
                "Understood": { en: "Understood", zh: "ÊòéÁôΩ‰∫Ü", de: "Verstanden", fr: "Compris" },
                
                // Selecci√≥n MULTICUPS
                "Volver a selecci√≥n": { en: "Back to selection", zh: "ËøîÂõûÈÄâÊã©", de: "Zur√ºck zur Auswahl", fr: "Retour √† la s√©lection" },
                "MULTICUPS": { en: "MULTICUPS", zh: "Â§öCUPS", de: "MULTICUPS", fr: "MULTICUPS" },
                "Selecciona el tipo de contrato que deseas a√±adir.": { en: "Select the type of contract you want to add.", zh: "ÈÄâÊã©Ë¶ÅÊ∑ªÂä†ÁöÑÂêàÂêåÁ±ªÂûã„ÄÇ", de: "W√§hlen Sie den Vertragstyp aus, den Sie hinzuf√ºgen m√∂chten.", fr: "S√©lectionnez le type de contrat que vous souhaitez ajouter." },
                "Total de suministros actuales:": { en: "Total current supplies:", zh: "ÂΩìÂâç‰æõÂ∫îÊÄªÊï∞Ôºö", de: "Gesamtzahl aktueller Versorgungen:", fr: "Total des approvisionnements actuels :" },
                "Permite Esc√°ner QR, Imagen y Entrada Manual": { en: "Allows QR Scanner, Image and Manual Entry", zh: "ÂÖÅËÆ∏‰∫åÁª¥Á†ÅÊâ´Êèè„ÄÅÂõæÂÉèÂíåÊâãÂä®ËæìÂÖ•", de: "Erm√∂glicht QR-Scanner, Bild und manuelle Eingabe", fr: "Permet le scanner QR, l'image et la saisie manuelle" },
                "Solo Entrada de Datos Manual": { en: "Manual Data Entry Only", zh: "‰ªÖÊâãÂä®Êï∞ÊçÆËæìÂÖ•", de: "Nur manuelle Dateneingabe", fr: "Saisie manuelle des donn√©es uniquement" },
                "FINALIZAR Y COMPARAR": { en: "FINISH AND COMPARE", zh: "ÂÆåÊàêÂπ∂ÊØîËæÉ", de: "ABSCHLIESSEN UND VERGLEICHEN", fr: "TERMINER ET COMPARER" },
                "Suministros": { en: "Supplies", zh: "‰æõÂ∫î", de: "Versorgungen", fr: "Approvisionnements" },
                
                // Datos Acumulados
                "Datos Acumulados": { en: "Accumulated Data", zh: "Á¥ØËÆ°Êï∞ÊçÆ", de: "Kumulierte Daten", fr: "Donn√©es cumul√©es" },
                "TOTAL ENERGY": { en: "TOTAL ENERGY", zh: "ÊÄªËÉΩÊ∫ê", de: "GESAMTENERGIE", fr: "√âNERGIE TOTALE" },
                "Hogar/Negocio": { en: "Home/Business", zh: "ÂÆ∂Â∫≠/ÂïÜ‰∏ö", de: "Haus/Gesch√§ft", fr: "Maison/Entreprise" },
                "Industria/Gran Consumo": { en: "Industry/High Consumption", zh: "Â∑•‰∏ö/È´òÊ∂àËÄó", de: "Industrie/Gro√üverbrauch", fr: "Industrie/Grande consommation" },
                "Consumos (kWh)": { en: "Consumption (kWh)", zh: "Ê∂àËÄó (kWh)", de: "Verbrauch (kWh)", fr: "Consommation (kWh)" },
                
                // Textos adicionales de interfaz
                "PROFESIONAL": { en: "PROFESSIONAL", zh: "‰∏ì‰∏ö", de: "PROFESSIONELL", fr: "PROFESSIONNEL" },
                "Total Anual Estimado": { en: "Estimated Annual Total", zh: "‰º∞ËÆ°Âπ¥Â∫¶ÊÄªÈ¢ù", de: "Gesch√§tzter Jahresgesamtbetrag", fr: "Total annuel estim√©" },
                
                // TEXTOS FALTANTES - IMPORTANTE
                "Total Periodo": { en: "Total Period", zh: "ÊÄªÊúüÈôê", pt: "Per√≠odo Total", de: "Gesamtzeitraum", fr: "P√©riode totale" },
                "Selecciona la regulaci√≥n de gas.": { en: "Select gas regulation.", zh: "ÈÄâÊã©Â§©ÁÑ∂Ê∞îÁõëÁÆ°„ÄÇ", pt: "Selecione a regulamenta√ß√£o de g√°s.", de: "W√§hlen Sie die Gasregelung.", fr: "S√©lectionnez la r√©glementation du gaz." },
                "Regulaci√≥n de Gas - Nivel 1": { en: "Gas Regulation - Level 1", zh: "Â§©ÁÑ∂Ê∞îÁõëÁÆ° - Á∫ßÂà´ 1", pt: "Regula√ß√£o de G√°s - N√≠vel 1", de: "Gasregelung - Stufe 1", fr: "R√©glementation Gaz - Niveau 1" },
                "Regulaci√≥n de Gas - Nivel 2": { en: "Gas Regulation - Level 2", zh: "Â§©ÁÑ∂Ê∞îÁõëÁÆ° - Á∫ßÂà´ 2", pt: "Regula√ß√£o de G√°s - N√≠vel 2", de: "Gasregelung - Stufe 2", fr: "R√©glementation Gaz - Niveau 2" },
                "Regulaci√≥n de Gas - Nivel 3": { en: "Gas Regulation - Level 3", zh: "Â§©ÁÑ∂Ê∞îÁõëÁÆ° - Á∫ßÂà´ 3", pt: "Regula√ß√£o de G√°s - N√≠vel 3", de: "Gasregelung - Stufe 3", fr: "R√©glementation Gaz - Niveau 3" },
                "Regulaci√≥n de Gas - Nivel 4": { en: "Gas Regulation - Level 4", zh: "Â§©ÁÑ∂Ê∞îÁõëÁÆ° - Á∫ßÂà´ 4", pt: "Regula√ß√£o de G√°s - N√≠vel 4", de: "Gasregelung - Stufe 4", fr: "R√©glementation Gaz - Niveau 4" },
                "Regulaci√≥n de Gas - Nivel 5": { en: "Gas Regulation - Level 5", zh: "Â§©ÁÑ∂Ê∞îÁõëÁÆ° - Á∫ßÂà´ 5", pt: "Regula√ß√£o de G√°s - N√≠vel 5", de: "Gasregelung - Stufe 5", fr: "R√©glementation Gaz - Niveau 5" },
                "Regulaci√≥n de Gas - Nivel 6": { en: "Gas Regulation - Level 6", zh: "Â§©ÁÑ∂Ê∞îÁõëÁÆ° - Á∫ßÂà´ 6", pt: "Regula√ß√£o de G√°s - N√≠vel 6", de: "Gasregelung - Stufe 6", fr: "R√©glementation Gaz - Niveau 6" },
                "Por favor, completa todos los campos": { en: "Please complete all fields", zh: "ËØ∑Â°´ÂÜôÊâÄÊúâÂ≠óÊÆµ", pt: "Por favor, preencha todos os campos", de: "Bitte f√ºllen Sie alle Felder aus", fr: "Veuillez remplir tous les champs" },
                "Aceptar": { en: "Accept", zh: "Êé•Âèó", pt: "Aceitar", de: "Akzeptieren", fr: "Accepter" },
                "Variado": { en: "Varied", zh: "ÂêÑÁßç", pt: "Variado", de: "Variiert", fr: "Vari√©" },
                "No hay datos para exportar": { en: "No data to export", zh: "Ê≤°ÊúâË¶ÅÂØºÂá∫ÁöÑÊï∞ÊçÆ", pt: "N√£o h√° dados para exportar", de: "Keine Daten zum Exportieren", fr: "Aucune donn√©e √† exporter" },
                "C√ìDIGO COMERCIAL (Obligatorio):": { en: "COMMERCIAL CODE (Required):", zh: "ÂïÜ‰∏ö‰ª£Á†ÅÔºàÂøÖÂ°´ÔºâÔºö", pt: "C√ìDIGO COMERCIAL (Obrigat√≥rio):", de: "HANDELSCODE (Pflicht):", fr: "CODE COMMERCIAL (Obligatoire) :" },
                "El c√≥digo comercial es obligatorio": { en: "Commercial code is required", zh: "ÂïÜ‰∏ö‰ª£Á†Å‰∏∫ÂøÖÂ°´È°π", pt: "O c√≥digo comercial √© obrigat√≥rio", de: "Der Handelscode ist erforderlich", fr: "Le code commercial est obligatoire" },
                "NOMBRE DEL CLIENTE:": { en: "CLIENT NAME:", zh: "ÂÆ¢Êà∑ÂêçÁß∞Ôºö", pt: "NOME DO CLIENTE:", de: "KUNDENNAME:", fr: "NOM DU CLIENT :" },
                "[NOMBRE COMPLETO CLIENTE]": { en: "[FULL CLIENT NAME]", zh: "[ÂÆ¢Êà∑ÂÖ®Âêç]", pt: "[NOME COMPLETO DO CLIENTE]", de: "[VOLLST√ÑNDIGER KUNDENNAME]", fr: "[NOM COMPLET DU CLIENT]" },
                "Realizar Nueva Comparaci√≥n": { en: "Make New Comparison", zh: "ËøõË°åÊñ∞ÊØîËæÉ", de: "Neuen Vergleich durchf√ºhren", fr: "Effectuer une nouvelle comparaison" },
                "‚úÖ ¬°Oferta copiada con √©xito! Ahora puede pegar (Ctrl+V o Cmd+V) el dise√±o visual en su correo de escritorio.": { en: "‚úÖ Offer copied successfully! Now you can paste (Ctrl+V or Cmd+V) the visual design into your email client.", zh: "‚úÖ Êä•‰ª∑Â§çÂà∂ÊàêÂäüÔºÅÁé∞Âú®ÊÇ®ÂèØ‰ª•Â∞ÜËßÜËßâËÆæËÆ°Á≤òË¥¥ÔºàCtrl+V Êàñ Cmd+VÔºâÂà∞ÊÇ®ÁöÑÁîµÂ≠êÈÇÆ‰ª∂ÂÆ¢Êà∑Á´Ø„ÄÇ", de: "‚úÖ Angebot erfolgreich kopiert! Jetzt k√∂nnen Sie das visuelle Design in Ihren E-Mail-Client einf√ºgen (Strg+V oder Cmd+V).", fr: "‚úÖ Offre copi√©e avec succ√®s ! Vous pouvez maintenant coller (Ctrl+V ou Cmd+V) le design visuel dans votre client de messagerie." },
                "No se pudo copiar el dise√±o visual. Intente desde un PC o contacte a soporte.": { en: "Could not copy visual design. Try from a PC or contact support.", zh: "Êó†Ê≥ïÂ§çÂà∂ËßÜËßâËÆæËÆ°„ÄÇËØ∑Â∞ùËØï‰ªéPCÊàñËÅîÁ≥ªÊîØÊåÅ„ÄÇ", de: "Visuelles Design konnte nicht kopiert werden. Versuchen Sie es von einem PC aus oder kontaktieren Sie den Support.", fr: "Impossible de copier le design visuel. Essayez depuis un PC ou contactez le support." },
                "Acumulado": { en: "Accumulated", zh: "Á¥ØËÆ°", de: "Kumuliert", fr: "Accumul√©" },
                "Total Consumo": { en: "Total Consumption", zh: "ÊÄªÊ∂àËÄó", de: "Gesamtverbrauch", fr: "Consommation totale" },
                "Ahorro:": { en: "Savings:", zh: "ËäÇÁúÅÔºö", de: "Einsparungen:", fr: "√âconomies :" },
                "Ahorro": { en: "Savings", zh: "ËäÇÁúÅ", de: "Einsparungen", fr: "√âconomies" },
                "No hay consumos para este tipo.": { en: "No consumption for this type.", zh: "Ê≠§Á±ªÂûãÊ≤°ÊúâÊ∂àËÄó„ÄÇ", de: "Kein Verbrauch f√ºr diesen Typ.", fr: "Aucune consommation pour ce type." },
                "No hay potencias para este tipo.": { en: "No power for this type.", zh: "Ê≠§Á±ªÂûãÊ≤°ÊúâÂäüÁéá„ÄÇ", de: "Keine Leistung f√ºr diesen Typ.", fr: "Aucune puissance pour ce type." },
                "Los precios mostrados son de las ofertas ganadoras detectadas para cada tipo de tarifa y se aplican a las CUPS a√±adidas.": { en: "The prices shown are from the winning offers detected for each tariff type and apply to the added CUPS.", zh: "ÊòæÁ§∫ÁöÑ‰ª∑Ê†ºÊù•Ëá™Ê£ÄÊµãÂà∞ÁöÑÊØèÁßçÂÖ≥Á®éÁ±ªÂûãÁöÑ‰∏≠Ê†áÊä•‰ª∑ÔºåÂπ∂ÈÄÇÁî®‰∫éÊ∑ªÂä†ÁöÑCUPS„ÄÇ", de: "Die angezeigten Preise stammen aus den f√ºr jeden Tariftyp erkannten gewinnenden Angeboten und gelten f√ºr die hinzugef√ºgten CUPS.", fr: "Les prix affich√©s proviennent des offres gagnantes d√©tect√©es pour chaque type de tarif et s'appliquent aux CUPS ajout√©es." },
                
                // Secciones del PDF
                "POTENCIA": { en: "POWER", zh: "ÂäüÁéá", de: "LEISTUNG", fr: "PUISSANCE" },
                "ENERG√çA": { en: "ENERGY", zh: "ËÉΩÊ∫ê", de: "ENERGIE", fr: "√âNERGIE" },
                "Resumen de Suministros A√±adidos": { en: "Summary of Added Supplies", zh: "Â∑≤Ê∑ªÂä†‰æõÂ∫îÁöÑÊëòË¶Å", de: "Zusammenfassung der hinzugef√ºgten Lieferungen", fr: "R√©sum√© des Fournitures Ajout√©es" },
                "Precios de las Ofertas Seleccionadas": { en: "Prices of Selected Offers", zh: "ÊâÄÈÄâÊä•‰ª∑ÁöÑ‰ª∑Ê†º", de: "Preise der ausgew√§hlten Angebote", fr: "Prix des Offres S√©lectionn√©es" },
                "Desglose Individual por Suministro": { en: "Individual Breakdown by Supply", zh: "Êåâ‰æõÂ∫îÁöÑ‰∏™Âà´ÊòéÁªÜ", de: "Einzelaufschl√ºsselung nach Lieferung", fr: "Ventilation Individuelle par Fourniture" },
                "A continuaci√≥n, se muestra el c√°lculo detallado de la mejor oferta para cada CUPS, por orden de introducci√≥n:": { en: "Below is the detailed calculation of the best offer for each CUPS, in order of entry:", zh: "‰ª•‰∏ãÊòØÊØè‰∏™CUPSÁöÑÊúÄ‰Ω≥Êä•‰ª∑ÁöÑËØ¶ÁªÜËÆ°ÁÆóÔºåÊåâËæìÂÖ•È°∫Â∫èÔºö", de: "Nachfolgend finden Sie die detaillierte Berechnung des besten Angebots f√ºr jede CUPS in Eingabereihenfolge:", fr: "Vous trouverez ci-dessous le calcul d√©taill√© de la meilleure offre pour chaque CUPS, par ordre d'introduction:" },
                "Suministro": { en: "Supply", zh: "‰æõÂ∫î", de: "Lieferung", fr: "Fourniture" },
                "AHORRO ANUAL": { en: "ANNUAL SAVINGS", zh: "Âπ¥Â∫¶ËäÇÁúÅ", de: "J√ÑHRLICHE EINSPARUNGEN", fr: "√âCONOMIES ANNUELLES" },
                "TU TARIFA ACTUAL es la mejor": { en: "YOUR CURRENT RATE is the best", zh: "ÊÇ®ÁöÑÂΩìÂâçË¥πÁéáÊòØÊúÄÂ•ΩÁöÑ", de: "IHR AKTUELLER TARIF ist der beste", fr: "VOTRE TARIF ACTUEL est le meilleur" },
                "Tarifa aplicada en el c√°lculo": { en: "Rate applied in calculation", zh: "ËÆ°ÁÆó‰∏≠Â∫îÁî®ÁöÑË¥πÁéá", de: "Im Berechnungsverfahren angewandter Tarif", fr: "Tarif appliqu√© dans le calcul" },
                "Factura Actual Periodo": { en: "Current Period Bill", zh: "ÂΩìÂâçÊúüÈó¥Ë¥¶Âçï", de: "Aktuelle Periodenrechnung", fr: "Facture P√©riode Actuelle" },
                "Nuevo Coste Periodo": { en: "New Period Cost", zh: "Êñ∞ÊúüÈó¥Ë¥πÁî®", de: "Neue Periodenkosten", fr: "Nouveau Co√ªt P√©riode" },
                "Desglose": { en: "Breakdown", zh: "ÊòéÁªÜ", de: "Aufschl√ºsselung", fr: "Ventilation" },
                "Subtotal Potencia": { en: "Power Subtotal", zh: "ÂäüÁéáÂ∞èËÆ°", de: "Leistung Zwischensumme", fr: "Sous-total Puissance" },
                "Subtotal Energ√≠a (Neto)": { en: "Energy Subtotal (Net)", zh: "ËÉΩÊ∫êÂ∞èËÆ°ÔºàÂáÄÈ¢ùÔºâ", de: "Energie Zwischensumme (Netto)", fr: "Sous-total √ânergie (Net)" },
                "Punta": { en: "Peak", zh: "Â≥∞ÂÄº", de: "Spitze", fr: "Pointe" },
                "Llano": { en: "Standard", zh: "Ê†áÂáÜ", de: "Standard", fr: "Standard" },
                "Valle": { en: "Valley", zh: "Ë∞∑ÂÄº", de: "Tal", fr: "Vall√©e" },
                
                // MULTICUPS - M√°s textos
                "RESUMEN DE": { en: "SUMMARY OF", zh: "ÊëòË¶Å", de: "ZUSAMMENFASSUNG VON", fr: "R√âSUM√â DE" },
                "SUMINISTROS": { en: "SUPPLIES", zh: "‰æõÂ∫î", de: "VERSORGUNGEN", fr: "APPROVISIONNEMENTS" },
                "Confirmar Suministro MultiCups": { en: "Confirm MultiCups Supply", zh: "Á°ÆËÆ§Â§öCUPS‰æõÂ∫î", de: "MultiCups-Versorgung best√§tigen", fr: "Confirmer l'approvisionnement MultiCups" },
                "Revisa los datos extra√≠dos del QR antes de a√±adir este suministro a la lista.": { en: "Review the data extracted from the QR before adding this supply to the list.", zh: "Âú®Â∞ÜÊ≠§‰æõÂ∫îÊ∑ªÂä†Âà∞ÂàóË°®‰πãÂâçÔºåËØ∑Ê£ÄÊü•‰ªé‰∫åÁª¥Á†Å‰∏≠ÊèêÂèñÁöÑÊï∞ÊçÆ„ÄÇ", de: "√úberpr√ºfen Sie die aus dem QR-Code extrahierten Daten, bevor Sie diese Versorgung zur Liste hinzuf√ºgen.", fr: "V√©rifiez les donn√©es extraites du QR avant d'ajouter cet approvisionnement √† la liste." },
                "Datos Extra√≠dos del QR": { en: "Data Extracted from QR", zh: "‰ªé‰∫åÁª¥Á†ÅÊèêÂèñÁöÑÊï∞ÊçÆ", de: "Aus QR extrahierte Daten", fr: "Donn√©es extraites du QR" },
                "D√≠as Fact:": { en: "Billed Days:", zh: "ËÆ°Ë¥πÂ§©Êï∞Ôºö", de: "Berechnete Tage:", fr: "Jours factur√©s :" },
                "Total": { en: "Total", zh: "ÊÄªËÆ°", de: "Gesamt", fr: "Total" },
                "Factura:": { en: "Bill:", zh: "Ë¥¶ÂçïÔºö", de: "Rechnung:", fr: "Facture :" },
                "A√ëADIR A LA LISTA DE CUPS": { en: "ADD TO CUPS LIST", zh: "Ê∑ªÂä†Âà∞CUPSÂàóË°®", de: "ZUR CUPS-LISTE HINZUF√úGEN", fr: "AJOUTER √Ä LA LISTE CUPS" },
                "Comparar FIJO vs INDEXADO": { en: "Compare FIXED vs INDEXED", zh: "ÊØîËæÉÂõ∫ÂÆö‰∏éÊåáÊï∞", de: "FEST vs INDEXIERT vergleichen", fr: "Comparer FIXE vs INDEX√â" },
                "RESUMEN DE TODOS LOS SUMINISTROS": { en: "SUMMARY OF ALL SUPPLIES", zh: "ÊâÄÊúâ‰æõÂ∫îÊëòË¶Å", de: "ZUSAMMENFASSUNG ALLER VERSORGUNGEN", fr: "R√âSUM√â DE TOUS LES APPROVISIONNEMENTS" },
                "RESUMEN DE SUMINISTROS INCLUIDOS": { en: "SUMMARY OF INCLUDED SUPPLIES", zh: "ÂåÖÂê´‰æõÂ∫îÊëòË¶Å", de: "ZUSAMMENFASSUNG DER ENTHALTENEN VERSORGUNGEN", fr: "R√âSUM√â DES APPROVISIONNEMENTS INCLUS" },
                "LA MEJOR OPCI√ìN PARA TI ES": { en: "THE BEST OPTION FOR YOU IS", zh: "ÊúÄÈÄÇÂêàÊÇ®ÁöÑÈÄâÈ°πÊòØ", de: "DIE BESTE OPTION F√úR SIE IST", fr: "LA MEILLEURE OPTION POUR VOUS EST" },
                
                // Selector de tarifa DRK
                "¬øQu√© tipo de tarifa DRK quieres ver?": { en: "What type of DRK rate do you want to see?", zh: "ÊÇ®ÊÉ≥Êü•ÁúãÂì™ÁßçÁ±ªÂûãÁöÑDRKË¥πÁéáÔºü", de: "Welchen DRK-Tariftyp m√∂chten Sie sehen?", fr: "Quel type de tarif DRK souhaitez-vous voir ?" },
                "üéØ ¬øQu√© tipo de tarifa DRK quieres ver?": { en: "üéØ What type of DRK rate do you want to see?", zh: "üéØ ÊÇ®ÊÉ≥Êü•ÁúãÂì™ÁßçÁ±ªÂûãÁöÑDRKË¥πÁéáÔºü", de: "üéØ Welchen DRK-Tariftyp m√∂chten Sie sehen?", fr: "üéØ Quel type de tarif DRK souhaitez-vous voir ?" },
                "Tarifa FIJA": { en: "FIXED Rate", zh: "Âõ∫ÂÆöË¥πÁéá", de: "FESTPREIS-Tarif", fr: "Tarif FIXE" },
                "‚ö° Tarifa FIJA": { en: "‚ö° FIXED Rate", zh: "‚ö° Âõ∫ÂÆöË¥πÁéá", de: "‚ö° FESTPREIS-Tarif", fr: "‚ö° Tarif FIXE" },
                "Precio fijo estable (excluye DRK INDEX)": { en: "Stable fixed price (excludes DRK INDEX)", zh: "Á®≥ÂÆöÂõ∫ÂÆö‰ª∑Ê†ºÔºà‰∏çÂåÖÊã¨DRK INDEXÔºâ", de: "Stabiler Festpreis (ohne DRK INDEX)", fr: "Prix fixe stable (exclut DRK INDEX)" },
                "Tarifa INDEXADA (DRK INDEX)": { en: "INDEXED Rate (DRK INDEX)", zh: "ÊåáÊï∞Ë¥πÁéáÔºàDRK INDEXÔºâ", de: "INDEXIERTER Tarif (DRK INDEX)", fr: "Tarif INDEX√â (DRK INDEX)" },
                "üå± Tarifa INDEXADA (DRK INDEX)": { en: "üå± INDEXED Rate (DRK INDEX)", zh: "üå± ÊåáÊï∞Ë¥πÁéáÔºàDRK INDEXÔºâ", de: "üå± INDEXIERTER Tarif (DRK INDEX)", fr: "üå± Tarif INDEX√â (DRK INDEX)" },
                "Solo muestra DRK INDEX del mercado": { en: "Only shows market DRK INDEX", zh: "‰ªÖÊòæÁ§∫Â∏ÇÂú∫DRK INDEX", de: "Zeigt nur Markt-DRK INDEX", fr: "Affiche uniquement le DRK INDEX du march√©" },
                "Continuar con esta opci√≥n ‚Üí": { en: "Continue with this option ‚Üí", zh: "ÁªßÁª≠Ê≠§ÈÄâÈ°π‚Üí", de: "Mit dieser Option fortfahren ‚Üí", fr: "Continuer avec cette option ‚Üí" },
                
                // DUAL
                "Gestiona m√∫ltiples suministros de Electricidad y Gas": { en: "Manage multiple Electricity and Gas supplies", zh: "ÁÆ°ÁêÜÂ§ö‰∏™ÁîµÂäõÂíåÂ§©ÁÑ∂Ê∞î‰æõÂ∫î", de: "Verwalten Sie mehrere Strom- und Gasversorgungen", fr: "G√©rer plusieurs approvisionnements en √©lectricit√© et gaz" },
                "Suministros a√±adidos:": { en: "Supplies added:", zh: "Â∑≤Ê∑ªÂä†ÁöÑ‰æõÂ∫îÔºö", de: "Hinzugef√ºgte Versorgungen:", fr: "Approvisionnements ajout√©s :" },
                "No hay suministros a√±adidos": { en: "No supplies added", zh: "Êú™Ê∑ªÂä†‰æõÂ∫î", de: "Keine Versorgungen hinzugef√ºgt", fr: "Aucun approvisionnement ajout√©" },
                "+ A√±adir Suministro": { en: "+ Add Supply", zh: "+ Ê∑ªÂä†‰æõÂ∫î", de: "+ Versorgung hinzuf√ºgen", fr: "+ Ajouter un approvisionnement" },
                "Calcular Comparativa Global": { en: "Calculate Global Comparison", zh: "ËÆ°ÁÆóÂÖ®Â±ÄÊØîËæÉ", de: "Globalen Vergleich berechnen", fr: "Calculer la comparaison globale" },
                "Limpiar todo": { en: "Clear all", zh: "Ê∏ÖÈô§ÂÖ®ÈÉ®", de: "Alles l√∂schen", fr: "Tout effacer" },
                
                // Textos del modal de decisi√≥n
                "Consejo:": { en: "Advice:", zh: "Âª∫ËÆÆÔºö", de: "Rat:", fr: "Conseil :" },
                "Si quieres ver r√°pidamente la mejor oferta, elige la primera opci√≥n. Si necesitas comparar varias opciones o el cliente tiene preferencias espec√≠ficas, elige la segunda.": { en: "If you want to quickly see the best offer, choose the first option. If you need to compare multiple options or the client has specific preferences, choose the second.", zh: "Â¶ÇÊûúÊÇ®ÊÉ≥Âø´ÈÄüÊü•ÁúãÊúÄ‰Ω≥‰ºòÊÉ†ÔºåËØ∑ÈÄâÊã©Á¨¨‰∏Ä‰∏™ÈÄâÈ°π„ÄÇÂ¶ÇÊûúÊÇ®ÈúÄË¶ÅÊØîËæÉÂ§ö‰∏™ÈÄâÈ°πÊàñÂÆ¢Êà∑ÊúâÁâπÂÆöÂÅèÂ•ΩÔºåËØ∑ÈÄâÊã©Á¨¨‰∫å‰∏™„ÄÇ", de: "Wenn Sie schnell das beste Angebot sehen m√∂chten, w√§hlen Sie die erste Option. Wenn Sie mehrere Optionen vergleichen m√ºssen oder der Kunde spezifische Pr√§ferenzen hat, w√§hlen Sie die zweite.", fr: "Si vous voulez voir rapidement la meilleure offre, choisissez la premi√®re option. Si vous devez comparer plusieurs options ou si le client a des pr√©f√©rences sp√©cifiques, choisissez la seconde." },
                "‚ö° Comparar FIJO vs INDEXADO": { en: "‚ö° Compare FIXED vs INDEXED", zh: "‚ö° ÊØîËæÉÂõ∫ÂÆö‰∏éÊåáÊï∞", de: "‚ö° FEST vs INDEXIERT vergleichen", fr: "‚ö° Comparer FIXE vs INDEX√â" },
                "Genera comparativa dual: tarifa fija y tarifa indexada DRK INDEX (precio variable del mercado).": { en: "Generate dual comparison: fixed rate and DRK INDEX indexed rate (variable market price).", zh: "ÁîüÊàêÂèåÈáçÊØîËæÉÔºöÂõ∫ÂÆöË¥πÁéáÂíåDRK INDEXÊåáÊï∞Ë¥πÁéáÔºàÂèØÂèòÂ∏ÇÂú∫‰ª∑Ê†ºÔºâ„ÄÇ", de: "Dual-Vergleich generieren: Festpreis und DRK INDEX indexierter Tarif (variabler Marktpreis).", fr: "G√©n√©rer une comparaison duale : tarif fixe et tarif index√© DRK INDEX (prix variable du march√©)." },
                
                // Modal de selecci√≥n de ofertas
                "üìã SELECCIONA TU OFERTA": { en: "üìã SELECT YOUR OFFER", zh: "üìã ÈÄâÊã©ÊÇ®ÁöÑÊä•‰ª∑", de: "üìã W√ÑHLEN SIE IHR ANGEBOT", fr: "üìã S√âLECTIONNEZ VOTRE OFFRE" },
                "Hemos calculado todas las opciones con ahorro. Elige la que prefieras.": { en: "We have calculated all options with savings. Choose the one you prefer.", zh: "Êàë‰ª¨Â∑≤ËÆ°ÁÆóÊâÄÊúâËäÇÁúÅÈÄâÈ°π„ÄÇÈÄâÊã©ÊÇ®ÂñúÊ¨¢ÁöÑ„ÄÇ", de: "Wir haben alle Optionen mit Einsparungen berechnet. W√§hlen Sie die, die Sie bevorzugen.", fr: "Nous avons calcul√© toutes les options avec des √©conomies. Choisissez celle que vous pr√©f√©rez." },
                "üìã DATOS DEL SUMINISTRO": { en: "üìã SUPPLY DATA", zh: "üìã ‰æõÂ∫îÊï∞ÊçÆ", de: "üìã VERSORGUNGSDATEN", fr: "üìã DONN√âES D'APPROVISIONNEMENT" },
                "üîç BUSCAR POR NOMBRE": { en: "üîç SEARCH BY NAME", zh: "üîç ÊåâÂêçÁß∞ÊêúÁ¥¢", de: "üîç NACH NAME SUCHEN", fr: "üîç RECHERCHER PAR NOM" },
                "Escribe nombre de comercializadora...": { en: "Enter supplier name...", zh: "ËæìÂÖ•‰æõÂ∫îÂïÜÂêçÁß∞...", de: "Lieferantenname eingeben...", fr: "Entrez le nom du fournisseur..." },
                "üìä ORDENAR POR": { en: "üìä SORT BY", zh: "üìä ÊéíÂ∫èÊñπÂºè", de: "üìä SORTIEREN NACH", fr: "üìä TRIER PAR" },
                "üí∞ Mayor ahorro primero": { en: "üí∞ Highest savings first", zh: "üí∞ ÊúÄÈ´òËäÇÁúÅ‰ºòÂÖà", de: "üí∞ H√∂chste Einsparungen zuerst", fr: "üí∞ √âconomies les plus √©lev√©es en premier" },
                "üí∏ Menor ahorro primero": { en: "üí∏ Lowest savings first", zh: "üí∏ ÊúÄ‰ΩéËäÇÁúÅ‰ºòÂÖà", de: "üí∏ Niedrigste Einsparungen zuerst", fr: "üí∏ √âconomies les plus faibles en premier" },
                "üî§ Nombre (A-Z)": { en: "üî§ Name (A-Z)", zh: "üî§ ÂêçÁß∞ÔºàA-ZÔºâ", de: "üî§ Name (A-Z)", fr: "üî§ Nom (A-Z)" },
                "üî§ Nombre (Z-A)": { en: "üî§ Name (Z-A)", zh: "üî§ ÂêçÁß∞ÔºàZ-AÔºâ", de: "üî§ Name (Z-A)", fr: "üî§ Nom (Z-A)" },
                "de": { en: "of", zh: "ÁöÑ", de: "von", fr: "de" },
                "ofertas": { en: "offers", zh: "Êä•‰ª∑", de: "Angebote", fr: "offres" },
                "üîÑ Limpiar filtros": { en: "üîÑ Clear filters", zh: "üîÑ Ê∏ÖÈô§Á≠õÈÄâ", de: "üîÑ Filter l√∂schen", fr: "üîÑ Effacer les filtres" },
                
                // Modal de pegado
                "Esperando Pegado (Ctrl+V)": { en: "Waiting for Paste (Ctrl+V)", zh: "Á≠âÂæÖÁ≤òË¥¥ÔºàCtrl+VÔºâ", de: "Warten auf Einf√ºgen (Strg+V)", fr: "En attente de Coller (Ctrl+V)" },
                "Con el cuadro de texto invisible enfocado, pulse Ctrl+V (o Cmd+V) para pegar la imagen de la factura.": { en: "With the invisible text box focused, press Ctrl+V (or Cmd+V) to paste the invoice image.", zh: "Âú®‰∏çÂèØËßÅÊñáÊú¨Ê°ÜËÅöÁÑ¶Êó∂ÔºåÊåâCtrl+VÔºàÊàñCmd+VÔºâÁ≤òË¥¥ÂèëÁ•®ÂõæÂÉè„ÄÇ", de: "Dr√ºcken Sie bei fokussiertem unsichtbaren Textfeld Strg+V (oder Cmd+V), um das Rechnungsbild einzuf√ºgen.", fr: "Avec la zone de texte invisible focalis√©e, appuyez sur Ctrl+V (ou Cmd+V) pour coller l'image de la facture." },
                "Continuar Pegando": { en: "Continue Pasting", zh: "ÁªßÁª≠Á≤òË¥¥", de: "Weiter einf√ºgen", fr: "Continuer √† coller" },
                "Cancelar Pegado": { en: "Cancel Paste", zh: "ÂèñÊ∂àÁ≤òË¥¥", de: "Einf√ºgen abbrechen", fr: "Annuler le Collage" },
                
                // Textos de tarjetas de resultados
                "Ahorro anual": { en: "Annual savings", zh: "Âπ¥Â∫¶ËäÇÁúÅ", de: "J√§hrliche Einsparungen", fr: "√âconomies annuelles" },
                "Resumen de suministros": { en: "Supplies summary", zh: "‰æõÂ∫îÊëòË¶Å", de: "Zusammenfassung der Versorgungen", fr: "R√©sum√© des approvisionnements" },
                "T√©rmino fijo": { en: "Fixed term", zh: "Âõ∫ÂÆöÊúüÈôê", de: "Feste Laufzeit", fr: "Terme fixe" },
                "d√≠as": { en: "days", zh: "Â§©", de: "Tage", fr: "jours" },
                "Imp. hidrocarburos": { en: "Hydrocarbon tax", zh: "Á¢≥Ê∞¢ÂåñÂêàÁâ©Á®é", de: "Kohlenwasserstoffsteuer", fr: "Taxe sur les hydrocarbures" },
                "TOTAL MENSUAL": { en: "MONTHLY TOTAL", zh: "ÊúàÂ∫¶ÊÄªËÆ°", de: "MONAT GESAMT", fr: "TOTAL MENSUEL" },
                "Factura actual:": { en: "Current bill:", zh: "ÂΩìÂâçË¥¶ÂçïÔºö", de: "Aktuelle Rechnung:", fr: "Facture actuelle :" },
                "Ahorro:": { en: "Savings:", zh: "ËäÇÁúÅÔºö", de: "Einsparungen:", fr: "√âconomies :" },
                "/mes": { en: "/month", zh: "/Êúà", de: "/Monat", fr: "/mois" },
                "/a√±o": { en: "/year", zh: "/Âπ¥", de: "/Jahr", fr: "/an" },
                "/Mes": { en: "/Month", zh: "/Êúà", de: "/Monat", fr: "/Mois" },
                "/A√±o": { en: "/Year", zh: "/Âπ¥", de: "/Jahr", fr: "/An" },
                "‚Ç¨/mes": { en: "‚Ç¨/month", zh: "‚Ç¨/Êúà", de: "‚Ç¨/Monat", fr: "‚Ç¨/mois" },
                "‚Ç¨/a√±o": { en: "‚Ç¨/year", zh: "‚Ç¨/Âπ¥", de: "‚Ç¨/Jahr", fr: "‚Ç¨/an" },
                "‚Ç¨/Mes": { en: "‚Ç¨/Month", zh: "‚Ç¨/Êúà", de: "‚Ç¨/Monat", fr: "‚Ç¨/Mois" },
                "‚Ç¨/A√±o": { en: "‚Ç¨/Year", zh: "‚Ç¨/Âπ¥", de: "‚Ç¨/Jahr", fr: "‚Ç¨/An" },
                "T√©rmino fijo (": { en: "Fixed term (", zh: "Âõ∫ÂÆöÊúüÈôêÔºà", de: "Feste Laufzeit (", fr: "Terme fixe (" },
                "Imp. el√©ctrico (5.113%)": { en: "Electricity tax (5.113%)", zh: "ÁîµÂäõÁ®éÔºà5.113%Ôºâ", de: "Stromsteuer (5.113%)", fr: "Taxe sur l'√©lectricit√© (5.113%)" },
                "TOTAL PERIODO": { en: "PERIOD TOTAL", zh: "ÊúüÈó¥ÊÄªËÆ°", de: "ZEITRAUM GESAMT", fr: "TOTAL P√âRIODE" },
                
                // Botones y acciones
                "Cerrar": { en: "Close", zh: "ÂÖ≥Èó≠", de: "Schlie√üen", fr: "Fermer" },
                "Comparar Indexada vs Fija": { en: "Compare Indexed vs Fixed", zh: "ÊØîËæÉÊåáÊï∞‰∏éÂõ∫ÂÆö", de: "Indexiert vs. Fest vergleichen", fr: "Comparer Index√© vs Fixe" },
                "Generar PDF": { en: "Generate PDF", zh: "ÁîüÊàêPDF", de: "PDF erstellen", fr: "G√©n√©rer PDF" },
                "Enviar Propuesta": { en: "Send Proposal", zh: "ÂèëÈÄÅÊèêÊ°à", de: "Vorschlag senden", fr: "Envoyer la Proposition" },
                "Ver Detalles": { en: "View Details", zh: "Êü•ÁúãËØ¶ÊÉÖ", de: "Details anzeigen", fr: "Voir les D√©tails" },
                "Solicitar Mejora": { en: "Request Improvement", zh: "ËØ∑Ê±ÇÊîπËøõ", de: "Verbesserung anfordern", fr: "Demander une Am√©lioration" },
                "Copiar Dise√±o": { en: "Copy Design", zh: "Â§çÂà∂ËÆæËÆ°", de: "Design kopieren", fr: "Copier le Design" },
                "‚úÖ ¬°Copiado! Pega en tu email": { en: "‚úÖ Copied! Paste in your email", zh: "‚úÖ Â∑≤Â§çÂà∂ÔºÅÁ≤òË¥¥Âà∞ÈÇÆ‰ª∂", de: "‚úÖ Kopiert! In E-Mail einf√ºgen", fr: "‚úÖ Copi√© ! Coller dans votre email" },
                
                // Mensajes de estado
                "Por favor espere.": { en: "Please wait.", zh: "ËØ∑Á®çÂÄô„ÄÇ", de: "Bitte warten.", fr: "Veuillez patienter." },
                "Procesando...": { en: "Processing...", zh: "Â§ÑÁêÜ‰∏≠...", de: "Verarbeitung...", fr: "Traitement en cours..." },
                "Generando...": { en: "Generating...", zh: "ÁîüÊàê‰∏≠...", de: "Erstellen...", fr: "G√©n√©ration..." },
                
                // Datos Extra√≠dos
                "Periodo": { en: "Period", zh: "ÊúüÈó¥", de: "Zeitraum", fr: "P√©riode" },
                "d√≠as": { en: "days", zh: "Â§©", de: "Tage", fr: "jours" },
                "d√≠a": { en: "day", zh: "Êó•", de: "Tag", fr: "jour" },
                "D√≠a": { en: "Day", zh: "Êó•", de: "Tag", fr: "Jour" },
                "Fechas": { en: "Dates", zh: "Êó•Êúü", de: "Daten", fr: "Dates" },
                "Consumo por Periodo (kWh)": { en: "Consumption per Period (kWh)", zh: "ÊúüÈó¥Ê∂àËÄó (kWh)", de: "Verbrauch pro Zeitraum (kWh)", fr: "Consommation par P√©riode (kWh)" },
                "Total Consumo": { en: "Total Consumption", zh: "ÊÄªÊ∂àËÄó", de: "Gesamtverbrauch", fr: "Consommation Totale" },
                "Potencia Contratada (kW)": { en: "Contracted Power (kW)", zh: "Á≠æÁ∫¶ÂäüÁéá (kW)", de: "Vertragsleistung (kW)", fr: "Puissance Contract√©e (kW)" },
                
                // Interfaz de resultados
                "Resumen": { en: "Summary", zh: "ÊëòË¶Å", pt: "Resumo", fr: "R√©sum√©" },
                "Precios": { en: "Prices", zh: "‰ª∑Ê†º", pt: "Pre√ßos", fr: "Prix" },
                "Datos Extra√≠dos": { en: "Extracted Data", zh: "ÊèêÂèñÊï∞ÊçÆ", de: "Extrahierte Daten", fr: "Donn√©es Extraites" },
                "C√°lculo Oficial": { en: "Official Calculation", zh: "ÂÆòÊñπËÆ°ÁÆó", de: "Offizielle Berechnung", fr: "Calcul Officiel", pt: "C√°lculo Oficial" },
                "Simulaci√≥n": { en: "Simulation", zh: "Ê®°Êãü", de: "Simulation", fr: "Simulation" },
                "Subtotal Potencia": { en: "Power Subtotal", zh: "ÂäüÁéáÂ∞èËÆ°", de: "Leistung Zwischensumme", fr: "Sous-total Puissance" },
                "Precios de la Oferta Consolidada": { en: "Consolidated Offer Prices", zh: "ÂêàÂπ∂Êä•‰ª∑‰ª∑Ê†º", de: "Konsolidierte Angebotspreise", fr: "Prix de l'Offre Consolid√©e" },
                "Tarifa": { en: "Tariff", zh: "ËµÑË¥π", de: "Tarif", fr: "Tarif" },
                "Punta": { en: "Peak", zh: "Â≥∞ÂÄº", de: "Spitze", fr: "Pointe" },
                "Llano": { en: "Flat", zh: "Âπ≥ÊÆµ", de: "Flach", fr: "Plat" },
                "Valle": { en: "Valley", zh: "Ë∞∑ÊÆµ", de: "Tal", fr: "Vall√©e" },
                "Los precios mostrados son de la oferta ganadora.": { en: "The prices shown are from the winning offer.", zh: "ÊòæÁ§∫ÁöÑ‰ª∑Ê†ºÊù•Ëá™‰∏≠Ê†áÊä•‰ª∑„ÄÇ", de: "Die angezeigten Preise stammen aus dem gewinnenden Angebot.", fr: "Les prix affich√©s proviennent de l'offre gagnante." },
                
                // Botones est√°ndar (para traducci√≥n autom√°tica)
                "Aceptar": { en: "Accept", zh: "Êé•Âèó", de: "Akzeptieren", fr: "Accepter" },
                "Guardar": { en: "Save", zh: "‰øùÂ≠ò", de: "Speichern", fr: "Sauvegarder" },
                "Eliminar": { en: "Delete", zh: "Âà†Èô§", de: "L√∂schen", fr: "Supprimer" },
                "Editar": { en: "Edit", zh: "ÁºñËæë", de: "Bearbeiten", fr: "Modifier" },
                "Modificar": { en: "Modify", zh: "‰øÆÊîπ", de: "√Ñndern", fr: "Modifier" },
                "Actualizar": { en: "Update", zh: "Êõ¥Êñ∞", de: "Aktualisieren", fr: "Mettre √† jour" },
                "Enviar": { en: "Send", zh: "ÂèëÈÄÅ", de: "Senden", fr: "Envoyer" },
                "Generar": { en: "Generate", zh: "ÁîüÊàê", de: "Erstellen", fr: "G√©n√©rer" },
                "Ver": { en: "View", zh: "Êü•Áúã", de: "Anzeigen", fr: "Voir" },
                "Calcular": { en: "Calculate", zh: "ËÆ°ÁÆó", de: "Berechnen", fr: "Calculer" },
                "Comparar": { en: "Compare", zh: "ÊØîËæÉ", de: "Vergleichen", fr: "Comparer" },
                "A√±adir": { en: "Add", zh: "Ê∑ªÂä†", de: "Hinzuf√ºgen", fr: "Ajouter" },
                
                // Botones de acci√≥n espec√≠ficos
                "‚Üê Volver": { en: "‚Üê Back", zh: "‚Üê ËøîÂõû", de: "‚Üê Zur√ºck", fr: "‚Üê Retour" },
                "Generar Comparativa ‚Üí": { en: "Generate Comparison ‚Üí", zh: "ÁîüÊàêÊØîËæÉ ‚Üí", de: "Vergleich erstellen ‚Üí", fr: "G√©n√©rer la Comparaison ‚Üí" },
                "SOLICITAR MEJORA A DRK": { en: "REQUEST IMPROVEMENT FROM DRK", zh: "ÂêëDRKËØ∑Ê±ÇÊîπËøõ", de: "VERBESSERUNG VON DRK ANFORDERN", fr: "DEMANDER UNE AM√âLIORATION √Ä DRK" },
                "Solicitar Mejora a DRK": { en: "Request Improvement from DRK", zh: "ÂêëDRKËØ∑Ê±ÇÊîπËøõ", de: "Verbesserung von DRK anfordern", fr: "Demander une Am√©lioration √† DRK" },
                "Ver desglose detallado del c√°lculo": { en: "View detailed calculation breakdown", zh: "Êü•ÁúãËØ¶ÁªÜËÆ°ÁÆóÊòéÁªÜ", de: "Detaillierte Berechnungsaufschl√ºsselung anzeigen", fr: "Voir la r√©partition d√©taill√©e du calcul" }
            };

            let lang = localStorage.getItem('appLanguage') || 'es';

            // Funci√≥n para traducir
            function tr(text) {
                if (!TR[text] || !TR[text][lang]) return text;
                return TR[text][lang];
            }
            
            // Hacer tr() global
            window.tr = tr;
            
            // CR√çTICO: Interceptor global de jsPDF para traducir autom√°ticamente
            // NUEVO: Sugerir cambiar idioma para generar PDF
            window.suggestLanguageChangeForPDF = function() {
                const currentLang = localStorage.getItem('appLanguage') || 'es';
                if (currentLang === 'zh') {
                    const message = 'üí° Âø´ÈÄüËß£ÂÜ≥ÊñπÊ°à (Quick Solution)\n\n' +
                        '1. ÁÇπÂáªÂè≥‰∏äËßíÂàáÊç¢Âà∞Ëã±ËØ≠ üá¨üáß\n' +
                        '   Click top-right to switch to English üá¨üáß\n\n' +
                        '2. ÁîüÊàêPDF\n' +
                        '   Generate PDF\n\n' +
                        '3. Â¶ÇÈúÄË¶ÅÔºåÂÜçÂàáÊç¢Âõû‰∏≠Êñá\n' +
                        '   Switch back to Chinese if needed\n\n' +
                        'Êï∞Â≠óÂíåËÆ°ÁÆóÁªìÊûúÂ∞ÜÁõ∏Âêå„ÄÇ\n' +
                        'Numbers and calculations will be the same.';
                    
                    alert(message);
                }
            };
            
            // NUEVO: Mostrar advertencia antes de generar PDF en chino
            window.showChinesePDFWarning = function() {
                const currentLang = localStorage.getItem('appLanguage') || 'es';
                if (currentLang === 'zh') {
                    // Mostrar mensaje informativo (no preguntar, directamente hacer el cambio)
                    alert(
                        'üá®üá≥ ÁîüÊàêPDFÊñá‰ª∂‰∏≠...\n' +
                        '‰∏∫‰∫ÜÁ°Æ‰øùÂ≠óÁ¨¶Ê≠£Á°ÆÊòæÁ§∫ÔºåPDFÂ∞Ü‰ΩøÁî®Ëã±ËØ≠ÁîüÊàê„ÄÇ\n\n' +
                        'üá¨üáß Generating PDF...\n' +
                        'To ensure correct character display, the PDF will be generated in English.\n\n' +
                        '‚úÖ ËÆ°ÁÆóÁªìÊûúÂ∞Ü‰øùÊåÅ‰∏çÂèò\n' +
                        '‚úÖ Calculations will remain the same'
                    );
                    
                    // IMPORTANTE: Marcar que el usuario estaba en chino
                    window._wasChineseBeforePDF = true;
                    
                    // Cambiar autom√°ticamente a ingl√©s SIN recargar
                    if (window.LANG && window.LANG.change) {
                        window.LANG.change('en', true); // skipReload = true
                    }
                    
                    return true; // PERMITIR generaci√≥n de PDF en ingl√©s
                }
                window._wasChineseBeforePDF = false; // No estaba en chino
                return true; // Para otros idiomas, continuar sin advertencia
            };
            
            window.setupPDFTranslation = function(doc) {
                if (!doc || !doc.text) return doc;
                
                // NOTA: PDFs en chino est√°n bloqueados por showChinesePDFWarning()
                // No intentamos configurar fuentes chinas porque no funcionan sin fuente completa CJK
                
                const originalText = doc.text.bind(doc);
                
                doc.text = function(text, x, y, options) {
                    // Traducir solo strings, no objetos ni arrays
                    if (typeof text === 'string' && window.tr) {
                        // Lista EXHAUSTIVA de patrones a buscar y reemplazar
                        const patterns = [
                            // T√çTULOS PRINCIPALES
                            'DESGLOSE DETALLADO DE LA SIMULACI√ìN',
                            'ESTUDIO DE AHORRO',
                            'COMPARATIVA PROFESIONAL',
                            'TU AHORRO ANUAL ESTIMADO ES:',
                            'TU FACTURA ACTUAL',
                            'TU NUEVO COSTE DRK',
                            'TU NUEVO COSTE POWER CUP',
                            
                            // MULTICUPS
                            'Datos Generales',
                            'Potencias (kW)',
                            'Energ√≠a (kWh)',
                            'Consumos (kWh)',
                            'Total Consumo',
                            'Hogar/Negocio',
                            'Industria/Gran Consumo',
                            'Acumulado',
                            'TOTAL ENERGY',
                            'Datos Acumulados',
                            
                            // T√âRMINOS T√âCNICOS
                            'T√âRMINO POTENCIA (Precio en ‚Ç¨/kW D√≠a)',
                            'T√âRMINO POTENCIA',
                            'T√âRMINO ENERG√çA (Precios en ‚Ç¨/kWh)',
                            'T√âRMINO ENERG√çA',
                            'Precio en ‚Ç¨/kW D√≠a',
                            'Precios en ‚Ç¨/kWh',
                            
                            // PER√çODOS
                            'E1 - Punta',
                            'E2 - Llano', 
                            'E3 - Valle',
                            'E4 - Supervalle',
                            'E5 - Punta',
                            'E6 - Valle',
                            'Punta',
                            'Llano',
                            'Valle',
                            'Supervalle',
                            
                            // SUBTOTALES Y TOTALES
                            'Subtotal Energ√≠a (Bruto)',
                            'Subtotal Energ√≠a (Neto)',
                            'SUBTOTAL POTENCIA',
                            'POWER SUBTOTAL',
                            'SUBTOTAL BASE (P+E)',
                            'BASE IMPONIBLE',
                            'TAXABLE BASE',
                            
                            // IMPUESTOS
                            'Imp. El√©c.',
                            'IVA (21%)',
                            'VAT (21%)',
                            'Imp. Hidrocarburos',
                            
                            // TOTALES
                            'TOTAL FACTURA (60 D√çAS)',
                            'TOTAL FACTURA (30 D√çAS)',
                            'TOTAL FACTURA',
                            'TOTAL A√ëO (PROYECTADO)',
                            'TOTAL YEAR (PROJECTED)',
                            'Total Periodo',
                            'Estimado Mensual',
                            
                            // CLIENTE
                            'CLIENTE:',
                            'COMERCIAL:',
                            'CUPS:',
                            'CUPS TOTALES:',
                            'TARIFA:',
                            
                            // OTROS
                            'Liderando el ahorro y la',
                            'eficiencia energ√©tica.',
                            'Asesor√≠a Energ√©tica',
                            'PRECIOS DE LA OFERTA:',
                            'PARA FORMALIZAR ESTE CONTRATO:',
                            
                            // GAS
                            'T√âRMINO FIJO:',
                            'ENERG√çA:',
                            'POTENCIA:',
                            'T√âRMINO FIJO (Precio en ‚Ç¨/d√≠a)',
                            'Precio fijo diario (‚Ç¨/d√≠a):',
                            'Precio energ√≠a (‚Ç¨/kWh):',
                            
                            // UNIDADES TEMPORALES (MUY IMPORTANTE)
                            '‚Ç¨/mes',
                            '‚Ç¨/a√±o',
                            '/mes',
                            '/a√±o',
                            '‚Ç¨/Mes',
                            '‚Ç¨/A√±o',
                            '/Mes',
                            '/A√±o',
                            
                            // Secciones del PDF (sin dos puntos)
                            'POTENCIA',
                            'ENERG√çA',
                            'RESUMEN DE',
                            'SUMINISTROS',
                            'RESUMEN DE TODOS LOS SUMINISTROS',
                            'RESUMEN DE SUMINISTROS INCLUIDOS',
                            'LA MEJOR OPCI√ìN PARA TI ES'
                        ];
                        
                        let translated = text;
                        let hasChange = false;
                        
                        // Buscar y reemplazar cada patr√≥n
                        patterns.forEach(pattern => {
                            if (translated.includes(pattern)) {
                                const translatedPattern = window.tr(pattern);
                                if (translatedPattern !== pattern) {
                                    translated = translated.replace(new RegExp(pattern.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), translatedPattern);
                                    hasChange = true;
                                    console.log(`üìù PDF Pattern: "${pattern}" ‚Üí "${translatedPattern}"`);
                                }
                            }
                        });
                        
                        // Tambi√©n intentar traducir el texto completo
                        const fullTranslation = window.tr(text);
                        if (fullTranslation !== text) {
                            console.log(`üìù PDF Full: "${text}" ‚Üí "${fullTranslation}"`);
                            text = fullTranslation;
                        } else if (hasChange) {
                            text = translated;
                        }
                    }
                    return originalText(text, x, y, options);
                };
                
                return doc;
            };
            
            // Funci√≥n para traducir TODO el HTML generado (usado antes de crear PDFs)
            window.translateHTML = function(html) {
                if (!html) return html;
                
                const currentLang = localStorage.getItem('appLanguage') || 'es';
                console.log('üåç translateHTML called with language:', currentLang);
                
                if (currentLang === 'es') {
                    console.log('‚úÖ Language is Spanish, no translation needed');
                    return html; // No need to translate if already in Spanish
                }
                
                // Lista exhaustiva de textos a traducir con TODAS las variantes
                const replacements = [
                    // MULTICUPS - Interfaz
                    ['A√±adir Suministro', tr('A√±adir Suministro')],
                    ['Datos Generales', tr('Datos Generales')],
                    ['N√∫mero CUPS', tr('N√∫mero CUPS')],
                    ['D√≠as Facturados', tr('D√≠as Facturados')],
                    ['Potencias (kW)', tr('Potencias (kW)')],
                    ['Energ√≠a (kWh)', tr('Energ√≠a (kWh)')],
                    ['Total Factura (‚Ç¨)', tr('Total Factura (‚Ç¨)')],
                    ['A√ëADIR SUMINISTRO MANUAL', tr('A√ëADIR SUMINISTRO MANUAL')],
                    ['A√ëADIR SUMINISTRO', tr('A√ëADIR SUMINISTRO')],
                    ['Cancelar', tr('Cancelar')],
                    
                    // Modal de confirmaci√≥n QR
                    ['Confirmar Suministro MultiCups', tr('Confirmar Suministro MultiCups')],
                    ['Revisa los datos extra√≠dos del QR antes de a√±adir este suministro a la lista.', tr('Revisa los datos extra√≠dos del QR antes de a√±adir este suministro a la lista.')],
                    ['Datos Extra√≠dos del QR', tr('Datos Extra√≠dos del QR')],
                    ['D√≠as Fact:', tr('D√≠as Fact:')],
                    ['Total Factura:', tr('Total') + ' ' + tr('Factura:')],
                    ['A√ëADIR A LA LISTA DE CUPS', tr('A√ëADIR A LA LISTA DE CUPS')],
                    ['RESUMEN DE', tr('RESUMEN DE')],
                    ['SUMINISTROS', tr('SUMINISTROS')],
                    ['RESUMEN DE TODOS LOS SUMINISTROS', tr('RESUMEN DE TODOS LOS SUMINISTROS')],
                    
                    // Modales
                    ['C√°lculo Completado', tr('C√°lculo Completado')],
                    ['Comparar FIJO vs INDEXADO', tr('Comparar FIJO vs INDEXADO')],
                    ['SEE BEST OPTION', tr('SEE BEST OPTION')],
                    ['CHOOSE FROM RESULTS', tr('CHOOSE FROM RESULTS')],
                    ['Suministro A√±adido', tr('Suministro A√±adido')],
                    ['Understood', tr('Understood')],
                    
                    // MULTICUPS selecci√≥n
                    ['Volver a selecci√≥n', tr('Volver a selecci√≥n')],
                    ['MULTICUPS', tr('MULTICUPS')],
                    ['Selecciona el tipo de contrato que deseas a√±adir.', tr('Selecciona el tipo de contrato que deseas a√±adir.')],
                    ['Total de suministros actuales:', tr('Total de suministros actuales:')],
                    ['Permite Esc√°ner QR, Imagen y Entrada Manual', tr('Permite Esc√°ner QR, Imagen y Entrada Manual')],
                    ['Solo Entrada de Datos Manual', tr('Solo Entrada de Datos Manual')],
                    ['FINALIZAR Y COMPARAR', tr('FINALIZAR Y COMPARAR')],
                    ['Suministros', tr('Suministros')],
                    
                    // Datos Acumulados
                    ['Datos Acumulados', tr('Datos Acumulados')],
                    ['TOTAL ENERGY', tr('TOTAL ENERGY')],
                    ['Hogar/Negocio', tr('Hogar/Negocio')],
                    ['Industria/Gran Consumo', tr('Industria/Gran Consumo')],
                    ['Consumos (kWh)', tr('Consumos (kWh)')],
                    ['Acumulado', tr('Acumulado')],
                    ['Total Consumo', tr('Total Consumo')],
                    
                    // Secciones del PDF (sin dos puntos para evitar conflictos)
                    ['POTENCIA', tr('POTENCIA')],
                    ['ENERG√çA', tr('ENERG√çA')],
                    ['Punta', tr('Punta')],
                    ['Llano', tr('Llano')],
                    ['Valle', tr('Valle')],
                    
                    // GAS - Interfaz
                    ['Selection mode:', tr('Selection mode:')],
                    ['Best rates', tr('Best rates')],
                    ['Elegir entre resultados', tr('Elegir entre resultados')],
                    ['Selecciona manualmente las tarifas que deseas comparar.', tr('Selecciona manualmente las tarifas que deseas comparar.')],
                    ['Ver tarifas disponibles', tr('Ver tarifas disponibles')],
                    ['Selecciona las tarifas a comparar:', tr('Selecciona las tarifas a comparar:')],
                    ['Selecciona una o m√°s tarifas para comparar.', tr('Selecciona una o m√°s tarifas para comparar.')],
                    ['üîç Buscar comercializadora:', tr('üîç Buscar comercializadora:')],
                    ['Ordenar por:', tr('Ordenar por:')],
                    ['üí∞ Mayor ahorro primero', tr('üí∞ Mayor ahorro primero')],
                    ['üîª Menor ahorro primero', tr('üîª Menor ahorro primero')],
                    ['üìã Por nombre', tr('üìã Por nombre')],
                    ['Calcular tarifas seleccionadas', tr('Calcular tarifas seleccionadas')],
                    
                    // Variaciones con par√©ntesis (CR√çTICAS para PDFs)
                    ['T√âRMINO POTENCIA (Precio en ‚Ç¨/kW D√≠a)', tr('T√âRMINO POTENCIA (Precio en ‚Ç¨/kW D√≠a)')],
                    ['T√âRMINO ENERG√çA (Precios en ‚Ç¨/kWh)', tr('T√âRMINO ENERG√çA (Precios en ‚Ç¨/kWh)')],
                    ['TOTAL FACTURA (60 D√çAS)', tr('TOTAL FACTURA (60 D√çAS)')],
                    ['Liderando el ahorro y la', tr('Liderando el ahorro y la')],
                    
                    // GAS - Resultados
                    ['Fixed term (30 days)', tr('Fixed term (30 days)')],
                    ['Energ√≠a (500 kWh)', tr('Energ√≠a (500 kWh)')],
                    ['Hydrocarbon tax', tr('Hydrocarbon tax')],
                    ['Your current bill:', tr('Your current bill:')],
                    ['With this rate:', tr('With this rate:')],
                    ['Monthly savings:', tr('Monthly savings:')],
                    ['Annual savings:', tr('Annual savings:')],
                    
                    // GAS - PDF
                    ['SAVINGS STUDY', tr('SAVINGS STUDY')],
                    ['COMPARATIVA PROFESIONAL GAS - DRK', tr('COMPARATIVA PROFESIONAL GAS - DRK')],
                    ['TARIFA:', tr('TARIFA:')],
                    ['T√âRMINO FIJO:', tr('T√âRMINO FIJO:')],
                    ['ENERG√çA:', tr('ENERG√çA:')],
                    ['Precio fijo diario (‚Ç¨/d√≠a):', tr('Precio fijo diario (‚Ç¨/d√≠a):')],
                    ['Precio energ√≠a (‚Ç¨/kWh):', tr('Precio energ√≠a (‚Ç¨/kWh):')],
                    ['T√âRMINO FIJO (Precio en ‚Ç¨/d√≠a)', tr('T√âRMINO FIJO (Precio en ‚Ç¨/d√≠a)')],
                    ['T√âRMINO ENERG√çA (Precios en ‚Ç¨/kWh)', tr('T√âRMINO ENERG√çA (Precios en ‚Ç¨/kWh)')],
                    ['Subtotal Energ√≠a (Bruto)', tr('Subtotal Energ√≠a (Bruto)')],
                    ['Imp. Hidrocarburos', tr('Imp. Hidrocarburos')],
                    ['TOTAL FACTURA (30 D√çAS)', tr('TOTAL FACTURA (30 D√çAS)')],
                    ['Precio fijo', tr('Precio fijo')],
                    
                    // Encabezados - TODAS las variantes
                    ['DESGLOSE DETALLADO DE LA SIMULACI√ìN', tr('DESGLOSE DETALLADO DE LA SIMULACI√ìN')],
                    ['TU AHORRO ANUAL ESTIMADO ES:', tr('TU AHORRO ANUAL ESTIMADO ES:')],
                    ['LA MEJOR OPCI√ìN PARA TI ES', tr('LA MEJOR OPCI√ìN PARA TI ES')],
                    ['TU FACTURA ACTUAL', tr('TU FACTURA ACTUAL')],
                    ['TU NUEVO COSTE DRK', tr('TU NUEVO COSTE DRK')],
                    ['TU NUEVO COSTE POWER CUP', tr('TU NUEVO COSTE POWER CUP')],
                    ['TU AHORRO ANUAL ESTIMADO', tr('TU AHORRO ANUAL ESTIMADO')],
                    ['TU AHORRO ANUAL FIJO', tr('TU AHORRO ANUAL FIJO')],
                    ['TU AHORRO ANUAL INDEXADO', tr('TU AHORRO ANUAL INDEXADO')],
                    
                    // Headers
                    ['ESTUDIO DE AHORRO', tr('ESTUDIO DE AHORRO')],
                    ['COMPARATIVA PROFESIONAL', tr('COMPARATIVA PROFESIONAL')],
                    ['COMPARATIVA', tr('COMPARATIVA')],
                    ['PROFESIONAL', tr('PROFESIONAL')],
                    ['Liderando el ahorro y la eficiencia energ√©tica.', tr('Liderando el ahorro y la eficiencia energ√©tica.')],
                    ['eficiencia energ√©tica.', tr('eficiencia energ√©tica.')],
                    ['Asesor√≠a Energ√©tica', tr('Asesor√≠a Energ√©tica')],
                    ['Ofrece el mayor ahorro consolidado con', tr('Ofrece el mayor ahorro consolidado con')],
                    
                    // Cliente
                    ['CLIENTE:', tr('CLIENTE:')],
                    ['CUPS:', tr('CUPS:')],
                    ['COMERCIAL:', tr('COMERCIAL:')],
                    ['CUPS TOTALES:', tr('CUPS TOTALES:')],
                    ['[NOMBRE COMPLETO CLIENTE]', tr('[NOMBRE COMPLETO CLIENTE]')],
                    
                    // T√©rminos - MUY IMPORTANTE
                    ['T√âRMINO POTENCIA (Precio en ‚Ç¨/kW D√≠a)', tr('T√âRMINO POTENCIA (Precio en ‚Ç¨/kW D√≠a)')],
                    ['T√âRMINO POTENCIA', tr('T√âRMINO POTENCIA')],
                    ['T√âRMINO ENERG√çA (Precios en ‚Ç¨/kWh)', tr('T√âRMINO ENERG√çA (Precios en ‚Ç¨/kWh)')],
                    ['T√âRMINO ENERG√çA', tr('T√âRMINO ENERG√çA')],
                    ['POTENCIA:', tr('POTENCIA:')],
                    ['ENERGIA:', tr('ENERGIA:')],
                    ['Precio en ‚Ç¨/kW D√≠a', tr('Precio en ‚Ç¨/kW D√≠a')],
                    ['Precios en ‚Ç¨/kWh', tr('Precios en ‚Ç¨/kWh')],
                    
                    // Per√≠odos espec√≠ficos
                    ['E1 - Punta', tr('E1 - Punta')],
                    ['E2 - Llano', tr('E2 - Llano')],
                    ['E3 - Valle', tr('E3 - Valle')],
                    ['Punta', tr('Punta')],
                    ['Llano', tr('Llano')],
                    ['Valle', tr('Valle')],
                    
                    // Subtotales - CR√çTICOS
                    ['SUBTOTAL POTENCIA', tr('SUBTOTAL POTENCIA')],
                    ['POWER SUBTOTAL', tr('SUBTOTAL POTENCIA')],
                    ['SUBTOTAL BASE (P+E)', tr('SUBTOTAL BASE (P+E)')],
                    ['BASE IMPONIBLE', tr('BASE IMPONIBLE')],
                    ['TAXABLE BASE', tr('BASE IMPONIBLE')],
                    ['Subtotal Energ√≠a (Bruto)', tr('Subtotal Energ√≠a (Bruto)')],
                    ['Subtotal Energ√≠a (Neto)', tr('Subtotal Energ√≠a (Neto)')],
                    
                    // Impuestos
                    ['Imp. El√©c.', tr('Imp. El√©c.')],
                    ['IVA (21%)', tr('IVA (21%)')],
                    ['VAT (21%)', tr('IVA (21%)')],
                    
                    // Totales - MUY IMPORTANTES
                    ['TOTAL FACTURA (60 D√çAS)', tr('TOTAL FACTURA') + ' (60 ' + tr('D√çAS') + ')'],
                    ['TOTAL FACTURA', tr('TOTAL FACTURA')],
                    ['TOTAL A√ëO (PROYECTADO)', tr('TOTAL A√ëO (PROYECTADO)')],
                    ['TOTAL YEAR (PROJECTED)', tr('TOTAL A√ëO (PROYECTADO)')],
                    ['Total Periodo', tr('Total Periodo')],
                    ['Estimado Mensual', tr('Estimado Mensual')],
                    
                    // GAS espec√≠fico
                    ['Resultados GAS', tr('Resultados GAS')],
                    ['Comparativa de tarifas', tr('Comparativa de tarifas')],
                    ['T√©rmino fijo', tr('T√©rmino fijo')],
                    ['T√©rmino fijo:', tr('T√©rmino fijo:')],
                    ['Impuesto hidrocarburos', tr('Impuesto hidrocarburos')],
                    
                    // Documentaci√≥n
                    ['PARA FORMALIZAR ESTE CONTRATO:', tr('PARA FORMALIZAR ESTE CONTRATO:')],
                    ['Responde a este email adjuntando la siguiente documentacion:', tr('Responde a este email adjuntando la siguiente documentacion:')],
                    ['Responde a este email adjuntando la documentacion de los', tr('Responde a este email adjuntando la documentacion de los')],
                    ['Este resumen es una simulacion', tr('Este resumen es una simulacion')],
                    ['basada en su ultima factura', tr('basada en su ultima factura')],
                    ['consolidada de', tr('consolidada de')],
                    ['suministros', tr('suministros')],
                    ['Colaborador:', tr('Colaborador:')],
                    
                    // Ofertas
                    ['PRECIOS DE LA OFERTA:', tr('PRECIOS DE LA OFERTA:')],
                    ['DESGLOSE DETALLADO DE LA SIMULACI√ìN', tr('DESGLOSE DETALLADO DE LA SIMULACI√ìN')],
                    ['DESGLOSE DETALLADO', tr('DESGLOSE DETALLADO')]
                ];
                
                // Aplicar reemplazos
                let result = html;
                let replacedCount = 0;
                
                replacements.forEach(([original, translated]) => {
                    if (original && translated && original !== translated) {
                        const escaped = original.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        const regex = new RegExp(escaped, 'gi'); // Case insensitive
                        const matches = result.match(regex);
                        if (matches) {
                            result = result.replace(regex, translated);
                            replacedCount += matches.length;
                            console.log(`‚úÖ Replaced "${original}" ‚Üí "${translated}" (${matches.length} times)`);
                        }
                    }
                });
                
                // Traducir unidades al final (para evitar conflictos)
                const unitReplacements = [
                    [' d√≠as)', ' ' + tr('d√≠as') + ')'],
                    [' D√çAS)', ' ' + tr('D√çAS') + ')'],
                    ['‚Ç¨/mes', tr('‚Ç¨/mes')],
                    ['‚Ç¨/a√±o', tr('‚Ç¨/a√±o')],
                    ['‚Ç¨/Mes', tr('‚Ç¨/Mes')],
                    ['‚Ç¨/A√±o', tr('‚Ç¨/A√±o')],
                    ['/mes', tr('/mes')],
                    ['/a√±o', tr('/a√±o')],
                    ['/Mes', tr('/Mes')],
                    ['/A√±o', tr('/A√±o')]
                ];
                
                unitReplacements.forEach(([original, translated]) => {
                    if (original && translated && original !== translated) {
                        const escaped = original.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        const regex = new RegExp(escaped, 'g');
                        result = result.replace(regex, translated);
                    }
                });
                
                console.log(`üéâ Total replacements made: ${replacedCount}`);
                return result;
            };

            // Funci√≥n exhaustiva de traducci√≥n
            function translateAll() {
                // Navbar
                const accentEl = document.getElementById('app-logo-accent');
                if (accentEl) accentEl.textContent = tr('Energ√≠a');
                const subtitleEl = document.getElementById('app-subtitle');
                if (subtitleEl) subtitleEl.textContent = tr('Selector');

                // Traducir elementos espec√≠ficos por ID
                const elementIds = [
                    'inicio-title', 'inicio-subtitle', 'inicio-supply-label',
                    'landing-title', 'savings-label', 'gas-results-subtitle', 'gas-regulation-subtitle',
                    'qr-analyzing-title', 'qr-progress-label', 'qr-help-text',
                    'multicups-datos-generales', 'multicups-potencias', 'multicups-energia',
                    'qr-confirm-title', 'qr-confirm-subtitle', 'confirm-save-supply-btn',
                    'finalize-btn-text', 'finalize-suministros-text',
                    'tariff-selector-title', 'tarifa-fija-title', 'tarifa-fija-desc',
                    'tarifa-indexada-title', 'tarifa-indexada-desc', 'tariff-selector-continue-btn',
                    'dual-title', 'dual-subtitle', 'dual-supplies-label',
                    'dual-add-btn', 'dual-calculate-btn', 'dual-reset-btn',
                    'advice-label', 'advice-content',
                    'compare-fijo-indexado-title', 'compare-fijo-indexado-desc',
                    'offer-selection-title', 'offer-selection-subtitle', 'datos-suministro-label',
                    'buscar-nombre-label', 'ordenar-por-label', 'offers-de-text', 'offers-text',
                    'limpiar-filtros-btn', 'cancel-manual-input-btn',
                    'back-offer-selection-btn', 'confirm-offer-selection-btn',
                    'gas-request-improvement-text', 'dual-request-improvement-text', 'request-improvement-text',
                    'calculation-complete-title', 'calculation-complete-subtitle',
                    'details-toggle-text', 'reset-button-text'
                ];
                
                elementIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el && el.textContent.trim()) {
                        const original = el.textContent.trim();
                        const translated = tr(original);
                        if (translated !== original) {
                            el.textContent = translated;
                        }
                    }
                });

                // Traducir TODO el DOM por contenido
                const walker = document.createTreeWalker(
                    document.body,
                    NodeFilter.SHOW_TEXT,
                    null,
                    false
                );

                let node;
                const nodesToTranslate = [];
                
                while (node = walker.nextNode()) {
                    const trimmed = node.textContent.trim();
                    if (trimmed && TR[trimmed]) {
                        nodesToTranslate.push({node, original: trimmed});
                    }
                }

                // Traducir todos los nodos encontrados
                nodesToTranslate.forEach(({node, original}) => {
                    const newText = tr(original);
                    if (node.textContent.includes(original)) {
                        node.textContent = node.textContent.replace(original, newText);
                    }
                });
                
                // CR√çTICO: Traducir placeholders
                const searchInput = document.getElementById('offer-search-input');
                if (searchInput) {
                    searchInput.placeholder = tr('Escribe nombre de comercializadora...');
                }
                
                // CR√çTICO: Traducir placeholders del modal Request Improvement
                const modalInputs = [
                    { id: 'improvement-comercial-code', text: 'C√ìDIGO COMERCIAL (Obligatorio)' },
                    { id: 'improvement-client-name', text: 'Nombre Cliente' },
                    { id: 'improvement-client-cups', text: 'CUPS' },
                    { id: 'improvement-client-phone', text: 'Tel√©fono' },
                    { id: 'improvement-client-email', text: 'Email' },
                    { id: 'improvement-observations', text: 'Observaciones (opcional)' }
                ];
                modalInputs.forEach(({id, text}) => {
                    const el = document.getElementById(id);
                    if (el) el.placeholder = tr(text);
                });
                
                // CR√çTICO: Traducir opciones del select de ordenaci√≥n
                const sortSelect = document.getElementById('offer-sort-select');
                if (sortSelect) {
                    const options = sortSelect.querySelectorAll('option');
                    options.forEach(option => {
                        const originalText = option.textContent.trim();
                        option.textContent = tr(originalText);
                    });
                }
                
                // CR√çTICO: Traducir TODOS los botones con textos est√°ndar
                const allButtons = document.querySelectorAll('button');
                allButtons.forEach(button => {
                    const text = button.textContent.trim();
                    // Lista completa de textos de botones a traducir
                    const buttonTexts = [
                        'Cancelar', 'Cerrar', 'Aceptar', 'Continuar', 'Guardar', 'Eliminar',
                        'Editar', 'Modificar', 'Actualizar', 'Enviar', 'Generar', 'Ver',
                        'Calcular', 'Comparar', 'A√±adir', '‚Üê Volver', 'Generar Comparativa ‚Üí',
                        'SOLICITAR MEJORA A DRK', 'Solicitar Mejora a DRK',
                        'Ver desglose detallado del c√°lculo'
                    ];
                    
                    if (buttonTexts.includes(text)) {
                        button.textContent = tr(text);
                    }
                });
            }
            
            // CR√çTICO: Hacer translateAll disponible globalmente
            window.translateAll = translateAll;

            // API global
            window.LANG = {
                change: function(newLang, skipReload = false) {
                    const oldLang = lang;
                    lang = newLang;
                    localStorage.setItem('appLanguage', newLang);
                    
                    // Solo recargar si es un cambio manual del usuario (no la carga inicial)
                    if (!skipReload && oldLang !== newLang) {
                        console.log(`üîÑ Cambiando idioma de ${oldLang} a ${newLang} - Recargando p√°gina...`);
                        location.reload();
                        return;
                    }
                    
                    // Si es carga inicial, solo actualizar la UI
                    if (document.getElementById('language-selector')) {
                        document.getElementById('language-selector').value = newLang;
                    }
                    document.title = tr('DRK COMPARADOR');
                    translateAll();
                },
                translate: tr,
                retranslate: translateAll,
                getCurrentLang: function() { return lang; }
            };

            // Interceptar navegaci√≥n
            const funcsToIntercept = ['hideAllScreens', 'goToInicio', 'goToElectricidad', 'goToGas', 'goToDual', 
                                       'selectTariffType', 'showOfferDecisionModal', 'showDualResults'];
            
            funcsToIntercept.forEach(funcName => {
                const original = window[funcName];
                if (original) {
                    window[funcName] = function() {
                        const result = original.apply(this, arguments);
                        setTimeout(() => window.LANG.retranslate(), 100);
                        return result;
                    };
                }
            });

            // MutationObserver
            const observer = new MutationObserver((mutations) => {
                const hasChanges = mutations.some(m => m.addedNodes.length > 0 || m.type === 'childList');
                if (hasChanges) {
                    setTimeout(() => window.LANG.retranslate(), 50);
                }
            });

            const appEl = document.getElementById('app');
            if (appEl) {
                observer.observe(appEl, {childList: true, subtree: true});
            }

            // Inicializar
            window.addEventListener('DOMContentLoaded', () => {
                const savedLang = localStorage.getItem('appLanguage') || 'es';
                window.LANG.change(savedLang, true); // skipReload = true para carga inicial
            });

            window.addEventListener('load', () => {
                setTimeout(() => window.LANG.retranslate(), 200);
            });
        })();
    </script>
</div>

<script>
// ========== SISTEMA DE TRADUCCI√ìN DEL PANEL ==========
const panelTranslations = {
    es: {
        'panel-title': 'DRK Energ√≠a',
        'panel-subtitle': 'Smart Solutions',
        'dept1-label': 'Optimizaci√≥n',
        'dept1-title': 'Calcula tu Ahorro',
        'dept2-label': 'Mercado',
        'dept2-title': 'Precios de la Competencia',
        'dept2-coming-soon': 'Pr√≥ximamente: Precios de la Competencia',
        'dept3-label': 'Contacto',
        'dept3-title': 'Email Backoffice',
        'dept3-coming-soon': 'Pr√≥ximamente: Email Backoffice',
        'dept4-label': 'Beneficios',
        'dept4-title': 'C√≥digo Amigos y Descuentos',
        'dept5-label': 'Informaci√≥n',
        'dept5-title': 'Noticias',
        'news-title': 'Noticias',
        'news-subtitle': 'Mantente informado con las √∫ltimas novedades',

        'dept4-coming-soon': 'Pr√≥ximamente: C√≥digo Amigos',
        'friends-title': 'üë• C√≥digo Amigos DRK',
        'friends-subtitle': 'Comparte energ√≠a, comparte ahorro',
        'friends-benefit-1-title': 'Presenta a un amigo empresario',
        'friends-benefit-1-desc': 'Solo necesitas presentarnos a un contacto que tenga una empresa y est√© dispuesto a compartir su factura energ√©tica actual',
        'friends-benefit-2-title': 'Estudio energ√©tico gratuito',
        'friends-benefit-2-desc': 'Realizaremos un an√°lisis completo y profesional de su consumo sin ning√∫n coste ni compromiso de contrataci√≥n',
        'friends-benefit-3-title': 'Recibe tu c√≥digo exclusivo',
        'friends-benefit-3-desc': 'Como agradecimiento, te entregaremos un c√≥digo promocional √∫nico para que compartas con tus 5 amigos',
        'friends-benefit-4-title': 'Beneficia hasta 5 hogares',
        'friends-benefit-4-desc': 'Comparte la tarifa especial en energ√≠a y potencia con familiares, amigos o conocidos que quieras ayudar',
        'friends-banner-title': 'üëç Lo mejor de todo',
        'friends-banner-intro': 'Imagina poder ofrecer a tus seres queridos una tarifa energ√©tica tan incre√≠ble como esta:',
        'friends-banner-code': 'El c√≥digo que te enviamos con el descuento es aplicable en hasta 5 hogares diferentes. Es tu oportunidad dorada para que quienes m√°s te importan ahorren de verdad y de forma significativa en su factura de la luz.',
        'friends-conditions-title': 'üìå Condiciones importantes',
        'friends-conditions-intro': 'La empresa que presente su factura para el estudio energ√©tico no tiene ninguna obligaci√≥n de contratar con nosotros. El an√°lisis es completamente gratuito y sin compromiso. Es una forma de ayudar a tu contacto empresarial a conocer su situaci√≥n energ√©tica actual mientras t√∫ obtienes acceso a esta promoci√≥n extraordinaria.',
        'friends-condition-1': 'Basta con presentar una factura de empresa con suministro activo',
        'friends-condition-2': 'El c√≥digo es v√°lido √∫nicamente para hasta 5 hogares',
        'friends-condition-3': 'No v√°lido para tarifas con exclusi√≥n social o familia numerosa',
        'friends-condition-4': 'Promoci√≥n limitada en tiempo y plazas disponibles',
        'friends-condition-5': 'Aplicable a nuevos contratos o renovaciones con c√≥digo promocional',
        'friends-card-title': 'üíé DRK PLAN AMIGO',
        'friends-card-subtitle': 'Tarifa exclusiva para referidos',
        'friends-request-button': 'üéÅ QUIERO MI C√ìDIGO - SOLICITAR A DRK ENERGY',
        'friends-form-title': 'üìã DATOS AMIGO PARA CONSEGUIR C√ìDIGO',
        'friends-form-friend-data': 'üè¢ DATOS DEL AMIGO (empresa recomendada)',
        'friends-form-company-name': 'Nombre de la empresa amiga *',
        'friends-form-contact-person': 'Persona de contacto *',
        'friends-form-friend-email': 'Email *',
        'friends-form-friend-phone': 'Tel√©fono *',
        'friends-form-comments': 'Comentarios opcionales',
        'friends-form-my-data': 'üë§ MIS DATOS (quien solicita el c√≥digo)',
        'friends-form-my-name': 'Nombre *',
        'friends-form-my-email': 'Email *',
        'friends-form-my-phone': 'Tel√©fono *',
        'friends-form-cancel': 'Cancelar',
        'friends-form-send': 'üìß Enviar Solicitud',


        'email-modal-title': 'Email Backoffice',
        'email-modal-subtitle': 'Datos del Cliente (opcional)',
        'email-label-name': 'Nombre y Apellidos',
        'email-label-email': 'Email',
        'email-label-phone': 'Tel√©fono',
        'email-btn-cancel': 'Cancelar',
        'email-btn-send': 'Abrir Email',
        'email-optional-note': 'Los campos son opcionales. Puedes enviar el email sin rellenarlos.',
        'back-btn': 'Volver',
        'comparison-title': 'üìä Comparativa de Precios - Tarifa 2.0TD',
        'comparison-subtitle': 'An√°lisis profesional con datos reales del mercado espa√±ol',
        'comparison-loading': 'Cargando datos de mercado...',
        'comp-col-company': 'Comercializadora',
        'comp-col-monthly': 'Coste Mensual',
        'comp-col-annual': 'Coste Anual',
        'comp-col-savings': 'Dif. vs Mejor',
        'comp-chart-title': 'üìà Comparativa Visual - Coste Anual',
        'comp-summary-title': 'üí° ¬øPor qu√© elegir la mejor tarifa?',
        'comp-benefit-1-title': 'Ahorro Real',
        'comp-benefit-1-desc': 'Compara precios reales actualizados del mercado',
        'comp-benefit-2-title': 'Transparencia',
        'comp-benefit-2-desc': 'Datos verificables y actualizados mensualmente',
        'comp-benefit-3-title': 'Decisi√≥n Informada',
        'comp-benefit-3-desc': 'Compara y elige la opci√≥n que m√°s te conviene',
        'comp-footer-note': '<strong>Nota metodol√≥gica:</strong> Precios reales extra√≠dos de tarifas p√∫blicas vigentes sin IVA. Cliente tipo: 6 kW potencia contratada, consumo mensual 270 kWh (60 kWh punta, 90 kWh llano, 120 kWh valle). Datos actualizados autom√°ticamente. Los precios pueden variar seg√∫n promociones espec√≠ficas.',
        'comp-stats-companies': 'Comercializadoras',
        'comp-stats-analyzed': 'Seleccionadas',
        'comp-stats-avg-savings': 'Ahorro Medio Anual',
        'comp-stats-best': 'Mejor Opci√≥n',
        'comp-best-badge': 'MEJOR PRECIO',
        'comp-reference': 'Referencia',
        'comp-highlight-title': 'Ahorro Real y Verificable',
        'comp-highlight-text': 'Con la mejor tarifa del mercado, un cliente tipo ahorra significativamente frente a las opciones m√°s caras. Estos ahorros son reales y est√°n calculados con los precios actuales de cada comercializadora.',
        'comp-client-profile': 'Cliente tipo: 6 kW ‚Ä¢ 270 kWh/mes',
        // Textos para traducci√≥n post-generaci√≥n
        'comp-text-with': 'Con',
        'comp-text-client-pays': 'un cliente tipo paga solo',
        'comp-text-per-year': 'al a√±o',
        'comp-text-while': 'mientras que con',
        'comp-text-would-pay': 'pagar√≠a',
        'comp-text-thats': 'Eso son',
        'comp-text-difference': 'de diferencia',
        'comp-text-pocket': 'que permanecen en tu bolsillo cada a√±o',
        'comp-text-in-5-years': 'En 5 a√±os, el ahorro acumulado ser√≠a de',
        'comp-text-these-numbers': 'Estos n√∫meros son reales y est√°n calculados con las tarifas actuales del mercado el√©ctrico espa√±ol',
        'comp-text-competitor-prices': 'Precios de la Competencia',
        'comp-text-drk-indexed': 'DRK INDEXADO',
        'comp-text-drk-fixed': 'DRK FIJO',
        'comp-text-best-market': 'MEJOR OPCI√ìN DEL MERCADO',
        'comp-text-stable-price': 'Precio estable garantizado',
        'comp-text-power': 'POTENCIA',
        'comp-text-energy': 'ENERG√çA',
        'comp-text-peak': 'Punta',
        'comp-text-standard': 'Llano',
        'comp-text-valley': 'Valle',
        'comp-text-detailed-prices': 'Precios Detallados DRK Energ√≠a'
    },
    en: {
        'panel-title': 'DRK Energy',
        'panel-subtitle': 'Smart Solutions',
        'dept1-label': 'Optimization',
        'dept1-title': 'Calculate Your Savings',
        'dept2-label': 'Market',
        'dept2-title': 'Competitor Prices',
        'dept2-coming-soon': 'Coming Soon: Competitor Prices',
        'dept3-label': 'Contact',
        'dept3-title': 'Backoffice Email',
        'dept3-coming-soon': 'Coming Soon: Backoffice Email',
        'dept4-label': 'Benefits',
        'dept4-title': 'Friends Code & Discounts',
        'dept5-label': 'Information',
        'dept5-title': 'News',
        'news-title': 'News',
        'news-subtitle': 'Stay informed with the latest updates',
        'dept4-coming-soon': 'Coming Soon: Friends Code',
        'friends-title': 'üë• DRK Friends Code',
        'friends-subtitle': 'Share energy, share savings',
        'friends-benefit-1-title': 'Refer a business friend',
        'friends-benefit-1-desc': 'You just need to introduce us to a contact who has a company and is willing to share their current energy bill',
        'friends-benefit-2-title': 'Free energy study',
        'friends-benefit-2-desc': 'We will conduct a complete and professional analysis of their consumption at no cost and with no commitment',
        'friends-benefit-3-title': 'Receive your exclusive code',
        'friends-benefit-3-desc': 'As a thank you, we will give you a unique promotional code to share with your 5 friends',
        'friends-benefit-4-title': 'Benefit up to 5 homes',
        'friends-benefit-4-desc': 'Share the special energy and power rate with family, friends or acquaintances you want to help',
        'friends-banner-title': 'üëç Best of all',
        'friends-banner-intro': 'Imagine being able to offer your loved ones an incredible energy rate like this:',
        'friends-banner-code': 'The discount code we send you is applicable to up to 5 different homes. It\'s your golden opportunity for those who matter most to you to truly save significantly on their electricity bill.',
        'friends-conditions-title': 'üìå Important conditions',
        'friends-conditions-intro': 'The company that submits their bill for the energy study has no obligation to contract with us. The analysis is completely free and without commitment. It\'s a way to help your business contact understand their current energy situation while you gain access to this extraordinary promotion.',
        'friends-condition-1': 'Just submit a business bill with active supply',
        'friends-condition-2': 'The code is valid only for up to 5 homes',
        'friends-condition-3': 'Not valid for rates with social exclusion or large families',
        'friends-condition-4': 'Promotion limited in time and available places',
        'friends-condition-5': 'Applicable to new contracts or renewals with promotional code',
        'friends-card-title': 'üíé DRK FRIENDS PLAN',
        'friends-card-subtitle': 'Exclusive rate for referrals',
        'friends-request-button': 'üéÅ I WANT MY CODE - REQUEST FROM DRK ENERGY',
        'friends-form-title': 'üìã FRIEND DATA TO GET CODE',
        'friends-form-friend-data': 'üè¢ FRIEND DATA (recommended company)',
        'friends-form-company-name': 'Friend company name *',
        'friends-form-contact-person': 'Contact person *',
        'friends-form-friend-email': 'Email *',
        'friends-form-friend-phone': 'Phone *',
        'friends-form-comments': 'Optional comments',
        'friends-form-my-data': 'üë§ MY DATA (who requests the code)',
        'friends-form-my-name': 'Name *',
        'friends-form-my-email': 'Email *',
        'friends-form-my-phone': 'Phone *',
        'friends-form-cancel': 'Cancel',
        'friends-form-send': 'üìß Send Request',


        'email-modal-title': 'Backoffice Email',
        'email-modal-subtitle': 'Client Data (optional)',
        'email-label-name': 'Full Name',
        'email-label-email': 'Email',
        'email-label-phone': 'Phone',
        'email-btn-cancel': 'Cancel',
        'email-btn-send': 'Open Email',
        'email-optional-note': 'Fields are optional. You can send the email without filling them.',
        'back-btn': 'Back',
        'comparison-title': 'üìä Price Comparison - Tariff 2.0TD',
        'comparison-subtitle': 'Professional analysis with real Spanish market data',
        'comparison-loading': 'Loading market data...',
        'comp-col-company': 'Company',
        'comp-col-monthly': 'Monthly Cost',
        'comp-col-annual': 'Annual Cost',
        'comp-col-savings': 'Diff. vs Best',
        'comp-chart-title': 'üìà Visual Comparison - Annual Cost',
        'comp-summary-title': 'üí° Why choose the best rate?',
        'comp-benefit-1-title': 'Real Savings',
        'comp-benefit-1-desc': 'Compare updated real market prices',
        'comp-benefit-2-title': 'Transparency',
        'comp-benefit-2-desc': 'Verifiable data updated monthly',
        'comp-benefit-3-title': 'Informed Decision',
        'comp-benefit-3-desc': 'Compare and choose the best option for you',
        'comp-footer-note': '<strong>Methodological note:</strong> Real prices from current public tariffs without VAT. Standard client: 6 kW contracted power, monthly consumption 270 kWh (60 kWh peak, 90 kWh standard, 120 kWh valley). Automatically updated data. Prices may vary according to specific promotions.',
        'comp-stats-companies': 'Companies',
        'comp-stats-analyzed': 'Selected',
        'comp-stats-avg-savings': 'Average Annual Savings',
        'comp-stats-best': 'Best Option',
        'comp-best-badge': 'BEST PRICE',
        'comp-reference': 'Reference',
        'comp-highlight-title': 'Real and Verifiable Savings',
        'comp-highlight-text': 'With the best market rate, a standard client saves significantly compared to more expensive options. These savings are real and calculated with current prices from each company.',
        'comp-client-profile': 'Standard client: 6 kW ‚Ä¢ 270 kWh/month',
        'comp-text-with': 'With',
        'comp-text-client-pays': 'a standard client pays only',
        'comp-text-per-year': 'per year',
        'comp-text-while': 'while with',
        'comp-text-would-pay': 'would pay',
        'comp-text-thats': 'That\'s',
        'comp-text-difference': 'difference',
        'comp-text-pocket': 'that stays in your pocket each year',
        'comp-text-in-5-years': 'In 5 years, the accumulated savings would be',
        'comp-text-these-numbers': 'These numbers are real and calculated with current Spanish electricity market rates',
        'comp-text-competitor-prices': 'Competitor Prices',
        'comp-text-drk-indexed': 'DRK INDEXED',
        'comp-text-drk-fixed': 'DRK FIXED',
        'comp-text-best-market': 'BEST MARKET OPTION',
        'comp-text-stable-price': 'Guaranteed stable price',
        'comp-text-power': 'POWER',
        'comp-text-energy': 'ENERGY',
        'comp-text-peak': 'Peak',
        'comp-text-standard': 'Standard',
        'comp-text-valley': 'Off-peak',
        'comp-text-detailed-prices': 'DRK Energy Detailed Prices'
    },
    pt: {
        'panel-title': 'DRK Energia',
        'panel-subtitle': 'Solu√ß√µes Inteligentes',
        'dept1-label': 'Otimiza√ß√£o',
        'dept1-title': 'Calcule Suas Economias',
        'dept2-label': 'Mercado',
        'dept2-title': 'Pre√ßos da Concorr√™ncia',
        'dept2-coming-soon': 'Em Breve: Pre√ßos da Concorr√™ncia',
        'dept3-label': 'Contato',
        'dept3-title': 'Email Backoffice',
        'dept3-coming-soon': 'Em Breve: Email Backoffice',
        'dept4-label': 'Benef√≠cios',
        'dept4-title': 'C√≥digo Amigos e Descontos',
        'dept5-label': 'Informa√ß√£o',
        'dept5-title': 'Not√≠cias',
        'news-title': 'Not√≠cias',
        'news-subtitle': 'Mantenha-se informado com as √∫ltimas novidades',
        'dept4-coming-soon': 'Em Breve: C√≥digo Amigos',
        'friends-title': 'üë• C√≥digo Amigos DRK',
        'friends-subtitle': 'Compartilhe energia, compartilhe economia',
        'friends-benefit-1-title': 'Apresente um amigo empres√°rio',
        'friends-benefit-1-desc': 'Voc√™ s√≥ precisa nos apresentar um contato que tenha uma empresa e esteja disposto a compartilhar sua conta de energia atual',
        'friends-benefit-2-title': 'Estudo energ√©tico gratuito',
        'friends-benefit-2-desc': 'Realizaremos uma an√°lise completa e profissional de seu consumo sem nenhum custo ou compromisso de contrata√ß√£o',
        'friends-benefit-3-title': 'Receba seu c√≥digo exclusivo',
        'friends-benefit-3-desc': 'Como agradecimento, entregaremos um c√≥digo promocional √∫nico para voc√™ compartilhar com seus 5 amigos',
        'friends-benefit-4-title': 'Beneficie at√© 5 lares',
        'friends-benefit-4-desc': 'Compartilhe a tarifa especial de energia e pot√™ncia com familiares, amigos ou conhecidos que queira ajudar',
        'friends-banner-title': 'üëç O melhor de tudo',
        'friends-banner-intro': 'Imagine poder oferecer aos seus entes queridos uma tarifa energ√©tica t√£o incr√≠vel como esta:',
        'friends-banner-code': 'O c√≥digo de desconto que enviamos √© aplic√°vel a at√© 5 lares diferentes. √â sua oportunidade dourada para que aqueles que mais importam economizem de verdade e de forma significativa na conta de luz.',
        'friends-conditions-title': 'üìå Condi√ß√µes importantes',
        'friends-conditions-intro': 'A empresa que apresentar sua conta para o estudo energ√©tico n√£o tem nenhuma obriga√ß√£o de contratar conosco. A an√°lise √© completamente gratuita e sem compromisso. √â uma forma de ajudar seu contato empresarial a conhecer sua situa√ß√£o energ√©tica atual enquanto voc√™ obt√©m acesso a esta promo√ß√£o extraordin√°ria.',
        'friends-condition-1': 'Basta apresentar uma conta de empresa com fornecimento ativo',
        'friends-condition-2': 'O c√≥digo √© v√°lido apenas para at√© 5 lares',
        'friends-condition-3': 'N√£o v√°lido para tarifas com exclus√£o social ou fam√≠lia numerosa',
        'friends-condition-4': 'Promo√ß√£o limitada em tempo e vagas dispon√≠veis',
        'friends-condition-5': 'Aplic√°vel a novos contratos ou renova√ß√µes com c√≥digo promocional',
        'friends-card-title': 'üíé PLANO AMIGO DRK',
        'friends-card-subtitle': 'Tarifa exclusiva para indicados',
        'friends-request-button': 'üéÅ QUERO MEU C√ìDIGO - SOLICITAR √Ä DRK ENERGY',
        'friends-form-title': 'üìã DADOS DO AMIGO PARA OBTER C√ìDIGO',
        'friends-form-friend-data': 'üè¢ DADOS DO AMIGO (empresa recomendada)',
        'friends-form-company-name': 'Nome da empresa amiga *',
        'friends-form-contact-person': 'Pessoa de contato *',
        'friends-form-friend-email': 'Email *',
        'friends-form-friend-phone': 'Telefone *',
        'friends-form-comments': 'Coment√°rios opcionais',
        'friends-form-my-data': 'üë§ MEUS DADOS (quem solicita o c√≥digo)',
        'friends-form-my-name': 'Nome *',
        'friends-form-my-email': 'Email *',
        'friends-form-my-phone': 'Telefone *',
        'friends-form-cancel': 'Cancelar',
        'friends-form-send': 'üìß Enviar Solicita√ß√£o',


        'email-modal-title': 'Email Backoffice',
        'email-modal-subtitle': 'Dados do Cliente (opcional)',
        'email-label-name': 'Nome Completo',
        'email-label-email': 'Email',
        'email-label-phone': 'Telefone',
        'email-btn-cancel': 'Cancelar',
        'email-btn-send': 'Abrir Email',
        'email-optional-note': 'Os campos s√£o opcionais. Voc√™ pode enviar o email sem preench√™-los.',
        'back-btn': 'Voltar',
        'comparison-title': 'üìä Compara√ß√£o de Pre√ßos - Tarifa 2.0TD',
        'comparison-subtitle': 'An√°lise profissional com dados reais do mercado espanhol',
        'comparison-loading': 'Carregando dados do mercado...',
        'comp-col-company': 'Empresa',
        'comp-col-monthly': 'Custo Mensal',
        'comp-col-annual': 'Custo Anual',
        'comp-col-savings': 'Dif. vs Melhor',
        'comp-chart-title': 'üìà Compara√ß√£o Visual - Custo Anual',
        'comp-summary-title': 'üí° Por que escolher a melhor tarifa?',
        'comp-benefit-1-title': 'Economia Real',
        'comp-benefit-1-desc': 'Compare pre√ßos reais atualizados do mercado',
        'comp-benefit-2-title': 'Transpar√™ncia',
        'comp-benefit-2-desc': 'Dados verific√°veis atualizados mensalmente',
        'comp-benefit-3-title': 'Decis√£o Informada',
        'comp-benefit-3-desc': 'Compare e escolha a melhor op√ß√£o para voc√™',
        'comp-footer-note': '<strong>Nota metodol√≥gica:</strong> Pre√ßos reais de tarifas p√∫blicas vigentes sem IVA. Cliente padr√£o: 6 kW pot√™ncia contratada, consumo mensal 270 kWh (60 kWh ponta, 90 kWh padr√£o, 120 kWh vale). Dados atualizados automaticamente. Os pre√ßos podem variar segundo promo√ß√µes espec√≠ficas.',
        'comp-stats-companies': 'Empresas',
        'comp-stats-analyzed': 'Selecionadas',
        'comp-stats-avg-savings': 'Economia M√©dia Anual',
        'comp-stats-best': 'Melhor Op√ß√£o',
        'comp-best-badge': 'MELHOR PRE√áO',
        'comp-reference': 'Refer√™ncia',
        'comp-highlight-title': 'Economia Real e Verific√°vel',
        'comp-highlight-text': 'Com a melhor tarifa do mercado, um cliente padr√£o economiza significativamente em compara√ß√£o com as op√ß√µes mais caras. Estas economias s√£o reais e calculadas com os pre√ßos atuais de cada empresa.',
        'comp-client-profile': 'Cliente padr√£o: 6 kW ‚Ä¢ 270 kWh/m√™s',
        'comp-text-with': 'Com',
        'comp-text-client-pays': 'um cliente padr√£o paga apenas',
        'comp-text-per-year': 'por ano',
        'comp-text-while': 'enquanto com',
        'comp-text-would-pay': 'pagaria',
        'comp-text-thats': 'S√£o',
        'comp-text-difference': 'de diferen√ßa',
        'comp-text-pocket': 'que permanece no seu bolso a cada ano',
        'comp-text-in-5-years': 'Em 5 anos, a economia acumulada seria de',
        'comp-text-these-numbers': 'Estes n√∫meros s√£o reais e calculados com as tarifas atuais do mercado el√©trico espanhol',
        'comp-text-competitor-prices': 'Pre√ßos da Concorr√™ncia',
        'comp-text-drk-indexed': 'DRK INDEXADO',
        'comp-text-drk-fixed': 'DRK FIXO',
        'comp-text-best-market': 'MELHOR OP√á√ÉO DO MERCADO',
        'comp-text-stable-price': 'Pre√ßo est√°vel garantido',
        'comp-text-power': 'POT√äNCIA',
        'comp-text-energy': 'ENERGIA',
        'comp-text-peak': 'Pico',
        'comp-text-standard': 'Normal',
        'comp-text-valley': 'Vale',
        'comp-text-detailed-prices': 'Pre√ßos Detalhados DRK Energia'
    },
    zh: {
        'panel-title': 'DRK ËÉΩÊ∫ê',
        'panel-subtitle': 'Êô∫ËÉΩËß£ÂÜ≥ÊñπÊ°à',
        'dept1-label': '‰ºòÂåñ',
        'dept1-title': 'ËÆ°ÁÆóÊÇ®ÁöÑËäÇÁúÅ',
        'dept2-label': 'Â∏ÇÂú∫',
        'dept2-title': 'Á´û‰∫âÂØπÊâã‰ª∑Ê†º',
        'dept2-coming-soon': 'Âç≥Â∞ÜÊé®Âá∫ÔºöÁ´û‰∫âÂØπÊâã‰ª∑Ê†º',
        'dept3-label': 'ËÅîÁ≥ª',
        'dept3-title': 'ÂêéÂè∞ÁîµÂ≠êÈÇÆ‰ª∂',
        'dept3-coming-soon': 'Âç≥Â∞ÜÊé®Âá∫ÔºöÂêéÂè∞ÁîµÂ≠êÈÇÆ‰ª∂',
        'dept4-label': '‰ºòÊÉ†',
        'dept4-title': 'ÊúãÂèã‰ª£Á†ÅÂíåÊäòÊâ£',
        'dept5-label': '‰ø°ÊÅØ',
        'dept5-title': 'Êñ∞Èóª',
        'news-title': 'Êñ∞Èóª',
        'news-subtitle': '‰∫ÜËß£ÊúÄÊñ∞Âä®ÊÄÅ',
        'dept4-coming-soon': 'Âç≥Â∞ÜÊé®Âá∫ÔºöÊúãÂèã‰ª£Á†Å',
        'friends-title': 'üë• DRKÊúãÂèã‰ª£Á†Å',
        'friends-subtitle': 'ÂàÜ‰∫´ËÉΩÊ∫êÔºåÂàÜ‰∫´ËäÇÁúÅ',
        'friends-benefit-1-title': 'Êé®Ëçê‰ºÅ‰∏öÊúãÂèã',
        'friends-benefit-1-desc': 'ÊÇ®Âè™ÈúÄ‰ªãÁªç‰∏Ä‰∏™Êã•ÊúâÂÖ¨Âè∏Âπ∂ÊÑøÊÑèÂàÜ‰∫´ÂÖ∂ÂΩìÂâçËÉΩÊ∫êË¥¶ÂçïÁöÑËÅîÁ≥ª‰∫∫',
        'friends-benefit-2-title': 'ÂÖçË¥πËÉΩÊ∫êÁ†îÁ©∂',
        'friends-benefit-2-desc': 'Êàë‰ª¨Â∞ÜÂØπÂÖ∂Ê∂àË¥πËøõË°åÂÆåÊï¥‰∏ì‰∏öÁöÑÂàÜÊûêÔºåÊó†ÈúÄ‰ªª‰ΩïË¥πÁî®ÊàñÊâøËØ∫',
        'friends-benefit-3-title': 'Ëé∑ÂæóÊÇ®ÁöÑ‰∏ìÂ±û‰ª£Á†Å',
        'friends-benefit-3-desc': '‰Ωú‰∏∫ÊÑüË∞¢ÔºåÊàë‰ª¨Â∞Ü‰∏∫ÊÇ®Êèê‰æõ‰∏Ä‰∏™Áã¨ÁâπÁöÑ‰øÉÈîÄ‰ª£Á†ÅÔºå‰æõÊÇ®‰∏é5‰ΩçÊúãÂèãÂàÜ‰∫´',
        'friends-benefit-4-title': 'ÊÉ†Âèä5‰∏™ÂÆ∂Â∫≠',
        'friends-benefit-4-desc': '‰∏éÊÇ®ÊÉ≥Â∏ÆÂä©ÁöÑÂÆ∂‰∫∫„ÄÅÊúãÂèãÊàñÁÜü‰∫∫ÂàÜ‰∫´ÁâπÊÆäÁöÑËÉΩÊ∫êÂíåÁîµÂäõË¥πÁéá',
        'friends-banner-title': 'üëç ÊúÄÊ£íÁöÑÊòØ',
        'friends-banner-intro': 'ÊÉ≥Ë±°‰∏Ä‰∏ãËÉΩÂ§ü‰∏∫ÊÇ®ÊâÄÁà±ÁöÑ‰∫∫Êèê‰æõÂ¶ÇÊ≠§‰ª§‰∫∫Èöæ‰ª•ÁΩÆ‰ø°ÁöÑËÉΩÊ∫êË¥πÁéáÔºö',
        'friends-banner-code': 'Êàë‰ª¨ÂèëÈÄÅÁªôÊÇ®ÁöÑÊäòÊâ£‰ª£Á†ÅÈÄÇÁî®‰∫éÊúÄÂ§ö5‰∏™‰∏çÂêåÁöÑÂÆ∂Â∫≠„ÄÇËøôÊòØÊÇ®ÁöÑÈªÑÈáëÊú∫‰ºöÔºåËÆ©ÊúÄÈáçË¶ÅÁöÑ‰∫∫ÁúüÊ≠£ÊòæËëóËäÇÁúÅÁîµË¥π„ÄÇ',
        'friends-conditions-title': 'üìå ÈáçË¶ÅÊù°‰ª∂',
        'friends-conditions-intro': 'Êèê‰∫§Ë¥¶ÂçïËøõË°åËÉΩÊ∫êÁ†îÁ©∂ÁöÑÂÖ¨Âè∏Ê≤°Êúâ‰πâÂä°‰∏éÊàë‰ª¨Á≠æÁ∫¶„ÄÇÂàÜÊûêÂÆåÂÖ®ÂÖçË¥π‰∏îÊó†ÈúÄÊâøËØ∫„ÄÇËøôÊòØÂ∏ÆÂä©ÊÇ®ÁöÑ‰ºÅ‰∏öËÅîÁ≥ª‰∫∫‰∫ÜËß£ÂÖ∂ÂΩìÂâçËÉΩÊ∫êÁä∂ÂÜµÁöÑ‰∏ÄÁßçÊñπÂºèÔºåÂêåÊó∂ÊÇ®ÂèØ‰ª•Ëé∑ÂæóËøô‰∏ÄÈùûÂá°‰øÉÈîÄÁöÑÊú∫‰ºö„ÄÇ',
        'friends-condition-1': 'Âè™ÈúÄÊèê‰∫§ÊúâÊ¥ªË∑É‰æõÂ∫îÁöÑ‰ºÅ‰∏öË¥¶Âçï',
        'friends-condition-2': '‰ª£Á†Å‰ªÖÈÄÇÁî®‰∫éÊúÄÂ§ö5‰∏™ÂÆ∂Â∫≠',
        'friends-condition-3': '‰∏çÈÄÇÁî®‰∫éÁ§æ‰ºöÊéíÊñ•ÊàñÂ§ßÂÆ∂Â∫≠Ë¥πÁéá',
        'friends-condition-4': '‰øÉÈîÄÂú®Êó∂Èó¥ÂíåÂèØÁî®ÂêçÈ¢ù‰∏äÊúâÈôê',
        'friends-condition-5': 'ÈÄÇÁî®‰∫é‰ΩøÁî®‰øÉÈîÄ‰ª£Á†ÅÁöÑÊñ∞ÂêàÂêåÊàñÁª≠Á∫¶',
        'friends-card-title': 'üíé DRK ÊúãÂèãËÆ°Âàí',
        'friends-card-subtitle': 'Êé®Ëçê‰∏ìÂ±ûË¥πÁéá',
        'friends-request-button': 'üéÅ ÊàëË¶ÅÊàëÁöÑ‰ª£Á†Å - ÂêëDRK ENERGYÁî≥ËØ∑',
        'friends-form-title': 'üìã Ëé∑Âèñ‰ª£Á†ÅÁöÑÊúãÂèãÊï∞ÊçÆ',
        'friends-form-friend-data': 'üè¢ ÊúãÂèãÊï∞ÊçÆÔºàÊé®ËçêÂÖ¨Âè∏Ôºâ',
        'friends-form-company-name': 'ÊúãÂèãÂÖ¨Âè∏ÂêçÁß∞ *',
        'friends-form-contact-person': 'ËÅîÁ≥ª‰∫∫ *',
        'friends-form-friend-email': 'ÁîµÂ≠êÈÇÆ‰ª∂ *',
        'friends-form-friend-phone': 'ÁîµËØù *',
        'friends-form-comments': 'ÂèØÈÄâËØÑËÆ∫',
        'friends-form-my-data': 'üë§ ÊàëÁöÑÊï∞ÊçÆÔºàÁî≥ËØ∑‰ª£Á†ÅËÄÖÔºâ',
        'friends-form-my-name': 'ÂßìÂêç *',
        'friends-form-my-email': 'ÁîµÂ≠êÈÇÆ‰ª∂ *',
        'friends-form-my-phone': 'ÁîµËØù *',
        'friends-form-cancel': 'ÂèñÊ∂à',
        'friends-form-send': 'üìß ÂèëÈÄÅËØ∑Ê±Ç',


        'email-modal-title': 'ÂêéÂè∞ÁîµÂ≠êÈÇÆ‰ª∂',
        'email-modal-subtitle': 'ÂÆ¢Êà∑Êï∞ÊçÆÔºàÂèØÈÄâÔºâ',
        'email-label-name': 'ÂÖ®Âêç',
        'email-label-email': 'ÁîµÂ≠êÈÇÆ‰ª∂',
        'email-label-phone': 'ÁîµËØù',
        'email-btn-cancel': 'ÂèñÊ∂à',
        'email-btn-send': 'ÊâìÂºÄÁîµÂ≠êÈÇÆ‰ª∂',
        'email-optional-note': 'Â≠óÊÆµ‰∏∫ÂèØÈÄâ„ÄÇÊÇ®ÂèØ‰ª•‰∏çÂ°´ÂÜôÂç≥ÂèëÈÄÅÁîµÂ≠êÈÇÆ‰ª∂„ÄÇ',
        'back-btn': 'ËøîÂõû',
        'comparison-title': 'üìä ‰ª∑Ê†ºÊØîËæÉ - 2.0TDË¥πÁéá',
        'comparison-subtitle': '‰ΩøÁî®Ë•øÁè≠ÁâôÂ∏ÇÂú∫ÁúüÂÆûÊï∞ÊçÆÁöÑ‰∏ì‰∏öÂàÜÊûê',
        'comparison-loading': 'Ê≠£Âú®Âä†ËΩΩÂ∏ÇÂú∫Êï∞ÊçÆ...',
        'comp-col-company': 'ÂÖ¨Âè∏',
        'comp-col-monthly': 'ÊúàË¥πÁî®',
        'comp-col-annual': 'Âπ¥Ë¥πÁî®',
        'comp-col-savings': '‰∏éÊúÄ‰Ω≥ÁöÑÂ∑ÆÂºÇ',
        'comp-chart-title': 'üìà ÂèØËßÜÂåñÊØîËæÉ - Âπ¥Ë¥πÁî®',
        'comp-summary-title': 'üí° ‰∏∫‰ªÄ‰πàÈÄâÊã©ÊúÄ‰Ω≥Ë¥πÁéáÔºü',
        'comp-benefit-1-title': 'ÁúüÂÆûËäÇÁúÅ',
        'comp-benefit-1-desc': 'ÊØîËæÉÊõ¥Êñ∞ÁöÑÁúüÂÆûÂ∏ÇÂú∫‰ª∑Ê†º',
        'comp-benefit-2-title': 'ÈÄèÊòéÂ∫¶',
        'comp-benefit-2-desc': 'ÊØèÊúàÊõ¥Êñ∞ÁöÑÂèØÈ™åËØÅÊï∞ÊçÆ',
        'comp-benefit-3-title': 'ÊòéÊô∫ÂÜ≥Á≠ñ',
        'comp-benefit-3-desc': 'ÊØîËæÉÂπ∂ÈÄâÊã©ÊúÄÈÄÇÂêàÊÇ®ÁöÑÈÄâÈ°π',
        'comp-footer-note': '<strong>ÊñπÊ≥ïËØ¥ÊòéÔºö</strong>‰∏çÂê´Â¢ûÂÄºÁ®éÁöÑÂΩìÂâçÂÖ¨ÂÖ±Ë¥πÁéáÁöÑÁúüÂÆû‰ª∑Ê†º„ÄÇÊ†áÂáÜÂÆ¢Êà∑Ôºö6ÂçÉÁì¶ÂêàÂêåÂäüÁéáÔºåÊúàÊ∂àË¥π270ÂçÉÁì¶Êó∂Ôºà60ÂçÉÁì¶Êó∂È´òÂ≥∞Ôºå90ÂçÉÁì¶Êó∂Ê†áÂáÜÔºå120ÂçÉÁì¶Êó∂‰ΩéË∞∑Ôºâ„ÄÇËá™Âä®Êõ¥Êñ∞Êï∞ÊçÆ„ÄÇ‰ª∑Ê†ºÂèØËÉΩÊ†πÊçÆÂÖ∑‰Ωì‰øÉÈîÄËÄåÊúâÊâÄ‰∏çÂêå„ÄÇ',
        'comp-stats-companies': 'ÂÖ¨Âè∏',
        'comp-stats-analyzed': 'Â∑≤ÈÄâÊã©',
        'comp-stats-avg-savings': 'Âπ≥ÂùáÂπ¥ËäÇÁúÅ',
        'comp-stats-best': 'ÊúÄ‰Ω≥ÈÄâÊã©',
        'comp-best-badge': 'ÊúÄ‰Ω≥‰ª∑Ê†º',
        'comp-reference': 'ÂèÇËÄÉ',
        'comp-highlight-title': 'ÁúüÂÆûÂèØÈ™åËØÅÁöÑËäÇÁúÅ',
        'comp-highlight-text': '‰ΩøÁî®Â∏ÇÂú∫‰∏äÊúÄÂ•ΩÁöÑË¥πÁéáÔºåÊ†áÂáÜÂÆ¢Êà∑Áõ∏ÊØîÊõ¥ÊòÇË¥µÁöÑÈÄâÈ°πÂèØËäÇÁúÅÊòæËëóÈáëÈ¢ù„ÄÇËøô‰∫õËäÇÁúÅÊòØÁúüÂÆûÁöÑÔºåÂπ∂‰ΩøÁî®ÊØèÂÆ∂ÂÖ¨Âè∏ÁöÑÂΩìÂâç‰ª∑Ê†ºËÆ°ÁÆó„ÄÇ',
        'comp-client-profile': 'Ê†áÂáÜÂÆ¢Êà∑Ôºö6 kW ‚Ä¢ 270 kWh/Êúà',
        'comp-text-with': '‰ΩøÁî®',
        'comp-text-client-pays': 'Ê†áÂáÜÂÆ¢Êà∑ÊØèÂπ¥Âè™ÈúÄÊîØ‰ªò',
        'comp-text-per-year': 'ÊØèÂπ¥',
        'comp-text-while': 'ËÄå‰ΩøÁî®',
        'comp-text-would-pay': 'ÈúÄË¶ÅÊîØ‰ªò',
        'comp-text-thats': 'ËøôÊòØ',
        'comp-text-difference': 'ÁöÑÂ∑ÆÈ¢ù',
        'comp-text-pocket': 'ÊØèÂπ¥ÁïôÂú®ÊÇ®ÁöÑÂè£Ë¢ãÈáå',
        'comp-text-in-5-years': '5Âπ¥ÂÜÖÔºåÁ¥ØËÆ°ËäÇÁúÅÂ∞ÜËææÂà∞',
        'comp-text-these-numbers': 'Ëøô‰∫õÊï∞Â≠óÊòØÁúüÂÆûÁöÑÔºå‰ΩøÁî®Ë•øÁè≠ÁâôÁîµÂäõÂ∏ÇÂú∫ÁöÑÂΩìÂâçË¥πÁéáËÆ°ÁÆó',
        'comp-text-competitor-prices': 'Á´û‰∫âÂØπÊâã‰ª∑Ê†º',
        'comp-text-drk-indexed': 'DRKÊµÆÂä®',
        'comp-text-drk-fixed': 'DRKÂõ∫ÂÆö',
        'comp-text-best-market': 'Â∏ÇÂú∫ÊúÄ‰Ω≥ÈÄâÊã©',
        'comp-text-stable-price': '‰øùËØÅÁ®≥ÂÆö‰ª∑Ê†º',
        'comp-text-power': 'ÂäüÁéá',
        'comp-text-energy': 'ËÉΩÊ∫ê',
        'comp-text-peak': 'È´òÂ≥∞',
        'comp-text-standard': 'Ê†áÂáÜ',
        'comp-text-valley': '‰ΩéË∞∑',
        'comp-text-detailed-prices': 'DRKËÉΩÊ∫êËØ¶ÁªÜ‰ª∑Ê†º'
    },
    fr: {
        'panel-title': 'DRK √ânergie',
        'panel-subtitle': 'Solutions Intelligentes',
        'dept1-label': 'Optimisation',
        'dept1-title': 'Calculez Vos √âconomies',
        'dept2-label': 'March√©',
        'dept2-title': 'Prix de la Concurrence',
        'dept2-coming-soon': 'Prochainement: Prix de la Concurrence',
        'dept3-label': 'Contact',
        'dept3-title': 'Email Backoffice',
        'dept3-coming-soon': 'Prochainement: Email Backoffice',
        'dept4-label': 'Avantages',
        'dept4-title': 'Code Amis et R√©ductions',
        'dept5-label': 'Information',
        'dept5-title': 'Actualit√©s',
        'news-title': 'Actualit√©s',
        'news-subtitle': 'Restez inform√© avec les derni√®res nouvelles',
        'dept4-coming-soon': 'Prochainement: Code Amis',
        'friends-title': 'üë• Code Amis DRK',
        'friends-subtitle': 'Partagez l\'√©nergie, partagez les √©conomies',
        'friends-benefit-1-title': 'Pr√©sentez un ami entrepreneur',
        'friends-benefit-1-desc': 'Vous devez simplement nous pr√©senter un contact qui a une entreprise et est dispos√© √† partager sa facture √©nerg√©tique actuelle',
        'friends-benefit-2-title': '√âtude √©nerg√©tique gratuite',
        'friends-benefit-2-desc': 'Nous r√©aliserons une analyse compl√®te et professionnelle de sa consommation sans aucun co√ªt ni engagement de contrat',
        'friends-benefit-3-title': 'Recevez votre code exclusif',
        'friends-benefit-3-desc': 'En remerciement, nous vous remettrons un code promotionnel unique pour le partager avec vos 5 amis',
        'friends-benefit-4-title': 'B√©n√©ficiez jusqu\'√† 5 foyers',
        'friends-benefit-4-desc': 'Partagez le tarif sp√©cial en √©nergie et puissance avec la famille, les amis ou les connaissances que vous voulez aider',
        'friends-banner-title': 'üëç Le meilleur de tout',
        'friends-banner-intro': 'Imaginez pouvoir offrir √† vos proches un tarif √©nerg√©tique aussi incroyable que celui-ci:',
        'friends-banner-code': 'Le code de r√©duction que nous vous envoyons est applicable jusqu\'√† 5 foyers diff√©rents. C\'est votre opportunit√© en or pour que ceux qui comptent le plus pour vous √©conomisent vraiment et significativement sur leur facture d\'√©lectricit√©.',
        'friends-conditions-title': 'üìå Conditions importantes',
        'friends-conditions-intro': 'L\'entreprise qui pr√©sente sa facture pour l\'√©tude √©nerg√©tique n\'a aucune obligation de contracter avec nous. L\'analyse est enti√®rement gratuite et sans engagement. C\'est une fa√ßon d\'aider votre contact professionnel √† conna√Ætre sa situation √©nerg√©tique actuelle pendant que vous acc√©dez √† cette promotion extraordinaire.',
        'friends-condition-1': 'Il suffit de pr√©senter une facture d\'entreprise avec fourniture active',
        'friends-condition-2': 'Le code est valable uniquement pour jusqu\'√† 5 foyers',
        'friends-condition-3': 'Non valable pour les tarifs avec exclusion sociale ou famille nombreuse',
        'friends-condition-4': 'Promotion limit√©e dans le temps et places disponibles',
        'friends-condition-5': 'Applicable aux nouveaux contrats ou renouvellements avec code promotionnel',
        'friends-card-title': 'üíé PLAN AMI DRK',
        'friends-card-subtitle': 'Tarif exclusif pour les parrainages',
        'friends-request-button': 'üéÅ JE VEUX MON CODE - DEMANDER √Ä DRK ENERGY',
        'friends-form-title': 'üìã DONN√âES AMI POUR OBTENIR LE CODE',
        'friends-form-friend-data': 'üè¢ DONN√âES DE L\'AMI (entreprise recommand√©e)',
        'friends-form-company-name': 'Nom de l\'entreprise amie *',
        'friends-form-contact-person': 'Personne de contact *',
        'friends-form-friend-email': 'Email *',
        'friends-form-friend-phone': 'T√©l√©phone *',
        'friends-form-comments': 'Commentaires optionnels',
        'friends-form-my-data': 'üë§ MES DONN√âES (qui demande le code)',
        'friends-form-my-name': 'Nom *',
        'friends-form-my-email': 'Email *',
        'friends-form-my-phone': 'T√©l√©phone *',
        'friends-form-cancel': 'Annuler',
        'friends-form-send': 'üìß Envoyer la demande',


        'email-modal-title': 'Email Backoffice',
        'email-modal-subtitle': 'Donn√©es du Client (optionnel)',
        'email-label-name': 'Nom Complet',
        'email-label-email': 'Email',
        'email-label-phone': 'T√©l√©phone',
        'email-btn-cancel': 'Annuler',
        'email-btn-send': 'Ouvrir Email',
        'email-optional-note': 'Les champs sont optionnels. Vous pouvez envoyer l\'email sans les remplir.',
        'back-btn': 'Retour',
        'comparison-title': 'üìä Comparaison de Prix - Tarif 2.0TD',
        'comparison-subtitle': 'Analyse professionnelle avec donn√©es r√©elles du march√© espagnol',
        'comparison-loading': 'Chargement des donn√©es du march√©...',
        'comp-col-company': 'Entreprise',
        'comp-col-monthly': 'Co√ªt Mensuel',
        'comp-col-annual': 'Co√ªt Annuel',
        'comp-col-savings': 'Diff. vs Meilleur',
        'comp-chart-title': 'üìà Comparaison Visuelle - Co√ªt Annuel',
        'comp-summary-title': 'üí° Pourquoi choisir le meilleur tarif?',
        'comp-benefit-1-title': '√âconomies R√©elles',
        'comp-benefit-1-desc': 'Comparez les prix r√©els mis √† jour du march√©',
        'comp-benefit-2-title': 'Transparence',
        'comp-benefit-2-desc': 'Donn√©es v√©rifiables mises √† jour mensuellement',
        'comp-benefit-3-title': 'D√©cision √âclair√©e',
        'comp-benefit-3-desc': 'Comparez et choisissez la meilleure option pour vous',
        'comp-footer-note': '<strong>Note m√©thodologique:</strong> Prix r√©els des tarifs publics en vigueur sans TVA. Client type: 6 kW puissance contract√©e, consommation mensuelle 270 kWh (60 kWh pointe, 90 kWh standard, 120 kWh vall√©e). Donn√©es automatiquement mises √† jour. Les prix peuvent varier selon les promotions sp√©cifiques.',
        'comp-stats-companies': 'Entreprises',
        'comp-stats-analyzed': 'S√©lectionn√©es',
        'comp-stats-avg-savings': '√âconomies Moyennes Annuelles',
        'comp-stats-best': 'Meilleure Option',
        'comp-best-badge': 'MEILLEUR PRIX',
        'comp-reference': 'R√©f√©rence',
        'comp-highlight-title': '√âconomies R√©elles et V√©rifiables',
        'comp-highlight-text': 'Avec le meilleur tarif du march√©, un client type √©conomise significativement par rapport aux options plus ch√®res. Ces √©conomies sont r√©elles et calcul√©es avec les prix actuels de chaque entreprise.',
        'comp-client-profile': 'Client type : 6 kW ‚Ä¢ 270 kWh/mois',
        'comp-text-with': 'Avec',
        'comp-text-client-pays': 'un client type ne paie que',
        'comp-text-per-year': 'par an',
        'comp-text-while': 'tandis qu\'avec',
        'comp-text-would-pay': 'paierait',
        'comp-text-thats': 'C\'est',
        'comp-text-difference': 'de diff√©rence',
        'comp-text-pocket': 'qui reste dans votre poche chaque ann√©e',
        'comp-text-in-5-years': 'En 5 ans, l\'√©conomie cumul√©e serait de',
        'comp-text-these-numbers': 'Ces chiffres sont r√©els et calcul√©s avec les tarifs actuels du march√© √©lectrique espagnol',
        'comp-text-competitor-prices': 'Prix de la Concurrence',
        'comp-text-drk-indexed': 'DRK INDEX√â',
        'comp-text-drk-fixed': 'DRK FIXE',
        'comp-text-best-market': 'MEILLEURE OPTION DU MARCH√â',
        'comp-text-stable-price': 'Prix stable garanti',
        'comp-text-power': 'PUISSANCE',
        'comp-text-energy': '√âNERGIE',
        'comp-text-peak': 'Pointe',
        'comp-text-standard': 'Normal',
        'comp-text-valley': 'Creuse',
        'comp-text-detailed-prices': 'Prix D√©taill√©s DRK √ânergie'
    }
};

let currentPanelLanguage = 'es';

function getPanelTranslation(key) {
    return panelTranslations[currentPanelLanguage][key] || panelTranslations['es'][key];
}

function translatePanel() {
    const elements = document.querySelectorAll('[data-translate]');
    elements.forEach(element => {
        const key = element.getAttribute('data-translate');
        const translation = getPanelTranslation(key);
        if (translation) {
            element.textContent = translation;
        }
    });
}

function changePanelLanguage(lang) {
    currentPanelLanguage = lang;
    translatePanel();
    translateComparisonTexts(); // Traducir textos de la comparativa
    
    // Guardar idioma para cuando entre a la calculadora
    localStorage.setItem('selectedLanguage', lang);
    
    console.log('üåç Idioma del panel cambiado a:', lang);
    console.log('‚úÖ El idioma se aplicar√° autom√°ticamente en la calculadora');
}

// Cargar idioma guardado al inicio
document.addEventListener('DOMContentLoaded', function() {
    const savedLang = localStorage.getItem('selectedLanguage') || 'es';
    currentPanelLanguage = savedLang;
    document.getElementById('panel-language-selector').value = savedLang;
    translatePanel();
    translateComparisonTexts(); // Traducir textos de comparativa si hay
});

// ========== NAVEGACI√ìN ENTRE PANEL Y CALCULADORA ==========
function showCalculator() {
    document.body.classList.add('showing-calculator');
    window.scrollTo(0, 0);
    
    // Ocultar el selector de idiomas de la calculadora (ya se eligi√≥ en el panel)
    const calcLangSelector = document.getElementById('calculator-language-selector');
    if (calcLangSelector) {
        calcLangSelector.style.display = 'none';
    }
    
    // FORZAR el cambio de idioma cada vez que se muestra la calculadora
    setTimeout(() => {
        const savedLang = localStorage.getItem('selectedLanguage') || 'es';
        
        console.log('üîÑ Aplicando idioma:', savedLang);
        
        // Actualizar el selector oculto primero
        const calcSelector = document.getElementById('language-selector');
        if (calcSelector) {
            calcSelector.value = savedLang;
        }
        
        // FORZAR cambio de idioma en la calculadora (sin skipReload)
        if (window.LANG && typeof window.LANG.change === 'function') {
            window.LANG.change(savedLang, false); // false = NO skip reload, fuerza cambio
            console.log('‚úÖ Idioma FORZADO en calculadora:', savedLang);
        }
        
        // Precargar tarifas autom√°ticamente en segundo plano
        if (typeof fetchTariffsFromSheet === 'function' && typeof currentTariffs !== 'undefined') {
            if (currentTariffs['2.0TD'] && currentTariffs['2.0TD'].length === 0) {
                console.log('üìä Precargando tarifas 2.0TD en segundo plano...');
                fetchTariffsFromSheet('2.0TD').then(() => {
                    console.log('‚úÖ Tarifas 2.0TD precargadas exitosamente');
                }).catch(err => {
                    console.error('‚ö†Ô∏è Error precargando tarifas:', err);
                });
            }
        }
        
        // Doble verificaci√≥n: volver a traducir despu√©s de un momento
        setTimeout(() => {
            if (window.LANG && typeof window.LANG.retranslate === 'function') {
                window.LANG.retranslate();
                console.log('‚úÖ Traducci√≥n refrescada');
            }
        }, 200);
        
    }, 150);
}

function showPanel() {
    document.body.classList.remove('showing-calculator');
    document.body.classList.remove('showing-comparison');
    window.scrollTo(0, 0);
}

function showPanelFromComparison() {
    document.body.classList.remove('showing-comparison');
    window.scrollTo(0, 0);
}

// ========== FRIENDS CODE SECTION ==========
async function showFriendsCode() {
    document.getElementById('panel-view').style.display = 'none';
    document.getElementById('friends-code-view').style.display = 'block';
    window.scrollTo(0, 0);
    
    // Traducir la pantalla
    translatePanel();
    
    // Cargar datos del PLAN AMIGO desde Google Sheets (Hoja 1)
    await loadPlanAmigoData();
    
    // Cargar textos din√°micos desde Google Sheets (Hoja 2)
    await loadFriendsTexts();
}

function hideFriendsCode() {
    document.getElementById('friends-code-view').style.display = 'none';
    document.getElementById('panel-view').style.display = 'block';
    window.scrollTo(0, 0);
}

// ========== FUNCIONES DE NOTICIAS ==========
async function showNews() {
    document.getElementById('panel-view').style.display = 'none';
    document.getElementById('news-view').style.display = 'block';
    window.scrollTo(0, 0);
    
    // Traducir la pantalla
    translatePanel();
    
    // Cargar noticias desde Google Sheets
    await loadNews();
}

function hideNews() {
    document.getElementById('news-view').style.display = 'none';
    document.getElementById('panel-view').style.display = 'block';
    window.scrollTo(0, 0);
}

async function loadNews() {
    const SHEET_ID = '1kLfQOZnTsBJ8lRXA0ab5RXk-QM3VeSRkDQsatL3-tVk';
    const GID = 632183598; // Hoja de noticias
    const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;
    
    console.log('üì∞ Cargando noticias desde Google Sheets...');
    console.log(`üì° URL: ${CSV_URL}`);
    
    const newsContainer = document.getElementById('news-container');
    const newsLoading = document.getElementById('news-loading');
    const newsEmpty = document.getElementById('news-empty');
    
    // Mostrar loading
    newsLoading.style.display = 'block';
    newsContainer.style.display = 'none';
    newsEmpty.style.display = 'none';
    
    // Funci√≥n para parsear CSV
    function parseCSVLine(line, delimiter = ',') {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            const nextChar = line[i + 1];
            
            if (char === '"') {
                if (inQuotes && nextChar === '"') {
                    current += '"';
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === delimiter && !inQuotes) {
                result.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        result.push(current.trim());
        return result;
    }
    
    try {
        const response = await fetch(CSV_URL);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const csvText = await response.text();
        console.log('üìÑ CSV recibido (primeras 200 chars):', csvText.substring(0, 200));
        
        const lines = csvText.split('\n').filter(line => line.trim().length > 0);
        console.log(`üìä Total de l√≠neas: ${lines.length}`);
        
        if (lines.length < 1) {
            console.warn('‚ö†Ô∏è No hay noticias en la hoja');
            newsLoading.style.display = 'none';
            newsEmpty.style.display = 'block';
            return;
        }
        
        // Detectar delimitador
        const delimiter = lines[0].includes(';') ? ';' : ',';
        console.log(`üîç Delimitador detectado: ${delimiter === ';' ? 'punto y coma (;)' : 'coma (,)'}`);
        
        // Parsear todas las l√≠neas
        const allRows = lines.map(line => parseCSVLine(line, delimiter));
        
        // Buscar la columna A (√≠ndice 0)
        const noticias = [];
        let startRow = 0;
        
        // Detectar si la primera fila es encabezado
        if (allRows[0][0] && (allRows[0][0].toLowerCase().includes('noticia') || allRows[0][0].toLowerCase().includes('titulo') || allRows[0][0].length < 20)) {
            startRow = 1; // Saltar encabezado
            console.log('üìã Primera fila detectada como encabezado, saltando...');
        }
        
        // Extraer noticias de la columna A
        for (let i = startRow; i < allRows.length; i++) {
            const noticiaText = allRows[i][0] ? allRows[i][0].replace(/"/g, '').trim() : '';
            
            if (noticiaText && noticiaText.length > 10) {
                noticias.push(noticiaText);
                console.log(`‚úÖ Noticia ${i + 1}: ${noticiaText.substring(0, 50)}...`);
            }
        }
        
        console.log(`üéØ Total de noticias encontradas: ${noticias.length}`);
        
        if (noticias.length === 0) {
            newsLoading.style.display = 'none';
            newsEmpty.style.display = 'block';
            return;
        }
        
        // Renderizar noticias
        let noticiasHTML = '';
        
        noticias.forEach((noticia, index) => {
            noticiasHTML += `
                <div style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border: 2px solid rgba(37, 150, 190, 0.3); border-radius: 1rem; padding: 2rem; transition: all 0.3s; cursor: pointer;" onmouseover="this.style.borderColor='rgba(37, 150, 190, 0.8)'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 40px rgba(37, 150, 190, 0.3)';" onmouseout="this.style.borderColor='rgba(37, 150, 190, 0.3)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="display: flex; align-items: start; gap: 1.5rem;">
                        <!-- N√∫mero de noticia -->
                        <div style="flex-shrink: 0; width: 50px; height: 50px; background: linear-gradient(135deg, #2596be 0%, #1e7a9e 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 800; color: white; box-shadow: 0 4px 12px rgba(37, 150, 190, 0.4);">
                            ${index + 1}
                        </div>
                        
                        <!-- Contenido de la noticia -->
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <i class="fas fa-newspaper" style="color: #fbbf24; font-size: 1.25rem;"></i>
                                <span style="color: #94a3b8; font-size: 0.875rem; font-weight: 600;">
                                    ${new Date().toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' })}
                                </span>
                            </div>
                            <p style="color: white; font-size: 1.1rem; line-height: 1.8; margin: 0;">
                                ${noticia}
                            </p>
                        </div>
                    </div>
                </div>
            `;
        });
        
        newsContainer.innerHTML = noticiasHTML;
        newsLoading.style.display = 'none';
        newsContainer.style.display = 'grid';
        
        console.log('‚úÖ Noticias cargadas y renderizadas correctamente');
        
    } catch (error) {
        console.error('‚ùå Error cargando noticias:', error);
        newsLoading.style.display = 'none';
        newsEmpty.style.display = 'block';
        newsEmpty.innerHTML = `
            <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: #ef4444; margin-bottom: 1rem;"></i>
            <p style="color: #94a3b8; font-size: 1.25rem;">Error al cargar las noticias</p>
            <p style="color: #64748b; font-size: 0.875rem; margin-top: 0.5rem;">Por favor, verifica que la hoja de Google Sheets sea p√∫blica</p>
        `;
    }
}

// Cargar datos del PLAN AMIGO desde Google Sheets
async function loadPlanAmigoData() {
    const SHEET_ID = '1kLfQOZnTsBJ8lRXA0ab5RXk-QM3VeSRkDQsatL3-tVk';
    const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv`;
    
    console.log('üì• Cargando datos del PLAN AMIGO...');
    
    // Funci√≥n para parsear CSV correctamente (maneja comillas y diferentes delimitadores)
    function parseCSVLine(line, delimiter = ',') {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            const nextChar = line[i + 1];
            
            if (char === '"') {
                if (inQuotes && nextChar === '"') {
                    current += '"';
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === delimiter && !inQuotes) {
                result.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        result.push(current.trim());
        return result;
    }
    
    // Funci√≥n para convertir n√∫mero europeo a JS
    const parseEuropeanNumber = (str) => {
        if (!str || str.trim() === '') return 0;
        // Eliminar comillas si las hay
        let cleaned = str.replace(/"/g, '').trim();
        // Reemplazar coma por punto
        cleaned = cleaned.replace(',', '.');
        const num = parseFloat(cleaned);
        return isNaN(num) ? 0 : num;
    };
    
    try {
        const response = await fetch(CSV_URL);
        const csvText = await response.text();
        
        console.log('üìÑ CSV recibido (primeras 300 chars):', csvText.substring(0, 300));
        
        const lines = csvText.split('\n');
        
        // Detectar delimitador mirando la primera l√≠nea
        const firstLine = lines[0];
        const delimiter = firstLine.includes(';') ? ';' : ',';
        console.log('üîç Delimitador detectado:', delimiter === ';' ? 'punto y coma' : 'coma');
        
        // Parsear encabezados
        const headers = parseCSVLine(lines[0], delimiter);
        console.log('üìã Encabezados:', headers);
        
        // Buscar la fila con "DRK PLAN AMIGO"
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            const values = parseCSVLine(line, delimiter);
            
            // Buscar "DRK PLAN AMIGO" en la columna description (√≠ndice 1)
            if (values[1] && values[1].includes('DRK PLAN AMIGO')) {
                console.log('‚úÖ Fila encontrada completa:', values);
                
                // Seg√∫n tu imagen de Google Sheets:
                // Columna A (0): name = "DRK"
                // Columna B (1): description = "DRK PLAN AMIGO"
                // Columna C (2): p1_price = "0,099"
                // Columna D (3): p2_price = "0,099"
                // Columna E (4): p3_price = "0,099"
                // Columna F (5): p_potencia_1 = "36,135"
                // Columna G (6): p_potencia_2 = "36,135"
                
                const p1Price = parseEuropeanNumber(values[2]);
                const p2Price = parseEuropeanNumber(values[3]);
                const p3Price = parseEuropeanNumber(values[4]);
                const pPotencia1 = parseEuropeanNumber(values[5]);
                const pPotencia2 = parseEuropeanNumber(values[6]);
                
                console.log('üìä Valores parseados correctamente:', {
                    'p1_price (Punta)': p1Price,
                    'p2_price (Llano)': p2Price,
                    'p3_price (Valle)': p3Price,
                    'p_potencia_1 (P1)': pPotencia1,
                    'p_potencia_2 (P2)': pPotencia2
                });
                
                // Actualizar UI
                document.getElementById('plan-amigo-p1-price').textContent = p1Price.toFixed(4);
                document.getElementById('plan-amigo-p2-price').textContent = p2Price.toFixed(4);
                document.getElementById('plan-amigo-p3-price').textContent = p3Price.toFixed(4);
                document.getElementById('plan-amigo-p-potencia-1').textContent = pPotencia1.toFixed(3);
                document.getElementById('plan-amigo-p-potencia-2').textContent = pPotencia2.toFixed(3);
                
                console.log('‚úÖ UI actualizada exitosamente');
                return;
            }
        }
        
        console.warn('‚ö†Ô∏è No se encontr√≥ "DRK PLAN AMIGO" en la columna description');
        
    } catch (error) {
        console.error('‚ùå Error cargando datos del PLAN AMIGO:', error);
        // Valores correctos por defecto
        document.getElementById('plan-amigo-p1-price').textContent = '0.0990';
        document.getElementById('plan-amigo-p2-price').textContent = '0.0990';
        document.getElementById('plan-amigo-p3-price').textContent = '0.0990';
        document.getElementById('plan-amigo-p-potencia-1').textContent = '36.135';
        document.getElementById('plan-amigo-p-potencia-2').textContent = '36.135';
    }
}

// ========== CARGAR TEXTOS DIN√ÅMICOS DESDE HOJA 2 ==========
async function loadFriendsTexts() {
    const SHEET_ID = '1kLfQOZnTsBJ8lRXA0ab5RXk-QM3VeSRkDQsatL3-tVk';
    
    console.log('üì• Cargando textos din√°micos desde Hoja 2...');
    console.log('üí° IMPORTANTE: Abre la consola (F12) para ver los logs detallados');
    
    // Funci√≥n para parsear CSV correctamente
    function parseCSVLine(line, delimiter = ',') {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            const nextChar = line[i + 1];
            
            if (char === '"') {
                if (inQuotes && nextChar === '"') {
                    current += '"';
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === delimiter && !inQuotes) {
                result.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        result.push(current.trim());
        return result;
    }
    
    // Probar m√∫ltiples gids (0, 1, 2, 3) para encontrar la Hoja 2
    // gid=514707142 es tu Hoja 2 (obtenido de la URL)
    const gidsToTry = [514707142, 0, 1, 2, 3]; // Prueba primero el correcto, luego los dem√°s por si acaso
    
    for (const gid of gidsToTry) {
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`;
        
        console.log(`\nüîç Probando gid=${gid}...`);
        console.log(`üì° URL: ${CSV_URL}`);
        
        try {
            const response = await fetch(CSV_URL);
            
            if (!response.ok) {
                console.log(`‚ùå gid=${gid} fall√≥: ${response.status} ${response.statusText}`);
                continue;
            }
            
            const csvText = await response.text();
            
            console.log(`üìÑ CSV recibido (primeras 300 chars):\n${csvText.substring(0, 300)}`);
            
            const lines = csvText.split('\n').filter(line => line.trim().length > 0);
            
            if (lines.length < 2) {
                console.log(`‚ö†Ô∏è gid=${gid}: No hay suficientes l√≠neas (solo ${lines.length})`);
                continue;
            }
            
            // Detectar delimitador
            const delimiter = lines[0].includes(';') ? ';' : ',';
            console.log(`üîç Delimitador detectado: ${delimiter === ';' ? 'punto y coma (;)' : 'coma (,)'}`);
            
            // Parsear todas las l√≠neas
            const allRows = lines.map(line => parseCSVLine(line, delimiter));
            
            console.log(`üìä Total de filas parseadas: ${allRows.length}`);
            
            // Buscar la fila con encabezados "Texto_comercial" o datos v√°lidos
            let headerRow = -1;
            let dataRow = -1;
            
            for (let i = 0; i < allRows.length; i++) {
                const row = allRows[i];
                console.log(`Fila ${i + 1}:`, row);
                
                // Verificar si es fila de encabezados
                if (row[0] && row[0].toLowerCase().includes('texto') || 
                    row[1] && row[1].toLowerCase().includes('condiciones')) {
                    headerRow = i;
                    console.log(`‚úÖ Encontrados encabezados en fila ${i + 1}`);
                }
                
                // Verificar si es fila de datos (texto largo en columnas)
                if (row[0] && row[0].length > 20 && row[1] && row[1].length > 20) {
                    dataRow = i;
                    console.log(`‚úÖ Encontrados datos en fila ${i + 1}`);
                }
            }
            
            // Si encontramos datos, usarlos
            if (dataRow >= 0) {
                const dataLine = allRows[dataRow];
                
                // Columna A: Texto comercial
                const textoComercial = (dataLine[0] || '').replace(/"/g, '');
                
                // Columna B: P√°rrafo de condiciones
                const condicionesIntro = (dataLine[1] || '').replace(/"/g, '');
                
                // Columna C: Los 5 puntos (pueden estar separados por ; o por saltos de l√≠nea)
                let condicionesRaw = (dataLine[2] || '').replace(/"/g, '');
                
                // Si est√° cortado, intentar buscar en las siguientes celdas
                if (dataLine.length > 3) {
                    // Puede que las condiciones est√©n en m√∫ltiples celdas
                    condicionesRaw = dataLine.slice(2).join(';');
                }
                
                const condicionesPuntos = condicionesRaw
                    .split(/[;\n]/)
                    .map(c => c.trim())
                    .filter(c => c.length > 5);
                
                console.log('\nüéØ TEXTOS ENCONTRADOS:');
                console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                console.log('1Ô∏è‚É£ Texto Comercial:');
                console.log(textoComercial.substring(0, 100) + '...');
                console.log('\n2Ô∏è‚É£ Condiciones Intro:');
                console.log(condicionesIntro.substring(0, 100) + '...');
                console.log('\n3Ô∏è‚É£ Condiciones Puntos:');
                condicionesPuntos.forEach((punto, idx) => {
                    console.log(`   ${idx + 1}. ${punto.substring(0, 50)}...`);
                });
                console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n');
                
                // Validar que tenemos datos
                if (!textoComercial || textoComercial.length < 10) {
                    console.log(`‚ö†Ô∏è gid=${gid}: Texto comercial muy corto o vac√≠o`);
                    continue;
                }
                
                // GUARDAR EN EL OBJETO DE TRADUCCIONES (espa√±ol)
                console.log('üíæ Guardando textos en las traducciones de espa√±ol...');
                
                // Actualizar las traducciones de espa√±ol con los textos de Google Sheets
                if (typeof translations !== 'undefined' && translations['es']) {
                    translations['es']['friends-banner-code'] = textoComercial;
                    translations['es']['friends-conditions-intro'] = condicionesIntro;
                    
                    for (let i = 0; i < Math.min(5, condicionesPuntos.length); i++) {
                        if (condicionesPuntos[i]) {
                            translations['es'][`friends-condition-${i + 1}`] = condicionesPuntos[i];
                        }
                    }
                    
                    console.log('‚úÖ Traducciones de espa√±ol actualizadas con datos de Google Sheets');
                } else {
                    console.warn('‚ö†Ô∏è Objeto de traducciones no disponible');
                }
                
                // APLICAR TRADUCCI√ìN SEG√öN EL IDIOMA ACTUAL
                // Esto asegura que si el usuario est√° en otro idioma, se mantengan las traducciones
                console.log('üåç Aplicando traducciones seg√∫n idioma actual...');
                translatePanel();
                
                let updates = 7; // 1 banner + 1 intro + 5 condiciones
                
                if (updates > 0) {
                    console.log(`\nüéâ ¬°√âXITO! Se actualizaron ${updates} elementos con gid=${gid}`);
                    console.log('‚úÖ Todos los textos din√°micos cargados correctamente\n');
                    return; // √âxito, salir de la funci√≥n
                } else {
                    console.log(`‚ö†Ô∏è gid=${gid}: No se pudo actualizar ning√∫n elemento`);
                }
                
            } else {
                console.log(`‚ö†Ô∏è gid=${gid}: No se encontraron datos v√°lidos en esta hoja`);
            }
            
        } catch (error) {
            console.log(`‚ùå Error con gid=${gid}:`, error.message);
        }
    }
    
    // Si llegamos aqu√≠, ning√∫n gid funcion√≥
    console.error('\n‚ùå ERROR CR√çTICO: No se pudo cargar la Hoja 2 con ning√∫n gid');
    console.error('üîß SOLUCIONES:');
    console.error('1. Verifica que la hoja sea P√öBLICA (Compartir > Cualquier persona con el enlace)');
    console.error('2. Abre tu Google Sheet y mira la URL cuando est√©s en la Hoja 2');
    console.error('3. Busca "#gid=XXXXX" en la URL y anota ese n√∫mero');
    console.error('4. Edita el c√≥digo y cambia la l√≠nea 22960 con ese gid\n');
}

// ========== COMPARATIVA DE PRECIOS CON DATOS REALES ==========
async function showComparison() {
    document.body.classList.add('showing-comparison');
    window.scrollTo(0, 0);
    
    // Traducir la pantalla de comparaci√≥n
    translatePanel();
    
    // Mostrar loading
    document.getElementById('comparison-loading').style.display = 'block';
    document.getElementById('comparison-stats').style.display = 'none';
    document.getElementById('comparison-table-container').style.display = 'none';
    document.getElementById('comparison-chart').parentElement.style.display = 'none';
    
    // Verificar si las tarifas est√°n cargadas
    if (typeof currentTariffs === 'undefined' || !currentTariffs['2.0TD'] || currentTariffs['2.0TD'].length === 0) {
        console.log('‚è≥ Tarifas no cargadas, cargando...');
        
        // Cargar tarifas primero
        if (typeof fetchTariffsFromSheet === 'function') {
            try {
                await fetchTariffsFromSheet('2.0TD');
                console.log('‚úÖ Tarifas cargadas para comparaci√≥n');
                
                // Esperar un momento y luego generar la comparaci√≥n
                setTimeout(() => generateComparison(), 500);
            } catch (err) {
                console.error('‚ùå Error cargando tarifas:', err);
                document.getElementById('comparison-loading').innerHTML = '<p style="color: #ef4444;">Error al cargar las tarifas. Por favor, intenta de nuevo.</p>';
            }
        }
    } else {
        // Tarifas ya cargadas, generar comparaci√≥n directamente
        setTimeout(() => generateComparison(), 300);
    }
}

function generateComparison() {
    console.log('üìä Generando comparaci√≥n con datos reales...');
    
    // Cliente tipo para la comparaci√≥n
    const clienteTipo = {
        potencia_p1_kw: 6,       // P1: 6 kW
        potencia_p2_kw: 6,       // P2: 6 kW (para 2.0TD solo se usa P1 y P2)
        consumo_punta: 60,       // 60 kWh en punta
        consumo_llano: 90,       // 90 kWh en llano
        consumo_valle: 120,      // 120 kWh en valle
        dias_facturados: 30,     // Mes completo
        importe_total: 70        // Factura original estimada
    };
    
    // Obtener todas las tarifas 2.0TD
    const tarifas = currentTariffs['2.0TD'] || [];
    
    if (tarifas.length === 0) {
        document.getElementById('comparison-loading').innerHTML = '<p style="color: #ef4444;">No hay tarifas disponibles para comparar.</p>';
        return;
    }
    
    console.log(`üìã ${tarifas.length} tarifas totales en Google Sheets`);
    
    // Calcular coste para TODAS las tarifas
    const todosResultados = tarifas.map(tarifa => {
        try {
            const resultado = calculateTariffCost(tarifa, clienteTipo, '2.0TD');
            const nombreComercializadora = (tarifa.comercializadora || tarifa.name || 'Sin nombre').trim();
            const descNormalizado = (tarifa.description || '').toUpperCase().trim();
            
            // CR√çTICO: Calcular anual EXPL√çCITAMENTE desde mensual
            const costeMensual = Number(resultado.totalPeriod);
            const costeAnual = Number(resultado.totalAnnual);
            
            // Crear objeto con valores expl√≠citos para evitar referencias
            const nuevoObjeto = {
                comercializadora: nombreComercializadora,
                costeMensual: costeMensual,
                costeAnual: costeAnual,
                resultado: resultado,
                tarifa: tarifa,
                nombreOriginal: nombreComercializadora,
                descripcion: tarifa.description || '',
                nombreNormalizado: nombreComercializadora.toUpperCase().replace(/\s+/g, ' ').trim(),
                descripcionNormalizada: descNormalizado
            };
            
            // DEBUG EXTREMO: Verificar que los valores no cambien
            if (nombreComercializadora.includes('TARIFA LIBRE') || nombreComercializadora.includes('PLAN ESPECIAL')) {
                console.log(`üîç DEBUG EXTREMO ${nombreComercializadora}:`);
                console.log(`  resultado.totalPeriod = ${resultado.totalPeriod}`);
                console.log(`  resultado.totalAnnual = ${resultado.totalAnnual}`);
                console.log(`  costeMensual = ${costeMensual}`);
                console.log(`  costeAnual = ${costeAnual}`);
                console.log(`  nuevoObjeto.costeMensual = ${nuevoObjeto.costeMensual}`);
                console.log(`  nuevoObjeto.costeAnual = ${nuevoObjeto.costeAnual}`);
            }
            
            console.log(`DEBUG CREACI√ìN: ${nombreComercializadora} -> Mensual=${costeMensual.toFixed(2)}‚Ç¨, Anual=${costeAnual.toFixed(2)}‚Ç¨`);
            
            return nuevoObjeto;
        } catch (err) {
            console.error('Error calculando tarifa:', tarifa, err);
            return null;
        }
    }).filter(r => r !== null);
    
    console.log(`‚úÖ ${todosResultados.length} tarifas calculadas correctamente`);
    
    // DEBUG: Mostrar algunos ejemplos
    console.log('DEBUG - Primeras 5 tarifas calculadas:');
    todosResultados.slice(0, 5).forEach(r => {
        console.log(`  ${r.comercializadora}: Mensual=${r.costeMensual.toFixed(2)}‚Ç¨, Anual=${r.costeAnual.toFixed(2)}‚Ç¨`);
    });
    
    // PASO 1: Buscar TODAS las DRK INDEX y seleccionar LA M√ÅS BARATA
    const todasDRKIndex = todosResultados.filter(r => {
        const esDRK = r.nombreNormalizado.includes('DRK');
        const noEsFijo = !r.descripcionNormalizada.includes('FIJO') && !r.descripcionNormalizada.includes('FIX');
        const noEsMeta = !r.descripcionNormalizada.includes('META');
        return esDRK && noEsFijo && noEsMeta;
    });
    
    console.log(`üîç Encontradas ${todasDRKIndex.length} tarifas DRK INDEX`);
    todasDRKIndex.forEach(t => console.log(`  - ${t.descripcion}: ${t.costeAnual.toFixed(2)}‚Ç¨/a√±o`));
    
    // Ordenar y tomar la m√°s barata
    todasDRKIndex.sort((a, b) => a.costeAnual - b.costeAnual);
    const mejorDRKIndex = todasDRKIndex[0];
    
    if (mejorDRKIndex) {
        console.log(`‚úÖ MEJOR DRK INDEX seleccionada: ${mejorDRKIndex.descripcion} - ${mejorDRKIndex.costeAnual.toFixed(2)}‚Ç¨/a√±o`);
    }
    
    // PASO 2: Buscar TODAS las DRK FIJO y seleccionar LA M√ÅS BARATA
    const todasDRKFijo = todosResultados.filter(r => {
        const esDRK = r.nombreNormalizado.includes('DRK');
        const esFijo = r.descripcionNormalizada.includes('FIJO') || r.descripcionNormalizada.includes('FIX');
        const noEsMeta = !r.descripcionNormalizada.includes('META');
        return esDRK && esFijo && noEsMeta;
    });
    
    console.log(`üîç Encontradas ${todasDRKFijo.length} tarifas DRK FIJO`);
    todasDRKFijo.forEach(t => console.log(`  - ${t.descripcion}: ${t.costeAnual.toFixed(2)}‚Ç¨/a√±o`));
    
    // Ordenar y tomar la m√°s barata
    todasDRKFijo.sort((a, b) => a.costeAnual - b.costeAnual);
    const mejorDRKFijo = todasDRKFijo[0];
    
    if (mejorDRKFijo) {
        console.log(`‚úÖ MEJOR DRK FIJO seleccionada: ${mejorDRKFijo.descripcion} - ${mejorDRKFijo.costeAnual.toFixed(2)}‚Ç¨/a√±o`);
    }
    
    // PASO 3: A√±adir las 2 DRK y ORDENARLAS POR PRECIO REAL
    let drkTarifas = [];
    
    // Crear COPIAS PROFUNDAS de las DRK para evitar referencias compartidas
    if (mejorDRKIndex) {
        drkTarifas.push({
            comercializadora: mejorDRKIndex.comercializadora,
            costeMensual: Number(mejorDRKIndex.costeMensual),
            costeAnual: Number(mejorDRKIndex.costeAnual),
            resultado: mejorDRKIndex.resultado,
            tarifa: mejorDRKIndex.tarifa,
            nombreOriginal: mejorDRKIndex.nombreOriginal,
            descripcion: mejorDRKIndex.descripcion,
            nombreNormalizado: mejorDRKIndex.nombreNormalizado,
            descripcionNormalizada: mejorDRKIndex.descripcionNormalizada
        });
    }
    
    if (mejorDRKFijo) {
        drkTarifas.push({
            comercializadora: mejorDRKFijo.comercializadora,
            costeMensual: Number(mejorDRKFijo.costeMensual),
            costeAnual: Number(mejorDRKFijo.costeAnual),
            resultado: mejorDRKFijo.resultado,
            tarifa: mejorDRKFijo.tarifa,
            nombreOriginal: mejorDRKFijo.nombreOriginal,
            descripcion: mejorDRKFijo.descripcion,
            nombreNormalizado: mejorDRKFijo.nombreNormalizado,
            descripcionNormalizada: mejorDRKFijo.descripcionNormalizada
        });
    }
    
    // IMPORTANTE: Ordenar por precio real (la m√°s barata primero)
    drkTarifas.sort((a, b) => a.costeAnual - b.costeAnual);
    
    console.log('üìã Tarifas DRK en orden de precio:');
    drkTarifas.forEach((t, i) => {
        console.log(`  ${i+1}¬∫: ${t.descripcion} - ${t.costeAnual.toFixed(2)}‚Ç¨/a√±o`);
    });
    
    // PASO 4: Buscar MEJOR tarifa de cada comercializadora GRANDE (NO-DRK)
    const comercializadorasObjetivo = [
        { keywords: ['ENDESA'], nombre: 'Endesa' },
        { keywords: ['IBERDROLA'], nombre: 'Iberdrola' },
        { keywords: ['NATURGY'], nombre: 'Naturgy' },
        { keywords: ['REPSOL'], nombre: 'Repsol' },
        { keywords: ['TOTAL', 'TOTALENERGIES'], nombre: 'TotalEnergies' },
        { keywords: ['CHC'], nombre: 'CHC Energ√≠a' }
    ];
    
    let otrasComercializadoras = [];
    
    for (const comercialObj of comercializadorasObjetivo) {
        // Filtrar TODAS las tarifas de esta comercializadora (excluyendo DRK)
        // Buscar en NOMBRE y DESCRIPCI√ìN
        const tarifasComercial = todosResultados.filter(r => {
            const noDRK = !r.nombreNormalizado.includes('DRK');
            const coincideNombre = comercialObj.keywords.some(keyword => r.nombreNormalizado.includes(keyword));
            const coincideDesc = comercialObj.keywords.some(keyword => r.descripcionNormalizada.includes(keyword));
            return noDRK && (coincideNombre || coincideDesc);
        });
        
        if (tarifasComercial.length > 0) {
            // Ordenar por coste y tomar SOLO la m√°s barata
            tarifasComercial.sort((a, b) => a.costeAnual - b.costeAnual);
            const mejorTarifaOriginal = tarifasComercial[0];
            
            // CR√çTICO: Crear una COPIA PROFUNDA del objeto para evitar referencias compartidas
            const mejorTarifa = {
                comercializadora: mejorTarifaOriginal.comercializadora,
                costeMensual: Number(mejorTarifaOriginal.costeMensual),
                costeAnual: Number(mejorTarifaOriginal.costeAnual),
                resultado: mejorTarifaOriginal.resultado,
                tarifa: mejorTarifaOriginal.tarifa,
                nombreOriginal: mejorTarifaOriginal.nombreOriginal,
                descripcion: mejorTarifaOriginal.descripcion,
                nombreNormalizado: mejorTarifaOriginal.nombreNormalizado,
                descripcionNormalizada: mejorTarifaOriginal.descripcionNormalizada,
                nombreComercializadoraForzado: comercialObj.nombre // Forzar nombre claro
            };
            
            console.log(`DEBUG - ${comercialObj.nombre} COPIA CREADA: Anual=${mejorTarifa.costeAnual.toFixed(2)}‚Ç¨, Mensual=${mejorTarifa.costeMensual.toFixed(2)}‚Ç¨`);
            
            otrasComercializadoras.push(mejorTarifa);
            console.log(`‚úÖ ${comercialObj.nombre}: ${mejorTarifa.descripcion || mejorTarifa.comercializadora} - ${mejorTarifa.costeAnual.toFixed(2)}‚Ç¨/a√±o (${mejorTarifa.costeMensual.toFixed(2)}‚Ç¨/mes)`);
        } else {
            console.warn(`‚ö†Ô∏è No se encontr√≥ ninguna tarifa para ${comercialObj.nombre}`);
        }
    }
    
    // Ordenar otras comercializadoras por precio
    otrasComercializadoras.sort((a, b) => a.costeAnual - b.costeAnual);
    
    // PASO 5: Combinar todo - DRK primero (las 2 ordenadas por precio), luego el resto
    let resultados = [...drkTarifas, ...otrasComercializadoras];
    
    console.log('\nüîç DEBUG DESPU√âS DE COMBINAR:');
    resultados.forEach((r, i) => {
        console.log(`  [${i}] ${r.descripcion || r.comercializadora}: Mensual=${r.costeMensual.toFixed(2)}‚Ç¨, Anual=${r.costeAnual.toFixed(2)}‚Ç¨`);
    });
    
    // Limitar a m√°ximo 8
    if (resultados.length > 8) {
        resultados = resultados.slice(0, 8);
    }
    
    console.log('üìä RANKING FINAL (orden real por precio):');
    resultados.forEach((r, i) => {
        console.log(`  ${i+1}¬∫: ${r.descripcion || r.comercializadora} - ANUAL=${r.costeAnual.toFixed(2)}‚Ç¨/a√±o (MENSUAL=${r.costeMensual.toFixed(2)}‚Ç¨/mes)`);
    });
    
    console.log('\nüîç DEBUG DETALLADO - Verificando cada resultado:');
    resultados.forEach((r, i) => {
        console.log(`  [${i}] costeAnual=${r.costeAnual}, costeMensual=${r.costeMensual}, tipo=${typeof r.costeAnual}`);
    });
    
    // Mejor y peor precio del ranking
    const mejorPrecio = resultados[0].costeAnual;
    const peorPrecio = resultados[resultados.length - 1].costeAnual;
    const ahorroMedio = resultados.reduce((sum, r, i) => {
        if (i === 0) return sum;
        return sum + (r.costeAnual - mejorPrecio);
    }, 0) / (resultados.length - 1);
    
    // Ocultar loading
    document.getElementById('comparison-loading').style.display = 'none';
    
    // Mostrar estad√≠sticas
    renderComparisonStats(resultados.length, ahorroMedio, resultados[0].descripcion || resultados[0].comercializadora);
    
    // Renderizar tabla
    renderComparisonTable(resultados, mejorPrecio);
    
    // Renderizar gr√°fico
    renderComparisonChart(resultados, mejorPrecio, peorPrecio);
    
    // Renderizar highlight con precios DRK detallados y precios de competencia
    renderComparisonHighlight(resultados[0], resultados[resultados.length - 1], mejorPrecio, peorPrecio, mejorDRKIndex, mejorDRKFijo, resultados);
}

function renderComparisonStats(numTarifas, ahorroMedio, mejorComercializadora) {
    const statsContainer = document.getElementById('comparison-stats');
    statsContainer.style.display = 'grid';
    
    statsContainer.innerHTML = `
        <div class="comparison-stat-box">
            <div style="font-size: 2.5rem; font-weight: 900; color: #2596be; margin-bottom: 0.5rem;">
                6
            </div>
            <div style="font-size: 0.875rem; color: #64748b; font-weight: 600;">
                <span data-translate="comp-stats-companies">Comercializadoras</span> <span data-translate="comp-stats-analyzed">Seleccionadas</span>
            </div>
        </div>
        <div class="comparison-stat-box">
            <div style="font-size: 2.5rem; font-weight: 900; color: #10b981; margin-bottom: 0.5rem;">
                ${Math.round(ahorroMedio)}‚Ç¨
            </div>
            <div style="font-size: 0.875rem; color: #64748b; font-weight: 600;" data-translate="comp-stats-avg-savings">
                Ahorro Medio Anual
            </div>
        </div>
        <div class="comparison-stat-box">
            <div style="font-size: 1.5rem; font-weight: 900; color: #2596be; margin-bottom: 0.5rem;">
                ${mejorComercializadora}
            </div>
            <div style="font-size: 0.875rem; color: #64748b; font-weight: 600;" data-translate="comp-stats-best">
                Mejor Opci√≥n
            </div>
        </div>
    `;
    
    translatePanel(); // Retraducir para nuevos elementos
}

function renderComparisonTable(resultados, mejorPrecio) {
    const tbody = document.getElementById('comparison-table-body');
    tbody.innerHTML = '';
    
    document.getElementById('comparison-table-container').style.display = 'block';
    
    resultados.forEach((resultado, index) => {
        console.log(`üîç RENDERIZANDO FILA ${index}:`);
        console.log(`  Nombre: ${resultado.comercializadora}`);
        console.log(`  costeMensual (variable): ${resultado.costeMensual}`);
        console.log(`  costeAnual (variable): ${resultado.costeAnual}`);
        console.log(`  typeof costeMensual: ${typeof resultado.costeMensual}`);
        console.log(`  typeof costeAnual: ${typeof resultado.costeAnual}`);
        
        // Destacar DRK INDEX (primera) y DRK FIJO (segunda)
        const isBest = index === 0;
        const isSecondBest = index === 1 && resultado.nombreNormalizado && resultado.nombreNormalizado.includes('DRK');
        
        // Calcular diferencia usando los datos INDIVIDUALES de cada resultado
        const diferencia = resultado.costeAnual - mejorPrecio;
        
        const row = document.createElement('tr');
        // Aplicar estilo especial si es DRK (primera o segunda posici√≥n)
        if (isBest || isSecondBest) {
            row.className = 'comp-table-row best-row';
        } else {
            row.className = 'comp-table-row';
        }
        
        // Mostrar nombre claro en la tabla
        let nombreMostrar;
        if (resultado.nombreComercializadoraForzado) {
            // Es una comercializadora grande, mostrar: "Endesa" o "Endesa - Tarifa Nombre"
            if (resultado.descripcion && resultado.descripcion.trim() !== '') {
                nombreMostrar = `${resultado.nombreComercializadoraForzado} - ${resultado.descripcion}`;
            } else {
                nombreMostrar = resultado.nombreComercializadoraForzado;
            }
        } else if (resultado.descripcion && resultado.descripcion.trim() !== '') {
            // DRK o similar, mostrar descripci√≥n
            nombreMostrar = resultado.descripcion;
        } else {
            // Fallback: nombre de comercializadora
            nombreMostrar = resultado.comercializadora;
        }
        
        // Badge apropiado
        let badge = '';
        if (isBest) {
            badge = '<span class="badge-winner" data-translate="comp-best-badge">MEJOR PRECIO</span>';
        } else if (isSecondBest) {
            badge = '<span style="display: inline-block; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.7rem; font-weight: 700; margin-left: 0.5rem;">2¬™ MEJOR</span>';
        }
        
        // DEBUG: Verificar valores justo antes de crear el HTML
        const mensualParaMostrar = resultado.costeMensual.toFixed(2);
        const anualParaMostrar = resultado.costeAnual.toFixed(2);
        console.log(`  üìù Valores para HTML: Mensual=${mensualParaMostrar}‚Ç¨, Anual=${anualParaMostrar}‚Ç¨`);
        
        row.innerHTML = `
            <td style="padding: 1.25rem 1rem;">
                <strong style="font-size: ${isBest || isSecondBest ? '1.125rem' : '1rem'};">${nombreMostrar}</strong>
                ${badge}
            </td>
            <td style="padding: 1.25rem 1rem; text-align: center; font-weight: 600;">${mensualParaMostrar}‚Ç¨</td>
            <td style="padding: 1.25rem 1rem; text-align: center; font-weight: 600; font-size: ${isBest ? '1.125rem' : '1rem'}; color: ${isBest || isSecondBest ? '#10b981' : '#1e293b'};">
                ${anualParaMostrar}‚Ç¨
            </td>
            <td style="padding: 1.25rem 1rem; text-align: center; font-weight: 700; color: ${isBest ? '#10b981' : (diferencia <= 0 ? '#10b981' : '#ef4444')};">
                ${isBest ? '<span data-translate="comp-reference">Referencia</span>' : (diferencia >= 0 ? '+' : '') + diferencia.toFixed(2) + '‚Ç¨'}
            </td>
        `;
        
        tbody.appendChild(row);
    });
    
    translatePanel(); // Retraducir
}

function renderComparisonChart(resultados, mejorPrecio, peorPrecio) {
    const chartContainer = document.getElementById('comparison-chart');
    chartContainer.innerHTML = '';
    chartContainer.parentElement.style.display = 'block';
    
    const maxWidth = 100;
    const minWidth = 60;
    const range = peorPrecio - mejorPrecio;
    
    resultados.forEach((resultado, index) => {
        // DRK INDEX (primera) y DRK FIJO (segunda) como ganadoras
        const isWinner = index === 0;
        const isSecondBest = index === 1 && resultado.nombreNormalizado && resultado.nombreNormalizado.includes('DRK');
        
        // Calcular porcentaje usando el coste INDIVIDUAL de cada resultado
        const porcentaje = range > 0 
            ? minWidth + ((resultado.costeAnual - mejorPrecio) / range) * (maxWidth - minWidth) 
            : maxWidth;
        
        const colors = [
            'linear-gradient(135deg, #10b981 0%, #059669 100%)', // Verde (ganadora)
            'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)', // Verde claro (DRK FIJO)
            'linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%)', // Azul
            'linear-gradient(135deg, #818cf8 0%, #6366f1 100%)', // √çndigo
            'linear-gradient(135deg, #3db4d8 0%, #2596be 100%)', // Azul corporativo
            'linear-gradient(135deg, #f472b6 0%, #ec4899 100%)', // Rosa
            'linear-gradient(135deg, #fb7185 0%, #f43f5e 100%)', // Rojo
            'linear-gradient(135deg, #f87171 0%, #ef4444 100%)'  // Rojo oscuro
        ];
        
        const colorIndex = Math.min(index, colors.length - 1);
        
        const bar = document.createElement('div');
        if (isWinner) {
            bar.className = 'chart-bar-comp winner-bar';
        } else if (isSecondBest) {
            bar.className = 'chart-bar-comp';
            bar.style.background = colors[1]; // Verde claro para DRK FIJO
            bar.style.border = '2px solid #16a34a';
        } else {
            bar.className = 'chart-bar-comp';
            bar.style.background = colors[colorIndex];
        }
        
        bar.style.width = porcentaje + '%';
        
        // Nombre para el gr√°fico: comercializadora forzada o descripci√≥n
        let nombreMostrar;
        if (resultado.nombreComercializadoraForzado) {
            nombreMostrar = resultado.nombreComercializadoraForzado;
        } else if (resultado.descripcion && resultado.descripcion.trim() !== '') {
            nombreMostrar = resultado.descripcion;
        } else {
            nombreMostrar = resultado.comercializadora;
        }
        
        bar.innerHTML = `
            <span style="flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 1rem;">${nombreMostrar}</span>
            <span style="white-space: nowrap;"><strong>${Math.round(resultado.costeAnual)}‚Ç¨</strong></span>
        `;
        
        chartContainer.appendChild(bar);
    });
}

// NUEVA FUNCI√ìN: Traduce textos DESPU√âS de generar el HTML (no toca la generaci√≥n de precios)
function translateComparisonTexts() {
    const highlightContainer = document.getElementById('comparison-highlight');
    if (!highlightContainer) return;
    
    // Obtener idioma actual - usar currentPanelLanguage
    const lang = currentPanelLanguage || 'es';
    
    console.log('üåç translateComparisonTexts ejecut√°ndose, idioma:', lang);
    
    if (lang === 'es') {
        console.log('   ‚úÖ Idioma es espa√±ol, no se requiere traducci√≥n');
        return; // Si es espa√±ol, no hay nada que traducir
    }
    
    let html = highlightContainer.innerHTML;
    const originalLength = html.length;
    
    // Helper para obtener traducci√≥n
    const t = (key) => {
        const translation = panelTranslations[lang] && panelTranslations[lang][key];
        return translation || panelTranslations.es[key] || key;
    };
    
    // Reemplazar textos espec√≠ficos (en orden, de m√°s espec√≠fico a m√°s general)
    // Solo reemplazamos los textos exactos en espa√±ol, sin tocar n√∫meros ni nombres
    const replacements = {
        // Textos m√°s largos primero para evitar reemplazos parciales
        'un cliente tipo paga solo': t('comp-text-client-pays'),
        'mientras que con': t('comp-text-while'),
        'que permanecen en tu bolsillo cada a√±o': t('comp-text-pocket'),
        'En 5 a√±os, el ahorro acumulado ser√≠a de': t('comp-text-in-5-years'),
        'Estos n√∫meros son reales y est√°n calculados con las tarifas actuales del mercado el√©ctrico espa√±ol': t('comp-text-these-numbers'),
        'Precios Detallados DRK Energ√≠a': t('comp-text-detailed-prices'),
        'Precios de la Competencia': t('comp-text-competitor-prices'),
        'MEJOR OPCI√ìN DEL MERCADO': t('comp-text-best-market'),
        'Precio estable garantizado': t('comp-text-stable-price'),
        'DRK INDEXADO': t('comp-text-drk-indexed'),
        'DRK FIJO': t('comp-text-drk-fixed'),
        'de diferencia': t('comp-text-difference'),
        'al a√±o': t('comp-text-per-year'),
        'pagar√≠a': t('comp-text-would-pay'),
        'Eso son': t('comp-text-thats'),
        'POTENCIA': t('comp-text-power'),
        'ENERG√çA': t('comp-text-energy'),
        'Potencia': t('comp-text-power'),
        'Energ√≠a': t('comp-text-energy'),
        'Punta': t('comp-text-peak'),
        'Llano': t('comp-text-standard'),
        'Valle': t('comp-text-valley'),
        'Con ': t('comp-text-with') + ' ' // Con espacio para no reemplazar "Con" dentro de otras palabras
    };
    
    let replacementCount = 0;
    
    // Aplicar todos los reemplazos
    for (const [spanish, translation] of Object.entries(replacements)) {
        if (spanish !== translation && html.includes(spanish)) {
            const beforeReplace = html;
            html = html.split(spanish).join(translation);
            if (beforeReplace !== html) {
                replacementCount++;
                console.log(`   ‚úÖ Reemplazado: "${spanish}" ‚Üí "${translation}"`);
            }
        }
    }
    
    highlightContainer.innerHTML = html;
    console.log(`   üìä Total reemplazos: ${replacementCount}, HTML length: ${originalLength} ‚Üí ${html.length}`);
}


function renderComparisonHighlight(mejor, peor, mejorPrecio, peorPrecio, drkIndexado, drkFijo, todosResultados) {
    const highlightContainer = document.getElementById('comparison-highlight');
    const ahorro = peorPrecio - mejorPrecio;
    const ahorro5anos = ahorro * 5;
    
    let drkPricesHTML = '';
    
    // Mostrar precios DRK DETALLADOS si est√°n disponibles
    if (drkIndexado || drkFijo) {
        drkPricesHTML = '<div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #059669;">';
        drkPricesHTML += '<h4 style="font-size: 1.25rem; font-weight: 700; color: #047857; margin-bottom: 1.5rem;">üí∞ Precios Detallados DRK Energ√≠a</h4>';
        
        // Crear grid para las dos tarifas DRK
        drkPricesHTML += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">';
        
        if (drkIndexado) {
            const tarifa = drkIndexado.tarifa;
            drkPricesHTML += `
                <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); padding: 1.5rem; border-radius: 1rem; border: 3px solid #10b981;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div style="font-size: 1rem; font-weight: 700; color: #047857;">üèÜ DRK INDEXADO</div>
                        <div style="font-size: 1.5rem; font-weight: 900; color: #047857;">${Math.round(drkIndexado.costeAnual)}‚Ç¨/a√±o</div>
                    </div>
                    <div style="background: rgba(16, 185, 129, 0.15); padding: 0.5rem; border-radius: 0.5rem; margin-bottom: 1rem; text-align: center;">
                        <div style="font-size: 0.75rem; font-weight: 600; color: #047857;">‚≠ê MEJOR OPCI√ìN DEL MERCADO</div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <div style="font-size: 0.75rem; font-weight: 600; color: #059669; text-transform: uppercase; margin-bottom: 0.5rem;">‚ö° Potencia</div>
                        <div style="display: grid; gap: 0.25rem;">
                            <div style="font-size: 0.875rem; color: #065f46;">
                                P1: <strong>${(tarifa.p_potencia_1 || 0).toFixed(4)} ‚Ç¨/kW¬∑a√±o</strong>
                            </div>
                            <div style="font-size: 0.875rem; color: #065f46;">
                                P2: <strong>${(tarifa.p_potencia_2 || 0).toFixed(4)} ‚Ç¨/kW¬∑a√±o</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <div style="font-size: 0.75rem; font-weight: 600; color: #059669; text-transform: uppercase; margin-bottom: 0.5rem;">‚ö° Energ√≠a</div>
                        <div style="display: grid; gap: 0.25rem;">
                            <div style="font-size: 0.875rem; color: #065f46;">
                                Punta: <strong>${(tarifa.p1_price || 0).toFixed(4)} ‚Ç¨/kWh</strong>
                            </div>
                            <div style="font-size: 0.875rem; color: #065f46;">
                                Llano: <strong>${(tarifa.p2_price || 0).toFixed(4)} ‚Ç¨/kWh</strong>
                            </div>
                            <div style="font-size: 0.875rem; color: #065f46;">
                                Valle: <strong>${(tarifa.p3_price || 0).toFixed(4)} ‚Ç¨/kWh</strong>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Descripci√≥n de la tarifa INDEXADA -->
                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid rgba(16, 185, 129, 0.2);">
                        <div style="background: rgba(16, 185, 129, 0.05); padding: 1rem; border-radius: 0.75rem; border-left: 3px solid #10b981;">
                            <h4 style="font-size: 0.95rem; font-weight: 700; color: #047857; margin-bottom: 0.5rem;">
                                ‚ö° Tarifa Variable (Indexada) ‚Äì DRK ENERGY
                            </h4>
                            <p style="font-size: 0.8rem; color: #059669; margin-bottom: 1rem; font-style: italic;">
                                Para quienes quieren pagar el precio real de la energ√≠a, sin ataduras
                            </p>
                            <div style="display: grid; gap: 0.5rem;">
                                <div style="display: flex; gap: 0.5rem; font-size: 0.8rem; color: #065f46;">
                                    <span style="color: #10b981; font-weight: 700;">1.</span>
                                    <span>El precio del kWh es la media de cada mes seg√∫n el precio horario.</span>
                                </div>
                                <div style="display: flex; gap: 0.5rem; font-size: 0.8rem; color: #065f46;">
                                    <span style="color: #10b981; font-weight: 700;">2.</span>
                                    <span><strong>M√°xima transparencia:</strong> pagas exactamente el coste real de la energ√≠a, sin m√°rgenes ocultos.</span>
                                </div>
                                <div style="display: flex; gap: 0.5rem; font-size: 0.8rem; color: #065f46;">
                                    <span style="color: #10b981; font-weight: 700;">3.</span>
                                    <span>Opci√≥n ideal para clientes con flexibilidad.</span>
                                </div>
                                <div style="display: flex; gap: 0.5rem; font-size: 0.8rem; color: #065f46;">
                                    <span style="color: #10b981; font-weight: 700;">4.</span>
                                    <span><strong>SIN PERMANENCIA:</strong> libertad total para cambiar cuando quieras, sin penalizaciones.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        if (drkFijo) {
            const tarifa = drkFijo.tarifa;
            drkPricesHTML += `
                <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); padding: 1.5rem; border-radius: 1rem; border: 2px solid #10b981;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div style="font-size: 1rem; font-weight: 700; color: #047857;">DRK FIJO</div>
                        <div style="font-size: 1.5rem; font-weight: 900; color: #047857;">${Math.round(drkFijo.costeAnual)}‚Ç¨/a√±o</div>
                    </div>
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 0.5rem; border-radius: 0.5rem; margin-bottom: 1rem; text-align: center;">
                        <div style="font-size: 0.75rem; font-weight: 600; color: #059669;">Precio estable garantizado</div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <div style="font-size: 0.75rem; font-weight: 600; color: #059669; text-transform: uppercase; margin-bottom: 0.5rem;">‚ö° Potencia</div>
                        <div style="display: grid; gap: 0.25rem;">
                            <div style="font-size: 0.875rem; color: #065f46;">
                                P1: <strong>${(tarifa.p_potencia_1 || 0).toFixed(4)} ‚Ç¨/kW¬∑a√±o</strong>
                            </div>
                            <div style="font-size: 0.875rem; color: #065f46;">
                                P2: <strong>${(tarifa.p_potencia_2 || 0).toFixed(4)} ‚Ç¨/kW¬∑a√±o</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <div style="font-size: 0.75rem; font-weight: 600; color: #059669; text-transform: uppercase; margin-bottom: 0.5rem;">‚ö° Energ√≠a</div>
                        <div style="display: grid; gap: 0.25rem;">
                            <div style="font-size: 0.875rem; color: #065f46;">
                                Punta: <strong>${(tarifa.p1_price || 0).toFixed(4)} ‚Ç¨/kWh</strong>
                            </div>
                            <div style="font-size: 0.875rem; color: #065f46;">
                                Llano: <strong>${(tarifa.p2_price || 0).toFixed(4)} ‚Ç¨/kWh</strong>
                            </div>
                            <div style="font-size: 0.875rem; color: #065f46;">
                                Valle: <strong>${(tarifa.p3_price || 0).toFixed(4)} ‚Ç¨/kWh</strong>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Descripci√≥n de la tarifa FIJA -->
                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid rgba(16, 185, 129, 0.2);">
                        <div style="background: rgba(16, 185, 129, 0.05); padding: 1rem; border-radius: 0.75rem; border-left: 3px solid #10b981;">
                            <h4 style="font-size: 0.95rem; font-weight: 700; color: #047857; margin-bottom: 0.5rem;">
                                ‚ö° Tarifa Fija de Electricidad
                            </h4>
                            <p style="font-size: 0.8rem; color: #059669; margin-bottom: 1rem; font-style: italic;">
                                Ideal para clientes que buscan estabilidad y tranquilidad
                            </p>
                            <div style="display: grid; gap: 0.5rem;">
                                <div style="display: flex; gap: 0.5rem; font-size: 0.8rem; color: #065f46;">
                                    <span style="color: #10b981; font-weight: 700;">1.</span>
                                    <span>Precio del kWh <strong>estable durante todo el contrato</strong>, sin cambios inesperados.</span>
                                </div>
                                <div style="display: flex; gap: 0.5rem; font-size: 0.8rem; color: #065f46;">
                                    <span style="color: #10b981; font-weight: 700;">2.</span>
                                    <span>Permite <strong>predecir la factura</strong> mes a mes con total claridad.</span>
                                </div>
                                <div style="display: flex; gap: 0.5rem; font-size: 0.8rem; color: #065f46;">
                                    <span style="color: #10b981; font-weight: 700;">3.</span>
                                    <span>Protege frente a <strong>subidas del mercado el√©ctrico</strong>.</span>
                                </div>
                                <div style="display: flex; gap: 0.5rem; font-size: 0.8rem; color: #065f46;">
                                    <span style="color: #10b981; font-weight: 700;">4.</span>
                                    <span>Facilita la <strong>planificaci√≥n del gasto energ√©tico</strong> anual.</span>
                                </div>
                                <div style="display: flex; gap: 0.5rem; font-size: 0.8rem; color: #065f46;">
                                    <span style="color: #10b981; font-weight: 700;">5.</span>
                                    <span>Recomendable para hogares o negocios que valoran <strong>seguridad y control</strong>.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        drkPricesHTML += '</div></div>';
    }
    
    // NUEVO: Precios de la competencia
    let competitorPricesHTML = '';
    if (todosResultados && todosResultados.length > 2) {
        competitorPricesHTML = '<div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #2596be;">';
        competitorPricesHTML += '<h4 style="font-size: 1.25rem; font-weight: 700; color: #2596be; margin-bottom: 1.5rem;">üìä Precios de la Competencia</h4>';
        
        competitorPricesHTML += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">';
        
        console.log('üè™ Generando precios de competencia...');
        
        // Mostrar precios de comercializadoras (excluyendo las 2 primeras que son DRK)
        // USAR todosResultados (array final filtrado y ordenado) en lugar de todos los resultados
        for (let i = 2; i < todosResultados.length && i < 8; i++) {
            const r = todosResultados[i];
            const tarifa = r.tarifa;
            const nombreComercial = r.nombreComercializadoraForzado || r.comercializadora;
            
            console.log(`  [${i}] ${nombreComercial}: Anual=${r.costeAnual.toFixed(2)}‚Ç¨`);
            
            competitorPricesHTML += `
                <div style="background: #f8fafc; padding: 1.25rem; border-radius: 0.75rem; border: 2px solid #2596be;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <div style="font-size: 0.875rem; font-weight: 700; color: #1e293b;">${nombreComercial}</div>
                        <div style="font-size: 1.125rem; font-weight: 900; color: #2596be;">${Math.round(r.costeAnual)}‚Ç¨/a√±o</div>
                    </div>
                    
                    <div style="margin-bottom: 0.75rem;">
                        <div style="font-size: 0.6875rem; font-weight: 600; color: #2596be; text-transform: uppercase; margin-bottom: 0.375rem;">‚ö° Potencia</div>
                        <div style="display: grid; gap: 0.125rem;">
                            <div style="font-size: 0.75rem; color: #475569;">
                                P1: <strong>${(tarifa.p_potencia_1 || 0).toFixed(4)} ‚Ç¨/kW¬∑a√±o</strong>
                            </div>
                            <div style="font-size: 0.75rem; color: #475569;">
                                P2: <strong>${(tarifa.p_potencia_2 || 0).toFixed(4)} ‚Ç¨/kW¬∑a√±o</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <div style="font-size: 0.6875rem; font-weight: 600; color: #2596be; text-transform: uppercase; margin-bottom: 0.375rem;">‚ö° Energ√≠a</div>
                        <div style="display: grid; gap: 0.125rem;">
                            <div style="font-size: 0.75rem; color: #475569;">
                                Punta: <strong>${(tarifa.p1_price || 0).toFixed(4)} ‚Ç¨/kWh</strong>
                            </div>
                            <div style="font-size: 0.75rem; color: #475569;">
                                Llano: <strong>${(tarifa.p2_price || 0).toFixed(4)} ‚Ç¨/kWh</strong>
                            </div>
                            <div style="font-size: 0.75rem; color: #475569;">
                                Valle: <strong>${(tarifa.p3_price || 0).toFixed(4)} ‚Ç¨/kWh</strong>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        competitorPricesHTML += '</div></div>';
    }
    
    // Usar siempre DRK INDEX como referencia en el texto
    const nombreMejor = mejor.descripcion || mejor.comercializadora;
    const nombrePeor = peor.nombreComercializadoraForzado || peor.comercializadora;
    
    highlightContainer.innerHTML = `
        <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; color: #047857;">
            <i class="fas fa-check-circle"></i> <span data-translate="comp-highlight-title">Ahorro Real y Verificable</span>
        </h3>
        <p style="color: #065f46; margin-bottom: 1rem; line-height: 1.6;">
            Con <strong>${nombreMejor}</strong>, un cliente tipo paga solo <strong>${Math.round(mejorPrecio)}‚Ç¨ al a√±o</strong>, 
            mientras que con <strong>${nombrePeor}</strong> pagar√≠a <strong>${Math.round(peorPrecio)}‚Ç¨</strong>. 
            Eso son <strong>${Math.round(ahorro)}‚Ç¨ de diferencia</strong> que permanecen en tu bolsillo cada a√±o.
        </p>
        <p style="color: #065f46; line-height: 1.6; margin-bottom: ${drkPricesHTML ? '0' : '1rem'};">
            <strong>En 5 a√±os, el ahorro acumulado ser√≠a de ${Math.round(ahorro5anos)}‚Ç¨</strong>. 
            Estos n√∫meros son reales y est√°n calculados con las tarifas actuales del mercado el√©ctrico espa√±ol.
        </p>
        ${drkPricesHTML}
        ${competitorPricesHTML}
    `;
    
    translatePanel(); // Retraducir
    translateComparisonTexts(); // Traducir textos espec√≠ficos de comparativa
}

// ========== EMAIL BACKOFFICE MODAL ==========
function openEmailModal() {
    // Traducir el modal antes de abrirlo
    translatePanel();
    
    document.getElementById('email-modal').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeEmailModal() {
    document.getElementById('email-modal').classList.remove('active');
    document.body.style.overflow = 'auto';
    
    // Limpiar formulario
    document.getElementById('client-name').value = '';
    document.getElementById('client-email').value = '';
    document.getElementById('client-phone').value = '';
}

function sendEmail() {
    // Obtener datos del formulario (opcionales)
    const clientName = document.getElementById('client-name').value.trim();
    const clientEmail = document.getElementById('client-email').value.trim();
    const clientPhone = document.getElementById('client-phone').value.trim();
    
    // Preparar destinatarios
    const recipients = [
        'Rguerra@drk.es',
        'f.araujo@drk.es',
        'l.grande@drk.es'
    ];
    
    // Textos traducidos para el email
    const emailTexts = {
        es: {
            subject: 'Solicitud de mejora de precios ‚Äì Cliente',
            greeting: 'Estimado equipo de DRK,',
            intro: 'Me pongo en contacto con ustedes para solicitar informaci√≥n sobre sus tarifas energ√©ticas y posibles mejoras en mis condiciones actuales.',
            contactDataHeader: 'Mis datos de contacto son:',
            name: 'Nombre',
            email: 'Email',
            phone: 'Tel√©fono',
            closing: 'Quedo a la espera de su respuesta.',
            farewell: 'Atentamente'
        },
        en: {
            subject: 'Request for price improvement ‚Äì Client',
            greeting: 'Dear DRK Team,',
            intro: 'I am contacting you to request information about your energy rates and possible improvements to my current conditions.',
            contactDataHeader: 'My contact details are:',
            name: 'Name',
            email: 'Email',
            phone: 'Phone',
            closing: 'I look forward to your response.',
            farewell: 'Best regards'
        },
        pt: {
            subject: 'Solicita√ß√£o de melhoria de pre√ßos ‚Äì Cliente',
            greeting: 'Prezada equipe DRK,',
            intro: 'Entro em contato para solicitar informa√ß√µes sobre suas tarifas de energia e poss√≠veis melhorias nas minhas condi√ß√µes atuais.',
            contactDataHeader: 'Meus dados de contato s√£o:',
            name: 'Nome',
            email: 'Email',
            phone: 'Telefone',
            closing: 'Aguardo sua resposta.',
            farewell: 'Atenciosamente'
        },
        zh: {
            subject: '‰ª∑Ê†ºÊîπËøõËØ∑Ê±Ç ‚Äì ÂÆ¢Êà∑',
            greeting: '‰∫≤Áà±ÁöÑDRKÂõ¢ÈòüÔºå',
            intro: 'ÊàëËÅîÁ≥ªÊÇ®ÊòØ‰∏∫‰∫ÜËØ¢ÈóÆÊÇ®ÁöÑËÉΩÊ∫êË¥πÁéá‰ø°ÊÅØ‰ª•ÂèäÊîπÂñÑÊàëÁõÆÂâçÊù°‰ª∂ÁöÑÂèØËÉΩÊÄß„ÄÇ',
            contactDataHeader: 'ÊàëÁöÑËÅîÁ≥ªÊñπÂºèÊòØÔºö',
            name: 'ÂßìÂêç',
            email: 'ÁîµÂ≠êÈÇÆ‰ª∂',
            phone: 'ÁîµËØù',
            closing: 'ÊúüÂæÖÊÇ®ÁöÑÂõûÂ§ç„ÄÇ',
            farewell: 'Ê≠§Ëá¥Êï¨Á§º'
        },
        fr: {
            subject: 'Demande d\'am√©lioration des prix ‚Äì Client',
            greeting: 'Ch√®re √©quipe DRK,',
            intro: 'Je vous contacte pour demander des informations sur vos tarifs √©nerg√©tiques et les am√©liorations possibles de mes conditions actuelles.',
            contactDataHeader: 'Mes coordonn√©es sont :',
            name: 'Nom',
            email: 'Email',
            phone: 'T√©l√©phone',
            closing: 'Dans l\'attente de votre r√©ponse.',
            farewell: 'Cordialement'
        }
    };
    
    // Obtener idioma actual
    const currentLang = currentPanelLanguage || 'es';
    const texts = emailTexts[currentLang] || emailTexts['es'];
    
    // Asunto del email
    const subject = texts.subject;
    
    // Cuerpo del email
    let body = texts.greeting + '\n\n';
    body += texts.intro + '\n\n';
    
    // SIEMPRE agregar secci√≥n de datos del cliente
    body += texts.contactDataHeader + '\n';
    body += '‚Ä¢ ' + texts.name + ': ' + (clientName || '_____________________') + '\n';
    body += '‚Ä¢ ' + texts.email + ': ' + (clientEmail || '_____________________') + '\n';
    body += '‚Ä¢ ' + texts.phone + ': ' + (clientPhone || '_____________________') + '\n';
    body += '\n';
    
    body += texts.closing + '\n\n';
    body += texts.farewell;
    
    // Crear el mailto link
    const mailtoLink = 'mailto:' + recipients.join(',') + 
                      '?subject=' + encodeURIComponent(subject) + 
                      '&body=' + encodeURIComponent(body);
    
    // Abrir cliente de correo
    window.location.href = mailtoLink;
    
    // Cerrar modal despu√©s de un breve delay
    setTimeout(() => {
        closeEmailModal();
    }, 500);
}

// Cerrar modal al hacer clic fuera
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('email-modal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeEmailModal();
            }
        });
    }
});
</script>

<!-- ========== PANTALLA DE COMPARACI√ìN DE PRECIOS ========== -->
<div id="comparison-view">
    <button class="back-btn" onclick="showPanelFromComparison()">
        <i class="fas fa-arrow-left" style="margin-right: 0.5rem;"></i><span data-translate="back-btn">Volver</span>
    </button>
    
    <div id="screen-comparison">
        <div style="max-width: 1400px; margin: 0 auto;">
            
            <!-- Hero Section -->
            <div class="comparison-hero">
                <h1 style="font-size: 2rem; font-weight: 900; margin-bottom: 0.75rem;" data-translate="comparison-title">
                    üìä Comparativa de Precios - Tarifa 2.0TD
                </h1>
                <p style="font-size: 1rem; opacity: 0.95;" data-translate="comparison-subtitle">
                    An√°lisis profesional con datos reales del mercado espa√±ol
                </p>
                <p style="font-size: 0.875rem; opacity: 0.8; margin-top: 0.5rem;" id="comparison-client-info" data-translate="comp-client-profile">
                    Cliente tipo: 6 kW ‚Ä¢ 270 kWh/mes
                </p>
            </div>

            <!-- Loading State -->
            <div id="comparison-loading" style="display: none; text-align: center; padding: 4rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">‚è≥</div>
                <p style="font-size: 1.25rem; font-weight: 600; color: #64748b;" data-translate="comparison-loading">
                    Cargando datos de mercado...
                </p>
            </div>

            <!-- Stats Overview -->
            <div id="comparison-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <!-- Se rellena din√°micamente -->
            </div>

            <!-- Comparison Table -->
            <div id="comparison-table-container" class="comparison-table-container">
                <div class="comp-table-responsive">
                    <table id="comparison-table" style="width: 100%; border-collapse: collapse;">
                        <thead class="comp-table-header">
                            <tr>
                                <th style="padding: 1rem; text-align: left;" data-translate="comp-col-company">Comercializadora</th>
                                <th style="padding: 1rem; text-align: center;" data-translate="comp-col-monthly">Coste Mensual</th>
                                <th style="padding: 1rem; text-align: center;" data-translate="comp-col-annual">Coste Anual</th>
                                <th style="padding: 1rem; text-align: center;" data-translate="comp-col-savings">Dif. vs Mejor</th>
                            </tr>
                        </thead>
                        <tbody id="comparison-table-body">
                            <!-- Se rellena din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Visual Chart -->
            <div class="comparison-summary-card">
                <h2 style="font-size: 1.75rem; font-weight: 800; margin-bottom: 1.5rem; color: #1e293b;" data-translate="comp-chart-title">
                    üìà Comparativa Visual - Coste Anual
                </h2>
                <div id="comparison-chart">
                    <!-- Se rellena din√°micamente -->
                </div>
            </div>

            <!-- Summary Section -->
            <div class="comparison-summary-card">
                <h2 style="font-size: 1.75rem; font-weight: 800; margin-bottom: 1.5rem; color: #1e293b;" data-translate="comp-summary-title">
                    üí° ¬øPor qu√© elegir la mejor tarifa?
                </h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div style="background: #f8fafc; padding: 1.5rem; border-radius: 1rem; border-left: 4px solid #2596be;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üí∞</div>
                        <h3 style="font-weight: 700; margin-bottom: 0.5rem; color: #1e293b;" data-translate="comp-benefit-1-title">Ahorro Real</h3>
                        <p style="color: #64748b; font-size: 0.875rem;" data-translate="comp-benefit-1-desc">
                            Compara precios reales actualizados del mercado
                        </p>
                    </div>

                    <div style="background: #f8fafc; padding: 1.5rem; border-radius: 1rem; border-left: 4px solid #10b981;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìä</div>
                        <h3 style="font-weight: 700; margin-bottom: 0.5rem; color: #1e293b;" data-translate="comp-benefit-2-title">Transparencia</h3>
                        <p style="color: #64748b; font-size: 0.875rem;" data-translate="comp-benefit-2-desc">
                            Datos verificables y actualizados mensualmente
                        </p>
                    </div>

                    <div style="background: #f8fafc; padding: 1.5rem; border-radius: 1rem; border-left: 4px solid #2596be;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ö°</div>
                        <h3 style="font-weight: 700; margin-bottom: 0.5rem; color: #1e293b;" data-translate="comp-benefit-3-title">Decisi√≥n Informada</h3>
                        <p style="color: #64748b; font-size: 0.875rem;" data-translate="comp-benefit-3-desc">
                            Compara y elige la opci√≥n que m√°s te conviene
                        </p>
                    </div>
                </div>

                <div id="comparison-highlight" class="comparison-highlight">
                    <!-- Se rellena din√°micamente con el resumen de ahorro -->
                </div>
            </div>

            <!-- Footer Notes -->
            <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-top: 2rem; border: 1px solid #e2e8f0;">
                <p style="font-size: 0.75rem; color: #64748b; line-height: 1.6;" data-translate="comp-footer-note">
                    <strong>Nota metodol√≥gica:</strong> Precios reales extra√≠dos de tarifas p√∫blicas vigentes sin IVA. 
                    Cliente tipo: 6 kW potencia contratada, consumo mensual 270 kWh (60 kWh punta, 90 kWh llano, 120 kWh valle). 
                    Datos actualizados autom√°ticamente. Los precios pueden variar seg√∫n promociones espec√≠ficas.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- ========== FRIENDS CODE SECTION ========== -->
<div id="friends-code-view" style="display: none;">
    <div class="comparison-section">
        <div class="comparison-container">
            <!-- Hero Section -->
            <div class="comparison-hero">
                <button onclick="hideFriendsCode()" class="back-button">
                    <i class="fas fa-arrow-left"></i> <span data-translate="back-to-panel">Volver al Panel</span>
                </button>
                
                <div style="text-align: center;">
                    <h1 style="font-size: 2.5rem; font-weight: 900; margin-bottom: 1rem;" data-translate="friends-title">
                        üë• C√≥digo Amigos DRK
                    </h1>
                    <p style="font-size: 1rem; opacity: 0.8; margin-top: 0.5rem;" id="friends-client-info" data-translate="friends-subtitle">
                        Comparte energ√≠a, comparte ahorro
                    </p>
                </div>
            </div>

            <!-- Banner Inspirador -->
            <div style="background: linear-gradient(135deg, #1e7a9e 0%, #2596be 100%); border-radius: 1.5rem; padding: 2.5rem; color: white; margin-bottom: 2rem; box-shadow: 0 10px 30px rgba(37, 150, 190, 0.3);">
                <h2 style="font-size: 2rem; font-weight: 800; margin-bottom: 1.5rem; text-align: center;" data-translate="friends-banner-title">
                    üëç Lo mejor de todo
                </h2>
                <p style="font-size: 1.1rem; line-height: 1.8; margin-bottom: 1.5rem; text-align: center;" data-translate="friends-banner-intro">
                    Imagina poder ofrecer a tus seres queridos una tarifa energ√©tica tan incre√≠ble como esta:
                </p>
                
                <!-- Tarjeta de Precios PLAN AMIGO -->
                <div id="plan-amigo-card" style="background: white; border-radius: 1rem; padding: 2rem; margin: 2rem auto; max-width: 500px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);">
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1.5rem; font-weight: 800; color: #2596be; margin-bottom: 0.5rem;" data-translate="friends-card-title">
                            üíé DRK PLAN AMIGO
                        </h3>
                        <p style="font-size: 0.875rem; color: #64748b;" data-translate="friends-card-subtitle">
                            Tarifa exclusiva para referidos
                        </p>
                    </div>
                    
                    <!-- Precios din√°micos desde Google Sheets -->
                    <div style="display: grid; gap: 1rem;">
                        <div style="background: #f0f9ff; padding: 1rem; border-radius: 0.75rem; border-left: 3px solid #2596be;">
                            <div style="font-size: 0.75rem; font-weight: 700; color: #0369a1; text-transform: uppercase; margin-bottom: 0.5rem;">‚ö° POTENCIA</div>
                            <div style="display: grid; gap: 0.25rem;">
                                <div style="font-size: 0.875rem; color: #0c4a6e;">
                                    P1: <strong id="plan-amigo-p-potencia-1" style="color: #2596be;">--</strong> ‚Ç¨/kW¬∑a√±o
                                </div>
                                <div style="font-size: 0.875rem; color: #0c4a6e;">
                                    P2: <strong id="plan-amigo-p-potencia-2" style="color: #2596be;">--</strong> ‚Ç¨/kW¬∑a√±o
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: #f0f9ff; padding: 1rem; border-radius: 0.75rem; border-left: 3px solid #2596be;">
                            <div style="font-size: 0.75rem; font-weight: 700; color: #0369a1; text-transform: uppercase; margin-bottom: 0.5rem;">‚ö° ENERG√çA</div>
                            <div style="display: grid; gap: 0.25rem;">
                                <div style="font-size: 0.875rem; color: #0c4a6e;">
                                    Punta: <strong id="plan-amigo-p1-price" style="color: #2596be;">--</strong> ‚Ç¨/kWh
                                </div>
                                <div style="font-size: 0.875rem; color: #0c4a6e;">
                                    Llano: <strong id="plan-amigo-p2-price" style="color: #2596be;">--</strong> ‚Ç¨/kWh
                                </div>
                                <div style="font-size: 0.875rem; color: #0c4a6e;">
                                    Valle: <strong id="plan-amigo-p3-price" style="color: #2596be;">--</strong> ‚Ç¨/kWh
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <p style="font-size: 1.1rem; line-height: 1.8; text-align: center; margin-top: 1.5rem;" data-translate="friends-banner-code">
                    El c√≥digo que te enviamos con el descuento es <strong>aplicable en hasta 5 hogares diferentes</strong>. 
                    Es tu oportunidad dorada para que quienes m√°s te importan ahorren de verdad y de forma significativa en su factura de la luz.
                </p>
            </div>

            <!-- 4 Beneficios -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <div style="background: linear-gradient(135deg, #0f4c75 0%, #1b6ca8 100%); padding: 2rem; border-radius: 1rem; color: white; border: 2px solid rgba(37, 150, 190, 0.3);">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #3a4a5c 0%, #2d3748 100%); border-radius: 1.5rem; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);">
                        <!-- Icono: Dos personas empresarios con apret√≥n de manos -->
                        <svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <!-- Persona 1 (izquierda) -->
                            <circle cx="18" cy="18" r="6" fill="#fbbf24" opacity="0.3"/>
                            <circle cx="18" cy="18" r="6" stroke="#fbbf24" stroke-width="2"/>
                            <path d="M 10 32 Q 10 26 18 26 Q 26 26 26 32 L 26 38 L 10 38 Z" fill="#fbbf24" opacity="0.3"/>
                            <path d="M 10 32 Q 10 26 18 26 Q 26 26 26 32" stroke="#fbbf24" stroke-width="2" fill="none"/>
                            
                            <!-- Persona 2 (derecha) -->
                            <circle cx="42" cy="18" r="6" fill="#fbbf24" opacity="0.3"/>
                            <circle cx="42" cy="18" r="6" stroke="#fbbf24" stroke-width="2"/>
                            <path d="M 34 32 Q 34 26 42 26 Q 50 26 50 32 L 50 38 L 34 38 Z" fill="#fbbf24" opacity="0.3"/>
                            <path d="M 34 32 Q 34 26 42 26 Q 50 26 50 32" stroke="#fbbf24" stroke-width="2" fill="none"/>
                            
                            <!-- Apret√≥n de manos (centro) -->
                            <rect x="23" y="42" width="7" height="10" rx="1" fill="#f59e0b" opacity="0.3"/>
                            <rect x="23" y="42" width="7" height="10" rx="1" stroke="#f59e0b" stroke-width="1.5"/>
                            <rect x="30" y="42" width="7" height="10" rx="1" fill="#f59e0b" opacity="0.3"/>
                            <rect x="30" y="42" width="7" height="10" rx="1" stroke="#f59e0b" stroke-width="1.5"/>
                            <path d="M 26 47 L 34 47" stroke="#fbbf24" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.75rem;" data-translate="friends-benefit-1-title">
                        Presenta a un amigo empresario
                    </h3>
                    <p style="font-size: 0.875rem; opacity: 0.9; line-height: 1.6;" data-translate="friends-benefit-1-desc">
                        Solo necesitas presentarnos a un contacto que tenga una empresa y est√© dispuesto a compartir su factura energ√©tica actual
                    </p>
                </div>

                <div style="background: linear-gradient(135deg, #0f4c75 0%, #1b6ca8 100%); padding: 2rem; border-radius: 1rem; color: white; border: 2px solid rgba(37, 150, 190, 0.3);">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #3a4a5c 0%, #2d3748 100%); border-radius: 1.5rem; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);">
                        <!-- Icono: Documento con gr√°fico de energ√≠a -->
                        <svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <!-- Documento -->
                            <rect x="15" y="10" width="30" height="40" rx="3" fill="#fbbf24" opacity="0.2"/>
                            <rect x="15" y="10" width="30" height="40" rx="3" stroke="#fbbf24" stroke-width="2"/>
                            
                            <!-- L√≠neas de texto -->
                            <line x1="20" y1="17" x2="35" y2="17" stroke="#fbbf24" stroke-width="2" stroke-linecap="round"/>
                            <line x1="20" y1="23" x2="40" y2="23" stroke="#fbbf24" stroke-width="2" stroke-linecap="round"/>
                            
                            <!-- Gr√°fico de barras dentro del documento -->
                            <rect x="20" y="32" width="4" height="12" rx="1" fill="#f59e0b"/>
                            <rect x="26" y="28" width="4" height="16" rx="1" fill="#f59e0b"/>
                            <rect x="32" y="35" width="4" height="9" rx="1" fill="#f59e0b"/>
                            <line x1="19" y1="45" x2="41" y2="45" stroke="#fbbf24" stroke-width="1.5"/>
                            
                            <!-- Rayo de energ√≠a (s√≠mbolo) -->
                            <circle cx="48" cy="18" r="8" fill="#f59e0b" opacity="0.3"/>
                            <circle cx="48" cy="18" r="8" stroke="#f59e0b" stroke-width="2"/>
                            <path d="M 51 14 L 47 18 L 49 18 L 45 22 L 49 18 L 47 18 Z" fill="#fbbf24" stroke="#fbbf24" stroke-width="0.5"/>
                        </svg>
                    </div>
                    <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.75rem;" data-translate="friends-benefit-2-title">
                        Estudio energ√©tico gratuito
                    </h3>
                    <p style="font-size: 0.875rem; opacity: 0.9; line-height: 1.6;" data-translate="friends-benefit-2-desc">
                        Realizaremos un an√°lisis completo y profesional de su consumo sin ning√∫n coste ni compromiso de contrataci√≥n
                    </p>
                </div>

                <div style="background: linear-gradient(135deg, #0f4c75 0%, #1b6ca8 100%); padding: 2rem; border-radius: 1rem; color: white; border: 2px solid rgba(37, 150, 190, 0.3);">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #3a4a5c 0%, #2d3748 100%); border-radius: 1.5rem; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);">
                        <!-- Icono: Regalo/Ticket con estrellas -->
                        <svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <!-- Ticket/Cup√≥n -->
                            <rect x="12" y="22" width="36" height="22" rx="3" fill="#fbbf24" opacity="0.2"/>
                            <rect x="12" y="22" width="36" height="22" rx="3" stroke="#fbbf24" stroke-width="2" stroke-dasharray="2,2"/>
                            
                            <!-- C√≥digo de barras simplificado -->
                            <line x1="17" y1="30" x2="17" y2="36" stroke="#f59e0b" stroke-width="2"/>
                            <line x1="21" y1="30" x2="21" y2="36" stroke="#f59e0b" stroke-width="1.5"/>
                            <line x1="24" y1="30" x2="24" y2="36" stroke="#f59e0b" stroke-width="2"/>
                            <line x1="28" y1="30" x2="28" y2="36" stroke="#f59e0b" stroke-width="1.5"/>
                            <line x1="31" y1="30" x2="31" y2="36" stroke="#f59e0b" stroke-width="2"/>
                            <line x1="35" y1="30" x2="35" y2="36" stroke="#f59e0b" stroke-width="1.5"/>
                            <line x1="38" y1="30" x2="38" y2="36" stroke="#f59e0b" stroke-width="2"/>
                            <line x1="42" y1="30" x2="42" y2="36" stroke="#f59e0b" stroke-width="1.5"/>
                            
                            <!-- Estrella brillante 1 (arriba izquierda) -->
                            <circle cx="18" cy="15" r="5" fill="#fbbf24" opacity="0.3"/>
                            <path d="M 18 12 L 19 16 L 22 16 L 19.5 18 L 20.5 21 L 18 19 L 15.5 21 L 16.5 18 L 14 16 L 17 16 Z" fill="#fbbf24"/>
                            
                            <!-- Estrella brillante 2 (arriba derecha) -->
                            <circle cx="42" cy="15" r="4" fill="#f59e0b" opacity="0.3"/>
                            <path d="M 42 13 L 42.8 15.5 L 45 15.5 L 43.2 17 L 44 19 L 42 17.5 L 40 19 L 40.8 17 L 39 15.5 L 41.2 15.5 Z" fill="#f59e0b"/>
                            
                            <!-- Estrella brillante 3 (abajo) -->
                            <circle cx="30" cy="48" r="4" fill="#f59e0b" opacity="0.3"/>
                            <path d="M 30 46 L 30.8 48.5 L 33 48.5 L 31.2 50 L 32 52 L 30 50.5 L 28 52 L 28.8 50 L 27 48.5 L 29.2 48.5 Z" fill="#f59e0b"/>
                        </svg>
                    </div>
                    <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.75rem;" data-translate="friends-benefit-3-title">
                        Recibe tu c√≥digo exclusivo
                    </h3>
                    <p style="font-size: 0.875rem; opacity: 0.9; line-height: 1.6;" data-translate="friends-benefit-3-desc">
                        Como agradecimiento, te entregaremos un c√≥digo promocional √∫nico para que compartas con tus 5 amigos
                    </p>
                </div>

                <div style="background: linear-gradient(135deg, #0f4c75 0%, #1b6ca8 100%); padding: 2rem; border-radius: 1rem; color: white; border: 2px solid rgba(37, 150, 190, 0.3);">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #3a4a5c 0%, #2d3748 100%); border-radius: 1.5rem; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);">
                        <!-- Icono: M√∫ltiples casas (5 hogares) -->
                        <svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <!-- Casa trasera izquierda -->
                            <path d="M 10 30 L 17 24 L 24 30 L 24 40 L 10 40 Z" fill="#f59e0b" opacity="0.3"/>
                            <path d="M 10 30 L 17 24 L 24 30" stroke="#f59e0b" stroke-width="1.5" fill="none"/>
                            <rect x="10" y="30" width="14" height="10" fill="#f59e0b" opacity="0.2"/>
                            <rect x="10" y="30" width="14" height="10" stroke="#f59e0b" stroke-width="1.5"/>
                            <rect x="14" y="34" width="3" height="6" fill="#fbbf24"/>
                            
                            <!-- Casa trasera derecha -->
                            <path d="M 36 30 L 43 24 L 50 30 L 50 40 L 36 40 Z" fill="#f59e0b" opacity="0.3"/>
                            <path d="M 36 30 L 43 24 L 50 30" stroke="#f59e0b" stroke-width="1.5" fill="none"/>
                            <rect x="36" y="30" width="14" height="10" fill="#f59e0b" opacity="0.2"/>
                            <rect x="36" y="30" width="14" height="10" stroke="#f59e0b" stroke-width="1.5"/>
                            <rect x="40" y="34" width="3" height="6" fill="#fbbf24"/>
                            
                            <!-- Casa central GRANDE (principal) -->
                            <path d="M 18 38 L 30 28 L 42 38 L 42 52 L 18 52 Z" fill="#fbbf24" opacity="0.3"/>
                            <path d="M 18 38 L 30 28 L 42 38" stroke="#fbbf24" stroke-width="2" fill="none"/>
                            <rect x="18" y="38" width="24" height="14" fill="#fbbf24" opacity="0.2"/>
                            <rect x="18" y="38" width="24" height="14" stroke="#fbbf24" stroke-width="2"/>
                            
                            <!-- Puerta casa central -->
                            <rect x="27" y="44" width="6" height="8" rx="1" fill="#f59e0b"/>
                            <circle cx="31" cy="48" r="0.8" fill="#fbbf24"/>
                            
                            <!-- Ventana casa central -->
                            <rect x="22" y="42" width="4" height="4" rx="0.5" fill="#f59e0b"/>
                            <line x1="24" y1="42" x2="24" y2="46" stroke="#fbbf24" stroke-width="0.8"/>
                            <line x1="22" y1="44" x2="26" y2="44" stroke="#fbbf24" stroke-width="0.8"/>
                            
                            <!-- N√∫mero "5" en la casa principal -->
                            <circle cx="38" cy="32" r="5" fill="#f59e0b" opacity="0.5"/>
                            <text x="38" y="36" text-anchor="middle" font-size="8" font-weight="bold" fill="#fbbf24">5</text>
                        </svg>
                    </div>
                    <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.75rem;" data-translate="friends-benefit-4-title">
                        Beneficia hasta 5 hogares
                    </h3>
                    <p style="font-size: 0.875rem; opacity: 0.9; line-height: 1.6;" data-translate="friends-benefit-4-desc">
                        Comparte la tarifa especial en energ√≠a y potencia con familiares, amigos o conocidos que quieras ayudar
                    </p>
                </div>
            </div>

            <!-- Condiciones Importantes -->
            <div style="background: white; border-radius: 1rem; padding: 2rem; border: 2px solid #2596be;">
                <h2 style="font-size: 1.5rem; font-weight: 800; color: #2596be; margin-bottom: 1rem;" data-translate="friends-conditions-title">
                    üìå Condiciones importantes
                </h2>
                <p style="font-size: 1rem; line-height: 1.8; color: #1e293b; margin-bottom: 1.5rem;" data-translate="friends-conditions-intro">
                    La empresa que presente su factura para el estudio energ√©tico <strong>no tiene ninguna obligaci√≥n de contratar con nosotros</strong>. 
                    El an√°lisis es completamente gratuito y sin compromiso. Es una forma de ayudar a tu contacto empresarial a conocer su situaci√≥n 
                    energ√©tica actual mientras t√∫ obtienes acceso a esta promoci√≥n extraordinaria.
                </p>
                <div style="display: grid; gap: 0.75rem;">
                    <div style="display: flex; gap: 0.75rem; align-items: start;">
                        <div style="width: 8px; height: 8px; background: #2596be; border-radius: 50%; margin-top: 0.5rem; flex-shrink: 0;"></div>
                        <p style="font-size: 0.9rem; color: #475569;" data-translate="friends-condition-1">Basta con presentar una factura de empresa con suministro activo</p>
                    </div>
                    <div style="display: flex; gap: 0.75rem; align-items: start;">
                        <div style="width: 8px; height: 8px; background: #2596be; border-radius: 50%; margin-top: 0.5rem; flex-shrink: 0;"></div>
                        <p style="font-size: 0.9rem; color: #475569;" data-translate="friends-condition-2">El c√≥digo es v√°lido √∫nicamente para hasta 5 hogares</p>
                    </div>
                    <div style="display: flex; gap: 0.75rem; align-items: start;">
                        <div style="width: 8px; height: 8px; background: #2596be; border-radius: 50%; margin-top: 0.5rem; flex-shrink: 0;"></div>
                        <p style="font-size: 0.9rem; color: #475569;" data-translate="friends-condition-3">No v√°lido para tarifas con exclusi√≥n social o familia numerosa</p>
                    </div>
                    <div style="display: flex; gap: 0.75rem; align-items: start;">
                        <div style="width: 8px; height: 8px; background: #2596be; border-radius: 50%; margin-top: 0.5rem; flex-shrink: 0;"></div>
                        <p style="font-size: 0.9rem; color: #475569;" data-translate="friends-condition-4">Promoci√≥n limitada en tiempo y plazas disponibles</p>
                    </div>
                    <div style="display: flex; gap: 0.75rem; align-items: start;">
                        <div style="width: 8px; height: 8px; background: #2596be; border-radius: 50%; margin-top: 0.5rem; flex-shrink: 0;"></div>
                        <p style="font-size: 0.9rem; color: #475569;" data-translate="friends-condition-5">Aplicable a nuevos contratos o renovaciones con c√≥digo promocional</p>
                    </div>
                </div>
            </div>

            <!-- Bot√≥n para solicitar c√≥digo -->
            <div style="margin-top: 2rem; text-align: center;">
                <button onclick="toggleFriendsCodeForm()" id="request-code-button" style="background: linear-gradient(135deg, #2596be 0%, #1e7a9e 100%); color: white; border: none; padding: 1.5rem 3rem; border-radius: 1rem; font-size: 1.25rem; font-weight: 800; cursor: pointer; box-shadow: 0 10px 30px rgba(37, 150, 190, 0.4); transition: all 0.3s ease; width: 100%; max-width: 600px;">
                    <span data-translate="friends-request-button">üéÅ QUIERO MI C√ìDIGO - SOLICITAR A DRK ENERGY</span>
                </button>
            </div>

            <!-- Accordion del formulario -->
            <div id="friends-code-form-container" style="display: none; margin-top: 2rem; animation: slideDown 0.3s ease;">
                <div style="background: white; border-radius: 1rem; padding: 2.5rem; border: 2px solid #2596be; box-shadow: 0 10px 30px rgba(37, 150, 190, 0.2);">
                    <h3 style="font-size: 1.5rem; font-weight: 800; color: #2596be; margin-bottom: 2rem; text-align: center;" data-translate="friends-form-title">
                        üìã DATOS AMIGO PARA CONSEGUIR C√ìDIGO
                    </h3>

                    <form id="friends-code-form" onsubmit="sendFriendsCodeRequest(event)">
                        <!-- DATOS DEL AMIGO -->
                        <div style="background: #f0f9ff; padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 2rem; border-left: 4px solid #2596be;">
                            <h4 style="font-size: 1.1rem; font-weight: 700; color: #0c4a6e; margin-bottom: 1.5rem;" data-translate="friends-form-friend-data">
                                üè¢ DATOS DEL AMIGO (empresa recomendada)
                            </h4>
                            
                            <div style="display: grid; gap: 1rem;">
                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #0369a1; margin-bottom: 0.5rem;" data-translate="friends-form-company-name">
                                        Nombre de la empresa amiga *
                                    </label>
                                    <input type="text" id="friend-company" required style="width: 100%; padding: 0.75rem; border: 2px solid #bae6fd; border-radius: 0.5rem; font-size: 1rem; transition: border-color 0.2s;" placeholder="Ej: Empresa ABC S.L.">
                                </div>

                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #0369a1; margin-bottom: 0.5rem;" data-translate="friends-form-contact-person">
                                        Persona de contacto *
                                    </label>
                                    <input type="text" id="friend-contact" required style="width: 100%; padding: 0.75rem; border: 2px solid #bae6fd; border-radius: 0.5rem; font-size: 1rem;" placeholder="Ej: Mar√≠a Gonz√°lez">
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #0369a1; margin-bottom: 0.5rem;" data-translate="friends-form-friend-email">
                                            Email *
                                        </label>
                                        <input type="email" id="friend-email" required style="width: 100%; padding: 0.75rem; border: 2px solid #bae6fd; border-radius: 0.5rem; font-size: 1rem;" placeholder="empresa@email.com">
                                    </div>

                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #0369a1; margin-bottom: 0.5rem;" data-translate="friends-form-friend-phone">
                                            Tel√©fono *
                                        </label>
                                        <input type="tel" id="friend-phone" required style="width: 100%; padding: 0.75rem; border: 2px solid #bae6fd; border-radius: 0.5rem; font-size: 1rem;" placeholder="+34 600 123 456">
                                    </div>
                                </div>

                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #0369a1; margin-bottom: 0.5rem;" data-translate="friends-form-comments">
                                        Comentarios opcionales
                                    </label>
                                    <textarea id="friend-comments" rows="3" style="width: 100%; padding: 0.75rem; border: 2px solid #bae6fd; border-radius: 0.5rem; font-size: 1rem; resize: vertical;" placeholder="Informaci√≥n adicional sobre la empresa..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- MIS DATOS -->
                        <div style="background: #f0fdf4; padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 2rem; border-left: 4px solid #10b981;">
                            <h4 style="font-size: 1.1rem; font-weight: 700; color: #065f46; margin-bottom: 1.5rem;" data-translate="friends-form-my-data">
                                üë§ MIS DATOS (quien solicita el c√≥digo)
                            </h4>
                            
                            <div style="display: grid; gap: 1rem;">
                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #047857; margin-bottom: 0.5rem;" data-translate="friends-form-my-name">
                                        Nombre *
                                    </label>
                                    <input type="text" id="my-name" required style="width: 100%; padding: 0.75rem; border: 2px solid #bbf7d0; border-radius: 0.5rem; font-size: 1rem;" placeholder="Ej: Juan Garc√≠a">
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #047857; margin-bottom: 0.5rem;" data-translate="friends-form-my-email">
                                            Email *
                                        </label>
                                        <input type="email" id="my-email" required style="width: 100%; padding: 0.75rem; border: 2px solid #bbf7d0; border-radius: 0.5rem; font-size: 1rem;" placeholder="tu@email.com">
                                    </div>

                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #047857; margin-bottom: 0.5rem;" data-translate="friends-form-my-phone">
                                            Tel√©fono *
                                        </label>
                                        <input type="tel" id="my-phone" required style="width: 100%; padding: 0.75rem; border: 2px solid #bbf7d0; border-radius: 0.5rem; font-size: 1rem;" placeholder="+34 600 123 456">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botones -->
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button type="button" onclick="toggleFriendsCodeForm()" style="background: #e2e8f0; color: #475569; border: none; padding: 1rem 2rem; border-radius: 0.75rem; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s;" data-translate="friends-form-cancel">
                                Cancelar
                            </button>
                            <button type="submit" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 1rem 2rem; border-radius: 0.75rem; font-size: 1rem; font-weight: 700; cursor: pointer; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3); transition: all 0.2s;" data-translate="friends-form-send">
                                üìß Enviar Solicitud
                            </button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

#request-code-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 15px 40px rgba(37, 150, 190, 0.5);
}

#friends-code-form input:focus,
#friends-code-form textarea:focus {
    outline: none;
    border-color: #2596be;
    box-shadow: 0 0 0 3px rgba(37, 150, 190, 0.1);
}
</style>

<script>
function toggleFriendsCodeForm() {
    const container = document.getElementById('friends-code-form-container');
    const button = document.getElementById('request-code-button');
    
    if (container.style.display === 'none') {
        container.style.display = 'block';
        button.style.opacity = '0.7';
        setTimeout(() => {
            container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
    } else {
        container.style.display = 'none';
        button.style.opacity = '1';
    }
}

function sendFriendsCodeRequest(event) {
    event.preventDefault();
    
    // Obtener datos del formulario
    const friendCompany = document.getElementById('friend-company').value;
    const friendContact = document.getElementById('friend-contact').value;
    const friendEmail = document.getElementById('friend-email').value;
    const friendPhone = document.getElementById('friend-phone').value;
    const friendComments = document.getElementById('friend-comments').value;
    
    const myName = document.getElementById('my-name').value;
    const myEmail = document.getElementById('my-email').value;
    const myPhone = document.getElementById('my-phone').value;
    
    // Construir el cuerpo del email
    const emailBody = `Estimado equipo de DRK,

Me pongo en contacto con ustedes para solicitar mi c√≥digo amigo, adjuntando los datos de la empresa amiga para que se pongan en contacto con ellos y les puedan facilitar un comparativo.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìã DATOS DE LA EMPRESA AMIGA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üè¢ Nombre de la empresa: ${friendCompany}
üë§ Persona de contacto: ${friendContact}
üìß Email: ${friendEmail}
üìû Tel√©fono: ${friendPhone}
${friendComments ? `üí¨ Comentarios: ${friendComments}` : ''}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üë§ MIS DATOS DE CONTACTO
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

‚Ä¢ Nombre: ${myName}
‚Ä¢ Email: ${myEmail}
‚Ä¢ Tel√©fono: ${myPhone}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Quedo a la espera de su respuesta.

Atentamente,
${myName}`;

    // Destinatarios
    const recipients = 'Rguerra@drk.es,f.araujo@drk.es,l.grande@drk.es';
    
    // Asunto
    const subject = 'Solicitud de C√≥digo Amigo ‚Äì DRK';
    
    // Crear el mailto link
    const mailtoLink = `mailto:${recipients}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
    
    // Abrir cliente de email
    window.location.href = mailtoLink;
    
    // Opcional: Cerrar el formulario despu√©s de enviar
    setTimeout(() => {
        toggleFriendsCodeForm();
        document.getElementById('friends-code-form').reset();
    }, 1000);
}
</script>


<!-- ========== VISTA DE NOTICIAS ========== -->
<div id="news-view" style="display: none; min-height: 100vh; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); padding: 2rem;">
    <div style="max-width: 1200px; margin: 0 auto;">
        <!-- Bot√≥n Volver -->
        <button onclick="hideNews()" style="background: rgba(37, 150, 190, 0.2); border: 2px solid #2596be; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer; margin-bottom: 2rem; font-size: 1rem; transition: all 0.3s;">
            <i class="fas fa-arrow-left" style="margin-right: 0.5rem;"></i><span data-translate="back-button">Volver al Panel</span>
        </button>

        <!-- Header -->
        <div style="text-align: center; margin-bottom: 3rem;">
            <h1 style="font-size: 3rem; font-weight: 800; color: white; margin-bottom: 1rem;">
                <i class="fas fa-newspaper" style="color: #fbbf24; margin-right: 1rem;"></i>
                <span data-translate="news-title">Noticias</span>
            </h1>
            <p style="font-size: 1.25rem; color: #94a3b8;" data-translate="news-subtitle">
                Mantente informado con las √∫ltimas novedades
            </p>
        </div>

        <!-- Loading indicator -->
        <div id="news-loading" style="text-align: center; padding: 3rem; display: none;">
            <div style="display: inline-block; width: 50px; height: 50px; border: 4px solid rgba(37, 150, 190, 0.3); border-top-color: #2596be; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="color: #94a3b8; margin-top: 1rem;">Cargando noticias...</p>
        </div>

        <!-- Container de noticias -->
        <div id="news-container" style="display: grid; gap: 2rem;">
            <!-- Las noticias se cargar√°n aqu√≠ din√°micamente -->
        </div>

        <!-- Mensaje si no hay noticias -->
        <div id="news-empty" style="display: none; text-align: center; padding: 4rem;">
            <i class="fas fa-inbox" style="font-size: 4rem; color: #475569; margin-bottom: 1rem;"></i>
            <p style="color: #94a3b8; font-size: 1.25rem;">No hay noticias disponibles en este momento</p>
        </div>
    </div>
</div>

<style>
@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>

<!-- Modal Email Backoffice -->
<div id="email-modal" class="email-modal">
    <div class="email-modal-content">
        <div class="email-modal-header">
            <div class="email-modal-icon">
                <i class="fas fa-envelope"></i>
            </div>
            <div>
                <h3 class="email-modal-title" data-translate="email-modal-title">Email Backoffice</h3>
                <p class="email-modal-subtitle" data-translate="email-modal-subtitle">Datos del Cliente (opcional)</p>
            </div>
        </div>
        
        <form onsubmit="event.preventDefault(); sendEmail();">
            <div class="email-form-group">
                <label class="email-form-label" data-translate="email-label-name">Nombre y Apellidos</label>
                <input type="text" id="client-name" class="email-form-input" placeholder="Ej: Juan Garc√≠a L√≥pez">
            </div>
            
            <div class="email-form-group">
                <label class="email-form-label" data-translate="email-label-email">Email</label>
                <input type="email" id="client-email" class="email-form-input" placeholder="Ej: juan@email.com">
            </div>
            
            <div class="email-form-group">
                <label class="email-form-label" data-translate="email-label-phone">Tel√©fono</label>
                <input type="tel" id="client-phone" class="email-form-input" placeholder="Ej: +34 600 123 456">
            </div>
            
            <div class="email-modal-buttons">
                <button type="button" class="email-btn email-btn-cancel" onclick="closeEmailModal()">
                    <span data-translate="email-btn-cancel">Cancelar</span>
                </button>
                <button type="submit" class="email-btn email-btn-send">
                    <i class="fas fa-paper-plane" style="margin-right: 0.5rem;"></i>
                    <span data-translate="email-btn-send">Abrir Email</span>
                </button>
            </div>
        </form>
        
        <p style="font-size: 0.75rem; color: #94a3b8; text-align: center; margin-top: 1rem;" data-translate="email-optional-note">
            Los campos son opcionales. Puedes enviar el email sin rellenarlos.
        </p>
    </div>
</div>

</body>
</html>
