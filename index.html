<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visor Interactivo - An√°lisis de Tarifas</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);padding:20px;min-height:100vh}
.container{max-width:1600px;margin:0 auto;background:#fff;border-radius:20px;padding:40px;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
h1{text-align:center;color:#667eea;margin-bottom:40px;font-size:2.5em}
.upload-area{border:3px dashed #667eea;border-radius:15px;padding:60px;text-align:center;margin:40px 0;cursor:pointer;transition:all 0.3s}
.upload-area:hover{background:#f9f9ff;border-color:#764ba2}
.upload-area.dragover{background:#e9e9ff;border-color:#764ba2;transform:scale(1.02)}
#content{display:none}
.tabs{display:flex;gap:10px;margin-bottom:30px;border-bottom:3px solid #667eea;flex-wrap:wrap}
.tab{padding:15px 25px;cursor:pointer;border:none;background:#f5f5f5;border-radius:10px 10px 0 0;font-weight:600;transition:all 0.3s}
.tab:hover{background:#e0e0e0}
.tab.active{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
.tab-content{display:none}
.tab-content.active{display:block}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:25px;margin-bottom:40px}
.kpi-card{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:30px;border-radius:15px;text-align:center;box-shadow:0 10px 30px rgba(102,126,234,0.4);transition:transform 0.3s}
.kpi-card:hover{transform:translateY(-8px)}
.kpi-value{font-size:3em;font-weight:bold;margin:15px 0}
.kpi-label{opacity:0.95;font-size:1em;text-transform:uppercase;letter-spacing:2px}
table{width:100%;border-collapse:collapse;margin:20px 0;font-size:14px}
th,td{padding:15px;text-align:left;border-bottom:1px solid #eee}
th{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-weight:600;position:sticky;top:0}
tr:hover{background:#f9f9f9}
.search-box{width:100%;max-width:400px;padding:12px 20px;border:2px solid #667eea;border-radius:25px;margin-bottom:20px}
.chart-container{background:#fff;padding:30px;border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,0.1);margin-bottom:30px}
.chart-box{position:relative;height:400px}
.badge{display:inline-block;padding:5px 12px;border-radius:20px;font-size:12px;font-weight:600}
.badge-success{background:#22c55e;color:#fff}
.badge-warning{background:#f59e0b;color:#fff}
.badge-danger{background:#ef4444;color:#fff}
.alert{padding:15px 20px;border-radius:10px;margin:10px 0;font-weight:500}
.alert-danger{background:#fee;color:#c00;border-left:4px solid #c00}
.alert-warning{background:#ffc;color:#880;border-left:4px solid #fa0}
.alert-info{background:#eff;color:#088;border-left:4px solid #088}
</style>
</head>
<body>
<div class="container">
<h1>üé® Visor Interactivo - An√°lisis de Tarifas</h1>

<div class="upload-area" id="uploadArea">
<h2 style="color:#667eea;margin-bottom:20px">üìÇ Arrastra aqu√≠ tu Excel</h2>
<p style="color:#999;font-size:1.1em">o haz click para seleccionar</p>
<p style="color:#999;margin-top:10px;font-size:0.9em">Archivo: Analisis_Tarifas_*.xlsx</p>
<input type="file" id="fileInput" accept=".xlsx" style="display:none">
</div>

<div id="content">
<div class="tabs">
<button class="tab active" onclick="cambiarTab(event,'dashboard')">üìä Dashboard</button>
<button class="tab" onclick="cambiarTab(event,'electricidad')">‚ö° Electricidad</button>
<button class="tab" onclick="cambiarTab(event,'gas')">üî• Gas</button>
<button class="tab" onclick="cambiarTab(event,'vencimientos')">üìÖ Vencimientos</button>
<button class="tab" onclick="cambiarTab(event,'resumen')">üìà Resumen</button>
</div>

<div id="dashboard" class="tab-content active"></div>
<div id="electricidad" class="tab-content"></div>
<div id="gas" class="tab-content"></div>
<div id="vencimientos" class="tab-content"></div>
<div id="resumen" class="tab-content"></div>
</div>

</div>

<script>
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
let datosGlobales = null;

uploadArea.addEventListener('click', () => fileInput.click());
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});
uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file) procesarExcel(file);
});
fileInput.addEventListener('change', (e) => {
    if (e.target.files[0]) procesarExcel(e.target.files[0]);
});

async function procesarExcel(file) {
    uploadArea.innerHTML = '<p style="color:#667eea;font-size:1.2em">‚è≥ Cargando ' + file.name + '...</p>';
    
    try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, {type: 'array'});
        
        datosGlobales = {};
        ['2_0TD','3_0TD','6_1TD','6_2TD','RL_1','RL_2','RL_3','RL_4','RL_5'].forEach(sheet => {
            if (workbook.Sheets[sheet]) datosGlobales[sheet] = XLSX.utils.sheet_to_json(workbook.Sheets[sheet]);
        });
        if (workbook.Sheets['Resumen Completo']) datosGlobales.resumenCompleto = XLSX.utils.sheet_to_json(workbook.Sheets['Resumen Completo'], {header:1});
        if (workbook.Sheets['Vencimientos Pr√≥ximos']) datosGlobales.vencimientos = XLSX.utils.sheet_to_json(workbook.Sheets['Vencimientos Pr√≥ximos']);
        if (workbook.Sheets['Resumen Gas']) datosGlobales.resumenGas = XLSX.utils.sheet_to_json(workbook.Sheets['Resumen Gas']);
        
        renderizarVisor();
        uploadArea.style.display = 'none';
        document.getElementById('content').style.display = 'block';
    } catch (error) {
        uploadArea.innerHTML = '<p style="color:red">‚ùå Error: ' + error.message + '</p><p style="margin-top:10px"><button onclick="location.reload()">Reintentar</button></p>';
    }
}

function cambiarTab(event, tabId) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(tabId).classList.add('active');
}

function fmt(num) { return new Intl.NumberFormat('es-ES').format(Math.round(num)); }
function fmtCur(num) { return new Intl.NumberFormat('es-ES', {style:'currency', currency:'EUR'}).format(num); }

function renderTabla(datos, titulo) {
    if (!datos || datos.length === 0) return '<p style="text-align:center;padding:40px;color:#999">No hay datos</p>';
    
    const keys = Object.keys(datos[0]);
    let html = '<h2>' + titulo + '</h2><input type="text" class="search-box" placeholder="üîç Buscar..." onkeyup="filtrarTabla(this)"><table><thead><tr>';
    keys.forEach(k => html += '<th>' + k + '</th>');
    html += '</tr></thead><tbody>';
    datos.forEach(row => {
        html += '<tr>';
        keys.forEach(k => {
            let val = row[k] || '';
            let cls = '';
            if (k === 'Estado') {
                if (val === 'ACTIVA') cls = 'badge badge-success';
                else if (val === 'CONFIGURADA') cls = 'badge badge-warning';
                else cls = 'badge badge-danger';
            }
            if (typeof val === 'number' && k.includes('Beneficio')) val = fmtCur(val);
            else if (typeof val === 'number' && k.includes('Consumo')) val = fmt(val);
            else if (typeof val === 'number') val = fmt(val);
            html += '<td><span class="' + cls + '">' + val + '</span></td>';
        });
        html += '</tr>';
    });
    html += '</tbody></table>';
    return html;
}

function filtrarTabla(input) {
    const filter = input.value.toUpperCase();
    const rows = input.nextElementSibling.querySelectorAll('tbody tr');
    rows.forEach(row => {
        row.style.display = row.textContent.toUpperCase().includes(filter) ? '' : 'none';
    });
}

function renderizarVisor() {
    // Dashboard
    let totalIndex = 0, totalFijos = 0, beneficioTotal = 0;
    const datosPeajes = {};
    
    ['2_0TD','3_0TD','6_1TD','6_2TD'].forEach(sheet => {
        if (datosGlobales[sheet]) {
            datosPeajes[sheet] = {index:0, fijos:0, beneficio:0};
            datosGlobales[sheet].forEach(row => {
                const esIndex = (row.Tarifa || '').toUpperCase().includes('INDEX');
                const facturas = row.Facturas || 0;
                const beneficio = row['Beneficio (‚Ç¨)'] || 0;
                if (esIndex) {
                    totalIndex += facturas;
                    datosPeajes[sheet].index += facturas;
                    datosPeajes[sheet].beneficio += beneficio;
                    beneficioTotal += beneficio;
                } else {
                    totalFijos += facturas;
                    datosPeajes[sheet].fijos += facturas;
                }
            });
        }
    });
    
    document.getElementById('dashboard').innerHTML = `
        <div class="kpi-grid">
        <div class="kpi-card"><div class="kpi-label">Contratos INDEX</div><div class="kpi-value">${fmt(totalIndex)}</div></div>
        <div class="kpi-card"><div class="kpi-label">Contratos FIJOS</div><div class="kpi-value">${fmt(totalFijos)}</div></div>
        <div class="kpi-card"><div class="kpi-label">Beneficio Mensual</div><div class="kpi-value">${fmtCur(beneficioTotal)}</div></div>
        <div class="kpi-card"><div class="kpi-label">Beneficio Anual</div><div class="kpi-value">${fmtCur(beneficioTotal*12)}</div></div>
        </div>
        <div class="chart-container"><h2>üìä Distribuci√≥n de Contratos</h2><div class="chart-box"><canvas id="chart1"></canvas></div></div>
        <div class="chart-container"><h2>üí∞ Beneficios INDEX</h2><div class="chart-box"><canvas id="chart2"></canvas></div></div>
    `;
    
    new Chart(document.getElementById('chart1'), {
        type: 'bar',
        data: {
            labels: Object.keys(datosPeajes),
            datasets: [{label:'INDEX',data:Object.values(datosPeajes).map(d=>d.index),backgroundColor:'rgba(102,126,234,0.8)'},{label:'FIJOS',data:Object.values(datosPeajes).map(d=>d.fijos),backgroundColor:'rgba(118,75,162,0.8)'}]
        },
        options: {responsive:true,maintainAspectRatio:false}
    });
    
    new Chart(document.getElementById('chart2'), {
        type: 'pie',
        data: {
            labels: Object.keys(datosPeajes),
            datasets: [{data:Object.values(datosPeajes).map(d=>d.beneficio),backgroundColor:['#667eea','#764ba2','#ed64a6','#2ec4b6']}]
        },
        options: {responsive:true,maintainAspectRatio:false}
    });
    
    // Electricidad
    let htmlElec = '<h2>‚ö° Tarifas Electricidad</h2>';
    ['2_0TD','3_0TD','6_1TD','6_2TD'].forEach(sheet => {
        if (datosGlobales[sheet]) htmlElec += renderTabla(datosGlobales[sheet], sheet.replace('_','.'));
    });
    document.getElementById('electricidad').innerHTML = htmlElec;
    
    // Gas
    let htmlGas = '<h2>üî• Tarifas Gas</h2>';
    ['RL_1','RL_2','RL_3','RL_4','RL_5'].forEach(sheet => {
        if (datosGlobales[sheet]) htmlGas += renderTabla(datosGlobales[sheet], sheet.replace('_','.'));
    });
    if (datosGlobales.resumenGas) htmlGas += renderTabla(datosGlobales.resumenGas, 'Resumen Gas');
    document.getElementById('gas').innerHTML = htmlGas;
    
    // Vencimientos
    if (datosGlobales.vencimientos) {
        const vencidos = datosGlobales.vencimientos.filter(v => v['D√≠as Restantes'] < 0);
        const urgentes = datosGlobales.vencimientos.filter(v => v['D√≠as Restantes'] >= 0 && v['D√≠as Restantes'] <= 30);
        let html = '';
        if (vencidos.length > 0) html += '<div class="alert alert-danger">‚ö†Ô∏è <strong>' + vencidos.length + ' contratos vencidos</strong></div>';
        if (urgentes.length > 0) html += '<div class="alert alert-warning">üî¥ <strong>' + urgentes.length + ' contratos urgentes (‚â§30 d√≠as)</strong></div>';
        html += renderTabla(datosGlobales.vencimientos, 'Todos los Vencimientos');
        document.getElementById('vencimientos').innerHTML = html;
    }
    
    // Resumen
    if (datosGlobales.resumenCompleto) {
        let html = '<h2>üìà Resumen Completo</h2><table>';
        datosGlobales.resumenCompleto.forEach(row => {
            html += '<tr>';
            row.forEach(cell => html += '<td><strong>' + (cell || '') + '</strong></td>');
            html += '</tr>';
        });
        html += '</table>';
        document.getElementById('resumen').innerHTML = html;
    }
}
</script>
</body>
</html>
