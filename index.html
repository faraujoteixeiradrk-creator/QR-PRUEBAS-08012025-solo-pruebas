<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Liquidaciones Comerciales - ELECTRICIDAD + GAS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 1.1em; }
        .header .subtitle { opacity: 0.8; font-size: 0.9em; margin-top: 5px; }
        .content { padding: 40px; }
        .upload-section {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            background: #f8f9ff;
            transition: all 0.3s;
            cursor: pointer;
        }
        .upload-section:hover { border-color: #764ba2; background: #f0f2ff; }
        .upload-section.dragover { background: #e8ebff !important; border-color: #764ba2 !important; transform: scale(1.02); }
        input[type="file"] { display: none; }
        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        .upload-btn:hover { transform: translateY(-2px); }
        .status { margin-top: 20px; padding: 15px; border-radius: 10px; display: none; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; display: block; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; display: block; }
        .download-section { display: none; text-align: center; margin-top: 30px; padding: 30px; background: #f8f9ff; border-radius: 15px; }
        .download-btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        }
        .download-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        .download-btn.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .download-btn.script {
            background: linear-gradient(135deg, #FF6B6B 0%, #FFE66D 100%);
        }
        .loading { text-align: center; padding: 20px; display: none; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .instructions {
            background: #fff9e6;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 5px;
        }
        .instructions h3 { color: #856404; margin-bottom: 10px; }
        .instructions ul { margin-left: 20px; color: #856404; }
        .instructions li { margin: 5px 0; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-card h3 { font-size: 2em; margin-bottom: 5px; }
        .stat-card p { opacity: 0.9; font-size: 0.9em; }
        .drag-icon { font-size: 3em; margin-bottom: 10px; }
        .missing-tariffs {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            display: none;
        }
        .missing-tariffs h4 { color: #856404; margin-bottom: 10px; }
        .missing-tariffs ul { margin-left: 20px; color: #856404; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üíº Calculadora de Liquidaciones Comerciales</h1>
            <p>ELECTRICIDAD + GAS</p>
            <p class="subtitle">Con f√≥rmulas Excel y exportaci√≥n por comercial</p>
        </div>
        
        <div class="content">
            <div class="instructions">
                <h3>üìã Funcionalidades:</h3>
                <ul>
                    <li><strong>F√≥rmulas Excel</strong> en subtotales para verificaci√≥n</li>
                    <li><strong>Exportar todo</strong> ‚Üí Un Excel completo</li>
                    <li><strong>Exportar por comercial</strong> ‚Üí Un ZIP con archivos separados</li>
                    <li><strong>Script Mac</strong> ‚Üí Abre Outlook autom√°ticamente (requiere descarga separada)</li>
                    <li><strong>INDEX PLUS</strong> ‚Üí TOTAL (100%) | <strong>Resto</strong> ‚Üí REPARTO</li>
                </ul>
            </div>
            
            <div class="upload-section" id="uploadSection">
                <div class="drag-icon">üìÅ</div>
                <h2>Arrastra tu Excel aqu√≠</h2>
                <p style="margin: 20px 0; color: #666;">o haz clic para seleccionar</p>
                <label for="fileInput" class="upload-btn">Seleccionar Excel</label>
                <input type="file" id="fileInput" accept=".xlsx,.xls">
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="margin-top: 15px; color: #667eea;">Procesando...</p>
            </div>
            
            <div class="status" id="status"></div>
            
            <div class="missing-tariffs" id="missingTariffs">
                <h4>‚ö†Ô∏è Tarifas extra√≠das autom√°ticamente:</h4>
                <ul id="missingList"></ul>
                <p style="margin-top: 10px;"><strong>Hoja "TARIFAS_NO_ENCONTRADAS" creada</strong></p>
            </div>
            
            <div id="statsContainer"></div>
            <div id="statsContainerGas"></div>
            
            <div class="download-section" id="downloadSection">
                <h2>‚úÖ ELECTRICIDAD - Procesamiento Completado</h2>
                <p style="margin: 15px 0;">Elige c√≥mo descargar:</p>
                <button class="download-btn" id="downloadBtn">üì• Descargar Todo (Excel completo)</button>
                <br>
                <button class="download-btn secondary" id="downloadByComercialBtn">üì¶ Descargar por Comercial (ZIP)</button>
                <p style="margin-top: 10px; font-size: 0.85em; color: #666;">
                    üí° <strong>ZIP:</strong> Un archivo Excel por cada comercial
                </p>
            </div>
            
            <div class="download-section" id="downloadSectionGas" style="display: none; margin-top: 20px; background: #fff3cd; border: 2px solid #ffc107;">
                <h2>‚úÖ GAS - Procesamiento Completado</h2>
                <p style="margin: 15px 0;">Elige c√≥mo descargar:</p>
                <button class="download-btn" onclick="downloadExcelGas()" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);">üì• Descargar Excel GAS Completo</button>
                <br>
                <button class="download-btn secondary" onclick="downloadByComercialGas()" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">üì¶ Descargar por Comercial GAS (ZIP)</button>
                <p style="margin-top: 10px; font-size: 0.85em; color: #666;">
                    üìä Incluye: Detalle GAS + Resumen + Tarifas no encontradas
                </p>
            </div>
            
            <div class="download-section" id="downloadSectionScript" style="display: none; margin-top: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                <h2 style="color: white;">üìß ENVIAR CORREOS</h2>
                <p style="margin: 15px 0; opacity: 0.95;">Descargar script para env√≠o autom√°tico por Outlook (Mac)</p>
                <button class="download-btn script" id="downloadScriptBtn" style="background: linear-gradient(135deg, #FF6B6B 0%, #FFE66D 100%); border: 3px solid white;">üçé Descargar Script Mac</button>
                <p style="margin-top: 15px; font-size: 0.85em; opacity: 0.9;">
                    üí° <strong>Instrucciones:</strong><br>
                    1. Descarga los ZIPs (Electricidad y/o Gas)<br>
                    2. Descarga este script<br>
                    3. Ejecuta el script ‚Üí Outlook abrir√° con todos los emails listos
                </p>
            </div>
            
            <div class="download-section" id="downloadSectionAnalisis" style="display: none; margin-top: 30px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none;">
                <h2 style="color: white;">üìä AN√ÅLISIS DE TARIFAS</h2>
                <p style="margin: 15px 0; opacity: 0.95;">Ver qu√© tarifas est√°n activas y cu√°les se est√°n facturando</p>
                <button class="download-btn" id="downloadAnalisisBtn" style="background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%); border: 3px solid white;">üìà Analizar Tarifas Activas</button>
                <p style="margin-top: 15px; font-size: 0.85em; opacity: 0.9;">
                    üí° <strong>Genera un Excel con:</strong><br>
                    ‚Ä¢ Tarifas √∫nicas por peaje (2.0 TD, 3.0 TD, 6.1 TD, RL.1-5)<br>
                    ‚Ä¢ Estado: ACTIVA / CONFIGURADA / NO ENCONTRADA<br>
                    ‚Ä¢ Tipo: REPARTO / TOTAL<br>
                    ‚Ä¢ N√∫mero de facturas por tarifa
                </p>
            </div>
            
            <!-- VISOR INTERACTIVO WEB -->
            <div class="section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h2 style="color: white;">üé® VISOR INTERACTIVO WEB</h2>
                <p style="margin: 15px 0; opacity: 0.95;">Visualiza el Excel generado en una interfaz web moderna</p>
                <input type="file" id="excelVisorInput" accept=".xlsx" style="display: none;">
                <button class="download-btn" id="abrirVisorBtn" style="background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); border: 3px solid white;">üé® Abrir Visor Web</button>
                <p style="margin-top: 15px; font-size: 0.85em; opacity: 0.9;">
                    üìä <strong>Instrucciones:</strong><br>
                    1. Click en "Abrir Visor Web"<br>
                    2. Selecciona el Excel generado<br>
                    3. ¬°Explora tus datos de forma visual!
                </p>
            </div>
        </div>
    </div>

    <script>
        // ELECTRICIDAD
        let processedWorkbook = null;
        let processedDataByGroup = null;
        let allProcessedData = null;
        
        // GAS (nuevo)
        let processedWorkbookGas = null;
        let processedDataByGroupGas = null;
        let allProcessedDataGas = null;
        
        // Workbook original (para an√°lisis)
        let originalWorkbook = null;
        
        // Nuevas estructuras para datos no encontrados (Electricidad)
        let tarifasNuevas = {}; // {nombreTarifa: {comision, tipo}}
        let comercialesNuevos = {}; // {nombreComercial: {numero, porcentaje}}
        
        // Nuevas estructuras para datos no encontrados (GAS)
        let tarifasGasNuevas = {}; // {nombreTarifa: {RL1, RL2, RL3, RL4, RL5}}
        let comercialesGasNuevos = {}; // {nombreComercial: {numero, porcentaje}}
        
        let processingPaused = false;
        let currentPendingData = null;
        
        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        
        uploadSection.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFile(e.target.files[0]);
        });
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadSection.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
        });
        
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadSection.addEventListener(eventName, () => uploadSection.classList.add('dragover'), false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            uploadSection.addEventListener(eventName, () => uploadSection.classList.remove('dragover'), false);
        });
        
        uploadSection.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFile(files[0]);
        }, false);
        
        document.getElementById('downloadBtn').addEventListener('click', downloadFile);
        document.getElementById('downloadByComercialBtn').addEventListener('click', downloadByComercial);
        document.getElementById('downloadScriptBtn').addEventListener('click', downloadScript);
        document.getElementById('downloadAnalisisBtn').addEventListener('click', () => {
            console.log('üî¥ CLICK EN BOT√ìN ANALIZAR TARIFAS');
            analizarTarifas();
        });
        
        function showStatus(msg, type) {
            const s = document.getElementById('status');
            s.textContent = msg;
            s.className = 'status ' + type;
        }
        
        function limpiarNombre(nombre) {
            return nombre.replace(/[:\\\/\?\*\[\]]/g, '-').substring(0, 31);
        }
        
        function formatearFecha(fecha) {
            if (!fecha) return '';
            if (typeof fecha === 'string' && fecha.includes('-')) {
                const d = new Date(fecha);
                if (!isNaN(d.getTime())) {
                    return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
                }
                return fecha;
            }
            if (fecha instanceof Date && !isNaN(fecha.getTime())) {
                return `${String(fecha.getDate()).padStart(2, '0')}/${String(fecha.getMonth() + 1).padStart(2, '0')}/${fecha.getFullYear()}`;
            }
            if (typeof fecha === 'number') {
                const d = new Date((fecha - 25569) * 86400 * 1000);
                return `${String(d.getUTCDate()).padStart(2, '0')}/${String(d.getUTCMonth() + 1).padStart(2, '0')}/${d.getUTCFullYear()}`;
            }
            return '';
        }
        
        async function preguntarTarifaNueva(nombreTarifa) {
            return new Promise((resolve) => {
                const comision = prompt(`‚ö†Ô∏è TARIFA NO ENCONTRADA: "${nombreTarifa}"\n\n¬øQu√© comisi√≥n debe aplicarse?\n(en ‚Ç¨/MWh)\n\nEjemplos: 15  o  18,5  o  20.5`);
                if (comision === null || comision.trim() === '') {
                    resolve(null);
                    return;
                }
                
                // Reemplazar coma por punto para parsing correcto
                const comisionNormalizada = comision.replace(',', '.');
                const comisionNum = parseFloat(comisionNormalizada);
                
                if (isNaN(comisionNum) || comisionNum <= 0) {
                    alert(`‚ö†Ô∏è Comisi√≥n inv√°lida: "${comision}"\nDebe ser un n√∫mero mayor que 0.\n\nEjemplos v√°lidos: 15, 18.5, 18,5, 20\n\nTarifa NO guardada.`);
                    resolve(null);
                    return;
                }
                
                const tipo = confirm(`Tarifa: ${nombreTarifa}\nComisi√≥n: ${comisionNum} ‚Ç¨/MWh\n\n¬øEs tipo TOTAL (100%)?\n\nOK = TOTAL (el comercial recibe el 100%)\nCancelar = REPARTO (el comercial recibe su %)`);
                
                resolve({
                    comision: comisionNum,
                    tipo: tipo ? 'TOTAL' : 'REPARTO'
                });
            });
        }
        
        async function preguntarComercialNuevo(nombreComercial) {
            return new Promise((resolve) => {
                const numero = prompt(`‚ö†Ô∏è COMERCIAL NO ENCONTRADO: "${nombreComercial}"\n\n¬øQu√© n√∫mero de comercial le asignamos?`);
                if (numero === null || numero.trim() === '') {
                    resolve(null);
                    return;
                }
                
                const porcentaje = prompt(`Comercial: ${nombreComercial}\nN√∫mero: ${numero}\n\n¬øQu√© porcentaje de comisi√≥n?\n\nEjemplos:\n- Para 30% escribe: 0.30 o 0,30\n- Para 25% escribe: 0.25 o 0,25\n- Para 35% escribe: 0.35 o 0,35`);
                if (porcentaje === null || porcentaje.trim() === '') {
                    alert('‚ö†Ô∏è Porcentaje no puede estar vac√≠o. Comercial NO guardado.');
                    resolve(null);
                    return;
                }
                
                // Reemplazar coma por punto para parsing correcto
                const porcentajeNormalizado = porcentaje.replace(',', '.');
                const porcentajeNum = parseFloat(porcentajeNormalizado);
                
                if (isNaN(porcentajeNum) || porcentajeNum <= 0) {
                    alert(`‚ö†Ô∏è Porcentaje inv√°lido: "${porcentaje}"\nDebe ser un n√∫mero mayor que 0.\n\nEjemplos v√°lidos: 0.30, 0,30, 0.25, 0,25\n\nComercial NO guardado.`);
                    resolve(null);
                    return;
                }
                
                resolve({
                    numero: parseInt(numero),
                    porcentaje: porcentajeNum
                });
            });
        }
        
        // FUNCIONES PARA GAS
        async function preguntarTarifaGasNueva(nombreTarifa, peaje) {
            return new Promise((resolve) => {
                const comision = prompt(`‚ö†Ô∏è TARIFA GAS NO ENCONTRADA: "${nombreTarifa}"\nPeaje: ${peaje}\n\n¬øQu√© comisi√≥n debe aplicarse?\n(en ‚Ç¨/MWh)\n\nEjemplos: 15  o  18,5  o  20.5`);
                if (comision === null || comision.trim() === '') {
                    resolve(null);
                    return;
                }
                
                const comisionNormalizada = comision.replace(',', '.');
                const comisionNum = parseFloat(comisionNormalizada);
                
                if (isNaN(comisionNum) || comisionNum <= 0) {
                    alert(`‚ö†Ô∏è Comisi√≥n inv√°lida: "${comision}"\nDebe ser un n√∫mero mayor que 0.\n\nTarifa GAS NO guardada.`);
                    resolve(null);
                    return;
                }
                
                resolve(comisionNum);
            });
        }
        
        async function preguntarComercialGasNuevo(nombreComercial) {
            return new Promise((resolve) => {
                const numero = prompt(`‚ö†Ô∏è COMERCIAL GAS NO ENCONTRADO: "${nombreComercial}"\n\n¬øQu√© n√∫mero de comercial le asignamos?`);
                if (numero === null || numero.trim() === '') {
                    resolve(null);
                    return;
                }
                
                const porcentaje = prompt(`Comercial GAS: ${nombreComercial}\nN√∫mero: ${numero}\n\n¬øQu√© porcentaje de comisi√≥n?\n\nEjemplos:\n- Para 30% escribe: 0.30 o 0,30\n- Para 75% escribe: 0.75 o 0,75`);
                if (porcentaje === null || porcentaje.trim() === '') {
                    alert('‚ö†Ô∏è Porcentaje no puede estar vac√≠o. Comercial GAS NO guardado.');
                    resolve(null);
                    return;
                }
                
                const porcentajeNormalizado = porcentaje.replace(',', '.');
                const porcentajeNum = parseFloat(porcentajeNormalizado);
                
                if (isNaN(porcentajeNum) || porcentajeNum <= 0) {
                    alert(`‚ö†Ô∏è Porcentaje inv√°lido: "${porcentaje}"\nComercial GAS NO guardado.`);
                    resolve(null);
                    return;
                }
                
                resolve({
                    numero: parseInt(numero),
                    porcentaje: porcentajeNum
                });
            });
        }
        
        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showStatus('‚ö†Ô∏è Archivo inv√°lido', 'error');
                return;
            }
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('downloadSection').style.display = 'none';
            document.getElementById('downloadSectionGas').style.display = 'none';
            document.getElementById('downloadSectionScript').style.display = 'none';
            document.getElementById('downloadSectionAnalisis').style.display = 'none';
            document.getElementById('statsContainer').innerHTML = '';
            document.getElementById('statsContainerGas').innerHTML = '';
            document.getElementById('status').style.display = 'none';
            document.getElementById('missingTariffs').style.display = 'none';
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                    
                    // Guardar workbook original para an√°lisis posterior
                    originalWorkbook = wb;
                    await processExcel(wb);
                    await processGas(wb);
                } catch (error) {
                    document.getElementById('loading').style.display = 'none';
                    showStatus('‚ùå Error: ' + error.message, 'error');
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        async function processExcel(wb) {
            try {
                const sheetNames = wb.SheetNames;
                const facturaSheet = wb.Sheets[sheetNames.find(n => n.toUpperCase().includes('FACTURA') || n.toUpperCase().includes('TOTAL'))];
                const datosSheet = wb.Sheets['DATOS'] || wb.Sheets['Datos'];
                const comisionesSheet = wb.Sheets['COMISIONES'] || wb.Sheets['Comisiones'];
                
                if (!facturaSheet || !datosSheet || !comisionesSheet) {
                    throw new Error('Faltan hojas necesarias');
                }
                
                const facturaData = XLSX.utils.sheet_to_json(facturaSheet);
                const datosRaw = XLSX.utils.sheet_to_json(datosSheet, { header: 1 });
                const comisionesRaw = XLSX.utils.sheet_to_json(comisionesSheet, { header: 1 });
                
                const tarifasMap = {};
                for (let i = 1; i < datosRaw.length; i++) {
                    if (datosRaw[i][0] && datosRaw[i][1] !== 'X') {
                        const tarifa = String(datosRaw[i][0]).toUpperCase().trim();
                        const comision = parseFloat(datosRaw[i][1]) || 0;
                        const tipo = datosRaw[i][2] ? String(datosRaw[i][2]).toUpperCase().trim() : null;
                        tarifasMap[tarifa] = { comision: comision, tipo: tipo };
                    }
                }
                
                const comercialesMap = {};
                const numeroComercialMap = {};
                
                for (let i = 1; i < comisionesRaw.length; i++) {
                    if (comisionesRaw[i][0]) {
                        const agente = String(comisionesRaw[i][0]).trim();
                        const agenteUpper = agente.toUpperCase();
                        const numeroComercial = comisionesRaw[i][1];
                        const porcentaje = parseFloat(comisionesRaw[i][2]) || 0;
                        
                        comercialesMap[agenteUpper] = {
                            numeroComercial: numeroComercial,
                            porcentaje: porcentaje,
                            nombreOriginal: agente
                        };
                        
                        if (!numeroComercialMap[numeroComercial]) {
                            numeroComercialMap[numeroComercial] = { nombres: [], porcentaje: porcentaje };
                        }
                        numeroComercialMap[numeroComercial].nombres.push(agente);
                    }
                }
                
                const processed = [];
                const tarifasNoEncontradas = new Set();
                
                // Resetear tarifas y comerciales nuevos
                tarifasNuevas = {};
                comercialesNuevos = {};
                
                // Cambiar forEach a for...of para poder usar await
                for (const r of facturaData) {
                    const comercial = r['Comercial'] || r['Identidad'] || '';
                    const grupoOriginal = r['Grupo'] || '';
                    const consumo = parseFloat(r['Consumo'] || 0);
                    if (!grupoOriginal || !consumo) continue;
                    
                    const grupo = String(grupoOriginal).toUpperCase().trim();
                    
                    let tarifaData = tarifasMap[grupo];
                    
                    // Primero buscar en tarifasNuevas (preguntadas previamente)
                    if (!tarifaData && tarifasNuevas[grupo]) {
                        tarifaData = tarifasNuevas[grupo];
                    }
                    
                    if (!tarifaData) {
                        // Buscar n√∫meros en el nombre de la tarifa
                        const match = grupoOriginal.match(/\b(\d+)\b/g);
                        
                        if (match) {
                            // Filtrar a√±os (2020-2099) que probablemente sean parte del nombre, no FEE
                            const numerosValidos = match.filter(num => {
                                const valor = parseInt(num);
                                return valor < 2020 || valor > 2099; // Excluir rango de a√±os
                            });
                            
                            if (numerosValidos.length > 0) {
                                // COMPORTAMIENTO ORIGINAL: Extrae n√∫mero autom√°ticamente
                                const numero = parseFloat(numerosValidos[0]);
                                let tipoAuto = 'REPARTO';
                                if (grupo.includes('INDEX PLUS') || (grupo.includes('INDEX') && grupo.includes('PLUS'))) {
                                    tipoAuto = 'TOTAL';
                                }
                                tarifaData = { comision: numero, tipo: tipoAuto };
                                tarifasNoEncontradas.add(JSON.stringify({ tarifa: grupoOriginal, comision: numero, tipo: tipoAuto, origen: 'Auto' }));
                            } else {
                                // El √∫nico n√∫mero es un a√±o - PREGUNTAR AL USUARIO
                                const respuesta = await preguntarTarifaNueva(grupoOriginal);
                                if (respuesta) {
                                    tarifasNuevas[grupo] = respuesta;
                                    tarifaData = respuesta;
                                }
                            }
                        } else {
                            // NUEVO: No hay n√∫mero - PREGUNTAR AL USUARIO
                            const respuesta = await preguntarTarifaNueva(grupoOriginal);
                            if (respuesta) {
                                tarifasNuevas[grupo] = respuesta;
                                tarifaData = respuesta;
                            }
                        }
                    }
                    
                    if (!tarifaData) continue; // Skip si usuario cancel√≥
                    
                    const comercialU = String(comercial).toUpperCase().trim();
                    let comercialInfo = comercialesMap[comercialU];
                    
                    if (!comercialInfo) {
                        // Buscar parcial
                        for (let k in comercialesMap) {
                            if (comercialU.includes(k) || k.includes(comercialU)) {
                                comercialInfo = comercialesMap[k];
                                break;
                            }
                        }
                    }
                    
                    // NUEVO: Si a√∫n no se encuentra, buscar en comercialesNuevos
                    if (!comercialInfo && comercialesNuevos[comercialU]) {
                        comercialInfo = comercialesNuevos[comercialU];
                    }
                    
                    // NUEVO: Si no existe, PREGUNTAR AL USUARIO
                    if (!comercialInfo) {
                        const respuesta = await preguntarComercialNuevo(comercial);
                        if (respuesta) {
                            comercialesNuevos[comercialU] = {
                                numeroComercial: respuesta.numero,
                                porcentaje: respuesta.porcentaje,
                                nombreOriginal: comercial
                            };
                            comercialInfo = comercialesNuevos[comercialU];
                        }
                    }
                    
                    if (!comercialInfo) continue; // Skip si usuario cancel√≥
                    
                    const numeroComercial = comercialInfo.numeroComercial;
                    const pctComercial = comercialInfo.porcentaje;
                    let pctFinal = pctComercial;
                    let tipoAplicado = tarifaData.tipo || 'REPARTO';
                    
                    if (tipoAplicado === 'TOTAL') pctFinal = 1.0;
                    
                    const consumoMWh = consumo / 1000;
                    const comision = tarifaData.comision;
                    const comisionCalculada = consumoMWh * comision * pctFinal;
                    const formulaCalculo = `(${consumo}/1000)*${comision}*${pctFinal.toFixed(2)}=${comisionCalculada.toFixed(2)} [${tipoAplicado}]`;
                    
                    const sn = String(r['Serie/Numero'] || '');
                    let serie = '', numero = sn;
                    const match = sn.match(/([A-Z]+)\s*(\d+)/);
                    if (match) { serie = match[1]; numero = match[2]; }
                    
                    processed.push({
                        'X': 'SigeCom.DTO.TablasMaestras.AgenteComisionDetailsDTO',
                        'Agente': comercial,
                        'Tipo Comision': 'Importe ‚Ç¨ kWh facturado',
                        'Fecha': '',
                        'Comisi√≥n': parseFloat(comisionCalculada.toFixed(2)),
                        'Serie': serie,
                        'Numero': numero,
                        'Importe Base': consumo,
                        'C√≥digo Contrato': r['Contrato'] || '',
                        'Fecha Activaci√≥n': '',
                        'CUPS': r['CUPS'] || '',
                        'Identidad': r['Identidad'] || '',
                        'Fecha Contrataci√≥n': formatearFecha(r['Fecha Factura']),
                        'Fecha Desde': formatearFecha(r['Fecha Inicio Suministro']),
                        'Fecha Hasta': formatearFecha(r['Fecha Fin Suministro']),
                        'Grupo': grupoOriginal,
                        'Cliente': r['Cliente'] || '',
                        'Direcci√≥n': r['Direcci√≥n'] || '',
                        'Tarifa Peaje': r['Tarifa Peaje'] || '',
                        'Tarifa': r['Tarifa'] || '',
                        'F√≥rmula C√°lculo': formulaCalculo,
                        '_numComercial': numeroComercial,
                        '_agente': comercial
                    });
                }
                
                // Mostrar tarifas no encontradas
                if (tarifasNoEncontradas.size > 0 || Object.keys(tarifasNuevas).length > 0) {
                    const missingDiv = document.getElementById('missingTariffs');
                    const missingList = document.getElementById('missingList');
                    missingList.innerHTML = '';
                    
                    // Tarifas autom√°ticas (negro)
                    tarifasNoEncontradas.forEach(t => {
                        const obj = JSON.parse(t);
                        const li = document.createElement('li');
                        li.textContent = `${obj.tarifa} ‚Üí ${obj.comision} [${obj.tipo}]`;
                        missingList.appendChild(li);
                    });
                    
                    // Tarifas preguntadas (rojo)
                    for (const [nombre, data] of Object.entries(tarifasNuevas)) {
                        const li = document.createElement('li');
                        li.textContent = `${nombre} ‚Üí ${data.comision} [${data.tipo}] ‚ö†Ô∏è MANUAL`;
                        li.style.color = 'red';
                        li.style.fontWeight = 'bold';
                        missingList.appendChild(li);
                    }
                    
                    missingDiv.style.display = 'block';
                }
                
                processed.sort((a, b) => {
                    const numComp = (a._numComercial || 0) - (b._numComercial || 0);
                    if (numComp !== 0) return numComp;
                    return a._agente.localeCompare(b._agente);
                });
                
                const groups = {};
                processed.forEach(r => {
                    const numCom = r._numComercial;
                    if (!groups[numCom]) groups[numCom] = [];
                    groups[numCom].push(r);
                });
                
                processedDataByGroup = groups;
                allProcessedData = { numeroComercialMap, tarifasNoEncontradas };
                
                const final = [];
                const resumen = [];
                let currentRow = 2;
                
                Object.keys(groups).sort((a, b) => parseInt(a) - parseInt(b)).forEach(numCom => {
                    const rows = groups[numCom];
                    const startRow = currentRow;
                    
                    rows.forEach(r => {
                        delete r._numComercial;
                        delete r._agente;
                        final.push(r);
                        currentRow++;
                    });
                    
                    const endRow = currentRow - 1;
                    
                    const nombresGrupo = numeroComercialMap[numCom] ? numeroComercialMap[numCom].nombres : [];
                    const nombrePrincipal = nombresGrupo.length > 0 ? nombresGrupo[0] : 'Comercial ' + numCom;
                    
                    const sub = rows.reduce((s, r) => s + (parseFloat(r['Comisi√≥n']) || 0), 0);
                    resumen.push({ numeroComercial: numCom, nombre: nombrePrincipal, subtotal: sub });
                    
                    final.push({});
                    currentRow++;
                    final.push({});
                    currentRow++;
                    
                    final.push({
                        'X': '',
                        'Agente': 'SUBTOTAL ' + nombrePrincipal,
                        'Comisi√≥n': { f: `SUM(E${startRow}:E${endRow})` }
                    });
                    currentRow++;
                    
                    final.push({
                        'X': '',
                        'Agente': 'SUBTOTAL CON IVA ' + nombrePrincipal,
                        'Comisi√≥n': { f: `1.21*SUM(E${startRow}:E${endRow})` }
                    });
                    currentRow++;
                    
                    final.push({});
                    currentRow++;
                    final.push({});
                    currentRow++;
                });
                
                const total = resumen.reduce((s, a) => s + a.subtotal, 0);
                const totalIVA = total * 1.21;
                
                // Crear HOJA SEPARADA para el resumen usando array de arrays
                const resumenData = [];
                
                // Fila 1: T√≠tulo en columna A
                resumenData.push(['=== RESUMEN (SIN IVA) ===']);
                
                // Fila 2: Vac√≠a
                resumenData.push([]);
                
                // Filas 3+: Datos (A=Nombre, B=Comisi√≥n, C=N√∫mero)
                const rowInicioResumen = 3;
                resumen.sort((a, b) => parseInt(a.numeroComercial) - parseInt(b.numeroComercial));
                resumen.forEach(i => {
                    resumenData.push([
                        i.nombre,                                    // Columna A
                        parseFloat(i.subtotal.toFixed(2)),          // Columna B (n√∫mero puro sin ‚Ç¨)
                        i.numeroComercial                            // Columna C

                    ]);
                });
                const rowFinResumen = rowInicioResumen + resumen.length - 1;
                
                // L√≠neas vac√≠as
                resumenData.push([]);
                resumenData.push([]);
                
                // TOTAL GENERAL en columna B
                const rowTotalGeneral = rowFinResumen + 3;
                resumenData.push([
                    'TOTAL GENERAL:',                       // Columna A
                    { f: `SUM(B${rowInicioResumen}:B${rowFinResumen})` }  // Columna B (f√≥rmula)
                ]);
                
                // TOTAL CON IVA en columna B
                resumenData.push([
                    'TOTAL CON IVA:',                       // Columna A
                    { f: `B${rowTotalGeneral}*1.21` }      // Columna B (f√≥rmula)
                ]);
                
                const newWb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(final, { cellFormula: true });
                XLSX.utils.book_append_sheet(newWb, ws, 'Detalle');
                
                // A√±adir hoja de resumen desde array de arrays
                const wsResumen = XLSX.utils.aoa_to_sheet(resumenData);
                
                // Aplicar formato de moneda ‚Ç¨ a la columna B
                const rangeResumen = XLSX.utils.decode_range(wsResumen['!ref']);
                for (let R = 2; R <= rangeResumen.e.r; R++) { // Desde fila 3 (√≠ndice 2)
                    const cellAddress = XLSX.utils.encode_cell({ r: R, c: 1 }); // Columna B (√≠ndice 1)
                    if (wsResumen[cellAddress] && typeof wsResumen[cellAddress].v === 'number') {
                        wsResumen[cellAddress].z = '#,##0.00 "‚Ç¨"'; // Formato moneda con ‚Ç¨
                    }
                }
                
                XLSX.utils.book_append_sheet(newWb, wsResumen, 'Resumen');
                
                // Hoja de tarifas no encontradas (incluye autom√°ticas y manuales)
                if (tarifasNoEncontradas.size > 0 || Object.keys(tarifasNuevas).length > 0) {
                    const tarifasFaltantes = [];
                    
                    // Tarifas autom√°ticas (con n√∫mero extra√≠do)
                    tarifasNoEncontradas.forEach(t => {
                        const obj = JSON.parse(t);
                        tarifasFaltantes.push({
                            'Tarifa': obj.tarifa,
                            'Comisi√≥n': obj.comision,
                            'Tipo': obj.tipo,
                            'Origen': 'Auto',
                            '_estilo': 'normal'
                        });
                    });
                    
                    // Tarifas manuales (preguntadas al usuario) - MARCAR EN ROJO
                    for (const [nombre, data] of Object.entries(tarifasNuevas)) {
                        tarifasFaltantes.push({
                            'Tarifa': nombre,
                            'Comisi√≥n': data.comision,
                            'Tipo': data.tipo,
                            'Origen': '‚ö†Ô∏è MANUAL',
                            '_estilo': 'rojo'
                        });
                    }
                    
                    const wsMissing = XLSX.utils.json_to_sheet(tarifasFaltantes);
                    
                    // Aplicar formato rojo a filas manuales
                    const range = XLSX.utils.decode_range(wsMissing['!ref']);
                    for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                        const origenAddr = XLSX.utils.encode_cell({r: R, c: 3});
                        const origenCell = wsMissing[origenAddr];
                        
                        if (origenCell && origenCell.v && origenCell.v.includes('MANUAL')) {
                            // Colorear toda la fila en rojo
                            for (let C = range.s.c; C <= range.e.c; ++C) {
                                const cellAddr = XLSX.utils.encode_cell({r: R, c: C});
                                if (!wsMissing[cellAddr]) {
                                    wsMissing[cellAddr] = {t: 's', v: ''};
                                }
                                if (!wsMissing[cellAddr].s) {
                                    wsMissing[cellAddr].s = {};
                                }
                                wsMissing[cellAddr].s = {
                                    fill: {fgColor: {rgb: "FFFF0000"}},
                                    font: {color: {rgb: "FFFFFFFF"}, bold: true}
                                };
                            }
                        }
                    }
                    
                    XLSX.utils.book_append_sheet(newWb, wsMissing, 'TARIFAS_NO_ENCONTRADAS');
                }
                
                // Hoja de comerciales no encontrados (solo manuales)
                if (Object.keys(comercialesNuevos).length > 0) {
                    const comercialesFaltantes = [];
                    
                    for (const [nombre, data] of Object.entries(comercialesNuevos)) {
                        comercialesFaltantes.push({
                            'Comercial': data.nombreOriginal || nombre,
                            'N√∫mero': data.numeroComercial,
                            'Porcentaje': data.porcentaje
                        });
                    }
                    
                    const wsComerciales = XLSX.utils.json_to_sheet(comercialesFaltantes);
                    
                    // Colorear TODO en rojo (son todos manuales)
                    const range = XLSX.utils.decode_range(wsComerciales['!ref']);
                    for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                        for (let C = range.s.c; C <= range.e.c; ++C) {
                            const cellAddr = XLSX.utils.encode_cell({r: R, c: C});
                            if (!wsComerciales[cellAddr]) {
                                wsComerciales[cellAddr] = {t: 's', v: ''};
                            }
                            if (!wsComerciales[cellAddr].s) {
                                wsComerciales[cellAddr].s = {};
                            }
                            wsComerciales[cellAddr].s = {
                                fill: {fgColor: {rgb: "FFFF0000"}},
                                font: {color: {rgb: "FFFFFFFF"}, bold: true}
                            };
                        }
                    }
                    
                    XLSX.utils.book_append_sheet(newWb, wsComerciales, 'COMERCIALES_NO_ENCONTRADOS');
                }
                
                processedWorkbook = newWb;
                
                document.getElementById('statsContainer').innerHTML = `
                    <div class="stats">
                        <div class="stat-card"><h3>${processed.length}</h3><p>Facturas</p></div>
                        <div class="stat-card"><h3>${Object.keys(groups).length}</h3><p>Comerciales</p></div>
                        <div class="stat-card"><h3>${tarifasNoEncontradas.size}</h3><p>Extra√≠das</p></div>
                        <div class="stat-card"><h3>${total.toFixed(2)}‚Ç¨</h3><p>Total</p></div>
                    </div>
                `;
                
                document.getElementById('loading').style.display = 'none';
                showStatus(`‚úÖ ${processed.length} facturas procesadas`, 'success');
                document.getElementById('downloadSection').style.display = 'block';
                document.getElementById('downloadSectionScript').style.display = 'block';
                document.getElementById('downloadSectionAnalisis').style.display = 'block';
                
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                showStatus('‚ùå Error: ' + error.message, 'error');
                console.error(error);
            }
        }

        // ========================================
        // PROCESAMIENTO DE GAS - FASE 1
        // ========================================
        
        async function processGas(wb) {
            try {
                console.log('üîç Iniciando procesamiento de GAS...');
                const sheetNames = wb.SheetNames;
                console.log('üìã Hojas disponibles:', sheetNames);
                
                const datosGasSheet = wb.Sheets['DATOSGAS'] || wb.Sheets['DatosGas'] || wb.Sheets['datosgas'];
                const comercialesGasSheet = wb.Sheets['COMERCIALESGAS'] || wb.Sheets['ComercialesGas'] || wb.Sheets['comercialesgas'];
                const facturasGasSheet = wb.Sheets[sheetNames.find(n => n.toUpperCase().includes('FACTURASGAS') || n.toUpperCase().includes('FACTURAS GAS'))];
                
                console.log('‚úì DATOSGAS:', datosGasSheet ? 'Encontrada' : 'NO encontrada');
                console.log('‚úì COMERCIALESGAS:', comercialesGasSheet ? 'Encontrada' : 'NO encontrada');
                console.log('‚úì FACTURASGAS:', facturasGasSheet ? 'Encontrada' : 'NO encontrada');
                
                if (!facturasGasSheet) {
                    console.log('‚ÑπÔ∏è No se encontr√≥ hoja FACTURASGAS - GAS no procesado');
                    showStatus('‚ÑπÔ∏è Solo se proces√≥ ELECTRICIDAD (no se encontr√≥ FACTURASGAS)', 'success');
                    return null;
                }
                
                // Procesar DATOSGAS
                const tarifasGasMap = {};
                if (datosGasSheet) {
                    const datosGasRaw = XLSX.utils.sheet_to_json(datosGasSheet, { header: 1 });
                    console.log('üìä DATOSGAS filas:', datosGasRaw.length);
                    
                    for (let i = 1; i < datosGasRaw.length; i++) {
                        const row = datosGasRaw[i];
                        if (!row[0]) continue;
                        
                        const tarifa = String(row[0]).toUpperCase().trim();
                        tarifasGasMap[tarifa] = {
                            'RL.1': parseFloat(row[1]) || 0,
                            'RL. 1': parseFloat(row[1]) || 0,
                            'RL1': parseFloat(row[1]) || 0,
                            'RL.2': parseFloat(row[2]) || 0,
                            'RL. 2': parseFloat(row[2]) || 0,
                            'RL2': parseFloat(row[2]) || 0,
                            'RL.3': parseFloat(row[3]) || 0,
                            'RL. 3': parseFloat(row[3]) || 0,
                            'RL3': parseFloat(row[3]) || 0,
                            'RL.4': parseFloat(row[4]) || 0,
                            'RL. 4': parseFloat(row[4]) || 0,
                            'RL4': parseFloat(row[4]) || 0,
                            'RL.5': parseFloat(row[5]) || 0,
                            'RL. 5': parseFloat(row[5]) || 0,
                            'RL5': parseFloat(row[5]) || 0
                        };
                    }
                    console.log('‚úì Tarifas GAS cargadas:', Object.keys(tarifasGasMap).length);
                    console.log('üìã Tarifas:', Object.keys(tarifasGasMap));
                }
                
                // Procesar COMERCIALESGAS
                const comercialesGasMap = {};
                const numeroComercialGasMap = {};
                
                if (comercialesGasSheet) {
                    const comercialesGasRaw = XLSX.utils.sheet_to_json(comercialesGasSheet, { header: 1 });
                    
                    for (let i = 1; i < comercialesGasRaw.length; i++) {
                        const row = comercialesGasRaw[i];
                        if (!row[0]) continue;
                        
                        const agente = String(row[0]).toUpperCase().trim();
                        const numeroComercial = row[1];
                        const porcentaje = parseFloat(row[2]) || 0;
                        
                        let numero;
                        if (typeof numeroComercial === 'number') {
                            numero = String(Math.floor(numeroComercial)).padStart(2, '0');
                        } else {
                            const nums = String(numeroComercial).match(/\d+/);
                            numero = nums ? String(parseInt(nums[0])).padStart(2, '0') : '00';
                        }
                        
                        comercialesGasMap[agente] = {
                            numeroComercial: numero,
                            porcentaje: porcentaje,
                            nombreOriginal: row[0]
                        };
                        
                        if (!numeroComercialGasMap[numero]) {
                            numeroComercialGasMap[numero] = { nombres: [], porcentaje: porcentaje };
                        }
                        numeroComercialGasMap[numero].nombres.push(row[0]);
                    }
                }
                
                // Procesar FACTURASGAS
                const facturaGasData = XLSX.utils.sheet_to_json(facturasGasSheet);
                console.log('üìã FACTURASGAS filas:', facturaGasData.length);
                
                const processedGas = [];
                const tarifasGasNoEncontradas = new Set();
                
                tarifasGasNuevas = {};
                comercialesGasNuevos = {};
                
                const formatearFecha = (fecha) => {
                    if (!fecha) return '';
                    if (fecha instanceof Date) {
                        return fecha.toLocaleDateString('es-ES');
                    }
                    return String(fecha);
                };
                
                for (const r of facturaGasData) {
                    const comercial = r['Comercial'] || r['Identidad'] || '';
                    const grupoOriginal = r['Grupo'] || '';
                    const tarifaPeaje = r['Tarifa Peaje'] || r['TarifaPeaje'] || '';
                    const consumo = parseFloat(r['Consumo'] || 0);
                    
                    if (!grupoOriginal || !consumo || !tarifaPeaje) continue;
                    
                    // Normalizar grupo: eliminar n√∫mero del final (ej: "Sport HI Index 1" ‚Üí "Sport HI Index")
                    let grupoLimpio = String(grupoOriginal).trim();
                    grupoLimpio = grupoLimpio.replace(/\s+\d+$/, ''); // Eliminar " 1", " 2", etc. del final
                    const grupo = grupoLimpio.toUpperCase().trim();
                    
                    const peaje = String(tarifaPeaje).toUpperCase().trim();
                    
                    // DEBUG: Log de primera factura para ver qu√© busca
                    if (processedGas.length === 0) {
                        console.log('üîç Primera factura GAS:');
                        console.log('  Grupo original:', grupoOriginal);
                        console.log('  Grupo limpio:', grupoLimpio);
                        console.log('  Grupo normalizado:', grupo);
                        console.log('  Peaje original:', tarifaPeaje);
                        console.log('  Peaje normalizado:', peaje);
                        console.log('  ¬øExiste en mapa?', tarifasGasMap[grupo] ? 'S√ç' : 'NO');
                        if (tarifasGasMap[grupo]) {
                            console.log('  Comisi√≥n para peaje:', tarifasGasMap[grupo][peaje]);
                        }
                    }
                    
                    let comisionBase = 0;
                    let tarifaData = tarifasGasMap[grupo];
                    
                    if (tarifaData) {
                        comisionBase = tarifaData[peaje] || 0;
                    } else {
                        // Buscar en tarifas ya preguntadas
                        const key = `${grupo}|${peaje}`;
                        if (tarifasGasNuevas[key]) {
                            comisionBase = tarifasGasNuevas[key];
                        } else {
                            // PREGUNTAR al usuario
                            const respuesta = await preguntarTarifaGasNueva(grupoOriginal, tarifaPeaje);
                            if (respuesta) {
                                tarifasGasNuevas[key] = respuesta;
                                comisionBase = respuesta;
                            } else {
                                // Usuario cancel√≥ - usar 0
                                comisionBase = 0;
                            }
                        }
                        
                        tarifasGasNoEncontradas.add(JSON.stringify({ 
                            tarifa: grupoOriginal, 
                            peaje: peaje 
                        }));
                    }
                    
                    const comercialU = String(comercial).toUpperCase().trim();
                    let comercialInfo = comercialesGasMap[comercialU];
                    
                    if (!comercialInfo) {
                        for (let k in comercialesGasMap) {
                            if (comercialU.includes(k) || k.includes(comercialU)) {
                                comercialInfo = comercialesGasMap[k];
                                break;
                            }
                        }
                    }
                    
                    // Buscar en comerciales ya preguntados
                    if (!comercialInfo && comercialesGasNuevos[comercialU]) {
                        comercialInfo = comercialesGasNuevos[comercialU];
                    }
                    
                    // PREGUNTAR al usuario si no existe
                    if (!comercialInfo) {
                        const respuesta = await preguntarComercialGasNuevo(comercial);
                        if (respuesta) {
                            comercialesGasNuevos[comercialU] = {
                                numeroComercial: String(respuesta.numero).padStart(2, '0'),
                                porcentaje: respuesta.porcentaje,
                                nombreOriginal: comercial
                            };
                            comercialInfo = comercialesGasNuevos[comercialU];
                            
                            // Actualizar mapa para resumen
                            if (!numeroComercialGasMap[comercialInfo.numeroComercial]) {
                                numeroComercialGasMap[comercialInfo.numeroComercial] = { nombres: [], porcentaje: respuesta.porcentaje };
                            }
                            numeroComercialGasMap[comercialInfo.numeroComercial].nombres.push(comercial);
                        } else {
                            // Usuario cancel√≥ - usar valores por defecto
                            comercialInfo = {
                                numeroComercial: '00',
                                porcentaje: 0,
                                nombreOriginal: comercial
                            };
                        }
                    }
                    
                    const numeroComercial = comercialInfo.numeroComercial;
                    const pctComercial = comercialInfo.porcentaje;
                    
                    const consumoMWh = consumo / 1000;
                    const comisionCalculada = consumoMWh * comisionBase * pctComercial;
                    const formulaCalculo = `(${consumo}/1000)*${comisionBase}*${pctComercial.toFixed(2)}=${comisionCalculada.toFixed(2)} [GAS]`;
                    
                    const serieNumero = r['Serie/Numero'] || r['Serie'] || '';
                    let serie = '', numero = '';
                    const match = String(serieNumero).match(/^([A-Z]+)(\d+)$/i);
                    if (match) { 
                        serie = match[1]; 
                        numero = match[2]; 
                    }
                    
                    processedGas.push({
                        'X': 'SigeCom.DTO.TablasMaestras.AgenteComisionDetailsDTO',
                        'Agente': 'GAS-' + comercial,
                        'Tipo Comision': 'Importe ‚Ç¨ kWh facturado',
                        'Fecha': '',
                        'Comisi√≥n': parseFloat(comisionCalculada.toFixed(2)),
                        'Serie': serie,
                        'Numero': numero,
                        'Importe Base': consumo,
                        'C√≥digo Contrato': r['Contrato'] || '',
                        'Fecha Activaci√≥n': '',
                        'CUPS': r['CUPS'] || '',
                        'Identidad': r['Identidad'] || '',
                        'Fecha Contrataci√≥n': formatearFecha(r['Fecha Factura']),
                        'Fecha Desde': formatearFecha(r['Fecha Inicio Suministro']),
                        'Fecha Hasta': formatearFecha(r['Fecha Fin Suministro']),
                        'Grupo': grupoOriginal,
                        'Cliente': r['Cliente'] || '',
                        'Direcci√≥n': r['Direcci√≥n'] || '',
                        'Tarifa Peaje': tarifaPeaje,
                        'Tarifa': r['Tarifa'] || '',
                        'F√≥rmula C√°lculo': formulaCalculo,
                        '_numComercial': numeroComercial,
                        '_agente': comercial
                    });
                }
                
                console.log('‚úÖ Facturas GAS procesadas:', processedGas.length);
                console.log('‚ö†Ô∏è Tarifas no encontradas:', tarifasGasNoEncontradas.size);
                
                if (processedGas.length === 0) {
                    console.log('‚ùå No se proces√≥ ninguna factura de GAS');
                    showStatus('‚ö†Ô∏è No se procesaron facturas de GAS', 'error');
                    return null;
                }
                
                processedGas.sort((a, b) => {
                    const numComp = (a._numComercial || 0) - (b._numComercial || 0);
                    if (numComp !== 0) return numComp;
                    return a._agente.localeCompare(b._agente);
                });
                
                const groupsGas = {};
                processedGas.forEach(r => {
                    const numCom = r._numComercial;
                    if (!groupsGas[numCom]) groupsGas[numCom] = [];
                    groupsGas[numCom].push(r);
                });
                
                const finalGas = [];
                const resumenGas = [];
                let currentRow = 2;
                
                Object.keys(groupsGas).sort((a, b) => parseInt(a) - parseInt(b)).forEach(numCom => {
                    const rows = groupsGas[numCom];
                    const startRow = currentRow;
                    
                    rows.forEach(r => {
                        delete r._numComercial;
                        delete r._agente;
                        finalGas.push(r);
                        currentRow++;
                    });
                    
                    const endRow = currentRow - 1;
                    const nombrePrincipal = numeroComercialGasMap[numCom]?.nombres[0] || 'Comercial ' + numCom;
                    const subtotal = rows.reduce((sum, r) => sum + (r['Comisi√≥n'] || 0), 0);
                    
                    resumenGas.push({
                        numeroComercial: numCom,
                        nombre: nombrePrincipal,
                        subtotal: subtotal
                    });
                    
                    finalGas.push({});
                    currentRow++;
                    finalGas.push({});
                    currentRow++;
                    
                    finalGas.push({
                        'X': '',
                        'Agente': 'SUBTOTAL ' + nombrePrincipal,
                        'Comisi√≥n': { f: `SUM(E${startRow}:E${endRow})` }
                    });
                    currentRow++;
                    
                    finalGas.push({
                        'X': '',
                        'Agente': 'SUBTOTAL CON IVA ' + nombrePrincipal,
                        'Comisi√≥n': { f: `1.21*SUM(E${startRow}:E${endRow})` }
                    });
                    currentRow++;
                    
                    finalGas.push({});
                    currentRow++;
                    finalGas.push({});
                    currentRow++;
                });
                
                const resumenGasData = [];
                resumenGasData.push(['=== RESUMEN GAS (SIN IVA) ===']);
                resumenGasData.push([]);
                
                const rowInicioResumenGas = 3;
                resumenGas.sort((a, b) => parseInt(a.numeroComercial) - parseInt(b.numeroComercial));
                resumenGas.forEach(i => {
                    resumenGasData.push([
                        i.nombre,
                        parseFloat(i.subtotal.toFixed(2)),
                        i.numeroComercial
                    ]);
                });
                const rowFinResumenGas = rowInicioResumenGas + resumenGas.length - 1;
                
                resumenGasData.push([]);
                resumenGasData.push([]);
                
                const rowTotalGeneralGas = rowFinResumenGas + 3;
                resumenGasData.push([
                    'TOTAL GENERAL:',
                    { f: `SUM(B${rowInicioResumenGas}:B${rowFinResumenGas})` }
                ]);
                
                resumenGasData.push([
                    'TOTAL CON IVA:',
                    { f: `B${rowTotalGeneralGas}*1.21` }
                ]);
                
                const newWbGas = XLSX.utils.book_new();
                const wsGas = XLSX.utils.json_to_sheet(finalGas, { cellFormula: true });
                XLSX.utils.book_append_sheet(newWbGas, wsGas, 'Detalle GAS');
                
                const wsResumenGas = XLSX.utils.aoa_to_sheet(resumenGasData);
                const rangeResumenGas = XLSX.utils.decode_range(wsResumenGas['!ref']);
                for (let R = 2; R <= rangeResumenGas.e.r; R++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: R, c: 1 });
                    if (wsResumenGas[cellAddress] && typeof wsResumenGas[cellAddress].v === 'number') {
                        wsResumenGas[cellAddress].z = '#,##0.00 "‚Ç¨"';
                    }
                }
                XLSX.utils.book_append_sheet(newWbGas, wsResumenGas, 'Resumen GAS');
                
                if (tarifasGasNoEncontradas.size > 0) {
                    const tarifasFaltantes = Array.from(tarifasGasNoEncontradas).map(t => {
                        const obj = JSON.parse(t);
                        return { 
                            'Tarifa': obj.tarifa, 
                            'Peaje': obj.peaje,
                            'Estado': 'Pendiente'
                        };
                    });
                    const wsMissing = XLSX.utils.json_to_sheet(tarifasFaltantes);
                    XLSX.utils.book_append_sheet(newWbGas, wsMissing, 'TARIFAS_GAS_NO_ENCONTRADAS');
                }
                
                processedWorkbookGas = newWbGas;
                processedDataByGroupGas = groupsGas;
                allProcessedDataGas = { numeroComercialGasMap, tarifasGasNoEncontradas };
                
                // Calcular total GAS
                const totalGas = resumenGas.reduce((s, a) => s + a.subtotal, 0);
                
                // Mostrar estad√≠sticas de GAS
                document.getElementById('statsContainerGas').innerHTML = `
                    <div class="stats" style="margin-top: 20px;">
                        <div class="stat-card" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);"><h3>${processedGas.length}</h3><p>Facturas GAS</p></div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);"><h3>${Object.keys(groupsGas).length}</h3><p>Comerciales</p></div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);"><h3>${tarifasGasNoEncontradas.size}</h3><p>Tarifas pendientes</p></div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);"><h3>${totalGas.toFixed(2)}‚Ç¨</h3><p>Total GAS</p></div>
                    </div>
                `;
                
                showStatus('‚úÖ GAS procesado: ' + processedGas.length + ' facturas', 'success');
                document.getElementById('downloadSectionGas').style.display = 'block';
                document.getElementById('downloadSectionScript').style.display = 'block';
                document.getElementById('downloadSectionAnalisis').style.display = 'block';
                
                return newWbGas;
                
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                showStatus('‚ùå Error procesando GAS: ' + error.message, 'error');
                console.error(error);
                return null;
            }
        }
        
        function downloadFile() {
            if (!processedWorkbook) return;
            XLSX.writeFile(processedWorkbook, 'Comisiones_Completo_' + new Date().toISOString().split('T')[0] + '.xlsx');
            showStatus('‚úÖ Excel completo descargado', 'success');
        }
        
        function downloadExcelGas() {
            if (!processedWorkbookGas) {
                showStatus('‚ö†Ô∏è No hay datos de GAS procesados', 'error');
                return;
            }
            
            const timestamp = new Date().toISOString().split('T')[0];
            XLSX.writeFile(processedWorkbookGas, `Liquidaciones_GAS_${timestamp}.xlsx`);
            showStatus('‚úÖ Excel GAS descargado', 'success');
        }
        
        async function downloadByComercialGas() {
            console.log('üîç downloadByComercialGas llamada');
            console.log('processedDataByGroupGas:', processedDataByGroupGas);
            
            if (!processedDataByGroupGas) {
                showStatus('‚ùå No hay datos de GAS procesados', 'error');
                return;
            }
            
            try {
                showStatus('‚è≥ Generando archivos GAS por comercial...', 'success');
                
                const zip = new JSZip();
                const { numeroComercialGasMap } = allProcessedDataGas;
                
                Object.keys(processedDataByGroupGas).sort((a, b) => parseInt(a) - parseInt(b)).forEach(numCom => {
                    const rows = processedDataByGroupGas[numCom];
                    const nombresGrupo = numeroComercialGasMap[numCom] ? numeroComercialGasMap[numCom].nombres : [];
                    let nombrePrincipal = nombresGrupo.length > 0 ? nombresGrupo[0] : 'Comercial_' + numCom;
                    
                    // Limpiar prefijo GAS- si existe
                    nombrePrincipal = nombrePrincipal.replace(/^GAS-/, '');
                    
                    const comercialData = [];
                    let currentRow = 2;
                    const startRow = currentRow;
                    
                    rows.forEach(r => {
                        const cleanRow = { ...r };
                        delete cleanRow._numComercial;
                        delete cleanRow._agente;
                        delete cleanRow['F√≥rmula C√°lculo']; // Ocultar f√≥rmula al comercial
                        comercialData.push(cleanRow);
                        currentRow++;
                    });
                    
                    const endRow = currentRow - 1;
                    
                    comercialData.push({});
                    currentRow++;
                    comercialData.push({});
                    currentRow++;
                    
                    comercialData.push({
                        'X': '',
                        'Agente': 'SUBTOTAL GAS ' + nombrePrincipal,
                        'Comisi√≥n': { f: `SUM(E${startRow}:E${endRow})` }
                    });
                    currentRow++;
                    
                    comercialData.push({
                        'X': '',
                        'Agente': 'SUBTOTAL GAS CON IVA ' + nombrePrincipal,
                        'Comisi√≥n': { f: `1.21*SUM(E${startRow}:E${endRow})` }
                    });
                    
                    const wb = XLSX.utils.book_new();
                    // Limitar nombre para dejar espacio al sufijo '_GAS' (31 - 4 = 27)
                    const nombreHojaBase = limpiarNombre(nombrePrincipal).substring(0, 27);
                    const ws = XLSX.utils.json_to_sheet(comercialData, { cellFormula: true });
                    XLSX.utils.book_append_sheet(wb, ws, nombreHojaBase + '_GAS');
                    
                    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                    const nombreArchivoLimpio = `${String(numCom).padStart(2, '0')}_${nombrePrincipal.replace(/[^a-zA-Z0-9-]/g, '_')}_GAS`;
                    const fileName = `${nombreArchivoLimpio}.xlsx`;
                    
                    zip.file(fileName, wbout);
                });
                
                showStatus('‚è≥ Comprimiendo ZIP GAS...', 'success');
                const content = await zip.generateAsync({ type: 'blob' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = 'Comisiones_GAS_Por_Comercial_' + new Date().toISOString().split('T')[0] + '.zip';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatus('‚úÖ ZIP GAS descargado correctamente', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showStatus('‚ùå Error: ' + error.message, 'error');
            }
        }
        
        async function downloadByComercial() {
            if (!processedDataByGroup) {
                showStatus('‚ùå No hay datos procesados', 'error');
                return;
            }
            
            try {
                showStatus('‚è≥ Generando archivos por comercial...', 'success');
                
                const zip = new JSZip();
                const { numeroComercialMap } = allProcessedData;
                
                Object.keys(processedDataByGroup).sort((a, b) => parseInt(a) - parseInt(b)).forEach(numCom => {
                    const rows = processedDataByGroup[numCom];
                    const nombresGrupo = numeroComercialMap[numCom] ? numeroComercialMap[numCom].nombres : [];
                    const nombrePrincipal = nombresGrupo.length > 0 ? nombresGrupo[0] : 'Comercial_' + numCom;
                    
                    const comercialData = [];
                    let currentRow = 2;
                    const startRow = currentRow;
                    
                    rows.forEach(r => {
                        const cleanRow = { ...r };
                        delete cleanRow._numComercial;
                        delete cleanRow._agente;
                        delete cleanRow['F√≥rmula C√°lculo']; // Ocultar f√≥rmula al comercial
                        comercialData.push(cleanRow);
                        currentRow++;
                    });
                    
                    const endRow = currentRow - 1;
                    
                    comercialData.push({});
                    currentRow++;
                    comercialData.push({});
                    currentRow++;
                    
                    comercialData.push({
                        'X': '',
                        'Agente': 'SUBTOTAL ' + nombrePrincipal,
                        'Comisi√≥n': { f: `SUM(E${startRow}:E${endRow})` }
                    });
                    currentRow++;
                    
                    comercialData.push({
                        'X': '',
                        'Agente': 'SUBTOTAL CON IVA ' + nombrePrincipal,
                        'Comisi√≥n': { f: `1.21*SUM(E${startRow}:E${endRow})` }
                    });
                    
                    const wb = XLSX.utils.book_new();
                    const nombreHojaLimpio = limpiarNombre(nombrePrincipal);
                    const ws = XLSX.utils.json_to_sheet(comercialData, { cellFormula: true });
                    XLSX.utils.book_append_sheet(wb, ws, nombreHojaLimpio);
                    
                    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                    const nombreArchivoLimpio = `${String(numCom).padStart(2, '0')}_${nombrePrincipal.replace(/[^a-zA-Z0-9-]/g, '_')}`;
                    const fileName = `${nombreArchivoLimpio}.xlsx`;
                    
                    zip.file(fileName, wbout);
                });
                
                showStatus('‚è≥ Comprimiendo ZIP...', 'success');
                const content = await zip.generateAsync({ type: 'blob' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = 'Comisiones_Por_Comercial_' + new Date().toISOString().split('T')[0] + '.zip';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatus('‚úÖ ZIP descargado correctamente', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showStatus('‚ùå Error: ' + error.message, 'error');
            }
        }
        
        function downloadScript() {
            const scriptContent = `-- SCRIPT AUTOM√ÅTICO OUTLOOK - ELECTRICIDAD + GAS
-- Busca y adjunta archivos de electricidad y/o gas seg√∫n disponibilidad

set carpetaDescargas to (path to downloads folder as text)

try
    set rutaDescargas to POSIX path of carpetaDescargas
    
    -- Buscar ZIPs m√°s recientes
    set comandoBuscarZIPElec to "find " & quoted form of rutaDescargas & " -name 'Comisiones_Por_Comercial_*.zip' -type f -mtime -1 | grep -v GAS | head -1"
    set archivoZIPElec to do shell script comandoBuscarZIPElec
    
    set comandoBuscarZIPGas to "find " & quoted form of rutaDescargas & " -name 'Comisiones_GAS_Por_Comercial_*.zip' -type f -mtime -1 | head -1"
    set archivoZIPGas to do shell script comandoBuscarZIPGas
    
    if archivoZIPElec is "" and archivoZIPGas is "" then
        display dialog "‚ùå No se encontraron ZIPs de comisiones.

Por favor descarga:
- ZIP Electricidad (bot√≥n rosa)
- ZIP Gas (bot√≥n rojo)

Y ejecuta este script de nuevo." buttons {"OK"} with icon stop
        return
    end if
    
    -- Buscar Excel de comisiones
    set comandoBuscarExcel to "find " & quoted form of rutaDescargas & " -maxdepth 1 -iname '*comision*.xlsx' -type f -mtime -1 | head -1"
    set archivoExcel to do shell script comandoBuscarExcel
    
    if archivoExcel is "" then
        display dialog "‚ùå No se encontr√≥ el Excel de comisiones." buttons {"OK"} with icon stop
        return
    end if
    
    -- Mostrar confirmaci√≥n
    set mensaje to "üìã Archivos encontrados:

"
    if archivoZIPElec is not "" then
        set nombreZIPElec to do shell script "basename " & quoted form of archivoZIPElec
        set mensaje to mensaje & "‚ö° Electricidad: " & nombreZIPElec & "
"
    end if
    if archivoZIPGas is not "" then
        set nombreZIPGas to do shell script "basename " & quoted form of archivoZIPGas
        set mensaje to mensaje & "üî• Gas: " & nombreZIPGas & "
"
    end if
    set mensaje to mensaje & "
¬øContinuar?"
    
    display dialog mensaje buttons {"Cancelar", "Continuar"} default button 2
    if button returned of result is "Cancelar" then return
    
on error errorMessage
    display dialog "‚ùå Error: " & errorMessage buttons {"OK"} with icon stop
    return
end try

-- Crear carpetas temporales
set carpetaTempElec to ""
set carpetaTempGas to ""
set archivosElec to {}
set archivosGas to {}

if archivoZIPElec is not "" then
    set carpetaTempElec to (do shell script "mktemp -d") & "/"
    do shell script "unzip -q " & quoted form of archivoZIPElec & " -d " & quoted form of carpetaTempElec
    set archivosElec to paragraphs of (do shell script "find " & quoted form of carpetaTempElec & " -name '*.xlsx' -type f | grep -v '~$'")
    log "Archivos electricidad encontrados: " & (count of archivosElec)
end if

if archivoZIPGas is not "" then
    set carpetaTempGas to (do shell script "mktemp -d") & "/"
    do shell script "unzip -q " & quoted form of archivoZIPGas & " -d " & quoted form of carpetaTempGas
    set archivosGas to paragraphs of (do shell script "find " & quoted form of carpetaTempGas & " -name '*.xlsx' -type f | grep -v '~$'")
    log "Archivos gas encontrados: " & (count of archivosGas)
    -- DEBUG: Mostrar primeros archivos
    if (count of archivosGas) > 0 then
        log "Ejemplo archivo gas: " & (item 1 of archivosGas)
    end if
end if

-- Leer datos de comerciales desde Excel
set scriptPython to "
import sys, subprocess
try: import openpyxl
except: subprocess.check_call([sys.executable, '-m', 'pip', 'install', '--user', 'openpyxl']); import openpyxl
import json

wb = openpyxl.load_workbook('" & archivoExcel & "', data_only=True)
hoja = next((n for n in wb.sheetnames if 'COMISION' in n.upper()), wb.sheetnames[0])
ws = wb[hoja]
datos = {}

for row in ws.iter_rows(min_row=2, values_only=True):
    if not row or len(row) < 2: continue
    num = row[1]
    if not num: continue
    
    try:
        if isinstance(num, (int, float)): numero = str(int(num)).zfill(2)
        else:
            import re
            nums = re.findall(r'\\\\\\\\d+', str(num))
            numero = str(int(nums[0])).zfill(2) if nums else None
    except: continue
    
    if not numero: continue
    nombre = str(row[3]) if len(row) > 3 and row[3] else str(row[0])
    emails = [str(row[i]).strip() for i in range(4, min(8, len(row))) if row[i] and '@' in str(row[i])]
    
    if emails: datos[numero] = {'nombre': nombre, 'emails': emails}

print(json.dumps(datos, ensure_ascii=False))
"

set datosJSON to do shell script "python3 -c " & quoted form of scriptPython

-- Obtener mes actual
set scriptMes to "import datetime; print(['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][datetime.datetime.now().month-1])"
set mesActual to do shell script "python3 -c " & quoted form of scriptMes

-- Crear emails en Outlook
tell application "Microsoft Outlook"
    activate
    
    set scriptParsear to "
import json
datos = json.loads('''" & datosJSON & "''')
for numero, info in sorted(datos.items()):
    print(f\\"{numero}|{info['nombre']}|{';'.join(info['emails'])}\\")
"
    
    set lineasDatos to paragraphs of (do shell script "python3 -c " & quoted form of scriptParsear)
    set contadorEmails to 0
    
    repeat with lineaDato in lineasDatos
        set AppleScript's text item delimiters to "|"
        set datosParte to text items of lineaDato
        set numeroComercial to item 1 of datosParte
        set nombreComercial to item 2 of datosParte
        set emailsDestino to item 3 of datosParte
        set AppleScript's text item delimiters to ""
        
        -- Buscar archivos de este comercial
        set archivoElec to missing value
        set archivoGas to missing value
        
        -- DEBUG: Log para ver qu√© busca
        log "Buscando archivos para comercial: " & numeroComercial & " - " & nombreComercial
        
        -- Buscar electricidad
        if (count of archivosElec) > 0 then
            set listaPaths to ""
            repeat with archivoPath in archivosElec
                set listaPaths to listaPaths & archivoPath & "
"
            end repeat
            try
                set archivoElec to do shell script "echo " & quoted form of listaPaths & " | grep '/" & numeroComercial & "_' | grep -v '_GAS' | head -1"
                log "  ‚úì Electricidad encontrado: " & archivoElec
            on error
                set archivoElec to missing value
                log "  ‚úó Electricidad NO encontrado"
            end try
        end if
        
        -- Buscar gas
        if (count of archivosGas) > 0 then
            set listaPaths to ""
            repeat with archivoPath in archivosGas
                set listaPaths to listaPaths & archivoPath & "
"
            end repeat
            try
                set archivoGas to do shell script "echo " & quoted form of listaPaths & " | grep '/" & numeroComercial & "_' | head -1"
                log "  ‚úì Gas encontrado: " & archivoGas
            on error
                set archivoGas to missing value
                log "  ‚úó Gas NO encontrado"
            end try
        end if
        
        -- Si tiene al menos un archivo, crear email
        if archivoElec is not missing value or archivoGas is not missing value then
            set nuevoEmail to make new outgoing message with properties {subject:"Liquidaciones " & mesActual & " - " & nombreComercial}
            
            -- A√±adir destinatarios
            set AppleScript's text item delimiters to ";"
            set listaEmails to text items of emailsDestino
            set AppleScript's text item delimiters to ""
            repeat with unEmail in listaEmails
                make new recipient at nuevoEmail with properties {email address:{address:unEmail}}
            end repeat
            
            -- Crear cuerpo HTML
            set contenidoHTML to "<html><body style='font-family: Arial, sans-serif; font-size: 11pt;'>"
            set contenidoHTML to contenidoHTML & "<p>Buenos d√≠as " & nombreComercial & ",</p>"
            set contenidoHTML to contenidoHTML & "<p>&nbsp;</p>"
            set contenidoHTML to contenidoHTML & "<p>Te env√≠o las liquidaciones del mes de " & mesActual & ".</p>"
            set contenidoHTML to contenidoHTML & "</body></html>"
            set content of nuevoEmail to contenidoHTML
            
            -- Adjuntar archivos
            tell nuevoEmail
                if archivoElec is not missing value then
                    try
                        log "    Adjuntando electricidad: " & archivoElec
                        -- Verificar que existe
                        do shell script "test -f " & quoted form of archivoElec
                        make new attachment with properties {file:POSIX file archivoElec}
                        log "    ‚úì Electricidad adjuntado"
                    on error errMsg
                        log "    ‚úó Error adjuntando electricidad: " & errMsg
                    end try
                end if
                if archivoGas is not missing value then
                    try
                        log "    Adjuntando gas: " & archivoGas
                        -- Verificar que existe
                        do shell script "test -f " & quoted form of archivoGas
                        make new attachment with properties {file:POSIX file archivoGas}
                        log "    ‚úì Gas adjuntado"
                    on error errMsg
                        log "    ‚úó Error adjuntando gas: " & errMsg
                    end try
                end if
            end tell
            
            open nuevoEmail
            set contadorEmails to contadorEmails + 1
            delay 1
        end if
    end repeat
end tell

-- Limpiar
if carpetaTempElec is not "" then do shell script "rm -rf " & quoted form of carpetaTempElec
if carpetaTempGas is not "" then do shell script "rm -rf " & quoted form of carpetaTempGas

display dialog "‚úÖ Proceso completado

Emails creados: " & contadorEmails & "

Los emails est√°n abiertos en Outlook.
Revisa y env√≠a cada uno." buttons {"OK"}`;
            
            const blob = new Blob([scriptContent], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Enviar_Liquidaciones_Outlook.scpt';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatus('‚úÖ Script descargado correctamente', 'success');
            alert('üì• Script descargado: Enviar_Liquidaciones_Outlook.scpt\n\n‚úÖ PASOS:\n\n1. Descarga ZIP Electricidad (bot√≥n rosa) y/o ZIP Gas (bot√≥n rojo)\n2. Haz doble clic en el archivo .scpt descargado\n3. El script buscar√° autom√°ticamente los archivos\n4. Outlook abrir√° con todos los emails\n\nüí° El script adjunta autom√°ticamente:\n- Archivo electricidad si existe\n- Archivo gas si existe\n- Ambos si el comercial tiene los dos\n\n‚ö†Ô∏è REQUISITO (solo primera vez):\npip3 install openpyxl');
        }

        function analizarTarifas() {
            console.log('üöÄ INICIO DE analizarTarifas()');
            console.log('processedWorkbook:', !!processedWorkbook);
            console.log('originalWorkbook:', !!originalWorkbook);
            
            try {
            
            if (!processedWorkbook && !processedWorkbookGas) {
                showStatus('‚ùå No hay datos procesados para analizar', 'error');
                console.log('‚ùå SALIDA: No hay workbooks procesados');
                return;
            }
            
            console.log('‚úì Workbooks disponibles');
            
            try {
                showStatus('‚è≥ Analizando tarifas activas...', 'success');
                console.log('‚è≥ Iniciando an√°lisis...');
                
                const analisisWb = XLSX.utils.book_new();
                console.log('‚úì Workbook de an√°lisis creado');
                
                // ========================================
                // AN√ÅLISIS DE ELECTRICIDAD
                // ========================================
                
                console.log('Verificando electricidad...');
                if (processedWorkbook && originalWorkbook) {
                    console.log('‚úì Procesando ELECTRICIDAD');
                    // Leer hoja DATOS del workbook ORIGINAL
                    const datosSheet = originalWorkbook.Sheets['DATOS'];
                    const detalleSheet = processedWorkbook.Sheets['Detalle'];
                    const tarifasNoEncontradasSheet = processedWorkbook.Sheets['TARIFAS_NO_ENCONTRADAS'];
                    
                    if (!datosSheet) {
                        console.error('No se encontr√≥ hoja DATOS en el workbook original');
                        return;
                    }
                    
                    // Extraer tarifas de DATOS (workbook original)
                    const datosData = XLSX.utils.sheet_to_json(datosSheet, { header: 1 });
                    const tarifasConfiguradasMap = {};
                    
                    console.log('=== TARIFAS EN DATOS (original) ===');
                    console.log('Total filas en DATOS:', datosData.length);
                    console.log('Primeras 20 tarifas con detalle:');
                    
                    for (let i = 1; i < datosData.length; i++) {
                        const row = datosData[i];
                        if (!row || row.length < 2) continue;
                        
                        const tarifa = row[0];
                        const comision = row[1];
                        const tipo = row[2];
                        
                        // Validar que no sea fila vac√≠a o encabezado
                        if (!tarifa || tarifa === 'TARIFA' || tarifa === 'X') continue;
                        if (comision === 'COMISION' || comision === 'X') continue;
                        
                        const tarifaStr = String(tarifa).trim();
                        const comisionNum = parseFloat(comision) || 0;
                        const tipoStr = tipo ? String(tipo).toUpperCase().trim() : 'REPARTO';
                        
                        const key = tarifaStr.toUpperCase();
                        tarifasConfiguradasMap[key] = {
                            tarifa: tarifaStr,
                            comision: comisionNum,
                            tipo: tipoStr
                        };
                        
                        if (Object.keys(tarifasConfiguradasMap).length <= 20) {
                            console.log(`  [${i}] "${key}" ‚Üí Comisi√≥n: ${comisionNum}, Tipo RAW: "${tipo}" ‚Üí Tipo PROCESADO: "${tipoStr}"`);
                        }
                    }
                    console.log(`Total tarifas configuradas: ${Object.keys(tarifasConfiguradasMap).length}`);
                    
                    // Leer FACTURA TOTAL para obtener consumos
                    const facturaTotalSheet = originalWorkbook.Sheets['FACTURA TOTAL'];
                    const consumosPorTarifa = {}; // {tarifa|peaje: consumoTotal}
                    
                    if (facturaTotalSheet) {
                        const facturaTotalData = XLSX.utils.sheet_to_json(facturaTotalSheet);
                        console.log('=== LEYENDO CONSUMOS DE FACTURA TOTAL ===');
                        console.log('Total facturas:', facturaTotalData.length);
                        
                        for (const row of facturaTotalData) {
                            const grupo = row['Grupo'] || row['GRUPO'];
                            const tarifaPeaje = row['Tarifa Peaje'] || row['TARIFA PEAJE'];
                            const consumo = parseFloat(row['Consumo'] || row['CONSUMO'] || row['consumo'] || 0);
                            
                            if (!grupo || !tarifaPeaje || !consumo) continue;
                            
                            const grupoUpper = String(grupo).toUpperCase().trim();
                            const peajeNorm = String(tarifaPeaje).trim();
                            const key = `${grupoUpper}|${peajeNorm}`;
                            
                            consumosPorTarifa[key] = (consumosPorTarifa[key] || 0) + consumo;
                        }
                        console.log(`Total claves con consumo: ${Object.keys(consumosPorTarifa).length}`);
                    }
                    
                    // Extraer tarifas del Detalle (facturas reales)
                    const detalleData = XLSX.utils.sheet_to_json(detalleSheet);
                    const tarifasActivasMap = {};
                    const conteoPorTarifa = {};
                    const todosPeajes = new Set(); // Todos los peajes encontrados
                    
                    console.log('=== TARIFAS EN DETALLE ===');
                    const nombresUnicos = new Set();
                    for (const row of detalleData) {
                        const grupo = row['Grupo'];
                        const tarifaPeaje = row['Tarifa Peaje'];
                        if (!grupo || !tarifaPeaje) continue;
                        
                        const grupoUpper = String(grupo).toUpperCase().trim();
                        nombresUnicos.add(grupoUpper);
                        const peajeNorm = String(tarifaPeaje).trim();
                        
                        todosPeajes.add(peajeNorm); // Guardar todos los peajes
                        
                        if (!tarifasActivasMap[grupoUpper]) {
                            tarifasActivasMap[grupoUpper] = {
                                grupo: grupo,
                                peajes: new Set()
                            };
                        }
                        tarifasActivasMap[grupoUpper].peajes.add(peajeNorm);
                        
                        const key = `${grupoUpper}|${peajeNorm}`;
                        conteoPorTarifa[key] = (conteoPorTarifa[key] || 0) + 1;
                    }
                    
                    console.log('Primeras 10 tarifas en Detalle:');
                    Array.from(nombresUnicos).slice(0, 10).forEach(n => console.log(`  "${n}"`));
                    console.log(`Total tarifas √∫nicas en Detalle: ${nombresUnicos.size}`);
                    
                    // Extraer tarifas no encontradas
                    const tarifasNoEncontradasMap = {};
                    if (tarifasNoEncontradasSheet) {
                        const noEncontradasData = XLSX.utils.sheet_to_json(tarifasNoEncontradasSheet);
                        for (const row of noEncontradasData) {
                            const tarifa = row['Tarifa'];
                            if (tarifa) {
                                tarifasNoEncontradasMap[String(tarifa).toUpperCase().trim()] = true;
                            }
                        }
                    }
                    
                    // Combinar toda la informaci√≥n
                    const todasLasTarifasElec = new Map();
                    
                    // De configuradas
                    for (const [key, info] of Object.entries(tarifasConfiguradasMap)) {
                        todasLasTarifasElec.set(key, {
                            tarifa: info.tarifa,
                            comision: info.comision,
                            tipo: info.tipo,
                            estado: 'CONFIGURADA',
                            peajes: [],
                            facturas: 0
                        });
                    }
                    
                    // De activas - buscar comisi√≥n de forma flexible
                    for (const [key, info] of Object.entries(tarifasActivasMap)) {
                        const peajes = Array.from(info.peajes);
                        
                        // Buscar comisi√≥n y tipo - primero coincidencia exacta
                        let comision = 0;
                        let tipo = 'REPARTO';
                        let encontrado = false;
                        
                        if (tarifasConfiguradasMap[key]) {
                            // Coincidencia exacta
                            comision = tarifasConfiguradasMap[key].comision;
                            tipo = tarifasConfiguradasMap[key].tipo;
                            encontrado = true;
                        } else {
                            // Buscar por inicio de nombre (m√°s espec√≠fico primero)
                            // Ordenar por longitud descendente para buscar primero las m√°s largas
                            const configKeys = Object.keys(tarifasConfiguradasMap).sort((a, b) => b.length - a.length);
                            
                            for (const configKey of configKeys) {
                                // Si la tarifa activa EMPIEZA con la tarifa configurada
                                if (key.startsWith(configKey)) {
                                    comision = tarifasConfiguradasMap[configKey].comision;
                                    tipo = tarifasConfiguradasMap[configKey].tipo;
                                    console.log(`‚úì Coincidencia: "${key}" empieza con "${configKey}" ‚Üí Comisi√≥n: ${comision}, Tipo: ${tipo}`);
                                    encontrado = true;
                                    break;
                                }
                            }
                            
                            // Si a√∫n no se encontr√≥, buscar si la tarifa configurada est√° contenida
                            if (!encontrado) {
                                for (const configKey of configKeys) {
                                    if (key.includes(configKey)) {
                                        comision = tarifasConfiguradasMap[configKey].comision;
                                        tipo = tarifasConfiguradasMap[configKey].tipo;
                                        console.log(`~ Coincidencia parcial: "${key}" contiene "${configKey}" ‚Üí Comisi√≥n: ${comision}, Tipo: ${tipo}`);
                                        encontrado = true;
                                        break;
                                    }
                                }
                            }
                            
                            // EXTRACCI√ìN INTELIGENTE si no se encontr√≥
                            if (!encontrado) {
                                // Para INDEX PLUS ‚Üí extraer n√∫mero y tipo TOTAL
                                if (key.startsWith('INDEX PLUS')) {
                                    const match = key.match(/INDEX PLUS (\d+)/);
                                    if (match) {
                                        comision = parseInt(match[1]);
                                        tipo = 'TOTAL';
                                        console.log(`üîç Extra√≠do INDEX PLUS: "${key}" ‚Üí ${comision}, TOTAL`);
                                        encontrado = true;
                                    }
                                }
                                // Para INDEXADA ‚Üí extraer n√∫mero
                                else if (key.startsWith('INDEXADA') || key.startsWith('INDEXADO')) {
                                    const match = key.match(/INDEXAD[OA] (\d+)/);
                                    if (match) {
                                        comision = parseInt(match[1]);
                                        tipo = 'REPARTO';
                                        console.log(`üîç Extra√≠do INDEXADA: "${key}" ‚Üí ${comision}, REPARTO`);
                                        encontrado = true;
                                    }
                                }
                                // Para DRK FIJO RUNNING ‚Üí extraer n√∫mero
                                else if (key.startsWith('DRK FIJO')) {
                                    const match = key.match(/DRK FIJO (?:RUNNING |JUAN |INCLAN )?(\d+)/);
                                    if (match) {
                                        comision = parseInt(match[1]);
                                        tipo = 'REPARTO';
                                        console.log(`üîç Extra√≠do DRK FIJO: "${key}" ‚Üí ${comision}, REPARTO`);
                                        encontrado = true;
                                    }
                                }
                                // Para INDEX ‚Üí extraer n√∫mero (sin PLUS)
                                else if (key.startsWith('INDEX ') && !key.startsWith('INDEX PLUS')) {
                                    const match = key.match(/INDEX (\d+)/);
                                    if (match) {
                                        comision = parseInt(match[1]);
                                        tipo = 'REPARTO';
                                        console.log(`üîç Extra√≠do INDEX: "${key}" ‚Üí ${comision}, REPARTO`);
                                        encontrado = true;
                                    }
                                }
                                // Para FEE ‚Üí extraer n√∫mero
                                else if (key.includes('FEE')) {
                                    const match = key.match(/FEE (\d+)/);
                                    if (match) {
                                        comision = parseInt(match[1]);
                                        tipo = 'REPARTO';
                                        console.log(`üîç Extra√≠do FEE: "${key}" ‚Üí ${comision}, REPARTO`);
                                        encontrado = true;
                                    }
                                }
                                // GEN√âRICO: Si tiene un n√∫mero al principio o despu√©s de un espacio
                                if (!encontrado) {
                                    const matchGenerico = key.match(/\b(\d+)\b/);
                                    if (matchGenerico) {
                                        comision = parseInt(matchGenerico[1]);
                                        tipo = 'REPARTO';
                                        console.log(`üîç Extra√≠do GEN√âRICO: "${key}" ‚Üí ${comision}, REPARTO`);
                                        encontrado = true;
                                    }
                                }
                            }
                        }
                        
                        if (!encontrado) {
                            console.warn(`‚úó No se encontr√≥ comisi√≥n para: "${key}"`);
                        }
                        
                        if (todasLasTarifasElec.has(key)) {
                            todasLasTarifasElec.get(key).estado = 'ACTIVA';
                            todasLasTarifasElec.get(key).peajes = peajes;
                            todasLasTarifasElec.get(key).comision = comision;
                            todasLasTarifasElec.get(key).tipo = tipo;
                        } else {
                            todasLasTarifasElec.set(key, {
                                tarifa: info.grupo,
                                comision: comision,
                                tipo: tipo,
                                estado: 'ACTIVA',
                                peajes: peajes,
                                facturas: 0
                            });
                        }
                    }
                    
                    // De no encontradas
                    for (const key of Object.keys(tarifasNoEncontradasMap)) {
                        if (!todasLasTarifasElec.has(key)) {
                            todasLasTarifasElec.set(key, {
                                tarifa: key,
                                comision: 0,
                                tipo: 'REPARTO',
                                estado: 'NO ENCONTRADA',
                                peajes: [],
                                facturas: 0
                            });
                        }
                    }
                    
                    // Agregar conteo de facturas
                    for (const [keyTarifa, info] of todasLasTarifasElec.entries()) {
                        let totalFacturas = 0;
                        for (const peaje of info.peajes) {
                            const key = `${keyTarifa}|${peaje}`;
                            totalFacturas += (conteoPorTarifa[key] || 0);
                        }
                        info.facturas = totalFacturas;
                    }
                    
                    // Clasificar por peaje - usar todos los peajes encontrados
                    console.log('Peajes encontrados:', Array.from(todosPeajes));
                    
                    // Indexar FEEs de tarifas INDEX desde CONTRATOSACTIVOS
                    const contratosActivosSheetFee = originalWorkbook.Sheets['CONTRATOSACTIVOS'];
                    const feesPorTarifaPeaje = {};
                    
                    if (contratosActivosSheetFee && facturaTotalSheet) {
                        const contratosActivosDataFee = XLSX.utils.sheet_to_json(contratosActivosSheetFee);
                        const facturaTotalDataFee = XLSX.utils.sheet_to_json(facturaTotalSheet);
                        const contratosPorCupsFee = {};
                        
                        console.log('=== DEBUG FEE ===');
                        console.log('Primera fila COMPLETA CONTRATOSACTIVOS:');
                        if (contratosActivosDataFee.length > 0) {
                            const primeraFila = contratosActivosDataFee[0];
                            for (const [key, value] of Object.entries(primeraFila)) {
                                console.log(`  "${key}": "${value}"`);
                            }
                        }
                        
                        for (const contrato of contratosActivosDataFee) {
                            const cups = String(contrato['CUPS'] || '').trim();
                            if (cups) contratosPorCupsFee[cups] = contrato;
                        }
                        
                        let contadorDebug = 0;
                        for (const row of facturaTotalDataFee) {
                            const grupo = row['Grupo'] || row['GRUPO'];
                            const cups = String(row['CUPS'] || '').trim();
                            const tarifaPeaje = row['Tarifa Peaje'] || '';
                            if (!grupo || !cups) continue;
                            
                            const contratoActivo = contratosPorCupsFee[cups];
                            if (!contratoActivo) continue;
                            
                            // ¬°CORRECCI√ìN! Leer de "Tarifa Grupo" en lugar de "Tarifa"
                            const nombreTarifa = String(
                                contratoActivo['Tarifa Grupo'] || 
                                contratoActivo['TARIFA GRUPO'] || 
                                contratoActivo['Tarifa'] || 
                                contratoActivo['TARIFA'] ||
                                ''
                            ).trim().toUpperCase();
                            
                            const fee = parseFloat(contratoActivo['Precio Energ√≠a P1'] || contratoActivo['AT'] || 0);
                            const esIndex = nombreTarifa.includes('INDEX');
                            
                            if (contadorDebug < 5 && grupo.toUpperCase().includes('INDEX')) {
                                console.log(`DEBUG ${contadorDebug}: Grupo="${grupo}", NombreTarifa="${nombreTarifa}", FEE=${fee}, esIndex=${esIndex}`);
                                contadorDebug++;
                            }
                            
                            if (esIndex && fee > 0) {
                                const key = `${String(grupo).toUpperCase().trim()}|${String(tarifaPeaje).trim()}`;
                                if (!feesPorTarifaPeaje[key]) {
                                    feesPorTarifaPeaje[key] = { fee: fee };
                                }
                            }
                        }
                        console.log(`FEEs INDEX indexados: ${Object.keys(feesPorTarifaPeaje).length}`);
                        if (Object.keys(feesPorTarifaPeaje).length > 0) {
                            console.log('Primeras 5 claves:', Object.keys(feesPorTarifaPeaje).slice(0, 5));
                        }
                    } // FIN del if (contratosActivosSheetFee && facturaTotalSheet)
                    
                    // ========================================
                    // EXTRAER PRECIOS DE POTENCIA Y ENERG√çA
                    // ========================================
                    
                    console.log('=== EXTRAYENDO PRECIOS DE POTENCIA Y ENERG√çA ===');
                    
                    const preciosPorTarifaPeaje = new Map(); // key: "tarifa|peaje", value: {potencia, energia, fecha}
                    
                    try {
                        if (facturaTotalSheet) {
                            const facturasTotales = XLSX.utils.sheet_to_json(facturaTotalSheet);
                            console.log(`Leyendo ${facturasTotales.length} facturas para extraer precios`);
                            
                            for (const factura of facturasTotales) {
                                const nombreTarifa = factura['Grupo'] || factura['GRUPO'];
                                const tarifaPeaje = factura['Tarifa Peaje'] || factura['TARIFA PEAJE'] || '';
                                const fechaFactura = factura['Fecha Factura'] || factura['FECHA FACTURA'] || '';
                                
                                if (!nombreTarifa || !tarifaPeaje) continue;
                                
                                const key = `${nombreTarifa}|${tarifaPeaje}`;
                                
                                // Solo actualizar si no tenemos precios o si esta factura es m√°s reciente
                                const existente = preciosPorTarifaPeaje.get(key);
                                if (!existente || (fechaFactura && fechaFactura > (existente.fecha || ''))) {
                                    const precios = {
                                        potencia: {},
                                        energia: {},
                                        fecha: fechaFactura
                                    };
                                    
                                    // Determinar si es 2.0TD
                                    const es2TD = (tarifaPeaje.includes('2.0') || tarifaPeaje.includes('2TD')) && !tarifaPeaje.includes('6.2');
                                    
                                    if (es2TD) {
                                        // Para 2.0TD: P1=AO, P2=AQ
                                        precios.potencia.P1 = factura['Precio Potencia P1'] || 0;
                                        precios.potencia.P2 = factura['Precio Potencia P3'] || 0;
                                        precios.energia.E1 = factura['Precio Energ√≠a P1'] || 0;
                                        precios.energia.E2 = factura['Precio Energ√≠a P2'] || 0;
                                        precios.energia.E3 = factura['Precio Energ√≠a P3'] || 0;
                                    } else {
                                        // Para 3.0TD, 6.1TD, 6.2TD
                                        precios.potencia.P1 = factura['Precio Potencia P1'] || 0;
                                        precios.potencia.P2 = factura['Precio Potencia P2'] || 0;
                                        precios.potencia.P3 = factura['Precio Potencia P3'] || 0;
                                        precios.potencia.P4 = factura['Precio Potencia P4'] || 0;
                                        precios.potencia.P5 = factura['Precio Potencia P5'] || 0;
                                        precios.potencia.P6 = factura['Precio Potencia P6'] || 0;
                                        precios.energia.E1 = factura['Precio Energ√≠a P1'] || 0;
                                        precios.energia.E2 = factura['Precio Energ√≠a P2'] || 0;
                                        precios.energia.E3 = factura['Precio Energ√≠a P3'] || 0;
                                        precios.energia.E4 = factura['Precio Energ√≠a P4'] || 0;
                                        precios.energia.E5 = factura['Precio Energ√≠a P5'] || 0;
                                        precios.energia.E6 = factura['Precio Energ√≠a P6'] || 0;
                                    }
                                    
                                    preciosPorTarifaPeaje.set(key, precios);
                                }
                            }
                            
                            console.log(`‚úÖ Precios extra√≠dos para ${preciosPorTarifaPeaje.size} combinaciones tarifa+peaje`);
                            
                            // Mostrar todas las claves con 6.2TD
                            const claves62TD = Array.from(preciosPorTarifaPeaje.keys()).filter(k => k.includes('6.2TD'));
                            console.log(`üîç Claves con 6.2TD (${claves62TD.length}):`, claves62TD);
                            
                            if (preciosPorTarifaPeaje.size > 0 && preciosPorTarifaPeaje.size <= 3) {
                                Array.from(preciosPorTarifaPeaje.entries()).slice(0, 3).forEach(([k, v]) => {
                                    console.log(`  "${k}" ‚Üí P1=${v.potencia.P1}, E1=${v.energia.E1}`);
                                });
                            }
                        } else {
                            console.log('‚ö†Ô∏è No se encontr√≥ hoja FACTURA TOTAL');
                        }
                    } catch (error) {
                        console.error('‚ùå Error extrayendo precios:', error);
                    }
                    
                    for (const peaje of todosPeajes) {
                        const tarifasDelPeaje = [];
                        
                        for (const [key, info] of todasLasTarifasElec.entries()) {
                            // Solo incluir si esta tarifa tiene este peaje
                            if (info.peajes.includes(peaje)) {
                                const keyConteo = `${key}|${peaje}`;
                                const consumoTotal = consumosPorTarifa[keyConteo] || 0;
                                const facturas = conteoPorTarifa[keyConteo] || 0;
                                const feeInfo = feesPorTarifaPeaje[keyConteo];
                                const fee = feeInfo ? feeInfo.fee : '';
                                let beneficio = '';
                                if (fee && consumoTotal > 0) {
                                    // F√≥rmula: (Consumos√∑1000) √ó (FEE√ó1000) = Consumos √ó FEE
                                    beneficio = Math.round(consumoTotal * fee * 100) / 100;
                                }
                                
                                // Obtener precios de potencia y energ√≠a
                                const keyPrecios = `${info.tarifa}|${peaje}`;
                                let precios = preciosPorTarifaPeaje.get(keyPrecios);
                                
                                // Debug para 6.2TD
                                if (peaje === '6.2TD') {
                                    console.log(`[6.2TD] Buscando: "${keyPrecios}"`);
                                    console.log(`[6.2TD] ¬øExiste en Map? ${preciosPorTarifaPeaje.has(keyPrecios)}`);
                                    console.log(`[6.2TD] Valor obtenido:`, precios);
                                    
                                    // Intentar b√∫squeda manual
                                    const todasLasClaves = Array.from(preciosPorTarifaPeaje.keys());
                                    const clavesConPeaje = todasLasClaves.filter(k => k.includes('6.2TD'));
                                    if (clavesConPeaje.length > 0) {
                                        console.log(`[6.2TD] Intentando con clave del Map:`, clavesConPeaje[0]);
                                        const preciosManual = preciosPorTarifaPeaje.get(clavesConPeaje[0]);
                                        console.log(`[6.2TD] Precios obtenidos manualmente:`, preciosManual);
                                        if (!precios) {
                                            precios = preciosManual;
                                            console.log(`[6.2TD] ‚úì Usando precios obtenidos manualmente`);
                                        }
                                    }
                                }
                                
                                const preciosFinales = precios || {potencia: {}, energia: {}};
                                
                                // Debug solo para primera tarifa de cada peaje (excepto 6.2TD que ya tiene su propio log)
                                if (tarifasDelPeaje.length === 0 && peaje !== '6.2TD') {
                                    console.log(`[${peaje}] Primera tarifa: "${info.tarifa}" ‚Üí Precios ${precios ? 'encontrados' : 'NO encontrados'}`);
                                    if (!precios && preciosPorTarifaPeaje.size > 0) {
                                        console.log(`  Buscando: "${keyPrecios}"`);
                                        console.log(`  Claves disponibles (primeras 3):`, Array.from(preciosPorTarifaPeaje.keys()).slice(0, 3));
                                    }
                                }
                                
                                // Crear objeto base
                                const tarifaData = {
                                    'Tarifa': info.tarifa,
                                    'Peaje': peaje,
                                    'Tipo': info.tipo,
                                    'Comisi√≥n': info.comision,
                                    'Estado': info.estado,
                                    'Facturas': facturas,
                                    'Consumos (kWh/mes)': consumoTotal,
                                    'FEE (‚Ç¨/MWh)': fee,
                                    'Beneficio (‚Ç¨)': beneficio
                                };
                                
                                // A√±adir precios seg√∫n el peaje
                                if (peaje === '2.0TD') {
                                    // 2.0TD: P1, P2 (multiplicar por 365 para convertir a anual)
                                    tarifaData['Pot P1 (‚Ç¨/kW/a√±o)'] = preciosFinales.potencia.P1 ? (preciosFinales.potencia.P1 * 365) : '';
                                    tarifaData['Pot P2 (‚Ç¨/kW/a√±o)'] = preciosFinales.potencia.P2 ? (preciosFinales.potencia.P2 * 365) : '';
                                    tarifaData['Energ E1 (‚Ç¨/kWh)'] = preciosFinales.energia.E1 || '';
                                    tarifaData['Energ E2 (‚Ç¨/kWh)'] = preciosFinales.energia.E2 || '';
                                    tarifaData['Energ E3 (‚Ç¨/kWh)'] = preciosFinales.energia.E3 || '';
                                } else if (peaje === '3.0TD' || peaje === '6.1TD' || peaje === '6.2TD') {
                                    // 3.0TD, 6.1TD, 6.2TD: P1-P6 (multiplicar por 365 para convertir a anual)
                                    tarifaData['Pot P1 (‚Ç¨/kW/a√±o)'] = preciosFinales.potencia.P1 ? (preciosFinales.potencia.P1 * 365) : '';
                                    tarifaData['Pot P2 (‚Ç¨/kW/a√±o)'] = preciosFinales.potencia.P2 ? (preciosFinales.potencia.P2 * 365) : '';
                                    tarifaData['Pot P3 (‚Ç¨/kW/a√±o)'] = preciosFinales.potencia.P3 ? (preciosFinales.potencia.P3 * 365) : '';
                                    tarifaData['Pot P4 (‚Ç¨/kW/a√±o)'] = preciosFinales.potencia.P4 ? (preciosFinales.potencia.P4 * 365) : '';
                                    tarifaData['Pot P5 (‚Ç¨/kW/a√±o)'] = preciosFinales.potencia.P5 ? (preciosFinales.potencia.P5 * 365) : '';
                                    tarifaData['Pot P6 (‚Ç¨/kW/a√±o)'] = preciosFinales.potencia.P6 ? (preciosFinales.potencia.P6 * 365) : '';
                                    tarifaData['Energ E1 (‚Ç¨/kWh)'] = preciosFinales.energia.E1 || '';
                                    tarifaData['Energ E2 (‚Ç¨/kWh)'] = preciosFinales.energia.E2 || '';
                                    tarifaData['Energ E3 (‚Ç¨/kWh)'] = preciosFinales.energia.E3 || '';
                                    tarifaData['Energ E4 (‚Ç¨/kWh)'] = preciosFinales.energia.E4 || '';
                                    tarifaData['Energ E5 (‚Ç¨/kWh)'] = preciosFinales.energia.E5 || '';
                                    tarifaData['Energ E6 (‚Ç¨/kWh)'] = preciosFinales.energia.E6 || '';
                                }
                                
                                tarifasDelPeaje.push(tarifaData);
                            }
                        }
                        
                        // Ordenar por estado (ACTIVA primero) y luego por n√∫mero de facturas
                        tarifasDelPeaje.sort((a, b) => {
                            if (a.Estado === 'ACTIVA' && b.Estado !== 'ACTIVA') return -1;
                            if (a.Estado !== 'ACTIVA' && b.Estado === 'ACTIVA') return 1;
                            return b.Facturas - a.Facturas; // Mayor a menor
                        });
                        
                        if (tarifasDelPeaje.length > 0) {
                            const ws = XLSX.utils.json_to_sheet(tarifasDelPeaje);
                            
                            // Aplicar formato a columnas
                            const range = XLSX.utils.decode_range(ws['!ref']);
                            for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                                // Columna G (√≠ndice 6): Consumos con separador de miles
                                const cellG = XLSX.utils.encode_cell({r: R, c: 6});
                                if (ws[cellG] && typeof ws[cellG].v === 'number') {
                                    ws[cellG].z = '#,##0';
                                }
                                
                                // Columna I (√≠ndice 8): Beneficio con formato moneda
                                const cellI = XLSX.utils.encode_cell({r: R, c: 8});
                                if (ws[cellI] && typeof ws[cellI].v === 'number') {
                                    ws[cellI].z = '#,##0.00 "‚Ç¨"';
                                }
                            }
                            
                            // Limpiar nombre de peaje para nombre de hoja
                            const nombreHoja = peaje.replace(/\./g, '_').replace(/\s/g, '_');
                            XLSX.utils.book_append_sheet(analisisWb, ws, nombreHoja);
                            console.log(`Hoja creada: ${nombreHoja} con ${tarifasDelPeaje.length} tarifas`);
                        }
                    }
                    
                    // ========================================
                    // CALCULAR BENEFICIO TOTAL INDEX
                    // ========================================
                    
                    let beneficioTotalIndex = 0;
                    
                    // Sumar beneficios de todas las tarifas INDEX de todos los peajes
                    for (const peaje of todosPeajes) {
                        for (const [key, info] of todasLasTarifasElec.entries()) {
                            if (info.peajes.includes(peaje)) {
                                const keyConteo = `${key}|${peaje}`;
                                const feeInfo = feesPorTarifaPeaje[keyConteo];
                                
                                // Solo sumar si tiene FEE (es tarifa INDEX)
                                if (feeInfo && feeInfo.fee > 0) {
                                    const consumoTotal = consumosPorTarifa[keyConteo] || 0;
                                    if (consumoTotal > 0) {
                                        const beneficio = consumoTotal * feeInfo.fee;
                                        beneficioTotalIndex += beneficio;
                                    }
                                }
                            }
                        }
                    }
                    
                    console.log(`Beneficio total INDEX mensual: ${Math.round(beneficioTotalIndex * 100) / 100} ‚Ç¨`);
                    console.log(`Beneficio total INDEX anual: ${Math.round(beneficioTotalIndex * 12 * 100) / 100} ‚Ç¨`);
                    
                    // Hoja resumen electricidad
                    const resumenElec = [];
                    for (const [key, info] of todasLasTarifasElec.entries()) {
                        resumenElec.push({
                            'Tarifa': info.tarifa,
                            'Tipo': info.tipo,
                            'Comisi√≥n': info.comision,
                            'Estado': info.estado,
                            'Peajes': info.peajes.join(', '),
                            'Facturas': info.facturas
                        });
                    }
                    
                    resumenElec.sort((a, b) => {
                        // Primero por estado (ACTIVA primero)
                        if (a.Estado === 'ACTIVA' && b.Estado !== 'ACTIVA') return -1;
                        if (a.Estado !== 'ACTIVA' && b.Estado === 'ACTIVA') return 1;
                        // Luego por n√∫mero de facturas (mayor a menor)
                        return b.Facturas - a.Facturas;
                    });
                    
                    const wsResumenElec = XLSX.utils.json_to_sheet(resumenElec);
                    XLSX.utils.book_append_sheet(analisisWb, wsResumenElec, 'Resumen Electricidad');
                    
                    // ========================================
                    // RESUMEN COMPLETO - INDEXADOS VS FIJOS
                    // ========================================
                    
                    // Funci√≥n para determinar si es indexado
                    const esIndexado = (tarifa) => {
                        const tarifaUpper = String(tarifa).toUpperCase();
                        return tarifaUpper.startsWith('INDEX') || 
                               tarifaUpper.includes('INDEXADA') || 
                               tarifaUpper.includes('INDEXADO');
                    };
                    
                    // Agrupar por peaje e indexado/fijo
                    const datosIndexados = {}; // {peaje: {contratos, consumo, beneficio}}
                    const datosFijos = {}; // {peaje: {contratos, consumo}}
                    
                    for (const [key, info] of todasLasTarifasElec.entries()) {
                        if (info.estado !== 'ACTIVA') continue; // Solo activas
                        
                        const indexado = esIndexado(info.tarifa);
                        
                        for (const peaje of info.peajes) {
                            const keyConteo = `${key}|${peaje}`;
                            const contratos = conteoPorTarifa[keyConteo] || 0;
                            const consumo = consumosPorTarifa[keyConteo] || 0;
                            
                            if (indexado) {
                                if (!datosIndexados[peaje]) {
                                    datosIndexados[peaje] = {contratos: 0, consumo: 0, beneficio: 0};
                                }
                                datosIndexados[peaje].contratos += contratos;
                                datosIndexados[peaje].consumo += consumo;
                                
                                // A√±adir beneficio si tiene FEE
                                const feeInfo = feesPorTarifaPeaje[keyConteo];
                                if (feeInfo && feeInfo.fee > 0 && consumo > 0) {
                                    const beneficio = consumo * feeInfo.fee;
                                    datosIndexados[peaje].beneficio += beneficio;
                                }
                            } else {
                                if (!datosFijos[peaje]) {
                                    datosFijos[peaje] = {contratos: 0, consumo: 0};
                                }
                                datosFijos[peaje].contratos += contratos;
                                datosFijos[peaje].consumo += consumo;
                            }
                        }
                    }
                    
                    // Crear hoja Resumen Completo
                    const resumenCompleto = [];
                    
                    // CONTRATOS INDEXADOS
                    resumenCompleto.push({'A': 'CONTRATOS INDEXADOS'});
                    resumenCompleto.push({'A': 'Tarifa', 'B': 'N√∫mero de contratos', 'C': 'Consumos (kWh) mes', 'D': 'Consumos (kWh) a√±o', 'E': 'Beneficio aprox. mensual', 'F': 'Beneficio aprox. anual'});
                    
                    const filaInicioIndexados = resumenCompleto.length + 1; // +1 porque Excel empieza en 1
                    let numFilasIndexados = 0;
                    
                    const peajesOrdenados = Array.from(todosPeajes).sort();
                    for (const peaje of peajesOrdenados) {
                        if (datosIndexados[peaje]) {
                            const consumoMes = Math.round(datosIndexados[peaje].consumo);
                            const beneficioMes = Math.round(datosIndexados[peaje].beneficio * 100) / 100;
                            const filaActual = filaInicioIndexados + numFilasIndexados;
                            
                            resumenCompleto.push({
                                'A': peaje,
                                'B': datosIndexados[peaje].contratos,
                                'C': consumoMes,
                                'D': { f: `C${filaActual}*12` },
                                'E': beneficioMes,
                                'F': { f: `E${filaActual}*12` }
                            });
                            numFilasIndexados++;
                        }
                    }
                    
                    // Fila TOTAL indexados con f√≥rmulas SUM
                    const filaFinIndexados = filaInicioIndexados + numFilasIndexados - 1;
                    
                    resumenCompleto.push({
                        'A': 'TOTAL',
                        'B': { f: `SUM(B${filaInicioIndexados}:B${filaFinIndexados})` },
                        'C': { f: `SUM(C${filaInicioIndexados}:C${filaFinIndexados})` },
                        'D': { f: `SUM(D${filaInicioIndexados}:D${filaFinIndexados})` },
                        'E': { f: `SUM(E${filaInicioIndexados}:E${filaFinIndexados})` },
                        'F': { f: `SUM(F${filaInicioIndexados}:F${filaFinIndexados})` }
                    });
                    const filaTotalIndexados = resumenCompleto.length;
                    resumenCompleto.push({});
                    
                    // CONTRATOS FIJOS
                    resumenCompleto.push({'A': 'CONTRATOS FIJOS'});
                    resumenCompleto.push({'A': 'Tarifa', 'B': 'N√∫mero de contratos', 'C': 'Consumos (kWh) mes', 'D': 'Consumos (kWh) a√±o'});
                    
                    const filaInicioFijos = resumenCompleto.length + 1;
                    let numFilasFijos = 0;
                    
                    for (const peaje of peajesOrdenados) {
                        if (datosFijos[peaje]) {
                            const consumoMes = Math.round(datosFijos[peaje].consumo);
                            resumenCompleto.push({
                                'A': peaje,
                                'B': datosFijos[peaje].contratos,
                                'C': consumoMes,
                                'D': { f: `C${filaInicioFijos + numFilasFijos}*12` }
                            });
                            numFilasFijos++;
                        }
                    }
                    
                    // Fila TOTAL fijos
                    const filaFinFijos = filaInicioFijos + numFilasFijos - 1;
                    resumenCompleto.push({
                        'A': 'TOTAL',
                        'B': { f: `SUM(B${filaInicioFijos}:B${filaFinFijos})` },
                        'C': { f: `SUM(C${filaInicioFijos}:C${filaFinFijos})` },
                        'D': { f: `SUM(D${filaInicioFijos}:D${filaFinFijos})` }
                    });
                    const filaTotalFijos = resumenCompleto.length;
                    resumenCompleto.push({});
                    
                    // CONSUMOS ANUALES
                    resumenCompleto.push({'A': 'CONSUMOS ANUALES'});
                    resumenCompleto.push({'A': 'Tipo de contrato', 'B': 'Consumos (kWh) mes', 'C': 'Consumos (kWh) a√±o'});
                    resumenCompleto.push({
                        'A': 'Contratos Indexados',
                        'B': { f: `C${filaTotalIndexados}` },
                        'C': { f: `D${filaTotalIndexados}` }
                    });
                    resumenCompleto.push({
                        'A': 'Contratos Fijos',
                        'B': { f: `C${filaTotalFijos}` },
                        'C': { f: `D${filaTotalFijos}` }
                    });
                    const filaIndexadosAnual = resumenCompleto.length - 1;
                    const filaFijosAnual = resumenCompleto.length;
                    resumenCompleto.push({
                        'A': 'TOTAL A√ëO',
                        'B': { f: `B${filaIndexadosAnual}+B${filaFijosAnual}` },
                        'C': { f: `C${filaIndexadosAnual}+C${filaFijosAnual}` }
                    });
                    
                    const wsResumenCompleto = XLSX.utils.json_to_sheet(resumenCompleto, {skipHeader: true});
                    
                    // Aplicar formato a Resumen Completo - aplicar a TODAS las filas
                    if (wsResumenCompleto['!ref']) {
                        const range = XLSX.utils.decode_range(wsResumenCompleto['!ref']);
                        
                        // Recorrer todas las filas y columnas
                        for (let R = range.s.r; R <= range.e.r; ++R) {
                            for (let C = range.s.c; C <= range.e.c; ++C) {
                                const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                                const cell = wsResumenCompleto[cellAddress];
                                
                                if (!cell) continue;
                                
                                // Columna B (√≠ndice 1): N√∫meros enteros con separador
                                if (C === 1 && (typeof cell.v === 'number' || cell.f)) {
                                    cell.z = '#,##0';
                                }
                                
                                // Columnas C y D (√≠ndices 2 y 3): Consumos con separador
                                if ((C === 2 || C === 3) && (typeof cell.v === 'number' || cell.f)) {
                                    cell.z = '#,##0';
                                }
                                
                                // Columnas E y F (√≠ndices 4 y 5): Moneda con 2 decimales
                                if ((C === 4 || C === 5) && (typeof cell.v === 'number' || cell.f)) {
                                    cell.z = '#,##0.00 "‚Ç¨"';
                                }
                            }
                        }
                    }
                    
                    XLSX.utils.book_append_sheet(analisisWb, wsResumenCompleto, 'Resumen Completo');
                    
                    // ========================================
                    // VENCIMIENTOS PR√ìXIMOS
                    // ========================================
                    
                    // Leer hoja CONTRATOSACTIVOS
                    const contratosActivosSheet = originalWorkbook.Sheets['CONTRATOSACTIVOS'];
                    const vencimientos = [];
                    
                    if (facturaTotalSheet && contratosActivosSheet) {
                        const facturaTotalData = XLSX.utils.sheet_to_json(facturaTotalSheet);
                        const contratosActivosData = XLSX.utils.sheet_to_json(contratosActivosSheet);
                        const hoy = new Date();
                        
                        console.log('=== ANALIZANDO VENCIMIENTOS CON CONTRATOSACTIVOS ===');
                        console.log('Fecha actual:', hoy.toISOString().split('T')[0]);
                        console.log('Contratos activos encontrados:', contratosActivosData.length);
                        
                        // Crear √≠ndice por CUPS de contratos activos
                        const contratosPorCups = {};
                        for (const contrato of contratosActivosData) {
                            const cupsCont = contrato['CUPS'] || contrato['cups'];
                            if (cupsCont) {
                                contratosPorCups[String(cupsCont).trim()] = contrato;
                            }
                        }
                        
                        console.log('CUPS indexados:', Object.keys(contratosPorCups).length);
                        
                        // Procesar FACTURA TOTAL
                        for (const row of facturaTotalData) {
                            const grupo = row['Grupo'] || row['GRUPO'];
                            const codigo = row['Contrato'] || row['CONTRATO'] || row['C√≥digo'] || row['CODIGO'] || '';
                            const consumo = parseFloat(row['Consumo'] || row['CONSUMO'] || row['consumo'] || 0);
                            const identidad = row['Identidad'] || row['IDENTIDAD'] || '';
                            const cliente = row['Cliente'] || row['CLIENTE'] || '';
                            const cups = String(row['CUPS'] || row['cups'] || '').trim();
                            const direccion = row['Direcci√≥n'] || row['DIRECCION'] || row['Direccion'] || '';
                            const tarifaPeaje = row['Tarifa Peaje'] || row['TARIFA PEAJE'] || row['Tarifa peaje'] || '';
                            const tarifa = row['Tarifa'] || row['TARIFA'] || grupo;
                            
                            if (!grupo || !cups) continue;
                            
                            // Excluir indexados
                            const grupoUpper = String(grupo).toUpperCase();
                            const esIndexado = grupoUpper.startsWith('INDEX') || 
                                             grupoUpper.includes('INDEXADA') || 
                                             grupoUpper.includes('INDEXADO');
                            
                            if (esIndexado) continue;
                            
                            // Buscar contrato activo por CUPS
                            const contratoActivo = contratosPorCups[cups];
                            if (!contratoActivo) continue;
                            
                            // Extraer Canal
                            const canal = contratoActivo['Canal'] || contratoActivo['CANAL'] || '';
                            
                            // Obtener fecha de vencimiento (columna M: "Vto.")
                            const fechaVto = contratoActivo['Vto.'] || contratoActivo['VTO.'] || contratoActivo['Vto'] || contratoActivo['vto'];
                            if (!fechaVto) continue;
                            
                            // Convertir fecha vencimiento a Date
                            let fechaVtoDate;
                            if (fechaVto instanceof Date) {
                                fechaVtoDate = fechaVto;
                            } else if (typeof fechaVto === 'number') {
                                fechaVtoDate = new Date((fechaVto - 25569) * 86400 * 1000);
                            } else {
                                fechaVtoDate = new Date(fechaVto);
                            }
                            
                            if (isNaN(fechaVtoDate.getTime())) continue;
                            
                            // Calcular meses restantes
                            const diffMs = fechaVtoDate - hoy;
                            const diasRestantes = Math.floor(diffMs / (24 * 60 * 60 * 1000));
                            const mesesRestantes = Math.round(diasRestantes / 30.44); // Promedio d√≠as por mes
                            
                            // Solo incluir si faltan 2 meses o menos (60 d√≠as)
                            if (diasRestantes > 60) continue;
                            
                            // Obtener precios de energ√≠a seg√∫n tipo de tarifa
                            const peajeNorm = String(tarifaPeaje).trim();
                            let precios = {};
                            
                            // Logging de claves disponibles en el primer contrato (debug)
                            if (vencimientos.length === 0) {
                                console.log('Columnas disponibles en CONTRATOSACTIVOS:', Object.keys(contratoActivo).slice(0, 50));
                            }
                            
                            if (peajeNorm.includes('2.0')) {
                                // 2.0 TD: P1, P2, P3
                                // Intentar m√∫ltiples variantes de nombre
                                precios = {
                                    'P1': contratoActivo['Precio Energ√≠a P1'] || 
                                          contratoActivo['AT'] || 
                                          contratoActivo['Precio Energia P1'] || 
                                          contratoActivo['PRECIO ENERG√çA P1'] || 0,
                                    'P2': contratoActivo['Precio Energ√≠a P2'] || 
                                          contratoActivo['AU'] || 
                                          contratoActivo['Precio Energia P2'] || 
                                          contratoActivo['PRECIO ENERG√çA P2'] || 0,
                                    'P3': contratoActivo['Precio Energ√≠a P3'] || 
                                          contratoActivo['AV'] || 
                                          contratoActivo['Precio Energia P3'] || 
                                          contratoActivo['PRECIO ENERG√çA P3'] || 0
                                };
                            } else if (peajeNorm.includes('3.0') || peajeNorm.includes('6.1') || peajeNorm.includes('6.2')) {
                                // 3.0 TD / 6.1 TD: P1-P6
                                precios = {
                                    'P1': contratoActivo['Precio Energ√≠a P1'] || 
                                          contratoActivo['AT'] || 
                                          contratoActivo['Precio Energia P1'] || 0,
                                    'P2': contratoActivo['Precio Energ√≠a P2'] || 
                                          contratoActivo['AU'] || 
                                          contratoActivo['Precio Energia P2'] || 0,
                                    'P3': contratoActivo['Precio Energ√≠a P3'] || 
                                          contratoActivo['AV'] || 
                                          contratoActivo['Precio Energia P3'] || 0,
                                    'P4': contratoActivo['Precio Energ√≠a P4'] || 
                                          contratoActivo['AW'] || 
                                          contratoActivo['Precio Energia P4'] || 0,
                                    'P5': contratoActivo['Precio Energ√≠a P5'] || 
                                          contratoActivo['AX'] || 
                                          contratoActivo['Precio Energia P5'] || 0,
                                    'P6': contratoActivo['Precio Energ√≠a P6'] || 
                                          contratoActivo['AY'] || 
                                          contratoActivo['Precio Energia P6'] || 0
                                };
                            }
                            
                            // Logging de precios encontrados (primeros 3 contratos)
                            if (vencimientos.length < 3) {
                                console.log(`Precios para ${cliente}:`, precios);
                            }
                            
                            vencimientos.push({
                                'Identidad': identidad,
                                'Cliente': cliente,
                                'Contrato': codigo,
                                'CUPS': cups,
                                'Direcci√≥n': direccion,
                                'Grupo': grupo,
                                'Tarifa Peaje': tarifaPeaje,
                                'Tarifa': tarifa,
                                'Fecha Vencimiento': fechaVtoDate.toISOString().split('T')[0],
                                'Meses Restantes': mesesRestantes,
                                'D√≠as Restantes': diasRestantes,
                                'Consumo (kWh)': Math.round(consumo),
                                'Precio P1': precios['P1'] || '',
                                'Precio P2': precios['P2'] || '',
                                'Precio P3': precios['P3'] || '',
                                'Precio P4': precios['P4'] || '',
                                'Precio P5': precios['P5'] || '',
                                'Precio P6': precios['P6'] || '',
                                // Estado y Canal se a√±adir√°n al final despu√©s de los precios de potencia
                                '_estado_temp': diasRestantes < 0 ? '‚ö†Ô∏è VENCIDO' : diasRestantes <= 30 ? 'üî¥ URGENTE' : 'üü° PR√ìXIMO',
                                '_canal_temp': canal
                            });
                        }
                        
                        console.log(`Contratos pr√≥ximos a vencer: ${vencimientos.length}`);
                        
                        // Ordenar por d√≠as restantes (m√°s urgente primero) y luego por cliente
                        vencimientos.sort((a, b) => {
                            if (a['D√≠as Restantes'] !== b['D√≠as Restantes']) {
                                return a['D√≠as Restantes'] - b['D√≠as Restantes'];
                            }
                            return String(a.Cliente).localeCompare(String(b.Cliente));
                        });
                        
                        if (vencimientos.length > 0) {
                            // ========================================
                            // A√ëADIR PRECIOS DE POTENCIA DESDE HOJAS DE AN√ÅLISIS
                            // ========================================
                            
                            console.log('üìä A√±adiendo precios de potencia a vencimientos...');
                            
                            // Leer las hojas de an√°lisis ya creadas
                            const hojasAnalisis = {
                                '2.0TD': analisisWb.Sheets['2_0TD'],
                                '3.0TD': analisisWb.Sheets['3_0TD'],
                                '6.1TD': analisisWb.Sheets['6_1TD'],
                                '6.2TD': analisisWb.Sheets['6_2TD']
                            };
                            
                            // Convertir hojas a datos
                            const datosPorPeaje = {};
                            for (const [peaje, hoja] of Object.entries(hojasAnalisis)) {
                                if (hoja) {
                                    const datos = XLSX.utils.sheet_to_json(hoja);
                                    // Indexar por tarifa para b√∫squeda r√°pida
                                    datosPorPeaje[peaje] = new Map();
                                    datos.forEach(fila => {
                                        const tarifa = fila['Tarifa'];
                                        if (tarifa) {
                                            datosPorPeaje[peaje].set(tarifa, fila);
                                        }
                                    });
                                }
                            }
                            
                            // A√±adir precios de potencia a cada vencimiento
                            vencimientos.forEach(venc => {
                                const tarifa = venc['Grupo'];  // Columna F
                                let peaje = venc['Tarifa Peaje'] || venc['Tarifa']; // Columna G o H
                                
                                // Normalizar peaje
                                if (peaje) {
                                    peaje = peaje.replace(/\./g, '.').replace(/\s/g, '');
                                    if (peaje.includes('2.0') || peaje.includes('20TD')) peaje = '2.0TD';
                                    else if (peaje.includes('3.0') || peaje.includes('30TD')) peaje = '3.0TD';
                                    else if (peaje.includes('6.1') || peaje.includes('61TD')) peaje = '6.1TD';
                                    else if (peaje.includes('6.2') || peaje.includes('62TD')) peaje = '6.2TD';
                                }
                                
                                // Buscar precios en la hoja correspondiente
                                const mapaHoja = datosPorPeaje[peaje];
                                if (mapaHoja && tarifa) {
                                    const filaTarifa = mapaHoja.get(tarifa);
                                    if (filaTarifa) {
                                        // A√±adir precios de potencia (columnas S-X)
                                        venc['Pot P1 Anual'] = filaTarifa['Pot P1 (‚Ç¨/kW/a√±o)'] || '';
                                        venc['Pot P2 Anual'] = filaTarifa['Pot P2 (‚Ç¨/kW/a√±o)'] || '';
                                        venc['Pot P3 Anual'] = filaTarifa['Pot P3 (‚Ç¨/kW/a√±o)'] || '';
                                        venc['Pot P4 Anual'] = filaTarifa['Pot P4 (‚Ç¨/kW/a√±o)'] || '';
                                        venc['Pot P5 Anual'] = filaTarifa['Pot P5 (‚Ç¨/kW/a√±o)'] || '';
                                        venc['Pot P6 Anual'] = filaTarifa['Pot P6 (‚Ç¨/kW/a√±o)'] || '';
                                    }
                                }
                                
                                // Mover Estado y Canal al final
                                venc['Estado'] = venc['_estado_temp'];
                                venc['Canal'] = venc['_canal_temp'];
                                delete venc['_estado_temp'];
                                delete venc['_canal_temp'];
                            });
                            
                            console.log('‚úÖ Precios de potencia a√±adidos a vencimientos');
                            
                            const wsVencimientos = XLSX.utils.json_to_sheet(vencimientos);
                            XLSX.utils.book_append_sheet(analisisWb, wsVencimientos, 'Vencimientos Pr√≥ximos');
                        } else {
                            console.log('‚úì No hay contratos pr√≥ximos a vencer');
                        }
                    } else {
                        if (!contratosActivosSheet) {
                            console.warn('‚ö†Ô∏è No se encontr√≥ hoja CONTRATOSACTIVOS');
                        }
                    }
                }
                
                // ========================================
                // AN√ÅLISIS DE GAS
                // ========================================
                
                if (processedWorkbookGas && originalWorkbook) {
                    // Leer DATOSGAS del workbook ORIGINAL
                    const datosGasSheet = originalWorkbook.Sheets['DATOSGAS'];
                    const detalleGasSheet = processedWorkbookGas.Sheets['Detalle GAS'];
                    const tarifasGasNoEncontradasSheet = processedWorkbookGas.Sheets['TARIFAS_GAS_NO_ENCONTRADAS'];
                    
                    if (!datosGasSheet) {
                        console.log('‚ö†Ô∏è No se encontr√≥ hoja DATOSGAS en el workbook original');
                    }
                    
                    // Para GAS necesitamos leer la estructura de DATOSGAS que tiene las tarifas en filas y peajes en columnas
                    const tarifasGasConfiguradasMap = {};
                    
                    if (datosGasSheet) {
                        const datosGasRaw = XLSX.utils.sheet_to_json(datosGasSheet, { header: 1 });
                        
                        console.log('=== TARIFAS GAS EN DATOSGAS (original) ===');
                        console.log('Total filas:', datosGasRaw.length);
                        
                        for (let i = 1; i < datosGasRaw.length; i++) {
                            const row = datosGasRaw[i];
                            if (!row || !row[0]) continue;
                            
                            const tarifa = String(row[0]).trim();
                            const tarifaUpper = tarifa.toUpperCase();
                            
                            tarifasGasConfiguradasMap[tarifaUpper] = {
                                tarifa: tarifa,
                                comisiones: {
                                    'RL.1': parseFloat(row[1]) || 0,
                                    'RL. 1': parseFloat(row[1]) || 0,
                                    'RL.2': parseFloat(row[2]) || 0,
                                    'RL. 2': parseFloat(row[2]) || 0,
                                    'RL.3': parseFloat(row[3]) || 0,
                                    'RL. 3': parseFloat(row[3]) || 0,
                                    'RL.4': parseFloat(row[4]) || 0,
                                    'RL. 4': parseFloat(row[4]) || 0,
                                    'RL.5': parseFloat(row[5]) || 0,
                                    'RL. 5': parseFloat(row[5]) || 0
                                }
                            };
                            
                            if (i <= 10) {
                                console.log(`  "${tarifaUpper}" ‚Üí RL.1:${row[1]}, RL.2:${row[2]}, RL.3:${row[3]}, RL.4:${row[4]}, RL.5:${row[5]}`);
                            }
                        }
                        console.log(`Total tarifas GAS configuradas: ${Object.keys(tarifasGasConfiguradasMap).length}`);
                    }
                    
                    // Extraer del detalle GAS
                    const tarifasActivasGasMap = {};
                    const conteoPorTarifaGas = {};
                    
                    if (detalleGasSheet) {
                        const detalleGasData = XLSX.utils.sheet_to_json(detalleGasSheet);
                        
                        for (const row of detalleGasData) {
                            let grupo = row['Grupo'];
                            const tarifaPeaje = row['Tarifa Peaje'];
                            if (!grupo || !tarifaPeaje) continue;
                            
                            // Limpiar n√∫mero del final
                            grupo = String(grupo).trim().replace(/\s+\d+$/, '');
                            const grupoUpper = grupo.toUpperCase();
                            const peajeNorm = String(tarifaPeaje).trim().toUpperCase();
                            
                            if (!tarifasActivasGasMap[grupoUpper]) {
                                tarifasActivasGasMap[grupoUpper] = {
                                    grupo: grupo,
                                    peajes: new Set()
                                };
                            }
                            tarifasActivasGasMap[grupoUpper].peajes.add(peajeNorm);
                            
                            const key = `${grupoUpper}|${peajeNorm}`;
                            conteoPorTarifaGas[key] = (conteoPorTarifaGas[key] || 0) + 1;
                        }
                    }
                    
                    // Combinar informaci√≥n de GAS
                    const todasLasTarifasGas = new Map();
                    
                    // De configuradas
                    for (const [key, info] of Object.entries(tarifasGasConfiguradasMap)) {
                        todasLasTarifasGas.set(key, {
                            tarifa: info.tarifa,
                            comisiones: info.comisiones,
                            estado: 'CONFIGURADA',
                            peajes: [],
                            facturas: 0
                        });
                    }
                    
                    // De activas
                    for (const [key, info] of Object.entries(tarifasActivasGasMap)) {
                        const peajes = Array.from(info.peajes);
                        if (todasLasTarifasGas.has(key)) {
                            todasLasTarifasGas.get(key).estado = 'ACTIVA';
                            todasLasTarifasGas.get(key).peajes = peajes;
                        } else {
                            todasLasTarifasGas.set(key, {
                                tarifa: info.grupo,
                                comisiones: {},
                                estado: 'ACTIVA',
                                peajes: peajes,
                                facturas: 0
                            });
                        }
                    }
                    
                    // Agregar conteo de facturas
                    for (const [keyTarifa, info] of todasLasTarifasGas.entries()) {
                        let totalFacturas = 0;
                        for (const peaje of info.peajes) {
                            const key = `${keyTarifa}|${peaje}`;
                            totalFacturas += (conteoPorTarifaGas[key] || 0);
                        }
                        info.facturas = totalFacturas;
                    }
                    
                    // Clasificar por peaje GAS
                    const peajesGas = ['RL.1', 'RL.2', 'RL.3', 'RL.4', 'RL.5', 'RL. 1', 'RL. 2', 'RL. 3', 'RL. 4', 'RL. 5'];
                    const peajesUnicos = new Set();
                    
                    for (const [key, info] of todasLasTarifasGas.entries()) {
                        for (const peaje of info.peajes) {
                            peajesUnicos.add(peaje);
                        }
                    }
                    
                    for (const peaje of peajesUnicos) {
                        const tarifasDelPeaje = [];
                        
                        for (const [key, info] of todasLasTarifasGas.entries()) {
                            if (info.peajes.includes(peaje)) {
                                const keyConteo = `${key}|${peaje}`;
                                const comision = info.comisiones ? info.comisiones[peaje] || 0 : 0;
                                
                                tarifasDelPeaje.push({
                                    'Tarifa': info.tarifa,
                                    'Peaje': peaje,
                                    'Comisi√≥n': comision,
                                    'Estado': info.estado,
                                    'Facturas': conteoPorTarifaGas[keyConteo] || 0
                                });
                            }
                        }
                        
                        tarifasDelPeaje.sort((a, b) => {
                            if (a.Estado === 'ACTIVA' && b.Estado !== 'ACTIVA') return -1;
                            if (a.Estado !== 'ACTIVA' && b.Estado === 'ACTIVA') return 1;
                            return b.Facturas - a.Facturas; // Mayor a menor
                        });
                        
                        if (tarifasDelPeaje.length > 0) {
                            const ws = XLSX.utils.json_to_sheet(tarifasDelPeaje);
                            const nombreHoja = peaje.replace('.', '_').replace(' ', '');
                            XLSX.utils.book_append_sheet(analisisWb, ws, nombreHoja);
                        }
                    }
                    
                    // Hoja resumen GAS
                    const resumenGas = [];
                    for (const [key, info] of todasLasTarifasGas.entries()) {
                        resumenGas.push({
                            'Tarifa': info.tarifa,
                            'Estado': info.estado,
                            'Peajes': info.peajes.join(', '),
                            'Facturas': info.facturas
                        });
                    }
                    
                    resumenGas.sort((a, b) => {
                        // Primero por estado (ACTIVA primero)
                        if (a.Estado === 'ACTIVA' && b.Estado !== 'ACTIVA') return -1;
                        if (a.Estado !== 'ACTIVA' && b.Estado === 'ACTIVA') return 1;
                        // Luego por n√∫mero de facturas (mayor a menor)
                        return b.Facturas - a.Facturas;
                    });
                    
                    const wsResumenGas = XLSX.utils.json_to_sheet(resumenGas);
                    XLSX.utils.book_append_sheet(analisisWb, wsResumenGas, 'Resumen Gas');
                }
                
                // Descargar el archivo
                const timestamp = new Date().toISOString().split('T')[0];
                XLSX.writeFile(analisisWb, `Analisis_Tarifas_${timestamp}.xlsx`);
                
                // Guardar datos para el visor en localStorage leyendo del workbook
                try {
                    console.log('üîÑ Intentando guardar datos en localStorage...');
                    const datosParaVisor = {
                        timestamp: new Date().toISOString(),
                        datos: {}
                    };
                    
                    // Leer cada hoja del workbook y guardar como JSON
                    analisisWb.SheetNames.forEach(sheetName => {
                        console.log('  Procesando hoja:', sheetName);
                        const sheet = analisisWb.Sheets[sheetName];
                        if (sheetName === 'Resumen Completo') {
                            datosParaVisor.datos.resumenCompleto = evaluarResumenCompleto(sheet);
                        } else {
                            const nombreNormalizado = sheetName.replace(/\./g, '_').replace(/\s/g, '_');
                            datosParaVisor.datos[nombreNormalizado] = XLSX.utils.sheet_to_json(sheet);
                            console.log('    ‚Üí Guardado como:', nombreNormalizado, '(' + datosParaVisor.datos[nombreNormalizado].length + ' filas)');
                        }
                    });
                    
                    const jsonString = JSON.stringify(datosParaVisor);
                    const sizeKB = (jsonString.length / 1024).toFixed(2);
                    console.log('üì¶ Tama√±o de datos a guardar:', sizeKB, 'KB');
                    
                    localStorage.setItem('datosAnalisisTarifas', jsonString);
                    console.log('‚úÖ Datos guardados en localStorage para el visor');
                    console.log('üìä Hojas guardadas:', Object.keys(datosParaVisor.datos).join(', '));
                    
                    showStatus('‚úÖ An√°lisis generado. Datos guardados para el visor.', 'success');
                    
                } catch (error) {
                    console.error('‚ùå Error guardando en localStorage:', error);
                    if (error.name === 'QuotaExceededError') {
                        showStatus('‚ö†Ô∏è An√°lisis generado. Datos muy grandes, usa el Excel para abrir el visor.', 'warning');
                    } else {
                        console.warn('No se pudieron guardar datos en localStorage:', error);
                        showStatus('‚úÖ An√°lisis de tarifas generado', 'success');
                    }
                    return;
                }
                
                showStatus('‚úÖ An√°lisis de tarifas generado', 'success');
                
            } catch (error) {
                console.error('‚ùå‚ùå‚ùå ERROR EN AN√ÅLISIS:', error);
                console.error('Stack trace:', error.stack);
                showStatus('‚ùå Error generando an√°lisis: ' + error.message, 'error');
            }
            
            } catch (outerError) {
                console.error('‚ùå‚ùå‚ùå ERROR OUTER:', outerError);
                console.error('Stack trace:', outerError.stack);
            }
        }
        
        // ==========================================
        // VISOR INTERACTIVO WEB - TODO EN UN HTML
        // ==========================================
        
        // Funci√≥n auxiliar para evaluar f√≥rmulas simples del Resumen Completo
        function evaluarResumenCompleto(sheet) {
            const range = XLSX.utils.decode_range(sheet['!ref']);
            const data = [];
            
            for (let R = range.s.r; R <= range.e.r; R++) {
                const row = [];
                for (let C = range.s.c; C <= range.e.c; C++) {
                    const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                    const cell = sheet[cellAddress];
                    
                    if (!cell) {
                        row.push('');
                    } else if (cell.f) {
                        const formula = cell.f;
                        if (formula.startsWith('SUM(')) {
                            const match = formula.match(/SUM\(([A-Z]+)(\d+):([A-Z]+)(\d+)\)/);
                            if (match) {
                                const col = match[1].charCodeAt(0) - 65;
                                const rowStart = parseInt(match[2]) - 1;
                                const rowEnd = parseInt(match[4]) - 1;
                                let sum = 0;
                                console.log(`      SUM ${cellAddress}=${formula} ‚Üí col ${col}, filas ${rowStart}-${rowEnd}`);
                                for (let r = rowStart; r <= rowEnd; r++) {
                                    // SIEMPRE usar valores ya evaluados de data
                                    if (data[r] && data[r][col] !== undefined && data[r][col] !== '') {
                                        const val = data[r][col];
                                        if (typeof val === 'number') {
                                            console.log(`        Fila ${r+1}: ${val}`);
                                            sum += val;
                                        }
                                    }
                                }
                                console.log(`        ‚Üí Total: ${sum}`);
                                row.push(sum);
                            } else {
                                row.push(0);
                            }
                        } else if (formula.match(/^[A-Z]+\d+$/)) {
                            // Referencia simple como =C7
                            const refMatch = formula.match(/([A-Z]+)(\d+)/);
                            if (refMatch) {
                                const refCol = refMatch[1].charCodeAt(0) - 65;
                                const refRow = parseInt(refMatch[2]) - 1;
                                console.log(`      Referencia ${cellAddress}=${formula} ‚Üí buscar fila ${refRow} col ${refCol}`);
                                // Usar valor ya evaluado si existe
                                if (data[refRow] && data[refRow][refCol] !== undefined && data[refRow][refCol] !== '') {
                                    console.log(`        ‚úì Encontrado en data: ${data[refRow][refCol]}`);
                                    row.push(data[refRow][refCol]);
                                } else {
                                    console.log(`        ‚úó No en data, buscar en sheet`);
                                    const refCell = sheet[formula];
                                    const val = refCell && refCell.v !== undefined ? refCell.v : '';
                                    console.log(`        Valor en sheet: ${val}`);
                                    row.push(val);
                                }
                            } else {
                                row.push('');
                            }
                        } else if (formula.includes('*12')) {
                            const match = formula.match(/([A-Z]+)(\d+)\*12/);
                            if (match) {
                                const refAddr = match[1] + match[2];
                                const refCell = sheet[refAddr];
                                row.push(refCell && typeof refCell.v === 'number' ? refCell.v * 12 : 0);
                            } else {
                                row.push(0);
                            }
                        } else if (formula.includes('+')) {
                            // Suma de celdas como =B18+B19
                            const parts = formula.split('+');
                            let sum = 0;
                            parts.forEach(part => {
                                const trimmed = part.trim();
                                const refMatch = trimmed.match(/([A-Z]+)(\d+)/);
                                if (refMatch) {
                                    const refCol = refMatch[1].charCodeAt(0) - 65;
                                    const refRow = parseInt(refMatch[2]) - 1;
                                    // Usar valor ya evaluado si existe
                                    if (data[refRow] && data[refRow][refCol] !== undefined && data[refRow][refCol] !== '') {
                                        const val = data[refRow][refCol];
                                        if (typeof val === 'number') sum += val;
                                    } else {
                                        const refCell = sheet[trimmed];
                                        if (refCell && typeof refCell.v === 'number') sum += refCell.v;
                                    }
                                }
                            });
                            row.push(sum);
                        } else {
                            row.push(0);
                        }
                    } else {
                        row.push(cell.v !== undefined ? cell.v : '');
                    }
                }
                data.push(row);
            }
            return data;
        }
        
        document.getElementById('abrirVisorBtn').addEventListener('click', () => {
            console.log('üé® Click en Abrir Visor Web');
            
            // Primero intentar cargar desde localStorage
            const datosGuardados = localStorage.getItem('datosAnalisisTarifas');
            console.log('üì¶ localStorage tiene datos:', datosGuardados ? 'S√ç (' + (datosGuardados.length/1024).toFixed(2) + ' KB)' : 'NO');
            
            if (datosGuardados) {
                try {
                    const datosParseados = JSON.parse(datosGuardados);
                    console.log('‚úÖ Datos parseados correctamente');
                    console.log('üìÖ Timestamp:', datosParseados.timestamp);
                    console.log('üìä Hojas disponibles:', Object.keys(datosParseados.datos).join(', '));
                    
                    const fechaGuardado = new Date(datosParseados.timestamp);
                    const ahora = new Date();
                    const horasTranscurridas = (ahora - fechaGuardado) / (1000 * 60 * 60);
                    console.log('‚è±Ô∏è Horas transcurridas:', horasTranscurridas.toFixed(2));
                    
                    // Si los datos tienen menos de 24 horas, usarlos
                    if (horasTranscurridas < 24) {
                        console.log('‚úÖ Datos frescos, abriendo visor autom√°ticamente');
                        showStatus('‚úÖ Abriendo visor con datos guardados (' + fechaGuardado.toLocaleString('es-ES') + ')', 'success');
                        abrirVisorEnNuevaVentana(datosParseados.datos);
                        return;
                    } else {
                        console.log('‚ö†Ô∏è Datos antiguos (m√°s de 24h)');
                        showStatus('‚ö†Ô∏è Datos guardados tienen m√°s de 24h. Selecciona el Excel actualizado.', 'warning');
                    }
                } catch (error) {
                    console.error('‚ùå Error al parsear datos guardados:', error);
                }
            } else {
                console.log('‚ÑπÔ∏è No hay datos guardados en localStorage');
            }
            
            // Si no hay datos guardados o son antiguos, pedir el archivo
            console.log('üìÇ Abriendo selector de archivos...');
            showStatus('üìÇ Selecciona el Excel generado...', 'info');
            document.getElementById('excelVisorInput').click();
        });
        
        document.getElementById('excelVisorInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            showStatus('üìä Cargando ' + file.name + '...', 'info');
            
            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, {type: 'array'});
                
                // Extraer datos normalizando nombres
                const datosVisor = {};
                workbook.SheetNames.forEach(sheetName => {
                    const sheet = workbook.Sheets[sheetName];
                    const nombreNormalizado = sheetName.replace(/\./g, '_').replace(/\s/g, '_');
                    if (sheetName === 'Resumen Completo') {
                        datosVisor.resumenCompleto = evaluarResumenCompleto(sheet);
                    } else {
                        datosVisor[nombreNormalizado] = XLSX.utils.sheet_to_json(sheet);
                    }
                });
                
                // Guardar en localStorage
                const datosParaGuardar = {
                    timestamp: new Date().toISOString(),
                    datos: datosVisor
                };
                localStorage.setItem('datosAnalisisTarifas', JSON.stringify(datosParaGuardar));
                console.log('‚úÖ Datos guardados desde Excel seleccionado');
                
                // Crear ventana del visor
                abrirVisorEnNuevaVentana(datosVisor);
                showStatus('‚úÖ Visor abierto', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showStatus('‚ùå Error: ' + error.message, 'error');
            }
            
            e.target.value = '';
        });
        
        function abrirVisorEnNuevaVentana(datos) {
            const visorWindow = window.open('', '_blank', 'width=1400,height=900');
            if (!visorWindow) {
                alert('Permite popups para abrir el visor');
                return;
            }
            
            // Construir HTML usando concatenaci√≥n (sin template literals)
            const datosJSON = JSON.stringify(datos);
            
            let html = '<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8">';
            html += '<meta name="viewport" content="width=device-width, initial-scale=1.0">';
            html += '<title>Visor Interactivo</title>';
            html += '<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></scr' + 'ipt>';
            html += '<style>';
            html += '*{margin:0;padding:0;box-sizing:border-box}';
            html += 'body{font-family:system-ui;background:linear-gradient(135deg,#667eea,#764ba2);padding:20px;min-height:100vh}';
            html += '.container{max-width:1600px;margin:0 auto;background:#fff;border-radius:20px;padding:40px;box-shadow:0 20px 60px rgba(0,0,0,0.3)}';
            html += 'h1{text-align:center;color:#667eea;margin-bottom:20px;font-size:2.5em}';
            html += '.info-banner{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:15px 25px;border-radius:10px;margin-bottom:30px;text-align:center}';
            html += '.tabs{display:flex;gap:10px;margin-bottom:30px;border-bottom:3px solid #667eea;flex-wrap:wrap}';
            html += '.tab{padding:15px 25px;cursor:pointer;border:none;background:#f5f5f5;border-radius:10px 10px 0 0;font-weight:600;transition:all 0.3s}';
            html += '.tab:hover{background:#e0e0e0}';
            html += '.tab.active{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}';
            html += '.tab-content{display:none}';
            html += '.tab-content.active{display:block}';
            html += '.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:25px;margin-bottom:40px}';
            html += '.kpi-card{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:30px;border-radius:15px;text-align:center;box-shadow:0 10px 30px rgba(102,126,234,0.4);transition:transform 0.3s}';
            html += '.kpi-card:hover{transform:translateY(-8px)}';
            html += '.kpi-value{font-size:3em;font-weight:bold;margin:15px 0}';
            html += '.kpi-label{opacity:0.95;font-size:1em;text-transform:uppercase;letter-spacing:2px}';
            html += 'table{width:100%;border-collapse:collapse;margin:20px 0;font-size:14px}';
            html += 'th,td{padding:15px;text-align:left;border-bottom:1px solid #eee}';
            html += 'th{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-weight:600;position:sticky;top:0}';
            html += 'tr:hover{background:#f9f9f9}';
            html += '.search-box{width:100%;max-width:400px;padding:12px 20px;border:2px solid #667eea;border-radius:25px;margin-bottom:20px}';
            html += '.chart-container{background:#fff;padding:30px;border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,0.1);margin-bottom:30px}';
            html += '.chart-box{position:relative;height:400px}';
            html += '.badge{display:inline-block;padding:5px 12px;border-radius:20px;font-size:12px;font-weight:600}';
            html += '.badge-success{background:#22c55e;color:#fff}';
            html += '.badge-warning{background:#f59e0b;color:#fff}';
            html += '.badge-danger{background:#ef4444;color:#fff}';
            html += '.alert{padding:15px 20px;border-radius:10px;margin:10px 0;font-weight:500}';
            html += '.alert-danger{background:#fee;color:#c00;border-left:4px solid #c00}';
            html += '.alert-warning{background:#ffc;color:#880;border-left:4px solid #fa0}';
            html += 'h2{color:#667eea;margin:30px 0 20px;font-size:1.8em}';
            html += '</style></head><body>';
            html += '<div class="container">';
            html += '<h1>üé® Visor Interactivo - An√°lisis de Tarifas</h1>';
            
            // Info banner
            const fechaCarga = new Date().toLocaleString('es-ES');
            html += '<div class="info-banner">';
            html += 'üìä <strong>Datos cargados autom√°ticamente</strong> | √öltima carga: ' + fechaCarga;
            html += '</div>';
            
            // Tabs
            html += '<div class="tabs">';
            html += '<button class="tab active" onclick="cambiarTab(event,' + "'dashboard'" + ')">üìä Dashboard</button>';
            html += '<button class="tab" onclick="cambiarTab(event,' + "'electricidad'" + ')">‚ö° Electricidad</button>';
            html += '<button class="tab" onclick="cambiarTab(event,' + "'gas'" + ')">üî• Gas</button>';
            html += '<button class="tab" onclick="cambiarTab(event,' + "'vencimientos'" + ')">üìÖ Vencimientos</button>';
            html += '<button class="tab" onclick="cambiarTab(event,' + "'resumen'" + ')">üìà Resumen</button>';
            html += '</div>';
            
            // Tab contents
            html += '<div id="dashboard" class="tab-content active"></div>';
            html += '<div id="electricidad" class="tab-content"></div>';
            html += '<div id="gas" class="tab-content"></div>';
            html += '<div id="vencimientos" class="tab-content"></div>';
            html += '<div id="resumen" class="tab-content"></div>';
            
            html += '</div>';
            
            // Script
            html += '<scr' + 'ipt>';
            html += 'const datos = ' + datosJSON + ';';
            
            html += 'function cambiarTab(e,id){';
            html += 'document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));';
            html += 'document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));';
            html += 'e.target.classList.add("active");';
            html += 'document.getElementById(id).classList.add("active");';
            html += '}';
            
            html += 'function fmt(n){return new Intl.NumberFormat("es-ES").format(Math.round(n))}';
            html += 'function fmtCur(n){return new Intl.NumberFormat("es-ES",{style:"currency",currency:"EUR"}).format(n)}';
            
            html += 'function renderTabla(datos,titulo){';
            html += 'if(!datos||datos.length===0)return "<p style=' + "'text-align:center;padding:40px;color:#999'" + '>No hay datos</p>";';
            html += 'const keys=Object.keys(datos[0]);';
            html += 'let html="<h2>"+titulo+"</h2><input class=' + "'search-box'" + ' placeholder=' + "'üîç Buscar...'" + ' onkeyup=' + "'filtrarTabla(this)'" + '><table><thead><tr>";';
            html += 'keys.forEach(k=>html+="<th>"+k+"</th>");';
            html += 'html+="</tr></thead><tbody>";';
            html += 'datos.forEach(row=>{';
            html += 'html+="<tr>";';
            html += 'keys.forEach(k=>{';
            html += 'let val=row[k]||"";';
            html += 'let cls="";';
            html += 'if(k==="Estado"){';
            html += 'if(val==="ACTIVA")cls="badge badge-success";';
            html += 'else if(val==="CONFIGURADA")cls="badge badge-warning";';
            html += 'else cls="badge badge-danger";';
            html += '}';
            html += 'if(typeof val==="number"&&k.includes("Beneficio"))val=fmtCur(val);';
            html += 'else if(typeof val==="number"&&k.includes("Consumo"))val=fmt(val);';
            html += 'else if(typeof val==="number")val=fmt(val);';
            html += 'html+="<td><span class=' + "'" + '"+cls+"' + "'" + '>"+val+"</span></td>";';
            html += '});';
            html += 'html+="</tr>";';
            html += '});';
            html += 'html+="</tbody></table>";';
            html += 'return html;';
            html += '}';
            
            html += 'function filtrarTabla(input){';
            html += 'const filter=input.value.toUpperCase();';
            html += 'const rows=input.nextElementSibling.querySelectorAll("tbody tr");';
            html += 'rows.forEach(row=>{';
            html += 'row.style.display=row.textContent.toUpperCase().includes(filter)?"":"none";';
            html += '});';
            html += '}';
            
            // Renderizar dashboard
            html += 'let totalIndex=0,totalFijos=0,beneficioTotal=0;';
            html += 'const datosPeajes={};';
            html += '["2_0TD","3_0TD","6_1TD","6_2TD"].forEach(sheet=>{';
            html += 'if(datos[sheet]){';
            html += 'datosPeajes[sheet]={index:0,fijos:0,beneficio:0};';
            html += 'datos[sheet].forEach(row=>{';
            html += 'const esIndex=(row.Tarifa||"").toUpperCase().includes("INDEX");';
            html += 'const facturas=row.Facturas||0;';
            html += 'const beneficio=row["Beneficio (‚Ç¨)"]||0;';
            html += 'if(esIndex){';
            html += 'totalIndex+=facturas;';
            html += 'datosPeajes[sheet].index+=facturas;';
            html += 'datosPeajes[sheet].beneficio+=beneficio;';
            html += 'beneficioTotal+=beneficio;';
            html += '}else{';
            html += 'totalFijos+=facturas;';
            html += 'datosPeajes[sheet].fijos+=facturas;';
            html += '}';
            html += '});';
            html += '}';
            html += '});';
            
            html += 'document.getElementById("dashboard").innerHTML=';
            html += '"<div class=' + "'kpi-grid'" + '>";';
            html += 'document.getElementById("dashboard").innerHTML+=';
            html += '"<div class=' + "'kpi-card'" + '><div class=' + "'kpi-label'" + '>Contratos INDEX</div><div class=' + "'kpi-value'" + '>"+fmt(totalIndex)+"</div></div>";';
            html += 'document.getElementById("dashboard").innerHTML+=';
            html += '"<div class=' + "'kpi-card'" + '><div class=' + "'kpi-label'" + '>Contratos FIJOS</div><div class=' + "'kpi-value'" + '>"+fmt(totalFijos)+"</div></div>";';
            html += 'document.getElementById("dashboard").innerHTML+=';
            html += '"<div class=' + "'kpi-card'" + '><div class=' + "'kpi-label'" + '>Beneficio Mensual</div><div class=' + "'kpi-value'" + '>"+fmtCur(beneficioTotal)+"</div></div>";';
            html += 'document.getElementById("dashboard").innerHTML+=';
            html += '"<div class=' + "'kpi-card'" + '><div class=' + "'kpi-label'" + '>Beneficio Anual</div><div class=' + "'kpi-value'" + '>"+fmtCur(beneficioTotal*12)+"</div></div>";';
            html += 'document.getElementById("dashboard").innerHTML+="</div>";';
            
            html += 'document.getElementById("dashboard").innerHTML+=';
            html += '"<div class=' + "'chart-container'" + '><h2>üìä Distribuci√≥n de Contratos</h2><div class=' + "'chart-box'" + '><canvas id=' + "'chart1'" + '></canvas></div></div>";';
            html += 'document.getElementById("dashboard").innerHTML+=';
            html += '"<div class=' + "'chart-container'" + '><h2>üí∞ Beneficios INDEX</h2><div class=' + "'chart-box'" + '><canvas id=' + "'chart2'" + '></canvas></div></div>";';
            
            html += 'new Chart(document.getElementById("chart1"),{';
            html += 'type:"bar",';
            html += 'data:{';
            html += 'labels:Object.keys(datosPeajes),';
            html += 'datasets:[{label:"INDEX",data:Object.values(datosPeajes).map(d=>d.index),backgroundColor:"rgba(102,126,234,0.8)"},';
            html += '{label:"FIJOS",data:Object.values(datosPeajes).map(d=>d.fijos),backgroundColor:"rgba(118,75,162,0.8)"}]';
            html += '},';
            html += 'options:{responsive:true,maintainAspectRatio:false}';
            html += '});';
            
            html += 'new Chart(document.getElementById("chart2"),{';
            html += 'type:"pie",';
            html += 'data:{';
            html += 'labels:Object.keys(datosPeajes),';
            html += 'datasets:[{data:Object.values(datosPeajes).map(d=>d.beneficio),backgroundColor:["#667eea","#764ba2","#ed64a6","#2ec4b6"]}]';
            html += '},';
            html += 'options:{responsive:true,maintainAspectRatio:false}';
            html += '});';
            
            // Electricidad
            html += 'let htmlElec="<h2>‚ö° Tarifas Electricidad</h2>";';
            html += '["2_0TD","3_0TD","6_1TD","6_2TD"].forEach(sheet=>{';
            html += 'if(datos[sheet])htmlElec+=renderTabla(datos[sheet],sheet.replace("_","."));';
            html += '});';
            html += 'document.getElementById("electricidad").innerHTML=htmlElec;';
            
            // Gas
            html += 'let htmlGas="<h2>üî• Tarifas Gas</h2>";';
            html += '["RL_1","RL_2","RL_3","RL_4","RL_5"].forEach(sheet=>{';
            html += 'if(datos[sheet])htmlGas+=renderTabla(datos[sheet],sheet.replace("_","."));';
            html += '});';
            html += 'if(datos.Resumen_Gas||datos.resumenGas)htmlGas+=renderTabla(datos.Resumen_Gas||datos.resumenGas,"Resumen Gas");';
            html += 'document.getElementById("gas").innerHTML=htmlGas;';
            
            // Vencimientos
            html += 'if(datos.Vencimientos_Pr√≥ximos||datos.vencimientos){';
            html += 'const datosVenc=datos.Vencimientos_Pr√≥ximos||datos.vencimientos;';
            html += 'const vencidos=datosVenc.filter(v=>v["D√≠as Restantes"]<0);';
            html += 'const urgentes=datosVenc.filter(v=>v["D√≠as Restantes"]>=0&&v["D√≠as Restantes"]<=30);';
            html += 'let htmlVenc="";';
            html += 'if(vencidos.length>0)htmlVenc+="<div class=' + "'alert alert-danger'" + '>‚ö†Ô∏è <strong>"+vencidos.length+" contratos vencidos</strong></div>";';
            html += 'if(urgentes.length>0)htmlVenc+="<div class=' + "'alert alert-warning'" + '>üî¥ <strong>"+urgentes.length+" contratos urgentes (‚â§30 d√≠as)</strong></div>";';
            html += 'htmlVenc+=renderTabla(datosVenc,"Todos los Vencimientos");';
            html += 'document.getElementById("vencimientos").innerHTML=htmlVenc;';
            html += '}';
            
            // Resumen
            html += 'if(datos.resumenCompleto){';
            html += 'let htmlRes="<h2>üìà Resumen Completo</h2><table style=' + "'width:100%'" + '>";';
            html += 'datos.resumenCompleto.forEach((row,idx)=>{';
            html += 'if(!row||row.length===0)return;';
            html += 'htmlRes+="<tr>";';
            html += 'row.forEach((cell,colIdx)=>{';
            html += 'let val=cell||"";';
            html += 'if(typeof val==="number"&&val!==0){';
            html += 'if(colIdx>=4){val=fmtCur(val);}';
            html += 'else{val=fmt(val);}';
            html += '}';
            html += 'const isHeader=idx===0||idx===1||String(row[0]).includes("CONTRATOS")||String(row[0]).includes("CONSUMOS")||String(row[0]).includes("TOTAL");';
            html += 'const style=isHeader?"font-weight:bold;background:#f5f5f5;padding:12px":"padding:10px";';
            html += 'htmlRes+="<td style=' + "'" + '"+style+"' + "'" + '>"+val+"</td>";';
            html += '});';
            html += 'htmlRes+="</tr>";';
            html += '});';
            html += 'htmlRes+="</table>";';
            html += 'document.getElementById("resumen").innerHTML=htmlRes;';
            html += '}';
            
            html += '</scr' + 'ipt>';
            html += '</body></html>';
            
            visorWindow.document.write(html);
            visorWindow.document.close();
        }

    </script>
</body>
</html>
