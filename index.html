<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-title">DRK: Comparador Multitarifa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluimos QRCode.js y jsQR.min.js para el manejo de QR -->
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <!-- LibrerÃ­as para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // --- TAILWIND CONFIGURATION ---
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        drk: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            400: '#38bdf8', /* Lighter Blue for Active Hover */
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1', /* AÃ‘ADIDO */
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        powercup: {
                            50: '#f7fee7',
                            100: '#ecfccb',
                            400: '#a3e635', /* Lighter Green for Active Hover */
                            500: '#84cc16',
                            600: '#65a30d',
                            700: '#4d7c0f', /* AÃ‘ADIDO */
                            800: '#3f6212',
                            900: '#365314',
                            'yellow-flash': '#facc15',
                        },
                        // Nuevos colores para asegurar el verde en el flujo de resultados y CTA
                        'cta-green': {
                            500: '#16a34a', /* Usado para los ahorros */
                            600: '#15803d',
                        },
                        'cta-red': {
                            500: '#CC0000',
                            600: '#A00000',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* === SISTEMA PANTALLAS === */
        .screen { display: none; }
        .screen.active { display: block; }
        
        /* Estilos base y animaciones */
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        #interactive.viewport { position: relative; width: 100%; height: auto; overflow: hidden; border-radius: 1rem; }
        #interactive.viewport > video { width: 100%; height: 100%; object-fit: cover; }
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .mode-selector { border: 2px solid; }

        /* Estilos de los botones de selecciÃ³n de tarifa (Landing Page) */
        .tariff-select-btn {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 1rem; /* p-4 */
            background-color: white;
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); /* shadow-lg */
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0; /* slate-200 */
        }
        
        /* DRK Active Hover Styles (Default) */
        .drk-active .tariff-select-btn:hover {
            border-color: #0ea5e9; /* drk-500 */
            background-color: #f0f9ff; /* drk-50 */
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(14, 165, 233, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
        }
        .drk-active .tariff-select-btn:hover .arrow-icon {
            color: #0ea5e9; /* drk-500 */
        }

        /* POWER CUP Active Hover Styles */
        .powercup-active .tariff-select-btn:hover {
            border-color: #84cc16; /* powercup-500 */
            background-color: #f7fee7; /* powercup-50 */
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(132, 204, 22, 0.2), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
        }
        .powercup-active .tariff-select-btn:hover .arrow-icon {
            color: #84cc16; /* powercup-500 */
        }

        .icon-wrapper {
            padding: 0.75rem; /* p-3 */
            border-radius: 0.75rem; /* rounded-xl */
            margin-right: 1rem; /* mr-4 */
            flex-shrink: 0;
            transition: background-color 0.3s;
        }

        .arrow-icon {
            margin-left: auto;
            font-size: 1.5rem;
            color: #94a3b8; /* slate-400 */
            transition: color 0.3s ease;
        }

        /* Estilos QR */
        #qr-content-wrapper { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; overflow: hidden; max-height: 0; opacity: 0; }
        #qr-content-wrapper.active { max-height: 500px; opacity: 1; }
        #qr-visual-container { 
            position: relative; 
            display: inline-block; 
            background-color: white; 
            border-radius: 1rem; 
            padding: 1rem; 
            border: 4px solid var(--qr-border-color, #0ea5e9); 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        /* Texto central del QR */
        #qr-visual-container::before { 
            content: var(--qr-center-text, "DRK"); 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            font-size: 20px; /* TamaÃ±o reducido para no cubrir tanto */
            font-weight: bold; 
            color: #ffffff; 
            background-color: var(--qr-center-bg, #0c4a6e); 
            padding: 4px 8px; /* Padding reducido */
            border-radius: 6px; 
            z-index: 10; 
            opacity: 0.95; 
            min-width: 60px;
            text-align: center;
        }
        
        /* Ocultar elementos dependiendo del tipo de tarifa */
        .hidden-period { display: none; }
        
        /* Estilos para el campo de pegado temporal (FIX para Ctrl+V) */
        #paste-catcher {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: -1; /* Oculto por defecto */
            width: 0;
            height: 0;
            opacity: 0;
            pointer-events: none;
            transition: all 0.15s ease-in-out;
            resize: none;
        }

        #paste-catcher.pasting-active {
            width: 200px; 
            height: 100px; 
            opacity: 0.01; /* Debe ser casi transparente, pero no 0 */
            z-index: 1000; /* Siempre visible cuando activo */
            border: 4px dashed var(--qr-border-color, #0ea5e9);
            background-color: white;
        }
        
        /* === ESTILOS PARA SISTEMA DE PESTAÃ‘AS === */
        /* Ocultar scrollbar en menÃº de navegaciÃ³n */
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        /* Estilos para pestaÃ±as de secciÃ³n */
        .section-tab {
            transition: all 0.2s ease;
        }
        
        .border-b-3 {
            border-bottom-width: 3px;
        }
        
        .section-tab.active {
            color: #0ea5e9 !important;
            background-color: #f0f9ff !important;
            border-bottom-color: #0ea5e9 !important;
        }
        
        /* AnimaciÃ³n suave para cambio de secciones */
        .section-content {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen text-slate-800 drk-active">

    <!-- Navbar -->
    <div id="navbar" class="w-full bg-drk-900 text-white p-4 shadow-md sticky top-0 z-50 transition-colors duration-300">
        <div class="max-w-lg mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold tracking-tight cursor-pointer" onclick="resetToLanding()">
                <span id="app-logo-main">DRK</span> <span class="text-drk-500" id="app-logo-accent">EnergÃ­a</span>
            </h1>
            
            <!-- Language Selector -->
            <div class="flex items-center gap-3">
                <div class="relative">
                    <select id="language-selector" onchange="if(window.LANG) window.LANG.change(this.value)" 
                            class="bg-drk-800 text-white text-xs px-3 py-1.5 rounded border border-drk-700 cursor-pointer hover:bg-drk-700 transition-colors appearance-none pr-8 font-semibold">
                        <option value="es">ðŸ‡ªðŸ‡¸ ES</option>
                        <option value="en">ðŸ‡¬ðŸ‡§ EN</option>
                        <option value="zh">ðŸ‡¨ðŸ‡³ ZH</option>
                        <option value="de">ðŸ‡©ðŸ‡ª DE</option>
                        <option value="fr">ðŸ‡«ðŸ‡· FR</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-white">
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>
                <span class="text-xs bg-drk-800 px-2 py-1 rounded text-drk-100" id="app-subtitle">Selector</span>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="app" class="w-full max-w-lg mx-auto p-4 md:p-6 flex-grow">

        <!-- MODO DE COMPARACIÃ“N (OCULTO - Solo DRK Ãšnicamente activo por defecto) -->
        <div id="modo-comparacion-section" class="fade-in mb-6" style="display: none;">
            <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-drk-500">
                <p class="text-sm font-bold text-drk-800 mb-3 text-center uppercase tracking-wider">MODO DE COMPARACIÃ“N</p>
                <div class="flex flex-wrap justify-center gap-2 text-sm">
                    <label class="mode-selector flex-1 px-2 py-2 rounded-lg cursor-pointer transition border-2 border-drk-500 text-white bg-drk-500 hover:bg-drk-600">
                        <input type="radio" name="comparison_mode" value="drk_only" class="hidden" checked>
                        <span class="font-semibold flex items-center justify-between w-full">DRK Ãšnicamente<svg class="w-4 h-4 ml-1 checkmark-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                    </label>
                    <!-- DRK Prioritario y POWER CUP ocultados para versiÃ³n comerciales DRK -->
                    <!--
                    <label class="mode-selector flex-1 px-2 py-2 rounded-lg cursor-pointer transition border-2 border-drk-300 text-drk-700 bg-white hover:bg-drk-100 hover:border-drk-400">
                        <input type="radio" name="comparison_mode" value="drk_prioritized" class="hidden">
                        <span class="font-semibold flex items-center justify-between w-full">DRK Prioritario<svg class="w-4 h-4 ml-1 checkmark-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                    </label>
                    <label class="mode-selector flex-1 px-2 py-2 rounded-lg cursor-pointer transition border-2 border-powercup-300 text-powercup-700 bg-white hover:bg-powercup-100 hover:border-powercup-400">
                        <input type="radio" name="comparison_mode" value="overall_best" class="hidden">
                        <span class="font-black flex flex-col items-center justify-center w-full leading-tight">
                            <span class="text-base">POWER CUP</span><span class="text-xs font-semibold -mt-0.5">Global</span>
                        </span>
                        <svg class="w-4 h-4 ml-1 checkmark-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    </label>
                    -->
                </div>
            </div>
        </div>

        <!-- PANTALLA INICIAL: Solo selector de servicio -->
        <div id="screen-inicio" class="screen active">
            <div class="fade-in flex flex-col items-center justify-center min-h-[40vh] py-8">
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-drk-500">
                    <div class="w-16 h-16 bg-drk-50 rounded-full flex items-center justify-center mx-auto mb-4 text-drk-600 shadow-inner">
                        <svg class="w-8 h-8" viewBox="0 0 100 100" fill="none">
                            <style>.drk-ring{fill:none;stroke-width:10;stroke-linecap:round;}</style>
                            <circle class="drk-ring" cx="45" cy="45" r="35" stroke="#E50000"/>
                            <circle class="drk-ring" cx="55" cy="55" r="35" stroke="#FFCC00"/>
                            <circle class="drk-ring" cx="45" cy="55" r="35" stroke="#0079C1"/>
                            <circle class="drk-ring" cx="55" cy="45" r="35" stroke="#00A859"/>
                        </svg>
                    </div>
                    <h2 id="inicio-title" class="text-3xl font-black text-drk-900 mb-2 text-center">DRK COMPARADOR</h2>
                    <p id="inicio-subtitle" class="text-slate-500 mb-6 text-center">Selecciona el tipo de suministro.</p>
                    
                    <!-- SELECTOR DE SERVICIO -->
                    <div class="pt-4 border-t border-slate-200">
                        <p id="inicio-supply-label" class="text-sm font-bold text-drk-800 mb-4 text-center uppercase tracking-wider">TIPO DE SUMINISTRO</p>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <button onclick="goToElectricidad()" style="padding: 2rem; border-radius: 1.5rem; border: 4px solid #cbd5e1; background: white; text-align: center; cursor: pointer;">
                                <div style="font-size: 3rem; margin-bottom: 0.75rem;">âš¡</div>
                                <div style="font-size: 1.25rem; font-weight: 900; color: #1e3a8a;">ELECTRICIDAD</div>
                                <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.5rem;">MULTICUPS Â· 2.0 TD Â· 3.0 TD</div>
                            </button>
                            
                            <button onclick="goToGas()" style="padding: 2rem; border-radius: 1.5rem; border: 4px solid #cbd5e1; background: white; text-align: center; cursor: pointer;">
                                <div style="font-size: 3rem; margin-bottom: 0.75rem;">ðŸ”¥</div>
                                <div style="font-size: 1.25rem; font-weight: 900; color: #dc2626;">GAS</div>
                                <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.5rem;">RL1 Â· RL2 Â· RL3 Â· RL4 Â· RL5 Â· RL6</div>
                            </button>
                        </div>
                        
                        <!-- NUEVO: BotÃ³n DUAL -->
                        <button onclick="goToDual()" style="padding: 2rem; border-radius: 1.5rem; border: 4px solid #84cc16; background: linear-gradient(135deg, #f0f9ff 0%, #f7fee7 100%); text-align: center; cursor: pointer; width: 100%;">
                            <div style="font-size: 3rem; margin-bottom: 0.75rem;">âš¡ðŸ”¥</div>
                            <div style="font-size: 1.5rem; font-weight: 900; background: linear-gradient(135deg, #0ea5e9 0%, #84cc16 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">DUAL</div>
                            <div style="font-size: 0.875rem; font-weight: 700; color: #475569; margin-top: 0.5rem;">ELECTRICIDAD + GAS</div>
                            <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">MÃºltiples suministros Â· Comparativa global</div>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PANTALLA 2: ELECTRICIDAD (landing-view original) -->
        <div id="screen-electricidad" class="screen">
        <!-- 1. Landing View -->
        <div id="landing-view" class="fade-in flex flex-col items-center justify-center min-h-[60vh] py-8">
            <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-drk-500" id="landing-card">
                <div id="landing-icon-bg" class="w-16 h-16 bg-drk-50 rounded-full flex items-center justify-center mx-auto mb-4 text-drk-600 shadow-inner">
                    <svg class="w-8 h-8" viewBox="0 0 100 100" fill="none">
                        <style>.drk-ring{fill:none;stroke-width:10;stroke-linecap:round;}</style>
                        <circle class="drk-ring" cx="45" cy="45" r="35" stroke="#E50000"/>
                        <circle class="drk-ring" cx="55" cy="55" r="35" stroke="#FFCC00"/>
                        <circle class="drk-ring" cx="45" cy="55" r="35" stroke="#0079C1"/>
                        <circle class="drk-ring" cx="55" cy="45" r="35" stroke="#00A859"/>
                    </svg>
                </div>
                <h2 id="landing-title" class="text-3xl font-black text-drk-900 mb-2 text-center">DRK COMPARADOR</h2>
                <p class="text-slate-500 mb-6 text-center">Selecciona la tarifa que deseas analizar.</p>
                
                <!-- Tariff Selection Buttons -->
                <div class="w-full space-y-4">
                    <button onclick="selectTariffType('MULTICUPS')" class="tariff-select-btn group">
                        <div class="icon-wrapper bg-drk-50 text-drk-600 group-hover:bg-drk-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/></svg>
                        </div>
                        <div class="text-left">
                            <span class="text-lg font-bold text-drk-900">MULTICUPS</span>
                            <span class="block text-xs text-slate-500">Gestor de mÃºltiples contratos (2.0TD + 3.0TD)</span>
                        </div>
                        <span class="arrow-icon group-hover:text-drk-500">&rarr;</span>
                    </button>

                    <button onclick="selectTariffType('2.0TD')" class="tariff-select-btn group">
                        <div class="icon-wrapper bg-drk-50 text-drk-600 group-hover:bg-drk-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                        </div>
                        <div class="text-left">
                            <span class="text-lg font-bold text-drk-900">2.0 TD</span>
                            <span class="block text-xs text-slate-500">Hogar / PequeÃ±o Negocio (Individual)</span>
                        </div>
                        <span class="arrow-icon group-hover:text-drk-500">&rarr;</span>
                    </button>

                    <button onclick="selectTariffType('3.0TD')" class="tariff-select-btn group">
                        <div class="icon-wrapper bg-drk-50 text-drk-600 group-hover:bg-drk-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.18a2 2 0 0 0 1.51-.72L11 1l2 2h3.18a2 2 0 0 1 1.51.72L20 5h1.18a2 2 0 0 1 2 2z"></path><path d="M14 9H8v8h8V9z"></path></svg>
                        </div>
                        <div class="text-left">
                            <span class="text-lg font-bold text-drk-900">3.0 TD</span>
                            <span class="block text-xs text-slate-500">Industria / Gran Consumo (Individual)</span>
                        </div>
                        <span class="arrow-icon group-hover:text-drk-500">&rarr;</span>
                    </button>
                </div>
                
                <!-- QR Link Section -->
                <div id="pwa-install-section" class="mt-8 pt-4 border-t border-slate-200 text-center">
                    <label class="flex items-center justify-center cursor-pointer mb-3 text-drk-800 hover:text-drk-900 transition">
                        <input type="checkbox" id="qr-toggle-checkbox" class="h-4 w-4 text-drk-500 border-gray-300 rounded focus:ring-drk-500 mr-2">
                        <span class="text-xs font-bold uppercase tracking-wider underline decoration-drk-500 decoration-2 underline-offset-4">Abrir en el Movil</span>
                    </label>
                    <div id="qr-content-wrapper" class="opacity-0 max-h-0">
                        <div id="qr-visual-container" class="mx-auto w-44 h-44 p-2">
                            <div id="qr-code-container"></div>
                        </div>
                        <p class="text-xs text-slate-500 mt-3">Haz una foto del QR y Ã¡brelo en tu mÃ³vil.</p>
                    </div>
                </div>

            </div>
        </div>
        </div> <!-- Cierre screen-electricidad -->
        
        <!-- PANTALLA 3: GAS -->
        <div id="screen-gas" class="screen">
            <div class="fade-in flex flex-col items-center justify-center min-h-[60vh] py-8">
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-red-500">
                    
                    <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600 shadow-inner">
                        <span class="text-4xl">ðŸ”¥</span>
                    </div>
                    <h2 class="text-3xl font-black text-red-600 mb-2 text-center">GAS</h2>
                    <p id="gas-regulation-subtitle" class="text-slate-500 mb-6 text-center">Selecciona la regulaciÃ³n de gas.</p>
                    
                    <div class="w-full space-y-4">
                        <button onclick="selectGasTariff('RL1')" class="tariff-select-btn group">
                            <div class="icon-wrapper bg-red-50 text-red-600 group-hover:bg-red-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>
                            </div>
                            <div class="text-left">
                                <span class="text-lg font-bold text-drk-900">RL1</span>
                                <span class="block text-xs text-slate-500">RegulaciÃ³n de Gas - Nivel 1</span>
                            </div>
                            <span class="arrow-icon group-hover:text-red-500">&rarr;</span>
                        </button>

                        <button onclick="selectGasTariff('RL2')" class="tariff-select-btn group">
                            <div class="icon-wrapper bg-red-50 text-red-600 group-hover:bg-red-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>
                            </div>
                            <div class="text-left">
                                <span class="text-lg font-bold text-drk-900">RL2</span>
                                <span class="block text-xs text-slate-500">RegulaciÃ³n de Gas - Nivel 2</span>
                            </div>
                            <span class="arrow-icon group-hover:text-red-500">&rarr;</span>
                        </button>

                        <button onclick="selectGasTariff('RL3')" class="tariff-select-btn group">
                            <div class="icon-wrapper bg-red-50 text-red-600 group-hover:bg-red-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>
                            </div>
                            <div class="text-left">
                                <span class="text-lg font-bold text-drk-900">RL3</span>
                                <span class="block text-xs text-slate-500">RegulaciÃ³n de Gas - Nivel 3</span>
                            </div>
                            <span class="arrow-icon group-hover:text-red-500">&rarr;</span>
                        </button>

                        <button onclick="selectGasTariff('RL4')" class="tariff-select-btn group">
                            <div class="icon-wrapper bg-red-50 text-red-600 group-hover:bg-red-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>
                            </div>
                            <div class="text-left">
                                <span class="text-lg font-bold text-drk-900">RL4</span>
                                <span class="block text-xs text-slate-500">RegulaciÃ³n de Gas - Nivel 4</span>
                            </div>
                            <span class="arrow-icon group-hover:text-red-500">&rarr;</span>
                        </button>

                        <button onclick="selectGasTariff('RL5')" class="tariff-select-btn group">
                            <div class="icon-wrapper bg-red-50 text-red-600 group-hover:bg-red-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>
                            </div>
                            <div class="text-left">
                                <span class="text-lg font-bold text-drk-900">RL5</span>
                                <span class="block text-xs text-slate-500">RegulaciÃ³n de Gas - Nivel 5</span>
                            </div>
                            <span class="arrow-icon group-hover:text-red-500">&rarr;</span>
                        </button>

                        <button onclick="selectGasTariff('RL6')" class="tariff-select-btn group">
                            <div class="icon-wrapper bg-red-50 text-red-600 group-hover:bg-red-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>
                            </div>
                            <div class="text-left">
                                <span class="text-lg font-bold text-drk-900">RL6</span>
                                <span class="block text-xs text-slate-500">RegulaciÃ³n de Gas - Nivel 6</span>
                            </div>
                            <span class="arrow-icon group-hover:text-red-500">&rarr;</span>
                        </button>
                    </div>
                </div>
            </div>
        </div> <!-- Cierre screen-gas -->
        
        <!-- MODAL: Entrada manual de datos GAS -->
        <div id="gas-manual-input-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md border-t-4 border-red-500 max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <h3 class="text-2xl font-black text-red-600 mb-2 text-center">Datos de la Factura de GAS</h3>
                    <p class="text-sm text-slate-500 mb-4 text-center">Tarifa: <span id="gas-selected-tariff" class="font-bold text-red-600"></span></p>
                    
                    <div class="space-y-4">
                        <!-- CUPS de GAS -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">
                                CUPS (Opcional)
                            </label>
                            <input 
                                type="text" 
                                id="gas-cups" 
                                placeholder="Ej: ES0021000020679723GY" 
                                class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:border-red-500 focus:outline-none text-sm"
                            >
                            <p class="text-xs text-slate-500 mt-1">Se incluirÃ¡ en el PDF si lo proporcionas</p>
                        </div>
                        
                        <!-- DÃ­as de facturaciÃ³n -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">
                                DÃ­as de facturaciÃ³n
                            </label>
                            <input 
                                type="number" 
                                id="gas-dias" 
                                placeholder="Ej: 30" 
                                class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:border-red-500 focus:outline-none"
                                min="1"
                                step="1"
                            >
                        </div>
                        
                        <!-- kWh consumidos -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">
                                kWh consumidos
                            </label>
                            <input 
                                type="number" 
                                id="gas-kwh" 
                                placeholder="Ej: 250" 
                                class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:border-red-500 focus:outline-none"
                                min="0"
                                step="0.01"
                            >
                        </div>
                        
                        <!-- Total cliente -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">
                                Total factura actual (â‚¬)
                            </label>
                            <input 
                                type="number" 
                                id="gas-total-cliente" 
                                placeholder="Ej: 45.50" 
                                class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:border-red-500 focus:outline-none"
                                min="0"
                                step="0.01"
                            >
                        </div>
                        
                        <!-- SELECTOR: Comparar Indexada vs Fija (Oculto en modo DUAL) -->
                        <div id="gas-indexed-comparison-section" class="pt-4 border-t border-slate-200">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input 
                                    type="checkbox" 
                                    id="gas-compare-indexed-fixed" 
                                    class="w-5 h-5 text-red-600 rounded focus:ring-red-500"
                                    onchange="toggleGasComparisonMode()"
                                >
                                <span class="text-sm font-bold text-slate-700">Comparar Indexada vs Fija</span>
                            </label>
                            <p class="text-xs text-slate-500 mt-1 ml-8">
                                Activa para comparar automÃ¡ticamente tarifa indexada DRK contra tarifas fijas.
                            </p>
                        </div>
                        
                        <!-- OPCIONES DE SELECCIÃ“N -->
                        <div class="pt-4 border-t border-slate-200">
                            <p class="text-sm font-bold text-slate-700 mb-3">Modo de selecciÃ³n:</p>
                            
                            <!-- OpciÃ³n 1: Mejores tarifas -->
                            <label class="flex items-start gap-3 mb-3 cursor-pointer p-3 border-2 border-slate-200 rounded-lg hover:border-red-300 transition">
                                <input 
                                    type="radio" 
                                    name="gas-selection-mode" 
                                    value="best" 
                                    class="mt-1 w-4 h-4 text-red-600"
                                    checked
                                    onchange="updateGasSelectionUI()"
                                >
                                <div>
                                    <span class="font-bold text-slate-800">Mejores tarifas</span>
                                    <p class="text-xs text-slate-500" id="gas-best-description">
                                        El sistema calcularÃ¡ automÃ¡ticamente las mejores opciones.
                                    </p>
                                </div>
                            </label>
                            
                            <!-- OpciÃ³n 2: Elegir entre resultados -->
                            <label class="flex items-start gap-3 cursor-pointer p-3 border-2 border-slate-200 rounded-lg hover:border-red-300 transition">
                                <input 
                                    type="radio" 
                                    name="gas-selection-mode" 
                                    value="manual" 
                                    class="mt-1 w-4 h-4 text-red-600"
                                    onchange="updateGasSelectionUI()"
                                >
                                <div>
                                    <span class="font-bold text-slate-800">Elegir entre resultados</span>
                                    <p class="text-xs text-slate-500">
                                        Selecciona manualmente las tarifas que deseas comparar.
                                    </p>
                                </div>
                            </label>
                        </div>
                        
                        <!-- Botones FIJA/INDEXADA (solo cuando selector NO marcado y modo "best") -->
                        <div id="gas-type-buttons" class="pt-4 border-t border-slate-200 space-y-2">
                            <p class="text-sm font-bold text-slate-700 mb-2">Tipo de tarifa:</p>
                            <button 
                                onclick="calculateGasWithType('fija')" 
                                class="w-full px-6 py-3 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition"
                            >
                                ðŸ”µ Tarifa Fija
                            </button>
                            <button 
                                onclick="calculateGasWithType('indexada')" 
                                class="w-full px-6 py-3 bg-orange-500 text-white rounded-lg font-bold hover:bg-orange-600 transition"
                            >
                                ðŸŸ  Tarifa Indexada
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button 
                            onclick="closeGasModal()" 
                            class="flex-1 px-6 py-3 bg-slate-200 text-slate-700 rounded-lg font-bold hover:bg-slate-300 transition"
                        >
                            Cancelar
                        </button>
                        <button 
                            id="gas-calculate-btn"
                            onclick="proceedToGasCalculation()" 
                            class="flex-1 px-6 py-3 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600 transition"
                        >
                            Continuar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PANTALLA 4: Resultados GAS -->
        <div id="screen-gas-results" class="screen">
            <div class="fade-in flex flex-col items-center justify-center min-h-[60vh] py-8">
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-red-500">
                    <button onclick="goToGas()" style="background:none;border:none;padding:0.5rem;margin-bottom:1rem;cursor:pointer;" class="text-sm text-slate-500 hover:text-red-600 flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        Volver
                    </button>
                    
                    <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600 shadow-inner">
                        <span class="text-4xl">ðŸ”¥</span>
                    </div>
                    <h2 class="text-3xl font-black text-red-600 mb-2 text-center">Resultados GAS</h2>
                    <p class="text-slate-500 mb-6 text-center" id="gas-results-subtitle">Comparativa de tarifas</p>
                    
                    <!-- Contenedor de resultados -->
                    <div id="gas-results-container" class="mt-6">
                        <!-- Los resultados se insertarÃ¡n aquÃ­ -->
                    </div>
                    
                    <!-- NUEVO: BotÃ³n para solicitar mejora cuando no hay ahorro en GAS -->
                    <div id="gas-request-improvement-container" style="display:none;" class="mt-6">
                        <button id="gas-request-improvement-btn" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                            <span id="gas-request-improvement-text">SOLICITAR MEJORA A DRK</span>
                        </button>
                    </div>
                    
                    <!-- NUEVO: BotÃ³n para aÃ±adir a DUAL (solo visible en modo DUAL) -->
                    <div id="gas-dual-button-container" style="display:none;" class="mt-6">
                        <button onclick="addCurrentGasToDual()" class="w-full text-white font-bold py-4 px-6 rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3" style="background: linear-gradient(135deg, #0ea5e9 0%, #84cc16 100%);">
                            <span class="text-2xl">âš¡ðŸ”¥</span>
                            <span>AÃ‘ADIR A DUAL</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ========================================
             NUEVO MÃ“DULO DUAL (ELECTRICIDAD + GAS)
             ======================================== -->
        
        <!-- PANTALLA DUAL: GestiÃ³n de suministros -->
        <div id="screen-dual" class="screen">
            
            <div class="fade-in flex flex-col items-center justify-center min-h-[60vh] py-8">
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-drk-500" style="border-image: linear-gradient(135deg, #0ea5e9 0%, #84cc16 100%) 1;">
                    <!-- Encabezado -->
                    <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner" style="background: linear-gradient(135deg, #f0f9ff 0%, #f7fee7 100%);">
                        <span class="text-4xl">âš¡ðŸ”¥</span>
                    </div>
                    <h2 id="dual-title" class="text-3xl font-black mb-2 text-center" style="background: linear-gradient(135deg, #0ea5e9 0%, #84cc16 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">DUAL</h2>
                    <p id="dual-subtitle" class="text-slate-500 mb-6 text-center">Gestiona mÃºltiples suministros de Electricidad y Gas</p>
                    
                    <!-- Lista de suministros aÃ±adidos -->
                    <div id="dual-supplies-list" class="mb-6">
                        <p class="text-sm font-bold text-slate-700 mb-3"><span id="dual-supplies-label">Suministros aÃ±adidos:</span> <span id="dual-supplies-count" class="text-drk-600">0</span></p>
                        <div id="dual-supplies-container" class="space-y-2">
                            <!-- Los suministros se aÃ±adirÃ¡n aquÃ­ dinÃ¡micamente -->
                        </div>
                    </div>
                    
                    <!-- Botones de acciÃ³n -->
                    <div class="space-y-3">
                        <button id="dual-add-btn" onclick="dualAddSupply()" class="w-full py-4 text-white font-bold rounded-xl shadow-lg transition-all" style="background: linear-gradient(135deg, #0ea5e9 0%, #84cc16 100%);">
                            + AÃ±adir Suministro
                        </button>
                        
                        <button id="dual-calculate-btn" onclick="dualCalculate()" class="w-full py-4 bg-slate-600 hover:bg-slate-700 text-white font-bold rounded-xl shadow-lg transition-all" disabled>
                            Calcular Comparativa Global
                        </button>
                        
                        <button id="dual-reset-btn" onclick="dualReset()" class="w-full py-2 text-sm text-slate-500 hover:text-slate-700 transition-colors">
                            Limpiar todo
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PANTALLA DUAL: AÃ±adir tipo de suministro -->
        <div id="screen-dual-add-type" class="screen">
            <button onclick="backToDualManager()" style="background:none;border:none;padding:0.5rem;margin-bottom:1rem;cursor:pointer;" class="text-sm text-slate-500 hover:text-drk-600 flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                Volver
            </button>
            
            <div class="fade-in flex flex-col items-center justify-center min-h-[60vh] py-8">
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-drk-500">
                    <!-- Icono MULTICUPS -->
                    <div class="w-16 h-16 bg-drk-50 rounded-full flex items-center justify-center mx-auto mb-4 text-drk-600 shadow-inner">
                        <svg class="w-8 h-8" viewBox="0 0 100 100" fill="none">
                            <style>.drk-ring{fill:none;stroke-width:10;stroke-linecap:round;}</style>
                            <circle class="drk-ring" cx="45" cy="45" r="35" stroke="#E50000"/>
                            <circle class="drk-ring" cx="55" cy="55" r="35" stroke="#FFCC00"/>
                            <circle class="drk-ring" cx="45" cy="55" r="35" stroke="#0079C1"/>
                            <circle class="drk-ring" cx="55" cy="45" r="35" stroke="#00A859"/>
                        </svg>
                    </div>
                    
                    <h2 class="text-3xl font-black text-drk-900 mb-2 text-center">MULTICUPS</h2>
                    <p class="text-slate-500 mb-6 text-center">Selecciona el tipo de contrato que deseas aÃ±adir.</p>
                    
                    <!-- SecciÃ³n ELECTRICIDAD -->
                    <div class="mb-6">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-2xl">âš¡</span>
                            <h3 class="text-lg font-bold text-slate-800">ELECTRICIDAD</h3>
                        </div>
                        <div class="space-y-3">
                            <button onclick="dualSelectTariff('electricidad', '2.0TD')" class="tariff-select-btn group border-drk-300 hover:border-drk-500 w-full">
                                <div class="icon-wrapper bg-drk-50 text-drk-600 group-hover:bg-drk-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                                </div>
                                <div class="text-left flex-1">
                                    <span class="text-lg font-bold text-drk-900">2.0 TD</span>
                                    <span class="block text-xs text-slate-500">Permite EscÃ¡ner QR, Imagen y Entrada Manual</span>
                                </div>
                                <span class="arrow-icon group-hover:text-drk-500">&rarr;</span>
                            </button>
                            
                            <button onclick="dualSelectTariff('electricidad', '3.0TD')" class="tariff-select-btn group border-drk-300 hover:border-drk-500 w-full">
                                <div class="icon-wrapper bg-drk-50 text-drk-600 group-hover:bg-drk-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><rect width="16" height="20" x="4" y="2" rx="2" ry="2"></rect><path d="M9 22v-4h6v4"></path><path d="M8 6h.01"></path><path d="M16 6h.01"></path><path d="M12 6h.01"></path><path d="M12 10h.01"></path><path d="M12 14h.01"></path><path d="M16 10h.01"></path><path d="M16 14h.01"></path><path d="M8 10h.01"></path><path d="M8 14h.01"></path></svg>
                                </div>
                                <div class="text-left flex-1">
                                    <span class="text-lg font-bold text-drk-900">3.0 TD</span>
                                    <span class="block text-xs text-slate-500">Solo Entrada de Datos Manual</span>
                                </div>
                                <span class="arrow-icon group-hover:text-drk-500">&rarr;</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- SecciÃ³n GAS -->
                    <div>
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-2xl">ðŸ”¥</span>
                            <h3 class="text-lg font-bold text-slate-800">GAS</h3>
                        </div>
                        <div class="space-y-2">
                            <button onclick="dualSelectTariff('gas', 'RL1')" class="w-full flex items-center gap-3 p-3 bg-white border-2 border-slate-200 hover:border-orange-400 hover:bg-orange-50 rounded-lg transition-all">
                                <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                                    <span class="text-orange-600 font-bold">1</span>
                                </div>
                                <div class="text-left flex-1">
                                    <span class="font-bold text-slate-800">RL1</span>
                                    <span class="block text-xs text-slate-500">RegulaciÃ³n de Gas - Nivel 1</span>
                                </div>
                                <span class="text-slate-400">&rarr;</span>
                            </button>
                            
                            <button onclick="dualSelectTariff('gas', 'RL2')" class="w-full flex items-center gap-3 p-3 bg-white border-2 border-slate-200 hover:border-orange-400 hover:bg-orange-50 rounded-lg transition-all">
                                <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                                    <span class="text-orange-600 font-bold">2</span>
                                </div>
                                <div class="text-left flex-1">
                                    <span class="font-bold text-slate-800">RL2</span>
                                    <span class="block text-xs text-slate-500">RegulaciÃ³n de Gas - Nivel 2</span>
                                </div>
                                <span class="text-slate-400">&rarr;</span>
                            </button>
                            
                            <button onclick="dualSelectTariff('gas', 'RL3')" class="w-full flex items-center gap-3 p-3 bg-white border-2 border-slate-200 hover:border-orange-400 hover:bg-orange-50 rounded-lg transition-all">
                                <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                                    <span class="text-orange-600 font-bold">3</span>
                                </div>
                                <div class="text-left flex-1">
                                    <span class="font-bold text-slate-800">RL3</span>
                                    <span class="block text-xs text-slate-500">RegulaciÃ³n de Gas - Nivel 3</span>
                                </div>
                                <span class="text-slate-400">&rarr;</span>
                            </button>
                            
                            <button onclick="dualSelectTariff('gas', 'RL4')" class="w-full flex items-center gap-3 p-3 bg-white border-2 border-slate-200 hover:border-orange-400 hover:bg-orange-50 rounded-lg transition-all">
                                <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                                    <span class="text-orange-600 font-bold">4</span>
                                </div>
                                <div class="text-left flex-1">
                                    <span class="font-bold text-slate-800">RL4</span>
                                    <span class="block text-xs text-slate-500">RegulaciÃ³n de Gas - Nivel 4</span>
                                </div>
                                <span class="text-slate-400">&rarr;</span>
                            </button>
                            
                            <button onclick="dualSelectTariff('gas', 'RL5')" class="w-full flex items-center gap-3 p-3 bg-white border-2 border-slate-200 hover:border-orange-400 hover:bg-orange-50 rounded-lg transition-all">
                                <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                                    <span class="text-orange-600 font-bold">5</span>
                                </div>
                                <div class="text-left flex-1">
                                    <span class="font-bold text-slate-800">RL5</span>
                                    <span class="block text-xs text-slate-500">RegulaciÃ³n de Gas - Nivel 5</span>
                                </div>
                                <span class="text-slate-400">&rarr;</span>
                            </button>
                            
                            <button onclick="dualSelectTariff('gas', 'RL6')" class="w-full flex items-center gap-3 p-3 bg-white border-2 border-slate-200 hover:border-orange-400 hover:bg-orange-50 rounded-lg transition-all">
                                <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                                    <span class="text-orange-600 font-bold">6</span>
                                </div>
                                <div class="text-left flex-1">
                                    <span class="font-bold text-slate-800">RL6</span>
                                    <span class="block text-xs text-slate-500">RegulaciÃ³n de Gas - Nivel 6</span>
                                </div>
                                <span class="text-slate-400">&rarr;</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PANTALLA DUAL: Resultados globales -->
        <div id="screen-dual-results" class="screen">
            <button onclick="backToDualManager()" style="background:none;border:none;padding:0.5rem;margin-bottom:1rem;cursor:pointer;" class="text-sm text-slate-500 hover:text-drk-600 flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                Volver
            </button>
            
            <div class="fade-in flex flex-col items-center justify-center min-h-[60vh] py-8">
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-drk-500">
                    <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner" style="background: linear-gradient(135deg, #f0f9ff 0%, #f7fee7 100%);">
                        <span class="text-4xl">âš¡ðŸ”¥</span>
                    </div>
                    <h2 class="text-3xl font-black mb-2 text-center" style="background: linear-gradient(135deg, #0ea5e9 0%, #84cc16 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">COMPARATIVA GLOBAL</h2>
                    <p class="text-slate-500 mb-6 text-center">Resultados de <span id="dual-results-count" class="font-bold">0</span> suministros</p>
                    
                    <!-- Contenedor de resultados -->
                    <div id="dual-results-container" class="mt-6 space-y-6">
                        <!-- Los resultados se insertarÃ¡n aquÃ­ -->
                    </div>
                    
                    <!-- Botones de descarga -->
                    <div class="mt-6 flex flex-col gap-3">
                        <!-- NUEVO: BotÃ³n para solicitar mejora cuando NO hay ahorro en DUAL -->
                        <div id="dual-request-improvement-container" style="display:none;">
                            <button id="dual-request-improvement-btn" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mb-3">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                <span id="dual-request-improvement-text">SOLICITAR MEJORA A DRK</span>
                            </button>
                        </div>
                        
                        <button onclick="showClientDataModal()" class="w-full py-3 bg-slate-700 hover:bg-slate-800 text-white rounded-xl font-semibold transition-all text-sm shadow-md flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                            </svg>
                            Descargar PDF Global
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- NUEVO: PANTALLA DUAL - ConfirmaciÃ³n de suministro -->
        <div id="screen-dual-confirm" class="screen">
            <button onclick="dualCancelAdd()" style="background:none;border:none;padding:0.5rem;margin-bottom:1rem;cursor:pointer;" class="text-sm text-slate-500 hover:text-drk-600 flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                Cancelar
            </button>
            
            <div class="fade-in flex flex-col items-center justify-center min-h-[60vh] py-8">
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-drk-500">
                    <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner" style="background: linear-gradient(135deg, #f0f9ff 0%, #f7fee7 100%);">
                        <span class="text-4xl" id="dual-confirm-icon">âš¡</span>
                    </div>
                    <h2 class="text-2xl font-black mb-2 text-center text-drk-900">Suministro Calculado</h2>
                    <p class="text-slate-500 mb-6 text-center">Â¿Deseas aÃ±adir este suministro a tu comparativa DUAL?</p>
                    
                    <!-- Resumen del suministro -->
                    <div class="bg-slate-50 rounded-xl p-4 mb-6">
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-600">Tipo:</span>
                                <span class="font-bold text-slate-900" id="dual-confirm-type">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Tarifa:</span>
                                <span class="font-bold text-slate-900" id="dual-confirm-tariff">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Consumo:</span>
                                <span class="font-bold text-slate-900" id="dual-confirm-consumption">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">DÃ­as:</span>
                                <span class="font-bold text-slate-900" id="dual-confirm-days">-</span>
                            </div>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-slate-200">
                            <div class="flex justify-between mb-2">
                                <span class="text-slate-600">DRK (anual):</span>
                                <span class="font-bold text-drk-600" id="dual-confirm-drk">-</span>
                            </div>
                            <div class="flex justify-between mb-2">
                                <span class="text-slate-600">Power Cup (anual):</span>
                                <span class="font-bold text-powercup-600" id="dual-confirm-powercup">-</span>
                            </div>
                            <!-- NUEVO: Mostrar ahorro anual -->
                            <div class="mt-3 pt-3 border-t-2 border-green-200 bg-green-50 rounded-lg p-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-green-700 font-semibold">${tr("TU AHORRO ANUAL ESTIMADO:")}</span>
                                    <span class="font-black text-2xl text-green-600" id="dual-confirm-savings">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones de acciÃ³n -->
                    <div class="space-y-3">
                        <button onclick="dualConfirmAdd()" class="w-full py-4 text-white font-bold rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3" style="background: linear-gradient(135deg, #0ea5e9 0%, #84cc16 100%);">
                            <span class="text-2xl">âœ“</span>
                            <span>SÃ, AÃ‘ADIR A DUAL</span>
                        </button>
                        
                        <button onclick="dualCancelAdd()" class="w-full py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold rounded-xl transition-all">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- MODAL: Datos del Comercial y Cliente (para PDF DUAL) -->
        <div id="client-data-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md border-t-4 border-blue-500 max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <h3 class="text-2xl font-black text-blue-600 mb-2 text-center">Datos del Comercial y Cliente</h3>
                    <p class="text-sm text-slate-500 mb-4 text-center">Rellene sus datos. El resumen profesional de la oferta se copiarÃ¡ a su portapapeles (Ctrl+V).</p>
                    
                    <div class="space-y-4">
                        <!-- CÃ³digo comercial -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">
                                CÃ“DIGO COMERCIAL (Obligatorio)
                            </label>
                            <input 
                                type="text" 
                                id="comercial-code" 
                                placeholder="Ej: D=00" 
                                class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none"
                            >
                        </div>
                        
                        <!-- Nombre del cliente -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">
                                Nombre Cliente
                            </label>
                            <input 
                                type="text" 
                                id="client-name" 
                                placeholder="Nombre completo del cliente" 
                                class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none"
                            >
                        </div>
                        
                        <!-- TelÃ©fono -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">
                                TelÃ©fono
                            </label>
                            <input 
                                type="tel" 
                                id="client-phone" 
                                placeholder="TelÃ©fono del cliente" 
                                class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none"
                            >
                        </div>
                        
                        <!-- DirecciÃ³n de Suministro -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">
                                DirecciÃ³n de Suministro
                            </label>
                            <input 
                                type="text" 
                                id="client-address" 
                                placeholder="DirecciÃ³n del suministro" 
                                class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none"
                            >
                        </div>
                        
                        <!-- Email -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">
                                Email
                                <svg class="inline ml-1 w-5 h-5" viewBox="0 0 24 24" fill="#9333ea">
                                    <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                                </svg>
                            </label>
                            <input 
                                type="email" 
                                id="client-email" 
                                placeholder="email@ejemplo.com" 
                                class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none"
                            >
                        </div>
                        
                        <!-- Nota para iPhone -->
                        <div class="bg-amber-50 border-2 border-amber-200 rounded-lg p-4">
                            <div class="flex items-start gap-3">
                                <span class="text-2xl">âš ï¸</span>
                                <div class="text-sm">
                                    <p class="font-bold text-amber-900 mb-2">NOTA PARA USUARIOS DE iPHONE:</p>
                                    <p class="text-amber-800 mb-2">Si copias desde iPhone, el formato puede no verse correctamente en algunos correos. Para mejor resultado:</p>
                                    <ul class="text-amber-800 space-y-1 ml-4">
                                        <li>âœ“ Copia desde un <strong>ordenador</strong></li>
                                        <li>âœ“ O usa <strong>Gmail/Outlook web</strong> en el navegador mÃ³vil</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones -->
                    <div class="mt-6 space-y-3">
                        <button onclick="copyDualHTML()" class="w-full py-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>
                            </svg>
                            <span data-i18n="ðŸ“‹ COPIAR COMPARATIVO (HTML)">ðŸ“‹ COPIAR COMPARATIVO (HTML)</span>
                        </button>
                        
                        <button onclick="generateDualPDF()" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                            <span data-i18n="ðŸ“„ CREAR PDF COMPARATIVO">ðŸ“„ CREAR PDF COMPARATIVO</span>
                        </button>
                        
                        <button onclick="closeClientDataModal()" class="w-full py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold rounded-xl transition-all">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- FIN MÃ“DULO DUAL -->
        
        <!-- 2. MultiCups Saga View (Intermediate Step) -->
        <div id="multicups-saga-view" class="fade-in hidden flex flex-col items-center justify-center min-h-[60vh] py-8">
            <button onclick="goBackFromMultiCupsSagaView()" class="mb-4 text-sm text-slate-500 hover:text-drk-600 flex items-center gap-1">
                &larr; Volver a selecciÃ³n
            </button>
            
            <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-drk-500" id="multicups-saga-card">
                <div id="initial-icon-bg-saga" class="w-16 h-16 bg-drk-50 rounded-full flex items-center justify-center mx-auto mb-4 text-drk-600 shadow-inner">
                    <svg class="w-8 h-8" viewBox="0 0 100 100" fill="none">
                        <style>.drk-ring{fill:none;stroke-width:10;stroke-linecap:round;}</style>
                        <circle class="drk-ring" cx="45" cy="45" r="35" stroke="#E50000"/>
                        <circle class="drk-ring" cx="55" cy="55" r="35" stroke="#FFCC00"/>
                        <circle class="drk-ring" cx="45" cy="55" r="35" stroke="#0079C1"/>
                        <circle class="drk-ring" cx="55" cy="45" r="35" stroke="#00A859"/>
                    </svg>
                </div>
                
                <h2 class="text-3xl font-black text-drk-900 mb-2 text-center">MULTICUPS</h2>
                <p class="text-slate-500 mb-6 text-center" id="saga-instruction-text">
                    Selecciona el tipo de contrato que deseas aÃ±adir.<br>
                    Total de suministros actuales: <span class="font-bold text-drk-800" id="saga-total-cups">0</span>
                </p>
                
                <p id="loading-status-saga" class="text-center text-sm text-slate-400 mt-4 mb-4">Cargando tarifas 2.0TD y 3.0TD...</p>

                <div id="saga-button-wrapper" class="w-full space-y-4 pt-4 border-t border-slate-200">
                    <button onclick="selectMultiCupType('2.0TD')" class="tariff-select-btn group border-drk-300 hover:border-drk-500">
                        <div class="icon-wrapper bg-drk-50 text-drk-600 group-hover:bg-drk-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                        </div>
                        <div class="text-left">
                            <span class="text-lg font-bold text-drk-900">2.0 TD</span>
                            <span class="block text-xs text-slate-500">Permite EscÃ¡ner QR, Imagen y Entrada Manual</span>
                        </div>
                        <span class="arrow-icon group-hover:text-drk-500">&rarr;</span>
                    </button>

                    <button onclick="selectMultiCupType('3.0TD')" class="tariff-select-btn group border-drk-300 hover:border-drk-500">
                        <div class="icon-wrapper bg-drk-50 text-drk-600 group-hover:bg-drk-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.18a2 2 0 0 0 1.51-.72L11 1l2 2h3.18a2 2 0 0 1 1.51.72L20 5h1.18a2 2 0 0 1 2 2z"></path><path d="M14 9H8v8h8V9z"></path></svg>
                        </div>
                        <div class="text-left">
                            <span class="text-lg font-bold text-drk-900">3.0 TD</span>
                            <span class="block text-xs text-slate-500">Solo Entrada de Datos Manual</span>
                        </div>
                        <span class="arrow-icon group-hover:text-drk-500">&rarr;</span>
                    </button>
                </div>
                
                <button id="multicups-finalize-btn-saga" onclick="finalizeMultiCups()" class="w-full bg-cta-green-500 hover:bg-cta-green-600 text-white font-bold py-4 rounded-2xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mt-8 hidden">
                    <span id="finalize-btn-text">FINALIZAR Y COMPARAR</span> (<span id="saga-finalize-count">0</span> <span id="finalize-suministros-text">Suministros</span>)
                </button>
            </div>
        </div>

        <!-- 3. Initial Input View (Scan/Manual) -->
        <div id="initial-view" class="fade-in hidden">
            <button onclick="currentTariffType === 'MULTICUPS' ? showMultiCupsSagaView() : goBackFromInitialView()" class="mb-4 text-sm text-slate-500 hover:text-drk-600 flex items-center gap-1">
                &larr; Volver <span id="back-button-label">a selecciÃ³n</span>
            </button>

            <div id="initial-card" class="bg-white p-6 rounded-3xl shadow-xl text-center border-t-4 border-drk-500 relative">
                <div id="tariff-badge" class="absolute top-4 right-4 bg-drk-500 px-2 py-1 rounded-full text-white text-xs font-bold shadow-md">
                    <span id="current-tariff-label">2.0TD</span> - <span id="tariff-display-badge">0</span>
                </div>
                
                <!-- VERSION -->
                <div class="absolute bottom-2 right-2 text-xs text-gray-400">
                    v2024.12.20
                </div>
                
                
                <div id="initial-icon-bg" class="w-16 h-16 bg-drk-50 rounded-full flex items-center justify-center mx-auto mb-4 text-drk-600"></div>
                
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Analizar Factura</h2>
                <p class="text-slate-500 mb-6" id="scan-instruction-text">Escanea el cÃ³digo QR o introduce datos manualmente.</p>
                
                <div id="qr-buttons-container">
                    <button id="start-scan-btn" class="w-full bg-gradient-to-r from-drk-600 to-drk-800 hover:from-drk-700 hover:to-drk-900 text-white font-bold py-4 px-6 rounded-2xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mb-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.125 3h3.75a2 2 0 011.664.89l.812 1.22a2 2 0 001.664.89H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span>ESCANEAR QR AHORA</span>
                    </button>
                    
                    <input type="file" id="image-file-input" accept="image/*" class="hidden">
                    <button id="upload-menu-btn" class="w-full bg-drk-50 hover:bg-drk-100 text-drk-800 font-bold py-3 px-6 rounded-xl shadow-sm transform transition active:scale-95 flex items-center justify-center gap-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <span>OTRAS OPCIONES DE CAPTURA</span>
                    </button>
                </div>
                <button id="manual-input-btn" class="w-full bg-drk-50 hover:bg-drk-100 text-drk-800 font-bold py-3 px-6 rounded-xl shadow-sm transform transition active:scale-95 flex items-center justify-center gap-3 mt-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    <span>DATOS A MANO</span>
                </button>

                <button id="multicups-finalize-btn-main" class="hidden"></button>

                <p id="loading-status" class="text-center text-sm text-slate-400 mt-4 hidden">Cargando tarifas...</p>

            </div>
        </div>

        <!-- 4. Scanner View -->
        <div id="scanner-view" class="hidden flex-col h-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-slate-700">Escaneando...</h2>
                <button id="stop-scan-btn" class="text-red-500 font-bold text-sm bg-red-50 px-3 py-1 rounded-lg">Cancelar</button>
            </div>
            
            <!-- Indicador de intensidad de escaneo -->
            <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-3 mb-3">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-bold text-blue-800">Potencia de detecciÃ³n:</span>
                    <span id="scan-power-label" class="text-xs font-bold text-blue-600">EstÃ¡ndar</span>
                </div>
                <div class="w-full bg-blue-100 rounded-full h-2 overflow-hidden">
                    <div id="scan-power-bar" class="bg-gradient-to-r from-blue-400 to-blue-600 h-full transition-all duration-500" style="width: 20%"></div>
                </div>
            </div>
            
            <div class="relative w-full aspect-[3/4] bg-black rounded-2xl overflow-hidden shadow-2xl mb-4">
                <div id="interactive" class="viewport w-full h-full"></div>
                <div id="scanner-guide" class="absolute inset-0 border-2 border-white opacity-30 m-8 rounded-lg pointer-events-none"></div>
                
                <!-- Marco Google Lens - Aparece al detectar -->
                <div id="qr-detection-frame" class="absolute hidden pointer-events-none" style="border: 4px solid #4285f4; box-shadow: 0 0 30px rgba(66, 133, 244, 0.8), inset 0 0 20px rgba(66, 133, 244, 0.3); border-radius: 16px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease-in-out; z-index: 100; opacity: 0;">
                    <!-- Esquinas blancas mÃ¡s brillantes -->
                    <div class="absolute" style="top: -4px; left: -4px; width: 32px; height: 32px; border-top: 5px solid white; border-left: 5px solid white; border-radius: 16px 0 0 0; box-shadow: 0 0 10px rgba(255,255,255,0.8);"></div>
                    <div class="absolute" style="top: -4px; right: -4px; width: 32px; height: 32px; border-top: 5px solid white; border-right: 5px solid white; border-radius: 0 16px 0 0; box-shadow: 0 0 10px rgba(255,255,255,0.8);"></div>
                    <div class="absolute" style="bottom: -4px; left: -4px; width: 32px; height: 32px; border-bottom: 5px solid white; border-left: 5px solid white; border-radius: 0 0 0 16px; box-shadow: 0 0 10px rgba(255,255,255,0.8);"></div>
                    <div class="absolute" style="bottom: -4px; right: -4px; width: 32px; height: 32px; border-bottom: 5px solid white; border-right: 5px solid white; border-radius: 0 0 16px 0; box-shadow: 0 0 10px rgba(255,255,255,0.8);"></div>
                    
                    <!-- LÃ­nea de escaneo MÃS VISIBLE -->
                    <div id="scan-line" class="absolute left-0 right-0" style="top: 0%; height: 3px; background: linear-gradient(90deg, transparent, #4285f4, #4285f4, transparent); box-shadow: 0 0 15px #4285f4, 0 0 30px rgba(66, 133, 244, 0.6); z-index: 110; animation: scanLineMove 2s ease-in-out infinite;"></div>
                </div>
                
                <!-- BotÃ³n de captura flotante estilo Google Lens -->
                <button id="capture-photo-btn" class="absolute bottom-6 left-1/2 transform -translate-x-1/2 w-20 h-20 rounded-full bg-white flex items-center justify-center shadow-2xl transition-all duration-300 hover:scale-110 active:scale-95" style="z-index: 200;">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center">
                        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </div>
                </button>
                
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none"><div class="w-64 h-1 bg-red-500 opacity-30"></div></div>
            </div>
            
            <style>
                @keyframes scanLineMove {
                    0% { 
                        top: 0%; 
                        opacity: 0; 
                    }
                    5% { 
                        opacity: 1; 
                    }
                    50% { 
                        top: 100%; 
                        opacity: 1; 
                    }
                    55% {
                        opacity: 0;
                    }
                    100% { 
                        top: 100%; 
                        opacity: 0; 
                    }
                }
                
                /* AnimaciÃ³n suave para el botÃ³n (sin parpadeo agresivo) */
                @keyframes buttonGlow {
                    0%, 100% { 
                        box-shadow: 0 0 20px rgba(34, 197, 94, 0.6), 0 0 40px rgba(34, 197, 94, 0.4);
                        transform: scale(1);
                    }
                    50% { 
                        box-shadow: 0 0 30px rgba(34, 197, 94, 0.8), 0 0 60px rgba(34, 197, 94, 0.6);
                        transform: scale(1.05);
                    }
                }
                
                .button-detected {
                    animation: buttonGlow 1.5s ease-in-out infinite !important;
                    box-shadow: 0 0 20px rgba(34, 197, 94, 0.6) !important;
                }
            </style>
            <p class="text-center text-sm text-slate-600 mb-2 font-semibold">ðŸ‘† Pulsa la lupa cuando veas el marco azul</p>
        </div>

        <!-- 5. Results View -->
        <div id="results-view" class="hidden animate-fade-in-up">
            <!-- Banner de Empresa -->
            <div id="company-banner" class="mb-8 rounded-2xl overflow-hidden shadow-lg">
                <!-- El contenido del banner se generarÃ¡ dinÃ¡micamente segÃºn la marca activa -->
            </div>
            
            <div class="text-center mb-6">
                <div class="inline-flex items-center gap-2 bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold mb-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> AnÃ¡lisis Completado
                </div>
                <h2 class="2xl font-black text-slate-800">Resultado del Estudio</h2>
                <p class="text-sm text-slate-500" id="results-cups-list">CUPS: <span class="font-mono text-slate-700" id="cups-value"></span></p>
            </div>

            <div id="result-card" class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-100 mb-8 relative">
                <div id="result-header" class="bg-gradient-to-r from-drk-800 to-drk-600 p-6 text-white text-center relative overflow-hidden">
                    <p class="uppercase tracking-widest text-xs font-semibold text-drk-100 mb-1" id="best-offer-label"${tr("LA MEJOR OPCIÃ“N PARA TI ES")}</p>
                    <h2 id="best-offer-name" class="text-2xl md:text-3xl font-extrabold leading-tight mb-2">Nombre Tarifa</h2>
                    <!-- offer.description del CSV -->
                    <p id="best-offer-desc" class="text-drk-100 text-sm opacity-90">DescripciÃ³n</p> 
                </div>
                <div class="p-6">
                    <div class="flex flex-col gap-6">
                        <div class="text-center">
                            <p id="savings-label" class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Tu Ahorro Anual Estimado</p>
                            <p id="savings-estimate" class="text-5xl font-black text-cta-green-500 tracking-tight">- â‚¬</p>
                        </div>
                        <div id="price-columns" class="w-full grid grid-cols-2 text-center text-sm border-b pb-4 border-slate-100">
                            <div class="border-r border-slate-200 pr-2">
                                <p class="text-slate-400 text-xs font-semibold mb-2 uppercase"${tr("TU FACTURA ACTUAL")}</p>
                                <div class="mb-3">
                                    <p class="text-xl font-bold text-cta-red-500 line-through decoration-cta-red-500/50 decoration-2" id="old-period-cost-display">0,00 â‚¬</p>
                                    <p class="text-xs text-slate-500 font-medium" id="old-period-days-label"${tr("Total Periodo")}</p> 
                                </div>
                                <div><p class="text-lg font-bold text-cta-red-500 line-through decoration-cta-red-500/50 decoration-2" id="old-annual-cost-display">0,00 â‚¬/aÃ±o</p></div>
                            </div>
                            <div class="pl-2">
                                <p class="text-drk-800 text-xs font-semibold mb-2 uppercase" id="new-cost-label"${tr("TU NUEVO COSTE DRK")}</p>
                                <div class="mb-3">
                                    <p class="text-2xl font-black text-drk-900" id="new-monthly-cost-display">0,00 â‚¬/mes</p>
                                    <p class="text-xs text-drk-800 font-medium" id="monthly-label"${tr("Estimado Mensual")}</p>
                                </div>
                                <div><p class="text-2xl font-black text-drk-900" id="new-annual-cost-display">0,00 â‚¬/aÃ±o</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-3 mb-8">
                <!-- NUEVO: BotÃ³n para aÃ±adir a DUAL (solo visible en modo DUAL) -->
                <button id="add-to-dual-btn" style="display:none;" onclick="addCurrentToDual()" class="w-full text-white font-bold py-4 px-6 rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mb-3" style="background: linear-gradient(135deg, #0ea5e9 0%, #84cc16 100%);">
                    <span class="text-2xl">âš¡ðŸ”¥</span>
                    <span>AÃ‘ADIR A DUAL</span>
                </button>
                
                <button id="send-offer-btn" class="w-full bg-cta-red-500 hover:bg-cta-red-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mb-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-2m-4-4l-4 4m0 0l-4-4m4 4V5"></path></svg>
                    <span>COPIAR COMPARATIVO</span>
                </button>
                
                <!-- NUEVO: BotÃ³n para solicitar mejora cuando no hay ahorro -->
                <button id="request-improvement-btn" style="display:none;" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mb-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    <span id="request-improvement-text">SOLICITAR MEJORA A DRK</span>
                </button>
                
                <button onclick="document.getElementById('details-container').classList.toggle('hidden')" class="text-center text-drk-800 font-bold text-sm hover:underline flex items-center justify-center gap-1" id="details-toggle-btn"><span id="details-toggle-text"></span></button>
            </div>
            
            <div id="details-container" class="hidden space-y-6">
            </div>

            <div class="mt-8">
                <button onclick="resetToLanding()" class="w-full bg-white border-2 border-slate-200 hover:border-drk-500 text-slate-600 hover:text-drk-800 font-bold py-4 rounded-xl transition flex items-center justify-center gap-2" id="reset-button-text">
                    Realizar Nueva ComparaciÃ³n
                </button>
            </div>
        </div>

        <!-- 6. Manual Input Modal -->
        <div id="manual-input-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-drk-800 mb-4" id="manual-modal-title">Entrada de Datos Manual</h3>
                
                <div id="manual-tariff-selector-wrapper" class="hidden mb-4">
                    <label for="manual-input-tariff-select" class="block text-sm font-medium text-slate-700 text-left mb-1">Tipo de Tarifa</label>
                    <select id="manual-input-tariff-select" onchange="toggleMultiCupsInputPeriods(this.value, 'input')" class="w-full p-3 rounded-lg border border-slate-300 text-sm font-bold focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <option value="2.0TD">2.0 TD (Hogar/Negocio)</option>
                        <option value="3.0TD">3.0 TD (Industria/Gran Consumo)</option>
                    </select>
                </div>

                <!-- NUEVO: Checkbox para activar comparativo con Potencia Optimizada (solo 3.0TD) -->
                <div id="optimized-power-toggle-wrapper" class="hidden mb-4 bg-gradient-to-r from-amber-50 to-orange-50 border-2 border-amber-300 p-4 rounded-xl">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="enable-optimized-power" onchange="toggleOptimizedPowerFields()" class="w-5 h-5 text-amber-600 bg-white border-amber-300 rounded focus:ring-amber-500 focus:ring-2 mr-3">
                        <div>
                            <span class="text-sm font-bold text-amber-900" data-i18n="Activar Comparativo con Potencia Optimizada">Activar Comparativo con Potencia Optimizada</span>
                            <p class="text-xs text-amber-700 mt-1" data-i18n="Permite comparar las potencias actuales vs. potencias optimizadas">Permite comparar las potencias actuales vs. potencias optimizadas</p>
                        </div>
                    </label>
                </div>

                <div class="border-b border-slate-200 pb-3 mb-4 bg-slate-50 p-3 rounded-lg">
                    <h4 id="multicups-datos-generales" class="font-bold text-slate-800 mb-2" data-i18n="General Data">Datos Generales</h4>
                    <input type="text" id="input-cups" placeholder="NÃºmero CUPS" class="w-full mb-3 p-3 rounded-lg border border-slate-300 text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                    <input type="number" id="input-billing-days" placeholder="DÃ­as Facturados" class="w-full p-3 rounded-lg border border-slate-300 text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                </div>
                
                <div class="border-b border-slate-200 pb-3 mb-3">
                    <h4 id="multicups-potencias" class="font-bold text-slate-800 mb-2" data-i18n="Power (kW)">Potencias (kW)</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" step="0.01" id="input-p1-kw" placeholder="P1" class="p-2 border rounded text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="0.01" id="input-p2-kw" placeholder="P2" class="p-2 border rounded text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="0.01" id="input-p3-kw" placeholder="P3" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="0.01" id="input-p4-kw" placeholder="P4" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="0.01" id="input-p5-kw" placeholder="P5" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="0.01" id="input-p6-kw" placeholder="P6" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                    </div>
                </div>
                
                <!-- NUEVO: Campos de Potencias Optimizadas (solo visible cuando checkbox activado) -->
                <div id="optimized-power-fields" class="border-b border-slate-200 pb-3 mb-3 hidden bg-gradient-to-r from-green-50 to-emerald-50 p-3 rounded-lg">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-bold text-emerald-800" data-i18n="Potencias Optimizadas (kW)">Potencias Optimizadas (kW)</h4>
                        <span class="text-xs bg-emerald-600 text-white px-2 py-1 rounded-full font-bold" data-i18n="PROPUESTA">PROPUESTA</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" step="0.01" id="input-p1-opt-kw" placeholder="P1 Opt" class="p-2 border-2 border-emerald-300 rounded text-sm focus:outline-none focus:border-2 focus:border-emerald-600 bg-white">
                        <input type="number" step="0.01" id="input-p2-opt-kw" placeholder="P2 Opt" class="p-2 border-2 border-emerald-300 rounded text-sm focus:outline-none focus:border-2 focus:border-emerald-600 bg-white">
                        <input type="number" step="0.01" id="input-p3-opt-kw" placeholder="P3 Opt" class="p-2 border-2 border-emerald-300 rounded text-sm hidden-period-opt focus:outline-none focus:border-2 focus:border-emerald-600 bg-white">
                        <input type="number" step="0.01" id="input-p4-opt-kw" placeholder="P4 Opt" class="p-2 border-2 border-emerald-300 rounded text-sm hidden-period-opt focus:outline-none focus:border-2 focus:border-emerald-600 bg-white">
                        <input type="number" step="0.01" id="input-p5-opt-kw" placeholder="P5 Opt" class="p-2 border-2 border-emerald-300 rounded text-sm hidden-period-opt focus:outline-none focus:border-2 focus:border-emerald-600 bg-white">
                        <input type="number" step="0.01" id="input-p6-opt-kw" placeholder="P6 Opt" class="p-2 border-2 border-emerald-300 rounded text-sm hidden-period-opt focus:outline-none focus:border-2 focus:border-emerald-600 bg-white">
                    </div>
                    <p class="text-xs text-emerald-700 mt-2 italic" data-i18n="Introduce las potencias optimizadas que propones al cliente">Introduce las potencias optimizadas que propones al cliente</p>
                </div>
                
                <div class="border-b border-slate-200 pb-3 mb-3">
                    <h4 id="multicups-energia" class="font-bold text-slate-800 mb-2" data-i18n="Energy (kWh)">EnergÃ­a (kWh)</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" step="1" id="input-e1-kwh" placeholder="E1" class="p-2 border rounded text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="1" id="input-e2-kwh" placeholder="E2" class="p-2 border rounded text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="1" id="input-e3-kwh" placeholder="E3" class="p-2 border rounded text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="1" id="input-e4-kwh" placeholder="E4" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="1" id="input-e5-kwh" placeholder="E5" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="1" id="input-e6-kwh" placeholder="E6" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                    </div>
                </div>

                <div class="pb-3 mb-3">
                    <input type="number" step="0.01" id="input-total-bill" placeholder="Total Factura (â‚¬)" class="w-full mb-4 p-3 rounded-lg border border-slate-300 text-sm font-bold focus:outline-none focus:border-2 focus:focus:border-drk-500">
                </div>
                
                <button id="execute-manual-input-btn" class="w-full bg-drk-500 hover:bg-drk-600 text-white font-bold py-3 rounded-xl shadow-md mb-3">CALCULAR</button>
                <button id="cancel-manual-input-btn" onclick="closeManualInputModal()" class="w-full bg-slate-200 text-slate-600 font-bold py-3 rounded-xl text-sm">Cancelar</button>
            </div>
        </div>

        <!-- 7. QR Confirmation Modal (MultiCups) -->
        <div id="qr-confirm-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full max-h-[90vh] overflow-y-auto">
                <h3 id="qr-confirm-title" class="text-xl font-bold text-drk-800 mb-2">Confirmar Suministro</h3>
                <p id="qr-confirm-subtitle" class="text-sm text-slate-500 mb-4">Revisa los datos extraÃ­dos y selecciona el tipo de tarifa para aÃ±adir a la lista.</p>

                <div class="mb-4" id="tariff-selector-wrapper">
                    <label for="confirm-tariff-select" class="block text-sm font-medium text-slate-700 text-left mb-1">Tipo de Tarifa</label>
                    <select id="confirm-tariff-select" class="w-full p-3 rounded-lg border border-slate-300 text-sm focus:outline-none focus:border-2 focus:border-drk-500">
                        <option value="2.0TD">2.0 TD (Punta, Llano, Valle)</option>
                        <option value="3.0TD">3.0 TD (6 Periodos)</option>
                    </select>
                </div>

                <div id="qr-data-summary" class="bg-slate-50 p-3 rounded-lg text-sm mb-4">
                    </div>

                <button id="confirm-save-supply-btn" class="w-full bg-drk-500 hover:bg-drk-600 text-white font-bold py-3 rounded-xl shadow-md mb-3">AÃ‘ADIR A LA LISTA DE CUPS</button>
                <button onclick="document.getElementById('qr-confirm-modal').classList.add('hidden');" class="w-full bg-slate-200 text-slate-600 font-bold py-3 rounded-xl text-sm">Cancelar</button>
            </div>
        </div>

        <!-- 8. QR Options Modal (Upload/Paste) -->
        <div id="qr-options-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full">
                <h3 class="text-xl font-bold text-drk-800 mb-4" id="modal-qr-title">Seleccione OpciÃ³n QR</h3>
                
                <!-- Input oculto para captura de foto -->
                <input type="file" id="camera-capture-input" accept="image/*" capture="environment" class="hidden">
                
                <!-- BotÃ³n Capturar Foto (primera opciÃ³n) -->
                <button id="camera-capture-btn" class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 px-6 rounded-xl shadow-md mb-3 flex items-center justify-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.125 3h3.75a2 2 0 011.664.89l.812 1.22a2 2 0 001.664.89H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span>Capturar Foto</span>
                </button>
                
                <button id="modal-upload-file-btn" class="w-full bg-drk-800 hover:bg-drk-900 text-white font-bold py-3 px-6 rounded-xl shadow-md mb-3">Subir Imagen</button>
                <button id="modal-paste-image-btn" class="w-full bg-drk-600 hover:bg-drk-800 text-white font-bold py-3 px-6 rounded-xl shadow-md mb-3">Pegar Imagen (CTRL+V)</button>
                
                <!-- NUEVO: 4Âª OpciÃ³n - Pegar CÃ³digo Completo -->
                <button id="modal-paste-url-btn" class="w-full bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-bold py-3 px-6 rounded-xl shadow-md mb-4 flex items-center justify-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span>Pegar CÃ³digo Completo</span>
                </button>
                
                <button onclick="document.getElementById('qr-options-modal').classList.add('hidden'); document.getElementById('qr-options-modal').classList.remove('flex');" class="w-full bg-slate-200 font-bold py-3 rounded-xl">Cancelar</button>
            </div>
        </div>

        <!-- NUEVO: Modal para Pegar CÃ³digo Completo del QR -->
        <div id="paste-url-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-lg w-full">
                <h3 class="text-xl font-bold text-drk-800 mb-2">ðŸ“‹ Pegar CÃ³digo QR Completo</h3>
                <p class="text-sm text-slate-600 mb-4">Pega aquÃ­ la URL completa que obtuviste de otra aplicaciÃ³n de lectura de QR.</p>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 text-xs text-blue-800">
                    <strong>ðŸ’¡ Ejemplo:</strong><br>
                    <code class="text-xs break-all">https://comparador.cnmc.gob.es/comparador/QRE?cp=28700&pP1=9.200&...</code>
                </div>
                
                <textarea id="paste-url-textarea" placeholder="Pega aquÃ­ la URL completa del QR..." class="w-full h-32 p-3 border border-slate-300 rounded-lg text-sm font-mono resize-none focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none mb-4"></textarea>
                
                <div class="flex gap-3">
                    <button id="paste-url-process-btn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-xl shadow-md">
                        âœ“ Procesar CÃ³digo
                    </button>
                    <button id="paste-url-cancel-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 px-6 rounded-xl">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>

        <!-- 9. Send Offer Modal (Copy HTML) -->
        <div id="send-offer-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm overflow-y-auto">
            <div class="bg-white p-5 rounded-2xl shadow-2xl max-w-sm w-full my-8 max-h-[90vh] overflow-y-auto">
                <h3 class="text-lg font-bold text-drk-800 mb-3" id="modal-client-data-title">Datos del Comercial y Cliente</h3>
                <p class="text-xs text-slate-600 mb-3">Rellene sus datos para generar el comparativo.</p>
                
                <input type="text" id="comercial-code-input" placeholder="CÃ“DIGO COMERCIAL (Obligatorio)" class="w-full mb-2 p-2.5 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-drk-500 outline-none">
                <input type="text" id="client-name-input" placeholder="Nombre Cliente" class="w-full mb-2 p-2.5 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-drk-500 outline-none">
                <input type="tel" id="client-phone-input" placeholder="TelÃ©fono" class="w-full mb-2 p-2.5 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-drk-500 outline-none">
                <input type="text" id="client-address-input" placeholder="DirecciÃ³n de Suministro" class="w-full mb-2 p-2.5 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-drk-500 outline-none">
                <input type="email" id="client-email-input" placeholder="Email" class="w-full mb-3 p-2.5 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-drk-500 outline-none">
                
                <!-- NUEVO: Selector de modo de presentaciÃ³n para potencias optimizadas (COMPACTO) -->
                <div id="optimized-presentation-mode-selector" class="hidden mb-3 bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-300 p-3 rounded-xl">
                    <label class="block text-xs font-bold text-purple-900 mb-2">ðŸ“Š Modo de PresentaciÃ³n de Potencias Optimizadas</label>
                    <div class="space-y-2">
                        <label class="flex items-start cursor-pointer bg-white p-2 rounded-lg border-2 border-transparent hover:border-purple-400 transition">
                            <input type="radio" name="presentation-mode" value="two-columns" checked class="mt-0.5 w-3.5 h-3.5 text-purple-600 focus:ring-purple-500 mr-2 flex-shrink-0">
                            <div class="flex-1">
                                <span class="text-xs font-bold text-slate-800">Modo A - Dos Columnas</span>
                                <p class="text-[10px] text-slate-600 mt-0.5 leading-tight">Muestra potencias actuales y optimizadas lado a lado. El cliente VE las potencias propuestas.</p>
                            </div>
                        </label>
                        <label class="flex items-start cursor-pointer bg-white p-2 rounded-lg border-2 border-transparent hover:border-purple-400 transition">
                            <input type="radio" name="presentation-mode" value="one-column" class="mt-0.5 w-3.5 h-3.5 text-purple-600 focus:ring-purple-500 mr-2 flex-shrink-0">
                            <div class="flex-1">
                                <span class="text-xs font-bold text-slate-800">Modo B - Una Columna</span>
                                <p class="text-[10px] text-slate-600 mt-0.5 leading-tight">Solo potencias actuales. Al final resumen de ahorros. El cliente NO ve quÃ© potencias bajar.</p>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- Nota informativa para iPhone (COMPACTA) -->
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-2 mb-3">
                    <div class="flex items-start gap-1.5">
                        <span class="text-amber-600 text-base flex-shrink-0">âš ï¸</span>
                        <div class="text-[10px] text-amber-800 leading-tight">
                            <p class="font-bold mb-0.5">NOTA PARA iPHONE:</p>
                            <p>Para mejor resultado: âœ“ Copia desde <strong>ordenador</strong> o âœ“ Usa <strong>Gmail/Outlook web</strong> en navegador mÃ³vil</p>
                        </div>
                    </div>
                </div>
                
                <button id="execute-send-offer-btn" class="w-full bg-cta-red-500 hover:bg-cta-red-600 text-white font-bold py-3 rounded-xl shadow-md mb-2">
                    ðŸ“§ COPIAR COMPARATIVO (HTML)
                </button>
                <button id="execute-pdf-offer-btn" class="w-full bg-drk-600 hover:bg-drk-700 text-white font-bold py-3 rounded-xl shadow-md mb-2">
                    ðŸ“„ CREAR PDF COMPARATIVO
                </button>
                <button onclick="document.getElementById('send-offer-modal').classList.add('hidden'); document.getElementById('send-offer-modal').classList.remove('flex');" class="w-full bg-slate-200 font-bold py-2.5 rounded-xl text-sm">Cancelar</button>
            </div>
        </div>

        <!-- 9.5. Request Improvement Modal (Nuevo) -->
        <div id="request-improvement-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full">
                <h3 class="text-xl font-bold text-drk-800 mb-4" data-i18n="Request Improvement from DRK">Solicitar Mejora a DRK</h3>
                <p class="text-sm text-slate-600 mb-4" data-i18n="Complete los datos para que el equipo de Back Office pueda revisar este comparativo y buscar una mejor opciÃ³n.">Complete los datos para que el equipo de Back Office pueda revisar este comparativo y buscar una mejor opciÃ³n.</p>
                
                <input type="text" id="improvement-comercial-code" data-i18n-placeholder="CÃ“DIGO COMERCIAL (Obligatorio)" placeholder="CÃ“DIGO COMERCIAL (Obligatorio)" class="w-full mb-3 p-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-amber-500 outline-none">
                <input type="text" id="improvement-client-name" data-i18n-placeholder="Nombre Cliente" placeholder="Nombre Cliente" class="w-full mb-3 p-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-amber-500 outline-none">
                <input type="text" id="improvement-client-cups" data-i18n-placeholder="CUPS" placeholder="CUPS" class="w-full mb-3 p-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-amber-500 outline-none">
                <input type="tel" id="improvement-client-phone" data-i18n-placeholder="TelÃ©fono" placeholder="TelÃ©fono" class="w-full mb-3 p-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-amber-500 outline-none">
                <input type="email" id="improvement-client-email" data-i18n-placeholder="Email" placeholder="Email" class="w-full mb-3 p-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-amber-500 outline-none">
                <textarea id="improvement-observations" data-i18n-placeholder="Observaciones (opcional)" placeholder="Observaciones (opcional)" rows="3" class="w-full mb-4 p-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-amber-500 outline-none resize-none"></textarea>
                
                <!-- Recordatorio -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                    <div class="flex items-start gap-2">
                        <span class="text-blue-600 text-xl">ðŸ“Ž</span>
                        <div class="text-xs text-blue-800">
                            <p class="font-bold mb-1" data-i18n="RECORDATORIO:">RECORDATORIO:</p>
                            <p class="leading-relaxed" data-i18n="Por favor, adjunte las facturas del cliente en su respuesta al email automÃ¡tico que recibirÃ¡.">Por favor, adjunte las facturas del cliente en su respuesta al email automÃ¡tico que recibirÃ¡.</p>
                        </div>
                    </div>
                </div>
                
                <button id="execute-improvement-request-btn" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white font-black py-3 rounded-xl shadow-md mb-3" data-i18n="ðŸ“§ ENVIAR SOLICITUD">
                    ðŸ“§ ENVIAR SOLICITUD
                </button>
                <button onclick="document.getElementById('request-improvement-modal').classList.add('hidden'); document.getElementById('request-improvement-modal').classList.remove('flex');" class="w-full bg-slate-200 font-bold py-3 rounded-xl text-sm" data-i18n="Cancelar">Cancelar</button>
            </div>
        </div>

        <!-- 9.8. Modal de DecisiÃ³n (Mejor OpciÃ³n vs Elegir) -->
        <div id="offer-decision-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full">
                <!-- Header -->
                <div class="bg-gradient-to-r from-drk-600 to-drk-700 p-6 text-white">
                    <h3 id="calculation-complete-title" class="text-2xl font-black">âœ… CÃ¡lculo Completado</h3>
                    <p id="calculation-complete-subtitle" class="text-drk-100 text-sm mt-1">Hemos encontrado ofertas con ahorro. Â¿CÃ³mo quieres continuar?</p>
                </div>
                
                <!-- Content -->
                <div class="p-6">
                    <!-- NUEVO: Checkbox para comparaciÃ³n con tarifas indexadas (SOLO POWER CUP) -->
                    <div id="powercup-indexed-comparison-checkbox" class="hidden mb-6 p-4 bg-gradient-to-r from-blue-50 to-green-50 rounded-xl border-2 border-blue-200">
                        <label class="flex items-start gap-3 cursor-pointer group">
                            <input 
                                type="checkbox" 
                                id="compare-indexed-checkbox" 
                                class="mt-1 w-5 h-5 text-drk-600 border-2 border-slate-300 rounded focus:ring-2 focus:ring-drk-500 cursor-pointer"
                                onchange="toggleIndexedComparison(this.checked)"
                            >
                            <div class="flex-1">
                                <p id="compare-fijo-indexado-title" class="font-black text-base text-slate-900 mb-1 group-hover:text-drk-600 transition">
                                    âš¡ Comparar FIJO vs INDEXADO
                                </p>
                                <p id="compare-fijo-indexado-desc" class="text-sm text-slate-600">
                                    Genera comparativa dual: tarifa fija y tarifa indexada DRK INDEX (precio variable del mercado).
                                </p>
                            </div>
                        </label>
                    </div>
                    
                    <div class="flex flex-col gap-4">
                        <!-- OpciÃ³n 1: Mejor OpciÃ³n (CON SELECTOR PARA DRK) -->
                        <div class="rounded-xl border-2 border-slate-300 bg-white overflow-hidden">
                            <!-- Cabecera clickeable -->
                            <button onclick="handleBestOptionClick()" class="w-full text-left p-6 hover:bg-drk-50 transition group">
                                <div class="flex items-start gap-4">
                                    <div class="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center flex-shrink-0 group-hover:bg-yellow-200">
                                        ðŸ†
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-black text-lg text-slate-900 mb-2">VER MEJOR OPCIÃ“N</p>
                                        <p class="text-sm text-slate-600">Muestra automÃ¡ticamente la oferta con mayor ahorro y genera la comparativa</p>
                                    </div>
                                    <svg class="w-6 h-6 text-slate-400 group-hover:text-drk-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </div>
                            </button>
                            
                            <!-- Selector de tipo de tarifa (SOLO para DRK Individual) -->
                            <div id="best-option-tariff-selector" class="hidden border-t-2 border-slate-200 bg-slate-50 p-4">
                                <p id="tariff-selector-title" class="text-sm font-bold text-slate-700 mb-3">ðŸŽ¯ Â¿QuÃ© tipo de tarifa DRK quieres ver?</p>
                                <div class="space-y-2">
                                    <!-- Tarifa FIJA -->
                                    <label class="flex items-center gap-3 p-3 rounded-lg border-2 border-drk-500 bg-drk-50 cursor-pointer transition hover:bg-drk-100" id="best-fija-label">
                                        <input 
                                            type="radio" 
                                            name="best-option-tariff-type" 
                                            value="fija" 
                                            checked
                                            class="w-4 h-4 text-drk-600 border-2 border-slate-300 focus:ring-2 focus:ring-drk-500 cursor-pointer"
                                            onchange="updateBestOptionTariffChoice('fija')"
                                        >
                                        <div class="flex-1">
                                            <p id="tarifa-fija-title" class="font-bold text-sm text-slate-900">âš¡ Tarifa FIJA</p>
                                            <p id="tarifa-fija-desc" class="text-xs text-slate-600">Precio fijo estable (excluye DRK INDEX)</p>
                                        </div>
                                    </label>
                                    
                                    <!-- Tarifa INDEXADA -->
                                    <label class="flex items-center gap-3 p-3 rounded-lg border-2 border-slate-200 bg-white cursor-pointer transition hover:bg-green-50" id="best-indexada-label">
                                        <input 
                                            type="radio" 
                                            name="best-option-tariff-type" 
                                            value="indexada"
                                            class="w-4 h-4 text-green-600 border-2 border-slate-300 focus:ring-2 focus:ring-green-500 cursor-pointer"
                                            onchange="updateBestOptionTariffChoice('indexada')"
                                        >
                                        <div class="flex-1">
                                            <p id="tarifa-indexada-title" class="font-bold text-sm text-slate-900">ðŸŒ± Tarifa INDEXADA (DRK INDEX)</p>
                                            <p id="tarifa-indexada-desc" class="text-xs text-slate-600">Solo muestra DRK INDEX del mercado</p>
                                        </div>
                                    </label>
                                </div>
                                
                                <!-- BotÃ³n de confirmaciÃ³n -->
                                <button id="tariff-selector-continue-btn" onclick="selectBestOptionWithChoice()" class="w-full mt-3 bg-drk-600 hover:bg-drk-700 text-white font-bold py-3 rounded-lg transition">
                                    Continuar con esta opciÃ³n â†’
                                </button>
                            </div>
                        </div>
                        
                        <!-- OpciÃ³n 2: Elegir Manual -->
                        <button onclick="selectFromResults()" class="text-left p-6 rounded-xl border-2 border-slate-300 bg-white hover:border-drk-500 hover:bg-drk-50 transition group">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0 group-hover:bg-blue-200">
                                    ðŸ“‹
                                </div>
                                <div class="flex-1">
                                    <p class="font-black text-lg text-slate-900 mb-2">ELEGIR ENTRE RESULTADOS</p>
                                    <p class="text-sm text-slate-600">Revisa todas las ofertas con ahorro positivo y elige la que prefieras</p>
                                </div>
                                <svg class="w-6 h-6 text-slate-400 group-hover:text-drk-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </div>
                        </button>
                    </div>
                    
                    <!-- Info adicional -->
                    <div class="mt-6 p-4 bg-slate-50 rounded-lg">
                        <p id="advice-text" class="text-xs text-slate-600">
                            ðŸ’¡ <strong id="advice-label">Consejo:</strong> <span id="advice-content">Si quieres ver rÃ¡pidamente la mejor oferta, elige la primera opciÃ³n. Si necesitas comparar varias opciones o el cliente tiene preferencias especÃ­ficas, elige la segunda.</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 9.8 Modal de SelecciÃ³n de Modo de PresentaciÃ³n (Potencias Optimizadas) -->
        <div id="pdf-presentation-mode-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full">
                <!-- Header -->
                <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-6 text-white">
                    <h3 class="text-2xl font-black">ðŸ“Š Modo de PresentaciÃ³n de Potencias Optimizadas</h3>
                    <p class="text-purple-100 text-sm mt-1">Selecciona cÃ³mo mostrar las potencias en el PDF</p>
                </div>
                
                <!-- Content -->
                <div class="p-6">
                    <div class="space-y-4">
                        <!-- Modo A - Dos Columnas -->
                        <label class="block">
                            <input 
                                type="radio" 
                                name="presentation-mode" 
                                value="two-columns" 
                                checked
                                class="hidden peer"
                                id="mode-two-columns"
                            >
                            <div class="p-6 rounded-xl border-2 border-slate-300 bg-white cursor-pointer transition hover:border-purple-500 hover:bg-purple-50 peer-checked:border-purple-600 peer-checked:bg-purple-50 peer-checked:shadow-lg">
                                <div class="flex items-start gap-4">
                                    <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center flex-shrink-0 peer-checked:bg-purple-600">
                                        <svg class="w-6 h-6 text-purple-600 peer-checked:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-black text-lg text-slate-900 mb-2">ðŸ“Š Modo A - Dos Columnas</p>
                                        <p class="text-sm text-slate-600 mb-2">Muestra potencias actuales y optimizadas lado a lado. El cliente VE las potencias propuestas.</p>
                                        <ul class="text-xs text-slate-500 space-y-1 ml-4">
                                            <li>â€¢ Columna izquierda: Potencias actuales</li>
                                            <li>â€¢ Columna derecha: Potencias optimizadas</li>
                                            <li>â€¢ ComparaciÃ³n visual directa</li>
                                            <li>â€¢ Ideal para mostrar propuesta de optimizaciÃ³n</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </label>
                        
                        <!-- Modo B - Una Columna -->
                        <label class="block">
                            <input 
                                type="radio" 
                                name="presentation-mode" 
                                value="one-column"
                                class="hidden peer"
                                id="mode-one-column"
                            >
                            <div class="p-6 rounded-xl border-2 border-slate-300 bg-white cursor-pointer transition hover:border-blue-500 hover:bg-blue-50 peer-checked:border-blue-600 peer-checked:bg-blue-50 peer-checked:shadow-lg">
                                <div class="flex items-start gap-4">
                                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0 peer-checked:bg-blue-600">
                                        <svg class="w-6 h-6 text-blue-600 peer-checked:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-black text-lg text-slate-900 mb-2">ðŸ“„ Modo B - Una Columna</p>
                                        <p class="text-sm text-slate-600 mb-2">Solo potencias actuales. Al final resumen de ahorros. El cliente NO ve quÃ© potencias bajar.</p>
                                        <ul class="text-xs text-slate-500 space-y-1 ml-4">
                                            <li>â€¢ Muestra solo el cÃ¡lculo actual</li>
                                            <li>â€¢ Resumen final: "Ahorro con optimizaciÃ³n"</li>
                                            <li>â€¢ No revela las potencias propuestas</li>
                                            <li>â€¢ Ideal para presentaciÃ³n comercial</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </label>
                    </div>
                    
                    <!-- Botones -->
                    <div class="flex gap-3 mt-6">
                        <button onclick="closePresentationModeModal()" class="flex-1 px-6 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold rounded-xl transition">
                            Cancelar
                        </button>
                        <button onclick="confirmPresentationMode()" class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold rounded-xl transition shadow-lg">
                            Generar PDF â†’
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 9.9. Modal de SelecciÃ³n de Oferta -->
        <div id="offer-selection-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] flex flex-col">
                <!-- Header -->
                <div class="bg-gradient-to-r from-drk-600 to-drk-700 p-6 text-white flex-shrink-0">
                    <h3 id="offer-selection-title" class="text-2xl font-black">ðŸ“‹ SELECCIONA TU OFERTA</h3>
                    <p id="offer-selection-subtitle" class="text-drk-100 text-sm mt-1">Hemos calculado todas las opciones con ahorro. Elige la que prefieras.</p>
                </div>
                
                <!-- Content -->
                <div class="p-6 overflow-y-auto flex-1">
                    <!-- Info del CUPS -->
                    <div class="bg-slate-50 rounded-lg p-4 mb-4">
                        <p id="datos-suministro-label" class="text-xs font-bold text-slate-600 mb-2">ðŸ“‹ DATOS DEL SUMINISTRO</p>
                        <p class="text-sm font-mono" id="modal-selection-cups"></p>
                    </div>
                    
                    <!-- NUEVO: Controles de Filtrado y OrdenaciÃ³n -->
                    <div class="bg-white border-2 border-drk-200 rounded-xl p-4 mb-4">
                        <div class="flex flex-col md:flex-row gap-3">
                            <!-- Filtro por nombre -->
                            <div class="flex-1">
                                <label id="buscar-nombre-label" class="block text-xs font-bold text-slate-600 mb-2">ðŸ” BUSCAR POR NOMBRE</label>
                                <input 
                                    type="text" 
                                    id="offer-search-input" 
                                    placeholder="Escribe nombre de comercializadora..."
                                    class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-drk-500 focus:outline-none text-sm"
                                    onkeyup="filterAndSortOffers()"
                                >
                            </div>
                            
                            <!-- OrdenaciÃ³n -->
                            <div class="md:w-64">
                                <label id="ordenar-por-label" class="block text-xs font-bold text-slate-600 mb-2">ðŸ“Š ORDENAR POR</label>
                                <select 
                                    id="offer-sort-select" 
                                    class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-drk-500 focus:outline-none text-sm font-medium"
                                    onchange="filterAndSortOffers()"
                                >
                                    <option value="savings_desc">ðŸ’° Mayor ahorro primero</option>
                                    <option value="savings_asc">ðŸ’¸ Menor ahorro primero</option>
                                    <option value="name_asc">ðŸ”¤ Nombre (A-Z)</option>
                                    <option value="name_desc">ðŸ”¤ Nombre (Z-A)</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Contador de resultados -->
                        <div class="mt-3 flex items-center justify-between">
                            <p class="text-xs text-slate-500">
                                <span class="font-bold text-drk-600" id="offers-visible-count">0</span> <span id="offers-de-text">de</span> <span id="offers-total-count">0</span> <span id="offers-text">ofertas</span>
                            </p>
                            <button 
                                id="limpiar-filtros-btn"
                                onclick="clearOfferFilters()" 
                                class="text-xs text-drk-600 hover:text-drk-800 font-bold hover:underline"
                            >
                                ðŸ”„ Limpiar filtros
                            </button>
                        </div>
                    </div>
                    
                    <!-- Lista de ofertas con radio buttons -->
                    <div id="offers-radio-list" class="space-y-3 mb-6">
                        <!-- Se rellenarÃ¡ dinÃ¡micamente -->
                    </div>
                    
                    <!-- Mensaje cuando no hay resultados -->
                    <div id="no-offers-message" class="hidden text-center py-8">
                        <p class="text-slate-400 text-lg mb-2">ðŸ”</p>
                        <p class="text-slate-600 font-bold">No se encontraron ofertas</p>
                        <p class="text-slate-500 text-sm">Prueba con otros criterios de bÃºsqueda</p>
                    </div>
                </div>
                
                <!-- Footer con botones -->
                <div class="p-6 border-t border-slate-200 flex-shrink-0">
                    <div class="flex gap-3">
                        <button id="back-offer-selection-btn" onclick="closeOfferSelectionModal()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 rounded-xl transition">
                            â† Volver
                        </button>
                        <button id="confirm-offer-selection-btn" class="flex-1 bg-drk-600 hover:bg-drk-700 text-white font-bold py-3 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed transition" disabled>
                            Generar Comparativa â†’
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 10. Error/Message Modal -->
        <div id="error-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full text-center">
                <div class="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4" id="error-icon"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                <h3 class="text-lg font-bold text-slate-800 mb-2" id="error-title">Â¡AtenciÃ³n!</h3>
                <p id="error-message" class="text-slate-600 text-sm mb-6"></p>
                <div class="space-y-2">
                    <button onclick="hideErrorModal()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-xl">Entendido</button>
                    <button id="secondary-action-btn" class="w-full bg-slate-200 text-slate-600 font-bold py-3 rounded-xl text-sm mt-2 hidden">AcciÃ³n Secundaria</button>
                </div>
            </div>
        </div>
        
        <!-- 11. Modal de DirecciÃ³n de Suministro (Multicups) -->
        <div id="supply-address-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full">
                <!-- Icono de ubicaciÃ³n -->
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </div>
                
                <h3 class="text-xl font-bold text-slate-800 mb-2 text-center">DirecciÃ³n del Suministro</h3>
                <p class="text-slate-600 text-sm mb-4 text-center">Introduce la direcciÃ³n del suministro <span id="supply-number-label" class="font-bold text-drk-600"></span></p>
                
                <!-- CUPS del suministro -->
                <div class="bg-slate-50 rounded-lg p-3 mb-4">
                    <p class="text-xs font-bold text-slate-600 mb-1">ðŸ“‹ CUPS</p>
                    <p class="text-sm font-mono text-slate-800" id="supply-cups-display"></p>
                </div>
                
                <!-- Input de direcciÃ³n -->
                <div class="mb-6">
                    <label class="block text-sm font-bold text-slate-700 mb-2">
                        DirecciÃ³n completa
                    </label>
                    <input 
                        type="text" 
                        id="multicups-supply-address" 
                        placeholder="Ej: Calle Mayor 123, Madrid" 
                        class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:border-drk-500 focus:outline-none"
                    >
                    <p class="text-xs text-slate-500 mt-2">Esta direcciÃ³n aparecerÃ¡ en el PDF junto al CUPS</p>
                </div>
                
                <!-- Botones -->
                <div class="flex gap-3">
                    <button onclick="cancelAddressInput()" class="flex-1 px-6 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold rounded-xl transition">
                        Omitir
                    </button>
                    <button onclick="confirmAddressInput()" class="flex-1 px-6 py-3 bg-drk-500 hover:bg-drk-600 text-white font-bold rounded-xl transition">
                        Confirmar â†’
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Overlay de procesamiento QR - Grande y visible -->
    <div id="qr-processing-overlay" class="fixed inset-0 bg-slate-900/95 hidden items-center justify-center z-[100] backdrop-blur-md">
        <div class="text-center px-6">
            <!-- Spinner grande animado -->
            <div class="relative mx-auto mb-8">
                <div class="w-32 h-32 border-8 border-green-500/20 border-t-green-500 rounded-full animate-spin"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <svg class="w-16 h-16 text-green-500 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M12 12h-4.01M12 12V8m0 4l-4-4m4 4l4-4m0 0v4m0-4h-4"></path>
                    </svg>
                </div>
            </div>
            
            <!-- TÃ­tulo grande -->
            <h2 id="qr-analyzing-title" class="text-3xl font-bold text-white mb-3">
                ðŸ” Analizando QR
            </h2>
            
            <!-- Mensaje de progreso -->
            <p id="qr-progress-message" class="text-xl text-green-400 font-semibold mb-6">
                Procesando imagen...
            </p>
            
            <!-- Contador de intentos -->
            <div class="bg-white/10 rounded-xl px-6 py-4 inline-block">
                <p id="qr-progress-label" class="text-white text-sm mb-2">Progreso de anÃ¡lisis</p>
                <p id="qr-attempt-counter" class="text-2xl font-bold text-green-400">
                    1 / 6
                </p>
            </div>
            
            <!-- Texto de ayuda -->
            <p id="qr-help-text" class="text-slate-400 text-sm mt-8 max-w-md mx-auto">
                Estamos probando diferentes tÃ©cnicas para detectar tu cÃ³digo QR. 
                Esto puede tardar unos segundos...
            </p>
        </div>
    </div>
    
    <!-- Paste Catcher (Hidden element for capturing pasted image data) -->
    <textarea id="paste-catcher" aria-hidden="true" title="Ãrea de pegado (invisible)"></textarea>

    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        .animate-pulse {
            animation: pulse 2s ease-in-out infinite;
        }
    </style>

    <script>
        // Inicializar modo DUAL en false
        window.dualMode = false;
        
        // --- CONFIGURACIÃ“N DE TIPO DE TARIFAS ---
        // **ATENCIÃ“N: Los IDs de las hojas deben ser pÃºblicos para funcionar (CSV)**
        // Eliminamos 6.1TD de la configuraciÃ³n
        const TARIFF_CONFIG = {
            '2.0TD': { sheetId: '19CBiWVvxHoWW0fqdbSbLGs-hoISQGORAfebBztFYi3w', periods: 3, powerPeriods: 2, label: '2.0 TD', isHighVoltage: false, requiresQR: true, isMulti: false },
            '3.0TD': { sheetId: '18nieA7yMD9Ytc2Z3EnktoNDZokuMrBet_ETGyhNZDuo', periods: 6, powerPeriods: 6, label: '3.0 TD', isHighVoltage: true, requiresQR: false, isMulti: false },
            'MULTICUPS': { sheetId: 'MULTICUPS_MIXED_TARIF_SHEET_ID', periods: 6, powerPeriods: 6, label: 'MULTICUPS', isHighVoltage: false, requiresQR: true, isMulti: true, baseTariffType: '2.0TD' }
        };

        const BRANDS = {
            DRK: {
                NAME: 'DRK', ACCENT: 'drk-500', ACCENT_TEXT: 'EnergÃ­a',
                FULL_NAME: 'DRK ENERGÃA', // AÃ‘ADIDO
                TITLE: 'DRK COMPARADOR', // TÃ­tulo en mayÃºsculas
                QR_URL: 'https://faraujoteixeiradrk-creator.github.io/QR-21-POWER-2-0-TD---3.0-TD-Con-PDF/',
                QR_TEXT: 'DRK',
                QR_BORDER_COLOR: '#0ea5e9', // drk-500
                QR_CENTER_BG: '#075985', // drk-800
                PRIMARY_BG_GRADIENT: 'from-drk-800 to-drk-600', 
                PRIMARY_BUTTON: 'from-drk-600 to-drk-800 hover:from-drk-700 hover:to-drk-900', // ESCANEAR QR
                SECONDARY_BUTTON_BG: 'bg-drk-50', // OPCIONES QR MANUAL / DATOS A MANO BG
                SECONDARY_BUTTON_TEXT: 'text-drk-800', // OPCIONES QR MANUAL / DATOS A MANO Text
                PRIMARY_TEXT: 'text-drk-800', SECONDARY_BG: 'bg-drk-50', SECONDARY_TEXT: 'text-drk-600', BORDER: 'border-drk-500',
                LOGO_SVG: `<svg class="w-8 h-8" viewBox="0 0 100 100" fill="none"><style>.drk-ring{fill:none;stroke-width:10;stroke-linecap:round;}</style><circle class="drk-ring" cx="45" cy="45" r="35" stroke="#E50000"/><circle class="drk-ring" cx="55" cy="55" r="35" stroke="#FFCC00"/><circle class="drk-ring" cx="45" cy="55" r="35" stroke="#0079C1"/><circle class="drk-ring" cx="55" cy="45" r="35" stroke="#00A859"/></svg>`,
                NAV_BG: 'bg-drk-900', NAV_SUBTITLE_BG: 'bg-drk-800', NAV_SUBTITLE_TEXT: 'text-drk-100'
            },
            POWER_CUP: {
                NAME: 'POWER CUP', ACCENT: 'powercup-500', ACCENT_TEXT: '',
                FULL_NAME: 'POWER CUP', // AÃ‘ADIDO
                TITLE: 'POWER CUP COMPARADOR', // TÃ­tulo en mayÃºsculas
                QR_URL: 'https://faraujoteixeiradrk-creator.github.io/QR-21-POWER-2-0-TD---3.0-TD-Con-PDF/',
                QR_TEXT: 'POWER',
                QR_BORDER_COLOR: '#84cc16', // powercup-500
                QR_CENTER_BG: '#3f6212', // powercup-800
                PRIMARY_BG_GRADIENT: 'from-powercup-900 to-powercup-800', 
                PRIMARY_BUTTON: 'from-powercup-600 to-powercup-800 hover:from-powercup-500 hover:to-powercup-900', // ESCANEAR QR
                SECONDARY_BUTTON_BG: 'bg-powercup-50', // OPCIONES QR MANUAL / DATOS A MANO BG
                SECONDARY_BUTTON_TEXT: 'text-powercup-800', // OPCIONES QR MANUAL / DATOS A MANO Text
                PRIMARY_TEXT: 'text-powercup-800', SECONDARY_BG: 'bg-powercup-50', SECONDARY_TEXT: 'text-powercup-600', BORDER: 'border-powercup-500',
                LOGO_SVG: `<svg width="40" height="40" viewBox="0 0 100 100" fill="none"><path d="M78 40V70C78 80.25 70.25 88 60 88H30C19.75 88 12 80.25 12 70V40C12 29.75 19.75 22 30 22H60C70.25 22 78 29.75 78 40Z" fill="#3f6212"/><circle cx="45" cy="95" r="5" fill="#365314" opacity="0.8"/><rect x="20" y="80" width="50" height="5" rx="2.5" fill="#365314"/><rect x="20" y="30" width="50" height="50" fill="#f7fee7" rx="5"/><rect x="25" y="65" width="40" height="10" rx="2" fill="#84cc16"/><rect x="25" y="50" width="40" height="10" rx="2" fill="#84cc16"/><rect x="25" y="35" width="40" height="10" rx="2" fill="#84cc16"/><path d="M80 20L60 35L70 45L50 60L75 60L65 80L85 65L75 55L85 45L65 45L75 25Z" fill="#facc15" stroke="#3f6212" stroke-width="2" stroke-linejoin="round"/><path d="M78 40C88 40 88 50 88 60C88 70 88 80 78 80" stroke="#3f6212" stroke-width="8" stroke-linecap="round"/></svg>`,
                NAV_BG: 'bg-powercup-900', NAV_SUBTITLE_BG: 'bg-powercup-800', NAV_SUBTITLE_TEXT: 'text-powercup-100'
            }
        };

        const EXTERNAL_APP_URL = 'https://faraujoteixeiradrk-creator.github.io/QR-21-POWER-2-0-TD---3.0-TD-Con-PDF/';
        
        // Estado Global
        // âš¡âš¡âš¡ VERSIÃ“N: 2024-12-31-DEBUG-ULTRA-v45 âš¡âš¡âš¡
        console.log('ðŸ”¥ðŸ”¥ðŸ”¥ ARCHIVO CARGADO - VERSIÃ“N: 2024-12-31-DEBUG-ULTRA-v45 ðŸ”¥ðŸ”¥ðŸ”¥');
        console.log('ðŸ” DEBUG ULTRA: Logs JSON.stringify para ver arrays completos');
        console.log('ðŸ” Esto mostrarÃ¡ EXACTAMENTE quÃ© propiedades tienen powerCosts y energyCosts');
        console.log('ðŸ“ Por favor, comparte los logs de powerCosts[0] y energyCosts[0] COMPLETOS');
        
        // Eliminamos 6.1TD del estado inicial
        let currentTariffs = {
            '2.0TD': [],
            '3.0TD': []
        };
        let currentTariffType = '2.0TD';
        let lastComparisonResult = null;
        let lastIndexedResult = null; // Para almacenar el resultado de tarifa indexada
        let comparisonMode = 'drk_only';
        let compareWithIndexed = false; // Control para comparaciÃ³n con tarifas indexadas
        let bestOptionTariffChoice = 'fija'; // NUEVO: ElecciÃ³n de tarifa para VER MEJOR OPCIÃ“N ('fija' o 'indexada')
        let isProcessingBestOption = false; // NUEVO: Bandera para prevenir llamadas concurrentes
        let activeBrand = BRANDS.DRK;
        let qrCodeInstance = null; // Instancia de QRCode.js
        
        // Nuevas variables para selecciÃ³n avanzada de ofertas
        let availableOffers = []; // Array de todas las ofertas con ahorro positivo
        let manuallySelectedOffer = null; // Oferta seleccionada manualmente

        // Estado Multicups
        let multiCupsData = [];
        let tempQrData = null; // Almacenamiento temporal para datos de QR antes de la confirmaciÃ³n
        let multiCupsAddType = null; // NEW: Holds '2.0TD' or '3.0TD' when adding a single CUPS in MultiCups mode.
        
        // Variables EscÃ¡ner
        let scannerRunning = false;
        let scanLoopCount = 0; // Contador de frames para procesamiento progresivo
        let frameCount = 0; // Contador para ciclo hÃ­brido de 3 modos
        let stream = null, video = null, canvas = null, canvasCtx = null, animationFrameId = null;
        
        // Variables para detecciÃ³n Google Lens
        let qrRegionDetected = null; // RegiÃ³n del QR cuando se detecta: {x, y, width, height}
        let qrDetectionFrame = 0; // Frame en el que se detectÃ³ el QR
        let qrStableFrames = 0; // Frames consecutivos con QR detectado (para estabilidad)
        
        // ProtecciÃ³n anti-duplicados para compareOffers
        let lastCompareOffersCall = 0;
        let lastCompareOffersData = null;

        // --- FUNCIONES DE FORMATO ROBUSTAS ---
        const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
        const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
        const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);

        // FunciÃ³n para obtener TODAS las ofertas Ãºnicas usadas en los resultados
        function getWinningOffersPerType(results) {
            // Cambio: Ahora guardamos arrays de ofertas Ãºnicas
            const winningOffers = { '2.0TD': [], '3.0TD': [] };
            let hasDrkWinner = false;
            
            results.forEach(resItem => {
                const type = resItem.originalTariffType;
                const winnerOffer = resItem.offer;
                
                // Track if any DRK offer won
                if (winnerOffer.isDrk && winnerOffer.name !== 'Tu Tarifa Actual') {
                    hasDrkWinner = true;
                }

                // Collect ALL unique winning offers for this type
                if (type === '2.0TD' || type === '3.0TD') {
                    const key = type;
                    
                    if (winnerOffer.name !== 'Tu Tarifa Actual') {
                        // Crear un identificador Ãºnico basado en los precios (no solo el nombre)
                        // Esto permite diferenciar ofertas con el mismo nombre pero diferentes precios
                        const offerSignature = type === '2.0TD' 
                            ? `${winnerOffer.name}_${winnerOffer.p1_price}_${winnerOffer.p2_price}_${winnerOffer.p3_price}`
                            : `${winnerOffer.name}_${winnerOffer.p1_price}_${winnerOffer.p2_price}_${winnerOffer.p3_price}_${winnerOffer.p4_price}`;
                        
                        // Verificar si esta oferta ya estÃ¡ (por firma Ãºnica)
                        const alreadyExists = winningOffers[key].some(o => {
                            const existingSignature = type === '2.0TD'
                                ? `${o.name}_${o.p1_price}_${o.p2_price}_${o.p3_price}`
                                : `${o.name}_${o.p1_price}_${o.p2_price}_${o.p3_price}_${o.p4_price}`;
                            return existingSignature === offerSignature;
                        });
                        
                        if (!alreadyExists) {
                            winningOffers[key].push({
                                ...winnerOffer,
                                totalAnnual: resItem.totalAnnual
                            });
                        }
                    }
                }
            });

            return { winningOffers, hasDrkWinner };
        }
        
        // --- FUNCIONES DE MODALES Y UI ---
        
        window.hideErrorModal = () => {
            document.getElementById('error-modal').classList.add('hidden');
            document.getElementById('error-modal').classList.remove('flex');
            const secondaryBtn = document.getElementById('secondary-action-btn');
            if (secondaryBtn) secondaryBtn.classList.add('hidden');
            cleanupPasteCatcher();
        };

        function setModalContent(msg, title, isError) {
            const brand = activeBrand;
            const basePrefix = brand.NAME.includes('DRK') ? 'drk' : 'powercup';
            
            document.getElementById('error-title').textContent = title;
            document.getElementById('error-message').textContent = msg;

            if (isError) {
                document.getElementById('error-icon').className = "w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4";
                document.getElementById('error-icon').innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
            } else {
                document.getElementById('error-icon').className = `w-12 h-12 bg-${basePrefix}-100 text-${basePrefix}-500 rounded-full flex items-center justify-center mx-auto mb-4`;
                document.getElementById('error-icon').innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
            }
            
            const mainButton = document.querySelector('#error-modal button:not(#secondary-action-btn)');
            if (mainButton) {
                mainButton.textContent = tr("Entendido");
                mainButton.onclick = hideErrorModal;
            }

            document.getElementById('error-modal').classList.remove('hidden');
            document.getElementById('error-modal').classList.add('flex');
            
            const secondaryBtn = document.getElementById('secondary-action-btn');
            if (secondaryBtn) secondaryBtn.classList.add('hidden');
            
            // CRÃTICO: Traducir contenido del modal
            if (window.translateAll) {
                setTimeout(() => window.translateAll(), 50);
            }
        }

        window.showMessageModal = (msg, title=tr("Ã‰xito")) => setModalContent(msg, title, false);
        window.showErrorModal = (msg, title=tr("Â¡AtenciÃ³n!")) => setModalContent(msg, title, true);
        
        // --- FUNCIONES PARA MODAL DE DIRECCIÃ“N DE SUMINISTRO (MULTICUPS) ---
        let pendingSupplyData = null; // Almacena temporalmente los datos del suministro mientras se pide la direcciÃ³n
        let pendingSupplyTariffType = null;
        
        // --- FUNCIONES PARA MODAL DE DIRECCIÃ“N DE SUMINISTRO (DUAL) ---
        let pendingDualSupply = null; // Almacena temporalmente el suministro DUAL mientras se pide la direcciÃ³n
        
        window.showDualSupplyAddressModal = function(type, tariff, data, results) {
            console.log('ðŸ”µ showDualSupplyAddressModal llamada');
            console.log('  Type:', type);
            console.log('  Tariff:', tariff);
            console.log('  Data:', data);
            console.log('  Data.cups:', data.cups);
            console.log('  Results:', results);
            
            // Guardar datos temporalmente
            pendingDualSupply = { type, tariff, data, results };
            
            // Actualizar contenido del modal
            const supplyNumber = dualSupplies.length + 1;
            const typeLabel = type === 'electricidad' ? 'Electricidad' : 'Gas';
            document.getElementById('supply-number-label').textContent = `#${supplyNumber} (${typeLabel})`;
            document.getElementById('supply-cups-display').textContent = data.cups || 'N/A';
            
            // Limpiar el input
            document.getElementById('multicups-supply-address').value = '';
            
            console.log('ðŸ”µ Mostrando modal de direcciÃ³n DUAL');
            
            // Mostrar modal
            const modal = document.getElementById('supply-address-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            console.log('ðŸ”µ Modal classList despuÃ©s de mostrar:', modal.classList.toString());
            
            // Focus en el input
            setTimeout(() => {
                document.getElementById('multicups-supply-address').focus();
            }, 100);
        }
        
        function showSupplyAddressModal(data, tariffType) {
            // Guardar datos temporalmente
            pendingSupplyData = data;
            pendingSupplyTariffType = tariffType;
            
            // Actualizar contenido del modal
            const supplyNumber = multiCupsData.length + 1;
            document.getElementById('supply-number-label').textContent = `#${supplyNumber}`;
            document.getElementById('supply-cups-display').textContent = data.cups || 'MANUAL';
            
            // Limpiar el input
            document.getElementById('multicups-supply-address').value = '';
            
            // Mostrar modal
            document.getElementById('supply-address-modal').classList.remove('hidden');
            document.getElementById('supply-address-modal').classList.add('flex');
            
            // Focus en el input
            setTimeout(() => {
                document.getElementById('multicups-supply-address').focus();
            }, 100);
        }
        
        window.confirmAddressInput = function() {
            const address = document.getElementById('multicups-supply-address').value.trim();
            
            // Cerrar modal
            document.getElementById('supply-address-modal').classList.add('hidden');
            document.getElementById('supply-address-modal').classList.remove('flex');
            
            // Verificar si es DUAL o Multicups
            if (pendingDualSupply) {
                // Es DUAL - aÃ±adir direcciÃ³n y procesar
                const { type, tariff, data, results } = pendingDualSupply;
                
                // AÃ±adir la direcciÃ³n a los datos
                const addressToSave = address || 'No especificada';
                
                // Procesar el suministro DUAL con la direcciÃ³n
                processDualSupplyWithAddress(type, tariff, data, results, addressToSave);
                
                // Limpiar datos temporales
                pendingDualSupply = null;
                
            } else if (pendingSupplyData) {
                // Es Multicups - procesar normalmente
                pendingSupplyData.supplyAddress = address || 'No especificada';
                
                // Procesar el suministro
                saveSupply(pendingSupplyData, pendingSupplyTariffType);
                
                // Limpiar datos temporales
                pendingSupplyData = null;
                pendingSupplyTariffType = null;
            }
        };
        
        window.cancelAddressInput = function() {
            // Cerrar modal
            document.getElementById('supply-address-modal').classList.add('hidden');
            document.getElementById('supply-address-modal').classList.remove('flex');
            
            // Verificar si es DUAL o Multicups
            if (pendingDualSupply) {
                // Es DUAL - procesar sin direcciÃ³n
                const { type, tariff, data, results } = pendingDualSupply;
                
                // Procesar el suministro DUAL sin direcciÃ³n
                processDualSupplyWithAddress(type, tariff, data, results, 'No especificada');
                
                // Limpiar datos temporales
                pendingDualSupply = null;
                
            } else if (pendingSupplyData) {
                // Es Multicups - procesar sin direcciÃ³n
                pendingSupplyData.supplyAddress = 'No especificada';
                
                // Procesar el suministro
                saveSupply(pendingSupplyData, pendingSupplyTariffType);
                
                // Limpiar datos temporales
                pendingSupplyData = null;
                pendingSupplyTariffType = null;
            }
        };
        
        // Nueva funciÃ³n para procesar suministro DUAL con direcciÃ³n
        function processDualSupplyWithAddress(type, tariff, data, results, supplyAddress) {
            console.log('=== processDualSupplyWithAddress ===');
            console.log('Type:', type);
            console.log('Tariff:', tariff);
            console.log('Data:', data);
            console.log('Results:', results);
            console.log('Address:', supplyAddress);
            
            // Recuperar finalResult si fue guardado
            const finalResult = window.pendingDualFinalResult;
            console.log('FinalResult disponible:', finalResult);
            
            if (results.drk.total_anual === 0 && results.powercup.total_anual === 0) {
                console.error('âš ï¸âš ï¸âš ï¸ PROBLEMA: Ambos costes son 0 al aÃ±adir suministro');
                console.error('Results completo:', JSON.stringify(results, null, 2));
            }
            
            // Calcular descripciÃ³n segÃºn el tipo
            let description = '';
            let totalKwh = 0;
            
            if (type === 'electricidad') {
                totalKwh = (parseFloat(data.kwh_p1) || 0) + 
                          (parseFloat(data.kwh_p2) || 0) + 
                          (parseFloat(data.kwh_p3) || 0) + 
                          (parseFloat(data.kwh_p4) || 0) + 
                          (parseFloat(data.kwh_p5) || 0) + 
                          (parseFloat(data.kwh_p6) || 0);
                description = `${totalKwh.toFixed(0)} kWh, ${data.dias} dÃ­as`;
            } else {
                totalKwh = parseFloat(data.kwh) || 0;
                description = `${totalKwh.toFixed(0)} kWh, ${data.dias} dÃ­as`;
            }
            
            // Construir objeto offer - usar finalResult si estÃ¡ disponible
            let offerData = {
                name: 'DRK',
                description: type === 'electricidad' ? 'DRK FIJO 4' : 'DRK 1',
                isDrk: true
            };
            
            // Si tenemos finalResult, extraer la oferta real
            if (finalResult) {
                if (finalResult.offer) {
                    offerData = {
                        ...finalResult.offer,
                        // AÃ±adir precios de potencia y energÃ­a si existen (para electricidad)
                        p1_power_price: finalResult.powerCosts?.[0]?.priceDay || finalResult.powerCosts?.[0]?.price_euro_kw_day,
                        p2_power_price: finalResult.powerCosts?.[1]?.priceDay || finalResult.powerCosts?.[1]?.price_euro_kw_day,
                        p3_power_price: finalResult.powerCosts?.[2]?.priceDay || finalResult.powerCosts?.[2]?.price_euro_kw_day,
                        p4_power_price: finalResult.powerCosts?.[3]?.priceDay || finalResult.powerCosts?.[3]?.price_euro_kw_day,
                        p5_power_price: finalResult.powerCosts?.[4]?.priceDay || finalResult.powerCosts?.[4]?.price_euro_kw_day,
                        p6_power_price: finalResult.powerCosts?.[5]?.priceDay || finalResult.powerCosts?.[5]?.price_euro_kw_day,
                        p1_price: finalResult.energyCosts?.[0]?.price || finalResult.energyCosts?.[0]?.price_euro_kwh,
                        p2_price: finalResult.energyCosts?.[1]?.price || finalResult.energyCosts?.[1]?.price_euro_kwh,
                        p3_price: finalResult.energyCosts?.[2]?.price || finalResult.energyCosts?.[2]?.price_euro_kwh,
                        p4_price: finalResult.energyCosts?.[3]?.price || finalResult.energyCosts?.[3]?.price_euro_kwh,
                        p5_price: finalResult.energyCosts?.[4]?.price || finalResult.energyCosts?.[4]?.price_euro_kwh,
                        p6_price: finalResult.energyCosts?.[5]?.price || finalResult.energyCosts?.[5]?.price_euro_kwh
                    };
                }
                
                // Si es gas, agregar precios de gas (siempre, incluso si no hay offer)
                if (type === 'gas') {
                    const energiaTotal = finalResult.energia || finalResult.total_energia || 0;
                    const kwhTotal = parseFloat(data.kwh) || 1;
                    const precioEnergiaUnitario = kwhTotal > 0 ? energiaTotal / kwhTotal : (finalResult.p_fijo_1 || 0);
                    
                    offerData.p_fijo_diario = finalResult.termino_fijo_diario || finalResult.p_fijo_diario || 0;
                    offerData.p1_price = precioEnergiaUnitario; // Precio unitario de energÃ­a
                }
            }
            
            const supply = {
                type: type, // 'electricidad' o 'gas'
                cups: data.cups || 'N/A', // CUPS del suministro
                tariff: tariff,
                data: finalResult || data, // Usar finalResult si estÃ¡ disponible
                results: results,
                description: description,
                totalKwh: totalKwh,
                supplyAddress: supplyAddress, // NUEVA: DirecciÃ³n del suministro
                offer: offerData, // InformaciÃ³n de la oferta
                // CRÃTICO: Calcular totalAnnual desde el resultado correspondiente (DRK o Power Cup)
                totalAnnual: (results.drk.total_anual > 0) ? results.drk.total_anual : results.powercup.total_anual,
                // CRÃTICO: Guardar factura original para cÃ¡lculo de ahorro
                originalBillAnnual: data.originalBillAnnual || 0,
                timestamp: new Date().getTime()
            };
            
            // AÃ±adir breakdown especÃ­fico segÃºn el tipo - usar finalResult si estÃ¡ disponible
            if (type === 'electricidad') {
                supply.electricityBreakdown = {
                    energyCosts: finalResult?.energyCosts || [],
                    powerCosts: finalResult?.powerCosts || [],
                    subEnergy: finalResult?.subEnergyNet || 0,
                    subPower: finalResult?.subPower || 0,
                    subBase: finalResult?.subBase || 0,
                    costIE: finalResult?.costIE || 0,
                    baseImp: finalResult?.baseImp || 0,
                    costIVA: finalResult?.costIVA || 0,
                    totalPeriod: finalResult?.totalPeriod || 0,
                    totalAnnual: finalResult?.totalAnnual || supply.totalAnnual,
                    ahorro_mensual: (finalResult?.originalBillPeriod || 0) - (finalResult?.totalPeriod || 0),
                    ahorro_anual: (finalResult?.originalBillAnnual || data.originalBillAnnual || 0) - supply.totalAnnual,
                    totalKwh: totalKwh,
                    dias: data.dias || 30
                };
            } else {
                // Para gas, extraer correctamente los datos de finalResult
                const energiaTotal = finalResult?.energia || finalResult?.total_energia || 0;
                const kwhTotal = totalKwh || 1; // Evitar divisiÃ³n por 0
                const precioEnergiaUnitario = kwhTotal > 0 ? energiaTotal / kwhTotal : (finalResult?.p_fijo_1 || 0);
                
                supply.gasBreakdown = {
                    totalKwh: totalKwh,
                    kwh: totalKwh,
                    dias: data.dias || 30,
                    // Mapear correctamente los campos de gas
                    termino_fijo: finalResult?.termino_fijo || finalResult?.total_fijo || 0,
                    termino_fijo_diario: finalResult?.termino_fijo_diario || finalResult?.p_fijo_diario || 0,
                    precio_fijo_diario: finalResult?.termino_fijo_diario || finalResult?.p_fijo_diario || 0,
                    energia: energiaTotal,
                    precio_energia: precioEnergiaUnitario, // Calculado: total energÃ­a / kWh
                    impuesto_hidrocarburos: finalResult?.impuesto_hidrocarburos || 0,
                    subtotal: finalResult?.subtotal || 0,
                    iva: finalResult?.iva || 0,
                    total: finalResult?.total || 0,
                    total_anual: supply.totalAnnual,
                    ahorro_mensual: 0,
                    ahorro_anual: (data.originalBillAnnual || 0) - supply.totalAnnual,
                    // Agregar tambiÃ©n la oferta completa
                    offer: finalResult?.offer || {}
                };
            }
            
            console.log('Suministro a aÃ±adir:', supply);
            console.log('VerificaciÃ³n - DRK:', supply.results.drk.total_anual, 'PowerCup:', supply.results.powercup.total_anual);
            
            // AÃ±adir al array
            dualSupplies.push(supply);
            console.log('Total suministros:', dualSupplies.length);
            console.log('Array completo:', dualSupplies);
            
            // Limpiar finalResult pendiente
            window.pendingDualFinalResult = null;
            
            // Volver al gestor DUAL
            backToDualManager();
            
            // Mostrar mensaje de confirmaciÃ³n
            setTimeout(() => {
                const drkCost = supply.results.drk.total_anual;
                const pcCost = supply.results.powercup.total_anual;
                alert(`âœ… Suministro aÃ±adido correctamente\n\nTipo: ${type === 'electricidad' ? 'Electricidad' : 'Gas'}\nTarifa: ${tariff}\n${description}\n\nDRK anual: ${drkCost.toFixed(2)} â‚¬\nPowerCup anual: ${pcCost.toFixed(2)} â‚¬\n\nTotal: ${dualSupplies.length} suministro(s)`);
            }, 100);
        }
        
        // Permitir confirmar con Enter
        document.addEventListener('DOMContentLoaded', function() {
            const addressInput = document.getElementById('multicups-supply-address');
            if (addressInput) {
                addressInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        confirmAddressInput();
                    }
                });
            }
        });
        
        function cleanupPasteCatcher() {
            const pasteCatcher = document.getElementById('paste-catcher');
            pasteCatcher.classList.remove('pasting-active');
            pasteCatcher.blur();  
            pasteCatcher.style.width = '0';
            pasteCatcher.style.height = '0';
            pasteCatcher.style.zIndex = '-1';
            pasteCatcher.style.pointerEvents = 'none';
            pasteCatcher.value = '';  
        }

        function showPasteModal(onCancel) {
            const pasteCatcher = document.getElementById('paste-catcher');
            
            // 1. Activar el campo de pegado
            pasteCatcher.classList.add('pasting-active');
            
            // Intentar asegurar el foco despuÃ©s de un breve momento para mayor fiabilidad.
            setTimeout(() => {
                pasteCatcher.focus();
            }, 50);
            
            // 2. Establecer contenido del modal
            setModalContent(tr("Con el cuadro de texto invisible enfocado, pulse Ctrl+V (o Cmd+V) para pegar la imagen de la factura."), tr("Esperando Pegado (Ctrl+V)"), false);

            // 3. Configurar el botÃ³n de Cancelar dinÃ¡micamente
            let secondaryBtn = document.getElementById('secondary-action-btn');
            secondaryBtn.textContent = tr("Cancelar Pegado");
            secondaryBtn.onclick = () => { onCancel(); hideErrorModal(); };
            secondaryBtn.classList.remove('hidden');
            
            // 4. Configurar botÃ³n principal para que tambiÃ©n cancele
            const mainButton = document.querySelector('#error-modal button:not(#secondary-action-btn)');
            mainButton.textContent = tr("Continuar Pegando");  
            mainButton.onclick = () => { hideErrorModal(); };
        }
        
        function setupPasteCatcher() {
            const pasteCatcher = document.getElementById('paste-catcher');
            const modalPasteBtn = document.getElementById('modal-paste-image-btn');
            
            modalPasteBtn.addEventListener('click', () => {
                document.getElementById('qr-options-modal').classList.add('hidden');
                document.getElementById('qr-options-modal').classList.remove('flex');
                showPasteModal(cleanupPasteCatcher);
            });

            pasteCatcher.addEventListener('paste', (e) => {
                e.preventDefault();
                hideErrorModal();
                cleanupPasteCatcher();
                
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                let imageFound = false;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        const file = items[i].getAsFile();
                        if (file) {
                            decodeQRFromImage(file);
                            imageFound = true;
                            break;
                        }
                    }
                }
                
                if (!imageFound) window.showErrorModal("No se detectÃ³ ninguna imagen en el portapapeles.");
            });
        }
        
        // FunciÃ³n para aplicar estilos de marca
        function applyBrandStyles(brand) {
            activeBrand = brand;
            const isDrk = brand.NAME.includes('DRK');
            
            const accent500 = isDrk ? 'drk-500' : 'powercup-500';
            const bg50 = isDrk ? 'bg-drk-50' : 'bg-powercup-50';
            const text800 = isDrk ? 'text-drk-800' : 'text-powercup-800';
            const borderColor = isDrk ? 'border-drk-500' : 'border-powercup-500';
            
            // --- CORE BRAND SWITCH (BODY CLASS) ---
            document.body.classList.toggle('powercup-active', !isDrk);
            document.body.classList.toggle('drk-active', isDrk);

            // 1. NAVBAR
            document.getElementById('app-logo-main').textContent = isDrk ? 'DRK' : 'POWER';
            document.getElementById('app-logo-accent').textContent = brand.ACCENT_TEXT;
            document.getElementById('app-logo-accent').className = `text-${brand.ACCENT}`;

            document.getElementById('navbar').className = `w-full ${brand.NAV_BG} text-white p-4 shadow-md sticky top-0 z-50 transition-colors duration-300`;
            document.getElementById('app-subtitle').className = `text-xs ${brand.NAV_SUBTITLE_BG} px-2 py-1 rounded ${brand.NAV_SUBTITLE_TEXT}`;

            // 2. LANDING PAGE CONTENT
            document.getElementById('landing-title').textContent = brand.TITLE; // Set main title in CAPS
            document.getElementById('landing-icon-bg').className = `w-16 h-16 ${bg50} rounded-full flex items-center justify-center mx-auto mb-4 ${text800} shadow-inner`;
            document.getElementById('landing-icon-bg').innerHTML = brand.LOGO_SVG; // Set main logo

            // 3. INITIAL VIEW ICON (Used when user proceeds to scan view)
            document.getElementById('initial-icon-bg').className = `w-16 h-16 ${bg50} rounded-full flex items-center justify-center mx-auto mb-4 ${text800} shadow-inner`;
            document.getElementById('initial-icon-bg').innerHTML = brand.LOGO_SVG;
            // Also apply to Saga View
            const sagaIcon = document.getElementById('initial-icon-bg-saga');
            if (sagaIcon) {
                sagaIcon.className = `w-16 h-16 ${bg50} rounded-full flex items-center justify-center mx-auto mb-4 ${text800} shadow-inner`;
                sagaIcon.innerHTML = brand.LOGO_SVG;
            }
            
            // 4. MAIN ACTION BUTTONS (Scanner/Input View)
            const primaryButtonClass = `w-full bg-gradient-to-r ${brand.PRIMARY_BUTTON} text-white font-bold py-4 px-6 rounded-2xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mb-3`;
            const startScanBtn = document.getElementById('start-scan-btn');
            if (startScanBtn) startScanBtn.className = primaryButtonClass; // Apply to scan button if visible

            const secondaryButtonBase = `w-full ${brand.SECONDARY_BUTTON_BG} ${isDrk ? 'hover:bg-drk-100' : 'hover:bg-powercup-100'} ${brand.SECONDARY_BUTTON_TEXT} font-bold py-3 px-6 rounded-xl shadow-sm transform transition active:scale-95 flex items-center justify-center gap-3`;
            const uploadMenuBtn = document.getElementById('upload-menu-btn');
            if (uploadMenuBtn) uploadMenuBtn.className = secondaryButtonBase; // Apply to upload button if visible
            
            // Apply unique style to Manual Input button
            const manualInputBtn = document.getElementById('manual-input-btn');
            if (manualInputBtn) {
                // Remove all previous style classes related to color/bg/hover
                manualInputBtn.className = manualInputBtn.className.split(' ').filter(c => 
                    !c.startsWith('bg-') && !c.startsWith('hover:bg-') && !c.startsWith('text-') && !c.includes('from-') && !c.includes('to-')
                ).join(' ');
                
                // If QR is hidden (3.0TD individual flow), use the Primary style for manual input
                const isManualPrimary = !isDrk && currentTariffType !== 'MULTICUPS' && !TARIFF_CONFIG[currentTariffType]?.requiresQR;
                
                if (isManualPrimary) {
                    manualInputBtn.classList.add('w-full', 'text-white', 'font-bold', 'py-4', 'px-6', 'rounded-2xl', 'shadow-lg', 'transform', 'transition', 'active:scale-95', 'flex', 'items-center', 'justify-center', 'gap-3');
                    // AÃ±adir clases de gradiente por separado
                    const gradientClasses = isDrk 
                        ? ['bg-gradient-to-r', 'from-drk-600', 'to-drk-800', 'hover:from-drk-700', 'hover:to-drk-900']
                        : ['bg-gradient-to-r', 'from-powercup-600', 'to-powercup-800', 'hover:from-powercup-500', 'hover:to-powercup-900'];
                    manualInputBtn.classList.add(...gradientClasses);
                } else { // DRK active, MULTICUPS, or 2.0TD flow (uses secondary style)
                    manualInputBtn.classList.add('w-full', 'font-bold', 'py-3', 'px-6', 'rounded-xl', 'shadow-sm', 'transform', 'transition', 'active:scale-95', ...brand.SECONDARY_BUTTON_BG.split(' '), ...brand.SECONDARY_BUTTON_TEXT.split(' '));
                }

                // Re-add mt-3 if QR buttons are visible
                if (!document.getElementById('qr-buttons-container')?.classList.contains('hidden')) {
                    manualInputBtn.classList.add('mt-3');
                } else {
                    manualInputBtn.classList.remove('mt-3');
                }
            }
            
            const focusColorClass = isDrk ? 'focus:border-drk-500' : 'focus:border-powercup-500';  
            const calcBtnBg = isDrk ? 'bg-drk-500 hover:bg-drk-600' : 'bg-powercup-500 hover:bg-powercup-600';
            
            // 5. MANUAL INPUT MODAL STYLES
            const manualModal = document.getElementById('manual-input-modal');
            manualModal.querySelector('h3#manual-modal-title').className = `text-xl font-bold ${text800} mb-4`;
            manualModal.querySelectorAll('input[type="text"], input[type="number"], select').forEach(input => {
                input.classList.remove('focus:border-drk-500', 'focus:border-powercup-500');
                input.classList.add(focusColorClass);
            });
            manualModal.querySelector('#execute-manual-input-btn').className = `w-full text-white font-bold py-3 rounded-xl shadow-md mb-3 ${calcBtnBg}`;

            // 6. QR OPTIONS MODAL STYLES (Modal 8)
            const qrOptionsModal = document.getElementById('qr-options-modal');
            qrOptionsModal.querySelector('h3#modal-qr-title').className = `text-xl font-bold ${text800} mb-4`;

            const uploadBtn = document.getElementById('modal-upload-file-btn');
            const pasteBtn = document.getElementById('modal-paste-image-btn');
            
            if (uploadBtn) {
                uploadBtn.className = `w-full text-white font-bold py-3 px-6 rounded-xl shadow-md mb-3 transform transition active:scale-95 ${isDrk ? 'bg-drk-800 hover:bg-drk-900' : 'bg-powercup-800 hover:bg-powercup-900'}`;
            }

            if (pasteBtn) {
                pasteBtn.className = `w-full text-white font-bold py-3 px-6 rounded-xl shadow-md mb-4 transform transition active:scale-95 ${isDrk ? 'bg-drk-600 hover:bg-drk-800' : 'bg-powercup-600 hover:bg-powercup-800'}`;
            }

            // 7. QR CONFIRM MODAL STYLES (Modal 7)
            const qrConfirmModal = document.getElementById('qr-confirm-modal');
            qrConfirmModal.querySelector('h3').className = `text-xl font-bold ${text800} mb-2`;
            qrConfirmModal.querySelector('#confirm-save-supply-btn').className = `w-full text-white font-bold py-3 rounded-xl shadow-md mb-3 ${calcBtnBg}`;

            // 8. SCANNER VIEW
            document.getElementById('scanner-guide').classList.remove('border-drk-500', 'border-powercup-500');
            document.getElementById('scanner-guide').classList.add(borderColor);
            
            const captureBtn = document.getElementById('capture-photo-btn');
            if (captureBtn) {
                captureBtn.classList.remove('border-drk-500', 'text-drk-800', 'border-powercup-500', 'text-powercup-800');
                captureBtn.classList.add('border-2', 'bg-white', borderColor, text800);
            }

            document.getElementById('paste-catcher').style.setProperty('--qr-border-color', brand.QR_BORDER_COLOR);


            // 9. Result Header Gradient & Card Borders
            document.getElementById('result-header').className = `bg-gradient-to-r ${brand.PRIMARY_BG_GRADIENT} p-6 text-white text-center relative overflow-hidden`;
            document.getElementById('initial-card').className = `bg-white p-6 rounded-3xl shadow-xl text-center border-t-4 ${borderColor} relative`;
            document.getElementById('landing-card').className = `bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 ${borderColor}`;
            
            const sagaCard = document.getElementById('multicups-saga-card');
            if (sagaCard) sagaCard.className = `bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 ${borderColor} relative`;

            // 10. TARIFF BADGE COLOR (In Initial View)
            const tariffBadge = document.getElementById('tariff-badge');
            tariffBadge.classList.remove('bg-drk-500', 'bg-powercup-500');  
            tariffBadge.classList.add(`bg-${accent500}`);

            // 11. Landing Page Tariff Buttons 
            document.querySelectorAll('.tariff-select-btn').forEach(btn => {
                const iconWrapper = btn.querySelector('.icon-wrapper');
                const arrowIcon = btn.querySelector('.arrow-icon');
                
                // Limpiar clases de color
                iconWrapper.className = iconWrapper.className.split(' ').filter(c => !c.startsWith('bg-') && !c.startsWith('text-') && !c.startsWith('group-hover')).join(' ');
                arrowIcon.classList.remove('group-hover:text-drk-500', 'group-hover:text-powercup-500');
                btn.classList.remove('border-drk-300', 'hover:border-drk-500', 'border-powercup-300', 'hover:border-powercup-500');

                if (isDrk) {
                    iconWrapper.classList.add('bg-drk-50', 'group-hover:bg-drk-100', 'text-drk-600');
                    arrowIcon.classList.add('group-hover:text-drk-500');
                    btn.classList.add('border-drk-300', 'hover:border-drk-500');
                } else {
                    iconWrapper.classList.add('bg-powercup-50', 'group-hover:bg-powercup-100', 'text-powercup-600');
                    arrowIcon.classList.add('group-hover:text-powercup-500');
                    btn.classList.add('border-powercup-300', 'hover:border-powercup-500');
                }
            });
        }
        
        // --- FUNCIONES DE LIMPIEZA ---

        function clearManualInputs(prefix = 'input') {
            document.getElementById(`${prefix}-cups`).value = '';
            document.getElementById(`${prefix}-billing-days`).value = '';
            document.getElementById(`${prefix}-total-bill`).value = '';
            for (let i = 1; i <= 6; i++) {
                const pInput = document.getElementById(`${prefix}-p${i}-kw`);
                if (pInput) pInput.value = '';
                const eInput = document.getElementById(`${prefix}-e${i}-kwh`);
                if (eInput) eInput.value = '';
            }
        }
        
        function closeManualInputModal() {
            document.getElementById('manual-input-modal').classList.add('hidden');
            document.getElementById('manual-input-modal').classList.remove('flex');
            // Si estÃ¡bamos en modo MultiCups, volvemos al selector 2.0/3.0
            if (currentTariffType === 'MULTICUPS') {
                showMultiCupsSagaView();
            }
        }

        // FUNCIÃ“N GLOBAL: Hacer accesible desde onclick en HTML
        window.resetToLanding = function() {
            console.log('resetToLanding llamada');
            stopScanner();
            
            // PRIMERO: Ocultar TODAS las pantallas antes de cualquier otra operaciÃ³n
            hideAllScreens();
            console.log('âœ… Todas las pantallas ocultadas con hideAllScreens()');
            
            // CRÃTICO: Limpiar TODAS las variables globales
            lastComparisonResult = null;
            lastIndexedResult = null;
            multiCupsData = [];
            multiCupsAddType = null;
            availableOffers = [];
            manuallySelectedOffer = null;
            compareWithIndexed = false;
            bestOptionTariffChoice = 'fija';
            currentTariffType = null; // NUEVO: Resetear tipo de tarifa
            window.lastGasComparisonResult = null; // NUEVO: Resetear datos de GAS
            window.dualGlobalResults = null; // NUEVO: Resetear datos DUAL
            
            // DUAL: Limpiar variables DUAL
            window.dualMode = false;
            window.dualSupplies = [];
            dualSupplies = window.dualSupplies; // Mantener referencia
            window.dualGlobalResults = null;
            dualTempSupply = null;
            console.log('âœ… Variables DUAL limpiadas');
            
            // Resetear checkbox de comparaciÃ³n indexada
            const checkboxIndexed = document.getElementById('compare-indexed-checkbox');
            if (checkboxIndexed) {
                checkboxIndexed.checked = false;
            }
            
            // Resetear selector de tipo de tarifa
            const fijaRadio = document.querySelector('input[name="best-option-tariff-type"][value="fija"]');
            if (fijaRadio) {
                fijaRadio.checked = true;
            }
            
            // Restaurar la marca activa segÃºn el modo de comparaciÃ³n
            const brandToApply = comparisonMode === 'overall_best' ? BRANDS.POWER_CUP : BRANDS.DRK;
            applyBrandStyles(brandToApply);  
            
            // Asegurarse de que el radio button correcto estÃ© checked
            const selectorInput = document.querySelector(`input[name="comparison_mode"][value="${comparisonMode}"]`);
            if (selectorInput) {
                selectorInput.checked = true;
                updateComparisonMode(comparisonMode);
            }

            // Ocultar vistas adicionales del flujo normal
            document.getElementById('initial-view')?.classList.add('hidden');
            document.getElementById('multicups-saga-view')?.classList.add('hidden');
            document.getElementById('results-view')?.classList.add('hidden');
            document.getElementById('scanner-view')?.classList.add('hidden');
            document.getElementById('manual-input-modal')?.classList.add('hidden');
            document.getElementById('manual-input-modal')?.classList.remove('flex');
            document.getElementById('multicups-finalize-btn-main')?.classList.add('hidden');
            document.getElementById('manual-tariff-selector-wrapper')?.classList.add('hidden');
            
            // IMPORTANTE: Mostrar landing-view para que estÃ© visible al volver a Electricidad/Gas
            document.getElementById('landing-view')?.classList.remove('hidden');
            
            document.querySelectorAll('.hidden-period').forEach(el => el.style.display = 'none');
            document.getElementById('tariff-display-badge').textContent = '0';
            
            // FINALMENTE: Mostrar pantalla inicial y selector de modo
            document.getElementById('screen-inicio')?.classList.add('active');
            const modoComparacionSection = document.getElementById('modo-comparacion-section');
            if (modoComparacionSection) {
                modoComparacionSection.style.display = 'block';
            }
            
            console.log('âœ… resetToLanding completada - screen-inicio activa');
        };
        
        // NUEVA FUNCIÃ“N: Volver desde initial-view SIN hacer reset completo
        window.goBackFromInitialView = function() {
            console.log('ðŸ”™ goBackFromInitialView llamada');
            stopScanner();
            
            // Solo ocultar initial-view
            document.getElementById('initial-view')?.classList.add('hidden');
            
            // Mostrar la pantalla de selecciÃ³n de tarifa (landing-view)
            document.getElementById('landing-view')?.classList.remove('hidden');
            
            console.log('âœ… Vuelto a landing-view sin resetear');
        };
        
        // NUEVA FUNCIÃ“N: Volver desde multicups-saga-view SIN hacer reset completo
        window.goBackFromMultiCupsSagaView = function() {
            console.log('ðŸ”™ goBackFromMultiCupsSagaView llamada');
            
            // Solo ocultar multicups-saga-view
            document.getElementById('multicups-saga-view')?.classList.add('hidden');
            
            // Mostrar la pantalla de selecciÃ³n de tarifa (landing-view)
            document.getElementById('landing-view')?.classList.remove('hidden');
            
            console.log('âœ… Vuelto a landing-view desde MultiCups');
        };

        function toggleMultiCupsInputPeriods(tariffType, prefix = 'input') {
            // Eliminamos la referencia a 6.1TD en la comprobaciÃ³n
            const isHighVoltage = tariffType === '3.0TD';
            const periods = document.querySelectorAll(`[id^="${prefix}-p3-kw"], [id^="${prefix}-p4-kw"], [id^="${prefix}-p5-kw"], [id^="${prefix}-p6-kw"], [id^="${prefix}-e4-kwh"], [id^="${prefix}-e5-kwh"], [id^="${prefix}-e6-kwh"]`);
            
            periods.forEach(el => {
                el.style.display = isHighVoltage ? 'block' : 'none';
            });
            // Ocultar/Mostrar campos de E1/E2/E3
            document.getElementById('input-e1-kwh').placeholder = isHighVoltage ? 'E1' : `E1 (${tr('Punta')})`;
            document.getElementById('input-e2-kwh').placeholder = isHighVoltage ? 'E2' : `E2 (${tr('Llano')})`;
            document.getElementById('input-e3-kwh').placeholder = isHighVoltage ? 'E3' : `E3 (${tr('Valle')})`;
            
            // NUEVO: Mostrar/Ocultar el toggle de potencias optimizadas solo para 3.0TD
            // IMPORTANTE: NO mostrar en modo MULTICUPS ni en modo DUAL
            const isMultiCupsMode = currentTariffType === 'MULTICUPS';
            const isDualMode = window.dualMode === true;
            const optimizedToggleWrapper = document.getElementById('optimized-power-toggle-wrapper');
            if (optimizedToggleWrapper) {
                // Solo mostrar si es 3.0TD Y NO estamos en MULTICUPS Y NO estamos en DUAL
                optimizedToggleWrapper.classList.toggle('hidden', !isHighVoltage || isMultiCupsMode || isDualMode);
            }
            
            // NUEVO: Mostrar/Ocultar periodos optimizados segÃºn tipo de tarifa
            if (isHighVoltage) {
                const periodsOpt = document.querySelectorAll('.hidden-period-opt');
                periodsOpt.forEach(el => {
                    el.style.display = 'block';
                });
            }
        }

        // NUEVA FUNCIÃ“N: Toggle de campos de potencias optimizadas
        function toggleOptimizedPowerFields() {
            const checkbox = document.getElementById('enable-optimized-power');
            const fieldsContainer = document.getElementById('optimized-power-fields');
            const presentationSelector = document.getElementById('optimized-presentation-mode-selector');
            
            if (checkbox.checked) {
                fieldsContainer.classList.remove('hidden');
                // Guardar el estado para usarlo en la generaciÃ³n del comparativo
                window.optimizedPowerEnabled = true;
                
                // Mostrar el selector de modo de presentaciÃ³n en el modal de datos del comercial
                if (presentationSelector) {
                    presentationSelector.classList.remove('hidden');
                }
            } else {
                fieldsContainer.classList.add('hidden');
                window.optimizedPowerEnabled = false;
                
                // Ocultar el selector de modo de presentaciÃ³n
                if (presentationSelector) {
                    presentationSelector.classList.add('hidden');
                }
            }
        }

        // NUEVA FUNCIÃ“N: Obtener datos de potencias optimizadas
        function getOptimizedPowerData() {
            if (!window.optimizedPowerEnabled) {
                return null;
            }
            
            return {
                p1: parseFloat(document.getElementById('input-p1-opt-kw').value) || 0,
                p2: parseFloat(document.getElementById('input-p2-opt-kw').value) || 0,
                p3: parseFloat(document.getElementById('input-p3-opt-kw').value) || 0,
                p4: parseFloat(document.getElementById('input-p4-opt-kw').value) || 0,
                p5: parseFloat(document.getElementById('input-p5-opt-kw').value) || 0,
                p6: parseFloat(document.getElementById('input-p6-opt-kw').value) || 0
            };
        }

        // NUEVA FUNCIÃ“N: Obtener modo de presentaciÃ³n seleccionado
        function getPresentationMode() {
            const modeRadio = document.querySelector('input[name="presentation-mode"]:checked');
            return modeRadio ? modeRadio.value : 'two-columns';
        }

        // NUEVA FUNCIÃ“N: Comparar ofertas con potencias actuales vs optimizadas
        function compareOffersDualPower(dataActual, dataOptimized) {
            try {
                console.log('=== COMPARACIÃ“N DUAL DE POTENCIAS INICIADA ===');
                console.log('Escenario 1 - Potencias actuales:', dataActual);
                console.log('Escenario 2 - Potencias optimizadas:', dataOptimized);
                
                const tariffType = currentTariffType;
                const tariffsToCompare = currentTariffs[tariffType] || [];
                
                if (tariffsToCompare.length === 0) {
                    return window.showErrorModal(`Las tarifas ${tariffType} no estÃ¡n cargadas.`);
                }
                
                // Calcular costes para ambos escenarios
                const resultsActual = tariffsToCompare.map(t => calculateTariffCost(t, dataActual, tariffType));
                const resultsOptimized = tariffsToCompare.map(t => calculateTariffCost(t, dataOptimized, tariffType));
                
                console.log('Resultados potencias actuales:', resultsActual.length);
                console.log('Resultados potencias optimizadas:', resultsOptimized.length);
                
                // Encontrar mejores ofertas para cada escenario
                let bestActual = null;
                let bestOptimized = null;
                let bestDrkActual = null;
                let bestDrkOptimized = null;
                
                resultsActual.forEach(r => {
                    const annualCost = r.totalAnnual;
                    if (!bestActual || annualCost < bestActual.totalAnnual) {
                        bestActual = r;
                    }
                    if (r.offer.isDrk && r.offer.name !== 'Tu Tarifa Actual') {
                        if (!bestDrkActual || annualCost < bestDrkActual.totalAnnual) {
                            bestDrkActual = r;
                        }
                    }
                });
                
                resultsOptimized.forEach(r => {
                    const annualCost = r.totalAnnual;
                    if (!bestOptimized || annualCost < bestOptimized.totalAnnual) {
                        bestOptimized = r;
                    }
                    if (r.offer.isDrk && r.offer.name !== 'Tu Tarifa Actual') {
                        if (!bestDrkOptimized || annualCost < bestDrkOptimized.totalAnnual) {
                            bestDrkOptimized = r;
                        }
                    }
                });
                
                // NUEVO: Guardar TODAS las ofertas calculando ahorro TOTAL (actuales + optimizaciÃ³n)
                availableOffers = resultsOptimized.map((rOpt, index) => {
                    const rActual = resultsActual[index]; // Resultado con potencias actuales
                    
                    // Calcular ahorros individuales
                    rActual.savings = rActual.originalBillAnnual - rActual.totalAnnual;
                    rOpt.savings = rOpt.originalBillAnnual - rOpt.totalAnnual;
                    
                    // Calcular ahorro adicional por optimizaciÃ³n
                    const ahorroAdicional = rActual.totalAnnual - rOpt.totalAnnual;
                    
                    // Calcular ahorro TOTAL (ahorro con potencias actuales + ahorro adicional optimizando)
                    const ahorroTotal = rActual.savings + ahorroAdicional;
                    
                    // Guardar informaciÃ³n adicional en el objeto
                    rOpt.savingsActual = rActual.savings; // Ahorro solo con potencias actuales
                    rOpt.savingsOptimized = rOpt.savings; // Ahorro con potencias optimizadas
                    rOpt.ahorroAdicional = ahorroAdicional; // Ahorro adicional por optimizar
                    rOpt.ahorroTotal = ahorroTotal; // Ahorro total
                    
                    return rOpt;
                }).filter(r => {
                    // Filtrar por ahorro TOTAL positivo (no solo por ahorro con optimizaciÃ³n)
                    const hasPositiveTotalSavings = r.ahorroTotal > 0;
                    
                    if (comparisonMode === 'drk_only') {
                        return hasPositiveTotalSavings && r.offer.isDrk;
                    }
                    
                    return hasPositiveTotalSavings;
                });
                
                console.log('Available offers with savings (filtered by mode):', availableOffers.length);
                
                // Aplicar lÃ³gica de selecciÃ³n segÃºn modo de comparaciÃ³n SOLO PARA LA MEJOR
                let finalActual = bestActual;
                let finalOptimized = bestOptimized;
                let brand = activeBrand;
                
                if (comparisonMode === 'overall_best') {
                    finalActual = bestActual;
                    finalOptimized = bestOptimized;
                    brand = finalOptimized.offer.isDrk ? BRANDS.DRK : BRANDS.POWER_CUP;
                } else if (comparisonMode === 'drk_only') {
                    // DRK ÃšNICAMENTE: SIEMPRE usar DRK, nunca fallback a otras comercializadoras
                    finalActual = bestDrkActual || bestActual;
                    finalOptimized = bestDrkOptimized || bestOptimized;
                    
                    // Si no hay DRK con ahorro, marcar para solicitar mejora
                    if (!bestDrkActual || bestDrkActual.totalAnnual >= bestDrkActual.originalBillAnnual) {
                        if (finalActual) finalActual.needsImprovementRequest = true;
                    }
                    if (!bestDrkOptimized || bestDrkOptimized.totalAnnual >= bestDrkOptimized.originalBillAnnual) {
                        if (finalOptimized) finalOptimized.needsImprovementRequest = true;
                    }
                    
                    brand = BRANDS.DRK;
                } else if (comparisonMode === 'drk_prioritized') {
                    finalActual = (bestDrkActual && bestDrkActual.totalAnnual < bestDrkActual.originalBillAnnual) ? bestDrkActual : bestActual;
                    finalOptimized = (bestDrkOptimized && bestDrkOptimized.totalAnnual < bestDrkOptimized.originalBillAnnual) ? bestDrkOptimized : bestOptimized;
                    brand = finalOptimized.offer.isDrk ? BRANDS.DRK : BRANDS.POWER_CUP;
                }
                
                // Calcular ahorros
                finalActual.savings = finalActual.originalBillAnnual - finalActual.totalAnnual;
                finalOptimized.savings = finalOptimized.originalBillAnnual - finalOptimized.totalAnnual;
                
                // AÃ±adir tipo de tarifa original
                finalActual.originalTariffType = tariffType;
                finalOptimized.originalTariffType = tariffType;
                
                // Guardar resultados en variables globales
                window.dualPowerResultActual = finalActual;
                window.dualPowerResultOptimized = finalOptimized;
                window.dualPowerBrand = brand;
                window.dualPowerAllResultsActual = resultsActual;
                window.dualPowerAllResultsOptimized = resultsOptimized;
                
                // CRÃTICO: Guardar comparaciÃ³n dual ANTES del modal
                window.lastDualPowerComparison = {
                    actual: finalActual,
                    optimized: finalOptimized,
                    brand: brand,
                    mode: getPresentationMode()
                };
                
                console.log('Mejor oferta con potencias actuales:', finalActual.offer.name, finalActual.totalAnnual, 'â‚¬/aÃ±o');
                console.log('Mejor oferta con potencias optimizadas:', finalOptimized.offer.name, finalOptimized.totalAnnual, 'â‚¬/aÃ±o');
                console.log('Ahorro adicional por optimizaciÃ³n:', (finalActual.totalAnnual - finalOptimized.totalAnnual).toFixed(2), 'â‚¬/aÃ±o');
                
                // Aplicar branding
                applyBrandStyles(brand);
                
                // Guardar el mejor resultado temporalmente para compatibilidad
                lastComparisonResult = finalOptimized;
                lastComparisonResult.isMulti = false;
                
                // NUEVO: Si hay mÃºltiples ofertas con ahorro, mostrar modal de decisiÃ³n
                // (igual que el flujo normal)
                if (availableOffers.length > 1) {
                    console.log('Mostrando modal de decisiÃ³n con', availableOffers.length, 'ofertas');
                    showOfferDecisionModal();
                    return; // No renderizar resultados todavÃ­a
                }
                
                // Si solo hay 1 oferta o ninguna, renderizar directamente
                console.log('Renderizando resultados directamente (1 o 0 ofertas)');
                renderDualPowerResultsUI(finalActual, finalOptimized, brand);
                
                // Mostrar vista de resultados
                document.getElementById('initial-view').classList.add('hidden');
                document.getElementById('scanner-view').classList.add('hidden');
                document.getElementById('results-view').classList.remove('hidden');
                
                console.log('=== COMPARACIÃ“N DUAL COMPLETADA ===');
                
            } catch (error) {
                console.error('Error en compareOffersDualPower:', error);
                window.showErrorModal(`Error al comparar potencias: ${error.message}`);
            }
        }

        // NUEVA FUNCIÃ“N: Renderizar UI con comparaciÃ³n dual de potencias
        function renderDualPowerResultsUI(resActual, resOptimized, brand) {
            try {
                console.log('ðŸ”¥ðŸ”¥ðŸ”¥ renderDualPowerResultsUI INICIADO ðŸ”¥ðŸ”¥ðŸ”¥');
                console.log('Renderizando UI de comparaciÃ³n dual de potencias');
                console.log('Potencias Actuales - Ahorro:', resActual.savings);
                console.log('Potencias Optimizadas - Ahorro:', resOptimized.savings);
                
                // Guardar en variables globales para acceso posterior SOLO si no existe
                if (!window.lastDualPowerComparison) {
                    window.lastDualPowerComparison = {
                        actual: resActual,
                        optimized: resOptimized,
                        brand: brand,
                        mode: getPresentationMode()
                    };
                    console.log('âœ… window.lastDualPowerComparison creado');
                } else {
                    console.log('â„¹ï¸ window.lastDualPowerComparison ya existÃ­a, preservando');
                }
                
                // IMPORTANTE: Guardar tambiÃ©n en lastComparisonResult para compatibilidad
                lastComparisonResult = resOptimized;
                lastIndexedResult = null; // No es comparativa Fijo vs Indexado
                
                const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
                const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
                
                // CRÃTICO: Colores dinÃ¡micos segÃºn marca
                const isDrk = brand.NAME.includes('DRK');
                const brandPrefix = isDrk ? 'drk' : 'powercup';
                
                console.log('ðŸŽ¨ Marca detectada:', brand.NAME, '| isDrk:', isDrk, '| Prefix:', brandPrefix);
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // BOTÃ“N ROJO DE VOLVER (RECARGA PÃGINA)
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                let backButtonContainer = document.getElementById('back-button-top-container');
                if (!backButtonContainer) {
                    backButtonContainer = document.createElement('div');
                    backButtonContainer.id = 'back-button-top-container';
                    backButtonContainer.className = 'fixed top-0 left-0 right-0 z-[100] bg-white shadow-lg p-3 border-b-4 border-red-500';
                    backButtonContainer.innerHTML = `
                        <div class="max-w-lg mx-auto">
                            <button id="force-back-button" class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-black py-4 px-6 rounded-xl shadow-2xl transform transition active:scale-95 flex items-center justify-center gap-3 text-lg">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                </svg>
                                <span>â¬…ï¸ VOLVER AL INICIO</span>
                            </button>
                        </div>
                    `;
                    document.body.insertBefore(backButtonContainer, document.body.firstChild);
                    
                    document.getElementById('force-back-button').addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('ðŸ”„ RECARGANDO PÃGINA...');
                        window.location.reload();
                    });
                }
                backButtonContainer.style.display = 'block';
                
                const resultsView = document.getElementById('results-view');
                if (resultsView) {
                    resultsView.style.paddingTop = '80px';
                }
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                
                // Banner de empresa con badge de optimizaciÃ³n
                const companyBanner = document.getElementById('company-banner');
                
                if (isDrk) {
                    companyBanner.innerHTML = `
                        <div class="bg-gradient-to-r from-drk-900 via-drk-800 to-drk-700 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                            <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                                <div class="transform scale-125">
                                    ${brand.LOGO_SVG}
                                </div>
                                <div class="text-center md:text-left">
                                    <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">${brand.FULL_NAME}</h1>
                                    <p class="text-drk-100 text-lg md:text-xl font-semibold">${tr('Liderando el ahorro y la eficiencia energÃ©tica')}</p>
                                </div>
                            </div>
                            <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                                <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">ðŸ“Š ESTUDIO DE AHORRO</p>
                                <p class="text-drk-100 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                                <p class="text-drk-100 text-base md:text-lg font-bold">${tr("PROFESIONAL")}</p>
                            </div>
                        </div>
                        <div class="mt-4 bg-gradient-to-r from-amber-500 to-orange-600 text-white px-4 py-3 rounded-lg text-sm font-bold text-center shadow-lg">
                            âš¡ COMPARATIVO: POTENCIAS ACTUALES vs POTENCIAS OPTIMIZADAS
                        </div>
                    `;
                } else {
                    companyBanner.innerHTML = `
                        <div class="bg-gradient-to-r from-powercup-700 via-powercup-600 to-powercup-500 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                            <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                                <div class="transform scale-125">
                                    ${brand.LOGO_SVG}
                                </div>
                                <div class="text-center md:text-left">
                                    <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">${brand.FULL_NAME}</h1>
                                    <p class="text-powercup-50 text-lg md:text-xl font-semibold">AsesorÃ­a EnergÃ©tica</p>
                                </div>
                            </div>
                            <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                                <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">ðŸ“Š ESTUDIO DE AHORRO</p>
                                <p class="text-powercup-50 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                                <p class="text-powercup-50 text-base md:text-lg font-bold">${tr("PROFESIONAL")}</p>
                            </div>
                        </div>
                        <div class="mt-4 bg-gradient-to-r from-amber-500 to-orange-600 text-white px-4 py-3 rounded-lg text-sm font-bold text-center shadow-lg">
                            âš¡ COMPARATIVO: POTENCIAS ACTUALES vs POTENCIAS OPTIMIZADAS
                        </div>
                    `;
                }
                
                // CUPS
                document.getElementById('results-cups-list').innerHTML = `
                    CUPS: <span class="font-mono text-slate-700">${resActual.cups}</span>
                `;
                
                // Vista con TRES COLUMNAS (Factura Actual + Potencias Actuales + Potencias Optimizadas)
                const resultCard = document.getElementById('result-card');
                resultCard.innerHTML = `
                    <div class="p-4">
                        <!-- TRES COLUMNAS -->
                        <div class="grid grid-cols-3 gap-3 mb-6">
                            <!-- COLUMNA 1: TU FACTURA ACTUAL -->
                            <div class="text-center">
                                <div class="bg-slate-600 text-white py-2 px-2 rounded-t-lg">
                                    <p class="text-xs font-bold uppercase">${tr("TU FACTURA ACTUAL")}</p>
                                </div>
                                <div class="bg-white border-2 border-slate-300 rounded-b-lg p-3">
                                    <p class="text-2xl font-black text-red-600 line-through mb-2">${eur(resActual.originalBillPeriod || resActual.importe_total)}</p>
                                    <p class="text-xs text-slate-500 mb-3">${tr('Total Periodo')} (${resActual.dias_facturados || 0} ${tr('dÃ­as')})</p>
                                    <p class="text-2xl font-black text-red-600 line-through">${eur(resActual.originalBillAnnual)}</p>
                                    <p class="text-xs text-slate-500 mt-1">${tr("/aÃ±o")}</p>
                                </div>
                            </div>
                            
                            <!-- COLUMNA 2: CON POTENCIAS ACTUALES (Color de marca) -->
                            <div class="text-center">
                                <div class="${isDrk ? 'bg-drk-600' : 'bg-powercup-600'} text-white py-2 px-2 rounded-t-lg">
                                    <p class="text-xs font-bold uppercase">${tr("TU AHORRO ANUAL")}</p>
                                </div>
                                <div class="${isDrk ? 'bg-drk-50 border-drk-400' : 'bg-powercup-50 border-powercup-400'} border-2 rounded-b-lg p-3">
                                    <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} mb-2 font-bold">${resActual.offer.name}</p>
                                    <p class="text-3xl font-black text-green-600 mb-3">${eur(resActual.savings)}</p>
                                    <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} mb-2 font-semibold uppercase">${tr("TU NUEVO COSTE")} ${isDrk ? 'DRK' : 'POWER CUP'}</p>
                                    <p class="text-xl font-black ${isDrk ? 'text-drk-900' : 'text-powercup-900'} mb-1">${eur(resActual.totalAnnual / 12)}${tr("/mes")}</p>
                                    <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} mb-2">${tr("Estimado Mensual")}</p>
                                    <p class="text-lg font-black ${isDrk ? 'text-drk-900' : 'text-powercup-900'}">${eur(resActual.totalAnnual)}${tr("/aÃ±o")}</p>
                                </div>
                            </div>
                            
                            <!-- COLUMNA 3: CON POTENCIAS OPTIMIZADAS (Verde para destacar la mejor opciÃ³n) -->
                            <div class="text-center">
                                <div class="bg-green-600 text-white py-2 px-2 rounded-t-lg">
                                    <p class="text-xs font-bold uppercase">âš¡ ${tr("TU AHORRO ANUAL CON OPTIMIZACIÃ“N")}</p>
                                </div>
                                <div class="bg-green-50 border-2 border-green-400 rounded-b-lg p-3">
                                    <p class="text-xs text-green-700 mb-2 font-bold">${resOptimized.offer.name}</p>
                                    <p class="text-3xl font-black text-green-600 mb-3">${eur(resOptimized.savings)}</p>
                                    <p class="text-xs text-green-700 mb-2 font-semibold uppercase">${tr("TU NUEVO COSTE")} ${isDrk ? 'DRK' : 'POWER CUP'}</p>
                                    <p class="text-xl font-black text-green-900 mb-1">${eur(resOptimized.totalAnnual / 12)}${tr("/mes")}</p>
                                    <p class="text-xs text-green-700 mb-2">${tr("Estimado Mensual")}</p>
                                    <p class="text-lg font-black text-green-900">${eur(resOptimized.totalAnnual)}${tr("/aÃ±o")}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AHORRO ADICIONAL POR OPTIMIZACIÃ“N -->
                        <div class="bg-gradient-to-r from-amber-100 to-orange-100 border-2 border-amber-400 rounded-xl p-4 mb-6">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="bg-amber-500 text-white w-12 h-12 rounded-full flex items-center justify-center text-2xl">
                                        ðŸ’°
                                    </div>
                                    <div>
                                        <p class="text-sm font-bold text-amber-900">AHORRO ADICIONAL POR OPTIMIZACIÃ“N DE POTENCIAS</p>
                                        <p class="text-xs text-amber-700">Al ajustar las potencias contratadas</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-3xl font-black text-amber-900">${eur(resActual.totalAnnual - resOptimized.totalAnnual)}</p>
                                    <p class="text-xs text-amber-700">Extra al aÃ±o</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // NUEVO: Crear desglose dual con pestaÃ±as para potencias actuales vs optimizadas
                createDualPowerBreakdown(resActual, resOptimized, brand);
                
                // Botones de acciÃ³n
                document.getElementById('send-offer-btn').style.display = 'flex';
                document.getElementById('request-improvement-btn').style.display = 'none';
                
                console.log('âœ… Vista dual de potencias renderizada correctamente');
                console.log('âœ… Vista dual de potencias renderizada correctamente');
                
            } catch (error) {
                console.error('Error en renderDualPowerResultsUI:', error);
                // Si falla, mostrar al menos el resultado optimizado
                renderResultsUI(resOptimized);
            }
        }

        // NUEVA FUNCIÃ“N: Crear desglose dual con pestaÃ±as para comparativo de potencias
        function createDualPowerBreakdown(resActual, resOptimized, brand) {
            console.log('ðŸ“Š Creando desglose dual de potencias');
            
            const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            
            const isDrk = brand.NAME.includes('DRK');
            const brandPrefix = isDrk ? 'drk' : 'powercup';
            
            // Generar HTML de desglose para potencias actuales
            const breakdownActualHTML = generateBreakdownHTML(resActual, brand);
            
            // Generar HTML de desglose para potencias optimizadas
            const breakdownOptimizedHTML = generateBreakdownHTML(resOptimized, brand);
            
            const detailsContainer = document.getElementById('details-container');
            
            detailsContainer.innerHTML = `
                <div id="dual-power-tabs" class="sticky top-0 z-50 bg-white border-b-2 border-slate-200 shadow-md mb-6">
                    <div class="relative">
                        <!-- BotÃ³n Flecha Izquierda -->
                        <button onclick="scrollDualTabs('left')" 
                                class="absolute left-0 top-0 bottom-0 z-10 bg-gradient-to-r from-white to-transparent hover:from-slate-100 px-2 text-slate-600 hover:text-${brandPrefix}-600 transition-colors"
                                style="box-shadow: 2px 0 8px rgba(0,0,0,0.1);">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        
                        <!-- Contenedor de tabs con scroll -->
                        <div id="dual-tabs-container" class="flex overflow-x-auto scrollbar-hide scroll-smooth px-10" style="scroll-behavior: smooth;">
                            <button onclick="showDualPowerTab('actual')" id="btn-power-actual"
                                    class="dual-power-tab active flex-1 min-w-fit px-6 py-3 text-sm font-semibold text-${brandPrefix}-600 bg-${brandPrefix}-50 border-b-4 border-${brandPrefix}-600 transition-all whitespace-nowrap">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                                ${tr('CÃ¡lculo con Potencias Actuales')}
                            </button>
                            <button onclick="showDualPowerTab('optimized')" id="btn-power-optimized"
                                    class="dual-power-tab flex-1 min-w-fit px-6 py-3 text-sm font-semibold text-slate-600 hover:text-green-600 hover:bg-green-50 border-b-4 border-transparent transition-all whitespace-nowrap">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                âš¡ ${tr('CÃ¡lculo con Potencias Optimizadas')}
                            </button>
                        </div>
                        
                        <!-- BotÃ³n Flecha Derecha -->
                        <button onclick="scrollDualTabs('right')" 
                                class="absolute right-0 top-0 bottom-0 z-10 bg-gradient-to-l from-white to-transparent hover:from-slate-100 px-2 text-slate-600 hover:text-${brandPrefix}-600 transition-colors"
                                style="box-shadow: -2px 0 8px rgba(0,0,0,0.1);">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Contenido de potencias actuales -->
                <div id="content-power-actual" class="dual-power-content">
                    <h3 class="text-lg font-bold text-slate-800 border-l-4 border-${brandPrefix}-500 pl-3 mb-4">${tr('Desglose Detallado - Potencias Actuales')}</h3>
                    <div class="bg-white p-0 rounded-xl border border-slate-200 shadow-sm overflow-hidden text-sm">
                        ${breakdownActualHTML}
                    </div>
                </div>
                
                <!-- Contenido de potencias optimizadas -->
                <div id="content-power-optimized" class="dual-power-content hidden">
                    <h3 class="text-lg font-bold text-slate-800 border-l-4 border-green-500 pl-3 mb-4">âš¡ ${tr('Desglose Detallado - Potencias Optimizadas')}</h3>
                    <div class="bg-white p-0 rounded-xl border border-slate-200 shadow-sm overflow-hidden text-sm">
                        ${breakdownOptimizedHTML}
                    </div>
                </div>
            `;
            
            // Mostrar el contenedor de detalles
            detailsContainer.classList.remove('hidden');
        }
        
        // FunciÃ³n para cambiar entre pestaÃ±as del comparativo dual
        function showDualPowerTab(tabName) {
            console.log('Cambiando a pestaÃ±a:', tabName);
            
            // Detectar marca activa para los colores
            const isDrk = activeBrand.NAME.includes('DRK');
            const brandPrefix = isDrk ? 'drk' : 'powercup';
            
            // Ocultar todos los contenidos
            document.querySelectorAll('.dual-power-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Resetear estilos de todos los tabs
            document.querySelectorAll('.dual-power-tab').forEach(tab => {
                tab.className = 'dual-power-tab flex-1 min-w-fit px-6 py-3 text-sm font-semibold text-slate-600 hover:text-green-600 hover:bg-green-50 border-b-4 border-transparent transition-all whitespace-nowrap';
            });
            
            // Mostrar contenido seleccionado y activar tab correspondiente
            if (tabName === 'actual') {
                document.getElementById('content-power-actual').classList.remove('hidden');
                document.getElementById('btn-power-actual').className = `dual-power-tab active flex-1 min-w-fit px-6 py-3 text-sm font-semibold text-${brandPrefix}-600 bg-${brandPrefix}-50 border-b-4 border-${brandPrefix}-600 transition-all whitespace-nowrap`;
            } else if (tabName === 'optimized') {
                document.getElementById('content-power-optimized').classList.remove('hidden');
                document.getElementById('btn-power-optimized').className = 'dual-power-tab active flex-1 min-w-fit px-6 py-3 text-sm font-semibold text-green-600 bg-green-50 border-b-4 border-green-600 transition-all whitespace-nowrap';
            }
        }
        
        // FunciÃ³n para scroll horizontal de las pestaÃ±as duales
        function scrollDualTabs(direction) {
            const container = document.getElementById('dual-tabs-container');
            const scrollAmount = 200;
            
            if (direction === 'left') {
                container.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
            } else {
                container.scrollBy({ left: scrollAmount, behavior: 'smooth' });
            }
        }
        
        // FunciÃ³n auxiliar para generar HTML de desglose
        function generateBreakdownHTML(res, brand) {
            const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            
            // Generar filas de potencia
            let powerRowsHTML = '';
            if (res.powerCosts && res.powerCosts.length > 0) {
                res.powerCosts.forEach((pc, idx) => {
                    const periodName = pc.period || `P${idx + 1}`;
                    const kw = pc.kw || 0;
                    const priceDay = pc.priceDay || pc.price_euro_kw_day || 0;
                    const days = res.dias_facturados || 30;
                    const totalPower = kw * priceDay * days;
                    
                    powerRowsHTML += `
                        <tr class="border-t border-slate-100">
                            <td class="py-2 px-3 font-medium text-slate-700">${periodName}</td>
                            <td class="py-2 px-3 text-right">${num(kw, 2)} kW</td>
                            <td class="py-2 px-3 text-right">${num(priceDay, 6)} â‚¬/dÃ­a</td>
                            <td class="py-2 px-3 text-right">${days}</td>
                            <td class="py-2 px-3 text-right font-semibold">${eur(totalPower)}</td>
                        </tr>
                    `;
                });
            }
            
            // Generar filas de energÃ­a
            let energyRowsHTML = '';
            if (res.energyCosts && res.energyCosts.length > 0) {
                res.energyCosts.forEach((ec, idx) => {
                    const periodName = ec.period || `E${idx + 1}`;
                    const kwh = ec.kwh || 0;
                    const price = ec.price || ec.price_euro_kwh || 0;
                    const totalEnergy = kwh * price;
                    
                    energyRowsHTML += `
                        <tr class="border-t border-slate-100">
                            <td class="py-2 px-3 font-medium text-slate-700">${periodName}</td>
                            <td class="py-2 px-3 text-right">${num(kwh, 0)} kWh</td>
                            <td class="py-2 px-3 text-right">${num(price, 5)} â‚¬/kWh</td>
                            <td class="py-2 px-3 text-right font-semibold">${eur(totalEnergy)}</td>
                        </tr>
                    `;
                });
            }
            
            return `
                <div class="p-4">
                    <!-- Tabla de Potencia -->
                    <h4 class="font-bold text-slate-800 mb-3">ðŸ’¡ Potencia Contratada</h4>
                    <div class="overflow-x-auto mb-6">
                        <table class="w-full text-xs">
                            <thead class="bg-red-50">
                                <tr>
                                    <th class="py-2 px-3 text-left font-semibold text-red-700">Periodo</th>
                                    <th class="py-2 px-3 text-right font-semibold text-red-700">Potencia</th>
                                    <th class="py-2 px-3 text-right font-semibold text-red-700">Precio/dÃ­a<br><span class="text-[10px] font-normal">(â‚¬/kW/dÃ­a)</span></th>
                                    <th class="py-2 px-3 text-right font-semibold text-red-700">DÃ­as</th>
                                    <th class="py-2 px-3 text-right font-semibold text-red-700">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${powerRowsHTML}
                            </tbody>
                            <tfoot class="bg-red-50 font-bold">
                                <tr>
                                    <td colspan="4" class="py-2 px-3 text-right">Subtotal Potencia:</td>
                                    <td class="py-2 px-3 text-right">${eur(res.subPower || 0)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <!-- Tabla de EnergÃ­a -->
                    <h4 class="font-bold text-slate-800 mb-3">âš¡ EnergÃ­a Consumida</h4>
                    <div class="overflow-x-auto mb-6">
                        <table class="w-full text-xs">
                            <thead class="bg-green-50">
                                <tr>
                                    <th class="py-2 px-3 text-left font-semibold text-green-700">Periodo</th>
                                    <th class="py-2 px-3 text-right font-semibold text-green-700">Consumo</th>
                                    <th class="py-2 px-3 text-right font-semibold text-green-700">Precio/kWh<br><span class="text-[10px] font-normal">(â‚¬/kWh)</span></th>
                                    <th class="py-2 px-3 text-right font-semibold text-green-700">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${energyRowsHTML}
                            </tbody>
                            <tfoot class="bg-green-50 font-bold">
                                <tr>
                                    <td colspan="3" class="py-2 px-3 text-right">Subtotal EnergÃ­a:</td>
                                    <td class="py-2 px-3 text-right">${eur(res.subEnergyNet || 0)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <!-- Resumen Final -->
                    <div class="bg-slate-50 rounded-lg p-3 border border-slate-200">
                        <div class="flex justify-between mb-2">
                            <span class="text-slate-600">Base Imponible:</span>
                            <span class="font-semibold">${eur(res.subBase || 0)}</span>
                        </div>
                        <div class="flex justify-between mb-2">
                            <span class="text-slate-600">Impuesto ElÃ©ctrico (5.113%):</span>
                            <span class="font-semibold">${eur(res.costIE || 0)}</span>
                        </div>
                        <div class="flex justify-between mb-2">
                            <span class="text-slate-600">Base con IE:</span>
                            <span class="font-semibold">${eur(res.baseImp || 0)}</span>
                        </div>
                        <div class="flex justify-between mb-3">
                            <span class="text-slate-600">IVA (21%):</span>
                            <span class="font-semibold">${eur(res.costIVA || 0)}</span>
                        </div>
                        <div class="flex justify-between pt-3 border-t-2 border-slate-300">
                            <span class="font-bold text-slate-900">Total Periodo (${res.dias_facturados || 30} dÃ­as):</span>
                            <span class="font-bold text-lg text-blue-600">${eur(res.totalPeriod || 0)}</span>
                        </div>
                        <div class="flex justify-between pt-2">
                            <span class="font-bold text-slate-900">Total Anual:</span>
                            <span class="font-bold text-xl text-blue-600">${eur(res.totalAnnual || 0)}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function selectTariffType(type) {
            console.log('=== selectTariffType EJECUTÃNDOSE ===');
            console.log('Type:', type);
            console.log('dualMode:', window.dualMode);
            
            currentTariffType = type;
            const config = TARIFF_CONFIG[type];
            const qrButtonsContainer = document.getElementById('qr-buttons-container');

            // CRÃTICO: Si estamos en modo DUAL, limpiar TODAS las variables
            if (window.dualMode === true) {
                console.log('âš¡ MODO DUAL DETECTADO - Limpiando variables anteriores...');
                lastComparisonResult = null;
                lastIndexedResult = null;
                availableOffers = [];
                manuallySelectedOffer = null;
                compareWithIndexed = false;
                console.log('âœ… Variables limpiadas correctamente');
            }

            clearManualInputs();  

            if (config.isMulti) {
                // NEW: FLujo MULTICUPS: Va a la vista SAGA intermedia
                // CRÃTICO: Limpiar TODAS las variables globales al iniciar MultiCups
                multiCupsData = [];  
                multiCupsAddType = null; // Reset sub-type
                availableOffers = [];
                lastComparisonResult = null;
                manuallySelectedOffer = null;
                
                document.getElementById('landing-view').classList.add('hidden');
                showMultiCupsSagaView();

                // Forzar carga de tarifas 2.0TD y 3.0TD
                fetchTariffsForMultiCups();
                
            } else {
                // Flujo Individual (2.0TD, 3.0TD)
                document.getElementById('manual-input-btn').textContent = "DATOS A MANO";
                document.getElementById('multicups-finalize-btn-main').classList.add('hidden');
                
                // --- FIX: Loading status displayed during fetch (Issue 1) ---
                document.getElementById('loading-status').textContent = `Cargando tarifas ${config.label}...`;
                document.getElementById('loading-status').classList.remove('hidden');
                document.getElementById('tariff-display-badge').textContent = '0';

                // --- FIX: 3.0TD always manual ---
                if (config.requiresQR && type === '2.0TD') { // 2.0TD is the only single tariff with QR
                    qrButtonsContainer.classList.remove('hidden');
                    document.getElementById('manual-input-btn').classList.add('mt-3');
                    document.getElementById('scan-instruction-text').textContent = "Escanea el cÃ³digo QR o introduce datos manualmente.";
                } else { // 3.0TD (Siempre manual)
                    qrButtonsContainer.classList.add('hidden');
                    document.getElementById('manual-input-btn').classList.remove('mt-3');
                    document.getElementById('scan-instruction-text').textContent = "Introduce los datos de la factura manualmente.";
                    document.getElementById('qr-toggle-checkbox').checked = false;
                    document.getElementById('qr-content-wrapper').classList.remove('active');
                }

                document.getElementById('current-tariff-label').textContent = config.label;
                document.getElementById('app-subtitle').textContent = `Comparador ${config.label}`;
                
                // Mostrar/Ocultar inputs P3-P6/E4-E6
                toggleMultiCupsInputPeriods(currentTariffType, 'input');

                // CRÃTICO: Ocultar todas las vistas antes de mostrar initial-view
                document.getElementById('landing-view').classList.add('hidden');
                document.getElementById('multicups-saga-view').classList.add('hidden');
                document.getElementById('initial-view').classList.remove('hidden');
                
                // Cargar tarifas al seleccionar tipo
                fetchTariffsFromSheet(currentTariffType);

                if (document.getElementById('qr-toggle-checkbox').checked) {
                    generateQRCode(activeBrand);
                }
            }
        }
        
        function generateQRCode(brand) {
            const qrContainer = document.getElementById('qr-code-container');
            const qrVisualContainer = document.getElementById('qr-visual-container');

            // En modo MULTICUPS el QR siempre enlaza con 2.0TD ya que es el Ãºnico compatible con QR
            const tariffParam = currentTariffType === 'MULTICUPS' ? '2.0TD' : currentTariffType;  
            const fullUrl = `${brand.QR_URL}?tariff=${tariffParam}`;  

            qrContainer.innerHTML = '';
            qrCodeInstance = null;

            qrVisualContainer.style.setProperty('--qr-center-text', `'${brand.QR_TEXT}'`);
            qrVisualContainer.style.setProperty('--qr-border-color', brand.QR_BORDER_COLOR);
            qrVisualContainer.style.setProperty('--qr-center-bg', brand.QR_CENTER_BG);
            
            qrCodeInstance = new QRCode(qrContainer, {
                text: fullUrl,
                width: 140,
                height: 140,
                colorDark : brand.QR_CENTER_BG,
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        // --- CÃLCULOS Y COMPARACIÃ“N INDIVIDUAL/MULTICUPS ---
        
        function calculateDays(startDateStr, endDateStr) {
             try {
                 const [d1, m1, y1] = startDateStr.split('/').map(Number);
                 const [d2, m2, y2] = endDateStr.split('/').map(Number);

                 const date1 = new Date(y1, m1 - 1, d1);
                 const date2 = new Date(y2, m2 - 1, d2);
                 
                 if (isNaN(date1.getTime()) || isNaN(date2.getTime())) return 30;

                 const ONE_DAY_MS = 1000 * 60 * 60 * 24;
                 const diffDays = (date2.getTime() - date1.getTime()) / ONE_DAY_MS;
                 return Math.round(diffDays) + 1;
             } catch (e) {
                 return 30;
             }
        }
        
        const formatIsoToDmy = (iso) => {
             if (!iso) return null;
             const parts = iso.split('-');
             if (parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0]}`;  
             return null;
        };

        function calculateTariffCost(tariff, data, tariffType) {
            const IVA_RATE = 0.21;
            const IE_RATE = 0.05113; // Impuesto ElÃ©ctrico base
            const ANNUAL_DAYS = 365;
            const config = TARIFF_CONFIG[tariffType];  
            
            let subPower = 0;
            let powerCosts = [];
            
            // CÃ¡lculo de Coste de Potencia
            for (let i = 1; i <= (config?.powerPeriods || 6); i++) {
                // Usamos 6 por defecto si no estÃ¡ definido (aunque TARIFF_CONFIG estÃ¡ bien definido ahora)
                const kw = data[`potencia_p${i}_kw`] || 0;
                const priceAnnual = tariff[`p_potencia_${i}`] || 0;
                const priceDay = priceAnnual / ANNUAL_DAYS;
                const cost = kw * data.dias_facturados * priceDay;
                subPower += cost;
                powerCosts.push({ period: i, cost: cost, priceDay: priceDay, kw: kw, priceAnnual: priceAnnual });
            }

            let subEnergy = 0;
            let energyCosts = [];
            
            // LÃ³gica de consumo: usa los campos del data object
            for (let i = 1; i <= (config?.periods || 6); i++) {
                let kwh = 0;
                let price = 0;

                if (tariffType === '2.0TD') {
                    // 2.0TD usa nombres de campo especÃ­ficos para consumo: punta, llano, valle.
                    kwh = i === 1 ? data.consumo_punta : i === 2 ? data.consumo_llano : i === 3 ? data.consumo_valle : 0;
                    price = tariff[`p${i}_price`] || 0;
                } else {
                    // 3.0TD (y 6.1TD, aunque este Ãºltimo se eliminÃ³ de la UI, el cÃ¡lculo usa la estructura de 6 periodos)
                    kwh = data[`consumo_p${i}`] || 0;
                    price = tariff[`p${i}_price`] || 0;
                }
                
                const cost = kwh * price;
                energyCosts.push({ period: i, cost: cost, price: price, kwh: kwh });
                subEnergy += cost;
            }

            // Aplicar Descuento
            const discountRate = (tariff.descuento || 0) / 100;
            const discountAmount = subEnergy * discountRate;
            const subEnergyNet = subEnergy - discountAmount;

            // Base Imponible e Impuestos
            const subBase = subPower + subEnergyNet;
            const costIE = subBase * IE_RATE; // Impuesto ElÃ©ctrico
            const baseImp = subBase + costIE;
            const costIVA = baseImp * IVA_RATE;
            const totalPeriod = baseImp + costIVA;
            
            // CÃ¡lculo Anualizado
            const factorAnual = ANNUAL_DAYS / (data.dias_facturados || 30); // Prevenir divisiÃ³n por cero/NaN
            const totalAnnual = totalPeriod * factorAnual;
            const originalBillAnnual = data.importe_total * factorAnual;

            const result = {
                ...data,
                tariffType: tariffType, // Tipo de tarifa usada en el cÃ¡lculo (e.g. 2.0TD)
                powerCosts, energyCosts,
                subPower, subEnergy, subEnergyNet,
                discountRate, discountAmount,
                subBase, costIE, baseImp, costIVA, totalPeriod, totalAnnual,
                originalBillAnnual,
                savings: originalBillAnnual - totalAnnual,
                offer: deepCopyOffer(tariff),  // COPIA PROFUNDA para evitar referencias compartidas
                ieRate: IE_RATE
            };
            
            // Si el ahorro es negativo, forzar la tarifa actual como mejor
            if (result.savings <= 0) {
                result.isNegativeSavings = true;
                result.savings = 0;
                result.totalAnnual = result.originalBillAnnual;  
                result.offer = { name: "Tu Tarifa Actual", description: "Es la mejor opciÃ³n detectada", isDrk: false };
            }
            
            return result;
        }

        function compareOffers(data) {
            try {
                // PROTECCIÃ“N: Evitar llamadas duplicadas dentro de 500ms con los mismos datos
                const now = Date.now();
                const dataStr = JSON.stringify(data);
                
                if (now - lastCompareOffersCall < 500 && dataStr === lastCompareOffersData) {
                    console.warn('âš ï¸âš ï¸âš ï¸ LLAMADA DUPLICADA A compareOffers DETECTADA Y BLOQUEADA âš ï¸âš ï¸âš ï¸');
                    console.warn('Tiempo desde Ãºltima llamada:', now - lastCompareOffersCall, 'ms');
                    console.warn('Datos idÃ©nticos - ignorando llamada duplicada');
                    return; // Ignorar llamada duplicada
                }
                
                lastCompareOffersCall = now;
                lastCompareOffersData = dataStr;
                
                console.log('=================================================');
                console.log('âš¡âš¡âš¡ compareOffers LLAMADA âš¡âš¡âš¡');
                console.log('Stack trace para identificar origen:');
                console.trace();
                console.log('Data recibida:', data);
                console.log('currentTariffType:', currentTariffType);
                console.log('dualMode activo:', window.dualMode);
                console.log('=================================================');
                
                const tariffType = currentTariffType;  
                const tariffsToCompare = currentTariffs[tariffType] || [];

                console.log(`Tarifas disponibles para ${tariffType}:`, tariffsToCompare.length);

                if (tariffsToCompare.length === 0) {
                    console.error(`No hay tarifas cargadas para ${tariffType}`);
                    return window.showErrorModal(`Las tarifas ${tariffType} no estÃ¡n cargadas. Por favor, espere un momento e intente de nuevo.`);
                }

                const results = tariffsToCompare.map(t => calculateTariffCost(t, data, tariffType));
                console.log('Results calculated:', results.length);
                
                let bestOverall = null;
                let bestDrk = null;

                results.forEach(r => {
                    // Siempre comparamos por el coste anual
                    const annualCost = r.totalAnnual;
                    
                    // Best overall is the one with the lowest annual cost
                    if (!bestOverall || annualCost < bestOverall.totalAnnual) {
                        bestOverall = r;
                    }

                    // Best DRK is the DRK one with the lowest annual cost
                    if (r.offer.isDrk && r.offer.name !== 'Tu Tarifa Actual') {
                        if (!bestDrk || annualCost < bestDrk.totalAnnual) {
                            bestDrk = r;
                        }
                    }
                });

                if (!bestOverall) {
                    console.error('No se encontrÃ³ ningÃºn resultado vÃ¡lido');
                    return window.showErrorModal("Sin resultados vÃ¡lidos. AsegÃºrate de que las tarifas estÃ¡n cargadas.");
                }
                
                console.log('Best overall:', bestOverall.offer.name, bestOverall.totalAnnual);
                console.log('Best DRK:', bestDrk ? bestDrk.offer.name : 'None', bestDrk ? bestDrk.totalAnnual : 0);
                
                // --- GUARDAR OFERTAS CON AHORRO POSITIVO ---
                availableOffers = results.filter(r => {
                    r.savings = r.originalBillAnnual - r.totalAnnual;
                    const hasPositiveSavings = r.savings > 0 && r.totalAnnual < r.originalBillAnnual;
                    
                    // Si modo es "DRK ÃšNICAMENTE", filtrar solo ofertas DRK
                    if (comparisonMode === 'drk_only') {
                        return hasPositiveSavings && r.offer.isDrk;
                    }
                    
                    // En otros modos, mostrar todas las ofertas con ahorro
                    return hasPositiveSavings;
                });
                console.log('Available offers with savings (filtered by mode):', availableOffers.length);
                console.log('Comparison mode:', comparisonMode);
                
                let final = bestOverall;
                let brand = activeBrand;

                // --- LÃ“GICA DE SELECCIÃ“N Y BRANDING (Individual) ---
                if (comparisonMode === 'overall_best') {
                    // Modo POWER CUP: Buscar la mejor oferta absoluta (con o sin DRK)
                    final = bestOverall;
                    
                    // Aplicar branding segÃºn quiÃ©n ganÃ³
                    if (final.offer.isDrk) {
                        brand = BRANDS.DRK;
                    } else {
                        brand = BRANDS.POWER_CUP;
                    }
                } else {
                    // Modos DRK (drk_only, drk_prioritized)
                    if (comparisonMode === 'drk_only') {
                        // DRK ÃšNICAMENTE: SIEMPRE usar DRK, NUNCA otra comercializadora
                        if (bestDrk && bestDrk.totalAnnual < bestDrk.originalBillAnnual) {
                            // Hay DRK con ahorro
                            final = bestDrk;
                        } else {
                            // NO hay DRK con ahorro: usar DRK de todas formas y marcar para modal
                            if (bestDrk) {
                                final = bestDrk;
                                final.isNegativeSavings = true;
                                final.needsImprovementRequest = true;
                            } else {
                                // No existe ninguna tarifa DRK, crear resultado placeholder
                                final = {
                                    ...data,
                                    offer: { 
                                        name: "DRK EnergÃ­a", 
                                        description: "Solicita una oferta personalizada", 
                                        isDrk: true 
                                    },
                                    totalAnnual: data.originalBillAnnual || (data.importe_total * 365 / (data.dias_facturados || 30)),
                                    originalBillAnnual: data.originalBillAnnual || (data.importe_total * 365 / (data.dias_facturados || 30)),
                                    savings: 0,
                                    isNegativeSavings: true,
                                    needsImprovementRequest: true,
                                    energyCosts: [],
                                    powerCosts: []
                                };
                            }
                        }
                        // DRK ÃšNICAMENTE: SIEMPRE mantener branding DRK (azul)
                        brand = BRANDS.DRK;
                    } else if (comparisonMode === 'drk_prioritized') {
                        // Usar DRK si tiene ahorro, sino usar la mejor absoluta
                        final = (bestDrk && bestDrk.totalAnnual < bestDrk.originalBillAnnual) ? bestDrk : bestOverall;
                        
                        // DRK PRIORITARIO: Solo cambiar a POWER_CUP si ganÃ³ una comercializadora NO-DRK
                        if (final.offer.isDrk) {
                            brand = BRANDS.DRK;
                        } else {
                            brand = BRANDS.POWER_CUP;
                        }
                    }
                }
                
                console.log('Final selection:', final.offer.name, 'Brand:', brand.NAME);
                
                // Recalcular el ahorro basado en el resultado final seleccionado
                final.savings = final.originalBillAnnual - final.totalAnnual;
                
                // Manejar casos sin ahorro
                if (final.savings <= 0) {
                    final.isNegativeSavings = true;
                    final.savings = 0;
                    final.totalAnnual = final.originalBillAnnual;
                    
                    // CRÃTICO: En modo DRK ÃšNICAMENTE, NO cambiar la oferta a "Tu Tarifa Actual"
                    if (comparisonMode === 'drk_only') {
                        // Mantener la oferta DRK y marcar para solicitar mejora
                        if (!final.offer || !final.offer.isDrk) {
                            final.offer = { 
                                name: "DRK EnergÃ­a", 
                                description: "Solicita una oferta personalizada", 
                                isDrk: true 
                            };
                        }
                        final.needsImprovementRequest = true;
                        brand = BRANDS.DRK;
                    } else {
                        // En otros modos, cambiar a "Tu Tarifa Actual"
                        final.offer = { 
                            name: "Tu Tarifa Actual", 
                            description: "Es la mejor opciÃ³n detectada", 
                            isDrk: false 
                        };
                        // Mantener el branding segÃºn el modo seleccionado
                        brand = comparisonMode === 'overall_best' ? BRANDS.POWER_CUP : BRANDS.DRK;
                    }
                }
                // Add originalTariffType for consistent logic in HTML generation
                final.originalTariffType = tariffType;

                lastComparisonResult = final;
                
                console.log('About to apply brand styles. Brand:', brand.NAME);
                try {
                    applyBrandStyles(brand);
                    console.log('Brand styles applied successfully');
                } catch (styleError) {
                    console.error('Error in applyBrandStyles:', styleError);
                    throw styleError;
                }
                
                // Guardar el resultado temporalmente
                lastComparisonResult = final;
                lastComparisonResult.isMulti = false;
                
                console.log('Checking available offers...');
                console.log('availableOffers.length:', availableOffers.length);
                console.log('final.savings:', final.savings);
                console.log('currentTariffType:', currentTariffType);
                
                // NUEVA LÃ“GICA: Si hay ofertas con ahorro, mostrar modal de decisiÃ³n
                // PERO SOLO en modo individual, NO en MultiCups
                const isMultiCupsMode = currentTariffType === 'MULTICUPS';
                
                if (!isMultiCupsMode && availableOffers.length > 1) {
                    console.log('Showing decision modal with', availableOffers.length, 'offers');
                    showOfferDecisionModal();
                    return; // No mostrar resultados todavÃ­a, esperar decisiÃ³n del usuario
                }
                
                // Si es MultiCups, solo hay 1 oferta, o ninguna, mostrar resultados directamente
                console.log('About to render UI...');
                renderResultsUI(final);
                
                console.log('Showing results view...');
                document.getElementById('initial-view').classList.add('hidden');
                document.getElementById('scanner-view').classList.add('hidden');
                
                // NUEVO: Si estamos en modo DUAL, mostrar confirmaciÃ³n en lugar de resultados
                if (window.dualMode === true) {
                    console.log('Modo DUAL detectado - usando flujo con direcciÃ³n');
                    
                    // Extraer datos para DUAL
                    const tariff = final.tariffType || currentTariffType || '2.0TD';
                    const data = {
                        cups: final.cups || 'CUPS-ELECTRICIDAD',
                        tariff: tariff,
                        kwh_p1: parseFloat(final.kwh_p1) || 0,
                        kwh_p2: parseFloat(final.kwh_p2) || 0,
                        kwh_p3: parseFloat(final.kwh_p3) || 0,
                        kwh_p4: parseFloat(final.kwh_p4) || 0,
                        kwh_p5: parseFloat(final.kwh_p5) || 0,
                        kwh_p6: parseFloat(final.kwh_p6) || 0,
                        p1: parseFloat(final.p1) || 0,
                        p2: parseFloat(final.p2) || 0,
                        p3: parseFloat(final.p3) || 0,
                        p4: parseFloat(final.p4) || 0,
                        p5: parseFloat(final.p5) || 0,
                        p6: parseFloat(final.p6) || 0,
                        dias: parseInt(final.dias) || 30
                    };
                    
                    let drkCost = 0;
                    let powercupCost = 0;
                    
                    if (final.bestOffer) {
                        drkCost = parseFloat(final.bestOffer.annual_cost) || parseFloat(final.bestOffer.total_cost_period) * 12 || 0;
                    }
                    
                    if (final.indexedResult) {
                        powercupCost = parseFloat(final.indexedResult.annual_cost) || parseFloat(final.indexedResult.total_cost_period) * 12 || 0;
                    }
                    
                    if (drkCost === 0 && final.aggregatedData) {
                        drkCost = parseFloat(final.aggregatedData.total_anual_drk) || 0;
                    }
                    
                    if (powercupCost === 0 && final.aggregatedData) {
                        powercupCost = parseFloat(final.aggregatedData.total_anual_powercup) || 0;
                    }
                    
                    if (drkCost === 0 && final.offer) {
                        drkCost = parseFloat(final.offer.annual_cost) || 0;
                    }
                    
                    const results = {
                        drk: {
                            total: drkCost / 12,
                            total_anual: drkCost
                        },
                        powercup: {
                            total: powercupCost / 12,
                            total_anual: powercupCost
                        }
                    };
                    
                    console.log('Llamando a dualAddFromResults con:', { type: 'electricidad', tariff, data, results });
                    
                    // Usar el flujo con modal de direcciÃ³n, pasando el objeto final completo
                    window.dualAddFromResults('electricidad', tariff, data, results, final);
                
                } else {
                    // Flujo normal - mostrar resultados
                    document.getElementById('results-view').classList.remove('hidden');
                    document.getElementById('results-view').classList.add('animate-fade-in-up');
                    
                    // Detectar modo DUAL y mostrar botÃ³n si corresponde
                    if (window.checkDualMode) window.checkDualMode();
                }
                
                console.log('compareOffers completed successfully');
            } catch (error) {
                console.error('Error in compareOffers:', error);
                window.showErrorModal(`Error al calcular: ${error.message}. Por favor, intente de nuevo.`);
            }
        }


        // --- LÃ“GICA MULTICUPS ---

        /**
         * Nueva vista intermedia para seleccionar 2.0TD o 3.0TD en modo MultiCups.
         */
        function showMultiCupsSagaView() {
            document.getElementById('initial-view').classList.add('hidden');
            document.getElementById('landing-view').classList.add('hidden');
            document.getElementById('multicups-saga-view').classList.remove('hidden');
            document.getElementById('app-subtitle').textContent = TARIFF_CONFIG.MULTICUPS.label;
            
            // Mostrar secciÃ³n de tipo de selecciÃ³n de oferta

            updateMultiCupsSagaView();
        }
        
        /**
         * Actualiza el contador y el botÃ³n de finalizar en la vista SAGA.
         */
        function updateMultiCupsSagaView() {
            const totalCount = multiCupsData.length;
            document.getElementById('saga-total-cups').textContent = totalCount;
            document.getElementById('saga-finalize-count').textContent = totalCount;
            
            const finalizeBtn = document.getElementById('multicups-finalize-btn-saga');
            if (totalCount > 0) {
                finalizeBtn.classList.remove('hidden');
            } else {
                finalizeBtn.classList.add('hidden');
            }

            // Habilitar botones si las tarifas estÃ¡n cargadas
            const loadingEl = document.getElementById('loading-status-saga');
            const isReady = currentTariffs['2.0TD'].length > 0 && currentTariffs['3.0TD'].length > 0;
            const sagaButtonWrapper = document.getElementById('saga-button-wrapper');

            if (isReady) {
                loadingEl.classList.add('hidden');
                sagaButtonWrapper.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                loadingEl.classList.remove('hidden');
                sagaButtonWrapper.classList.add('opacity-50', 'pointer-events-none');
            }
        }
        
        /**
         * Se llama al pulsar 2.0TD o 3.0TD en la vista SAGA.
         * @param {string} type - '2.0TD' or '3.0TD'
         */
        window.selectMultiCupType = (type) => {
            multiCupsAddType = type;
            
            // 1. Ocultar Saga, Mostrar Vista de entrada
            document.getElementById('multicups-saga-view').classList.add('hidden');
            document.getElementById('initial-view').classList.remove('hidden');
            
            // 2. Configurar el botÃ³n de volver
            document.getElementById('back-button-label').textContent = "a MultiCups";
            
            // 3. Configurar Vista de entrada
            const qrButtonsContainer = document.getElementById('qr-buttons-container');
            const manualInputBtn = document.getElementById('manual-input-btn');
            const currentTariffLabel = document.getElementById('current-tariff-label');
            const scanInstructionText = document.getElementById('scan-instruction-text');

            currentTariffLabel.textContent = `MULTICUPS (${type})`;
            document.getElementById('tariff-display-badge').textContent = multiCupsData.length; // Keep existing count

            if (type === '2.0TD') {
                // 2.0TD: QR and Manual
                qrButtonsContainer.classList.remove('hidden');
                manualInputBtn.classList.add('mt-3');
                scanInstructionText.textContent = "Escanea el cÃ³digo QR (2.0TD) o introduce datos manualmente.";
                document.getElementById('scan-instruction-text').classList.remove('hidden'); // Ensure instruction is visible
            } else if (type === '3.0TD') {
                // 3.0TD: ONLY Manual
                qrButtonsContainer.classList.add('hidden');
                manualInputBtn.classList.remove('mt-3');
                scanInstructionText.textContent = "Introduce los datos de la factura 3.0TD manualmente.";
                document.getElementById('scan-instruction-text').classList.remove('hidden'); // Ensure instruction is visible
            }
            
            manualInputBtn.textContent = "AÃ‘ADIR SUMINISTRO MANUAL";
            // Asegurarse de aplicar los estilos correctos al botÃ³n manual
            applyBrandStyles(activeBrand);  
            // Ocultar status de carga, ya que ya estÃ¡n cargadas desde la vista SAGA
            document.getElementById('loading-status').classList.add('hidden');
        }

        function finalizeMultiCups() {
            if (multiCupsData.length === 0) return window.showErrorModal("AÃ±ada al menos un suministro.");

            compareMultiOffers();
        }

        function compareMultiOffers() {
            if (multiCupsData.length === 0) return window.showErrorModal("No hay suministros para comparar.");
            
            console.log('=== DIAGNÃ“STICO AHORRO CONSOLIDADO ===');
            console.log('Total CUPS:', multiCupsData.length);
            
            // Verificar si hay comparaciones indexadas
            const hasIndexedComparisons = multiCupsData.some(d => d.indexedComparison);
            console.log('Â¿Hay comparaciones indexadas?', hasIndexedComparisons);
            
            // Mostrar datos de cada CUPS antes de la suma
            multiCupsData.forEach((cups, idx) => {
                console.log(`CUPS ${idx + 1}:`, cups.cups);
                console.log(`  - Original Annual: ${cups.originalBillAnnual}`);
                console.log(`  - Total Annual (Fijo): ${cups.totalAnnual}`);
                console.log(`  - Savings (Fijo): ${cups.savings}`);
                if (cups.indexedComparison) {
                    console.log(`  - âœ… TIENE indexedComparison:`, cups.indexedComparison.offer.name);
                    console.log(`  - Total Annual (Indexado): ${cups.indexedComparison.totalAnnual}`);
                    console.log(`  - Savings (Indexado): ${cups.indexedComparison.savings}`);
                    console.log(`  - originalTariffType (Indexado): ${cups.indexedComparison.originalTariffType}`);
                } else {
                    console.log(`  - âŒ NO tiene indexedComparison`);
                }
            });
            
            // 1. Acumular Totales y Consumos (FIJO)
            const total = multiCupsData.reduce((acc, current) => {
                const newAnnual = current.totalAnnual;  
                
                acc.originalBillAnnual += current.originalBillAnnual;
                acc.totalAnnual += newAnnual;
                acc.totalPeriod += current.importe_total;

                // AcumulaciÃ³n de Potencias y EnergÃ­as
                const type = current.originalTariffType;
                
                for (let i = 1; i <= 6; i++) {
                    const kwKey = `potencia_p${i}_kw`;
                    if (current[kwKey] !== undefined) {
                        const groupKey = (type === '2.0TD' ? '2.0TD' : '3.0TD');
                        
                        if (TARIFF_CONFIG[type]?.powerPeriods >= i || type === '3.0TD') {
                            acc.aggregatedData[groupKey].power[`p${i}`] += current[kwKey] || 0;
                        }
                    }
                }

                if (type === '2.0TD') {
                    acc.aggregatedData[type].energy.e1 += current.consumo_punta || 0;
                    acc.aggregatedData[type].energy.e2 += current.consumo_llano || 0;
                    acc.aggregatedData[type].energy.e3 += current.consumo_valle || 0;
                } else if (type === '3.0TD') {
                    for (let i = 1; i <= 6; i++) {
                        acc.aggregatedData['3.0TD'].energy[`e${i}`] += current[`consumo_p${i}`] || 0;
                    }
                }
                
                return acc;
            }, {
                originalBillAnnual: 0,
                totalAnnual: 0,
                totalPeriod: 0,
                diasFacturados: 0,
                aggregatedData: {
                    '2.0TD': { power: { p1: 0, p2: 0, p3: 0, p4: 0, p5: 0, p6: 0 }, energy: { e1: 0, e2: 0, e3: 0, e4: 0, e5: 0, e6: 0 } },
                    '3.0TD': { power: { p1: 0, p2: 0, p3: 0, p4: 0, p5: 0, p6: 0 }, energy: { e1: 0, e2: 0, e3: 0, e4: 0, e5: 0, e6: 0 } }
                }
            });

            // 1b. Si hay comparaciones indexadas, acumular tambiÃ©n esos totales
            let totalIndexed = null;
            if (hasIndexedComparisons) {
                totalIndexed = multiCupsData.reduce((acc, current) => {
                    if (current.indexedComparison) {
                        acc.totalAnnual += current.indexedComparison.totalAnnual;
                    }
                    return acc;
                }, {
                    originalBillAnnual: total.originalBillAnnual, // Mismo original
                    totalAnnual: 0,
                    totalPeriod: total.totalPeriod
                });
                
                totalIndexed.savings = totalIndexed.originalBillAnnual - totalIndexed.totalAnnual;
                console.log('Total Indexado acumulado:', totalIndexed);
            }

            // 2. Calcular Ahorro Final Consolidado (FIJO)
            total.savings = total.originalBillAnnual - total.totalAnnual;
            
            console.log('=== TOTALES ACUMULADOS ===');
            console.log('Total originalBillAnnual:', total.originalBillAnnual);
            console.log('Total totalAnnual:', total.totalAnnual);
            console.log('Total savings calculado:', total.savings);

            // 3. Determinar la Oferta de Referencia para el resumen
            let bestOverallWinner = multiCupsData.reduce((best, current) => {
                // If this item has more savings, it becomes the reference.
                if (current.savings > best.savings) return { savings: current.savings, offer: current.offer, originalTariffType: current.originalTariffType };
                return best;
            }, { 
                savings: -1, 
                offer: { name: 'Resultado Consolidado', description: 'N/A', isDrk: false },
                originalTariffType: 'N/A'
            });

            if (total.savings <= 0) {
                bestOverallWinner.offer = { name: tr("Tu Tarifa Actual"), description: tr("Es la mejor opciÃ³n consolidada"), isDrk: false };
                total.savings = 0; // Ensure consistency
            } else {
                // Ahorro positivo: Usar un nombre genÃ©rico para la cabecera
                const genericName = activeBrand.NAME.includes('DRK') ? 'DRK EnergÃ­a' : 'POWER CUP';
                const genericDescription = tr('Ofrece el mayor ahorro consolidado con') + ' ' + genericName + '.';

                bestOverallWinner.offer = { 
                    name: genericName, 
                    description: genericDescription, 
                    // Se usa la bandera isDrk basada en el modo de comparaciÃ³n para el styling/branding
                    isDrk: activeBrand.NAME.includes('DRK') 
                };
            }

            const finalResult = {
                cups: `${multiCupsData.length} CUPS`, // String for display
                multiCupsList: multiCupsData.map(d => `${d.cups} (${d.originalTariffType})`).join(', '),
                dias_facturados: total.diasFacturados, // Should remain N/A or 0 for multi-cups
                importe_total: total.totalPeriod,
                originalBillAnnual: total.originalBillAnnual,
                totalAnnual: total.totalAnnual,
                savings: total.savings,
                offer: bestOverallWinner.offer, // Use the (potentially generic) offer for the header display
                isMulti: true,
                isMultiCups: true, // IMPORTANTE: AÃ±adir esta propiedad para que se detecte correctamente
                individualResults: multiCupsData, // AÃ±adir resultados individuales para el desglose HTML
                aggregatedData: total.aggregatedData,
                // AÃ±adir datos indexados si existen
                indexedTotals: totalIndexed // SerÃ¡ null si no hay comparaciones indexadas
            };
            
            console.log('finalResult created:', finalResult);
            if (totalIndexed) {
                console.log('finalResult incluye datos indexados:', totalIndexed);
            }
            
            lastComparisonResult = finalResult;
            
            // --- LÃ“GICA DE BRANDING (MultiCups) ---
            let brandToApply = activeBrand;
            
            if (comparisonMode === 'overall_best') {
                // REQUERIMIENTO DEL USUARIO: Si es modo Power Cup Global, siempre usa Power Cup.
                brandToApply = BRANDS.POWER_CUP;
            } else {
                // DRK modes (drk_only, drk_prioritized)
                if (finalResult.savings <= 0) {
                    // No savings, stick to the initial DRK brand
                    brandToApply = BRANDS.DRK;
                } else if (bestOverallWinner.offer.isDrk) {
                    // DRK won overall combo -> Use DRK brand
                    brandToApply = BRANDS.DRK;
                } else {
                    // Competitor won overall combo in a DRK mode -> Use Power Cup (general market/non-DRK saving)
                    brandToApply = BRANDS.POWER_CUP;
                }
            }
            
            applyBrandStyles(brandToApply);
            
            renderMultiResultsUI(finalResult);
            
            document.getElementById('initial-view').classList.add('hidden');
            document.getElementById('multicups-saga-view').classList.add('hidden');
            document.getElementById('scanner-view').classList.add('hidden');
            document.getElementById('results-view').classList.remove('hidden');
            document.getElementById('results-view').classList.add('animate-fade-in-up');
        }


        // Nueva funciÃ³n para renderizar comparaciÃ³n dual en MULTICUPS
        function renderMultiDualComparisonUI(res) {
            console.log('renderMultiDualComparisonUI llamada', res);
            
            // IMPORTANTE: Asegurar que la variable global estÃ© guardada
            if (!lastComparisonResult) {
                lastComparisonResult = res;
            }
            
            const brand = activeBrand;
            const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            
            // CRÃTICO: Colores dinÃ¡micos segÃºn marca
            const isDrk = brand.NAME.includes('DRK');
            const brandPrefix = isDrk ? 'drk' : 'powercup';  // drk (azul) o powercup (verde)
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // BOTÃ“N ROJO DE VOLVER (RECARGA PÃGINA)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            let backButtonContainer = document.getElementById('back-button-top-container');
            if (!backButtonContainer) {
                backButtonContainer = document.createElement('div');
                backButtonContainer.id = 'back-button-top-container';
                backButtonContainer.className = 'fixed top-0 left-0 right-0 z-[100] bg-white shadow-lg p-3 border-b-4 border-red-500';
                backButtonContainer.innerHTML = `
                    <div class="max-w-lg mx-auto">
                        <button id="force-back-button" class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-black py-4 px-6 rounded-xl shadow-2xl transform transition active:scale-95 flex items-center justify-center gap-3 text-lg">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                            <span>â¬…ï¸ VOLVER AL INICIO</span>
                        </button>
                    </div>
                `;
                document.body.insertBefore(backButtonContainer, document.body.firstChild);
                
                document.getElementById('force-back-button').addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('ðŸ”„ RECARGANDO PÃGINA (MULTICUPS)...');
                    window.location.reload();
                });
            }
            backButtonContainer.style.display = 'block';
            
            const resultsView = document.getElementById('results-view');
            if (resultsView) {
                resultsView.style.paddingTop = '80px';
            }
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // FIN BOTÃ“N ROJO
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            // Banner
            const companyBanner = document.getElementById('company-banner');
            
            // CRÃTICO: Usar colores dinÃ¡micos segÃºn marca
            if (isDrk) {
                // DRK - Banner mejorado y mÃ¡s grande
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-drk-900 via-drk-800 to-drk-700 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                            <div class="transform scale-125">
                                ${brand.LOGO_SVG}
                            </div>
                            <div class="text-center md:text-left">
                                <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">${brand.FULL_NAME}</h1>
                                <p class="text-drk-100 text-lg md:text-xl font-semibold">${tr('Liderando el ahorro y la eficiencia energÃ©tica')}</p>
                            </div>
                        </div>
                        <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">ðŸ“Š ESTUDIO DE AHORRO</p>
                            <p class="text-drk-100 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                            <p class="text-drk-100 text-base md:text-lg font-bold">${tr("PROFESIONAL")}</p>
                        </div>
                    </div>
                `;
            } else {
                // POWER CUP - Banner mejorado y mÃ¡s grande
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-powercup-700 via-powercup-600 to-powercup-500 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                            <div class="transform scale-125">
                                ${brand.LOGO_SVG}
                            </div>
                            <div class="text-center md:text-left">
                                <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">${brand.FULL_NAME}</h1>
                                <p class="text-powercup-50 text-lg md:text-xl font-semibold">AsesorÃ­a EnergÃ©tica</p>
                            </div>
                        </div>
                        <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">ðŸ“Š ESTUDIO DE AHORRO</p>
                            <p class="text-powercup-50 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                            <p class="text-powercup-50 text-base md:text-lg font-bold">${tr("PROFESIONAL")}</p>
                        </div>
                    </div>
                `;
            }
            
            // CUPS list
            document.getElementById('results-cups-list').innerHTML = `
                Total: ${res.cups} - <span class="text-xs">${res.multiCupsList}</span>
            `;
            
            // Calcular totales indexados
            const totalIndexadoAnual = res.indexedTotals ? res.indexedTotals.totalAnnual : 0;
            const ahorroIndexado = res.indexedTotals ? res.indexedTotals.savings : 0;
            
            // Vista con TRES COLUMNAS (similar a individual pero con totales MULTICUPS)
            const resultCard = document.getElementById('result-card');
            resultCard.innerHTML = `
                <div class="p-4">
                    <h2 class="text-xl font-black text-slate-800 mb-4 text-center">
                        ðŸ“Š COMPARATIVA MULTICUPS: ${res.cups}
                    </h2>
                    
                    <!-- TRES COLUMNAS -->
                    <div class="grid grid-cols-3 gap-3 mb-6">
                        <!-- COLUMNA 1: TU FACTURA ACTUAL -->
                        <div class="text-center">
                            <div class="bg-slate-600 text-white py-2 px-2 rounded-t-lg">
                                <p class="text-xs font-bold uppercase"${tr("TU FACTURA ACTUAL")}</p>
                            </div>
                            <div class="bg-white border-2 border-slate-300 rounded-b-lg p-3">
                                <p class="text-xs text-slate-500 mb-2 uppercase"${tr("TU FACTURA ACTUAL")}</p>
                                <p class="text-2xl font-black text-red-600 line-through mb-2">${eur(res.importe_total)}</p>
                                <p class="text-xs text-slate-500 mb-3">${tr('Total Periodo')} (${res.dias_facturados || 'varios'} ${tr('dÃ­as')})</p>
                                <p class="text-2xl font-black text-red-600">${eur(res.originalBillAnnual)}${tr("/aÃ±o")}</p>
                            </div>
                        </div>
                        
                        <!-- COLUMNA 2: LA MEJOR OPCIÃ“N - FIJO (Color de marca) -->
                        <div class="text-center">
                            <div class="${isDrk ? 'bg-drk-600' : 'bg-powercup-600'} text-white py-2 px-2 rounded-t-lg">
                                <p class="text-xs font-bold uppercase">LA MEJOR OPCIÃ“N PARA TI ES ${isDrk ? 'DRK' : 'POWER CUP'}</p>
                            </div>
                            <div class="${isDrk ? 'bg-drk-50 border-drk-400' : 'bg-powercup-50 border-powercup-400'} border-2 rounded-b-lg p-3">
                                <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} mb-2 font-bold">${isDrk ? 'DRK' : 'POWER CUP'} - TARIFAS FIJAS</p>
                                <p class="text-2xl font-black ${isDrk ? 'text-drk-900' : 'text-powercup-900'} mb-2">${eur(res.totalAnnual / 12)}${tr("/mes")}</p>
                                <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} mb-3"${tr("Estimado Mensual")}</p>
                                <p class="text-2xl font-black ${isDrk ? 'text-drk-900' : 'text-powercup-900'}">${eur(res.totalAnnual)}${tr("/aÃ±o")}</p>
                            </div>
                        </div>
                        
                        <!-- COLUMNA 3: LA MEJOR OPCIÃ“N - INDEXADO (Verde) -->
                        <div class="text-center">
                            <div class="bg-green-600 text-white py-2 px-2 rounded-t-lg">
                                <p class="text-xs font-bold uppercase">LA MEJOR OPCIÃ“N PARA TI ES ${isDrk ? 'DRK' : 'POWER CUP'}</p>
                            </div>
                            <div class="bg-green-50 border-2 border-green-400 rounded-b-lg p-3">
                                <p class="text-xs text-green-700 mb-2 font-bold">${isDrk ? 'DRK' : 'POWER CUP'} - TARIFAS INDEXADAS</p>
                                <p class="text-2xl font-black text-green-900 mb-2">${eur(totalIndexadoAnual / 12)}${tr("/mes")}</p>
                                <p class="text-xs text-green-700 mb-3"${tr("Estimado Mensual")}</p>
                                <p class="text-2xl font-black text-green-900">${eur(totalIndexadoAnual)}${tr("/aÃ±o")}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AHORROS -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="${isDrk ? 'bg-drk-100 border-drk-400' : 'bg-powercup-100 border-powercup-400'} border-2 rounded-xl p-4 text-center">
                            <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} font-bold uppercase mb-2">ðŸ’¼ TU AHORRO CON TARIFAS FIJAS</p>
                            <p class="text-4xl font-black text-green-600">${eur(res.savings)}</p>
                            <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} mt-1">Ahorro anual estimado total</p>
                        </div>
                        <div class="bg-green-100 border-2 border-green-400 rounded-xl p-4 text-center">
                            <p class="text-xs text-green-700 font-bold uppercase mb-2">âš¡ TU AHORRO CON TARIFAS INDEXADAS</p>
                            <p class="text-4xl font-black text-green-600">${eur(ahorroIndexado)}</p>
                            <p class="text-xs text-green-700 mt-1">Ahorro anual estimado total</p>
                        </div>
                    </div>
                    
                    <!-- LISTADO DE CUPS -->
                    <div class="bg-slate-50 rounded-xl p-4 mb-4">
                        <h3 class="text-sm font-black text-slate-800 mb-3 text-center">
                            ðŸ“‹ DETALLE POR SUMINISTRO
                        </h3>
                        <div class="grid md:grid-cols-2 gap-4 text-xs">
                            <!-- Lista FIJAS -->
                            <div>
                                <p class="font-bold text-blue-700 mb-2">ðŸ’¼ TARIFAS FIJAS:</p>
                                <div class="space-y-2">
                                    ${res.individualResults.map((supply, idx) => `
                                        <div class="bg-white rounded p-2 border border-blue-200">
                                            <div class="flex justify-between items-start mb-1">
                                                <span class="font-mono text-slate-600">${supply.cups}</span>
                                                <span class="font-bold text-green-600">${eur(supply.savings)}</span>
                                            </div>
                                            <div class="text-slate-700">
                                                <span class="font-semibold">${supply.offer.name}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Lista INDEXADAS -->
                            <div>
                                <p class="font-bold text-green-700 mb-2">âš¡ TARIFAS INDEXADAS:</p>
                                <div class="space-y-2">
                                    ${res.individualResults.map((supply, idx) => {
                                        const indexedOffer = supply.indexedComparison ? supply.indexedComparison.offer : null;
                                        const indexedSavings = supply.indexedComparison ? supply.indexedComparison.savings : 0;
                                        return `
                                        <div class="bg-white rounded p-2 border border-green-200">
                                            <div class="flex justify-between items-start mb-1">
                                                <span class="font-mono text-slate-600">${supply.cups}</span>
                                                <span class="font-bold text-green-600">${eur(indexedSavings)}</span>
                                            </div>
                                            <div class="text-slate-700">
                                                <span class="font-semibold">${indexedOffer ? indexedOffer.name : 'N/A'}</span>
                                            </div>
                                        </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- NOTA IMPORTANTE -->
                    <div class="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-4 mb-6">
                        <p class="text-sm text-yellow-900">
                            <strong>âš ï¸ Importante:</strong> El PDF y HTML incluirÃ¡n el desarrollo detallado de cÃ¡lculos para cada CUPS, 
                            mostrando las fÃ³rmulas completas de potencia y energÃ­a tanto para tarifas fijas como indexadas.
                        </p>
                    </div>
                </div>
            `;
            
            // Configurar el botÃ³n existente (NO crear uno nuevo)
            const sendOfferBtn = document.getElementById('send-offer-btn');
            if (sendOfferBtn) {
                sendOfferBtn.style.display = 'flex'; // Asegurar que estÃ© visible
                sendOfferBtn.onclick = () => {
                    document.getElementById('send-offer-modal').classList.remove('hidden');
                    document.getElementById('send-offer-modal').classList.add('flex');
                    document.querySelectorAll('#send-offer-modal input').forEach(input => {
                        input.classList.remove('focus:ring-drk-500', 'focus:ring-powercup-500');
                        input.classList.add(activeBrand.NAME.includes('DRK') ? 'focus:ring-drk-500' : 'focus:ring-powercup-500');
                    });
                };
            }
            
            // Ocultar detalles
            document.getElementById('details-toggle-btn').style.display = 'none';
            document.getElementById('details-container').style.display = 'none';
            
            // IMPORTANTE: Asegurar que el botÃ³n "Realizar Nueva ComparaciÃ³n" estÃ© visible y funcional
            const resetButton = document.querySelector('#results-view button[onclick="resetToLanding()"]');
            if (resetButton) {
                resetButton.style.display = 'flex';
                resetButton.style.visibility = 'visible';
                resetButton.classList.remove('hidden');
            }
        }
        /**
         * Rellena la vista de resultados con los datos acumulados para MULTICUPS.
         * @param {Object} res - Resultado final de la comparaciÃ³n acumulada.
         */
        function renderMultiResultsUI(res) {
            // Si hay resultados indexados, usar vista de comparaciÃ³n dual
            if (res.indexedTotals) {
                renderMultiDualComparisonUI(res);
                return;
            }
            
            // Si no hay resultados indexados, continuar con la vista normal
            const offer = res.offer;
            let brand = activeBrand; // Use activeBrand set by comparisonMode
            const individualResults = res.individualResults;
            const aggregatedData = res.aggregatedData;
            const isDrk = brand.NAME.includes('DRK');
            
            // FIX: Usar funciones robustas contra NaN
            const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
            
            // NUEVO: Generar banner de empresa dinÃ¡mico para MultiCups
            const companyBanner = document.getElementById('company-banner');
            if (isDrk) {
                // DRK - Banner mejorado
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-drk-900 via-drk-800 to-drk-700 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                            <div class="transform scale-125">
                                ${brand.LOGO_SVG}
                            </div>
                            <div class="text-center md:text-left">
                                <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">DRK ENERGÃA</h1>
                                <p class="text-drk-100 text-lg md:text-xl font-semibold">${tr('Liderando el ahorro y la eficiencia energÃ©tica')}</p>
                            </div>
                        </div>
                        <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">ðŸ“Š ESTUDIO DE AHORRO</p>
                            <p class="text-drk-100 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                            <p class="text-drk-100 text-base md:text-lg font-bold">${tr("PROFESIONAL")}</p>
                        </div>
                    </div>
                `;
            } else {
                // POWER CUP - Banner mejorado
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-powercup-700 via-powercup-600 to-powercup-500 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                            <div class="transform scale-125">
                                ${brand.LOGO_SVG}
                            </div>
                            <div class="text-center md:text-left">
                                <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">POWER CUP</h1>
                                <p class="text-powercup-50 text-lg md:text-xl font-semibold">AsesorÃ­a EnergÃ©tica</p>
                            </div>
                        </div>
                        <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">ðŸ“Š ESTUDIO DE AHORRO</p>
                            <p class="text-powercup-50 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                            <p class="text-powercup-50 text-base md:text-lg font-bold">${tr("PROFESIONAL")}</p>
                        </div>
                    </div>
                `;
            }
            
            // 1. Cabecera y Resumen Global
            document.getElementById('results-cups-list').innerHTML = `
                ${tr('CUPS Procesadas')}: ${individualResults.length}
            `;

            // MODIFICACIÃ“N: Mostrar Nombre y DescripciÃ³n.
            // Si el nombre es genÃ©rico ("Tu Mejor ElecciÃ³n"), solo mostramos el nombre en H2 y la descripciÃ³n en el pÃ¡rrafo.
            if (res.isMulti && res.savings > 0 && offer.name !== "Tu Tarifa Actual") {
                document.getElementById('best-offer-name').textContent = offer.name;
                document.getElementById('best-offer-desc').textContent = offer.description;
            } else {
                // OpciÃ³n 'Tu Tarifa Actual' o individual (mantiene el formato combinado)
                document.getElementById('best-offer-name').textContent = `${offer.name || ''}`;
                document.getElementById('best-offer-desc').textContent = offer.description;
            }
            
            const savingsEl = document.getElementById('savings-estimate');
            const newCostLabelEl = document.getElementById('new-cost-label');
            const oldCostPeriodEl = document.getElementById('old-period-cost-display');
            const oldCostAnnualEl = document.getElementById('old-annual-cost-display');

            // Resetear clases de color dinÃ¡micas
            savingsEl.className = 'text-5xl font-black tracking-tight';
            oldCostPeriodEl.classList.remove('line-through', 'text-red-400', 'text-cta-green-500', 'decoration-red-400/50');
            oldCostAnnualEl.classList.remove('line-through', 'text-cta-red-500', 'text-cta-green-500', 'decoration-cta-red-500/50');

            if (res.savings <= 0) {
                // Mensaje especial cuando no hay ahorro
                document.getElementById('savings-label').textContent = "Â¡ENHORABUENA!";
                savingsEl.innerHTML = `<div class="text-lg leading-tight font-bold">${tr("Actualmente estÃ¡s en una buena tarifa.")}</div><div class="text-sm mt-3 leading-relaxed">${tr("Seguiremos estudiando el mercado y te avisaremos cuando encontremos alguna tarifa que se adapte a tu perfil de consumo.")}</div>`;
                const colorClass = brand.PRIMARY_TEXT.replace('text-', '');
                savingsEl.classList.add('text-' + colorClass);
                savingsEl.classList.remove('text-5xl', 'font-black');
                savingsEl.classList.add('text-base');
                
                // Ocultar columnas de precios
                document.getElementById('price-columns').style.display = 'none';
                
                // NUEVO: Mostrar botÃ³n para solicitar mejora a DRK
                document.getElementById('request-improvement-btn').style.display = 'flex';
                
                newCostLabelEl.textContent = "TU COSTE ACTUAL CONSOLIDADO";
                oldCostPeriodEl.classList.remove('line-through');
                oldCostPeriodEl.classList.add('text-cta-green-500');
                oldCostAnnualEl.classList.remove('line-through');
                oldCostAnnualEl.classList.add('text-cta-green-500');
            } else {
                document.getElementById('savings-label').textContent = "TU AHORRO ANUAL ESTIMADO";
                savingsEl.textContent = eur(res.savings);
                savingsEl.classList.add('text-cta-green-500');
                savingsEl.classList.add('text-5xl', 'font-black');
                savingsEl.classList.remove('text-base');
                
                // Mostrar columnas de precios
                document.getElementById('price-columns').style.display = 'grid';
                
                // Ocultar botÃ³n de solicitar mejora
                document.getElementById('request-improvement-btn').style.display = 'none';
                
                newCostLabelEl.textContent = `${tr('TU NUEVO COSTE')} ${brand.NAME.includes('DRK') ? 'DRK' : 'POWER CUP'} ${tr('CONSOLIDADO')}`;
                oldCostPeriodEl.classList.add('line-through', 'text-red-400', 'decoration-red-400/50');
                oldCostAnnualEl.classList.add('line-through', 'text-cta-red-500', 'decoration-cta-red-500/50');
            }
            
            document.getElementById('old-period-cost-display').textContent = eur(res.importe_total);
            document.getElementById('old-annual-cost-display').textContent = eur(res.originalBillAnnual) + tr('/aÃ±o');
            document.getElementById('old-period-days-label').textContent = `${tr('Total Periodo')} (${tr('Variado')})`; // DÃ­as varÃ­an por factura
            
            
            document.getElementById('new-monthly-cost-display').textContent = eur(res.totalAnnual / 12) + tr('/mes');
            document.getElementById('new-annual-cost-display').textContent = eur(res.totalAnnual) + tr('/aÃ±o');
            
            
            // 2. Nuevo: Resumen de Suministros (Tipo, CUPS, Ahorro Individual)
            let summaryListHTML = individualResults.map((resItem, index) => {
                // MODIFICACIÃ“N #2: Eliminar "Sin Ahorro" en la vista interna, dejando un espacio.
                const savingsText = resItem.isNegativeSavings ? `&nbsp;` : `(${tr('Ahorro')}: ${eur(resItem.savings)})`;
                
                // Incluir direcciÃ³n si existe
                const addressHTML = resItem.supplyAddress && resItem.supplyAddress !== 'No especificada' 
                    ? `<div class="text-xs text-slate-500 mt-1">${resItem.supplyAddress}</div>` 
                    : '';
                
                return `<div class="py-2 border-b border-slate-100 last:border-b-0">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-sm text-slate-700">${resItem.cups}</span>
                        <span class="text-xs text-drk-800 font-semibold">${resItem.originalTariffType}</span>
                        <span class="text-xs ${resItem.isNegativeSavings ? 'text-slate-500' : 'text-cta-green-600 font-medium'}">${savingsText}</span>
                    </div>
                    ${addressHTML}
                </div>`;
            }).join('');

            const supplySummarySection = `
                <h3 class="text-lg font-bold text-slate-800 border-l-4 border-green-500 pl-3 mb-3" style="border-left-color: ${brand.QR_CENTER_BG};">${tr('Resumen de Suministros AÃ±adidos')}</h3>
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm text-sm mb-6 space-y-1">
                    ${summaryListHTML}
                </div>
            `;


            // 3. Datos Acumulados Agrupados por Tarifa
            let totalEnergy = 0;
            Object.keys(aggregatedData).forEach(type => {
                // Solo iteramos 2.0TD y 3.0TD, ya que 6.1TD ya no existe en el estado global
                Object.values(aggregatedData[type].energy).forEach(kwh => {
                    totalEnergy += kwh;
                });
            });
            
            // Helper para generar el HTML del grupo
            function generateGroupedDataHTML(type, data, powerPeriods, energyPeriods) {
                const is20TD = type === '2.0TD';
                
                const hasPower = Object.values(data.power).slice(0, powerPeriods).some(v => v > 0);
                const hasEnergy = Object.values(data.energy).slice(0, energyPeriods).some(v => v > 0);
                
                if (!hasPower && !hasEnergy) return '';  

                let energyRows = '';
                let totalGroupEnergy = 0;
                for (let i = 1; i <= energyPeriods; i++) {
                    const kwh = data.energy[`e${i}`] || 0;
                    if (kwh > 0) {
                        let label = `E${i}`;
                        if (is20TD) {
                            if (i === 1) label += ` (${tr('Punta')})`;
                            if (i === 2) label += ` (${tr('Llano')})`;
                            if (i === 3) label += ` (${tr('Valle')})`;
                        }
                        energyRows += `<div class="flex justify-between text-xs mb-1"><span>${label} (Acumulado)</span><span class="font-mono">${num(kwh, 0)} kWh</span></div>`;
                        totalGroupEnergy += kwh;
                    }
                }

                let powerRows = '';
                for (let i = 1; i <= powerPeriods; i++) {
                    const kw = data.power[`p${i}`] || 0;
                    if (kw > 0) {
                        powerRows += `<div class="flex justify-between text-xs mb-1"><span>P${i} (Acumulado)</span><span class="font-mono">${num(kw, 2)} kW</span></div>`;
                    }
                }

                // Eliminamos la referencia a 6.1 TD en el tÃ­tulo, ya que el tipo 3.0TD ahora lo engloba todo
                const title = is20TD ? '2.0 TD (' + tr('Hogar/Negocio') + ')' : '3.0 TD (' + tr('Industria/Gran Consumo') + ')';

                return `
                    <div class="border-t pt-4 mt-4 first:border-t-0 first:pt-0 first:mt-0">
                        <p class="font-black text-base ${brand.PRIMARY_TEXT} mb-3">${title}</p>
                        
                        <p class="font-bold text-slate-700 mt-2 mb-1">${tr('Consumos (kWh)')}</p>
                        ${energyRows || `<p class="text-xs text-slate-400">${tr('No hay consumos para este tipo.')}</p>`}
                        ${totalGroupEnergy > 0 ? `<div class="flex justify-between font-bold ${brand.PRIMARY_TEXT} mt-1 border-t pt-1 border-slate-200"><span>${tr('Total Consumo')} ${type}</span><span>${num(totalGroupEnergy, 0)} kWh</span></div>` : ''}
                        
                        <p class="font-bold text-slate-700 mt-4 mb-1">${tr('Potencias (kW)')}</p>
                        ${powerRows || `<p class="text-xs text-slate-400">${tr('No hay potencias para este tipo.')}</p>`}
                    </div>
                `;
            }

            let accumulatedSectionsHTML = '';
            accumulatedSectionsHTML += generateGroupedDataHTML('2.0TD', aggregatedData['2.0TD'], 2, 3);  
            accumulatedSectionsHTML += generateGroupedDataHTML('3.0TD', aggregatedData['3.0TD'], 6, 6);  

            const correctedConsumptionHTML = `
                <div class="grid grid-cols-1 gap-4">
                    <div class="col-span-1 border-b pb-2 mb-2">
                        <div class="flex justify-between items-center ${brand.PRIMARY_TEXT}">
                            <span class="text-sm font-black uppercase">TOTAL ENERGÃA</span>
                            <span class="text-xl font-black">${num(totalEnergy, 0)} kWh</span>
                        </div>
                    </div>
                    ${accumulatedSectionsHTML}
                </div>
            `;

            // --- 4. Precios de la Oferta Consolidada (Dynamic Winner) ---
            const { winningOffers, hasDrkWinner } = getWinningOffersPerType(individualResults);
            let tariffPricesHTML = '';
            const consolidatedPrices = [];
            const brandPrimaryText = brand.PRIMARY_TEXT;
            const isPowerCupMode = comparisonMode === 'overall_best';

            // Determine the label for the price section
            let priceSectionLabel;
            if (hasDrkWinner && comparisonMode !== 'overall_best') {
                // Modo DRK con ofertas DRK
                priceSectionLabel = tr('Precios de las Ofertas Seleccionadas') + ' (DRK ENERGÃA)';
            } else if (!hasDrkWinner && comparisonMode === 'overall_best') {
                // Modo POWER CUP sin DRK
                priceSectionLabel = tr('Precios de las Ofertas Seleccionadas') + ' (POWER CUP GLOBAL)';
            } else {
                // Mixto o general
                priceSectionLabel = tr('Precios de las Ofertas Seleccionadas');
            }

            const basePrefix = brand.NAME.includes('DRK') ? 'drk' : 'powercup';
            const color800 = brand.PRIMARY_TEXT.replace('text-', ''); // Get dynamic color: text-drk-800 -> drk-800

            // Add 2.0TD Prices - TODAS las ofertas Ãºnicas
            const offers20 = winningOffers['2.0TD'];
            const has20TD = individualResults.some(d => d.originalTariffType === '2.0TD');
            if (offers20 && offers20.length > 0 && has20TD) {
                offers20.forEach((offer20, index) => {
                    const fullTariffName20 = `${offer20.name || 'Tarifa 2.0TD'} - ${offer20.description || 'N/A'}`;
                    
                    const p1 = offer20.p_potencia_1 / 365;
                    const p2 = offer20.p_potencia_2 / 365;
                    const e1 = offer20.p1_price;
                    const e2 = offer20.p2_price;
                    const e3 = offer20.p3_price;

                    consolidatedPrices.push(`
                        <div class="mb-4 p-3 bg-white rounded-lg border border-${basePrefix}-100">
                            <h5 class="font-black text-sm text-${color800} border-b pb-1 mb-2">Tarifa 2.0 TD #${index + 1} - ${fullTariffName20}</h5>
                            <div class="grid grid-cols-2 gap-x-4 text-xs">
                                <p class="text-slate-500">P1 (â‚¬/kW/dÃ­a):</p><p class="font-mono font-bold text-right">${numPriceFormula(p1)}</p>
                                <p class="text-slate-500">P2 (â‚¬/kW/dÃ­a):</p><p class="font-mono font-bold text-right">${numPriceFormula(p2)}</p>
                                <p class="text-slate-500 mt-2 col-span-2 font-bold text-cta-green-600">${tr('ENERGÃA')} (â‚¬/kWh)</p>
                                <p class="text-slate-500">E1 (${tr('Punta')}):</p><p class="font-mono font-bold text-right">${numPriceFormula(e1)}</p>
                                <p class="text-slate-500">E2 (${tr('Llano')}):</p><p class="font-mono font-bold text-right">${numPriceFormula(e2)}</p>
                                <p class="text-slate-500">E3 (${tr('Valle')}):</p><p class="font-mono font-bold text-right">${numPriceFormula(e3)}</p>
                            </div>
                        </div>
                    `);
                });
            }

            // Add 3.0TD Prices - TODAS las ofertas Ãºnicas
            const offers30 = winningOffers['3.0TD'];
            const has30TD = individualResults.some(d => d.originalTariffType === '3.0TD');
            if (offers30 && offers30.length > 0 && has30TD) {
                offers30.forEach((offer30, index) => {
                    let pRows = '';
                    for(let i=1; i<=6; i++) {
                        pRows += `<p class="text-slate-500">P${i}:</p><p class="font-mono font-bold text-right">${numPriceFormula(offer30[`p_potencia_${i}`] / 365)}</p>`;
                    }
                    let eRows = '';
                    for(let i=1; i<=6; i++) {
                        eRows += `<p class="text-slate-500">E${i}:</p><p class="font-mono font-bold text-right">${numPriceFormula(offer30[`p${i}_price`])}</p>`;
                    }
                    const fullTariffName30 = `${offer30.name || 'Tarifa 3.0TD'} - ${offer30.description || 'N/A'}`;

                    consolidatedPrices.push(`
                        <div class="mb-4 p-3 bg-white rounded-lg border border-${basePrefix}-100">
                            <h5 class="font-black text-sm text-${color800} border-b pb-1 mb-2">Tarifa 3.0 TD #${index + 1} - ${fullTariffName30}</h5>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-x-4 text-xs">
                                <div class="col-span-2 md:col-span-4 font-bold text-cta-red-500 mb-1">${tr('POTENCIA')} (â‚¬/kW/dÃ­a)</div>
                                ${pRows}
                                <div class="col-span-2 md:col-span-4 font-bold text-cta-green-600 mt-2 mb-1 border-t pt-2">${tr('ENERGÃA')} (â‚¬/kWh)</div>
                                ${eRows}
                            </div>
                        </div>
                    `);
                });
            }

            if (consolidatedPrices.length > 0) {
                tariffPricesHTML = `
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-sm text-sm mb-6">
                        <h4 class="font-bold text-lg ${brandPrimaryText} mb-3">${priceSectionLabel}</h4>
                        ${consolidatedPrices.join('')}
                        <p class="text-xs text-slate-500 mt-2">*${tr('Los precios mostrados son de las ofertas ganadoras detectadas para cada tipo de tarifa y se aplican a las CUPS aÃ±adidas.')}</p>
                    </div>
                `;
            }

            // 5. Desglose detallado de CADA CUPS (Se mantiene)

            let allBreakdownsHTML = '';

            individualResults.forEach((resItem, index) => {
                const currentConfig = TARIFF_CONFIG[resItem.originalTariffType] || TARIFF_CONFIG['2.0TD'];
                const periods = currentConfig.periods;
                const powerPeriods = currentConfig.powerPeriods;
                
                // Determinar el nombre de la tarifa final aplicada
                // MODIFICACIÃ“N: Usar el campo con mÃ¡s informaciÃ³n para DRK
                const appliedOfferName = resItem.offer.isDrk 
                    ? ((resItem.offer.description?.length > resItem.offer.name?.length) 
                        ? resItem.offer.description 
                        : resItem.offer.name)
                    : resItem.offer.name;

                let energyBreakdown = '';
                resItem.energyCosts.forEach(e => {
                    let label = `E${e.period}`;
                    if (resItem.originalTariffType === '2.0TD') {
                        if (e.period === 1) label += ` (${tr('Punta')})`;
                        if (e.period === 2) label += ` (${tr('Llano')})`;
                        if (e.period === 3) label += ` (${tr('Valle')})`;
                    }
                    
                    if (e.period <= periods) {
                        energyBreakdown += `<div class="flex justify-between"><span>${label} (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)} â‚¬/kWh)</span><span>${num(e.cost, 2)} â‚¬</span></div>`;
                    }
                });

                let powerBreakdown = '';
                resItem.powerCosts.forEach(p => {
                    if (p.period <= powerPeriods) {
                        powerBreakdown += `<div class="flex justify-between"><span>P${p.period} (${num(p.kw, 2)} kW x ${numPriceFormula(p.priceDay)} â‚¬/dÃ­a)</span><span>${num(p.cost, 2)} â‚¬</span></div>`;
                    }
                });
                
                const statusText = resItem.isNegativeSavings ? 
                    `<p class="text-sm font-bold text-cta-red-600 mb-2">âš ï¸ ${tr('TU TARIFA ACTUAL es la mejor')}</p>` :
                    `<p class="text-sm font-bold text-cta-green-600 mb-2">ðŸ’° ${tr('AHORRO ANUAL')}: ${eur(resItem.savings)}</p>`;

                allBreakdownsHTML += `
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-lg text-sm">
                               <h4 class="text-lg font-black text-slate-800 border-b pb-2 mb-3">${tr('Suministro')} ${index + 1}: ${resItem.cups} (${resItem.originalTariffType})</h4>
                               ${statusText}
                               <p class="text-xs text-slate-500 mb-3">${tr('Tarifa aplicada en el cÃ¡lculo')}: <span class="font-bold text-slate-700">${appliedOfferName}</span></p>
                               <div class="grid grid-cols-2 gap-4 border-b border-slate-200 pb-3 mb-3">
                                   <div class="text-center">
                                       <p class="text-slate-400 text-xs uppercase">${tr('Factura Actual Periodo')}</p>
                                       <p class="font-bold text-cta-red-500">${eur(resItem.importe_total)}</p>
                                   </div>
                                   <div class="text-center">
                                       <p class="text-slate-400 text-xs uppercase">${tr('Nuevo Coste Periodo')}</p>
                                       <p class="font-black ${brand.PRIMARY_TEXT}">${eur(resItem.totalPeriod)}</p>
                                   </div>
                               </div>

                               <p class="font-bold text-slate-800 mb-2">${tr('Desglose')} (${appliedOfferName}):</p>
                               
                               <div class="pl-2 space-y-2 font-mono text-xs">
                                   <p class="font-bold text-slate-700">${tr('POTENCIA')}</p>
                                   ${powerBreakdown}
                                   <div class="flex justify-between font-bold text-slate-800 border-t pt-1"><span>${tr('Subtotal Potencia')}</span><span>${num(resItem.subPower, 2)} â‚¬</span></div>
                                   
                                   <p class="font-bold text-slate-700 pt-2">${tr('ENERGÃA')}</p>
                                   ${energyBreakdown}
                                   <div class="flex justify-between font-bold text-slate-800 border-t pt-1"><span>${tr('Subtotal EnergÃ­a (Neto)')}</span><span>${num(resItem.subEnergyNet, 2)} â‚¬</span></div>
                                   
                                   <div class="flex justify-between font-black ${brand.PRIMARY_TEXT} pt-2"><span>TOTAL CON IMPUESTOS</span><span>${eur(resItem.totalPeriod)}</span></div>
                               </div>
                    </div>
                `;
            });


            const detailsContainer = document.getElementById('details-container');

            detailsContainer.innerHTML = `
                ${supplySummarySection}
                <h3 id="extracted-data-header" class="text-lg font-bold text-slate-800 border-l-4 ${brand.BORDER.replace('border-', 'border-')} pl-3">Datos Acumulados</h3>
                <div id="user-consumption-details" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm text-sm">${correctedConsumptionHTML}</div>
                
                ${tariffPricesHTML}
                
                <h3 class="text-lg font-bold text-slate-800 border-l-4 border-green-500 pl-3" style="border-left-color: ${brand.QR_CENTER_BG};">${tr('Desglose Individual por Suministro')}</h3>
                <p class="text-sm text-slate-500 mb-4 pl-3">${tr('A continuaciÃ³n, se muestra el cÃ¡lculo detallado de la mejor oferta para cada CUPS, por orden de introducciÃ³n:')}</p>
                <div id="cost-breakdown-multi" class="space-y-4">
                    ${allBreakdownsHTML}
                </div>
            `;
        }
        
        /**
         * Rellena la vista de resultados con los datos calculados (UNIDAD).
         * @param {Object} res - Resultado final de la comparaciÃ³n.
         */
        // Nueva funciÃ³n para renderizar comparaciÃ³n dual (Fijo vs Indexado)
        function renderDualComparisonUI(resFijo, resIndexed) {
            console.log('ðŸ”¥ðŸ”¥ðŸ”¥ renderDualComparisonUI INICIADO ðŸ”¥ðŸ”¥ðŸ”¥');
            console.log('renderDualComparisonUI llamada', resFijo, resIndexed);
            
            // IMPORTANTE: Asegurar que las variables globales estÃ©n guardadas
            if (!lastComparisonResult) {
                lastComparisonResult = resFijo;
            }
            if (!lastIndexedResult) {
                lastIndexedResult = resIndexed;
            }
            
            const brand = activeBrand;
            const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            
            // CRÃTICO: Colores dinÃ¡micos segÃºn marca
            const isDrk = brand.NAME.includes('DRK');
            const brandPrefix = isDrk ? 'drk' : 'powercup';  // drk (azul) o powercup (verde)
            
            console.log('ðŸŽ¨ Marca detectada:', brand.NAME, '| isDrk:', isDrk, '| Prefix:', brandPrefix);
            console.log('ðŸŽ¨ Preparando para generar banner...');
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // BOTÃ“N ROJO DE VOLVER (RECARGA PÃGINA)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            let backButtonContainer = document.getElementById('back-button-top-container');
            if (!backButtonContainer) {
                backButtonContainer = document.createElement('div');
                backButtonContainer.id = 'back-button-top-container';
                backButtonContainer.className = 'fixed top-0 left-0 right-0 z-[100] bg-white shadow-lg p-3 border-b-4 border-red-500';
                backButtonContainer.innerHTML = `
                    <div class="max-w-lg mx-auto">
                        <button id="force-back-button" class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-black py-4 px-6 rounded-xl shadow-2xl transform transition active:scale-95 flex items-center justify-center gap-3 text-lg">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                            <span>â¬…ï¸ VOLVER AL INICIO</span>
                        </button>
                    </div>
                `;
                document.body.insertBefore(backButtonContainer, document.body.firstChild);
                
                document.getElementById('force-back-button').addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('ðŸ”„ RECARGANDO PÃGINA...');
                    window.location.reload();
                });
            }
            backButtonContainer.style.display = 'block';
            
            const resultsView = document.getElementById('results-view');
            if (resultsView) {
                resultsView.style.paddingTop = '80px';
            }
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // FIN BOTÃ“N ROJO
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            // Banner de empresa
            const companyBanner = document.getElementById('company-banner');
            
            // CRÃTICO: Usar colores dinÃ¡micos segÃºn marca
            if (isDrk) {
                // DRK - Banner mejorado y mÃ¡s grande
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-drk-900 via-drk-800 to-drk-700 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                            <div class="transform scale-125">
                                ${brand.LOGO_SVG}
                            </div>
                            <div class="text-center md:text-left">
                                <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">${brand.FULL_NAME}</h1>
                                <p class="text-drk-100 text-lg md:text-xl font-semibold">${tr('Liderando el ahorro y la eficiencia energÃ©tica')}</p>
                            </div>
                        </div>
                        <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">ðŸ“Š ESTUDIO DE AHORRO</p>
                            <p class="text-drk-100 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                            <p class="text-drk-100 text-base md:text-lg font-bold">${tr("PROFESIONAL")}</p>
                        </div>
                    </div>
                `;
            } else {
                // POWER CUP - Banner mejorado y mÃ¡s grande
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-powercup-700 via-powercup-600 to-powercup-500 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                            <div class="transform scale-125">
                                ${brand.LOGO_SVG}
                            </div>
                            <div class="text-center md:text-left">
                                <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">${brand.FULL_NAME}</h1>
                                <p class="text-powercup-50 text-lg md:text-xl font-semibold">AsesorÃ­a EnergÃ©tica</p>
                            </div>
                        </div>
                        <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">ðŸ“Š ESTUDIO DE AHORRO</p>
                            <p class="text-powercup-50 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                            <p class="text-powercup-50 text-base md:text-lg font-bold">${tr("PROFESIONAL")}</p>
                        </div>
                    </div>
                `;
                console.log('âœ… Banner POWER CUP GENERADO en renderDualComparisonUI');
            }
            
            console.log('ðŸŽ¨ Banner generado. Continuando con CUPS...');
            
            // CUPS
            document.getElementById('results-cups-list').innerHTML = `
                CUPS: <span class="font-mono text-slate-700">${resFijo.cups}</span>
            `;
            
            // Vista con TRES COLUMNAS
            const resultCard = document.getElementById('result-card');
            resultCard.innerHTML = `
                <div class="p-4">
                    <!-- TRES COLUMNAS -->
                    <div class="grid grid-cols-3 gap-3 mb-6">
                        <!-- COLUMNA 1: TU FACTURA ACTUAL -->
                        <div class="text-center">
                            <div class="bg-slate-600 text-white py-2 px-2 rounded-t-lg">
                                <p class="text-xs font-bold uppercase"${tr("TU FACTURA ACTUAL")}</p>
                            </div>
                            <div class="bg-white border-2 border-slate-300 rounded-b-lg p-3">
                                <p class="text-xs text-slate-500 mb-2 uppercase"${tr("TU FACTURA ACTUAL")}</p>
                                <p class="text-2xl font-black text-red-600 line-through mb-2">${eur(resFijo.originalBillPeriod || resFijo.importe_total)}</p>
                                <p class="text-xs text-slate-500 mb-3">${tr('Total Periodo')} (${resFijo.dias_facturados || 0} ${tr('dÃ­as')})</p>
                                <p class="text-2xl font-black text-red-600">${eur(resFijo.originalBillAnnual)}${tr("/aÃ±o")}</p>
                            </div>
                        </div>
                        
                        <!-- COLUMNA 2: LA MEJOR OPCIÃ“N - FIJO (Color de marca) -->
                        <div class="text-center">
                            <div class="${isDrk ? 'bg-drk-600' : 'bg-powercup-600'} text-white py-2 px-2 rounded-t-lg">
                                <p class="text-xs font-bold uppercase">LA MEJOR OPCIÃ“N PARA TI ES ${isDrk ? 'DRK' : 'POWER CUP'}</p>
                            </div>
                            <div class="${isDrk ? 'bg-drk-50 border-drk-400' : 'bg-powercup-50 border-powercup-400'} border-2 rounded-b-lg p-3">
                                <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} mb-2 font-bold">${resFijo.offer.name}</p>
                                <p class="text-2xl font-black ${isDrk ? 'text-drk-900' : 'text-powercup-900'} mb-2">${eur(resFijo.totalAnnual / 12)}${tr("/mes")}</p>
                                <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} mb-3"${tr("Estimado Mensual")}</p>
                                <p class="text-2xl font-black ${isDrk ? 'text-drk-900' : 'text-powercup-900'}">${eur(resFijo.totalAnnual)}${tr("/aÃ±o")}</p>
                            </div>
                        </div>
                        
                        <!-- COLUMNA 3: LA MEJOR OPCIÃ“N PARA TI ES [MARCA] (INDEXADO) -->
                        <div class="text-center">
                            <div class="bg-green-600 text-white py-2 px-2 rounded-t-lg">
                                <p class="text-xs font-bold uppercase">LA MEJOR OPCIÃ“N PARA TI ES ${isDrk ? 'DRK' : 'POWER CUP'}</p>
                            </div>
                            <div class="bg-green-50 border-2 border-green-400 rounded-b-lg p-3">
                                <p class="text-xs text-green-700 mb-2 font-bold">${resIndexed.offer.name}</p>
                                <p class="text-2xl font-black text-green-900 mb-2">${eur(resIndexed.totalAnnual / 12)}${tr("/mes")}</p>
                                <p class="text-xs text-green-700 mb-3"${tr("Estimado Mensual")}</p>
                                <p class="text-2xl font-black text-green-900">${eur(resIndexed.totalAnnual)}${tr("/aÃ±o")}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AHORROS -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="${isDrk ? 'bg-drk-100 border-drk-400' : 'bg-powercup-100 border-powercup-400'} border-2 rounded-xl p-4 text-center">
                            <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} font-bold uppercase mb-2">ðŸ’¼ TU AHORRO CON TARIFA FIJA</p>
                            <p class="text-4xl font-black text-green-600">${eur(resFijo.savings)}</p>
                            <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} mt-1">Ahorro anual estimado</p>
                        </div>
                        <div class="bg-green-100 border-2 border-green-400 rounded-xl p-4 text-center">
                            <p class="text-xs text-green-700 font-bold uppercase mb-2">âš¡ TU AHORRO CON TARIFA INDEXADA</p>
                            <p class="text-4xl font-black text-green-600">${eur(resIndexed.savings)}</p>
                            <p class="text-xs text-green-700 mt-1">Ahorro anual estimado</p>
                        </div>
                    </div>
                    
                    <!-- NOTA IMPORTANTE -->
                    <div class="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-4 mb-6">
                        <p class="text-sm text-yellow-900">
                            <strong>âš ï¸ Importante:</strong> La tarifa indexada puede variar mensualmente segÃºn el mercado elÃ©ctrico. 
                            Los valores mostrados son estimaciones basadas en precios actuales.
                        </p>
                    </div>
                </div>
            `;
            
            // Configurar el botÃ³n existente (NO crear uno nuevo)
            const sendOfferBtn = document.getElementById('send-offer-btn');
            if (sendOfferBtn) {
                sendOfferBtn.style.display = 'flex'; // Asegurar que estÃ© visible
                sendOfferBtn.onclick = () => {
                    document.getElementById('send-offer-modal').classList.remove('hidden');
                    document.getElementById('send-offer-modal').classList.add('flex');
                    document.querySelectorAll('#send-offer-modal input').forEach(input => {
                        input.classList.remove('focus:ring-drk-500', 'focus:ring-powercup-500');
                        input.classList.add(activeBrand.NAME.includes('DRK') ? 'focus:ring-drk-500' : 'focus:ring-powercup-500');
                    });
                };
            }
            
            // Ocultar detalles
            document.getElementById('details-toggle-btn').style.display = 'none';
            document.getElementById('details-container').style.display = 'none';
            
            // IMPORTANTE: Asegurar que el botÃ³n "Realizar Nueva ComparaciÃ³n" estÃ© visible y funcional
            const resetButton = document.querySelector('#results-view button[onclick="resetToLanding()"]');
            if (resetButton) {
                resetButton.style.display = 'flex';
                resetButton.style.visibility = 'visible';
                resetButton.classList.remove('hidden');
            }
        }
        function renderResultsUI(res, resIndexed = null) {
            // Si hay resultado indexado, usar vista de comparaciÃ³n dual
            if (resIndexed) {
                renderDualComparisonUI(res, resIndexed);
                return;
            }
            
            // Si no hay resultado indexado, renderizar como siempre
            try {
                console.log('renderResultsUI called with:', res);
                
                const offer = res.offer;
                const brand = activeBrand;
                const isDrk = brand.NAME.includes('DRK');
                const tariffType = res.tariffType || currentTariffType;
                // Usamos TARIFF_CONFIG[tariffType] y si no existe (ej: 6.1TD residual), se usa un fallback seguro, aunque ya hemos limpiado el estado
                const config = TARIFF_CONFIG[tariffType] || TARIFF_CONFIG['2.0TD']; 

                console.log('Rendering with tariffType:', tariffType, 'Brand:', brand.NAME);

            // FIX: Usar funciones robustas contra NaN
            const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
            
            // NUEVO: Generar banner de empresa dinÃ¡mico
            const companyBanner = document.getElementById('company-banner');
            if (isDrk) {
                // DRK - Banner mejorado
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-drk-900 via-drk-800 to-drk-700 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                            <div class="transform scale-125">
                                ${brand.LOGO_SVG}
                            </div>
                            <div class="text-center md:text-left">
                                <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">DRK ENERGÃA</h1>
                                <p class="text-drk-100 text-lg md:text-xl font-semibold">${tr('Liderando el ahorro y la eficiencia energÃ©tica')}</p>
                            </div>
                        </div>
                        <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">ðŸ“Š ESTUDIO DE AHORRO</p>
                            <p class="text-drk-100 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                            <p class="text-drk-100 text-base md:text-lg font-bold">${tr("PROFESIONAL")}</p>
                        </div>
                    </div>
                `;
            } else {
                // POWER CUP - Banner mejorado
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-powercup-700 via-powercup-600 to-powercup-500 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                            <div class="transform scale-125">
                                ${brand.LOGO_SVG}
                            </div>
                            <div class="text-center md:text-left">
                                <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">POWER CUP</h1>
                                <p class="text-powercup-50 text-lg md:text-xl font-semibold">AsesorÃ­a EnergÃ©tica</p>
                            </div>
                        </div>
                        <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">ðŸ“Š ESTUDIO DE AHORRO</p>
                            <p class="text-powercup-50 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                            <p class="text-powercup-50 text-base md:text-lg font-bold">${tr("PROFESIONAL")}</p>
                        </div>
                    </div>
                `;
            }
            
            // 1. Cabecera y Resumen
            document.getElementById('results-cups-list').innerHTML = `
                CUPS: <span class="font-mono text-slate-700" id="cups-value">${res.cups}</span>
            `;
            
            // MODIFICACIÃ“N: Mostrar Comercializadora - Tarifa
            document.getElementById('best-offer-name').textContent = `${offer.name || ''}`;
            document.getElementById('best-offer-desc').textContent = offer.description;
            
            const savingsEl = document.getElementById('savings-estimate');
            const newCostLabelEl = document.getElementById('new-cost-label');
            const oldCostPeriodEl = document.getElementById('old-period-cost-display');
            const oldCostAnnualEl = document.getElementById('old-annual-cost-display');

            // Resetear clases de color dinÃ¡micas
            savingsEl.className = 'text-5xl font-black tracking-tight';
            oldCostPeriodEl.classList.remove('line-through', 'text-red-400', 'text-cta-green-500', 'decoration-red-400/50');
            oldCostAnnualEl.classList.remove('line-through', 'text-cta-red-500', 'text-cta-green-500', 'decoration-cta-red-500/50');

            if (res.isNegativeSavings) {
                // Mensaje especial cuando no hay ahorro
                document.getElementById('savings-label').textContent = "Â¡ENHORABUENA!";
                savingsEl.innerHTML = `<div class="text-lg leading-tight font-bold">${tr("Actualmente estÃ¡s en una buena tarifa.")}</div><div class="text-sm mt-3 leading-relaxed">${tr("Seguiremos estudiando el mercado y te avisaremos cuando encontremos alguna tarifa que se adapte a tu perfil de consumo.")}</div>`;
                const colorClass = brand.PRIMARY_TEXT.replace('text-', '');
                savingsEl.classList.add('text-' + colorClass);
                savingsEl.classList.remove('text-5xl', 'font-black');
                savingsEl.classList.add('text-base');
                
                // Ocultar columnas de precios
                document.getElementById('price-columns').style.display = 'none';
                
                // NUEVO: Mostrar botÃ³n para solicitar mejora a DRK
                document.getElementById('request-improvement-btn').style.display = 'flex';
                
                newCostLabelEl.textContent = "TU COSTE ACTUAL";
                
                // Si no hay ahorro, el coste actual es el "bueno", sin tachar
                oldCostPeriodEl.classList.remove('line-through');
                oldCostPeriodEl.classList.add('text-cta-green-500');
                oldCostAnnualEl.classList.remove('line-through');
                oldCostAnnualEl.classList.add('text-cta-green-500');

            } else {
                document.getElementById('savings-label').textContent = "TU AHORRO ANUAL ESTIMADO";
                savingsEl.textContent = eur(res.savings);
                savingsEl.classList.add('text-cta-green-500');
                savingsEl.classList.add('text-5xl', 'font-black');
                savingsEl.classList.remove('text-base');
                
                // Mostrar columnas de precios
                document.getElementById('price-columns').style.display = 'grid';
                
                // Ocultar botÃ³n de solicitar mejora
                document.getElementById('request-improvement-btn').style.display = 'none';
                
                newCostLabelEl.textContent = `TU NUEVO COSTE ${isDrk ? 'DRK' : 'POWER CUP'}`;
                
                // Tachar el coste antiguo
                oldCostPeriodEl.classList.add('line-through', 'text-cta-red-500', 'decoration-cta-red-500/50');
                oldCostAnnualEl.classList.add('line-through', 'text-cta-red-500', 'decoration-cta-red-500/50');
            }
            
            document.getElementById('old-period-cost-display').textContent = eur(res.importe_total);
            document.getElementById('old-annual-cost-display').textContent = eur(res.originalBillAnnual) + tr('/aÃ±o');
            document.getElementById('old-period-days-label').textContent = `${tr('Total Periodo')} (${res.dias_facturados} ${tr('dÃ­as')})`;
            
            document.getElementById('new-monthly-cost-display').textContent = eur(res.totalAnnual / 12) + tr('/mes');
            document.getElementById('new-annual-cost-display').textContent = eur(res.totalAnnual) + tr('/aÃ±o');
            
            // 2. Desglose (Datos ExtraÃ­dos)
            // CRÃTICO: Solo renderizar desglose si hay datos vÃ¡lidos (no es un placeholder sin ahorro)
            let consumptionHTML = '';
            
            if (!res.isNegativeSavings && res.energyCosts && res.powerCosts && res.energyCosts.length > 0 && res.powerCosts.length > 0) {
                let energyRows = '';
                res.energyCosts.forEach(e => {
                    let label = `E${e.period}`;
                    if (tariffType === '2.0TD') {
                        if (e.period === 1) label += ` (${tr('Punta')})`;
                        if (e.period === 2) label += ` (${tr('Llano')})`;
                        if (e.period === 3) label += ` (${tr('Valle')})`;
                    }
                    if(e.kwh > 0 || e.period <= config.periods) {
                        energyRows += `<div class="flex justify-between text-xs mb-1"><span>${label}</span><span class="font-mono">${num(e.kwh, 0)} kWh</span></div>`;
                    }
                });
                const totalEnergy = res.energyCosts.reduce((sum, e) => sum + e.kwh, 0);

                let powerRows = '';
                res.powerCosts.forEach(p => {
                    if(p.kw > 0 || p.period <= config.powerPeriods) {
                        powerRows += `<div class="flex justify-between text-xs mb-1"><span>P${p.period}</span><span class="font-mono">${num(p.kw, 2)} kW</span></div>`;
                    }
                });

                consumptionHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div><p class="text-xs text-slate-500">${tr('Periodo')}</p><p class="font-bold text-slate-700">${res.dias_facturados} ${tr('dÃ­as')}</p></div>
                        <div><p class="text-xs text-slate-500">${tr('Fechas')}</p><p class="font-bold text-slate-700 text-xs">${res.fechas}</p></div>
                        <div class="col-span-2 border-t pt-2 mt-2">
                            <p class="font-bold ${brand.PRIMARY_TEXT} mb-2">${tr('Consumo por Periodo (kWh)')}</p>
                            ${energyRows}
                            <div class="flex justify-between font-bold ${brand.PRIMARY_TEXT} mt-1 border-t pt-1"><span>${tr('Total Consumo')}</span><span>${num(totalEnergy, 0)} kWh</span></div>  
                        </div>
                        <div class="col-span-2">
                            <p class="font-bold ${brand.PRIMARY_TEXT} mb-2">${tr('Potencia Contratada (kW)')}</p>
                            ${powerRows}
                        </div>
                    </div>
                `;
            } else {
                // Si no hay datos vÃ¡lidos, mostrar mensaje alternativo
                consumptionHTML = `
                    <div class="text-center py-4">
                        <p class="text-slate-500 text-sm">${tr('Desglose no disponible para esta tarifa')}</p>
                    </div>
                `;
            }

            // 3. Desglose (CÃ¡lculo Oficial)
            let powerBreakdown = '';
            let energyBreakdown = '';
            
            if (!res.isNegativeSavings && res.powerCosts && res.energyCosts && res.powerCosts.length > 0 && res.energyCosts.length > 0) {
                res.powerCosts.forEach(p => {
                    if (p.kw > 0 || p.period <= config.powerPeriods) {
                        powerBreakdown += `<div class="flex justify-between"><span>P${p.period} (${num(p.kw, 2)} kW x ${numPriceFormula(p.priceDay)} â‚¬/dÃ­a)</span><span>${num(p.cost, 2)} â‚¬</span></div>`;
                    }
                });
                
                res.energyCosts.forEach(e => {
                    if (e.kwh > 0 || e.period <= config.periods) {
                        let label = `E${e.period}`;
                        if (tariffType === '2.0TD') {
                            if (e.period === 1) label += ` (${tr('Punta')})`;
                            if (e.period === 2) label += ` (${tr('Llano')})`;
                            if (e.period === 3) label += ` (${tr('Valle')})`;
                        }
                        energyBreakdown += `<div class="flex justify-between"><span>${label} (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)} â‚¬/kWh)</span><span>${num(e.cost, 2)} â‚¬</span></div>`;
                    }
                });
            }

            let discountRowsHtml = '';
            let breakdownHTML = '';
            
            if (!res.isNegativeSavings && res.powerCosts && res.energyCosts && res.powerCosts.length > 0 && res.energyCosts.length > 0) {
                discountRowsHtml = res.discountAmount > 0 ? `
                    <div class="flex justify-between font-bold text-cta-red-500 mt-2">
                        <span>Descuento Aplicado (${num(res.discountRate * 100, 0)}%)</span>
                        <span>-${num(res.discountAmount, 2)} â‚¬</span>
                    </div>
                    <div class="flex justify-between font-bold text-slate-800 border-t border-dashed mt-1 pt-1">
                        <span>Subtotal EnergÃ­a (Neto)</span>
                        <span>${num(res.subEnergyNet, 2)} â‚¬</span>
                    </div>
                ` : '';

                breakdownHTML = `
                    <div class="bg-white p-6 font-mono text-xs md:text-sm text-slate-600 leading-relaxed">
                        <div class="text-center border-b-2 border-dashed border-slate-300 pb-4 mb-4">
                            <h4 class="font-bold text-lg text-slate-800 uppercase">${offer.name}</h4>
                            <p>${tr('SimulaciÃ³n')} ${res.dias_facturados} ${tr('dÃ­as')}</p>
                        </div>
                        
                        <div class="mb-4">
                            <p class="font-bold text-slate-800 mb-1">${tr('POTENCIA')} (â‚¬/kW ${tr('DÃ­a')})</p>
                            ${powerBreakdown}
                            <div class="flex justify-between font-bold ${brand.SECONDARY_TEXT} border-t mt-1 pt-1"><span>${tr('Subtotal Potencia')}</span><span>${num(res.subPower, 2)} â‚¬</span></div>
                        </div>

                        <div class="mb-4">
                            <p class="font-bold text-slate-800 mb-1">${tr('ENERGÃA')} (â‚¬/kWh)</p>
                            ${energyBreakdown}
                            <div class="flex justify-between font-bold ${brand.SECONDARY_TEXT} border-t mt-1 pt-1"><span${tr("Subtotal EnergÃ­a (Bruto)")}</span><span>${num(res.subEnergy, 2)} â‚¬</span></div>
                            ${discountRowsHtml}
                        </div>

                        <div class="border-t border-slate-200 pt-2 mb-2">
                            <div class="flex justify-between font-bold text-slate-800"><span${tr("SUBTOTAL BASE (P+E)")}</span><span>${num(res.subBase, 2)} â‚¬</span></div>
                            <div class="flex justify-between"><span>${tr('Imp. ElÃ©c.')} (${num(res.ieRate * 100, 3)}%)</span><span>${num(res.costIE, 2)} â‚¬</span></div>
                            <div class="flex justify-between font-bold text-lg border-t mt-1 pt-1"><span${tr("BASE IMPONIBLE")}</span><span>${num(res.baseImp, 2)} â‚¬</span></div>
                            <div class="flex justify-between"><span>IVA (21%)</span><span>${num(res.costIVA, 2)} â‚¬</span></div>
                        </div>
                        
                        <div class="bg-drk-900 text-white p-3 rounded-lg flex justify-between items-center text-md font-bold mb-1 mt-4"><span>${tr("TOTAL FACTURA")}</span><span>${eur(res.totalPeriod)}</span></div>
                        <div class="text-center mt-2 ${brand.PRIMARY_TEXT} font-bold">${tr("Total Anual Estimado")}: ${eur(res.totalAnnual)}</div>
                    </div>
                `;
            } else {
                // Si no hay datos vÃ¡lidos para el desglose
                breakdownHTML = `
                    <div class="bg-white p-6 text-center">
                        <p class="text-slate-500">${tr('Desglose no disponible')}</p>
                    </div>
                `;
            }
            
            // NUEVO: Generar resumen de precios consolidados
            let preciosHTML = '';
            if (offer.name !== 'Tu Tarifa Actual' && !res.isNegativeSavings && res.powerCosts && res.energyCosts && res.powerCosts.length > 0 && res.energyCosts.length > 0) {
                const nombreCompleto = offer.isDrk 
                    ? ((offer.description?.length > offer.name?.length) ? offer.description : offer.name)
                    : offer.name;
                
                if (tariffType === '2.0TD') {
                    preciosHTML = `
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-sm text-sm mb-6">
                            <h4 class="font-bold text-lg text-slate-800 mb-3">${tr('Precios de la Oferta Consolidada')}</h4>
                            <div class="p-3 bg-white rounded-lg border border-slate-200">
                                <h5 class="font-black text-sm text-slate-700 border-b pb-1 mb-2">${tr('Tarifa')} 2.0 TD - ${nombreCompleto}</h5>
                                <div class="grid grid-cols-2 gap-x-4 text-xs">
                                    <p class="text-slate-500">P1 (â‚¬/kW/${tr('dÃ­a')}):</p>
                                    <p class="font-mono font-bold text-right">${numPriceFormula(res.powerCosts[0].priceDay)}</p>
                                    <p class="text-slate-500">P2 (â‚¬/kW/${tr('dÃ­a')}):</p>
                                    <p class="font-mono font-bold text-right">${numPriceFormula(res.powerCosts[1].priceDay)}</p>
                                    <p class="text-slate-500 mt-2 col-span-2 font-bold text-green-600">${tr('ENERGÃA')} (â‚¬/kWh)</p>
                                    <p class="text-slate-500">E1 (${tr('Punta')}):</p>
                                    <p class="font-mono font-bold text-right">${numPriceFormula(res.energyCosts[0].price)}</p>
                                    <p class="text-slate-500">E2 (${tr('Llano')}):</p>
                                    <p class="font-mono font-bold text-right">${numPriceFormula(res.energyCosts[1].price)}</p>
                                    <p class="text-slate-500">E3 (${tr('Valle')}):</p>
                                    <p class="font-mono font-bold text-right">${numPriceFormula(res.energyCosts[2].price)}</p>
                                </div>
                            </div>
                            <p class="text-xs text-slate-500 mt-2">*${tr('Los precios mostrados son de la oferta ganadora.')}</p>
                        </div>
                    `;
                } else if (tariffType === '3.0TD') {
                    let filasPotencia = '';
                    for(let i = 0; i < 6; i++) {
                        filasPotencia += `<p class="text-slate-500">P${i+1}:</p><p class="font-mono font-bold text-right">${numPriceFormula(res.powerCosts[i].priceDay)}</p>`;
                    }
                    let filasEnergia = '';
                    for(let i = 0; i < 6; i++) {
                        filasEnergia += `<p class="text-slate-500">E${i+1}:</p><p class="font-mono font-bold text-right">${numPriceFormula(res.energyCosts[i].price)}</p>`;
                    }
                    
                    preciosHTML = `
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-sm text-sm mb-6">
                            <h4 class="font-bold text-lg text-slate-800 mb-3">Precios de la Oferta Consolidada</h4>
                            <div class="p-3 bg-white rounded-lg border border-slate-200">
                                <h5 class="font-black text-sm text-slate-700 border-b pb-1 mb-2">Tarifa 3.0 TD - ${nombreCompleto}</h5>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-x-4 text-xs">
                                    <div class="col-span-2 md:col-span-4 font-bold text-red-500 mb-1">${tr('POTENCIA')} (â‚¬/kW/dÃ­a)</div>
                                    ${filasPotencia}
                                    <div class="col-span-2 md:col-span-4 font-bold text-green-600 mt-2 mb-1 border-t pt-2">${tr('ENERGÃA')} (â‚¬/kWh)</div>
                                    ${filasEnergia}
                                </div>
                            </div>
                            <p class="text-xs text-slate-500 mt-2">*Los precios mostrados son de la oferta ganadora.</p>
                        </div>
                    `;
                }
            }
            
            // Calcular distribuciÃ³n de consumo para 2.0 TD (para anÃ¡lisis de horarios)
            let scheduleAnalysisHTML = '';
            let navigationMenuHTML = '';
            
            if (tariffType === '2.0TD') {
                // Calcular kWh por perÃ­odo
                const puntaKwh = res.energyCosts[0]?.kwh || 0;
                const llanoKwh = res.energyCosts[1]?.kwh || 0;
                const valleKwh = res.energyCosts[2]?.kwh || 0;
                const totalKwh = puntaKwh + llanoKwh + valleKwh;
                
                const puntaPct = totalKwh > 0 ? (puntaKwh / totalKwh * 100).toFixed(1) : 0;
                const llanoPct = totalKwh > 0 ? (llanoKwh / totalKwh * 100).toFixed(1) : 0;
                const vallePct = totalKwh > 0 ? (valleKwh / totalKwh * 100).toFixed(1) : 0;
                
                // MenÃº de navegaciÃ³n con anÃ¡lisis de horarios
                navigationMenuHTML = `
                    <div id="sections-nav" class="sticky top-0 z-50 bg-white border-b-2 border-slate-200 shadow-md mb-6">
                        <div class="relative">
                            <!-- BotÃ³n Flecha Izquierda -->
                            <button onclick="scrollTabs('left')" 
                                    class="absolute left-0 top-0 bottom-0 z-10 bg-gradient-to-r from-white to-transparent hover:from-slate-100 px-2 text-slate-600 hover:text-drk-600 transition-colors"
                                    style="box-shadow: 2px 0 8px rgba(0,0,0,0.1);">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                                </svg>
                            </button>
                            
                            <!-- Contenedor de tabs con scroll -->
                            <div id="tabs-container" class="flex overflow-x-auto scrollbar-hide scroll-smooth" style="scroll-behavior: smooth;">
                                <button onclick="showSection('analisis')" id="btn-analisis"
                                        class="section-tab flex-1 min-w-fit px-4 py-3 text-sm font-semibold text-slate-600 hover:text-drk-600 hover:bg-drk-50 border-b-3 border-transparent transition-all whitespace-nowrap">
                                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    ${tr('AnÃ¡lisis de Horarios')}
                                </button>
                                <button onclick="showSection('datos-extraidos')" id="btn-datos-extraidos"
                                        class="section-tab flex-1 min-w-fit px-4 py-3 text-sm font-semibold text-slate-600 hover:text-drk-600 hover:bg-drk-50 border-b-3 border-transparent transition-all whitespace-nowrap">
                                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                    ${tr('Datos ExtraÃ­dos')}
                                </button>
                                <button onclick="showSection('precios')" id="btn-precios"
                                        class="section-tab flex-1 min-w-fit px-4 py-3 text-sm font-semibold text-slate-600 hover:text-drk-600 hover:bg-drk-50 border-b-3 border-transparent transition-all whitespace-nowrap">
                                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    ${tr('Precios Ofertas')}
                                </button>
                                <button onclick="showSection('calculo')" id="btn-calculo"
                                        class="section-tab flex-1 min-w-fit px-4 py-3 text-sm font-semibold text-slate-600 hover:text-drk-600 hover:bg-drk-50 border-b-3 border-transparent transition-all whitespace-nowrap">
                                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                                    ${tr('CÃ¡lculo Oficial')}
                                </button>
                            </div>
                            
                            <!-- BotÃ³n Flecha Derecha -->
                            <button onclick="scrollTabs('right')" 
                                    class="absolute right-0 top-0 bottom-0 z-10 bg-gradient-to-l from-white to-transparent hover:from-slate-100 px-2 text-slate-600 hover:text-drk-600 transition-colors"
                                    style="box-shadow: -2px 0 8px rgba(0,0,0,0.1);">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                
                scheduleAnalysisHTML = `
                    <div id="section-analisis" class="section-content mb-8 bg-gradient-to-br from-slate-50 to-slate-100 p-6 rounded-2xl border-2 border-slate-200 shadow-lg" style="display: block;">
                        <h3 class="text-xl font-black text-slate-800 mb-6 flex items-center gap-3">
                            <svg class="w-6 h-6 text-drk-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            ${tr('AnÃ¡lisis de Horarios y Consumo - Tarifa 2.0 TD')}
                        </h3>
                        
                        <!-- InformaciÃ³n de Horarios en formato compacto -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div class="bg-white p-4 rounded-xl shadow-md border border-slate-200">
                                <h4 class="text-center font-bold text-slate-700 mb-3">${tr('Lunes a viernes laborables')}</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex items-center gap-2 p-2 bg-red-50 rounded"><span class="w-3 h-3 rounded-full bg-red-600 flex-shrink-0"></span><span class="font-semibold text-red-700">${tr('Punta')}:</span><span class="text-slate-600">10-14h, 18-22h</span></div>
                                    <div class="flex items-center gap-2 p-2 bg-yellow-50 rounded"><span class="w-3 h-3 rounded-full bg-yellow-400 flex-shrink-0"></span><span class="font-semibold text-yellow-700">${tr('Llano')}:</span><span class="text-slate-600">8-10h, 14-18h, 22-24h</span></div>
                                    <div class="flex items-center gap-2 p-2 bg-green-50 rounded"><span class="w-3 h-3 rounded-full bg-green-600 flex-shrink-0"></span><span class="font-semibold text-green-700">${tr('Valle')}:</span><span class="text-slate-600">0-8h</span></div>
                                </div>
                            </div>
                            
                            <div class="bg-white p-4 rounded-xl shadow-md border border-slate-200">
                                <h4 class="text-center font-bold text-slate-700 mb-3">${tr('SÃ¡bados, domingos y festivos')}</h4>
                                <div class="flex items-center justify-center h-full">
                                    <div class="text-center p-4 bg-green-50 rounded-lg w-full">
                                        <div class="flex items-center justify-center gap-2 mb-2">
                                            <span class="w-4 h-4 rounded-full bg-green-600"></span>
                                            <span class="font-bold text-green-700 text-lg">${tr('Valle')}</span>
                                        </div>
                                        <p class="text-sm text-slate-600">24 horas (todo el dÃ­a)</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AnÃ¡lisis de Consumo -->
                        <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200">
                            <h4 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                                <svg class="w-5 h-5 text-drk-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                                ${tr('Tu DistribuciÃ³n de Consumo')}
                            </h4>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <!-- Punta -->
                                <div class="text-center p-4 bg-red-50 rounded-lg border-2 border-red-200">
                                    <div class="flex items-center justify-center gap-2 mb-2">
                                        <div class="w-4 h-4 rounded-full bg-red-600"></div>
                                        <h5 class="font-bold text-red-700">${tr('Periodo Punta')}</h5>
                                    </div>
                                    <div class="text-3xl font-black text-red-600 mb-1">${puntaPct}%</div>
                                    <div class="text-sm text-slate-600 mb-2">${num(puntaKwh, 0)} kWh</div>
                                    <div class="text-xs text-slate-500 bg-white p-2 rounded">${tr('Horario mÃ¡s caro')}<br>10-14h, 18-22h (lab.)</div>
                                </div>
                                
                                <!-- Llano -->
                                <div class="text-center p-4 bg-yellow-50 rounded-lg border-2 border-yellow-300">
                                    <div class="flex items-center justify-center gap-2 mb-2">
                                        <div class="w-4 h-4 rounded-full bg-yellow-400"></div>
                                        <h5 class="font-bold text-yellow-700">${tr('Periodo Llano')}</h5>
                                    </div>
                                    <div class="text-3xl font-black text-yellow-600 mb-1">${llanoPct}%</div>
                                    <div class="text-sm text-slate-600 mb-2">${num(llanoKwh, 0)} kWh</div>
                                    <div class="text-xs text-slate-500 bg-white p-2 rounded">${tr('Horario intermedio')}<br>8-10h, 14-18h, 22-24h</div>
                                </div>
                                
                                <!-- Valle -->
                                <div class="text-center p-4 bg-green-50 rounded-lg border-2 border-green-200">
                                    <div class="flex items-center justify-center gap-2 mb-2">
                                        <div class="w-4 h-4 rounded-full bg-green-600"></div>
                                        <h5 class="font-bold text-green-700">${tr('Periodo Valle')}</h5>
                                    </div>
                                    <div class="text-3xl font-black text-green-600 mb-1">${vallePct}%</div>
                                    <div class="text-sm text-slate-600 mb-2">${num(valleKwh, 0)} kWh</div>
                                    <div class="text-xs text-slate-500 bg-white p-2 rounded">${tr('Horario mÃ¡s barato')}<br>0-8h + fines semana</div>
                                </div>
                            </div>
                            
                            <!-- Barra de progreso visual -->
                            <div class="mb-4">
                                <div class="flex h-8 rounded-lg overflow-hidden shadow-inner">
                                    <div class="bg-red-600 flex items-center justify-center text-white text-xs font-bold" 
                                         style="width: ${puntaPct}%">${puntaPct > 8 ? puntaPct + '%' : ''}</div>
                                    <div class="bg-yellow-400 flex items-center justify-center text-slate-800 text-xs font-bold" 
                                         style="width: ${llanoPct}%">${llanoPct > 8 ? llanoPct + '%' : ''}</div>
                                    <div class="bg-green-600 flex items-center justify-center text-white text-xs font-bold" 
                                         style="width: ${vallePct}%">${vallePct > 8 ? vallePct + '%' : ''}</div>
                                </div>
                            </div>
                            
                            <!-- Consejo personalizado -->
                            <div class="bg-blue-50 border-l-4 border-drk-600 p-4 rounded-r-lg">
                                <div class="flex items-start gap-3">
                                    <svg class="w-6 h-6 text-drk-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>
                                    <div>
                                        <h5 class="font-bold text-drk-800 mb-1">${tr('RecomendaciÃ³n Personalizada')}</h5>
                                        <p class="text-sm text-slate-700">
                                            ${puntaPct > 30 
                                                ? tr('Consumes mÃ¡s del 30% en horario Punta. Te recomendamos trasladar consumos al periodo Valle (madrugada y fines de semana) para maximizar tu ahorro.')
                                                : vallePct > 50
                                                    ? tr('Â¡Excelente! MÃ¡s del 50% de tu consumo estÃ¡ en Valle, el periodo mÃ¡s econÃ³mico. Sigue asÃ­ para maximizar tu ahorro.')
                                                    : tr('Tu consumo estÃ¡ bien distribuido. Considera trasladar mÃ¡s consumo al periodo Valle para aumentar tu ahorro.')}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // MenÃº de navegaciÃ³n SIN anÃ¡lisis de horarios (para tarifas 3.0TD, etc.)
                navigationMenuHTML = `
                    <div id="sections-nav" class="sticky top-0 z-50 bg-white border-b-2 border-slate-200 shadow-md mb-6">
                        <div class="flex overflow-x-auto scrollbar-hide">
                            <button onclick="showSection('datos-extraidos')" id="btn-datos-extraidos"
                                    class="section-tab flex-1 min-w-fit px-4 py-3 text-sm font-semibold text-slate-600 hover:text-drk-600 hover:bg-drk-50 border-b-3 border-transparent transition-all whitespace-nowrap">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                ${tr('Datos ExtraÃ­dos')}
                            </button>
                            <button onclick="showSection('precios')" id="btn-precios"
                                    class="section-tab flex-1 min-w-fit px-4 py-3 text-sm font-semibold text-slate-600 hover:text-drk-600 hover:bg-drk-50 border-b-3 border-transparent transition-all whitespace-nowrap">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                ${tr('Precios Ofertas')}
                            </button>
                            <button onclick="showSection('calculo')" id="btn-calculo"
                                    class="section-tab flex-1 min-w-fit px-4 py-3 text-sm font-semibold text-slate-600 hover:text-drk-600 hover:bg-drk-50 border-b-3 border-transparent transition-all whitespace-nowrap">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                                ${tr('CÃ¡lculo Oficial')}
                            </button>
                        </div>
                    </div>
                `;
            }

            const detailsContainer = document.getElementById('details-container');

            detailsContainer.innerHTML = `
                ${navigationMenuHTML}
                ${scheduleAnalysisHTML}
                <div id="section-datos-extraidos" class="section-content" style="display: ${tariffType === '2.0TD' ? 'none' : 'block'};">
                    <h3 class="text-lg font-bold text-slate-800 border-l-4 ${brand.BORDER.replace('border-', 'border-')} pl-3 mb-4">${tr('Datos ExtraÃ­dos')}</h3>
                    <div id="user-consumption-details" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm text-sm">${consumptionHTML}</div>
                </div>
                <div id="section-precios" class="section-content" style="display: none;">${preciosHTML}</div>
                <div id="section-calculo" class="section-content" style="display: none;">
                    <h3 class="text-lg font-bold text-slate-800 border-l-4 border-green-500 pl-3 mb-4" style="border-left-color: ${brand.QR_CENTER_BG};">${tr('CÃ¡lculo Oficial')}</h3>
                    <div id="cost-breakdown" class="bg-white p-0 rounded-xl border border-slate-200 shadow-sm overflow-hidden text-sm">
                        ${breakdownHTML}
                    </div>
                </div>
            `;
            
            console.log('renderResultsUI completed successfully');
            } catch (error) {
                console.error('Error in renderResultsUI:', error);
                window.showErrorModal(`Error al mostrar resultados: ${error.message}`);
            }
        }
        
        // === FUNCIÃ“N PARA NAVEGACIÃ“N POR PESTAÃ‘AS ===
        window.showSection = function(sectionName) {
            // Ocultar todas las secciones
            const sections = document.querySelectorAll('.section-content');
            sections.forEach(section => {
                section.style.display = 'none';
            });
            
            // Remover clase active de todos los botones
            const tabs = document.querySelectorAll('.section-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar la secciÃ³n seleccionada
            const targetSection = document.getElementById(`section-${sectionName}`);
            if (targetSection) {
                targetSection.style.display = 'block';
            }
            
            // Activar el botÃ³n correspondiente
            const activeButton = document.getElementById(`btn-${sectionName}`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            // Scroll suave al inicio de la secciÃ³n
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        
        // === INICIALIZAR PRIMERA PESTAÃ‘A ===
        // Se ejecuta automÃ¡ticamente despuÃ©s de cargar los resultados
        setTimeout(() => {
            const firstTab = document.querySelector('.section-tab');
            if (firstTab && firstTab.onclick) {
                // Hacer clic en la primera pestaÃ±a para activarla
                firstTab.click();
            }
        }, 100);
        
        // --- COPIA HTML MEJORADA ---

        // NUEVA FUNCIÃ“N: Manejar copia de oferta con comparativo dual de potencias
        async function handleCopyOfferDualPower() {
            console.log('ðŸ”¥ handleCopyOfferDualPower - Generando HTML para comparativo dual');
            
            const dualComparison = window.lastDualPowerComparison;
            const resActual = dualComparison.actual;
            const resOptimized = dualComparison.optimized;
            const brand = dualComparison.brand;
            const presentationMode = getPresentationMode();
            
            const isDrk = brand.NAME.includes('DRK');
            const brandColor = isDrk ? '#2e5266' : '#3f6212';
            
            const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            
            console.log('Modo de presentaciÃ³n seleccionado:', presentationMode);
            
            let htmlContent = '';
            
            if (presentationMode === 'two-columns') {
                // MODO A: DOS COLUMNAS - Mostrar ambos comparativos lado a lado
                console.log('ðŸ“Š Generando HTML Modo A - Dos Columnas');
                
                htmlContent = `
                    <!DOCTYPE html>
                    <html>
                    <head><meta charset="UTF-8"></head>
                    <body style="margin:0;padding:20px;font-family:Arial,sans-serif;background:#f1f5f9;">
                    
                    <table width="900" cellpadding="0" cellspacing="0" align="center" style="background:#ffffff;">
                        <!-- HEADER -->
                        <tr>
                            <td bgcolor="${brandColor}" style="padding:30px;text-align:center;">
                                <h1 style="margin:0;color:#ffffff;font-size:32px;">${brand.FULL_NAME}</h1>
                                <p style="margin:10px 0 0 0;color:#ffffff;font-size:15px;">Comparativa: Potencias Actuales vs Potencias Optimizadas</p>
                            </td>
                        </tr>
                        
                        <!-- BADGE OPTIMIZACIÃ“N -->
                        <tr>
                            <td style="padding:15px;background:linear-gradient(to right, #f59e0b, #ea580c);text-align:center;">
                                <p style="margin:0;color:#ffffff;font-size:14px;font-weight:bold;">âš¡ COMPARATIVO 3.0TD CON OPTIMIZACIÃ“N DE POTENCIAS</p>
                            </td>
                        </tr>
                        
                        <!-- CUPS -->
                        <tr>
                            <td style="padding:15px 20px;background:#f8fafc;">
                                <p style="margin:0;color:#64748b;font-size:12px;">CUPS: <span style="font-family:monospace;color:#1e293b;font-weight:bold;">${resActual.cups}</span></p>
                            </td>
                        </tr>
                        
                        <!-- DOS COLUMNAS COMPARATIVAS -->
                        <tr>
                            <td style="padding:20px;">
                                <table width="100%" cellpadding="0" cellspacing="0">
                                    <tr>
                                        <!-- COLUMNA 1: POTENCIAS ACTUALES -->
                                        <td width="48%" valign="top" style="padding-right:10px;">
                                            <!-- Header Columna 1 -->
                                            <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom:15px;">
                                                <tr>
                                                    <td bgcolor="${brandColor}" style="padding:15px;text-align:center;border-radius:8px 8px 0 0;">
                                                        <h3 style="margin:0;color:#ffffff;font-size:16px;">CON POTENCIAS ACTUALES</h3>
                                                    </td>
                                                </tr>
                                            </table>
                                            
                                            <!-- Ahorro Actual -->
                                            <table width="100%" cellpadding="15" cellspacing="0" style="background:#f8fafc;border:2px solid ${brandColor};border-radius:8px;margin-bottom:15px;">
                                                <tr>
                                                    <td style="text-align:center;">
                                                        <p style="margin:0 0 8px 0;color:#64748b;font-size:11px;font-weight:bold;">TU AHORRO ANUAL</p>
                                                        <p style="margin:0;color:#16a34a;font-size:32px;font-weight:bold;">${eur(resActual.savings)}</p>
                                                    </td>
                                                </tr>
                                            </table>
                                            
                                            <!-- Costes Actual -->
                                            <table width="100%" cellpadding="10" cellspacing="0" style="background:#ffffff;border:1px solid #e2e8f0;border-radius:8px;margin-bottom:15px;">
                                                <tr>
                                                    <td style="text-align:center;border-bottom:1px solid #e2e8f0;padding:15px;">
                                                        <p style="margin:0 0 5px 0;color:#64748b;font-size:11px;">TU FACTURA ACTUAL</p>
                                                        <p style="margin:0;color:#dc2626;font-size:20px;font-weight:bold;text-decoration:line-through;">${eur(resActual.originalBillAnnual)}/aÃ±o</p>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:center;padding:15px;">
                                                        <p style="margin:0 0 5px 0;color:${brandColor};font-size:11px;font-weight:bold;">TU NUEVO COSTE ${brand.NAME}</p>
                                                        <p style="margin:0 0 5px 0;color:#1e293b;font-size:18px;font-weight:bold;">${eur(resActual.totalAnnual / 12)}/mes</p>
                                                        <p style="margin:0;color:#1e293b;font-size:16px;font-weight:bold;">${eur(resActual.totalAnnual)}/aÃ±o</p>
                                                    </td>
                                                </tr>
                                            </table>
                                            
                                            <!-- Potencias Actuales -->
                                            <table width="100%" cellpadding="10" cellspacing="0" bgcolor="#f8fafc" style="border-radius:8px;">
                                                <tr>
                                                    <td colspan="2" style="padding:10px;border-bottom:1px solid #e2e8f0;">
                                                        <p style="margin:0;color:${brandColor};font-size:13px;font-weight:bold;">POTENCIAS CONTRATADAS (kW)</p>
                                                    </td>
                                                </tr>
                                                ${resActual.powerCosts ? resActual.powerCosts.map(p => `
                                                <tr>
                                                    <td style="padding:5px 10px;color:#64748b;font-size:12px;">P${p.period}</td>
                                                    <td align="right" style="padding:5px 10px;color:#1e293b;font-size:12px;font-weight:bold;">${(p.kw || 0).toFixed(2)} kW</td>
                                                </tr>
                                                `).join('') : ''}
                                            </table>
                                        </td>
                                        
                                        <!-- SEPARADOR -->
                                        <td width="4%" style="background:#e2e8f0;"></td>
                                        
                                        <!-- COLUMNA 2: POTENCIAS OPTIMIZADAS -->
                                        <td width="48%" valign="top" style="padding-left:10px;">
                                            <!-- Header Columna 2 -->
                                            <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom:15px;">
                                                <tr>
                                                    <td bgcolor="#16a34a" style="padding:15px;text-align:center;border-radius:8px 8px 0 0;">
                                                        <h3 style="margin:0;color:#ffffff;font-size:16px;">âš¡ CON POTENCIAS OPTIMIZADAS</h3>
                                                    </td>
                                                </tr>
                                            </table>
                                            
                                            <!-- Ahorro Optimizado -->
                                            <table width="100%" cellpadding="15" cellspacing="0" style="background:#dcfce7;border:2px solid #16a34a;border-radius:8px;margin-bottom:15px;">
                                                <tr>
                                                    <td style="text-align:center;">
                                                        <p style="margin:0 0 8px 0;color:#15803d;font-size:11px;font-weight:bold;">TU AHORRO ANUAL CON OPTIMIZACIÃ“N</p>
                                                        <p style="margin:0;color:#16a34a;font-size:32px;font-weight:bold;">${eur(resOptimized.savings)}</p>
                                                    </td>
                                                </tr>
                                            </table>
                                            
                                            <!-- Costes Optimizado -->
                                            <table width="100%" cellpadding="10" cellspacing="0" style="background:#ffffff;border:2px solid #16a34a;border-radius:8px;margin-bottom:15px;">
                                                <tr>
                                                    <td style="text-align:center;border-bottom:1px solid #e2e8f0;padding:15px;">
                                                        <p style="margin:0 0 5px 0;color:#64748b;font-size:11px;">TU FACTURA ACTUAL</p>
                                                        <p style="margin:0;color:#dc2626;font-size:20px;font-weight:bold;text-decoration:line-through;">${eur(resOptimized.originalBillAnnual)}/aÃ±o</p>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:center;padding:15px;">
                                                        <p style="margin:0 0 5px 0;color:#16a34a;font-size:11px;font-weight:bold;">TU NUEVO COSTE ${brand.NAME}</p>
                                                        <p style="margin:0 0 5px 0;color:#1e293b;font-size:18px;font-weight:bold;">${eur(resOptimized.totalAnnual / 12)}/mes</p>
                                                        <p style="margin:0;color:#1e293b;font-size:16px;font-weight:bold;">${eur(resOptimized.totalAnnual)}/aÃ±o</p>
                                                    </td>
                                                </tr>
                                            </table>
                                            
                                            <!-- Potencias Optimizadas -->
                                            <table width="100%" cellpadding="10" cellspacing="0" bgcolor="#dcfce7" style="border:2px solid #16a34a;border-radius:8px;">
                                                <tr>
                                                    <td colspan="2" style="padding:10px;border-bottom:1px solid #86efac;">
                                                        <p style="margin:0;color:#15803d;font-size:13px;font-weight:bold;">âš¡ POTENCIAS OPTIMIZADAS (kW)</p>
                                                    </td>
                                                </tr>
                                                ${resOptimized.powerCosts ? resOptimized.powerCosts.map(p => `
                                                <tr>
                                                    <td style="padding:5px 10px;color:#15803d;font-size:12px;">P${p.period}</td>
                                                    <td align="right" style="padding:5px 10px;color:#1e293b;font-size:12px;font-weight:bold;">${(p.kw || 0).toFixed(2)} kW</td>
                                                </tr>
                                                `).join('') : ''}
                                            </table>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        
                        <!-- AHORRO ADICIONAL POR OPTIMIZACIÃ“N -->
                        <tr>
                            <td style="padding:20px;">
                                <table width="100%" cellpadding="20" cellspacing="0" style="background:linear-gradient(to right, #fef3c7, #fed7aa);border:3px solid #f59e0b;border-radius:12px;">
                                    <tr>
                                        <td style="text-align:center;">
                                            <p style="margin:0 0 8px 0;color:#92400e;font-size:14px;font-weight:bold;">ðŸ’° AHORRO ADICIONAL POR OPTIMIZACIÃ“N DE POTENCIAS</p>
                                            <p style="margin:0;color:#d97706;font-size:36px;font-weight:bold;">${eur(resActual.totalAnnual - resOptimized.totalAnnual)}</p>
                                            <p style="margin:8px 0 0 0;color:#78350f;font-size:12px;">Extra al aÃ±o ajustando tus potencias contratadas</p>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        
                        <!-- FOOTER -->
                        <tr>
                            <td bgcolor="${brandColor}" style="padding:20px;text-align:center;">
                                <p style="margin:0;color:#ffffff;font-size:12px;">${brand.FULL_NAME} - Soluciones EnergÃ©ticas Inteligentes</p>
                            </td>
                        </tr>
                    </table>
                    
                    </body>
                    </html>
                `;
                
            } else {
                // MODO B: UNA COLUMNA - Solo mostrar escenario actual con resumen al final
                console.log('ðŸ“Š Generando HTML Modo B - Una Columna (Ocultar optimizaciÃ³n)');
                
                htmlContent = `
                    <!DOCTYPE html>
                    <html>
                    <head><meta charset="UTF-8"></head>
                    <body style="margin:0;padding:20px;font-family:Arial,sans-serif;background:#f1f5f9;">
                    
                    <table width="700" cellpadding="0" cellspacing="0" align="center" style="background:#ffffff;">
                        <!-- HEADER -->
                        <tr>
                            <td bgcolor="${brandColor}" style="padding:30px;text-align:center;">
                                <h1 style="margin:0;color:#ffffff;font-size:32px;">${brand.FULL_NAME}</h1>
                                <p style="margin:10px 0 0 0;color:#ffffff;font-size:15px;">Tu Estudio de Ahorro EnergÃ©tico</p>
                            </td>
                        </tr>
                        
                        <!-- OFERTA -->
                        <tr>
                            <td bgcolor="${brandColor}" style="padding:15px;text-align:center;">
                                <p style="margin:0;color:#ffffff;font-size:11px;">LA MEJOR OPCIÃ“N PARA TI</p>
                                <h2 style="margin:5px 0 0 0;color:#ffffff;font-size:22px;">${resActual.offer.name}</h2>
                            </td>
                        </tr>
                        
                        <!-- AHORRO -->
                        <tr>
                            <td style="padding:25px;text-align:center;border-bottom:1px solid #e2e8f0;">
                                <p style="margin:0 0 8px 0;color:#64748b;font-size:11px;font-weight:bold;">TU AHORRO ANUAL ESTIMADO</p>
                                <p style="margin:0;color:#16a34a;font-size:42px;font-weight:bold;">${eur(resActual.savings)}</p>
                            </td>
                        </tr>
                        
                        <!-- COMPARATIVA -->
                        <tr>
                            <td style="padding:0;">
                                <table width="100%" cellpadding="0" cellspacing="0">
                                    <tr>
                                        <td width="50%" style="padding:20px;text-align:center;border-right:1px solid #e2e8f0;">
                                            <p style="margin:0 0 10px 0;color:#64748b;font-size:10px;font-weight:bold;">TU FACTURA ACTUAL</p>
                                            <p style="margin:0;color:#dc2626;font-size:18px;font-weight:bold;text-decoration:line-through;">${eur(resActual.originalBillAnnual)}/aÃ±o</p>
                                        </td>
                                        <td width="50%" style="padding:20px;text-align:center;">
                                            <p style="margin:0 0 10px 0;color:${brandColor};font-size:10px;font-weight:bold;">TU NUEVO COSTE ${brand.NAME}</p>
                                            <p style="margin:0 0 5px 0;color:#1e293b;font-size:20px;font-weight:bold;">${eur(resActual.totalAnnual / 12)}/mes</p>
                                            <p style="margin:0;color:#1e293b;font-size:16px;font-weight:bold;">${eur(resActual.totalAnnual)}/aÃ±o</p>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        
                        <!-- RESUMEN DE OPTIMIZACIÃ“N (Sin detalles de potencias) -->
                        <tr>
                            <td style="padding:30px 20px;">
                                <table width="100%" cellpadding="20" cellspacing="0" style="background:#f8fafc;border:2px solid #f59e0b;border-radius:12px;">
                                    <tr>
                                        <td>
                                            <h3 style="margin:0 0 15px 0;color:#1e293b;font-size:18px;text-align:center;">ðŸ“Š Resumen de OptimizaciÃ³n</h3>
                                            
                                            <table width="100%" cellpadding="10" cellspacing="0">
                                                <tr>
                                                    <td style="padding:10px;background:#ffffff;border-radius:8px;margin-bottom:10px;">
                                                        <p style="margin:0 0 5px 0;color:#64748b;font-size:12px;">Ahorro sin optimizar:</p>
                                                        <p style="margin:0;color:#16a34a;font-size:20px;font-weight:bold;">${eur(resActual.savings)}/aÃ±o</p>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td style="padding:10px;background:#dcfce7;border:2px solid #16a34a;border-radius:8px;">
                                                        <p style="margin:0 0 5px 0;color:#15803d;font-size:12px;font-weight:bold;">Ahorro con optimizaciÃ³n de potencias:</p>
                                                        <p style="margin:0;color:#16a34a;font-size:24px;font-weight:bold;">${eur(resOptimized.savings)}/aÃ±o</p>
                                                    </td>
                                                </tr>
                                            </table>
                                            
                                            <table width="100%" cellpadding="15" cellspacing="0" style="margin-top:15px;background:linear-gradient(to right, #fef3c7, #fed7aa);border-radius:8px;">
                                                <tr>
                                                    <td style="text-align:center;">
                                                        <p style="margin:0 0 5px 0;color:#92400e;font-size:13px;font-weight:bold;">ðŸ’° Ahorro adicional ajustando potencias:</p>
                                                        <p style="margin:0;color:#d97706;font-size:28px;font-weight:bold;">${eur(resActual.totalAnnual - resOptimized.totalAnnual)}</p>
                                                        <p style="margin:5px 0 0 0;color:#78350f;font-size:11px;font-style:italic;">Â¡Podemos ayudarte a optimizar tus potencias!</p>
                                                    </td>
                                                </tr>
                                            </table>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        
                        <!-- FOOTER -->
                        <tr>
                            <td bgcolor="${brandColor}" style="padding:20px;text-align:center;">
                                <p style="margin:0;color:#ffffff;font-size:12px;">${brand.FULL_NAME} - Soluciones EnergÃ©ticas Inteligentes</p>
                            </td>
                        </tr>
                    </table>
                    
                    </body>
                    </html>
                `;
            }
            
            // Copiar al portapapeles
            try {
                const tempElement = document.createElement('div');
                tempElement.innerHTML = htmlContent;
                tempElement.style.position = 'absolute';
                tempElement.style.left = '-9999px';
                document.body.appendChild(tempElement);
                
                const range = document.createRange();
                range.selectNodeContents(tempElement);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                
                let success = document.execCommand('copy');
                document.body.removeChild(tempElement);
                
                if (success) {
                    window.showMessageModal(`âœ… Â¡Comparativo de potencias copiado! (Modo: ${presentationMode === 'two-columns' ? 'Dos Columnas' : 'Una Columna'})`);
                    document.getElementById('send-offer-modal').classList.add('hidden');
                    document.getElementById('send-offer-modal').classList.remove('flex');
                } else {
                    window.showErrorModal("No se pudo copiar. Intente desde un PC.");
                }
            } catch (e) {
                console.error("Error al copiar:", e);
                window.showErrorModal(`Error: ${e.message}`);
            }
        }

        async function handleCopyOffer() {
            console.log('handleCopyOffer llamada', {
                lastComparisonResult: lastComparisonResult,
                lastIndexedResult: lastIndexedResult,
                compareWithIndexed: compareWithIndexed,
                dualPowerComparison: window.lastDualPowerComparison
            });
            
            // NUEVO: Detectar si hay comparativa dual de potencias
            if (window.lastDualPowerComparison) {
                console.log('ðŸ”„ Comparativa DUAL DE POTENCIAS detectada');
                return await handleCopyOfferDualPower();
            }
            
            if (!lastComparisonResult) {
                console.error('ERROR: lastComparisonResult es null o undefined');
                return window.showErrorModal("Primero realice una comparaciÃ³n.");
            }
            
            const currentLang = localStorage.getItem('appLanguage') || 'es';
            
            // NUEVO: Para TODOS LOS IDIOMAS, generar HTML con tablas traducidas
            console.log(`ðŸŒ Generando HTML traducido para idioma: ${currentLang}`);
            
            try {
                // Detectar marca activa
                const brand = activeBrand;
                const isDrk = brand.NAME.includes('DRK');
                const brandColor = isDrk ? '#2e5266' : '#3f6212'; // DRK azul, POWER CUP verde
                
                // Extraer datos principales del DOM
                const offerName = document.getElementById('best-offer-name')?.textContent || 'DRK FIJO 4';
                const savingsAmount = document.getElementById('savings-estimate')?.textContent || '0 â‚¬';
                const oldCost = document.getElementById('old-annual-cost-display')?.textContent || '0 â‚¬';
                const newCost = document.getElementById('new-annual-cost-display')?.textContent || '0 â‚¬';
                const monthlyText = document.getElementById('new-monthly-cost-display')?.textContent || '0 â‚¬';
                
                // Extraer datos del cÃ¡lculo
                const res = lastComparisonResult;
                
                // Crear HTML ULTRA-SIMPLE para Outlook (compatible con TODOS los idiomas)
                const htmlContent = `
                    <!DOCTYPE html>
                    <html>
                    <head><meta charset="UTF-8"></head>
                    <body style="margin:0;padding:20px;font-family:Arial,sans-serif;background:#f1f5f9;">
                    
                    <table width="700" cellpadding="0" cellspacing="0" align="center" style="background:#ffffff;">
                        <!-- HEADER -->
                        <tr>
                            <td bgcolor="${brandColor}" style="padding:30px;text-align:center;">
                                <h1 style="margin:0;color:#ffffff;font-size:32px;">${brand.FULL_NAME}</h1>
                                <p style="margin:10px 0 0 0;color:#ffffff;font-size:15px;">${tr('Liderando el ahorro y la eficiencia energÃ©tica')}</p>
                            </td>
                        </tr>
                        
                        <!-- OFERTA -->
                        <tr>
                            <td bgcolor="${brandColor}" style="padding:15px;text-align:center;">
                                <p style="margin:0;color:#ffffff;font-size:11px;">${tr('ä¸ºæ‚¨æä¾›çš„æœ€ä½³é€‰æ‹©')}</p>
                                <h2 style="margin:5px 0 0 0;color:#ffffff;font-size:22px;">${offerName}</h2>
                            </td>
                        </tr>
                        
                        <!-- AHORRO -->
                        <tr>
                            <td style="padding:25px;text-align:center;border-bottom:1px solid #e2e8f0;">
                                <p style="margin:0 0 8px 0;color:#64748b;font-size:11px;font-weight:bold;">${tr('æ‚¨çš„é¢„è®¡å¹´åº¦èŠ‚çœ')}</p>
                                <p style="margin:0;color:#16a34a;font-size:42px;font-weight:bold;">${savingsAmount}</p>
                            </td>
                        </tr>
                        
                        <!-- COMPARATIVA -->
                        <tr>
                            <td style="padding:0;">
                                <table width="100%" cellpadding="0" cellspacing="0">
                                    <tr>
                                        <td width="50%" style="padding:20px;text-align:center;border-right:1px solid #e2e8f0;">
                                            <p style="margin:0 0 10px 0;color:#64748b;font-size:10px;font-weight:bold;">${tr('æ‚¨çš„å½“å‰è´¦å•')}</p>
                                            <p style="margin:0;color:#dc2626;font-size:18px;font-weight:bold;text-decoration:line-through;">${oldCost}</p>
                                        </td>
                                        <td width="50%" style="padding:20px;text-align:center;">
                                            <p style="margin:0 0 10px 0;color:${brandColor};font-size:10px;font-weight:bold;">${tr('æ‚¨çš„æ–°DRKæˆæœ¬')}</p>
                                            <p style="margin:0 0 5px 0;color:#1e293b;font-size:20px;font-weight:bold;">${monthlyText}</p>
                                            <p style="margin:0;color:#1e293b;font-size:16px;font-weight:bold;">${newCost}</p>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        
                        <!-- DETALLES TÃTULO -->
                        <tr>
                            <td style="padding:20px 20px 10px 20px;">
                                <h3 style="margin:0;padding-left:10px;border-left:4px solid ${brandColor};color:#1e293b;font-size:16px;">${tr('æå–æ•°æ®')}</h3>
                            </td>
                        </tr>
                        
                        <!-- PERIODO Y FECHAS -->
                        <tr>
                            <td style="padding:0 20px;">
                                <table width="100%" cellpadding="10" cellspacing="0" bgcolor="#f8fafc">
                                    <tr>
                                        <td width="50%">
                                            <p style="margin:0 0 5px 0;color:#64748b;font-size:11px;">${tr('æœŸé—´')}</p>
                                            <p style="margin:0;color:#1e293b;font-size:14px;font-weight:bold;">${res.dias_facturados || 60} ${tr('å¤©')}</p>
                                        </td>
                                        <td width="50%">
                                            <p style="margin:0 0 5px 0;color:#64748b;font-size:11px;">${tr('æ—¥æœŸ')}</p>
                                            <p style="margin:0;color:#1e293b;font-size:12px;font-weight:bold;">${res.fechas || 'N/A'}</p>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        
                        <!-- CONSUMOS -->
                        <tr>
                            <td style="padding:15px 20px 5px 20px;">
                                <p style="margin:0;color:${brandColor};font-size:14px;font-weight:bold;">${tr('æœŸé—´æ¶ˆè€— (kWh)')}</p>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding:0 20px;">
                                <table width="100%" cellpadding="5" cellspacing="0" border="0">
                                    ${res.energyCosts ? res.energyCosts.map((e, i) => `
                                    <tr>
                                        <td style="padding:5px 0;color:#64748b;font-size:12px;">E${e.period} (${i===0 ? tr('å³°å€¼') : i===1 ? tr('å¹³æ®µ') : tr('è°·æ®µ')})</td>
                                        <td align="right" style="padding:5px 0;color:#1e293b;font-size:12px;font-weight:bold;">${e.kwh || 0} kWh</td>
                                    </tr>
                                    `).join('') : ''}
                                    <tr style="border-top:1px solid #e2e8f0;">
                                        <td style="padding:8px 0;color:${brandColor};font-size:13px;font-weight:bold;">${tr('æ€»æ¶ˆè€—')}</td>
                                        <td align="right" style="padding:8px 0;color:${brandColor};font-size:13px;font-weight:bold;">${res.energyCosts ? res.energyCosts.reduce((sum, e) => sum + (e.kwh || 0), 0) : 0} kWh</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        
                        <!-- POTENCIAS -->
                        <tr>
                            <td style="padding:15px 20px 5px 20px;">
                                <p style="margin:0;color:${brandColor};font-size:14px;font-weight:bold;">${tr('ç­¾çº¦åŠŸçŽ‡ (kW)')}</p>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding:0 20px 15px 20px;">
                                <table width="100%" cellpadding="5" cellspacing="0">
                                    ${res.powerCosts ? res.powerCosts.map(p => `
                                    <tr>
                                        <td style="padding:5px 0;color:#64748b;font-size:12px;">P${p.period}</td>
                                        <td align="right" style="padding:5px 0;color:#1e293b;font-size:12px;font-weight:bold;">${(p.kw || 0).toFixed(2)} kW</td>
                                    </tr>
                                    `).join('') : ''}
                                </table>
                            </td>
                        </tr>
                        
                        <!-- PRECIOS TÃTULO -->
                        <tr>
                            <td style="padding:20px 20px 10px 20px;">
                                <h3 style="margin:0;padding-left:10px;border-left:4px solid ${brandColor};color:#1e293b;font-size:16px;">${tr('åˆå¹¶æŠ¥ä»·ä»·æ ¼')}</h3>
                            </td>
                        </tr>
                        
                        <!-- PRECIOS -->
                        <tr>
                            <td style="padding:0 20px;">
                                <table width="100%" cellpadding="10" cellspacing="0" bgcolor="#f8fafc">
                                    <tr>
                                        <td colspan="2">
                                            <p style="margin:0 0 10px 0;color:#1e293b;font-size:13px;font-weight:bold;">${tr('èµ„è´¹ 2.0 TD')} - ${offerName}</p>
                                        </td>
                                    </tr>
                                    ${res.powerCosts ? res.powerCosts.map(p => `
                                    <tr>
                                        <td style="padding:4px 0;color:#64748b;font-size:11px;">P${p.period} (â‚¬/kW/${tr('æ—¥')}):</td>
                                        <td align="right" style="padding:4px 0;color:#1e293b;font-size:11px;font-family:monospace;font-weight:bold;">${(p.priceDay || 0).toFixed(6)}</td>
                                    </tr>
                                    `).join('') : ''}
                                    <tr>
                                        <td colspan="2" style="padding:8px 0 4px 0;color:#16a34a;font-size:12px;font-weight:bold;">${tr('èƒ½æº (â‚¬/kWh)')}</td>
                                    </tr>
                                    ${res.energyCosts ? res.energyCosts.map((e, i) => `
                                    <tr>
                                        <td style="padding:4px 0;color:#64748b;font-size:11px;">E${e.period} (${i===0 ? tr('å³°å€¼') : i===1 ? tr('å¹³æ®µ') : tr('è°·æ®µ')}):</td>
                                        <td align="right" style="padding:4px 0;color:#1e293b;font-size:11px;font-family:monospace;font-weight:bold;">${(e.price || 0).toFixed(6)}</td>
                                    </tr>
                                    `).join('') : ''}
                                    <tr>
                                        <td colspan="2" style="padding:10px 0 0 0;color:#64748b;font-size:10px;font-style:italic;">*${tr('æ˜¾ç¤ºçš„ä»·æ ¼æ¥è‡ªä¸­æ ‡æŠ¥ä»·ã€‚')}</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        
                        ${(() => {
                            // ANÃLISIS DE HORARIOS Y CONSUMO - SOLO PARA TARIFA 2.0TD
                            if (res.tariffType === '2.0TD' && res.energyCosts && res.energyCosts.length >= 3) {
                                const puntaKwh = res.energyCosts[0]?.kwh || 0;
                                const llanoKwh = res.energyCosts[1]?.kwh || 0;
                                const valleKwh = res.energyCosts[2]?.kwh || 0;
                                const totalKwh = puntaKwh + llanoKwh + valleKwh;
                                
                                const puntaPct = totalKwh > 0 ? (puntaKwh / totalKwh * 100).toFixed(1) : 0;
                                const llanoPct = totalKwh > 0 ? (llanoKwh / totalKwh * 100).toFixed(1) : 0;
                                const vallePct = totalKwh > 0 ? (valleKwh / totalKwh * 100).toFixed(1) : 0;
                                
                                let recomendacion = '';
                                if (puntaPct > 30) {
                                    recomendacion = tr('Consumes mÃ¡s del 30% en horario Punta. Te recomendamos trasladar consumos al periodo Valle (madrugada y fines de semana) para maximizar tu ahorro.');
                                } else if (vallePct > 50) {
                                    recomendacion = tr('Â¡Excelente! MÃ¡s del 50% de tu consumo estÃ¡ en Valle, el periodo mÃ¡s econÃ³mico. Sigue asÃ­ para maximizar tu ahorro.');
                                } else {
                                    recomendacion = tr('Tu consumo estÃ¡ bien distribuido. Considera trasladar mÃ¡s consumo al periodo Valle para aumentar tu ahorro.');
                                }
                                
                                return `
                                <!-- ANÃLISIS DE HORARIOS Y CONSUMO (Solo 2.0TD) -->
                                <tr>
                                    <td style="padding:20px;background:#f8fafc;">
                                        <table width="100%" cellpadding="0" cellspacing="0">
                                            <tr>
                                                <td style="padding-bottom:15px;">
                                                    <h3 style="margin:0;color:#1e293b;font-size:16px;font-weight:bold;">
                                                        ðŸ• ${tr('AnÃ¡lisis de Horarios y Consumo - Tarifa 2.0 TD')}
                                                    </h3>
                                                </td>
                                            </tr>
                                        </table>
                                        
                                        <!-- Tarjetas de Horarios -->
                                        <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom:15px;">
                                            <tr>
                                                <td width="48%" valign="top" style="background:#ffffff;padding:15px;border-radius:8px;">
                                                    <p style="margin:0 0 10px 0;text-align:center;font-weight:bold;color:#334155;font-size:13px;">${tr('Lunes a viernes laborables')}</p>
                                                    <table width="100%" cellpadding="5" cellspacing="0">
                                                        <tr>
                                                            <td style="background:#fef2f2;padding:8px;border-radius:6px;margin-bottom:5px;">
                                                                <span style="display:inline-block;width:10px;height:10px;background:#dc2626;border-radius:50%;margin-right:5px;"></span>
                                                                <span style="font-weight:bold;color:#991b1b;font-size:11px;">${tr('Punta')}:</span>
                                                                <span style="color:#475569;font-size:11px;">10-14h, 18-22h</span>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td style="background:#fefce8;padding:8px;border-radius:6px;margin-bottom:5px;">
                                                                <span style="display:inline-block;width:10px;height:10px;background:#facc15;border-radius:50%;margin-right:5px;"></span>
                                                                <span style="font-weight:bold;color:#a16207;font-size:11px;">${tr('Llano')}:</span>
                                                                <span style="color:#475569;font-size:11px;">8-10h, 14-18h, 22-24h</span>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td style="background:#f0fdf4;padding:8px;border-radius:6px;">
                                                                <span style="display:inline-block;width:10px;height:10px;background:#16a34a;border-radius:50%;margin-right:5px;"></span>
                                                                <span style="font-weight:bold;color:#166534;font-size:11px;">${tr('Valle')}:</span>
                                                                <span style="color:#475569;font-size:11px;">0-8h</span>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </td>
                                                <td width="4%"></td>
                                                <td width="48%" valign="top" style="background:#ffffff;padding:15px;border-radius:8px;">
                                                    <p style="margin:0 0 10px 0;text-align:center;font-weight:bold;color:#334155;font-size:13px;">${tr('SÃ¡bados, domingos y festivos')}</p>
                                                    <table width="100%" cellpadding="15" cellspacing="0">
                                                        <tr>
                                                            <td style="background:#f0fdf4;padding:20px;border-radius:8px;text-align:center;">
                                                                <span style="display:inline-block;width:14px;height:14px;background:#16a34a;border-radius:50%;margin-right:5px;vertical-align:middle;"></span>
                                                                <span style="font-weight:bold;color:#166534;font-size:14px;vertical-align:middle;">${tr('Valle')}</span>
                                                                <p style="margin:8px 0 0 0;color:#475569;font-size:11px;">24 horas (todo el dÃ­a)</p>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>
                                        </table>
                                        
                                        <!-- DistribuciÃ³n de Consumo -->
                                        <table width="100%" cellpadding="0" cellspacing="0">
                                            <tr>
                                                <td style="padding-bottom:15px;">
                                                    <h4 style="margin:0;color:#1e293b;font-size:14px;font-weight:bold;">
                                                        ðŸ“Š ${tr('Tu DistribuciÃ³n de Consumo')}
                                                    </h4>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <table width="100%" cellpadding="8" cellspacing="0">
                                                        <tr>
                                                            <!-- Punta -->
                                                            <td width="32%" style="background:#fef2f2;padding:12px;border-radius:8px;border:2px solid #fecaca;text-align:center;">
                                                                <span style="display:inline-block;width:12px;height:12px;background:#dc2626;border-radius:50%;margin-right:5px;vertical-align:middle;"></span>
                                                                <span style="font-weight:bold;color:#991b1b;font-size:12px;vertical-align:middle;">${tr('Periodo Punta')}</span>
                                                                <p style="margin:8px 0 5px 0;color:#dc2626;font-size:24px;font-weight:bold;">${puntaPct}%</p>
                                                                <p style="margin:0 0 5px 0;color:#64748b;font-size:11px;">${puntaKwh.toFixed(0)} kWh</p>
                                                                <p style="margin:0;background:#ffffff;padding:6px;border-radius:4px;color:#64748b;font-size:9px;">
                                                                    ${tr('Horario mÃ¡s caro')}<br>10-14h, 18-22h (lab.)
                                                                </p>
                                                            </td>
                                                            <td width="2%"></td>
                                                            <!-- Llano -->
                                                            <td width="32%" style="background:#fefce8;padding:12px;border-radius:8px;border:2px solid #fde047;text-align:center;">
                                                                <span style="display:inline-block;width:12px;height:12px;background:#facc15;border-radius:50%;margin-right:5px;vertical-align:middle;"></span>
                                                                <span style="font-weight:bold;color:#a16207;font-size:12px;vertical-align:middle;">${tr('Periodo Llano')}</span>
                                                                <p style="margin:8px 0 5px 0;color:#ca8a04;font-size:24px;font-weight:bold;">${llanoPct}%</p>
                                                                <p style="margin:0 0 5px 0;color:#64748b;font-size:11px;">${llanoKwh.toFixed(0)} kWh</p>
                                                                <p style="margin:0;background:#ffffff;padding:6px;border-radius:4px;color:#64748b;font-size:9px;">
                                                                    ${tr('Precio medio')}<br>8-10h, 14-18h, 22-24h
                                                                </p>
                                                            </td>
                                                            <td width="2%"></td>
                                                            <!-- Valle -->
                                                            <td width="32%" style="background:#f0fdf4;padding:12px;border-radius:8px;border:2px solid #bbf7d0;text-align:center;">
                                                                <span style="display:inline-block;width:12px;height:12px;background:#16a34a;border-radius:50%;margin-right:5px;vertical-align:middle;"></span>
                                                                <span style="font-weight:bold;color:#166534;font-size:12px;vertical-align:middle;">${tr('Periodo Valle')}</span>
                                                                <p style="margin:8px 0 5px 0;color:#16a34a;font-size:24px;font-weight:bold;">${vallePct}%</p>
                                                                <p style="margin:0 0 5px 0;color:#64748b;font-size:11px;">${valleKwh.toFixed(0)} kWh</p>
                                                                <p style="margin:0;background:#ffffff;padding:6px;border-radius:4px;color:#64748b;font-size:9px;">
                                                                    ${tr('Horario mÃ¡s barato')}<br>0-8h + fines semana
                                                                </p>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>
                                            <!-- Barra de progreso -->
                                            <tr>
                                                <td style="padding-top:12px;">
                                                    <table width="100%" cellpadding="0" cellspacing="0" style="height:25px;border-radius:6px;overflow:hidden;">
                                                        <tr>
                                                            <td width="${puntaPct}%" style="background:#dc2626;color:#ffffff;text-align:center;font-size:10px;font-weight:bold;padding:5px;">
                                                                ${puntaPct > 8 ? puntaPct + '%' : ''}
                                                            </td>
                                                            <td width="${llanoPct}%" style="background:#facc15;color:#1e293b;text-align:center;font-size:10px;font-weight:bold;padding:5px;">
                                                                ${llanoPct > 8 ? llanoPct + '%' : ''}
                                                            </td>
                                                            <td width="${vallePct}%" style="background:#16a34a;color:#ffffff;text-align:center;font-size:10px;font-weight:bold;padding:5px;">
                                                                ${vallePct > 8 ? vallePct + '%' : ''}
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>
                                        </table>
                                        
                                        <!-- RecomendaciÃ³n -->
                                        <table width="100%" cellpadding="0" cellspacing="0" style="background:#eff6ff;padding:12px;border-radius:8px;border-left:4px solid #0284c7;margin-top:15px;">
                                            <tr>
                                                <td>
                                                    <p style="margin:0 0 5px 0;font-weight:bold;color:#0c4a6e;font-size:12px;">ðŸ’¡ ${tr('RecomendaciÃ³n Personalizada')}</p>
                                                    <p style="margin:0;color:#334155;font-size:11px;line-height:1.5;">${recomendacion}</p>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                                `;
                            }
                            return '';
                        })()}
                        
                        <!-- CÃLCULO TÃTULO -->
                        <tr>
                            <td style="padding:20px 20px 10px 20px;">
                                <h3 style="margin:0;padding-left:10px;border-left:4px solid ${brandColor};color:#1e293b;font-size:16px;">${tr('å®˜æ–¹è®¡ç®—')}</h3>
                            </td>
                        </tr>
                        
                        <!-- CÃLCULO -->
                        <tr>
                            <td style="padding:0 20px 20px 20px;">
                                <table width="100%" cellpadding="10" cellspacing="0" border="1" bordercolor="#e2e8f0" style="border-collapse:collapse;font-family:monospace;font-size:11px;">
                                    <tr>
                                        <td colspan="2" bgcolor="#f8fafc" align="center" style="padding:10px;">
                                            <p style="margin:0;color:#1e293b;font-size:14px;font-weight:bold;">DRK</p>
                                            <p style="margin:5px 0 0 0;color:#64748b;font-size:12px;">${tr('æ¨¡æ‹Ÿ')} ${res.dias_facturados || 60} ${tr('å¤©')}</p>
                                        </td>
                                    </tr>
                                    
                                    <tr bgcolor="#f8fafc">
                                        <td colspan="2" style="padding:8px;color:#1e293b;font-size:12px;font-weight:bold;">${tr('åŠŸçŽ‡ (â‚¬/kW æ—¥)')}</td>
                                    </tr>
                                    ${res.powerCosts ? res.powerCosts.map(p => `
                                    <tr>
                                        <td style="padding:5px;color:#64748b;">P${p.period} (${(p.kw || 0).toFixed(2)} kW x ${(p.priceDay || 0).toFixed(6)} â‚¬/dÃ­a)</td>
                                        <td align="right" style="padding:5px;color:#1e293b;font-weight:bold;">${(p.cost || 0).toFixed(2)} â‚¬</td>
                                    </tr>
                                    `).join('') : ''}
                                    <tr style="border-top:2px solid #e2e8f0;">
                                        <td style="padding:8px;color:#3b82f6;font-weight:bold;">${tr('åŠŸçŽ‡å°è®¡')}</td>
                                        <td align="right" style="padding:8px;color:#3b82f6;font-weight:bold;">${(res.subPower || 0).toFixed(2)} â‚¬</td>
                                    </tr>
                                    
                                    <tr bgcolor="#f8fafc">
                                        <td colspan="2" style="padding:8px;color:#1e293b;font-size:12px;font-weight:bold;">${tr('èƒ½æº (â‚¬/kWh)')}</td>
                                    </tr>
                                    ${res.energyCosts ? res.energyCosts.map((e, i) => `
                                    <tr>
                                        <td style="padding:5px;color:#64748b;">E${e.period} (${i===0 ? tr('å³°å€¼') : i===1 ? tr('å¹³æ®µ') : tr('è°·æ®µ')}) (${e.kwh || 0} kWh x ${(e.price || 0).toFixed(6)} â‚¬/kWh)</td>
                                        <td align="right" style="padding:5px;color:#1e293b;font-weight:bold;">${(e.cost || 0).toFixed(2)} â‚¬</td>
                                    </tr>
                                    `).join('') : ''}
                                    
                                    <tr style="border-top:1px dashed #cbd5e1;">
                                        <td></td>
                                        <td align="right" style="padding:8px;color:#1e293b;font-weight:bold;">${(res.subEnergyNet || 0).toFixed(2)} â‚¬</td>
                                    </tr>
                                    <tr style="border-top:1px dashed #cbd5e1;">
                                        <td></td>
                                        <td align="right" style="padding:8px;color:#1e293b;font-weight:bold;">${(res.subtotalNet || 0).toFixed(2)} â‚¬</td>
                                    </tr>
                                    <tr>
                                        <td style="padding:5px;color:#64748b;">${tr('Imp. ElÃ©c.')} (5,113%)</td>
                                        <td align="right" style="padding:5px;color:#1e293b;">${(res.costIE || 0).toFixed(2)} â‚¬</td>
                                    </tr>
                                    <tr style="border-top:1px solid #cbd5e1;">
                                        <td></td>
                                        <td align="right" style="padding:8px;color:#1e293b;font-weight:bold;">${(res.totalSinIVA || 0).toFixed(2)} â‚¬</td>
                                    </tr>
                                    <tr>
                                        <td style="padding:5px;color:#64748b;">${tr('å¢žå€¼ç¨Žï¼ˆ21%ï¼‰')}</td>
                                        <td align="right" style="padding:5px;color:#1e293b;">${(res.costIVA || 0).toFixed(2)} â‚¬</td>
                                    </tr>
                                    <tr style="border-top:3px solid #1e293b;" bgcolor="#f8fafc">
                                        <td style="padding:10px;color:#1e293b;font-size:13px;font-weight:bold;">${tr('æ€»è´¦å•')}</td>
                                        <td align="right" style="padding:10px;color:#1e293b;font-size:13px;font-weight:bold;">${(res.totalPeriod || 0).toFixed(2)} â‚¬</td>
                                    </tr>
                                    
                                    <tr bgcolor="${brandColor}">
                                        <td colspan="2" align="center" style="padding:15px;color:#ffffff;font-size:13px;font-weight:bold;">${tr('ä¼°è®¡å¹´åº¦æ€»é¢')}: ${(res.totalAnnual || 0).toFixed(2)} â‚¬</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        
                        <!-- FOOTER -->
                        <tr>
                            <td bgcolor="#f8fafc" style="padding:15px;text-align:center;">
                                <p style="margin:0;color:#64748b;font-size:13px;">${tr('æ‰€æœ‰æ–‡æœ¬å‡ä¸ºä¸­æ–‡ Â· å¯ç›´æŽ¥ä½¿ç”¨')}</p>
                            </td>
                        </tr>
                    </table>
                    
                    </body>
                    </html>
                `;
                
                // Copiar al portapapeles
                const tempElement = document.createElement('div');
                tempElement.contentEditable = true;
                tempElement.innerHTML = htmlContent;
                tempElement.style.position = 'fixed';
                tempElement.style.left = '-9999px';
                document.body.appendChild(tempElement);
                
                const range = document.createRange();
                range.selectNodeContents(tempElement);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                
                let success = document.execCommand('copy');
                document.body.removeChild(tempElement);
                
                if (success) {
                    window.showMessageModal(tr("âœ… Â¡Oferta copiada con Ã©xito! Ahora puede pegar (Ctrl+V o Cmd+V) el diseÃ±o visual en su correo de escritorio."));
                    document.getElementById('send-offer-modal').classList.add('hidden');
                    document.getElementById('send-offer-modal').classList.remove('flex');
                } else {
                    window.showErrorModal(tr("No se pudo copiar el diseÃ±o visual. Intente desde un PC o contacte a soporte."));
                }
                
                return;
            } catch (e) {
                console.error("Error al copiar HTML traducido:", e);
                window.showErrorModal(`Error: ${e.message}`);
                return;
            }
            
            // El cÃ³digo anterior ya manejÃ³ todos los idiomas y terminÃ³ con return
            // Este cÃ³digo nunca se ejecutarÃ¡ pero lo dejo por compatibilidad
            const commercialCode = document.getElementById('comercial-code-input').value.trim();
            if (!commercialCode) return window.showErrorModal("Indique el CÃ³digo Comercial.");

            try {
                // 1. Generar el HTML
                let htmlContent = '';
                
                // IMPORTANTE: Detectar si hay resultado indexado para generar HTML dual
                if (lastIndexedResult && compareWithIndexed) {
                    // Si hay resultado indexado, generar HTML dual
                    if (lastComparisonResult.isMultiCups) {
                        // MULTICUPS con Ã­ndice - generar HTML especial
                        htmlContent = generateMultiDualStyledHtmlOffer(commercialCode);
                    } else {
                        // Individual con Ã­ndice - generar HTML especial
                        htmlContent = generateDualStyledHtmlOffer(commercialCode, lastComparisonResult, lastIndexedResult);
                    }
                } else {
                    // Modo normal (sin indexado)
                    if (lastComparisonResult.isMulti) {
                        htmlContent = generateMultiStyledHtmlOffer(commercialCode);
                    } else {
                        htmlContent = generateStyledHtmlOffer(commercialCode);
                    }
                }
                
                // 2. Crear un elemento temporal para la copia HTML enriquecida
                const tempElement = document.createElement('div');
                tempElement.contentEditable = true;
                tempElement.innerHTML = htmlContent;
                tempElement.style.position = 'fixed';
                tempElement.style.left = '-9999px';
                document.body.appendChild(tempElement);
                
                // Seleccionar y copiar
                const range = document.createRange();
                range.selectNodeContents(tempElement);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                
                let success = document.execCommand('copy');
                document.body.removeChild(tempElement);

                if (success) {
                    window.showMessageModal(tr("âœ… Â¡Oferta copiada con Ã©xito! Ahora puede pegar (Ctrl+V o Cmd+V) el diseÃ±o visual en su correo de escritorio."));
                    document.getElementById('send-offer-modal').classList.add('hidden');
                    document.getElementById('send-offer-modal').classList.remove('flex');
                } else {
                    window.showErrorModal(tr("No se pudo copiar el diseÃ±o visual. Intente desde un PC o contacte a soporte."));
                }
            } catch (e) {
                console.error("Error al copiar al portapapeles:", e);
                window.showErrorModal(`Error de Portapapeles: ${e.message}`);
            }
        }
        
        // --- GENERACIÃ“N DE PDF CON COMPARACIÃ“N DUAL (FIJO VS INDEXADO) CON DESARROLLO COMPLETO ---
        
        async function generatePDF_Dual(resFijo, resIndexed, commercialCode = 'D=00', clientName = '[NOMBRE COMPLETO CLIENTE]', clientPhone = '', clientEmail = '', clientAddress = '') {
            try {
                console.log('=== generatePDF_Dual INICIADO ===');
                console.log('resFijo:', resFijo);
                console.log('commercialCode:', commercialCode);
                console.log('clientName:', clientName);
                console.log('clientAddress:', clientAddress);
                console.log('resFijo tiene powerCosts?:', !!resFijo.powerCosts);
                console.log('resFijo tiene energyCosts?:', !!resFijo.energyCosts);
                console.log('resIndexed:', resIndexed);
                console.log('resIndexed tiene powerCosts?:', !!resIndexed.powerCosts);
                console.log('resIndexed tiene energyCosts?:', !!resIndexed.energyCosts);
                
                // CRÃTICO: Si no tienen powerCosts/energyCosts, recalcularlos
                if (!resFijo.powerCosts || !resFijo.energyCosts) {
                    console.warn('resFijo no tiene powerCosts/energyCosts, recalculando...');
                    const recalculated = recalculateCostsForOffer(resFijo, resFijo.offer);
                    resFijo.powerCosts = recalculated.powerCosts;
                    resFijo.energyCosts = recalculated.energyCosts;
                    resFijo.subPower = recalculated.subPower;
                    resFijo.subEnergyNet = recalculated.subEnergyNet;
                    console.log('resFijo recalculado:', resFijo);
                }
                
                if (!resIndexed.powerCosts || !resIndexed.energyCosts) {
                    console.warn('resIndexed no tiene powerCosts/energyCosts, recalculando...');
                    const recalculated = recalculateCostsForOffer(resIndexed, resIndexed.offer);
                    resIndexed.powerCosts = recalculated.powerCosts;
                    resIndexed.energyCosts = recalculated.energyCosts;
                    resIndexed.subPower = recalculated.subPower;
                    resIndexed.subEnergyNet = recalculated.subEnergyNet;
                    console.log('resIndexed recalculado:', resIndexed);
                }
                
                window.showMessageModal("â³ Generando PDF con comparaciÃ³n Fijo vs Indexado... Por favor espere.");
                
                const { jsPDF } = window.jspdf;
                let doc = new jsPDF('p', 'mm', 'a4');
                
                // CRÃTICO: Activar traducciÃ³n automÃ¡tica de textos
                if (window.setupPDFTranslation) {
                    doc = window.setupPDFTranslation(doc);
                }
                
                const brand = activeBrand;
                const tariffType = resFijo.originalTariffType || currentTariffType;
                const config = TARIFF_CONFIG[tariffType] || TARIFF_CONFIG['2.0TD'];
                
                // Ya no necesitamos capturar desde el DOM, usamos los parÃ¡metros de la funciÃ³n
                console.log('ðŸ“‹ Datos del comercial recibidos como parÃ¡metros:');
                console.log('  - CÃ³digo comercial:', commercialCode);
                console.log('  - Nombre cliente:', clientName);
                console.log('  - ðŸ  DirecciÃ³n:', clientAddress);
                console.log('  - TelÃ©fono:', clientPhone);
                console.log('  - Email:', clientEmail);
                
                // Colores dinÃ¡micos segÃºn la marca activa
                const darkColor = [107, 125, 142];
                const greenColor = [22, 163, 74];
                const redColor = [220, 38, 38];
                
                // CRÃTICO: Colores segÃºn marca (DRK = azul, POWER CUP = verde)
                const isDrk = brand.NAME.includes('DRK');
                const brandColor = isDrk ? [59, 130, 246] : [132, 204, 22];  // Azul DRK o Verde POWER CUP
                const brandColorLight = isDrk ? [59, 130, 246] : [22, 163, 74];  // Para ahorros
                const blueColor = brandColor;  // Alias para compatibilidad (usado en PÃ¡gina 2 y 3)
                const greenIndexColor = [22, 163, 74];  // Verde para INDEXADA (siempre verde)
                
                const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
                const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
                const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
                
                let yPos = 0;
                const pageWidth = 210;
                const margin = 12;
                const contentWidth = pageWidth - (2 * margin);
                
                // === PÃGINA 1: RESUMEN ===
                
                // CABECERA con degradado
                const headerHeight = 35;
                
                // CRÃTICO: Color del header segÃºn marca
                const headerColor = isDrk ? [107, 125, 142] : [115, 130, 95]; // Gris azulado (DRK) o Verde oliva (POWER)
                
                for (let i = 0; i < pageWidth; i++) {
                    const ratio = i / pageWidth;
                    const r = Math.round(headerColor[0] + (240 - headerColor[0]) * ratio);
                    const g = Math.round(headerColor[1] + (245 - headerColor[1]) * ratio);
                    const b = Math.round(headerColor[2] + (250 - headerColor[2]) * ratio);
                    doc.setFillColor(r, g, b);
                    doc.rect(i, 0, 1, headerHeight, 'F');
                }
                
                // Logo segÃºn marca
                const logoX = margin + 8;
                const logoY = 12;
                const logoRadius = 5;
                
                if (isDrk) {
                    // Logo DRK (anillo multicolor)
                    doc.setFillColor(219, 68, 55);
                    doc.circle(logoX - 1, logoY + 1, logoRadius * 0.8, 'F');
                    doc.setFillColor(66, 133, 244);
                    doc.circle(logoX + 1, logoY - 1, logoRadius * 0.8, 'F');
                    doc.setFillColor(244, 180, 0);
                    doc.circle(logoX - 1, logoY - 1, logoRadius * 0.7, 'F');
                    doc.setFillColor(15, 157, 88);
                    doc.circle(logoX + 1, logoY + 1, logoRadius * 0.7, 'F');
                    doc.setFillColor(255, 255, 255);
                    doc.circle(logoX, logoY, logoRadius * 0.4, 'F');
                } else {
                    // Logo POWER CUP (taza con rayo)
                    // Plato/base (verde oscuro)
                    doc.setFillColor(60, 90, 50);
                    doc.rect(logoX - 5, logoY + 4, 10, 1, 'F');
                    
                    // Borde de la taza (verde oscuro)
                    doc.setDrawColor(60, 90, 50);
                    doc.setLineWidth(1.2);
                    doc.roundedRect(logoX - 3.5, logoY - 2, 7, 6, 0.5, 0.5, 'S');
                    
                    // Asa de la taza
                    doc.setLineWidth(1);
                    doc.line(logoX + 3.5, logoY, logoX + 5, logoY - 0.5);
                    doc.line(logoX + 5, logoY - 0.5, logoX + 5.5, logoY + 1);
                    doc.line(logoX + 5.5, logoY + 1, logoX + 5, logoY + 2.5);
                    doc.line(logoX + 5, logoY + 2.5, logoX + 3.5, logoY + 2);
                    
                    // Rayo dentro de la taza (amarillo/oro)
                    doc.setFillColor(255, 215, 0);
                    doc.setLineWidth(0.3);
                    const rayoX = logoX - 0.5;
                    const rayoY = logoY;
                    doc.line(rayoX, rayoY - 1, rayoX - 0.7, rayoY + 0.5);
                    doc.line(rayoX - 0.7, rayoY + 0.5, rayoX + 0.3, rayoY + 0.3);
                    doc.line(rayoX + 0.3, rayoY + 0.3, rayoX, rayoY + 2);
                    doc.line(rayoX, rayoY + 2, rayoX + 0.7, rayoY + 0.2);
                    doc.line(rayoX + 0.7, rayoY + 0.2, rayoX - 0.3, rayoY + 0.5);
                }
                
                // Texto del nombre de marca
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(brand.NAME.toUpperCase(), logoX + 12, 14);
                
                // Subtexto segÃºn marca
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                if (isDrk) {
                    doc.text(tr('Liderando el ahorro y la'), logoX + 12, 20);
                    doc.text(tr('eficiencia energÃ©tica.'), logoX + 12, 24);
                } else {
                    doc.text(tr('AsesorÃ­a EnergÃ©tica'), logoX + 12, 20);
                }
                
                // Texto derecha
                doc.setTextColor(40, 60, 80);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('ESTUDIO DE AHORRO'), pageWidth - margin, 12, { align: 'right' });
                
                doc.setFontSize(11);
                doc.setTextColor(255, 255, 255);
                doc.text('COMPARATIVA', pageWidth - margin, 18, { align: 'right' });
                
                doc.setFontSize(9);
                doc.setTextColor(100, 120, 140);
                doc.text('PROFESIONAL', pageWidth - margin, 24, { align: 'right' });
                
                yPos = headerHeight + 8;
                
                // === DATOS DEL CLIENTE ===
                
                // TÃ­tulo "COMPARATIVA PROFESIONAL - DRK"
                doc.setTextColor(55, 65, 81);  // Gris oscuro
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('COMPARATIVA PROFESIONAL - ' + brand.NAME.toUpperCase(), margin, yPos);
                yPos += 8;
                
                // Info del cliente
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.setTextColor(75, 85, 99);
                doc.text(tr('CLIENTE:') + ' ' + clientName.toUpperCase(), margin, yPos);
                yPos += 6;
                
                // Mostrar direcciÃ³n si existe
                if (clientAddress && clientAddress.trim() !== '') {
                    doc.setFontSize(9);
                    doc.setTextColor(100, 116, 139);
                    doc.text('ðŸ  ' + tr('DIRECCIÃ“N:') + ' ' + clientAddress, margin, yPos);
                    yPos += 6;
                    doc.setTextColor(75, 85, 99);
                    doc.setFontSize(10);
                }
                
                doc.text('CUPS TOTALES: ' + (resFijo.isMulti ? resFijo.cups : '1'), margin, yPos);
                yPos += 12;
                
                // === CAJA GRANDE CON LA MEJOR OPCIÃ“N ===
                
                const bigBoxY = yPos;
                const bigBoxHeight = 45;
                const bigBoxMargin = 20;
                const bigBoxWidth = contentWidth - (bigBoxMargin * 2);
                const bigBoxX = margin + bigBoxMargin;
                
                // CRÃTICO: Color de fondo segÃºn marca
                const bigBoxColor = isDrk ? [100, 116, 139] : [115, 130, 95]; // Gris azulado (DRK) o Verde oliva (POWER)
                doc.setFillColor(...bigBoxColor);
                doc.roundedRect(bigBoxX, bigBoxY, bigBoxWidth, bigBoxHeight, 4, 4, 'F');
                
                // Texto "LA MEJOR OPCIÃ“N PARA TI ES"
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.text(tr('LA MEJOR OPCIÃ“N PARA TI ES'), pageWidth / 2, bigBoxY + 12, { align: 'center' });
                
                // Nombre de la marca en grande
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(30);
                doc.text(brand.NAME.toUpperCase(), pageWidth / 2, bigBoxY + 26, { align: 'center' });
                
                // DescripciÃ³n
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                const descripcion = tr('Ofrece el mayor ahorro consolidado con') + ' ' + brand.FULL_NAME + '.';
                doc.text(descripcion, pageWidth / 2, bigBoxY + 37, { align: 'center' });
                
                yPos = bigBoxY + bigBoxHeight + 10;
                
                // === DISEÃ‘O LIMPIO SIN MARCOS (3 COLUMNAS) ===
                
                const col1X = margin;
                const col2X = margin + (contentWidth / 3);
                const col3X = margin + (contentWidth / 3) * 2;
                const colWidth = contentWidth / 3;
                
                // === COLUMNA 1: TU FACTURA ACTUAL (IZQUIERDA) - BAJADA AL MEDIO ===
                
                let y1 = yPos + 25;
                
                // TÃ­tulo
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.setTextColor(107, 114, 128);
                doc.text(tr('TU FACTURA ACTUAL'), col1X, y1);
                y1 += 12;
                
                // Precio mensual (TACHADO)
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(22);
                doc.setTextColor(220, 38, 38);
                const precioMensualActual = eur(resFijo.originalBillPeriod || resFijo.importe_total);
                doc.text(precioMensualActual, col1X, y1);
                
                // LÃ­nea tachada
                const tw1 = doc.getTextWidth(precioMensualActual);
                doc.setDrawColor(220, 38, 38);
                doc.setLineWidth(1.5);
                doc.line(col1X, y1 - 4, col1X + tw1, y1 - 4);
                y1 += 10;
                
                // Subtexto
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(156, 163, 175);
                doc.text(`${tr('Total Periodo')} (${resFijo.dias_facturados || 0} ${tr('dÃ­as')})`, col1X, y1);
                y1 += 14;
                
                // Precio anual (TACHADO)
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(20);
                doc.setTextColor(220, 38, 38);
                const precioAnualActual = eur(resFijo.originalBillAnnual) + tr('/aÃ±o');
                doc.text(precioAnualActual, col1X, y1);
                
                // LÃ­nea tachada
                const tw2 = doc.getTextWidth(precioAnualActual);
                doc.setDrawColor(220, 38, 38);
                doc.setLineWidth(1.5);
                doc.line(col1X, y1 - 3, col1X + tw2, y1 - 3);
                
                // === COLUMNA 2: AHORRO + NUEVO COSTE FIJO (CENTRO) - CAJA SUBIDA ===
                
                let y2 = yPos;
                
                // CRÃTICO: Color de caja segÃºn marca
                const cajaHeaderColor = isDrk ? [100, 116, 139] : [115, 130, 95]; // Gris azulado (DRK) o Verde oliva (POWER)
                
                // Caja superior "TU AHORRO ANUAL FIJO"
                const boxHeaderHeight = 12;
                doc.setFillColor(...cajaHeaderColor);
                doc.roundedRect(col2X - 2, y2, colWidth - 8, boxHeaderHeight, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                doc.text('TU AHORRO ANUAL FIJO', col2X + (colWidth - 8) / 2 - 2, y2 + 8, { align: 'center' });
                y2 += boxHeaderHeight + 12;
                
                // Ahorro en verde GRANDE
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(30);
                doc.setTextColor(22, 163, 74);
                doc.text(eur(resFijo.savings), col2X, y2);
                y2 += 18;
                
                // "TU NUEVO COSTE [MARCA]"
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.setTextColor(107, 114, 128);
                doc.text(tr('TU NUEVO COSTE') + ' ' + brand.NAME.toUpperCase(), col2X, y2);
                y2 += 12;
                
                // Precio mensual nuevo (color de marca)
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(20);
                doc.setTextColor(...brandColor);
                doc.text(eur(resFijo.totalAnnual / 12) + tr('/mes'), col2X, y2);
                y2 += 10;
                
                // Subtexto "Estimado Mensual"
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(156, 163, 175);
                doc.text(tr('Estimado Mensual'), col2X, y2);
                y2 += 12;
                
                // Precio anual nuevo (color de marca)
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18);
                doc.setTextColor(...brandColor);
                doc.text(eur(resFijo.totalAnnual) + tr('/aÃ±o'), col2X, y2);
                
                // === COLUMNA 3: AHORRO + NUEVO COSTE INDEXADO (DERECHA) - CAJA SUBIDA ===
                
                let y3 = yPos;
                
                // Caja superior "TU AHORRO ANUAL INDEXADO" (con mismo color que FIJO)
                doc.setFillColor(...cajaHeaderColor);
                doc.roundedRect(col3X - 2, y3, colWidth - 8, boxHeaderHeight, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                doc.text('TU AHORRO ANUAL INDEXADO', col3X + (colWidth - 8) / 2 - 2, y3 + 8, { align: 'center' });
                y3 += boxHeaderHeight + 12;
                
                // Ahorro en verde GRANDE
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(30);
                doc.setTextColor(22, 163, 74);
                doc.text(eur(resIndexed.savings), col3X, y3);
                y3 += 18;
                
                // "TU NUEVO COSTE [MARCA]"
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.setTextColor(107, 114, 128);
                doc.text(tr('TU NUEVO COSTE') + ' ' + brand.NAME.toUpperCase(), col3X, y3);
                y3 += 12;
                
                // Precio mensual nuevo
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(20);
                doc.setTextColor(22, 163, 74);
                doc.text(eur(resIndexed.totalAnnual / 12) + tr('/mes'), col3X, y3);
                y3 += 10;
                
                // Subtexto "Estimado Mensual"
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(156, 163, 175);
                doc.text(tr('Estimado Mensual'), col3X, y3);
                y3 += 12;
                
                // Precio anual nuevo
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18);
                doc.setTextColor(22, 163, 74);
                doc.text(eur(resIndexed.totalAnnual) + tr('/aÃ±o'), col3X, y3);
                
                // Actualizar yPos al mÃ¡ximo de las tres columnas
                const maxY = Math.max(y1, y2, y3);
                
                // LÃNEAS VERTICALES SEPARADORAS
                const lineStartY = yPos - 5;
                const lineEndY = maxY + 5;
                
                // LÃ­nea entre columna 1 y 2
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.5);
                doc.line(col2X - 10, lineStartY, col2X - 10, lineEndY);
                
                // LÃ­nea entre columna 2 y 3
                doc.line(col3X - 10, lineStartY, col3X - 10, lineEndY);
                
                yPos = maxY + 15;
                
                // === PÃGINA 2: DESGLOSE DETALLADO POR SUMINISTRO ===
                doc.addPage();
                yPos = 15;
                
                // TÃ­tulo verde con bordes redondeados
                doc.setFillColor(34, 197, 94);
                doc.roundedRect(margin, yPos, contentWidth, 14, 4, 4, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('DESGLOSE DETALLADO POR SUMINISTRO', pageWidth / 2, yPos + 10, { align: 'center' });
                yPos += 22;
                
                const col2Width = (contentWidth - 6) / 2;
                const leftX = margin;
                const rightX = margin + col2Width + 6;
                
                // FunciÃ³n para generar desglose con cajas grises
                function generarDesgloseConCajasGrises(res, x, width, esFijo) {
                    if (!res || !res.powerCosts || !res.energyCosts) {
                        console.error('ERROR: res no tiene la estructura necesaria', res);
                        return;
                    }
                    
                    let y = yPos;
                    
                    // === CABECERA GRIS OSCURA CON CUPS ===
                    doc.setFillColor(71, 85, 105);
                    doc.roundedRect(x, y, width, 14, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`[${res.cups || 'N/A'}]`, x + 3, y + 4);
                    doc.text(`Tipo: ${res.originalTariffType || tariffType}`, x + width - 3, y + 4, { align: 'right' });
                    doc.text(`DÃ­as: ${res.dias_facturados || 0}`, x + width - 3, y + 8, { align: 'right' });
                    
                    // Nombre completo: Comercializadora - Tarifa
                    doc.setFontSize(6.5);
                    doc.setFont('helvetica', 'normal');
                    const comercializadora = res.offer.name || brand.NAME;
                    const nombreTarifa = res.offer.description || 'N/A';
                    const nombreCompleto = `${comercializadora} - ${nombreTarifa}`;
                    doc.text(nombreCompleto, x + 3, y + 11);
                    
                    y += 16;
                    
                    // === CAJA PRECIOS APLICADOS ===
                    doc.setFillColor(100, 116, 139);
                    doc.roundedRect(x, y, width, 8, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PRECIOS APLICADOS:', x + 3, y + 6);
                    y += 10;
                    
                    // Info de precios (Potencia y EnergÃ­a) - Altura dinÃ¡mica segÃºn perÃ­odos
                    const numPowerPeriods = Math.min(res.powerCosts.length, 6);
                    const numEnergyPeriods = Math.min(res.energyCosts.length, 6);
                    const maxPeriods = Math.max(numPowerPeriods, numEnergyPeriods);
                    const boxHeight = 6 + (maxPeriods * 3.2); // Altura base 6 + 3.2 por cada perÃ­odo (mÃ¡s espacio)
                    
                    doc.setFillColor(100, 116, 139);
                    doc.roundedRect(x, y, width, boxHeight, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('POTENCIA:'), x + 3, y + 4);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(5.5);
                    
                    // Mostrar precios de potencia reales (todos los perÃ­odos disponibles)
                    let potenciaY = y + 8;
                    const maxPowerPeriodsToShow = Math.min(res.powerCosts.length, 6); // MÃ¡ximo 6 perÃ­odos
                    for (let i = 0; i < maxPowerPeriodsToShow; i++) {
                        if (res.powerCosts[i]) {
                            doc.text(`P${i + 1}: ${num(res.powerCosts[i].priceDay || 0, 6)} â‚¬/kW/dÃ­a`, x + 3, potenciaY);
                            potenciaY += 3.2;
                        }
                    }
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(6);
                    doc.text('ENERGÃA:', x + width/2, y + 4);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(5.5);
                    
                    // Mostrar precios de energÃ­a reales (todos los perÃ­odos disponibles)
                    let energiaY = y + 8;
                    const maxEnergyPeriodsToShow = Math.min(res.energyCosts.length, 6); // MÃ¡ximo 6 perÃ­odos
                    for (let i = 0; i < maxEnergyPeriodsToShow; i++) {
                        if (res.energyCosts[i]) {
                            doc.text(`E${i + 1}: ${num(res.energyCosts[i].price || 0, 6)} â‚¬/kWh`, x + width/2, energiaY);
                            energiaY += 3.2;
                        }
                    }
                    y += boxHeight + 4;
                    
                    // === SECCIÃ“N POTENCIA ===
                    doc.setFillColor(100, 116, 139);
                    doc.roundedRect(x, y, width, 7, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('POTENCIA', x + 3, y + 5);
                    y += 9;
                    
                    // Desglose potencia
                    doc.setTextColor(55, 65, 81);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'normal');
                    res.powerCosts.forEach((p, i) => {
                        if (p.kw > 0) {
                            const texto = `P${i+1}: (${num(p.kw, 2)} kW x ${num(p.priceDay, 6)} â‚¬/kW/dÃ­a)`;
                            doc.text(texto, x + 3, y);
                            doc.text(eur(p.cost), x + width - 3, y, { align: 'right' });
                            y += 4;
                        }
                    });
                    y += 2;
                    
                    // === SECCIÃ“N ENERGÃA ===
                    doc.setFillColor(100, 116, 139);
                    doc.roundedRect(x, y, width, 7, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('ENERGÃA', x + 3, y + 5);
                    y += 9;
                    
                    // Desglose energÃ­a
                    doc.setTextColor(55, 65, 81);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'normal');
                    res.energyCosts.forEach((e, i) => {
                        if (e.kwh > 0) {
                            let periodoNombre = '';
                            if (tariffType === '2.0TD') {
                                if (i === 0) periodoNombre = ` (${tr('Punta')})`;
                                else if (i === 1) periodoNombre = ` (${tr('Llano')})`;
                                else if (i === 2) periodoNombre = ` (${tr('Valle')})`;
                            }
                            const texto = `E${i+1}${periodoNombre}: (${num(e.kwh, 0)} kWh x ${num(e.price, 6)} â‚¬/kWh)`;
                            doc.text(texto, x + 3, y);
                            doc.text(eur(e.cost), x + width - 3, y, { align: 'right' });
                            y += 4;
                        }
                    });
                    y += 2;
                    
                    // === TOTAL ===
                    doc.setFillColor(71, 85, 105);
                    doc.roundedRect(x, y, width, 9, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${tr('TOTAL')} (${res.dias_facturados || 0} ${tr('DÃAS')})`, x + 3, y + 6);
                    doc.text(eur(res.totalPeriod || res.importe_total || 0), x + width - 3, y + 6, { align: 'right' });
                    y += 12;
                    
                    // === AHORRO ===
                    doc.setFillColor(220, 38, 38);
                    doc.roundedRect(x + width - 55, y, 52, 10, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('AHORRO:', x + width - 52, y + 4);
                    doc.setFontSize(9);
                    doc.text(eur(res.savings || 0), x + width - 28, y + 7, { align: 'center' });
                }
                
                // Generar desgloses en dos columnas
                generarDesgloseConCajasGrises(resFijo, leftX, col2Width, true);
                generarDesgloseConCajasGrises(resIndexed, rightX, col2Width, false);
                
                yPos += 120;
                
                // === PÃGINA 3: EXPLICACIÃ“N ===
                doc.addPage();
                yPos = 15;
                
                // Definir variables para las dos columnas de la explicaciÃ³n
                const colWidthPage3 = (contentWidth - 3) / 2;
                const leftXPage3 = margin;
                const rightXPage3 = margin + colWidthPage3 + 3;
                
                doc.setFillColor(245, 245, 245);
                doc.roundedRect(margin, yPos, contentWidth, 120, 2, 2, 'F');
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('CUAL ES LA DIFERENCIA?', pageWidth / 2, yPos + 8, { align: 'center' });
                
                yPos += 15;
                
                // Columna izquierda - Tarifa Fija
                let leftColY = yPos;
                doc.setFontSize(9);
                doc.setTextColor(...blueColor);
                doc.setFont('helvetica', 'bold');
                doc.text('POR QUE TARIFA FIJA?', leftXPage3 + 2, leftColY);
                leftColY += 6;
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                const fijaTextFull = [
                    'â€¢ Implica un precio fijo por los kilovatios que',
                    '  consumes (kWh).',
                    '',
                    'â€¢ El precio se mantiene estable,',
                    '  independientemente de cÃ³mo se comporten los',
                    '  precios en el mercado elÃ©ctrico.',
                    '',
                    'â€¢ Cuando el precio del mercado estÃ¡ alto, el',
                    '  cliente estÃ¡ protegido frente a sobresaltos.',
                    '',
                    'â€¢ No tendrÃ¡s que estar pendiente de las',
                    '  variaciones del mercado y podrÃ¡s seguir',
                    '  usando la electricidad como siempre.'
                ];
                
                fijaTextFull.forEach(line => {
                    doc.text(line, leftXPage3 + 2, leftColY, { maxWidth: colWidthPage3 - 4 });
                    leftColY += 3.5;
                });
                
                // Columna derecha - Tarifa Indexada
                let rightColY = yPos;
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...greenColor);
                doc.text('POR QUE TARIFA INDEXADA?', rightXPage3 + 2, rightColY);
                rightColY += 6;
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                const indexadaTextFull = [
                    'â€¢ Implica un precio variable por los kilovatios',
                    '  que consumes (kWh) cada mes.',
                    '',
                    'â€¢ Es la tarifa mÃ¡s justa, ya que pagas el coste',
                    '  real de la energÃ­a mes a mes.',
                    '',
                    'â€¢ Al contratarla, el cliente evita pagar',
                    '  mÃ¡rgenes adicionales cuando el precio de la',
                    '  electricidad es mÃ¡s barato.',
                    '',
                    'â€¢ A largo plazo, con un indexado 100%',
                    '  funcional, se puede obtener un ahorro',
                    '  aproximado de hasta un 20% en Ã©pocas de',
                    '  mejor precio.'
                ];
                
                indexadaTextFull.forEach(line => {
                    doc.text(line, rightXPage3 + 2, rightColY, { maxWidth: colWidthPage3 - 4 });
                    rightColY += 3.5;
                });
                
                // Guardar PDF
                const filename = `Comparacion_Fijo_vs_Indexado_${resFijo.cups.slice(-6)}.pdf`;
                doc.save(filename);
                
                window.showMessageModal(`âœ… PDF generado con Ã©xito: ${filename}`);
                
                // Cerrar modal
                document.getElementById('send-offer-modal').classList.add('hidden');
                document.getElementById('send-offer-modal').classList.remove('flex');
                
            } catch (error) {
                console.error('Error generando PDF dual:', error);
                window.showErrorModal(`Error al generar PDF: ${error.message}`);
            }
        }


        async function generateMultiPDF_Dual(res, commercialCode = 'D=00', clientName = '[NOMBRE COMPLETO CLIENTE]', clientPhone = '', clientEmail = '', clientAddress = '') {
            try {
                console.log('=== generateMultiPDF_Dual INICIADO ===');
                console.log('res recibido:', res);
                console.log('commercialCode:', commercialCode);
                console.log('clientName:', clientName);
                console.log('clientAddress:', clientAddress);
                console.log('res.individualResults:', res.individualResults);
                
                if (res.individualResults && res.individualResults.length > 0) {
                    console.log('Primer supply:', res.individualResults[0]);
                    console.log('Primer supply tiene indexedComparison?:', !!res.individualResults[0].indexedComparison);
                    if (res.individualResults[0].indexedComparison) {
                        console.log('indexedComparison:', res.individualResults[0].indexedComparison);
                        console.log('indexedComparison.powerCosts?:', !!res.individualResults[0].indexedComparison.powerCosts);
                        console.log('indexedComparison.energyCosts?:', !!res.individualResults[0].indexedComparison.energyCosts);
                    }
                }
                
                console.log('ðŸŸ¢ ANTES de showMessageModal');
                window.showMessageModal("â³ Generando PDF MULTICUPS con comparaciÃ³n Fijo vs Indexado... Por favor espere.");
                console.log('ðŸŸ¢ DESPUÃ‰S de showMessageModal');
                
                console.log('ðŸŸ¢ ANTES de obtener jsPDF');
                const { jsPDF } = window.jspdf;
                console.log('ðŸŸ¢ DESPUÃ‰S de obtener jsPDF, creando documento...');
                let doc = new jsPDF('p', 'mm', 'a4');
                console.log('ðŸŸ¢ Documento PDF creado exitosamente');
                
                // CRÃTICO: Activar traducciÃ³n automÃ¡tica de textos
                if (window.setupPDFTranslation) {
                    doc = window.setupPDFTranslation(doc);
                }
                
                console.log('âœ… PASO 1: Objeto PDF creado');
                
                const darkColor = [107, 125, 142];
                const greenColor = [22, 163, 74];
                const redColor = [220, 38, 38];
                
                // CRÃTICO: Colores segÃºn marca activa
                const brand = activeBrand;
                const isDrk = brand.NAME.includes('DRK');
                const brandColor = isDrk ? [59, 130, 246] : [132, 204, 22];  // Azul DRK o Verde POWER CUP
                const blueColor = brandColor;  // Alias para compatibilidad
                
                const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
                const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
                const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
                
                // Nota: clientName y clientAddress ya fueron capturados arriba (lÃ­nea 6336-6337)
                console.log('ðŸ  DirecciÃ³n capturada:', clientAddress);
                console.log('ðŸ“ CÃ³digo comercial:', commercialCode);
                
                let yPos = 0;
                const pageWidth = 210;
                const margin = 12;
                const contentWidth = pageWidth - (2 * margin);
                const colWidth = (contentWidth / 2) - 3;
                const leftX = margin;
                const rightX = margin + colWidth + 6;
                
                console.log('âœ… PASO 2: Variables definidas - leftX:', leftX, 'rightX:', rightX, 'colWidth:', colWidth);
                
                // === PÃGINA 1: RESUMEN GENERAL ===
                const headerHeight = 35;
                
                // CRÃTICO: Color del header segÃºn marca
                const headerColor = isDrk ? [107, 125, 142] : [115, 130, 95]; // Gris azulado (DRK) o Verde oliva (POWER)
                
                for (let i = 0; i < pageWidth; i++) {
                    const ratio = i / pageWidth;
                    const r = Math.round(headerColor[0] + (240 - headerColor[0]) * ratio);
                    const g = Math.round(headerColor[1] + (245 - headerColor[1]) * ratio);
                    const b = Math.round(headerColor[2] + (250 - headerColor[2]) * ratio);
                    doc.setFillColor(r, g, b);
                    doc.rect(i, 0, 1, headerHeight, 'F');
                }
                
                // Logo segÃºn marca
                const logoX = margin + 8;
                const logoY = 12;
                const logoRadius = 5;
                
                if (isDrk) {
                    // Logo DRK (anillo multicolor)
                    doc.setFillColor(219, 68, 55);
                    doc.circle(logoX - 1, logoY + 1, logoRadius * 0.8, 'F');
                    doc.setFillColor(66, 133, 244);
                    doc.circle(logoX + 1, logoY - 1, logoRadius * 0.8, 'F');
                    doc.setFillColor(244, 180, 0);
                    doc.circle(logoX - 1, logoY - 1, logoRadius * 0.7, 'F');
                    doc.setFillColor(15, 157, 88);
                    doc.circle(logoX + 1, logoY + 1, logoRadius * 0.7, 'F');
                    doc.setFillColor(255, 255, 255);
                    doc.circle(logoX, logoY, logoRadius * 0.4, 'F');
                } else {
                    // Logo POWER CUP (taza con rayo)
                    // Plato/base (verde oscuro)
                    doc.setFillColor(60, 90, 50);
                    doc.rect(logoX - 5, logoY + 4, 10, 1, 'F');
                    
                    // Borde de la taza (verde oscuro)
                    doc.setDrawColor(60, 90, 50);
                    doc.setLineWidth(1.2);
                    doc.roundedRect(logoX - 3.5, logoY - 2, 7, 6, 0.5, 0.5, 'S');
                    
                    // Asa de la taza
                    doc.setLineWidth(1);
                    doc.line(logoX + 3.5, logoY, logoX + 5, logoY - 0.5);
                    doc.line(logoX + 5, logoY - 0.5, logoX + 5.5, logoY + 1);
                    doc.line(logoX + 5.5, logoY + 1, logoX + 5, logoY + 2.5);
                    doc.line(logoX + 5, logoY + 2.5, logoX + 3.5, logoY + 2);
                    
                    // Rayo dentro de la taza (amarillo/oro)
                    doc.setFillColor(255, 215, 0);
                    doc.setLineWidth(0.3);
                    const rayoX = logoX - 0.5;
                    const rayoY = logoY;
                    doc.line(rayoX, rayoY - 1, rayoX - 0.7, rayoY + 0.5);
                    doc.line(rayoX - 0.7, rayoY + 0.5, rayoX + 0.3, rayoY + 0.3);
                    doc.line(rayoX + 0.3, rayoY + 0.3, rayoX, rayoY + 2);
                    doc.line(rayoX, rayoY + 2, rayoX + 0.7, rayoY + 0.2);
                    doc.line(rayoX + 0.7, rayoY + 0.2, rayoX - 0.3, rayoY + 0.5);
                }
                
                // Texto del nombre de marca
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(brand.NAME.toUpperCase(), logoX + 12, 14);
                
                // Subtexto segÃºn marca
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                if (isDrk) {
                    doc.text(tr('Liderando el ahorro y la'), logoX + 12, 20);
                    doc.text(tr('eficiencia energÃ©tica.'), logoX + 12, 24);
                } else {
                    doc.text(tr('AsesorÃ­a EnergÃ©tica'), logoX + 12, 20);
                }
                
                doc.setTextColor(40, 60, 80);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('MULTICUPS', pageWidth - margin, 12, { align: 'right' });
                doc.setFontSize(11);
                doc.setTextColor(255, 255, 255);
                doc.text('FIJO VS INDEXADO', pageWidth - margin, 18, { align: 'right' });
                doc.setFontSize(9);
                doc.setTextColor(100, 120, 140);
                doc.text(`Total: ${res.cups}`, pageWidth - margin, 24, { align: 'right' });
                
                console.log('âœ… PASO 3: Encabezado completo creado (logo + tÃ­tulo + Total CUPS:', res.cups, ')');
                
                yPos = headerHeight + 8;
                
                // === PÃGINA 1: RESUMEN VISUAL MEJORADO MULTICUPS ===
                
                yPos = headerHeight + 8;
                
                // === DATOS DEL CLIENTE ===
                
                // TÃ­tulo "COMPARATIVA PROFESIONAL - DRK"
                doc.setTextColor(55, 65, 81);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('COMPARATIVA PROFESIONAL - ' + brand.NAME.toUpperCase(), margin, yPos);
                yPos += 8;
                
                // Info del cliente
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.setTextColor(75, 85, 99);
                doc.text(tr('CLIENTE:') + ' ' + clientName.toUpperCase(), margin, yPos);
                yPos += 6;
                doc.text('CUPS TOTALES: ' + res.cups, margin, yPos);
                yPos += 12;
                
                // === CAJA GRANDE CON LA MEJOR OPCIÃ“N ===
                
                const bigBoxY = yPos;
                const bigBoxHeight = 45;
                const bigBoxMargin = 20;
                const bigBoxWidth = contentWidth - (bigBoxMargin * 2);
                const bigBoxX = margin + bigBoxMargin;
                
                // CRÃTICO: Color de fondo segÃºn marca
                const bigBoxColor = isDrk ? [100, 116, 139] : [115, 130, 95]; // Gris azulado (DRK) o Verde oliva (POWER)
                doc.setFillColor(...bigBoxColor);
                doc.roundedRect(bigBoxX, bigBoxY, bigBoxWidth, bigBoxHeight, 4, 4, 'F');
                
                // Texto "LA MEJOR OPCIÃ“N PARA TI ES"
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.text(tr('LA MEJOR OPCIÃ“N PARA TI ES'), pageWidth / 2, bigBoxY + 12, { align: 'center' });
                
                // Nombre de la marca en grande
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(30);
                doc.text(brand.NAME.toUpperCase(), pageWidth / 2, bigBoxY + 26, { align: 'center' });
                
                // DescripciÃ³n
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                const descripcion = tr('Ofrece el mayor ahorro consolidado con') + ' ' + brand.FULL_NAME + '.';
                doc.text(descripcion, pageWidth / 2, bigBoxY + 37, { align: 'center' });
                
                yPos = bigBoxY + bigBoxHeight + 10;
                
                // === TRES CAJAS GRANDES ===
                const boxWidth = (contentWidth - 4) / 3;
                const box1X = margin;
                const box2X = margin + boxWidth + 2;
                const box3X = margin + (boxWidth + 2) * 2;
                const boxHeight = 60;
                
                // Calcular totales
                const totalIndexadoAnual = res.indexedTotals ? res.indexedTotals.totalAnnual : 0;
                const ahorroIndexado = res.indexedTotals ? res.indexedTotals.savings : 0;
                
                // FunciÃ³n para dibujar caja (igual que en PDF individual)
                function drawVisualBox(x, headerColor, headerText, label, mainPrice, subLabel, bottomPrice, isCrossed = false) {
                    let y = yPos;
                    
                    // Cabecera de color
                    doc.setFillColor(...headerColor);
                    doc.roundedRect(x, y, boxWidth, 9, 1.5, 1.5, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(6.5);
                    doc.setFont('helvetica', 'bold');
                    const headerLines = doc.splitTextToSize(headerText, boxWidth - 2);
                    doc.text(headerLines, x + boxWidth / 2, y + 4, { align: 'center' });
                    y += 10;
                    
                    // Cuerpo de la caja
                    const bodyColor = headerColor[0] === 75 ? [248, 249, 250] : (headerColor[0] === 59 ? [239, 246, 255] : [240, 253, 244]);
                    doc.setFillColor(...bodyColor);
                    doc.setDrawColor(...headerColor);
                    doc.setLineWidth(1.5);
                    doc.roundedRect(x, y, boxWidth, boxHeight - 10, 1.5, 1.5, 'FD');
                    
                    // Label
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'bold');
                    doc.text(label.toUpperCase(), x + boxWidth / 2, y + 7, { align: 'center' });
                    
                    // Precio principal (grande)
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(isCrossed ? 220 : headerColor[0], isCrossed ? 38 : headerColor[1], isCrossed ? 38 : headerColor[2]);
                    const mainPriceText = mainPrice;
                    doc.text(mainPriceText, x + boxWidth / 2, y + 18, { align: 'center' });
                    
                    // Tachar si es necesario
                    if (isCrossed) {
                        const textWidth = doc.getTextWidth(mainPriceText);
                        doc.setDrawColor(220, 38, 38);
                        doc.setLineWidth(0.7);
                        doc.line(x + boxWidth / 2 - textWidth / 2, y + 17, x + boxWidth / 2 + textWidth / 2, y + 17);
                    }
                    
                    // Sublabel
                    doc.setFontSize(5.5);
                    doc.setTextColor(120, 120, 120);
                    doc.setFont('helvetica', 'normal');
                    doc.text(subLabel, x + boxWidth / 2, y + 24, { align: 'center' });
                    
                    // LÃ­nea separadora
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.3);
                    doc.line(x + 5, y + 30, x + boxWidth - 5, y + 30);
                    
                    // Precio inferior (anual)
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(isCrossed ? 220 : headerColor[0], isCrossed ? 38 : headerColor[1], isCrossed ? 38 : headerColor[2]);
                    doc.text(bottomPrice, x + boxWidth / 2, y + 42, { align: 'center' });
                }
                
                // CAJA 1: TU FACTURA ACTUAL (GRIS) - REEMPLAZADA CON DISEÃ‘O LIMPIO
                
                console.log('âœ… PASO 4: Iniciando dibujo de 3 columnas (Factura Actual, Fijo, Indexado)');
                
                // === COLUMNA 1: TU FACTURA ACTUAL (DISEÃ‘O LIMPIO) ===
                let y1 = yPos + 25;
                
                // TÃ­tulo
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.setTextColor(107, 114, 128);
                doc.text(tr('TU FACTURA ACTUAL'), margin, y1);
                y1 += 12;
                
                // Precio mensual (TACHADO)
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(22);
                doc.setTextColor(220, 38, 38);
                const precioMensualActual = eur(res.importe_total);
                doc.text(precioMensualActual, margin, y1);
                
                // LÃ­nea tachada
                const tw1 = doc.getTextWidth(precioMensualActual);
                doc.setDrawColor(220, 38, 38);
                doc.setLineWidth(1.5);
                doc.line(margin, y1 - 4, margin + tw1, y1 - 4);
                y1 += 10;
                
                // Subtexto
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(156, 163, 175);
                doc.text('Total Periodo (varios dÃ­as)', margin, y1);
                y1 += 14;
                
                // Precio anual (TACHADO)
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(20);
                doc.setTextColor(220, 38, 38);
                const precioAnualActual = eur(res.originalBillAnnual) + tr('/aÃ±o');
                doc.text(precioAnualActual, margin, y1);
                
                // LÃ­nea tachada
                const tw2 = doc.getTextWidth(precioAnualActual);
                doc.setDrawColor(220, 38, 38);
                doc.setLineWidth(1.5);
                doc.line(margin, y1 - 3, margin + tw2, y1 - 3);
                
                // === COLUMNA 2: AHORRO + NUEVO COSTE FIJO (CENTRO) ===
                
                let y2 = yPos;
                const col2X = margin + (contentWidth / 3);
                
                // CRÃTICO: Color de caja segÃºn marca
                const cajaHeaderColor = isDrk ? [100, 116, 139] : [115, 130, 95]; // Gris azulado (DRK) o Verde oliva (POWER)
                
                // Caja superior "TU AHORRO ANUAL FIJO"
                const boxHeaderHeight = 12;
                doc.setFillColor(...cajaHeaderColor);
                doc.roundedRect(col2X - 2, y2, (contentWidth / 3) - 8, boxHeaderHeight, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                doc.text('TU AHORRO ANUAL FIJO', col2X + ((contentWidth / 3) - 8) / 2 - 2, y2 + 8, { align: 'center' });
                y2 += boxHeaderHeight + 12;
                
                // Ahorro en verde GRANDE
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(30);
                doc.setTextColor(22, 163, 74);
                doc.text(eur(res.savings), col2X, y2);
                y2 += 18;
                
                // "TU NUEVO COSTE [MARCA]"
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.setTextColor(107, 114, 128);
                doc.text(tr('TU NUEVO COSTE') + ' ' + brand.NAME.toUpperCase(), col2X, y2);
                y2 += 12;
                
                // Precio mensual nuevo (color de marca)
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(20);
                doc.setTextColor(...brandColor);
                doc.text(eur(res.totalAnnual / 12) + tr('/mes'), col2X, y2);
                y2 += 10;
                
                // Subtexto "Estimado Mensual"
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(156, 163, 175);
                doc.text(tr('Estimado Mensual'), col2X, y2);
                y2 += 12;
                
                // Precio anual nuevo (color de marca)
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18);
                doc.setTextColor(...brandColor);
                doc.text(eur(res.totalAnnual) + tr('/aÃ±o'), col2X, y2);
                
                // === COLUMNA 3: AHORRO + NUEVO COSTE INDEXADO (DERECHA) ===
                
                let y3 = yPos;
                const col3X = margin + (contentWidth / 3) * 2;
                
                // Caja superior "TU AHORRO ANUAL INDEXADO" (con mismo color que FIJO)
                doc.setFillColor(...cajaHeaderColor);
                doc.roundedRect(col3X - 2, y3, (contentWidth / 3) - 8, boxHeaderHeight, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                doc.text('TU AHORRO ANUAL INDEXADO', col3X + ((contentWidth / 3) - 8) / 2 - 2, y3 + 8, { align: 'center' });
                y3 += boxHeaderHeight + 12;
                
                // Ahorro en verde GRANDE
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(30);
                doc.setTextColor(22, 163, 74);
                doc.text(eur(ahorroIndexado), col3X, y3);
                y3 += 18;
                
                // "TU NUEVO COSTE [MARCA]"
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.setTextColor(107, 114, 128);
                doc.text(tr('TU NUEVO COSTE') + ' ' + brand.NAME.toUpperCase(), col3X, y3);
                y3 += 12;
                
                // Precio mensual nuevo
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(20);
                doc.setTextColor(22, 163, 74);
                doc.text(eur(totalIndexadoAnual / 12) + tr('/mes'), col3X, y3);
                y3 += 10;
                
                // Subtexto "Estimado Mensual"
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(156, 163, 175);
                doc.text(tr('Estimado Mensual'), col3X, y3);
                y3 += 12;
                
                // Precio anual nuevo
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18);
                doc.setTextColor(22, 163, 74);
                doc.text(eur(totalIndexadoAnual) + tr('/aÃ±o'), col3X, y3);
                
                // Actualizar yPos al mÃ¡ximo de las tres columnas
                const maxY = Math.max(y1, y2, y3);
                
                // LÃNEAS VERTICALES SEPARADORAS
                const lineStartY = yPos - 5;
                const lineEndY = maxY + 5;
                
                // LÃ­nea entre columna 1 y 2
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.5);
                doc.line(col2X - 10, lineStartY, col2X - 10, lineEndY);
                
                // LÃ­nea entre columna 2 y 3
                doc.line(col3X - 10, lineStartY, col3X - 10, lineEndY);
                
                yPos = maxY + 15;
                
                // === TABLA RESUMEN DE SUMINISTROS ===
                // TÃ­tulo resumen (verde)
                doc.setFillColor(...greenColor);
                doc.roundedRect(margin, yPos, contentWidth, 10, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                const resumenText = `${tr('RESUMEN DE')} ${res.individualResults.length} ${tr('SUMINISTROS')}`;
                doc.text(resumenText, margin + 3, yPos + 6.5);
                yPos += 14;
                
                // Cabecera tabla (gris oscuro con texto blanco)
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.setFillColor(...darkColor);
                doc.roundedRect(margin, yPos, contentWidth, 7, 2, 2, 'F');
                doc.text('NÂº', margin + 2, yPos + 5);
                doc.text(tr('CUPS / DIRECCIÃ“N'), margin + 12, yPos + 5);
                doc.text('TIPO', margin + 95, yPos + 5);
                doc.text('DÃAS', margin + 115, yPos + 5);
                doc.text('AHORRO', pageWidth - margin - 28, yPos + 5);
                yPos += 7;
                
                // Filas de suministros
                doc.setFont('helvetica', 'normal');
                res.individualResults.forEach((supply, idx) => {
                    // Verificar si necesitamos nueva pÃ¡gina
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    // Fondo alternado - altura aumentada para incluir direcciÃ³n
                    const rowHeight = supply.supplyAddress ? 11 : 7;
                    if (idx % 2 === 0) {
                        doc.setFillColor(248, 250, 252); // Azul muy claro
                        doc.rect(margin, yPos, contentWidth, rowHeight, 'F');
                    }
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(8);
                    doc.text(`[${idx + 1}]`, margin + 2, yPos + 4.5);
                    
                    // CUPS (primera lÃ­nea)
                    doc.setFontSize(7);
                    doc.text(supply.cups, margin + 12, yPos + 4.5);
                    
                    // DIRECCIÃ“N (segunda lÃ­nea, si existe)
                    if (supply.supplyAddress && supply.supplyAddress !== 'No especificada') {
                        doc.setFontSize(6);
                        doc.setTextColor(100, 116, 139); // Gris para la direcciÃ³n
                        const direccionCorta = supply.supplyAddress.length > 35 
                            ? supply.supplyAddress.substring(0, 32) + '...' 
                            : supply.supplyAddress;
                        doc.text(direccionCorta, margin + 12, yPos + 8.5);
                        doc.setTextColor(0, 0, 0);
                    }
                    
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text(supply.originalTariffType, margin + 95, yPos + 4.5);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`${supply.dias_facturados}`, margin + 118, yPos + 4.5, { align: 'center' });
                    
                    // Calcular ahorro (fijo vs indexado)
                    const ahorroSupply = supply.savings || 0;
                    const savSupply = ahorroSupply < 0 ? '0,00 â‚¬' : eur(ahorroSupply);
                    const colorSupply = ahorroSupply < 0 ? [150, 150, 150] : greenColor;
                    doc.setTextColor(...colorSupply);
                    doc.setFont('helvetica', 'bold');
                    doc.text(savSupply, pageWidth - margin - 2, yPos + 4.5, { align: 'right' });
                    yPos += rowHeight;
                });
                
                yPos += 10;
                
                // === PÃGINAS 2-N: DESARROLLO DETALLADO DE CADA CUPS ===
                
                // FunciÃ³n auxiliar para generar desglose detallado
                function generarDesgloseDetalladoCUPS(supply, x, width, color, titulo, usarIndexado = false) {
                    const resultado = usarIndexado && supply.indexedComparison ? supply.indexedComparison : supply;
                    
                    // VERIFICACIÃ“N CRÃTICA: Asegurar que resultado tiene los datos necesarios
                    if (!resultado || !resultado.powerCosts || !resultado.energyCosts) {
                        console.error('ERROR: resultado no tiene la estructura necesaria', resultado);
                        doc.setTextColor(220, 38, 38);
                        doc.setFontSize(8);
                        doc.text('Error: Datos incompletos para este suministro', x + 2, yPos + 10);
                        return;
                    }
                    
                    const tariffType = resultado.originalTariffType || currentTariffType;
                    const config = TARIFF_CONFIG[tariffType] || TARIFF_CONFIG['2.0TD'];
                    
                    // COLORES SEGÃšN MARCA (PowerCup usa verde oliva en lugar de gris)
                    const headerDarkColor = isDrk ? [71, 85, 105] : [95, 110, 75];   // Gris oscuro DRK o Verde oliva oscuro PowerCup
                    const headerMedColor = isDrk ? [100, 116, 139] : [110, 125, 90]; // Gris medio DRK o Verde oliva medio PowerCup
                    
                    let y = yPos;
                    
                    // === CABECERA OSCURA CON CUPS ===
                    doc.setFillColor(...headerDarkColor);
                    doc.roundedRect(x, y, width, 14, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`[${supply.cups}]`, x + 3, y + 4);
                    doc.text(`Tipo: ${tariffType}`, x + width - 3, y + 4, { align: 'right' });
                    doc.text(`DÃ­as: ${resultado.dias_facturados || 0}`, x + width - 3, y + 8, { align: 'right' });
                    
                    // Nombre completo: Comercializadora - Tarifa
                    doc.setFontSize(6.5);
                    doc.setFont('helvetica', 'normal');
                    const comercializadora = resultado.offer.name || brand.NAME;
                    const nombreTarifa = resultado.offer.description || 'N/A';
                    const nombreCompleto = `${comercializadora} - ${nombreTarifa}`;
                    doc.text(nombreCompleto, x + 3, y + 11);
                    
                    y += 16;
                    
                    // === CAJA PRECIOS APLICADOS ===
                    doc.setFillColor(...headerMedColor);
                    doc.roundedRect(x, y, width, 8, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PRECIOS APLICADOS:', x + 3, y + 6);
                    y += 10;
                    
                    // Info de precios (Potencia y EnergÃ­a) - Altura dinÃ¡mica segÃºn perÃ­odos
                    const numPowerPeriods = Math.min(resultado.powerCosts.length, 6);
                    const numEnergyPeriods = Math.min(resultado.energyCosts.length, 6);
                    const maxPeriods = Math.max(numPowerPeriods, numEnergyPeriods);
                    const boxHeight = 6 + (maxPeriods * 3.2); // Altura base 6 + 3.2 por cada perÃ­odo (mÃ¡s espacio)
                    
                    doc.setFillColor(...headerMedColor);
                    doc.roundedRect(x, y, width, boxHeight, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('POTENCIA:'), x + 3, y + 4);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(5.5);
                    
                    // Mostrar precios de potencia reales (todos los perÃ­odos disponibles)
                    let potenciaY = y + 8;
                    const maxPowerPeriodsToShow = Math.min(resultado.powerCosts.length, 6); // MÃ¡ximo 6 perÃ­odos
                    for (let i = 0; i < maxPowerPeriodsToShow; i++) {
                        if (resultado.powerCosts[i]) {
                            doc.text(`P${i + 1}: ${num(resultado.powerCosts[i].priceDay || 0, 6)} â‚¬/kW/dÃ­a`, x + 3, potenciaY);
                            potenciaY += 3.2;
                        }
                    }
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(6);
                    doc.text('ENERGÃA:', x + width/2, y + 4);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(5.5);
                    
                    // Mostrar precios de energÃ­a reales (todos los perÃ­odos disponibles)
                    let energiaY = y + 8;
                    const maxEnergyPeriodsToShow = Math.min(resultado.energyCosts.length, 6); // MÃ¡ximo 6 perÃ­odos
                    for (let i = 0; i < maxEnergyPeriodsToShow; i++) {
                        if (resultado.energyCosts[i]) {
                            doc.text(`E${i + 1}: ${num(resultado.energyCosts[i].price || 0, 6)} â‚¬/kWh`, x + width/2, energiaY);
                            energiaY += 3.2;
                        }
                    }
                    y += boxHeight + 4;
                    
                    // === SECCIÃ“N POTENCIA ===
                    doc.setFillColor(...headerMedColor);
                    doc.roundedRect(x, y, width, 7, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('POTENCIA', x + 3, y + 5);
                    y += 9;
                    
                    // Desglose potencia
                    doc.setTextColor(55, 65, 81);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'normal');
                    resultado.powerCosts.forEach(p => {
                        if (p.kw > 0 || p.period <= config.powerPeriods) {
                            const formula = `P${p.period}: (${num(p.kw, 2)} kW x ${numPriceFormula(p.priceDay)} â‚¬/kW/dÃ­a)`;
                            doc.text(formula, x + 3, y);
                            doc.text(`${num(p.cost, 2)} â‚¬`, x + width - 3, y, { align: 'right' });
                            y += 4;
                        }
                    });
                    y += 2;
                    
                    // === SECCIÃ“N ENERGÃA ===
                    doc.setFillColor(...headerMedColor);
                    doc.roundedRect(x, y, width, 7, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('ENERGÃA', x + 3, y + 5);
                    y += 9;
                    
                    // Desglose energÃ­a
                    doc.setTextColor(55, 65, 81);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'normal');
                    resultado.energyCosts.forEach(e => {
                        if (e.kwh > 0 || e.period <= config.periods) {
                            let label = `E${e.period}`;
                            if (tariffType === '2.0TD') {
                                if (e.period === 1) label += ` (${tr('Punta')})`;
                                if (e.period === 2) label += ` (${tr('Llano')})`;
                                if (e.period === 3) label += ` (${tr('Valle')})`;
                            }
                            const formula = `${label}: (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)} â‚¬/kWh)`;
                            doc.text(formula, x + 3, y);
                            doc.text(`${num(e.cost, 2)} â‚¬`, x + width - 3, y, { align: 'right' });
                            y += 4;
                        }
                    });
                    y += 2;
                    
                    // === TOTAL ===
                    doc.setFillColor(...headerDarkColor);
                    doc.roundedRect(x, y, width, 9, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${tr('TOTAL')} (${resultado.dias_facturados || 0} ${tr('DÃAS')})`, x + 3, y + 6);
                    doc.text(eur(resultado.totalPeriod || 0), x + width - 3, y + 6, { align: 'right' });
                    y += 12;
                    
                    // === AHORRO ===
                    doc.setFillColor(220, 38, 38);
                    doc.roundedRect(x + width - 55, y, 52, 10, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('AHORRO:', x + width - 52, y + 4);
                    doc.setFontSize(9);
                    doc.text(eur(resultado.savings || 0), x + width - 28, y + 7, { align: 'center' });
                }
                
                console.log('âœ… PASO 5: FunciÃ³n generarDesgloseDetalladoCUPS definida');
                console.log('âœ… PASO 6: res.individualResults existe?', !!res.individualResults);
                console.log('âœ… PASO 6B: res.individualResults.length:', res.individualResults ? res.individualResults.length : 'undefined');
                
                // Generar pÃ¡ginas de desarrollo para cada CUPS
                console.log('ðŸ”§ Iniciando forEach de pÃ¡ginas detalladas para', res.individualResults ? res.individualResults.length : 0, 'suministros');
                res.individualResults.forEach((supply, idx) => {
                    console.log(`  ðŸ“„ Generando pÃ¡gina detallada ${idx + 1}/${res.individualResults.length} para CUPS:`, supply.cups);
                    doc.addPage();
                    yPos = 15;
                    
                    // ENCABEZADO PROFESIONAL CON FONDO DE COLOR
                    const headerBgColor = isDrk ? [140, 150, 160] : [110, 125, 90]; // Gris para DRK, verde oliva para POWER CUP
                    const headerHeight = 12;
                    
                    doc.setFillColor(...headerBgColor);
                    doc.roundedRect(margin, yPos, contentWidth, headerHeight, 3, 3, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${tr('DESARROLLO DETALLADO - SUMINISTRO')} ${idx + 1} ${tr('DE')} ${res.individualResults.length}`, pageWidth / 2, yPos + 8, { align: 'center' });
                    
                    yPos += headerHeight + 4;
                    
                    // Dos columnas con desarrollo
                    generarDesgloseDetalladoCUPS(
                        supply,
                        leftX,
                        colWidth,
                        blueColor,
                        `TARIFA FIJA: ${supply.offer.name}`,
                        false
                    );
                    
                    generarDesgloseDetalladoCUPS(
                        supply,
                        rightX,
                        colWidth,
                        greenColor,
                        `TARIFA INDEXADA: ${supply.indexedComparison ? supply.indexedComparison.offer.name : 'N/A'}`,
                        true
                    );
                });
                
                // === NUEVA PÃGINA: RESUMEN DE TODOS LOS SUMINISTROS ===
                doc.addPage();
                yPos = 20;
                
                // Encabezado con color segÃºn marca
                const headerBgColor = isDrk ? [140, 150, 160] : [110, 125, 90];
                doc.setFillColor(...headerBgColor);
                doc.roundedRect(margin, yPos, contentWidth, 14, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('RESUMEN DE TODOS LOS SUMINISTROS', pageWidth / 2, yPos + 9.5, { align: 'center' });
                yPos += 20;
                
                // Cabeceras de columnas (mismo color que el encabezado principal)
                doc.setFillColor(...headerBgColor);
                doc.roundedRect(leftX, yPos, colWidth, 8, 1, 1, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(8);
                doc.text(tr('TARIFAS FIJAS'), leftX + colWidth / 2, yPos + 5.5, { align: 'center' });
                
                doc.setFillColor(...headerBgColor);
                doc.roundedRect(rightX, yPos, colWidth, 8, 1, 1, 'F');
                doc.text(tr('TARIFAS INDEXADAS'), rightX + colWidth / 2, yPos + 5.5, { align: 'center' });
                yPos += 12;
                
                // Listar cada suministro
                let totalFijas = 0;
                let totalIndexadas = 0;
                
                res.individualResults.forEach((supply, idx) => {
                    // FIJO
                    doc.setFillColor(239, 246, 255);
                    doc.roundedRect(leftX, yPos, colWidth, 11, 1, 1, 'F');
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(6.5);
                    doc.setFont('helvetica', 'bold');
                    doc.text(supply.cups, leftX + 2, yPos + 4);
                    doc.setTextColor(22, 163, 74);
                    doc.setFontSize(7);
                    doc.text(eur(supply.savings), leftX + colWidth - 2, yPos + 4, { align: 'right' });
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(5.5);
                    doc.setFont('helvetica', 'normal');
                    const nombreFija = supply.offer.name || 'N/A';
                    doc.text(nombreFija.substring(0, 35), leftX + 2, yPos + 8.5);
                    
                    // INDEXADO
                    doc.setFillColor(240, 253, 244);
                    doc.roundedRect(rightX, yPos, colWidth, 11, 1, 1, 'F');
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(6.5);
                    doc.setFont('helvetica', 'bold');
                    doc.text(supply.cups, rightX + 2, yPos + 4);
                    const savingsIdx = supply.indexedComparison ? supply.indexedComparison.savings : 0;
                    doc.setTextColor(22, 163, 74);
                    doc.setFontSize(7);
                    doc.text(eur(savingsIdx), rightX + colWidth - 2, yPos + 4, { align: 'right' });
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(5.5);
                    doc.setFont('helvetica', 'normal');
                    const nombreIdx = supply.indexedComparison ? supply.indexedComparison.offer.name : 'N/A';
                    doc.text(nombreIdx.substring(0, 35), rightX + 2, yPos + 8.5);
                    
                    totalFijas += supply.savings || 0;
                    totalIndexadas += savingsIdx;
                    yPos += 13;
                });
                
                // Espacio antes de los totales
                yPos += 5;
                
                // CAJAS ROJAS CON TOTALES
                doc.setFillColor(220, 38, 38);
                doc.roundedRect(leftX, yPos, colWidth, 13, 2, 2, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('AHORRO TOTAL FIJAS:', leftX + 3, yPos + 6);
                doc.setFontSize(11);
                doc.text(eur(totalFijas), leftX + colWidth - 3, yPos + 9.5, { align: 'right' });
                
                doc.setFillColor(220, 38, 38);
                doc.roundedRect(rightX, yPos, colWidth, 13, 2, 2, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('AHORRO TOTAL INDEXADAS:', rightX + 3, yPos + 6);
                doc.setFontSize(11);
                doc.text(eur(totalIndexadas), rightX + colWidth - 3, yPos + 9.5, { align: 'right' });
                
                // === PÃGINA FINAL: EXPLICACIÃ“N ===
                doc.addPage();
                yPos = 15;
                
                doc.setFillColor(245, 245, 245);
                doc.roundedRect(margin, yPos, contentWidth, 120, 2, 2, 'F');
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('CUAL ES LA DIFERENCIA?'), pageWidth / 2, yPos + 8, { align: 'center' });
                
                yPos += 15;
                
                // Columna izquierda
                let leftColY = yPos;
                doc.setFontSize(9);
                doc.setTextColor(...blueColor);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('POR QUE TARIFA FIJA?'), leftX + 2, leftColY);
                leftColY += 6;
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                
                // Textos explicativos traducibles - divididos para caber en el PDF
                const fijaText1 = tr('Implica un precio fijo por los kilovatios que consumes (kWh).');
                const fijaText2 = tr('El precio se mantiene estable, independientemente de cÃ³mo se comporten los precios en el mercado elÃ©ctrico.');
                const fijaText3 = tr('Cuando el precio del mercado estÃ¡ alto, el cliente estÃ¡ protegido frente a sobresaltos.');
                const fijaText4 = tr('No tendrÃ¡s que estar pendiente de las variaciones del mercado y podrÃ¡s seguir usando la electricidad como siempre.');
                
                // Dividir textos en mÃºltiples lÃ­neas para que quepan
                const fijaExplText = [
                    `â€¢ ${doc.splitTextToSize(fijaText1, colWidth - 6).join('\n  ')}`,
                    '',
                    `â€¢ ${doc.splitTextToSize(fijaText2, colWidth - 6).join('\n  ')}`,
                    '',
                    `â€¢ ${doc.splitTextToSize(fijaText3, colWidth - 6).join('\n  ')}`,
                    '',
                    `â€¢ ${doc.splitTextToSize(fijaText4, colWidth - 6).join('\n  ')}`
                ];
                
                fijaExplText.forEach(line => {
                    const lines = line.split('\n');
                    lines.forEach(l => {
                        doc.text(l, leftX + 2, leftColY, { maxWidth: colWidth - 4 });
                        leftColY += 3.5;
                    });
                });
                
                // Columna derecha
                let rightColY = yPos;
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...greenColor);
                doc.text(tr('POR QUE TARIFA INDEXADA?'), rightX + 2, rightColY);
                rightColY += 6;
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                
                // Textos explicativos traducibles - divididos para caber en el PDF
                const indexText1 = tr('Implica un precio variable por los kilovatios que consumes (kWh) cada mes.');
                const indexText2 = tr('Es la tarifa mÃ¡s justa, ya que pagas el coste real de la energÃ­a mes a mes.');
                const indexText3 = tr('Al contratarla, el cliente evita pagar mÃ¡rgenes adicionales cuando el precio de la electricidad es mÃ¡s barato.');
                const indexText4 = tr('A largo plazo, con un indexado 100% funcional, se puede obtener un ahorro aproximado de hasta un 20% en Ã©pocas de mejor precio.');
                
                const indexExplText = [
                    `â€¢ ${doc.splitTextToSize(indexText1, colWidth - 6).join('\n  ')}`,
                    '',
                    `â€¢ ${doc.splitTextToSize(indexText2, colWidth - 6).join('\n  ')}`,
                    '',
                    `â€¢ ${doc.splitTextToSize(indexText3, colWidth - 6).join('\n  ')}`,
                    '',
                    `â€¢ ${doc.splitTextToSize(indexText4, colWidth - 6).join('\n  ')}`
                ];
                
                indexExplText.forEach(line => {
                    const lines = line.split('\n');
                    lines.forEach(l => {
                        doc.text(l, rightX + 2, rightColY, { maxWidth: colWidth - 4 });
                        rightColY += 3.5;
                    });
                });
                
                // Guardar
                const filename = `MULTICUPS_Fijo_vs_Indexado_${new Date().getTime()}.pdf`;
                doc.save(filename);
                
                window.showMessageModal(`âœ… PDF generado con Ã©xito: ${filename}`);
                
                // Cerrar modal
                document.getElementById('send-offer-modal').classList.add('hidden');
                document.getElementById('send-offer-modal').classList.remove('flex');
                
            } catch (error) {
                console.error('Error generando PDF MULTICUPS dual:', error);
                window.showErrorModal(`Error al generar PDF: ${error.message}`);
            }
        }

        
        // --- SOLICITAR MEJORA A DRK (SIN AHORRO) ---
        
        async function handleRequestImprovement() {
            console.log('handleRequestImprovement llamada');
            
            // Verificar si hay datos de ELECTRICIDAD, GAS o DUAL
            const hasElectricityData = lastComparisonResult !== null;
            const hasGasData = window.lastGasComparisonResult !== null;
            const hasDualData = window.dualGlobalResults !== null && typeof dualSupplies !== 'undefined' && dualSupplies && dualSupplies.length >= 2;
            
            console.log('Verificando datos:', {hasElectricityData, hasGasData, hasDualData});
            
            if (!hasElectricityData && !hasGasData && !hasDualData) {
                return window.showErrorModal("Primero realice una comparaciÃ³n.");
            }
            
            // Validar campos obligatorios
            const commercialCode = document.getElementById('improvement-comercial-code').value.trim();
            const clientName = document.getElementById('improvement-client-name').value.trim();
            const cups = document.getElementById('improvement-client-cups').value.trim();
            const phone = document.getElementById('improvement-client-phone').value.trim();
            const email = document.getElementById('improvement-client-email').value.trim();
            const observations = document.getElementById('improvement-observations').value.trim();
            
            if (!commercialCode) {
                return window.showErrorModal("El CÃ³digo Comercial es obligatorio.");
            }
            
            try {
                let htmlContent = '';
                let desglose = '';
                let tipoSuministro = '';
                
                // DETERMINAR QUÃ‰ TIPO DE CÃLCULO SE HIZO ÃšLTIMO
                // Prioridad: DUAL > ELECTRICIDAD > GAS
                // Esto evita errores cuando hay datos de mÃºltiples tipos
                
                // CASO 1: Datos DUAL (MÃXIMA PRIORIDAD)
                if (hasDualData) {
                    console.log('âœ… Usando datos DUAL');
                    tipoSuministro = 'DUAL (ELECTRICIDAD + GAS)';
                    const dualResults = window.dualGlobalResults;
                    const isDrk = dualResults.comparisonMode !== 'overall_best';
                    const brandColor = isDrk ? '#0ea5e9' : '#84cc16';
                    const brandName = isDrk ? 'DRK' : 'POWER CUP';
                    
                    // Separar suministros de electricidad y gas
                    const electricitySupply = dualSupplies.find(s => s.type === 'electricidad');
                    const gasSupply = dualSupplies.find(s => s.type === 'gas');
                    
                    htmlContent = `
                        <div style="font-family: Arial, sans-serif; max-width: 900px;">
                            <h2 style="color: ${brandColor}; text-align: center;">âš¡ðŸ”¥ RESULTADO COMPARATIVA DUAL</h2>
                            <div style="background: linear-gradient(135deg, ${isDrk ? '#f0f9ff' : '#f7fee7'} 0%, ${isDrk ? '#e0f2fe' : '#ecfccb'} 100%); border: 3px solid ${brandColor}; border-radius: 12px; padding: 24px; margin: 20px 0;">
                                <h3 style="color: ${brandColor}; text-align: center; font-size: 24px;"${tr("LA MEJOR OPCIÃ“N PARA TI ES")}</h3>
                                <h2 style="color: ${isDrk ? '#0c4a6e' : '#365314'}; text-align: center; font-size: 36px; margin: 16px 0;">Tus Tarifas Actuales</h2>
                                <p style="text-align: center; color: ${brandColor}; font-size: 18px;">Es la mejor opciÃ³n detectada</p>
                            </div>
                            
                            <div style="background-color: white; border: 2px solid ${isDrk ? '#bfdbfe' : '#d9f99d'}; border-radius: 12px; padding: 20px; margin: 16px 0;">
                                <h4 style="color: ${brandColor}; text-align: center; font-size: 20px;">Â¡ENHORABUENA!</h4>
                                <p style="text-align: center; color: ${isDrk ? '#0c4a6e' : '#365314'}; font-weight: bold; font-size: 18px;">Actualmente estÃ¡s en buenas tarifas</p>
                                <p style="text-align: center; color: ${brandColor}; margin-top: 8px;">Tanto en ELECTRICIDAD como en GAS tienes tarifas competitivas.</p>
                            </div>
                            
                            <!-- Detalle ELECTRICIDAD -->
                            <div style="background-color: #EFF6FF; border-left: 4px solid #3B82F6; border-radius: 8px; padding: 16px; margin: 16px 0;">
                                <h3 style="color: #1E40AF; margin-bottom: 12px;">âš¡ ELECTRICIDAD</h3>
                                <table style="width: 100%; border-collapse: collapse;">
                                    <tr style="border-bottom: 1px solid #BFDBFE;">
                                        <td style="padding: 8px; font-weight: bold;">Tarifa:</td>
                                        <td style="padding: 8px; text-align: right;">${electricitySupply?.tariff || 'N/A'}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #BFDBFE;">
                                        <td style="padding: 8px; font-weight: bold;"${tr("CUPS:")}</td>
                                        <td style="padding: 8px; text-align: right; font-family: monospace; font-size: 11px;">${electricitySupply?.cups || 'N/A'}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #BFDBFE;">
                                        <td style="padding: 8px; font-weight: bold;">Periodo:</td>
                                        <td style="padding: 8px; text-align: right;">${electricitySupply?.electricityBreakdown?.dias || 'N/A'} dÃ­as</td>
                                    </tr>
                                </table>
                                
                                <!-- Consumos por periodo -->
                                <div style="background-color: #DBEAFE; border-radius: 6px; padding: 12px; margin: 12px 0;">
                                    <p style="font-weight: bold; color: #1E40AF; margin: 0 0 8px 0; font-size: 14px;">ðŸ“Š CONSUMOS:</p>
                                    ${(() => {
                                        const eb = electricitySupply?.electricityBreakdown;
                                        if (!eb?.energyCosts || !Array.isArray(eb.energyCosts)) return '<p style="margin:0;font-size:12px;color:#64748B;">No disponible</p>';
                                        
                                        let html = '<table style="width:100%; font-size:12px;">';
                                        let total = 0;
                                        eb.energyCosts.forEach(item => {
                                            const kwh = item.kwh || 0;
                                            total += kwh;
                                            if (kwh > 0) {
                                                html += `<tr><td style="padding:4px;">P${item.period}:</td><td style="text-align:right; font-weight:bold;">${kwh.toFixed(0)} kWh</td></tr>`;
                                            }
                                        });
                                        html += `<tr style="border-top:2px solid #3B82F6;"><td style="padding:4px; font-weight:bold;">TOTAL:</td><td style="text-align:right; font-weight:bold; color:#1E40AF;">${total.toFixed(0)} kWh</td></tr>`;
                                        html += '</table>';
                                        return html;
                                    })()}
                                </div>
                                
                                <!-- Potencias contratadas -->
                                <div style="background-color: #DBEAFE; border-radius: 6px; padding: 12px; margin: 12px 0;">
                                    <p style="font-weight: bold; color: #1E40AF; margin: 0 0 8px 0; font-size: 14px;">âš¡ POTENCIAS CONTRATADAS:</p>
                                    ${(() => {
                                        const eb = electricitySupply?.electricityBreakdown;
                                        if (!eb?.powerCosts || !Array.isArray(eb.powerCosts)) return '<p style="margin:0;font-size:12px;color:#64748B;">No disponible</p>';
                                        
                                        let html = '<table style="width:100%; font-size:12px;">';
                                        eb.powerCosts.forEach(item => {
                                            const kw = item.kw || 0;
                                            if (kw > 0) {
                                                html += `<tr><td style="padding:4px;">P${item.period}:</td><td style="text-align:right; font-weight:bold;">${kw} kW</td></tr>`;
                                            }
                                        });
                                        html += '</table>';
                                        return html;
                                    })()}
                                </div>
                                
                                <!-- PRECIOS APLICADOS -->
                                <div style="background-color: #DBEAFE; border-radius: 6px; padding: 12px; margin: 12px 0;">
                                    <p style="font-weight: bold; color: #1E40AF; margin: 0 0 8px 0; font-size: 14px;">ðŸ“‹ PRECIOS APLICADOS:</p>
                                    ${(() => {
                                        const eb = electricitySupply?.electricityBreakdown;
                                        let html = '<div style="font-size:12px;">';
                                        
                                        // Precios de POTENCIA
                                        if (eb?.powerCosts && Array.isArray(eb.powerCosts)) {
                                            html += '<p style="margin:0 0 6px 0; font-weight:bold; color:#1E40AF; font-size:11px;">POTENCIA:</p>';
                                            html += '<table style="width:100%; margin-bottom:12px;">';
                                            eb.powerCosts.forEach(item => {
                                                if ((item.kw || 0) > 0 && item.priceDay) {
                                                    html += `<tr><td style="padding:2px;">P${item.period}:</td><td style="text-align:right;">${item.priceDay.toFixed(6)} â‚¬/kW/dÃ­a</td></tr>`;
                                                }
                                            });
                                            html += '</table>';
                                        }
                                        
                                        // Precios de ENERGÃA
                                        if (eb?.energyCosts && Array.isArray(eb.energyCosts)) {
                                            html += '<p style="margin:0 0 6px 0; font-weight:bold; color:#1E40AF; font-size:11px;">ENERGÃA:</p>';
                                            html += '<table style="width:100%;">';
                                            eb.energyCosts.forEach(item => {
                                                if ((item.kwh || 0) > 0 && item.price) {
                                                    html += `<tr><td style="padding:2px;">P${item.period}:</td><td style="text-align:right;">${item.price.toFixed(6)} â‚¬/kWh</td></tr>`;
                                                }
                                            });
                                            html += '</table>';
                                        }
                                        
                                        html += '</div>';
                                        return html;
                                    })()}
                                </div>
                                
                                <!-- Costes del periodo -->
                                <div style="background-color: #DBEAFE; border-radius: 6px; padding: 12px; margin: 12px 0;">
                                    <p style="font-weight: bold; color: #1E40AF; margin: 0 0 8px 0; font-size: 14px;">ðŸ’° COSTES PERIODO:</p>
                                    <table style="width: 100%; font-size: 12px;">
                                        <tr><td style="padding:4px;">Potencia:</td><td style="text-align:right;">${(electricitySupply?.electricityBreakdown?.subPower || 0).toFixed(2)} â‚¬</td></tr>
                                        <tr><td style="padding:4px;">EnergÃ­a:</td><td style="text-align:right;">${(electricitySupply?.electricityBreakdown?.subEnergy || 0).toFixed(2)} â‚¬</td></tr>
                                        <tr><td style="padding:4px;">Imp. elÃ©ctrico:</td><td style="text-align:right;">${(electricitySupply?.electricityBreakdown?.costIE || 0).toFixed(2)} â‚¬</td></tr>
                                        <tr><td style="padding:4px;">IVA (21%):</td><td style="text-align:right;">${(electricitySupply?.electricityBreakdown?.costIVA || 0).toFixed(2)} â‚¬</td></tr>
                                        <tr style="border-top:2px solid #3B82F6; font-weight:bold;">
                                            <td style="padding:8px 4px 4px 4px;">TOTAL:</td>
                                            <td style="text-align:right; padding:8px 4px 4px 4px; color:#1E40AF;">${(electricitySupply?.electricityBreakdown?.totalPeriod || 0).toFixed(2)} â‚¬</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <table style="width: 100%; border-collapse: collapse; margin-top: 12px;">
                                    <tr style="background-color: #DBEAFE;">
                                        <td style="padding: 12px; font-size: 16px; font-weight: bold; color: #1E3A8A;">Coste actual anual:</td>
                                        <td style="padding: 12px; font-size: 18px; text-align: right; color: #1E3A8A; font-weight: bold;">${(electricitySupply?.originalBillAnnual || 0).toFixed(2)} â‚¬</td>
                                    </tr>
                                    <tr style="background-color: #DBEAFE;">
                                        <td style="padding: 12px; font-size: 16px; font-weight: bold; color: #1E3A8A;">Con ${brandName}:</td>
                                        <td style="padding: 12px; font-size: 18px; text-align: right; color: #1E3A8A; font-weight: bold;">${(electricitySupply?.totalAnnual || 0).toFixed(2)} â‚¬</td>
                                    </tr>
                                    <tr style="background-color: ${((electricitySupply?.originalBillAnnual || 0) - (electricitySupply?.totalAnnual || 0)) > 0 ? '#D1FAE5' : '#FEE2E2'};">
                                        <td style="padding: 12px; font-size: 16px; font-weight: bold; color: ${((electricitySupply?.originalBillAnnual || 0) - (electricitySupply?.totalAnnual || 0)) > 0 ? '#065F46' : '#991B1B'};">Ahorro anual:</td>
                                        <td style="padding: 12px; font-size: 18px; text-align: right; color: ${((electricitySupply?.originalBillAnnual || 0) - (electricitySupply?.totalAnnual || 0)) > 0 ? '#065F46' : '#991B1B'}; font-weight: bold;">${((electricitySupply?.originalBillAnnual || 0) - (electricitySupply?.totalAnnual || 0)).toFixed(2)} â‚¬</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <!-- Detalle GAS -->
                            <div style="background-color: #FEE2E2; border-left: 4px solid #DC2626; border-radius: 8px; padding: 16px; margin: 16px 0;">
                                <h3 style="color: #991B1B; margin-bottom: 12px;">ðŸ”¥ GAS</h3>
                                <table style="width: 100%; border-collapse: collapse;">
                                    <tr style="border-bottom: 1px solid #FCA5A5;">
                                        <td style="padding: 8px; font-weight: bold;">Tarifa:</td>
                                        <td style="padding: 8px; text-align: right;">${gasSupply?.tariff || 'N/A'}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #FCA5A5;">
                                        <td style="padding: 8px; font-weight: bold;">Periodo:</td>
                                        <td style="padding: 8px; text-align: right;">${gasSupply?.gasBreakdown?.dias || gasSupply?.data?.dias || 'N/A'} dÃ­as</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #FCA5A5;">
                                        <td style="padding: 8px; font-weight: bold;">Consumo total:</td>
                                        <td style="padding: 8px; text-align: right; font-weight: bold;">${gasSupply?.gasBreakdown?.kwh || gasSupply?.data?.kwh || '0'} kWh</td>
                                    </tr>
                                </table>
                                
                                <!-- Precios aplicados -->
                                <div style="background-color: #FECACA; border-radius: 6px; padding: 12px; margin: 12px 0;">
                                    <p style="font-weight: bold; color: #991B1B; margin: 0 0 8px 0; font-size: 14px;">ðŸ“‹ PRECIOS APLICADOS:</p>
                                    <table style="width: 100%; font-size: 12px;">
                                        <tr>
                                            <td style="padding:4px;">TÃ©rmino fijo:</td>
                                            <td style="text-align:right; font-weight:bold;">${(gasSupply?.gasBreakdown?.termino_fijo_diario || gasSupply?.offer?.p_fijo_diario || 0).toFixed(6)} â‚¬/dÃ­a</td>
                                        </tr>
                                        <tr>
                                            <td style="padding:4px;">Precio energÃ­a:</td>
                                            <td style="text-align:right; font-weight:bold;">${(gasSupply?.offer?.p1_price || 0).toFixed(6)} â‚¬/kWh</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <!-- Costes del periodo -->
                                <div style="background-color: #FECACA; border-radius: 6px; padding: 12px; margin: 12px 0;">
                                    <p style="font-weight: bold; color: #991B1B; margin: 0 0 8px 0; font-size: 14px;">ðŸ’° COSTES PERIODO:</p>
                                    <table style="width: 100%; font-size: 12px;">
                                        <tr><td style="padding:4px;">TÃ©rmino fijo:</td><td style="text-align:right;">${(gasSupply?.gasBreakdown?.termino_fijo || 0).toFixed(2)} â‚¬</td></tr>
                                        <tr><td style="padding:4px;">EnergÃ­a:</td><td style="text-align:right;">${(gasSupply?.gasBreakdown?.energia || 0).toFixed(2)} â‚¬</td></tr>
                                        <tr><td style="padding:4px;">Imp. hidrocarburos:</td><td style="text-align:right;">${(gasSupply?.gasBreakdown?.impuesto_hidrocarburos || 0).toFixed(2)} â‚¬</td></tr>
                                        <tr><td style="padding:4px;">IVA (21%):</td><td style="text-align:right;">${(gasSupply?.gasBreakdown?.iva || 0).toFixed(2)} â‚¬</td></tr>
                                        <tr style="border-top:2px solid #DC2626; font-weight:bold;">
                                            <td style="padding:8px 4px 4px 4px;">TOTAL:</td>
                                            <td style="text-align:right; padding:8px 4px 4px 4px; color:#991B1B;">${(gasSupply?.gasBreakdown?.total || 0).toFixed(2)} â‚¬</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <table style="width: 100%; border-collapse: collapse; margin-top: 12px;">
                                    <tr style="background-color: #FECACA;">
                                        <td style="padding: 12px; font-size: 16px; font-weight: bold; color: #7F1D1D;">Coste actual anual:</td>
                                        <td style="padding: 12px; font-size: 18px; text-align: right; color: #7F1D1D; font-weight: bold;">${(gasSupply?.originalBillAnnual || 0).toFixed(2)} â‚¬</td>
                                    </tr>
                                    <tr style="background-color: #FECACA;">
                                        <td style="padding: 12px; font-size: 16px; font-weight: bold; color: #7F1D1D;">Con ${brandName}:</td>
                                        <td style="padding: 12px; font-size: 18px; text-align: right; color: #7F1D1D; font-weight: bold;">${(gasSupply?.totalAnnual || 0).toFixed(2)} â‚¬</td>
                                    </tr>
                                    <tr style="background-color: ${((gasSupply?.originalBillAnnual || 0) - (gasSupply?.totalAnnual || 0)) > 0 ? '#D1FAE5' : '#FEE2E2'};">
                                        <td style="padding: 12px; font-size: 16px; font-weight: bold; color: ${((gasSupply?.originalBillAnnual || 0) - (gasSupply?.totalAnnual || 0)) > 0 ? '#065F46' : '#991B1B'};">Ahorro anual:</td>
                                        <td style="padding: 12px; font-size: 18px; text-align: right; color: ${((gasSupply?.originalBillAnnual || 0) - (gasSupply?.totalAnnual || 0)) > 0 ? '#065F46' : '#991B1B'}; font-weight: bold;">${((gasSupply?.originalBillAnnual || 0) - (gasSupply?.totalAnnual || 0)).toFixed(2)} â‚¬</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <!-- Total consolidado -->
                            <div style="background: linear-gradient(135deg, ${brandColor} 0%, ${isDrk ? '#0369a1' : '#65a30d'} 100%); border-radius: 12px; padding: 20px; margin-top: 20px;">
                                <h3 style="color: white; text-align: center; margin-bottom: 16px; font-size: 20px;">ðŸ“Š RESUMEN CONSOLIDADO ANUAL</h3>
                                
                                <!-- Factura actual -->
                                <div style="background-color: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 2px solid ${brandColor};">
                                    <p style="color: ${brandColor}; font-weight: bold; margin: 0 0 8px 0; font-size: 14px;">FACTURA ACTUAL TOTAL:</p>
                                    <table style="width: 100%; color: ${isDrk ? '#0c4a6e' : '#365314'};">
                                        <tr>
                                            <td style="padding: 4px; font-size: 28px; font-weight: bold; text-align: center; color: ${brandColor};" colspan="2">${(dualResults.totalOriginalBill || 0).toFixed(2)} â‚¬/aÃ±o</td>
                                        </tr>
                                        <tr style="border-top: 2px solid ${isDrk ? '#bfdbfe' : '#d9f99d'};">
                                            <td style="padding: 8px 4px 4px 4px;">âš¡ Electricidad:</td>
                                            <td style="padding: 8px 4px 4px 4px; text-align: right; font-weight: bold;">${(electricitySupply?.originalBillAnnual || 0).toFixed(2)} â‚¬</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 4px;">ðŸ”¥ Gas:</td>
                                            <td style="padding: 4px; text-align: right; font-weight: bold;">${(gasSupply?.originalBillAnnual || 0).toFixed(2)} â‚¬</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <!-- Con DRK/Power Cup -->
                                <div style="background-color: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 2px solid ${brandColor};">
                                    <p style="color: ${brandColor}; font-weight: bold; margin: 0 0 8px 0; font-size: 14px;">CON ${brandName.toUpperCase()}:</p>
                                    <table style="width: 100%; color: ${isDrk ? '#0c4a6e' : '#365314'};">
                                        <tr>
                                            <td style="padding: 4px; font-size: 28px; font-weight: bold; text-align: center; color: ${brandColor};" colspan="2">${((isDrk ? dualResults.totalDRK : dualResults.totalPowerCup) || 0).toFixed(2)} â‚¬/aÃ±o</td>
                                        </tr>
                                        <tr style="border-top: 2px solid ${isDrk ? '#bfdbfe' : '#d9f99d'};">
                                            <td style="padding: 8px 4px 4px 4px;">âš¡ Electricidad:</td>
                                            <td style="padding: 8px 4px 4px 4px; text-align: right; font-weight: bold;">${(electricitySupply?.totalAnnual || 0).toFixed(2)} â‚¬</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 4px;">ðŸ”¥ Gas:</td>
                                            <td style="padding: 4px; text-align: right; font-weight: bold;">${(gasSupply?.totalAnnual || 0).toFixed(2)} â‚¬</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <!-- Ahorro total -->
                                <div style="background-color: ${(dualResults.totalSavings || 0) > 0 ? '#D1FAE5' : '#FEE2E2'}; border: 3px solid ${(dualResults.totalSavings || 0) > 0 ? '#10B981' : '#EF4444'}; border-radius: 8px; padding: 16px;">
                                    <p style="color: ${(dualResults.totalSavings || 0) > 0 ? '#065F46' : '#991B1B'}; font-weight: bold; margin: 0 0 8px 0; font-size: 14px; text-align: center;">${(dualResults.totalSavings || 0) > 0 ? 'ðŸŽ‰ AHORRO TOTAL ANUAL' : 'âš ï¸ DIFERENCIA ANUAL'}:</p>
                                    <p style="color: ${(dualResults.totalSavings || 0) > 0 ? '#065F46' : '#991B1B'}; font-size: 32px; font-weight: bold; text-align: center; margin: 0;">${(dualResults.totalSavings || 0).toFixed(2)} â‚¬</p>
                                    <p style="color: ${(dualResults.totalSavings || 0) > 0 ? '#065F46' : '#991B1B'}; font-size: 14px; text-align: center; margin: 8px 0 0 0;">(${((dualResults.totalSavings || 0) / 12).toFixed(2)} â‚¬/mes)</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Generar desglose COMPLETO de DUAL
                    let desgloseElectricidad = '';
                    if (electricitySupply) {
                        const eb = electricitySupply.electricityBreakdown;
                        const data = electricitySupply.data;
                        
                        // Extraer consumos de energyCosts array
                        let consumoP1 = 0, consumoP2 = 0, consumoP3 = 0;
                        let consumoTotal = 0;
                        
                        if (eb?.energyCosts && Array.isArray(eb.energyCosts)) {
                            eb.energyCosts.forEach(item => {
                                if (item.period === 1) consumoP1 = item.kwh || 0;
                                else if (item.period === 2) consumoP2 = item.kwh || 0;
                                else if (item.period === 3) consumoP3 = item.kwh || 0;
                                consumoTotal += item.kwh || 0;
                            });
                        }
                        
                        // Extraer potencias de powerCosts array
                        let potenciaP1 = 0, potenciaP2 = 0, potenciaP3 = 0;
                        let preciosPotencia = '';
                        
                        if (eb?.powerCosts && Array.isArray(eb.powerCosts)) {
                            eb.powerCosts.forEach(item => {
                                if (item.period === 1) potenciaP1 = item.kw || 0;
                                else if (item.period === 2) potenciaP2 = item.kw || 0;
                                else if (item.period === 3) potenciaP3 = item.kw || 0;
                            });
                            
                            // Extraer precios de potencia
                            preciosPotencia = 'PRECIOS POTENCIA:\n';
                            eb.powerCosts.forEach(item => {
                                if ((item.kw || 0) > 0 && item.priceDay) {
                                    preciosPotencia += `  P${item.period}: ${item.priceDay.toFixed(6)} â‚¬/kW/dÃ­a\n`;
                                }
                            });
                        }
                        
                        // Extraer precios de energÃ­a
                        let preciosEnergia = '';
                        if (eb?.energyCosts && Array.isArray(eb.energyCosts)) {
                            preciosEnergia = 'PRECIOS ENERGÃA:\n';
                            eb.energyCosts.forEach(item => {
                                if ((item.kwh || 0) > 0 && item.price) {
                                    preciosEnergia += `  P${item.period}: ${item.price.toFixed(6)} â‚¬/kWh\n`;
                                }
                            });
                        }
                        
                        desgloseElectricidad = `=== ELECTRICIDAD ===
Tarifa: ${electricitySupply.tariff || 'N/A'}
CUPS: ${electricitySupply.cups || data?.cups || 'N/A'}
Periodo: ${eb?.dias || data?.dias_facturados || 'N/A'} dÃ­as

CONSUMOS:
${consumoP1 > 0 ? `  P1: ${consumoP1.toFixed(0)} kWh` : ''}
${consumoP2 > 0 ? `  P2: ${consumoP2.toFixed(0)} kWh` : ''}
${consumoP3 > 0 ? `  P3: ${consumoP3.toFixed(0)} kWh` : ''}
  TOTAL ENERGÃA: ${consumoTotal.toFixed(0)} kWh

POTENCIAS CONTRATADAS:
${potenciaP1 > 0 ? `  P1: ${potenciaP1} kW` : ''}
${potenciaP2 > 0 ? `  P2: ${potenciaP2} kW` : ''}
${potenciaP3 > 0 ? `  P3: ${potenciaP3} kW` : ''}

${preciosPotencia}
${preciosEnergia}
COSTES PERIODO:
  Potencia: ${eb?.subPower?.toFixed(2) || '0.00'} â‚¬
  EnergÃ­a: ${eb?.subEnergy?.toFixed(2) || '0.00'} â‚¬
  Impuesto elÃ©ctrico (5.113%): ${eb?.costIE?.toFixed(2) || '0.00'} â‚¬
  IVA (21%): ${eb?.costIVA?.toFixed(2) || '0.00'} â‚¬
  TOTAL PERIODO: ${eb?.totalPeriod?.toFixed(2) || '0.00'} â‚¬

COSTES ANUALES:
  Factura actual anual: ${(electricitySupply.originalBillAnnual || 0).toFixed(2)} â‚¬
  Con ${brandName} pagarÃ­as: ${(electricitySupply.totalAnnual || 0).toFixed(2)} â‚¬
  Ahorro anual: ${((electricitySupply.originalBillAnnual || 0) - (electricitySupply.totalAnnual || 0)).toFixed(2)} â‚¬`;
                    }
                    
                    let desgloseGas = '';
                    if (gasSupply) {
                        const gData = gasSupply.data;
                        const gBreakdown = gasSupply.gasBreakdown; // Usar gasBreakdown en lugar de results
                        
                        desgloseGas = `
=== GAS ===
Tarifa: ${gasSupply.tariff || 'N/A'}
Periodo: ${gData?.dias || gBreakdown?.dias || 'N/A'} dÃ­as
Consumo: ${gData?.kwh || gBreakdown?.kwh || 0} kWh

PRECIOS APLICADOS:
  TÃ©rmino fijo: ${(gBreakdown?.termino_fijo_diario || gasSupply?.offer?.p_fijo_diario || 0).toFixed(6)} â‚¬/dÃ­a
  Precio energÃ­a: ${(gasSupply?.offer?.p1_price || 0).toFixed(6)} â‚¬/kWh

COSTES PERIODO:
  TÃ©rmino fijo: ${gBreakdown?.termino_fijo?.toFixed(2) || 'N/A'} â‚¬
  EnergÃ­a: ${gBreakdown?.energia?.toFixed(2) || 'N/A'} â‚¬
  Impuesto hidrocarburos: ${gBreakdown?.impuesto_hidrocarburos?.toFixed(2) || 'N/A'} â‚¬
  IVA (21%): ${gBreakdown?.iva?.toFixed(2) || 'N/A'} â‚¬
  TOTAL PERIODO: ${gBreakdown?.total?.toFixed(2) || 'N/A'} â‚¬

COSTES ANUALES:
  Factura actual anual: ${(gasSupply.originalBillAnnual || 0).toFixed(2)} â‚¬
  Con ${brandName} pagarÃ­as: ${(gasSupply.totalAnnual || 0).toFixed(2)} â‚¬
  Ahorro anual: ${((gasSupply.originalBillAnnual || 0) - (gasSupply.totalAnnual || 0)).toFixed(2)} â‚¬`;
                    }
                    
                    desglose = `TIPO DE SUMINISTRO: DUAL (ELECTRICIDAD + GAS)
MODO: ${brandName}

${desgloseElectricidad}
${desgloseGas}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
=== RESUMEN CONSOLIDADO ===
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Factura actual total anual: ${(dualResults.totalOriginalBill || 0).toFixed(2)} â‚¬
Con ${brandName} pagarÃ­as: ${(isDrk ? dualResults.totalDRK : dualResults.totalPowerCup).toFixed(2)} â‚¬
Ahorro total anual: ${(dualResults.totalSavings || 0).toFixed(2)} â‚¬

${(dualResults.totalSavings || 0) <= 0 ? 'IMPORTANTE: El cliente ya estÃ¡ en buenas tarifas tanto en electricidad como en gas.' : ''}

Desglose mensual estimado:
  Factura actual: ${(dualResults.totalOriginalBill / 12).toFixed(2)} â‚¬/mes
  Con ${brandName}: ${((isDrk ? dualResults.totalDRK : dualResults.totalPowerCup) / 12).toFixed(2)} â‚¬/mes
  Ahorro mensual: ${(dualResults.totalSavings / 12).toFixed(2)} â‚¬/mes
`;
                
                // CASO 2: Datos de ELECTRICIDAD (prioridad sobre GAS - mÃ¡s comÃºn)
                } else if (hasElectricityData && !hasDualData) {
                    console.log('âœ… Usando datos ELECTRICIDAD individual');
                    tipoSuministro = 'ELECTRICIDAD';
                    
                    // VALIDACIÃ“N: Verificar que lastComparisonResult existe y tiene las propiedades necesarias
                    if (!lastComparisonResult || !lastComparisonResult.dias_facturados || !lastComparisonResult.energyCosts) {
                        console.error('âŒ ERROR: lastComparisonResult incompleto', lastComparisonResult);
                        return window.showErrorModal(tr("Error: Los datos de ELECTRICIDAD no estÃ¡n completos. Por favor, realice el cÃ¡lculo de nuevo."));
                    }
                    
                    // Verificar si hay ahorro o no
                    const hasPositiveSavings = lastComparisonResult && lastComparisonResult.savings > 0;
                    
                    if (!hasPositiveSavings || lastComparisonResult.isNegativeSavings) {
                        // NO HAY AHORRO: Generar HTML especial
                        const brand = activeBrand;
                        const isDrk = brand.NAME.includes('DRK');
                        const brandColor = isDrk ? '#0ea5e9' : '#84cc16';
                        const brandName = isDrk ? 'DRK' : 'POWER CUP';
                        
                        htmlContent = `
                            <div style="font-family: Arial, sans-serif; max-width: 800px;">
                                <h2 style="color: ${brandColor}; text-align: center;">âš¡ RESULTADO COMPARATIVA ELECTRICIDAD</h2>
                                <div style="background-color: ${isDrk ? '#f0f9ff' : '#f7fee7'}; border: 3px solid ${brandColor}; border-radius: 12px; padding: 24px; margin: 20px 0;">
                                    <h3 style="color: ${brandColor}; text-align: center; font-size: 24px;"${tr("LA MEJOR OPCIÃ“N PARA TI ES")}</h3>
                                    <h2 style="color: ${isDrk ? '#0c4a6e' : '#365314'}; text-align: center; font-size: 36px; margin: 16px 0;">Tu Tarifa Actual</h2>
                                    <p style="text-align: center; color: ${brandColor}; font-size: 18px;">Es la mejor opciÃ³n detectada</p>
                                </div>
                                
                                <div style="background-color: white; border: 2px solid ${isDrk ? '#bfdbfe' : '#d9f99d'}; border-radius: 12px; padding: 20px; margin: 16px 0;">
                                    <h4 style="color: ${brandColor}; text-align: center; font-size: 20px;">Â¡ENHORABUENA!</h4>
                                    <p style="text-align: center; color: ${isDrk ? '#0c4a6e' : '#365314'}; font-weight: bold;">Actualmente estÃ¡s en una buena tarifa.</p>
                                    <p style="text-align: center; color: ${brandColor};">Seguiremos estudiando el mercado y te avisaremos cuando encontremos alguna tarifa que se adapte a tu perfil de consumo.</p>
                                </div>
                                
                                <div style="background-color: ${isDrk ? '#f0f9ff' : '#f7fee7'}; border-radius: 12px; padding: 16px; margin-top: 16px;">
                                    <h3 style="color: ${brandColor}; margin-bottom: 12px;">ðŸ“Š TU COSTE ACTUAL CONSOLIDADO</h3>
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tr style="border-bottom: 1px solid ${isDrk ? '#bfdbfe' : '#d9f99d'};">
                                            <td style="padding: 8px; font-weight: bold;">Periodo analizado:</td>
                                            <td style="padding: 8px; text-align: right;">${lastComparisonResult.dias_facturados || 0} dÃ­as</td>
                                        </tr>
                                        <tr style="border-bottom: 1px solid ${isDrk ? '#bfdbfe' : '#d9f99d'};">
                                            <td style="padding: 8px; font-weight: bold;"${tr("CUPS:")}</td>
                                            <td style="padding: 8px; text-align: right; font-family: monospace; font-size: 11px;">${lastComparisonResult.cups || 'N/A'}</td>
                                        </tr>
                                        <tr style="border-bottom: 1px solid ${isDrk ? '#bfdbfe' : '#d9f99d'};">
                                            <td style="padding: 8px; font-weight: bold;">Tipo de tarifa:</td>
                                            <td style="padding: 8px; text-align: right;">${lastComparisonResult.tariffType || 'N/A'}</td>
                                        </tr>
                                        <tr style="border-bottom: 2px solid ${brandColor};">
                                            <td style="padding: 8px; font-weight: bold;">Consumo total energÃ­a:</td>
                                            <td style="padding: 8px; text-align: right; font-weight: bold;">${lastComparisonResult.energyCosts ? lastComparisonResult.energyCosts.reduce((sum, e) => sum + e.kwh, 0).toFixed(0) : 0} kWh</td>
                                        </tr>
                                        <tr style="background-color: ${isDrk ? '#dbeafe' : '#ecfccb'};">
                                            <td style="padding: 12px; font-size: 18px; font-weight: bold; color: ${isDrk ? '#0c4a6e' : '#365314'};">Total periodo:</td>
                                            <td style="padding: 12px; font-size: 24px; text-align: right; color: ${isDrk ? '#0c4a6e' : '#365314'}; font-weight: bold;">${(lastComparisonResult.importe_total || 0).toFixed(2)} â‚¬</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 12px; font-size: 16px; font-weight: bold; color: ${isDrk ? '#0c4a6e' : '#365314'};">EstimaciÃ³n anual:</td>
                                            <td style="padding: 12px; font-size: 20px; text-align: right; color: ${isDrk ? '#0c4a6e' : '#365314'}; font-weight: bold;">${(lastComparisonResult.originalBillAnnual || 0).toFixed(2)} â‚¬/aÃ±o</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        `;
                    } else {
                        // SÃ HAY AHORRO: Usar funciones existentes
                        if (lastIndexedResult && compareWithIndexed) {
                            if (lastComparisonResult.isMultiCups) {
                                htmlContent = generateMultiDualStyledHtmlOffer(commercialCode);
                            } else {
                                htmlContent = generateDualStyledHtmlOffer(commercialCode, lastComparisonResult, lastIndexedResult);
                            }
                        } else {
                            if (lastComparisonResult.isMulti) {
                                htmlContent = generateMultiStyledHtmlOffer(commercialCode);
                            } else {
                                htmlContent = generateStyledHtmlOffer(commercialCode);
                            }
                        }
                    }
                    
                    // 2. Generar desglose detallado de cÃ¡lculos
                    desglose = generateCalculationBreakdown(lastComparisonResult);
                }
                
                // 3. Preparar el contenido del email (MUY CORTO para evitar lÃ­mites de mailto)
                const emailSubject = `Solicitud Mejora ${tipoSuministro} - ${clientName || 'Cliente'} - ${cups || 'Sin CUPS'}`;
                
                const emailBody = `SOLICITUD DE MEJORA - ${tipoSuministro}

Comercial: ${commercialCode}
Cliente: ${clientName || 'No proporcionado'}
CUPS: ${cups || 'No proporcionado'}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš ï¸ INSTRUCCIONES IMPORTANTES:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. PEGAR contenido completo (Ctrl+V) debajo de este texto
   â†’ El contenido estÃ¡ copiado en el portapapeles

2. ADJUNTAR facturas OBLIGATORIAS:
   ðŸ“„ Factura usada para el estudio
   ðŸ“„ Factura mÃ¡s actualizada del cliente

3. ENVIAR email

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[PEGAR AQUÃ EL CONTENIDO COMPLETO CON CTRL+V]

`;

                // 4. Crear mailto con mÃºltiples destinatarios (LIMITADO para evitar cortes)
                const recipients = 'F.araujo@drk.es,rguerra@drk.es,l.grande@drk.es';
                const mailtoLink = `mailto:${recipients}?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody.substring(0, 900))}`;
                
                // 5. Copiar HTML completo al portapapeles para pegar en el email
                const tempElement = document.createElement('div');
                tempElement.contentEditable = true;
                tempElement.innerHTML = `
                    <div style="font-family: Arial, sans-serif;">
                        <h2 style="color: #E50000;">SOLICITUD DE MEJORA DE COMPARATIVO - ${tipoSuministro}</h2>
                        <p><strong>El comercial ${commercialCode} solicita una mejora de este comparativo.</strong></p>
                        
                        <div style="background-color: #E0F2FE; border-left: 4px solid #0EA5E9; padding: 12px; margin: 16px 0;">
                            <p style="margin: 0; font-weight: bold;">ðŸ“‹ TIPO DE SUMINISTRO: ${tipoSuministro}</p>
                        </div>
                        
                        <h3>DATOS DEL CLIENTE:</h3>
                        <ul>
                            <li><strong>Nombre:</strong> ${clientName || 'No proporcionado'}</li>
                            <li><strong${tr("CUPS:")}</strong> ${cups || 'No proporcionado'}</li>
                            <li><strong>TelÃ©fono:</strong> ${phone || 'No proporcionado'}</li>
                            <li><strong>Email:</strong> ${email || 'No proporcionado'}</li>
                            ${observations ? `<li><strong>Observaciones:</strong> ${observations}</li>` : ''}
                        </ul>
                        
                        <div style="background-color: #FEF3C7; border: 2px solid #F59E0B; border-radius: 8px; padding: 16px; margin: 20px 0;">
                            <h3 style="margin: 0 0 12px 0; color: #92400E; font-size: 18px;">âš ï¸ IMPORTANTE - FACTURAS A ADJUNTAR:</h3>
                            <div style="background-color: white; padding: 12px; border-radius: 6px; margin-bottom: 8px;">
                                <p style="margin: 0; font-weight: bold; color: #92400E;">ðŸ“„ 1. La factura UTILIZADA para realizar este estudio</p>
                                <p style="margin: 4px 0 0 0; font-size: 13px; color: #78350F;">Esta es la factura que el comercial ha analizado para hacer la comparativa</p>
                            </div>
                            <div style="background-color: white; padding: 12px; border-radius: 6px;">
                                <p style="margin: 0; font-weight: bold; color: #92400E;">ðŸ“„ 2. La factura MÃS ACTUALIZADA del cliente</p>
                                <p style="margin: 4px 0 0 0; font-size: 13px; color: #78350F;">Si es la misma factura que la del estudio, adjuntar solo una vez</p>
                            </div>
                            <p style="margin: 12px 0 0 0; font-size: 12px; color: #92400E; font-style: italic;">
                                â„¹ï¸ Estas facturas son necesarias para que Back Office pueda verificar los datos y mejorar el comparativo
                            </p>
                        </div>
                        
                        <hr style="margin: 24px 0;">
                        
                        <h3>COMPARATIVO:</h3>
                        ${htmlContent}
                        
                        <hr style="margin: 24px 0;">
                        
                        <h3>DESGLOSE DETALLADO DE CÃLCULOS:</h3>
                        <pre style="background-color: #f5f5f5; padding: 16px; border-radius: 8px; overflow-x: auto; font-size: 12px;">${desglose}</pre>
                    </div>
                `;
                tempElement.style.position = 'fixed';
                tempElement.style.left = '-9999px';
                document.body.appendChild(tempElement);
                
                const range = document.createRange();
                range.selectNodeContents(tempElement);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                
                const success = document.execCommand('copy');
                document.body.removeChild(tempElement);
                
                // 6. Abrir cliente de correo
                window.location.href = mailtoLink;
                
                // 7. Mostrar mensaje de Ã©xito
                if (success) {
                    window.showMessageModal(`âœ… Â¡LISTO! Email abierto y contenido copiado.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸ“‹ PASOS PARA ENVIAR LA SOLICITUD:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1ï¸âƒ£ En el email que se acaba de abrir:
   â†’ Coloque el cursor debajo de "[PEGAR AQUÃ...]"
   â†’ Presione Ctrl+V (o Cmd+V en Mac)
   â†’ Se pegarÃ¡ TODO el comparativo completo

2ï¸âƒ£ ADJUNTE LAS FACTURAS (OBLIGATORIO):
   ðŸ“„ Factura usada para hacer el estudio
   ðŸ“„ Factura mÃ¡s actualizada del cliente
   (Si son la misma, adjuntar solo una vez)

3ï¸âƒ£ Revise que todo estÃ© correcto y ENVÃE

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Destinatarios: F.araujo@drk.es, rguerra@drk.es, l.grande@drk.es

âš ï¸ IMPORTANTE: Sin las facturas adjuntas, Back Office NO podrÃ¡ procesar la solicitud.`);
                    
                    // Cerrar modal
                    document.getElementById('request-improvement-modal').classList.add('hidden');
                    document.getElementById('request-improvement-modal').classList.remove('flex');
                    
                    // Limpiar campos
                    document.getElementById('improvement-comercial-code').value = '';
                    document.getElementById('improvement-client-name').value = '';
                    document.getElementById('improvement-client-cups').value = '';
                    document.getElementById('improvement-client-phone').value = '';
                    document.getElementById('improvement-client-email').value = '';
                    document.getElementById('improvement-observations').value = '';
                } else {
                    window.showErrorModal("No se pudo copiar el contenido. Por favor, contacte a soporte.");
                }
                
            } catch (error) {
                console.error('Error en handleRequestImprovement:', error);
                window.showErrorModal(`Error al preparar la solicitud: ${error.message}`);
            }
        }
        
        // FunciÃ³n auxiliar para generar desglose de cÃ¡lculos
        function generateCalculationBreakdown(result) {
            let breakdown = '';
            
            breakdown += `TIPO: ${result.tariffType || 'N/A'}\n`;
            breakdown += `CUPS: ${result.cups || 'N/A'}\n`;
            breakdown += `DÃAS: ${result.dias_facturados || result.days || 'N/A'}\n\n`;
            
            breakdown += `COSTES DE POTENCIA:\n`;
            if (result.powerCosts && Array.isArray(result.powerCosts)) {
                result.powerCosts.forEach(item => {
                    if (item.kw > 0) {
                        breakdown += `  P${item.period}: ${(item.cost || 0).toFixed(2)} â‚¬ (${item.kw} kW x ${(item.priceDay || 0).toFixed(6)} â‚¬/dÃ­a)\n`;
                    }
                });
                breakdown += `  TOTAL POTENCIA: ${(result.subPower || 0).toFixed(2)} â‚¬\n\n`;
            }
            
            breakdown += `COSTES DE ENERGÃA:\n`;
            if (result.energyCosts && Array.isArray(result.energyCosts)) {
                result.energyCosts.forEach(item => {
                    if (item.kwh > 0) {
                        breakdown += `  E${item.period}: ${(item.cost || 0).toFixed(2)} â‚¬ (${item.kwh} kWh x ${(item.price || 0).toFixed(6)} â‚¬/kWh)\n`;
                    }
                });
                breakdown += `  TOTAL ENERGÃA: ${(result.subEnergyNet || 0).toFixed(2)} â‚¬\n\n`;
            }
            
            breakdown += `IMPUESTOS Y OTROS:\n`;
            breakdown += `  Impuesto ElÃ©ctrico: ${(result.elec_tax || 0).toFixed(2)} â‚¬\n`;
            breakdown += `  IVA: ${(result.vat || 0).toFixed(2)} â‚¬\n`;
            breakdown += `  Alquiler Contador: ${(result.rental || 0).toFixed(2)} â‚¬\n\n`;
            
            breakdown += `TOTALES:\n`;
            breakdown += `  Subtotal: ${(result.subtotal || 0).toFixed(2)} â‚¬\n`;
            breakdown += `  TOTAL PERIODO: ${(result.importe_total || 0).toFixed(2)} â‚¬\n`;
            breakdown += `  TOTAL ANUAL: ${(result.totalAnnual || result.originalBillAnnual || 0).toFixed(2)} â‚¬\n`;
            breakdown += `  AHORRO: ${(result.savings || 0).toFixed(2)} â‚¬\n`;
            
            return breakdown;
        }

        
        // --- GENERACIÃ“N DE PDF PROFESIONAL COMPLETO ---
        
        // NUEVA FUNCIÃ“N: Generar PDF con comparativo dual de potencias
        async function handleGeneratePDF_DualPower(mode = 'two-columns') {
            console.log('ðŸ”¥ handleGeneratePDF_DualPower - Generando PDF comparativo dual');
            console.log('ðŸ“Š Modo seleccionado:', mode);
            
            const dualComparison = window.lastDualPowerComparison;
            const resActual = dualComparison.actual;
            const resOptimized = dualComparison.optimized;
            const brand = dualComparison.brand;
            const presentationMode = mode; // Usar el modo pasado como parÃ¡metro
            
            const commercialCode = document.getElementById('comercial-code-input').value.trim();
            const clientName = document.getElementById('client-name-input').value.trim() || '[NOMBRE COMPLETO CLIENTE]';
            const clientPhone = document.getElementById('client-phone-input').value.trim();
            const clientAddress = document.getElementById('client-address-input').value.trim();
            const clientEmail = document.getElementById('client-email-input').value.trim();
            
            if (!commercialCode) return window.showErrorModal("Indique el CÃ³digo Comercial.");
            
            try {
                // Mostrar mensaje de carga
                window.showMessageModal("â³ Generando PDF comparativo de potencias... Por favor espere.");
                
                // Importar jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                const isDrk = brand.NAME.includes('DRK');
                
                // Colores corporativos
                const primaryColor = isDrk ? [46, 82, 102] : [63, 98, 18]; // DRK azul / POWER CUP verde
                const lightBg = isDrk ? [240, 245, 250] : [245, 248, 240];
                const greenColor = [22, 163, 74];
                const orangeColor = [245, 158, 11];
                const redColor = [220, 38, 38];
                
                const pageWidth = 210;
                const margin = 15;
                const contentWidth = pageWidth - (2 * margin);
                
                const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
                const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
                
                // ===============================================
                // PÃGINA 1: HEADER Y DATOS GENERALES
                // ===============================================
                let yPos = 0;
                
                // Header con gradiente
                const headerHeight = 40;
                for (let i = 0; i < pageWidth; i++) {
                    const ratio = i / pageWidth;
                    const r = Math.round(primaryColor[0] + (lightBg[0] - primaryColor[0]) * ratio);
                    const g = Math.round(primaryColor[1] + (lightBg[1] - primaryColor[1]) * ratio);
                    const b = Math.round(primaryColor[2] + (lightBg[2] - primaryColor[2]) * ratio);
                    doc.setFillColor(r, g, b);
                    doc.rect(i, 0, 1, headerHeight, 'F');
                }
                
                // TÃ­tulo
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(22);
                doc.setFont('helvetica', 'bold');
                doc.text(brand.FULL_NAME, margin, 15);
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(tr('Comparativa: Potencias Actuales vs Optimizadas'), margin, 23);
                
                yPos = headerHeight + 5;
                
                // Badge de optimizaciÃ³n
                doc.setFillColor(orangeColor[0], orangeColor[1], orangeColor[2]);
                doc.roundedRect(margin, yPos, contentWidth, 10, 2, 2, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('COMPARATIVO 3.0TD CON OPTIMIZACION DE POTENCIAS'), pageWidth / 2, yPos + 6.5, { align: 'center' });
                
                yPos += 15;
                
                // Datos del cliente
                doc.setFillColor(lightBg[0], lightBg[1], lightBg[2]);
                doc.roundedRect(margin, yPos, contentWidth, 25, 2, 2, 'F');
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('DATOS DEL CLIENTE'), margin + 5, yPos + 6);
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.text(`${tr('Cliente')}: ${clientName}`, margin + 5, yPos + 12);
                doc.text(`CUPS: ${resActual.cups}`, margin + 5, yPos + 17);
                if (clientPhone) doc.text(`Tel: ${clientPhone}`, margin + 5, yPos + 22);
                
                doc.setFont('helvetica', 'bold');
                doc.text(`${tr('CÃ³digo Comercial')}: ${commercialCode}`, pageWidth - margin - 5, yPos + 12, { align: 'right' });
                doc.setFont('helvetica', 'normal');
                if (clientAddress) {
                    doc.text(`${tr('DirecciÃ³n')}: ${clientAddress}`, pageWidth - margin - 5, yPos + 17, { align: 'right' });
                }
                if (clientEmail) {
                    const emailY = clientAddress ? yPos + 22 : yPos + 17;
                    doc.text(`Email: ${clientEmail}`, pageWidth - margin - 5, emailY, { align: 'right' });
                }
                
                yPos += 30;
                
                // ===============================================
                // SECCIÃ“N: TU FACTURA ACTUAL
                // ===============================================
                doc.setFillColor(200, 200, 200);
                doc.roundedRect(margin, yPos, contentWidth, 20, 2, 2, 'F');
                
                doc.setTextColor(80, 80, 80);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('TU FACTURA ACTUAL'), pageWidth / 2, yPos + 6, { align: 'center' });
                
                doc.setTextColor(redColor[0], redColor[1], redColor[2]);
                doc.setFontSize(18);
                doc.text(eur(resActual.originalBillAnnual) + '/aÃ±o', pageWidth / 2, yPos + 15, { align: 'center' });
                
                // LÃ­nea tachada
                const textWidth = doc.getTextWidth(eur(resActual.originalBillAnnual) + '/aÃ±o');
                doc.setDrawColor(redColor[0], redColor[1], redColor[2]);
                doc.setLineWidth(0.5);
                doc.line(pageWidth / 2 - textWidth / 2, yPos + 13, pageWidth / 2 + textWidth / 2, yPos + 13);
                
                yPos += 25;
                
                // ===============================================
                // COLUMNAS COMPARATIVAS
                // ===============================================
                // Ajustar ancho segÃºn el modo
                const colWidth = presentationMode === 'two-columns' ? (contentWidth - 5) / 2 : contentWidth;
                
                // COLUMNA IZQUIERDA (o ÃšNICA): POTENCIAS ACTUALES
                let leftX = margin;
                let leftY = yPos;
                
                doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.roundedRect(leftX, leftY, colWidth, 12, 2, 2, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                const headerText = presentationMode === 'two-columns' ? tr('CON POTENCIAS ACTUALES') : tr('TU NUEVA TARIFA');
                doc.text(headerText, leftX + colWidth / 2, leftY + 8, { align: 'center' });
                
                leftY += 15;
                
                // Ahorro actual
                doc.setFillColor(lightBg[0], lightBg[1], lightBg[2]);
                doc.roundedRect(leftX, leftY, colWidth, 20, 2, 2, 'F');
                doc.setTextColor(100, 100, 100);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('TU AHORRO ANUAL'), leftX + colWidth / 2, leftY + 5, { align: 'center' });
                doc.setTextColor(greenColor[0], greenColor[1], greenColor[2]);
                doc.setFontSize(16);
                doc.text(eur(resActual.savings), leftX + colWidth / 2, leftY + 14, { align: 'center' });
                
                leftY += 25;
                
                // Nuevo coste actual
                doc.setDrawColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.setLineWidth(0.5);
                doc.roundedRect(leftX, leftY, colWidth, 20, 2, 2, 'S');
                doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('TU NUEVO COSTE'), leftX + colWidth / 2, leftY + 5, { align: 'center' });
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                doc.text(eur(resActual.totalAnnual / 12) + '/mes', leftX + colWidth / 2, leftY + 11, { align: 'center' });
                doc.setFontSize(9);
                doc.text(eur(resActual.totalAnnual) + '/aÃ±o', leftX + colWidth / 2, leftY + 16, { align: 'center' });
                
                leftY += 25;
                
                // Potencias actuales
                doc.setFillColor(lightBg[0], lightBg[1], lightBg[2]);
                doc.roundedRect(leftX, leftY, colWidth, 35, 2, 2, 'F');
                doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('POTENCIAS CONTRATADAS (kW)'), leftX + colWidth / 2, leftY + 5, { align: 'center' });
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                let powerY = leftY + 10;
                resActual.powerCosts.forEach((p, idx) => {
                    if (p.kw > 0 || idx < 6) {
                        doc.text(`P${p.period}: ${num(p.kw, 2)} kW`, leftX + 5, powerY);
                        powerY += 4;
                    }
                });
                
                // ===============================================
                // COLUMNA DERECHA (SOLO EN MODO DOS COLUMNAS)
                // ===============================================
                if (presentationMode === 'two-columns') {
                    // COLUMNA DERECHA: POTENCIAS OPTIMIZADAS
                    let rightX = margin + colWidth + 5;
                    let rightY = yPos;
                    
                    doc.setFillColor(greenColor[0], greenColor[1], greenColor[2]);
                    doc.roundedRect(rightX, rightY, colWidth, 12, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('CON POTENCIAS OPTIMIZADAS'), rightX + colWidth / 2, rightY + 8, { align: 'center' });
                    
                    rightY += 15;
                    
                    // Ahorro optimizado
                    doc.setFillColor(220, 252, 231);
                    doc.setDrawColor(greenColor[0], greenColor[1], greenColor[2]);
                    doc.setLineWidth(0.5);
                    doc.roundedRect(rightX, rightY, colWidth, 20, 2, 2, 'FD');
                    doc.setTextColor(greenColor[0], greenColor[1], greenColor[2]);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('TU AHORRO CON OPTIMIZACIÃ“N'), rightX + colWidth / 2, rightY + 5, { align: 'center' });
                    doc.setFontSize(16);
                    doc.text(eur(resOptimized.savings), rightX + colWidth / 2, rightY + 14, { align: 'center' });
                    
                    rightY += 25;
                    
                    // Nuevo coste optimizado
                    doc.setDrawColor(greenColor[0], greenColor[1], greenColor[2]);
                    doc.setLineWidth(0.8);
                    doc.roundedRect(rightX, rightY, colWidth, 20, 2, 2, 'S');
                    doc.setTextColor(greenColor[0], greenColor[1], greenColor[2]);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('TU NUEVO COSTE'), rightX + colWidth / 2, rightY + 5, { align: 'center' });
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(11);
                    doc.text(eur(resOptimized.totalAnnual / 12) + '/mes', rightX + colWidth / 2, rightY + 11, { align: 'center' });
                    doc.setFontSize(9);
                    doc.text(eur(resOptimized.totalAnnual) + '/aÃ±o', rightX + colWidth / 2, rightY + 16, { align: 'center' });
                    
                    rightY += 25;
                    
                    // Potencias optimizadas
                    doc.setFillColor(220, 252, 231);
                    doc.setDrawColor(greenColor[0], greenColor[1], greenColor[2]);
                    doc.setLineWidth(0.5);
                    doc.roundedRect(rightX, rightY, colWidth, 35, 2, 2, 'FD');
                    doc.setTextColor(greenColor[0], greenColor[1], greenColor[2]);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('POTENCIAS OPTIMIZADAS (kW)'), rightX + colWidth / 2, rightY + 5, { align: 'center' });
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'normal');
                    powerY = rightY + 10;
                    resOptimized.powerCosts.forEach((p, idx) => {
                        if (p.kw > 0 || idx < 6) {
                            doc.text(`P${p.period}: ${num(p.kw, 2)} kW`, rightX + 5, powerY);
                            powerY += 4;
                        }
                    });
                    
                    yPos = Math.max(leftY, rightY) + 40;
                } else {
                    // MODO UNA COLUMNA: Extender la columna izquierda a ancho completo
                    yPos = leftY;
                }
                
                // ===============================================
                // AHORRO ADICIONAL (SOLO EN MODO DOS COLUMNAS)
                // ===============================================
                if (presentationMode === 'two-columns') {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    const ahorroAdicional = resActual.totalAnnual - resOptimized.totalAnnual;
                    
                    doc.setFillColor(254, 243, 199);
                    doc.setDrawColor(orangeColor[0], orangeColor[1], orangeColor[2]);
                    doc.setLineWidth(1);
                    doc.roundedRect(margin, yPos, contentWidth, 25, 3, 3, 'FD');
                    
                    doc.setTextColor(orangeColor[0], orangeColor[1], orangeColor[2]);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('AHORRO ADICIONAL POR OPTIMIZACION DE POTENCIAS'), pageWidth / 2, yPos + 7, { align: 'center' });
                    
                    doc.setFontSize(18);
                    doc.text(eur(ahorroAdicional) + '/aÃ±o', pageWidth / 2, yPos + 18, { align: 'center' });
                    
                    yPos += 30;
                } else {
                    // MODO UNA COLUMNA: Mostrar resumen de optimizaciÃ³n sin revelar potencias
                    if (yPos > 235) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    yPos += 5;
                    
                    const ahorroAdicional = resActual.totalAnnual - resOptimized.totalAnnual;
                    
                    // TÃ­tulo
                    doc.setFillColor(lightBg[0], lightBg[1], lightBg[2]);
                    doc.roundedRect(margin, yPos, contentWidth, 10, 2, 2, 'F');
                    doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('POTENCIAL DE OPTIMIZACION'), pageWidth / 2, yPos + 6.5, { align: 'center' });
                    
                    yPos += 15;
                    
                    // Resumen de ahorros
                    doc.setFillColor(255, 255, 255);
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.5);
                    doc.roundedRect(margin, yPos, contentWidth, 45, 2, 2, 'FD');
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text(tr('Con tu tarifa actual y potencias contratadas:'), margin + 5, yPos + 8);
                    
                    doc.setTextColor(greenColor[0], greenColor[1], greenColor[2]);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('Ahorro') + ': ' + eur(resActual.savings) + '/aÃ±o', margin + 5, yPos + 18);
                    
                    yPos += 23;
                    
                    // LÃ­nea separadora
                    doc.setDrawColor(220, 220, 220);
                    doc.setLineWidth(0.3);
                    doc.line(margin + 5, yPos, pageWidth - margin - 5, yPos);
                    
                    yPos += 5;
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text(tr('Con optimizaciÃ³n de potencias (ajuste tÃ©cnico):'), margin + 5, yPos);
                    
                    yPos += 6;
                    
                    doc.setTextColor(orangeColor[0], orangeColor[1], orangeColor[2]);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('Ahorro adicional') + ': ' + eur(ahorroAdicional) + '/aÃ±o', margin + 5, yPos);
                    
                    yPos += 8;
                    
                    // Total
                    doc.setFillColor(greenColor[0], greenColor[1], greenColor[2]);
                    doc.roundedRect(margin, yPos, contentWidth, 12, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('AHORRO TOTAL OPTIMIZADO:') + ' ' + eur(resOptimized.savings) + '/aÃ±o', pageWidth / 2, yPos + 8, { align: 'center' });
                    
                    yPos += 17;
                }
                
                // ===============================================
                // PÃGINA 2: DESGLOSE DETALLADO
                // ===============================================
                doc.addPage();
                yPos = 20;
                
                // Header de la segunda pÃ¡gina
                doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.rect(0, 0, pageWidth, 15, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('DESGLOSE DETALLADO POR SUMINISTRO'), pageWidth / 2, 10, { align: 'center' });
                
                if (presentationMode === 'two-columns') {
                    // ===============================================
                    // MODO DOS COLUMNAS: COMPARATIVO LADO A LADO
                    // ===============================================
                    const colWidth = (contentWidth - 5) / 2;
                    let leftX = margin;
                    let rightX = margin + colWidth + 5;
                    let currentY = yPos;
                    
                    // FunciÃ³n auxiliar para generar una columna de desglose
                    const generateColumn = (res, x, title, color) => {
                        let y = currentY;
                        
                        // Header de la columna
                        doc.setFillColor(color[0], color[1], color[2]);
                        doc.roundedRect(x, y, colWidth, 8, 1, 1, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.text(title, x + colWidth / 2, y + 5.5, { align: 'center' });
                        y += 10;
                        
                        // Datos del CUPS
                        doc.setFillColor(70, 70, 80);
                        doc.roundedRect(x, y, colWidth, 15, 1, 1, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'bold');
                        doc.text('[' + (res.cups || 'ES') + ']', x + 3, y + 5);
                        doc.text(`Tipo: ${res.tariffType}`, x + colWidth - 3, y + 5, { align: 'right' });
                        doc.setFont('helvetica', 'normal');
                        doc.text(`DÃ­as: ${res.dias_facturados || 30}`, x + colWidth - 3, y + 9, { align: 'right' });
                        doc.setFontSize(6);
                        doc.text(res.offer.name || 'Tarifa', x + 3, y + 9);
                        y += 17;
                        
                        // Precios aplicados
                        doc.setFillColor(90, 90, 100);
                        doc.roundedRect(x, y, colWidth, 6, 1, 1, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'bold');
                        doc.text(tr('PRECIOS APLICADOS:'), x + 3, y + 4);
                        y += 8;
                        
                        // Tabla de precios - Altura dinÃ¡mica segÃºn perÃ­odos
                        const numPowerPeriods = Math.min(res.powerCosts.length, 6);
                        const numEnergyPeriods = Math.min(res.energyCosts.length, 6);
                        const maxPeriods = Math.max(numPowerPeriods, numEnergyPeriods);
                        const priceBoxHeight = 8 + (maxPeriods * 3.5); // Altura base 8 + 3.5 por cada perÃ­odo (aÃºn mÃ¡s espacio)
                        
                        doc.setFillColor(100, 100, 110);
                        doc.roundedRect(x, y, colWidth, priceBoxHeight, 1, 1, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(6);
                        doc.setFont('helvetica', 'bold');
                        doc.text(tr('POTENCIA:'), x + 3, y + 4);
                        doc.text(tr('ENERGÃA:'), x + colWidth / 2 + 2, y + 4);
                        
                        doc.setFont('helvetica', 'normal');
                        let priceY = y + 8;
                        // Mostrar todos los perÃ­odos de potencia disponibles (hasta 6)
                        const powerPeriodsToShow = Math.min(res.powerCosts.length, 6);
                        for (let i = 0; i < powerPeriodsToShow; i++) {
                            const p = res.powerCosts[i];
                            doc.text(`P${p.period}: ${num(p.priceDay, 6)} â‚¬/kW/dÃ­a`, x + 3, priceY, { maxWidth: colWidth / 2 - 5 });
                            priceY += 3.5;
                        }
                        
                        priceY = y + 8;
                        // Mostrar todos los perÃ­odos de energÃ­a disponibles (hasta 6)
                        const energyPeriodsToShow = Math.min(res.energyCosts.length, 6);
                        for (let i = 0; i < energyPeriodsToShow; i++) {
                            const e = res.energyCosts[i];
                            doc.text(`E${e.period}: ${num(e.price, 5)} â‚¬/kWh`, x + colWidth / 2 + 2, priceY, { maxWidth: colWidth / 2 - 5 });
                            priceY += 3.5;
                        }
                        y += priceBoxHeight + 2;
                        
                        // POTENCIA
                        doc.setFillColor(250, 250, 250);
                        doc.roundedRect(x, y, colWidth, 6, 1, 1, 'F');
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'bold');
                        doc.text(tr('POTENCIA'), x + 3, y + 4);
                        y += 8;
                        
                        res.powerCosts.forEach(p => {
                            if (p.kw > 0 || res.powerCosts.length <= 6) {
                                doc.setFontSize(6);
                                doc.setFont('helvetica', 'normal');
                                doc.setTextColor(60, 60, 60);
                                const powerLine = `P${p.period}: (${num(p.kw, 2)} kW x ${num(p.priceDay, 6)} â‚¬/kW/dÃ­a)`;
                                doc.text(powerLine, x + 3, y);
                                doc.text(`${num(p.cost, 2)} â‚¬`, x + colWidth - 3, y, { align: 'right' });
                                y += 3.5;
                            }
                        });
                        
                        // ENERGÃA
                        y += 2;
                        doc.setFillColor(250, 250, 250);
                        doc.roundedRect(x, y, colWidth, 6, 1, 1, 'F');
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'bold');
                        doc.text(tr('ENERGÃA'), x + 3, y + 4);
                        y += 8;
                        
                        res.energyCosts.forEach(e => {
                            if (e.kwh > 0 || res.energyCosts.length <= 6) {
                                doc.setFontSize(6);
                                doc.setFont('helvetica', 'normal');
                                doc.setTextColor(60, 60, 60);
                                const energyLine = `E${e.period}: (${num(e.kwh, 0)} kWh x ${num(e.price, 5)} â‚¬/kWh)`;
                                doc.text(energyLine, x + 3, y);
                                doc.text(`${num(e.cost, 2)} â‚¬`, x + colWidth - 3, y, { align: 'right' });
                                y += 3.5;
                            }
                        });
                        
                        // TOTAL
                        y += 2;
                        doc.setFillColor(color[0], color[1], color[2]);
                        doc.roundedRect(x, y, colWidth, 8, 1, 1, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'bold');
                        doc.text(tr('TOTAL (30 DÃAS)'), x + 3, y + 5.5);
                        doc.text(eur(res.totalPeriod), x + colWidth - 3, y + 5.5, { align: 'right' });
                        y += 10;
                        
                        // AHORRO
                        doc.setFillColor(220, 38, 38);
                        doc.roundedRect(x, y, colWidth, 8, 1, 1, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'bold');
                        doc.text(tr('AHORRO:'), x + 3, y + 5.5);
                        doc.text(eur(res.savings), x + colWidth - 3, y + 5.5, { align: 'right' });
                        
                        return y + 12;
                    };
                    
                    // Generar columna izquierda (Actuales)
                    generateColumn(resActual, leftX, tr('[ES] - POTENCIAS ACTUALES'), primaryColor);
                    
                    // Generar columna derecha (Optimizadas)
                    generateColumn(resOptimized, rightX, tr('[ES] - POTENCIAS OPTIMIZADAS'), greenColor);
                    
                } else {
                    // ===============================================
                    // MODO UNA COLUMNA: SOLO ACTUALES
                    // ===============================================
                    let y = yPos;
                    
                    // Header del desglose
                    doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                    doc.roundedRect(margin, y, contentWidth, 8, 1, 1, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('[ES] - CON TU TARIFA ACTUAL'), pageWidth / 2, y + 5.5, { align: 'center' });
                    y += 10;
                    
                    // Datos del CUPS
                    doc.setFillColor(70, 70, 80);
                    doc.roundedRect(margin, y, contentWidth, 15, 1, 1, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('[' + (resActual.cups || 'ES') + ']', margin + 3, y + 5);
                    doc.text(`Tipo: ${resActual.tariffType}`, pageWidth - margin - 3, y + 5, { align: 'right' });
                    doc.setFont('helvetica', 'normal');
                    doc.text(`DÃ­as: ${resActual.dias_facturados || 30}`, pageWidth - margin - 3, y + 9, { align: 'right' });
                    doc.setFontSize(6);
                    doc.text(resActual.offer.name || 'Tarifa', margin + 3, y + 9);
                    y += 17;
                    
                    // Precios aplicados
                    doc.setFillColor(90, 90, 100);
                    doc.roundedRect(margin, y, contentWidth, 6, 1, 1, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PRECIOS APLICADOS:', margin + 3, y + 4);
                    y += 8;
                    
                    // Tabla de precios
                    doc.setFillColor(100, 100, 110);
                    doc.roundedRect(margin, y, contentWidth, 25, 1, 1, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'bold');
                    doc.text('POTENCIA:', margin + 3, y + 4);
                    doc.text('ENERGÃA:', margin + contentWidth / 2 + 3, y + 4);
                    
                    doc.setFont('helvetica', 'normal');
                    let priceY = y + 8;
                    resActual.powerCosts.forEach((p, idx) => {
                        if (idx < 6) {
                            doc.text(`P${p.period}: ${num(p.priceDay, 6)} â‚¬/kW/dÃ­a`, margin + 3, priceY);
                            priceY += 3;
                        }
                    });
                    
                    priceY = y + 8;
                    resActual.energyCosts.forEach((e, idx) => {
                        if (idx < 6) {
                            doc.text(`E${e.period}: ${num(e.price, 5)} â‚¬/kWh`, margin + contentWidth / 2 + 3, priceY);
                            priceY += 3;
                        }
                    });
                    y += 27;
                    
                    // POTENCIA
                    doc.setFillColor(250, 250, 250);
                    doc.roundedRect(margin, y, contentWidth, 6, 1, 1, 'F');
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('POTENCIA', margin + 3, y + 4);
                    y += 8;
                    
                    resActual.powerCosts.forEach(p => {
                        doc.setFontSize(6);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(60, 60, 60);
                        const powerLine = `P${p.period}: (${num(p.kw, 2)} kW x ${num(p.priceDay, 6)} â‚¬/kW/dÃ­a)`;
                        doc.text(powerLine, margin + 3, y);
                        doc.text(`${num(p.cost, 2)} â‚¬`, pageWidth - margin - 3, y, { align: 'right' });
                        y += 3.5;
                    });
                    
                    // ENERGÃA
                    y += 2;
                    doc.setFillColor(250, 250, 250);
                    doc.roundedRect(margin, y, contentWidth, 6, 1, 1, 'F');
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('ENERGÃA', margin + 3, y + 4);
                    y += 8;
                    
                    resActual.energyCosts.forEach(e => {
                        doc.setFontSize(6);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(60, 60, 60);
                        const energyLine = `E${e.period}: (${num(e.kwh, 0)} kWh x ${num(e.price, 5)} â‚¬/kWh)`;
                        doc.text(energyLine, margin + 3, y);
                        doc.text(`${num(e.cost, 2)} â‚¬`, pageWidth - margin - 3, y, { align: 'right' });
                        y += 3.5;
                    });
                    
                    // TOTAL
                    y += 2;
                    doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                    doc.roundedRect(margin, y, contentWidth, 8, 1, 1, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`TOTAL (${resActual.dias_facturados || 30} DÃAS)`, margin + 3, y + 5.5);
                    doc.text(eur(resActual.totalPeriod), pageWidth - margin - 3, y + 5.5, { align: 'right' });
                    y += 10;
                    
                    // AHORRO
                    doc.setFillColor(220, 38, 38);
                    doc.roundedRect(margin, y, contentWidth, 8, 1, 1, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text('AHORRO:', margin + 3, y + 5.5);
                    doc.text(eur(resActual.savings), pageWidth - margin - 3, y + 5.5, { align: 'right' });
                    
                    // Actualizar finalY para que el resumen vaya despuÃ©s del desglose
                    finalY = y + 12; // Menos espacio entre desglose y resumen
                }
                
                // ===============================================
                // RESUMEN DE AHORRO JUSTO DESPUÃ‰S DEL DESGLOSE
                // ===============================================
                // Si finalY no fue definido (modo dos columnas), usar una posiciÃ³n despuÃ©s de las columnas
                if (typeof finalY === 'undefined') {
                    finalY = 185; // Ajustado para que quepa todo en pÃ¡gina 2
                }
                
                if (presentationMode === 'two-columns') {
                    // Modo dos columnas: Mostrar resumen comparativo (mÃ¡s compacto)
                    doc.setFillColor(250, 250, 250);
                    doc.roundedRect(margin, finalY, contentWidth, 30, 2, 2, 'F');
                    doc.setDrawColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                    doc.setLineWidth(0.5);
                    doc.roundedRect(margin, finalY, contentWidth, 30, 2, 2, 'S');
                    
                    // TÃ­tulo
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                    doc.text(tr('RESUMEN DE AHORRO ANUAL'), pageWidth / 2, finalY + 6, { align: 'center' });
                    
                    // LÃ­nea de separaciÃ³n
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.3);
                    doc.line(margin + 5, finalY + 9, pageWidth - margin - 5, finalY + 9);
                    
                    // Ahorro con potencias actuales
                    doc.setFontSize(7.5);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(0, 0, 0);
                    doc.text(tr('Con potencias actuales:'), margin + 5, finalY + 14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(greenColor[0], greenColor[1], greenColor[2]);
                    doc.text(eur(resActual.savings), pageWidth - margin - 5, finalY + 14, { align: 'right' });
                    
                    // Ahorro adicional con optimizaciÃ³n
                    const ahorroAdicional = resActual.totalAnnual - resOptimized.totalAnnual;
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(0, 0, 0);
                    doc.text(tr('Ahorro adicional optimizando:'), margin + 5, finalY + 19);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(orangeColor[0], orangeColor[1], orangeColor[2]);
                    doc.text(eur(ahorroAdicional), pageWidth - margin - 5, finalY + 19, { align: 'right' });
                    
                    // Total optimizado
                    doc.setFillColor(greenColor[0], greenColor[1], greenColor[2]);
                    doc.roundedRect(margin + 5, finalY + 22, contentWidth - 10, 7, 1, 1, 'F');
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(8);
                    doc.text(tr('AHORRO TOTAL OPTIMIZADO:'), margin + 10, finalY + 27);
                    doc.text(eur(resOptimized.savings), pageWidth - margin - 10, finalY + 27, { align: 'right' });
                    
                    finalY += 35; // Avanzar despuÃ©s del resumen
                    
                } else {
                    // Modo una columna: MISMO RESUMEN que dos columnas
                    doc.setFillColor(250, 250, 250);
                    doc.roundedRect(margin, finalY, contentWidth, 30, 2, 2, 'F');
                    doc.setDrawColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                    doc.setLineWidth(0.5);
                    doc.roundedRect(margin, finalY, contentWidth, 30, 2, 2, 'S');
                    
                    // TÃ­tulo
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                    doc.text(tr('RESUMEN DE AHORRO ANUAL'), pageWidth / 2, finalY + 6, { align: 'center' });
                    
                    // LÃ­nea de separaciÃ³n
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.3);
                    doc.line(margin + 5, finalY + 9, pageWidth - margin - 5, finalY + 9);
                    
                    // Ahorro con potencias actuales
                    doc.setFontSize(7.5);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(0, 0, 0);
                    doc.text(tr('Con potencias actuales:'), margin + 5, finalY + 14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(greenColor[0], greenColor[1], greenColor[2]);
                    doc.text(eur(resActual.savings), pageWidth - margin - 5, finalY + 14, { align: 'right' });
                    
                    // Ahorro adicional con optimizaciÃ³n
                    const ahorroAdicional = resActual.totalAnnual - resOptimized.totalAnnual;
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(0, 0, 0);
                    doc.text(tr('Ahorro adicional optimizando:'), margin + 5, finalY + 19);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(orangeColor[0], orangeColor[1], orangeColor[2]);
                    doc.text(eur(ahorroAdicional), pageWidth - margin - 5, finalY + 19, { align: 'right' });
                    
                    // Total optimizado
                    doc.setFillColor(greenColor[0], greenColor[1], greenColor[2]);
                    doc.roundedRect(margin + 5, finalY + 22, contentWidth - 10, 7, 1, 1, 'F');
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(8);
                    doc.text(tr('AHORRO TOTAL OPTIMIZADO:'), margin + 10, finalY + 27);
                    doc.text(eur(resOptimized.savings), pageWidth - margin - 10, finalY + 27, { align: 'right' });
                    
                    finalY += 35; // Avanzar despuÃ©s del resumen
                }
                
                // ===============================================
                // TEXTO DE FORMALIZACIÃ“N (en la misma pÃ¡gina 2)
                // ===============================================
                // AÃ±adir un pequeÃ±o espacio
                finalY += 3;
                
                // Caja de formalizaciÃ³n (mÃ¡s compacta)
                doc.setFillColor(70, 80, 90);
                doc.roundedRect(margin, finalY, contentWidth, 45, 2, 2, 'F');
                
                // TÃ­tulo
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('PARA FORMALIZAR ESTE CONTRATO:'), margin + 4, finalY + 7);
                
                // SubtÃ­tulo
                doc.setFontSize(7.5);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('Responde a este email adjuntando la siguiente documentacion:'), margin + 4, finalY + 12);
                
                // Lista de documentos (mÃ¡s compacta)
                doc.setFontSize(6.5);
                doc.setFont('helvetica', 'normal');
                doc.text(tr('1. Foto del DNI/CIF (anverso y reverso)'), margin + 7, finalY + 17);
                doc.text(tr('2. Ultima factura (minimo 3 meses de antiguedad)'), margin + 7, finalY + 21);
                doc.text(tr('3. Email de contacto para validacion'), margin + 7, finalY + 25);
                doc.text(tr('4. Telefono de contacto'), margin + 7, finalY + 29);
                doc.text(tr('5. Numero de cuenta bancaria (IBAN)'), margin + 7, finalY + 33);
                
                // LÃ­nea separadora
                doc.setDrawColor(180, 180, 180);
                doc.setLineWidth(0.5);
                doc.line(margin + 4, finalY + 37, pageWidth - margin - 4, finalY + 37);
                
                // Texto de envÃ­o
                doc.setFontSize(6.5);
                doc.setFont('helvetica', 'normal');
                doc.text(tr('Envia la documentacion al comercial:'), margin + 4, finalY + 41);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(8);
                doc.text(commercialCode || 'a<sz', margin + 4, finalY + 45);
                
                // Guardar PDF
                const pdfName = `Comparativo_Potencias_${clientName.replace(/\s+/g, '_')}_${new Date().toLocaleDateString('es-ES').replace(/\//g, '-')}.pdf`;
                doc.save(pdfName);
                
                window.showMessageModal(`âœ… PDF generado correctamente: ${pdfName}`);
                
                // Cerrar modal
                document.getElementById('send-offer-modal').classList.add('hidden');
                document.getElementById('send-offer-modal').classList.remove('flex');
                
            } catch (error) {
                console.error('Error al generar PDF dual de potencias:', error);
                window.showErrorModal(`Error al generar PDF: ${error.message}`);
            }
        }

        async function handleGeneratePDF() {
            // NUEVO: Mostrar advertencia si el idioma es chino
            if (window.showChinesePDFWarning && !window.showChinesePDFWarning()) {
                return; // Usuario cancelÃ³
            }
            
            console.log('handleGeneratePDF llamada', {
                lastComparisonResult: lastComparisonResult,
                lastIndexedResult: lastIndexedResult,
                compareWithIndexed: compareWithIndexed,
                dualPowerComparison: window.lastDualPowerComparison
            });
            
            // NUEVO: Detectar si hay comparativa dual de potencias
            if (window.lastDualPowerComparison && !window.pdfModeAlreadySelected) {
                console.log('ðŸ”„ Comparativa DUAL DE POTENCIAS detectada');
                
                // Verificar si el selector compacto estÃ¡ visible
                const compactSelector = document.getElementById('optimized-presentation-mode-selector');
                if (compactSelector && !compactSelector.classList.contains('hidden')) {
                    // El selector compacto estÃ¡ visible, tomar el valor de ahÃ­
                    const selectedModeCompact = document.querySelector('#optimized-presentation-mode-selector input[name="presentation-mode"]:checked').value;
                    console.log('ðŸ“Š Modo seleccionado desde selector compacto:', selectedModeCompact);
                    
                    // Marcar como seleccionado y generar PDF directamente
                    window.pdfModeAlreadySelected = true;
                    await handleGeneratePDF_DualPower(selectedModeCompact);
                    window.pdfModeAlreadySelected = false;
                    return;
                } else {
                    // El selector compacto no estÃ¡ visible, mostrar modal grande
                    console.log('ðŸ“Š Mostrando modal de selecciÃ³n de modo');
                    showPresentationModeModal();
                    return; // No generar PDF todavÃ­a, esperar a que el usuario elija
                }
            }
            
            if (!lastComparisonResult) {
                console.error('ERROR: lastComparisonResult es null o undefined');
                return window.showErrorModal("Primero realice una comparaciÃ³n.");
            }
            
            const commercialCode = document.getElementById('comercial-code-input').value.trim();
            const clientName = document.getElementById('client-name-input').value.trim() || '[NOMBRE COMPLETO CLIENTE]';
            const clientPhone = document.getElementById('client-phone-input').value.trim();
            const clientAddress = document.getElementById('client-address-input').value.trim();
            const clientEmail = document.getElementById('client-email-input').value.trim();
            
            console.log('ðŸ“‹ DATOS CAPTURADOS EN handleGeneratePDF:');
            console.log('  - CÃ³digo comercial:', commercialCode);
            console.log('  - Nombre cliente:', clientName);
            console.log('  - TelÃ©fono:', clientPhone);
            console.log('  - ðŸ  DIRECCIÃ“N:', clientAddress);
            console.log('  - Email:', clientEmail);
            
            if (!commercialCode) return window.showErrorModal("Indique el CÃ³digo Comercial.");
            
            // IMPORTANTE: Detectar si hay resultado indexado para generar PDF dual
            // Puede estar en lastIndexedResult (individual) o en indexedTotals (MULTICUPS)
            const hasIndexedData = (lastIndexedResult && compareWithIndexed) || 
                                    (lastComparisonResult.isMultiCups && lastComparisonResult.indexedTotals);
            
            console.log('ðŸ” hasIndexedData:', hasIndexedData);
            console.log('ðŸ” lastIndexedResult:', lastIndexedResult);
            console.log('ðŸ” indexedTotals:', lastComparisonResult.indexedTotals);
            
            if (hasIndexedData) {
                // Si hay resultado indexado, generar PDF dual
                if (lastComparisonResult.isMultiCups) {
                    // MULTICUPS con Ã­ndice
                    console.log('âœ… Generando PDF MULTICUPS DUAL');
                    await generateMultiPDF_Dual(lastComparisonResult, commercialCode, clientName, clientPhone, clientEmail, clientAddress);
                } else {
                    // Individual con Ã­ndice
                    console.log('âœ… Generando PDF INDIVIDUAL DUAL');
                    await generatePDF_Dual(lastComparisonResult, lastIndexedResult, commercialCode, clientName, clientPhone, clientEmail, clientAddress);
                }
                
                // Cerrar modal
                document.getElementById('send-offer-modal').classList.add('hidden');
                document.getElementById('send-offer-modal').classList.remove('flex');
                return;
            }
            
            try {
                // Mostrar mensaje de carga
                window.showMessageModal("â³ Generando PDF profesional... Por favor espere.");
                
                // Importar jsPDF
                const { jsPDF } = window.jspdf;
                let doc = new jsPDF('p', 'mm', 'a4');
                
                // CRÃTICO: Activar traducciÃ³n automÃ¡tica de textos
                if (window.setupPDFTranslation) {
                    doc = window.setupPDFTranslation(doc);
                }
                
                const brand = activeBrand;
                const res = lastComparisonResult;
                const offer = res.offer;
                const isDrk = brand.NAME.includes('DRK');
                const tariffType = res.originalTariffType || currentTariffType;
                const config = TARIFF_CONFIG[tariffType];
                
                // Colores corporativos
                const primaryColor = isDrk ? [90, 120, 145] : [130, 145, 100]; // DRK: azul grisÃ¡ceo | POWER: verde oliva claro
                const darkColor = isDrk ? [107, 125, 142] : [115, 130, 95]; // DRK: gris azulado | POWER: verde oliva oscuro
                const lightBg = isDrk ? [240, 245, 250] : [245, 248, 240];
                const greenColor = [22, 163, 74];
                const redColor = [220, 38, 38];
                const grayBg = [245, 245, 245];
                
                let yPos = 0;
                const pageWidth = 210;
                const margin = 15;
                const contentWidth = pageWidth - (2 * margin);
                
                // === NUEVA CABECERA CON DEGRADADO HORIZONTAL Y LOGO ===
                // Fondo con degradado de oscuro a claro (izquierda a derecha)
                const headerHeight = 45;
                for (let i = 0; i < pageWidth; i++) {
                    const ratio = i / pageWidth;
                    // De azul oscuro a azul claro/blanco
                    const r = Math.round(darkColor[0] + (240 - darkColor[0]) * ratio);
                    const g = Math.round(darkColor[1] + (245 - darkColor[1]) * ratio);
                    const b = Math.round(darkColor[2] + (250 - darkColor[2]) * ratio);
                    doc.setFillColor(r, g, b);
                    doc.rect(i, 0, 1, headerHeight, 'F');
                }
                
                // Logo segÃºn marca
                const logoX = margin + 8;
                const logoY = 15;
                const logoRadius = 6;
                
                if (isDrk) {
                    // Logo circular DRK (anillo multicolor)
                    doc.setFillColor(219, 68, 55); // Rojo
                    doc.circle(logoX - 1, logoY + 1, logoRadius * 0.8, 'F');
                    doc.setFillColor(66, 133, 244); // Azul
                    doc.circle(logoX + 1, logoY - 1, logoRadius * 0.8, 'F');
                    doc.setFillColor(244, 180, 0); // Amarillo
                    doc.circle(logoX - 1, logoY - 1, logoRadius * 0.7, 'F');
                    doc.setFillColor(15, 157, 88); // Verde
                    doc.circle(logoX + 1, logoY + 1, logoRadius * 0.7, 'F');
                    
                    // CÃ­rculo central blanco
                    doc.setFillColor(255, 255, 255);
                    doc.circle(logoX, logoY, logoRadius * 0.4, 'F');
                } else {
                    // Logo POWER CUP (taza con niveles de energÃ­a y rayo)
                    
                    // Plato/base (verde oscuro)
                    doc.setFillColor(60, 90, 50);
                    doc.rect(logoX - 5, logoY + 4, 10, 1, 'F');
                    
                    // Borde de la taza (verde oscuro)
                    doc.setDrawColor(60, 90, 50);
                    doc.setLineWidth(1.2);
                    doc.roundedRect(logoX - 3.5, logoY - 2, 7, 6, 0.5, 0.5, 'S');
                    
                    // Asa de la taza (usando lÃ­nea curva)
                    doc.setLineWidth(1);
                    doc.line(logoX + 3.5, logoY, logoX + 5, logoY - 0.5);
                    doc.line(logoX + 5, logoY - 0.5, logoX + 5.5, logoY + 1);
                    doc.line(logoX + 5.5, logoY + 1, logoX + 5, logoY + 2.5);
                    doc.line(logoX + 5, logoY + 2.5, logoX + 3.5, logoY + 2);
                    
                    // Niveles de energÃ­a dentro de la taza (lÃ­neas verdes horizontales)
                    doc.setFillColor(100, 150, 70);
                    doc.rect(logoX - 3, logoY + 2.5, 6, 0.8, 'F');  // Nivel 1
                    doc.rect(logoX - 3, logoY + 0.8, 6, 0.8, 'F');  // Nivel 2
                    doc.rect(logoX - 3, logoY - 0.9, 6, 0.8, 'F');  // Nivel 3
                    
                    // Rayo amarillo encima de la taza
                    doc.setFillColor(255, 200, 0);
                    const rayX = logoX;
                    const rayY = logoY - 7;
                    // Parte superior del rayo
                    doc.triangle(rayX - 1, rayY, rayX - 2, rayY + 2.5, rayX, rayY + 2, 'F');
                    // Parte inferior del rayo
                    doc.triangle(rayX, rayY + 2, rayX - 1, rayY + 4.5, rayX + 1.5, rayY + 4.5, 'F');
                }
                
                yPos = 12;
                
                // Texto "DRK ENERGÃA" a la derecha del logo
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                const brandText = isDrk ? 'DRK' : 'POWER CUP';
                doc.text(brandText, logoX + 12, yPos + 3);
                
                // "ENERGÃA" debajo
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text('ENERGÃA', logoX + 12, yPos + 11);
                
                // Tagline
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(200, 220, 240);
                doc.text(tr('Liderando el ahorro y la'), logoX + 12, yPos + 19);
                doc.text(tr('eficiencia energÃ©tica.'), logoX + 12, yPos + 24);
                
                // Texto derecha "ESTUDIO DE AHORRO COMPARATIVA PROFESIONAL"
                doc.setTextColor(40, 60, 80);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('ESTUDIO DE AHORRO'), pageWidth - margin - 3, yPos + 5, { align: 'right' });
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('COMPARATIVA', pageWidth - margin - 3, yPos + 13, { align: 'right' });
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(100, 120, 140);
                doc.text('PROFESIONAL', pageWidth - margin - 3, yPos + 21, { align: 'right' });
                
                yPos = 50;
                
                // === INFORMACIÃ“N DEL CLIENTE (REDISEÃ‘ADA) ===
                // Barra superior verde
                doc.setFillColor(...greenColor); // VERDE
                doc.roundedRect(margin, yPos, contentWidth, 8, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('ESTUDIO DE AHORRO'), margin + 5, yPos + 5.5);
                
                // Caja blanca con borde azul
                doc.setFillColor(255, 255, 255);
                doc.setDrawColor(...darkColor);
                doc.setLineWidth(1);
                doc.roundedRect(margin, yPos + 8, contentWidth, 20, 3, 3, 'FD');
                
                doc.setTextColor(...darkColor);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text(`COMPARATIVA PROFESIONAL - ${isDrk ? 'DRK' : 'POWER CUP'}`, margin + 5, yPos + 14);
                
                doc.setTextColor(80, 80, 80);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text(`CLIENTE: ${clientName}`, margin + 5, yPos + 20);
                if (!res.isMulti) {
                    doc.text(`CUPS: ${res.cups}`, margin + 5, yPos + 25);
                } else {
                    doc.text(`CUPS TOTALES: ${res.individualResults.length}`, margin + 5, yPos + 25);
                }
                
                // Comercial en caja destacada
                doc.setFillColor(...lightBg);
                doc.roundedRect(pageWidth - margin - 45, yPos + 17, 45, 8, 2, 2, 'F');
                doc.setTextColor(...darkColor);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(8);
                doc.text(`COMERCIAL: ${commercialCode}`, pageWidth - margin - 43, yPos + 22.5);
                
                // DirecciÃ³n debajo del comercial (si existe)
                if (clientAddress) {
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(7);
                    doc.text(tr('DirecciÃ³n:') + ' ' + clientAddress, pageWidth - margin - 43, yPos + 27);
                }
                
                yPos += 35;
                
                // Definir savingsText para usarlo en la seccion comun al final
                const savingsText = res.savings > 0 ? eur(res.savings) : '0,00 â‚¬';
                
                // Funcion auxiliar para nueva pagina (disponible para todos)
                const checkNewPage = function(neededSpace) {
                    if (yPos + neededSpace > 270) {
                        doc.addPage();
                        yPos = 20;
                        return true;
                    }
                    return false;
                };
                
                // ================================================================
                // BIFURCACION: Si es MultiCups, generar PDF especial MultiCups
                // ================================================================
                
                if (res.isMulti && res.individualResults && res.individualResults.length > 0) {
                    // === INICIO MULTICUPS - DISEÃ‘O COMPACTO TIPO TARJETA ===
                    
                    // === CABECERA AZUL (MÃS PEQUEÃ‘A) ===
                    doc.setFillColor(...primaryColor);
                    doc.roundedRect(margin, yPos, contentWidth, 32, 4, 4, 'F');
                    
                    // "LA MEJOR OPCIÃ“N PARA TI ES"
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('LA MEJOR OPCIÃ“N PARA TI ES'), pageWidth / 2, yPos + 8, { align: 'center' });
                    
                    // Marca o Tarifa
                    const brandNameMulti = isDrk ? 'DRK' : 'POWER CUP';
                    // Usar description si estÃ¡ disponible, sino name
                    const displayOfferName = (offer.description && offer.description !== 'N/A') ? offer.description : offer.name;
                    
                    if (!isDrk) {
                        // POWER CUP MultiCups: Solo mostrar "POWER CUP" (puede haber mÃºltiples tarifas)
                        doc.setFontSize(32);
                        doc.setFont('helvetica', 'bold');
                        doc.text('POWER CUP', pageWidth / 2, yPos + 20, { align: 'center' });
                    } else {
                        // DRK: Mostrar DRK y nombre de tarifa
                        doc.setFontSize(26);
                        doc.setFont('helvetica', 'bold');
                        doc.text('DRK', pageWidth / 2, yPos + 18, { align: 'center' });
                        
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'normal');
                        doc.text(displayOfferName, pageWidth / 2, yPos + 27, { align: 'center' });
                    }
                    
                    yPos += 37;
                    
                    // === CAJA BLANCA COMPACTA ===
                    doc.setFillColor(255, 255, 255);
                    doc.setDrawColor(220, 220, 220);
                    doc.setLineWidth(0.3);
                    const boxHeight = res.savings > 0 ? 75 : 65; // Altura ajustada para mensaje
                    doc.roundedRect(margin, yPos, contentWidth, boxHeight, 4, 4, 'FD');
                    
                    if (res.savings > 0) {
                        // Ahorro positivo - diseÃ±o normal
                        doc.setTextColor(120, 120, 140);
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text(tr('TU AHORRO ANUAL ESTIMADO'), pageWidth / 2, yPos + 8, { align: 'center' });
                        
                        // Cifra de ahorro en VERDE (grande pero ajustado)
                        doc.setTextColor(...greenColor);
                        doc.setFontSize(32);
                        doc.setFont('helvetica', 'bold');
                        doc.text(savingsText, pageWidth / 2, yPos + 25, { align: 'center' });
                        
                        yPos += 32;
                    } else {
                        // Sin ahorro - mensaje grande centrado
                        doc.setTextColor(...primaryColor);
                        doc.setFontSize(16);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Â¡ENHORABUENA!', pageWidth / 2, yPos + 12, { align: 'center' });
                        
                        doc.setTextColor(60, 60, 60);
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Actualmente estÃ¡s en una buena tarifa.', pageWidth / 2, yPos + 25, { align: 'center' });
                        
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'normal');
                        doc.text('Seguiremos estudiando el mercado y te avisaremos cuando', pageWidth / 2, yPos + 38, { align: 'center' });
                        doc.text('encontremos alguna tarifa que se adapte a tu perfil de consumo.', pageWidth / 2, yPos + 45, { align: 'center' });
                        
                        yPos += 67;
                        // Saltar la secciÃ³n de precios - no mostrarlos
                        yPos += 50;
                    }
                    
                    // === DOS COLUMNAS COMPACTAS === (Solo si hay ahorro)
                    if (res.savings > 0) {
                    const colWidthMulti = (contentWidth - 20) / 2;
                    
                    // COLUMNA IZQUIERDA - TU FACTURA ACTUAL
                    const leftXMulti = margin + 10;
                    
                    doc.setTextColor(140, 150, 160);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('TU FACTURA ACTUAL'), leftXMulti + colWidthMulti / 2, yPos, { align: 'center' });
                    
                    // Precio mensual tachado en rojo
                    const oldPriceMulti = `${eur(res.originalBillAnnual / 12)}${tr('/mes')}`;
                    doc.setTextColor(...redColor);
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    const oldXMulti = leftXMulti + colWidthMulti / 2;
                    const oldYMulti = yPos + 12;
                    doc.text(oldPriceMulti, oldXMulti, oldYMulti, { align: 'center' });
                    
                    // LÃ­nea tachada
                    const oldWidthMulti = doc.getTextWidth(oldPriceMulti);
                    doc.setDrawColor(...redColor);
                    doc.setLineWidth(1.5);
                    doc.line(oldXMulti - oldWidthMulti/2 - 2, oldYMulti - 3, oldXMulti + oldWidthMulti/2 + 2, oldYMulti - 3);
                    
                    // "Total Periodo (Variado)"
                    doc.setTextColor(140, 150, 160);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`${tr('Total Periodo')} (${tr('Variado')})`, leftXMulti + colWidthMulti / 2, yPos + 19, { align: 'center' });
                    
                    // Precio anual tachado
                    const oldAnnualMulti = eur(res.originalBillAnnual);
                    doc.setTextColor(...redColor);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    const oldAnnualXMulti = leftXMulti + colWidthMulti / 2;
                    const oldAnnualYMulti = yPos + 32;
                    doc.text(`${oldAnnualMulti}${tr('/aÃ±o')}`, oldAnnualXMulti, oldAnnualYMulti, { align: 'center' });
                    
                    // LÃ­nea tachada
                    const oldAnnualWidthMulti = doc.getTextWidth(`${oldAnnualMulti}${tr('/aÃ±o')}`);
                    doc.setDrawColor(...redColor);
                    doc.setLineWidth(1.5);
                    doc.line(oldAnnualXMulti - oldAnnualWidthMulti/2 - 2, oldAnnualYMulti - 3, oldAnnualXMulti + oldAnnualWidthMulti/2 + 2, oldAnnualYMulti - 3);
                    
                    // SEPARADOR VERTICAL
                    doc.setDrawColor(220, 220, 220);
                    doc.setLineWidth(0.3);
                    doc.line(pageWidth / 2, yPos - 5, pageWidth / 2, yPos + 38);
                    
                    // COLUMNA DERECHA - TU NUEVO COSTE
                    const rightXMulti = margin + 10 + colWidthMulti + 10;
                    
                    doc.setTextColor(...primaryColor);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    const newLabelMulti = `TU NUEVO COSTE ${brandNameMulti}`;
                    doc.text(newLabelMulti, rightXMulti + colWidthMulti / 2, yPos, { align: 'center' });
                    
                    // Precio mensual en azul
                    doc.setTextColor(...primaryColor);
                    doc.setFontSize(20);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${eur(res.totalAnnual / 12)}${tr('/mes')}`, rightXMulti + colWidthMulti / 2, yPos + 13, { align: 'center' });
                    
                    // "Estimado Mensual"
                    doc.setTextColor(140, 150, 160);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'normal');
                    doc.text(tr('Estimado Mensual'), rightXMulti + colWidthMulti / 2, yPos + 19, { align: 'center' });
                    
                    // Precio anual en azul
                    doc.setTextColor(...primaryColor);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${eur(res.totalAnnual)}${tr('/aÃ±o')}`, rightXMulti + colWidthMulti / 2, yPos + 32, { align: 'center' });
                    
                    yPos += 50;
                    } // Fin del condicional de columnas de precios
                    
                    // === RESUMEN DE SUMINISTROS (DISEÃ‘O MEJORADO) ===
                    checkNewPage(50);
                    
                    // Titulo resumen (verde)
                    doc.setFillColor(...greenColor); // VERDE
                    doc.roundedRect(margin, yPos, contentWidth, 10, 3, 3, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    // Construir texto traducible
                    const resumenText = `${tr('RESUMEN DE')} ${res.individualResults.length} ${tr('SUMINISTROS')}`;
                    doc.text(resumenText, margin + 3, yPos + 6.5);
                    yPos += 14;
                    
                    // Cabecera tabla (azul oscuro con texto blanco)
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.setFillColor(...darkColor);
                    doc.roundedRect(margin, yPos, contentWidth, 7, 2, 2, 'F');
                    doc.text('NÂº', margin + 2, yPos + 5);
                    doc.text(tr('CUPS / DIRECCIÃ“N'), margin + 12, yPos + 5);
                    doc.text('TIPO', margin + 95, yPos + 5);
                    doc.text('DÃAS', margin + 115, yPos + 5);
                    doc.text('AHORRO', pageWidth - margin - 28, yPos + 5);
                    yPos += 7;
                    
                    // Filas (alternadas con borde sutil)
                    doc.setFont('helvetica', 'normal');
                    res.individualResults.forEach((supply, idx) => {
                        checkNewPage(12); // Aumentado para dar espacio a la direcciÃ³n
                        
                        // Fondo alternado - altura aumentada para incluir direcciÃ³n
                        const rowHeight = supply.supplyAddress ? 11 : 7;
                        if (idx % 2 === 0) {
                            doc.setFillColor(248, 250, 252); // Azul muy claro
                            doc.rect(margin, yPos, contentWidth, rowHeight, 'F');
                        }
                        
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(8);
                        doc.text(`[${idx + 1}]`, margin + 2, yPos + 4.5);
                        
                        // CUPS (primera lÃ­nea)
                        doc.setFontSize(7);
                        doc.text(supply.cups, margin + 12, yPos + 4.5);
                        
                        // DIRECCIÃ“N (segunda lÃ­nea, si existe)
                        if (supply.supplyAddress && supply.supplyAddress !== 'No especificada') {
                            doc.setFontSize(6);
                            doc.setTextColor(100, 116, 139); // Gris para la direcciÃ³n
                            const direccionCorta = supply.supplyAddress.length > 35 
                                ? supply.supplyAddress.substring(0, 32) + '...' 
                                : supply.supplyAddress;
                            doc.text(direccionCorta, margin + 12, yPos + 8.5);
                            doc.setTextColor(0, 0, 0);
                        }
                        
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'bold');
                        doc.text(supply.originalTariffType, margin + 95, yPos + 4.5);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`${supply.dias_facturados}`, margin + 118, yPos + 4.5, { align: 'center' });
                        
                        const savSupply = supply.isNegativeSavings ? '0,00 â‚¬' : eur(supply.savings);
                        const colorSupply = supply.isNegativeSavings ? [150, 150, 150] : greenColor;
                        doc.setTextColor(...colorSupply);
                        doc.setFont('helvetica', 'bold');
                        doc.text(savSupply, pageWidth - margin - 2, yPos + 4.5, { align: 'right' });
                        yPos += rowHeight;
                    });
                    
                    yPos += 10;
                    
                    // === NUEVA PÃGINA PARA DESGLOSE DETALLADO ===
                    doc.addPage();
                    yPos = 20;
                    
                    // TÃ­tulo desglose detallado (en pÃ¡gina 2) - VERDE
                    doc.setFillColor(...greenColor); // VERDE
                    doc.roundedRect(margin, yPos, contentWidth, 10, 3, 3, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text('DESGLOSE DETALLADO POR SUMINISTRO', margin + 3, yPos + 6.5);
                    yPos += 14;
                    
                    // FunciÃ³n auxiliar para generar desglose en MULTICUPS (estilo dual)
                    function generarDesgloseMultiCups(supply, supplyIndexed, x, width, esColumnaIzq) {
                        const res = esColumnaIzq ? supply : supplyIndexed;
                        if (!res || !res.powerCosts || !res.energyCosts) {
                            console.error('ERROR: res no tiene la estructura necesaria', res);
                            return;
                        }
                        
                        let y = yPos;
                        
                        // === CABECERA GRIS OSCURA CON CUPS ===
                        doc.setFillColor(71, 85, 105);
                        doc.roundedRect(x, y, width, 14, 2, 2, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`[${res.cups || 'N/A'}]`, x + 3, y + 4);
                        doc.text(`Tipo: ${res.originalTariffType || ''}`, x + width - 3, y + 4, { align: 'right' });
                        doc.text(`DÃ­as: ${res.dias_facturados || 0}`, x + width - 3, y + 8, { align: 'right' });
                        
                        // DirecciÃ³n del suministro (si existe)
                        if (res.supplyAddress && res.supplyAddress !== 'No especificada') {
                            doc.setFontSize(6);
                            doc.setFont('helvetica', 'normal');
                            doc.setTextColor(200, 220, 255); // Azul claro
                            const direccionCorta = res.supplyAddress.length > 40 
                                ? res.supplyAddress.substring(0, 37) + '...' 
                                : res.supplyAddress;
                            doc.text(direccionCorta, x + 3, y + 8);
                        }
                        
                        // Nombre completo: Comercializadora - Tarifa
                        doc.setFontSize(6.5);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(255, 255, 255);
                        const comercializadora = res.offer.name || brand.NAME;
                        const nombreTarifa = res.offer.description || 'N/A';
                        const nombreCompleto = `${comercializadora} - ${nombreTarifa}`;
                        doc.text(nombreCompleto, x + 3, y + 11);
                        
                        y += 16;
                        
                        // === CAJA PRECIOS APLICADOS ===
                        doc.setFillColor(100, 116, 139);
                        doc.roundedRect(x, y, width, 8, 2, 2, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'bold');
                        doc.text('PRECIOS APLICADOS:', x + 3, y + 6);
                        y += 10;
                        
                        // Info de precios (Potencia y EnergÃ­a) - Altura dinÃ¡mica segÃºn perÃ­odos
                        const numPowerPeriods = Math.min(res.powerCosts.length, 6);
                        const numEnergyPeriods = Math.min(res.energyCosts.length, 6);
                        const maxPeriods = Math.max(numPowerPeriods, numEnergyPeriods);
                        const boxHeight = 6 + (maxPeriods * 3.2); // Altura base 6 + 3.2 por cada perÃ­odo (mÃ¡s espacio)
                        
                        doc.setFillColor(100, 116, 139);
                        doc.roundedRect(x, y, width, boxHeight, 2, 2, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(6);
                        doc.setFont('helvetica', 'bold');
                        doc.text(tr('POTENCIA:'), x + 3, y + 4);
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(5.5);
                        
                        // Mostrar precios de potencia reales (todos los perÃ­odos disponibles)
                        let potenciaY = y + 8;
                        const maxPowerPeriodsToShow = Math.min(res.powerCosts.length, 6); // MÃ¡ximo 6 perÃ­odos
                        for (let i = 0; i < maxPowerPeriodsToShow; i++) {
                            if (res.powerCosts[i]) {
                                doc.text(`P${i + 1}: ${num(res.powerCosts[i].priceDay || 0, 6)} â‚¬/kW/dÃ­a`, x + 3, potenciaY);
                                potenciaY += 3.2;
                            }
                        }
                        
                        doc.setFont('helvetica', 'bold');
                        doc.setFontSize(6);
                        doc.text('ENERGÃA:', x + width/2, y + 4);
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(5.5);
                        
                        // Mostrar precios de energÃ­a reales (todos los perÃ­odos disponibles)
                        let energiaY = y + 8;
                        const maxEnergyPeriodsToShow = Math.min(res.energyCosts.length, 6); // MÃ¡ximo 6 perÃ­odos
                        for (let i = 0; i < maxEnergyPeriodsToShow; i++) {
                            if (res.energyCosts[i]) {
                                doc.text(`E${i + 1}: ${num(res.energyCosts[i].price || 0, 6)} â‚¬/kWh`, x + width/2, energiaY);
                                energiaY += 3.2;
                            }
                        }
                        y += boxHeight + 4;
                        
                        // === SECCIÃ“N POTENCIA ===
                        doc.setFillColor(100, 116, 139);
                        doc.roundedRect(x, y, width, 7, 2, 2, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'bold');
                        doc.text('POTENCIA', x + 3, y + 5);
                        y += 9;
                        
                        // Desglose potencia
                        doc.setTextColor(55, 65, 81);
                        doc.setFontSize(6);
                        doc.setFont('helvetica', 'normal');
                        res.powerCosts.forEach((p, i) => {
                            if (p.kw > 0) {
                                const texto = `P${i+1}: (${num(p.kw, 2)} kW x ${num(p.priceDay, 6)} â‚¬/kW/dÃ­a)`;
                                doc.text(texto, x + 3, y);
                                doc.text(eur(p.cost), x + width - 3, y, { align: 'right' });
                                y += 4;
                            }
                        });
                        y += 2;
                        
                        // === SECCIÃ“N ENERGÃA ===
                        doc.setFillColor(100, 116, 139);
                        doc.roundedRect(x, y, width, 7, 2, 2, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'bold');
                        doc.text('ENERGÃA', x + 3, y + 5);
                        y += 9;
                        
                        // Desglose energÃ­a
                        doc.setTextColor(55, 65, 81);
                        doc.setFontSize(6);
                        doc.setFont('helvetica', 'normal');
                        res.energyCosts.forEach((e, i) => {
                            if (e.kwh > 0) {
                                let periodoNombre = '';
                                if (res.originalTariffType === '2.0TD') {
                                    if (i === 0) periodoNombre = ` (${tr('Punta')})`;
                                    else if (i === 1) periodoNombre = ` (${tr('Llano')})`;
                                    else if (i === 2) periodoNombre = ` (${tr('Valle')})`;
                                }
                                const texto = `E${i+1}${periodoNombre}: (${num(e.kwh, 0)} kWh x ${num(e.price, 6)} â‚¬/kWh)`;
                                doc.text(texto, x + 3, y);
                                doc.text(eur(e.cost), x + width - 3, y, { align: 'right' });
                                y += 4;
                            }
                        });
                        y += 2;
                        
                        // === TOTAL ===
                        doc.setFillColor(71, 85, 105);
                        doc.roundedRect(x, y, width, 9, 2, 2, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`TOTAL (${res.dias_facturados || 0} DÃAS)`, x + 3, y + 6);
                        doc.text(eur(res.totalPeriod || res.importe_total || 0), x + width - 3, y + 6, { align: 'right' });
                        y += 12;
                        
                        // === AHORRO ===
                        doc.setFillColor(220, 38, 38);
                        doc.roundedRect(x + width - 55, y, 52, 10, 2, 2, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'bold');
                        doc.text('AHORRO:', x + width - 52, y + 4);
                        doc.setFontSize(9);
                        doc.text(eur(res.savings || 0), x + width - 28, y + 7, { align: 'center' });
                    }
                    
                    // Por cada suministro
                    res.individualResults.forEach((supply, idx) => {
                        // Verificar si tiene comparaciÃ³n indexada
                        const tieneIndexado = supply.indexedComparison && 
                                             supply.indexedComparison.powerCosts && 
                                             supply.indexedComparison.energyCosts;
                        
                        if (tieneIndexado) {
                            // DISEÃ‘O DUAL: DOS COLUMNAS (FIJO vs INDEXADO)
                            const col2Width = (contentWidth - 6) / 2;
                            const leftXDual = margin;
                            const rightXDual = margin + col2Width + 6;
                            
                            const neededSpace = 140;
                            checkNewPage(neededSpace);
                            
                            // TÃ­tulo del suministro
                            doc.setFillColor(...darkColor);
                            doc.roundedRect(margin, yPos, contentWidth, 8, 2, 2, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(9);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`SUMINISTRO ${idx + 1}`, margin + 3, yPos + 5.5);
                            yPos += 12;
                            
                            // Generar desgloses en dos columnas
                            generarDesgloseMultiCups(supply, supply.indexedComparison, leftXDual, col2Width, true);
                            generarDesgloseMultiCups(supply, supply.indexedComparison, rightXDual, col2Width, false);
                            
                            yPos += 135;
                            
                        } else {
                            // DISEÃ‘O SIMPLE: UNA SOLA COLUMNA (solo FIJO)
                            const neededSpace = supply.originalTariffType === '3.0TD' ? 140 : 100;
                            checkNewPage(neededSpace);
                            
                            // === CABECERA DEL SUMINISTRO (AZUL OSCURO) ===
                            doc.setFillColor(...darkColor);
                            doc.setDrawColor(255, 255, 255);
                            doc.setLineWidth(2);
                            doc.roundedRect(margin, yPos, contentWidth, 12, 3, 3, 'FD');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(7);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`[${idx + 1}] ${supply.cups}`, margin + 3, yPos + 5);
                            doc.setFontSize(7);
                            doc.setFont('helvetica', 'normal');
                            
                            // Mostrar nombre completo: Comercializadora - Tarifa
                            const comercializadoraName = supply.offer.name || '';
                            const tarifaName = supply.offer.description || supply.offer.name;
                            const fullOfferName = isDrk 
                                ? tarifaName 
                                : `${comercializadoraName} - ${tarifaName}`;
                            doc.text(`Tipo: ${supply.originalTariffType} | DÃ­as: ${supply.dias_facturados} | ${fullOfferName}`, margin + 3, yPos + 9);
                            yPos += 14;
                            
                            // === PRECIOS APLICADOS ARRIBA (DISEÃ‘O MEJORADO CON TÃTULOS) ===
                            const priceBoxH = supply.originalTariffType === '2.0TD' ? 38 : 52;
                            doc.setFillColor(...darkColor);
                            doc.setDrawColor(255, 255, 255);
                            doc.setLineWidth(1);
                            doc.roundedRect(margin, yPos, contentWidth, priceBoxH, 3, 3, 'FD');
                            
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(8);
                            doc.setFont('helvetica', 'bold');
                            doc.text('PRECIOS APLICADOS:', margin + 3, yPos + 5);
                            yPos += 10;
                            
                            // === POTENCIA (con tÃ­tulo) ===
                            doc.setFontSize(7);
                            doc.setFont('helvetica', 'bold');
                            doc.text(tr('POTENCIA:'), margin + 5, yPos);
                            yPos += 4;
                            
                            doc.setFont('helvetica', 'normal');
                            if (supply.originalTariffType === '2.0TD') {
                                const p1S = supply.offer.p_potencia_1 / 365;
                                const p2S = supply.offer.p_potencia_2 / 365;
                                doc.text(`P1: ${numPriceFormula(p1S)} â‚¬/kW/dÃ­a`, margin + 8, yPos);
                                doc.text(`P2: ${numPriceFormula(p2S)} â‚¬/kW/dÃ­a`, margin + 70, yPos);
                                yPos += 6;
                            } else {
                                // 3.0TD - compacto
                                for (let i = 1; i <= 6; i++) {
                                    const pDS = (supply.offer[`p_potencia_${i}`] || 0) / 365;
                                    const col = i <= 3 ? margin + 8 : margin + 70;
                                    const row = i <= 3 ? i : i - 3;
                                    doc.text(`P${i}: ${numPriceFormula(pDS)} â‚¬/kW/dÃ­a`, col, yPos + (row - 1) * 3.5);
                                }
                                yPos += 12;
                            }
                            
                            // === ENERGÃA (con tÃ­tulo) ===
                            doc.setFont('helvetica', 'bold');
                            doc.text('ENERGÃA:', margin + 5, yPos);
                            yPos += 4;
                            
                            doc.setFont('helvetica', 'bold');
                            if (supply.originalTariffType === '2.0TD') {
                                doc.text(`E1: ${numPriceFormula(supply.offer.p1_price)}`, margin + 8, yPos);
                                doc.text(`E2: ${numPriceFormula(supply.offer.p2_price)}`, margin + 50, yPos);
                                doc.text(`E3: ${numPriceFormula(supply.offer.p3_price)}`, margin + 95, yPos);
                                yPos += 8;
                            } else {
                                // 3.0TD - compacto
                                for (let i = 1; i <= 6; i++) {
                                    const col = i <= 3 ? margin + 8 : margin + 70;
                                    const row = i <= 3 ? i : i - 3;
                                    doc.text(`E${i}: ${numPriceFormula(supply.offer[`p${i}_price`] || 0)}`, col, yPos + (row - 1) * 3.5);
                                }
                                yPos += 12;
                            }
                            
                            // Espacio variable segÃºn tarifa
                            yPos += supply.originalTariffType === '3.0TD' ? 12 : 8;
                            
                            // === DESGLOSE DE CÃLCULOS (FUERA DE LA CAJA AZUL) ===
                            // TÃ­tulo POTENCIA
                            doc.setFillColor(...darkColor);
                            doc.roundedRect(margin, yPos, contentWidth / 2 - 2, 6, 2, 2, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(7);
                            doc.setFont('helvetica', 'bold');
                            doc.text('POTENCIA', margin + 2, yPos + 4);
                            yPos += 10;
                            
                            doc.setTextColor(0, 0, 0);
                            doc.setFont('helvetica', 'normal');
                            doc.setFontSize(7);
                            supply.powerCosts.forEach(p => {
                                if (p.kw > 0 || p.period <= 2) {
                                    checkNewPage(4);
                                    doc.text(`P${p.period} (${num(p.kw, 2)} kW x ${supply.dias_facturados}d x ${numPriceFormula(p.priceDay)})`, margin + 4, yPos);
                                    doc.text(`${num(p.cost, 2)} â‚¬`, pageWidth - margin - 2, yPos, { align: 'right' });
                                    yPos += 3.5;
                                }
                            });
                            
                            yPos += 4;
                            
                            // TÃ­tulo ENERGÃA
                            doc.setFillColor(...darkColor);
                            doc.roundedRect(margin, yPos, contentWidth / 2 - 2, 6, 2, 2, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(7);
                            doc.setFont('helvetica', 'bold');
                            doc.text('ENERGÃA', margin + 2, yPos + 4);
                            yPos += 10;
                            
                            doc.setTextColor(0, 0, 0);
                            doc.setFont('helvetica', 'normal');
                            doc.setFontSize(7);
                            supply.energyCosts.forEach(e => {
                                const maxPeriod = supply.originalTariffType === '2.0TD' ? 3 : 6;
                                if (e.kwh > 0 || e.period <= maxPeriod) {
                                    checkNewPage(4);
                                    let labelE = `E${e.period}`;
                                    if (supply.originalTariffType === '2.0TD') {
                                        if (e.period === 1) labelE += ` (${tr('Punta')})`;
                                        if (e.period === 2) labelE += ` (${tr('Llano')})`;
                                        if (e.period === 3) labelE += ` (${tr('Valle')})`;
                                    }
                                    doc.text(`${labelE} (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)})`, margin + 4, yPos);
                                    doc.text(`${num(e.cost, 2)} â‚¬`, pageWidth - margin - 2, yPos, { align: 'right' });
                                    yPos += 3.5;
                                }
                            });
                            
                            yPos += 3;
                            
                            // Total del suministro
                            doc.setFillColor(...darkColor);
                            doc.rect(margin, yPos, contentWidth, 7, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(8);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`TOTAL (${supply.dias_facturados} DÃAS)`, margin + 2, yPos + 4.5);
                            doc.text(eur(supply.totalPeriod), pageWidth - margin - 2, yPos + 4.5, { align: 'right' });
                            yPos += 9;
                            
                            // === AHORRO INDIVIDUAL (DEBAJO DEL TOTAL) ===
                            if (!supply.isNegativeSavings) {
                                const ahorroWidth = 55;
                                const ahorroHeight = 8;
                                const ahorroX = pageWidth - margin - ahorroWidth;
                                
                                doc.setFillColor(...redColor);
                                doc.roundedRect(ahorroX, yPos, ahorroWidth, ahorroHeight, 2, 2, 'F');
                                doc.setTextColor(255, 255, 255);
                                doc.setFontSize(6);
                                doc.setFont('helvetica', 'bold');
                                doc.text('AHORRO:', ahorroX + 2, yPos + 3.5);
                                doc.setFontSize(10);
                                doc.text(eur(supply.savings), ahorroX + ahorroWidth - 2, yPos + 6, { align: 'right' });
                                yPos += ahorroHeight + 4;
                            } else {
                                yPos += 3;
                            }
                        }
                    });
                    
                    // === PRECIOS CONSOLIDADOS (REDISEÃ‘ADO) ===
                    checkNewPage(35);
                    
                    // TÃ­tulo principal con fondo verde
                    doc.setFillColor(...greenColor); // VERDE
                    doc.roundedRect(margin, yPos, contentWidth, 10, 3, 3, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PRECIOS DE LAS OFERTAS SELECCIONADAS', margin + 3, yPos + 6.5);
                    yPos += 14;
                    
                    const winningOffers = getWinningOffersPerType(res.individualResults);
                    const offers20MC = winningOffers.winningOffers['2.0TD'];
                    if (offers20MC && offers20MC.length > 0) {
                        offers20MC.forEach((offer20, index) => {
                            checkNewPage(35);
                            
                            // Caja con fondo azul oscuro y borde blanco
                            doc.setFillColor(...darkColor);
                            doc.setDrawColor(255, 255, 255);
                            doc.setLineWidth(2);
                            doc.roundedRect(margin, yPos, contentWidth, 32, 3, 3, 'FD');
                            
                            // TÃ­tulo de la tarifa (blanco)
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(9);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`TARIFA 2.0TD #${index + 1}: ${offer20.description || offer20.name}`, margin + 3, yPos + 5);
                            yPos += 10;
                            
                            // POTENCIA (con tÃ­tulo)
                            doc.setFontSize(7);
                            doc.text(tr('POTENCIA:'), margin + 3, yPos);
                            yPos += 4;
                            
                            doc.setFont('helvetica', 'normal');
                            const p120 = offer20.p_potencia_1 / 365;
                            const p220 = offer20.p_potencia_2 / 365;
                            doc.text(`P1: ${numPriceFormula(p120)} â‚¬/kW/dÃ­a`, margin + 5, yPos);
                            doc.text(`P2: ${numPriceFormula(p220)} â‚¬/kW/dÃ­a`, margin + 70, yPos);
                            yPos += 5;
                            
                            // ENERGÃA (con tÃ­tulo)
                            doc.setFont('helvetica', 'bold');
                            doc.text('ENERGÃA:', margin + 3, yPos);
                            yPos += 4;
                            
                            doc.text(`E1: ${numPriceFormula(offer20.p1_price)}`, margin + 5, yPos);
                            doc.text(`E2: ${numPriceFormula(offer20.p2_price)}`, margin + 48, yPos);
                            doc.text(`E3: ${numPriceFormula(offer20.p3_price)}`, margin + 93, yPos);
                            
                            yPos += 20; // MÃ¡s espacio entre tarifas (antes 12)
                        });
                    }
                    
                    const offers30MC = winningOffers.winningOffers['3.0TD'];
                    if (offers30MC && offers30MC.length > 0) {
                        offers30MC.forEach((offer30, index) => {
                            checkNewPage(60);
                            
                            // Caja con fondo azul oscuro y borde blanco
                            doc.setFillColor(...darkColor);
                            doc.setDrawColor(255, 255, 255);
                            doc.setLineWidth(2);
                            doc.roundedRect(margin, yPos, contentWidth, 56, 3, 3, 'FD');
                            
                            // TÃ­tulo de la tarifa (blanco)
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(9);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`TARIFA 3.0TD #${index + 1}: ${offer30.description || offer30.name}`, margin + 3, yPos + 5);
                            yPos += 10;
                            
                            // POTENCIA (con tÃ­tulo)
                            doc.setFontSize(7);
                            doc.text(tr('POTENCIA:'), margin + 3, yPos);
                            yPos += 4;
                            
                            doc.setFont('helvetica', 'normal');
                            for (let i = 1; i <= 6; i++) {
                                const pDay30 = (offer30[`p_potencia_${i}`] || 0) / 365;
                                const col = i <= 3 ? margin + 5 : margin + 70;
                                const row = i <= 3 ? i : i - 3;
                                doc.text(`P${i}: ${numPriceFormula(pDay30)} â‚¬/kW/dÃ­a`, col, yPos + (row - 1) * 3.5);
                            }
                            yPos += 12;
                            
                            // ENERGÃA (con tÃ­tulo)
                            doc.setFont('helvetica', 'bold');
                            doc.text('ENERGÃA:', margin + 3, yPos);
                            yPos += 4;
                            
                            for (let i = 1; i <= 6; i++) {
                                const col = i <= 3 ? margin + 5 : margin + 70;
                                const row = i <= 3 ? i : i - 3;
                                doc.text(`E${i}: ${numPriceFormula(offer30[`p${i}_price`] || 0)}`, col, yPos + (row - 1) * 3.5);
                            }
                            
                            yPos += 20; // MÃ¡s espacio despuÃ©s de 3.0TD (antes 18)
                        });
                    }
                    
                    // FIN SECCION MULTICUPS
                    
                } else {
                    // === INICIO INDIVIDUAL - DISEÃ‘O COMPACTO TIPO TARJETA ===
                
                // === CABECERA AZUL (MÃS PEQUEÃ‘A) ===
                doc.setFillColor(...primaryColor);
                doc.roundedRect(margin, yPos, contentWidth, 32, 4, 4, 'F');
                
                // "LA MEJOR OPCIÃ“N PARA TI ES"
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('LA MEJOR OPCIÃ“N PARA TI ES'), pageWidth / 2, yPos + 8, { align: 'center' });
                
                // Comercializadora y Tarifa
                const comercializadora = offer.name; // Nombre corto (ej: ELEIA)
                const tarifaCompleta = (offer.description && offer.description !== 'N/A') ? offer.description : offer.name;
                const brandName = isDrk ? 'DRK' : 'POWER CUP';
                
                if (!isDrk) {
                    // POWER CUP Individual: Solo mostrar comercializadora (nombre corto)
                    doc.setFontSize(32);
                    doc.setFont('helvetica', 'bold');
                    doc.text(comercializadora.toUpperCase(), pageWidth / 2, yPos + 18, { align: 'center' });
                    
                    // POWER CUP debajo
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text('POWER CUP', pageWidth / 2, yPos + 27, { align: 'center' });
                } else {
                    // DRK: Mostrar solo DRK y nombre de tarifa
                    doc.setFontSize(26);
                    doc.setFont('helvetica', 'bold');
                    doc.text('DRK', pageWidth / 2, yPos + 18, { align: 'center' });
                    
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text(tarifaCompleta, pageWidth / 2, yPos + 27, { align: 'center' });
                }
                
                yPos += 37;
                
                // === CAJA BLANCA COMPACTA ===
                doc.setFillColor(255, 255, 255);
                doc.setDrawColor(220, 220, 220);
                doc.setLineWidth(0.3);
                const boxHeightIndiv = res.savings > 0 ? 75 : 65;
                doc.roundedRect(margin, yPos, contentWidth, boxHeightIndiv, 4, 4, 'FD');
                
                if (res.savings > 0) {
                    // Ahorro positivo - diseÃ±o normal
                    doc.setTextColor(120, 120, 140);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('TU AHORRO ANUAL ESTIMADO'), pageWidth / 2, yPos + 8, { align: 'center' });
                    
                    // Cifra de ahorro en VERDE (grande pero ajustado)
                    doc.setTextColor(...greenColor);
                    doc.setFontSize(32);
                    doc.setFont('helvetica', 'bold');
                    doc.text(savingsText, pageWidth / 2, yPos + 25, { align: 'center' });
                    
                    yPos += 32;
                } else {
                    // Sin ahorro - mensaje grande centrado
                    doc.setTextColor(...primaryColor);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Â¡ENHORABUENA!', pageWidth / 2, yPos + 12, { align: 'center' });
                    
                    doc.setTextColor(60, 60, 60);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Actualmente estÃ¡s en una buena tarifa.', pageWidth / 2, yPos + 25, { align: 'center' });
                    
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Seguiremos estudiando el mercado y te avisaremos cuando', pageWidth / 2, yPos + 38, { align: 'center' });
                    doc.text('encontremos alguna tarifa que se adapte a tu perfil de consumo.', pageWidth / 2, yPos + 45, { align: 'center' });
                    
                    yPos += 67;
                }
                
                // === DOS COLUMNAS COMPACTAS === (Solo si hay ahorro)
                if (res.savings > 0) {
                const colWidthResumen = (contentWidth - 20) / 2;
                
                // COLUMNA IZQUIERDA - TU FACTURA ACTUAL
                const leftXResumen = margin + 10;
                
                doc.setTextColor(140, 150, 160);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('TU FACTURA ACTUAL'), leftXResumen + colWidthResumen / 2, yPos, { align: 'center' });
                
                // Precio periodo (mensual estimado) tachado en rojo
                const diasPeriodo = res.dias_facturados || 30;
                const precioMensualEstimado = (res.originalBillAnnual / 365) * 30;
                const oldPrice = `${eur(precioMensualEstimado)}/mes`;
                doc.setTextColor(...redColor);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                const oldX = leftXResumen + colWidthResumen / 2;
                const oldY = yPos + 12;
                doc.text(oldPrice, oldX, oldY, { align: 'center' });
                
                // LÃ­nea tachada
                const oldWidth = doc.getTextWidth(oldPrice);
                doc.setDrawColor(...redColor);
                doc.setLineWidth(1.5);
                doc.line(oldX - oldWidth/2 - 2, oldY - 3, oldX + oldWidth/2 + 2, oldY - 3);
                
                // "Total Periodo"
                doc.setTextColor(140, 150, 160);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.text(`Total Periodo (${diasPeriodo} dÃ­as)`, leftXResumen + colWidthResumen / 2, yPos + 19, { align: 'center' });
                
                // Precio anual tachado
                const oldAnnual = eur(res.originalBillAnnual);
                doc.setTextColor(...redColor);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                const oldAnnualX = leftXResumen + colWidthResumen / 2;
                const oldAnnualY = yPos + 32;
                doc.text(`${oldAnnual}/aÃ±o`, oldAnnualX, oldAnnualY, { align: 'center' });
                
                // LÃ­nea tachada
                const oldAnnualWidth = doc.getTextWidth(`${oldAnnual}/aÃ±o`);
                doc.setDrawColor(...redColor);
                doc.setLineWidth(1.5);
                doc.line(oldAnnualX - oldAnnualWidth/2 - 2, oldAnnualY - 3, oldAnnualX + oldAnnualWidth/2 + 2, oldAnnualY - 3);
                
                // SEPARADOR VERTICAL
                doc.setDrawColor(220, 220, 220);
                doc.setLineWidth(0.3);
                doc.line(pageWidth / 2, yPos - 5, pageWidth / 2, yPos + 38);
                
                // COLUMNA DERECHA - TU NUEVO COSTE
                const rightXResumen = margin + 10 + colWidthResumen + 10;
                
                doc.setTextColor(...primaryColor);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                const newLabel = `TU NUEVO COSTE ${brandName}`;
                doc.text(newLabel, rightXResumen + colWidthResumen / 2, yPos, { align: 'center' });
                
                // Precio mensual en azul
                doc.setTextColor(...primaryColor);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(`${eur(res.totalAnnual / 12)}/mes`, rightXResumen + colWidthResumen / 2, yPos + 13, { align: 'center' });
                
                // "Estimado Mensual"
                doc.setTextColor(140, 150, 160);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.text(tr('Estimado Mensual'), rightXResumen + colWidthResumen / 2, yPos + 19, { align: 'center' });
                
                // Precio anual en azul
                doc.setTextColor(...primaryColor);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text(`${eur(res.totalAnnual)}/aÃ±o`, rightXResumen + colWidthResumen / 2, yPos + 32, { align: 'center' });
                
                yPos += 50;
                } // Fin del condicional de columnas de precios en Individual
                
                // === ANÃLISIS DE HORARIOS Y CONSUMO (Solo 2.0TD) ===
                if (tariffType === '2.0TD' && res.energyCosts && res.energyCosts.length >= 3 && !res.isMulti) {
                    const puntaKwh = res.energyCosts[0].kwh || 0;
                    const llanoKwh = res.energyCosts[1].kwh || 0;
                    const valleKwh = res.energyCosts[2].kwh || 0;
                    const totalKwh = puntaKwh + llanoKwh + valleKwh;
                    
                    const puntaPct = totalKwh > 0 ? (puntaKwh / totalKwh * 100).toFixed(1) : 0;
                    const llanoPct = totalKwh > 0 ? (llanoKwh / totalKwh * 100).toFixed(1) : 0;
                    const vallePct = totalKwh > 0 ? (valleKwh / totalKwh * 100).toFixed(1) : 0;
                    
                    // Verificar espacio disponible (necesitamos ~85mm)
                    if (yPos > 210) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    // TÃ­tulo de la secciÃ³n con fondo VERDE y letras BLANCAS
                    doc.setFillColor(...greenColor); // VERDE
                    doc.roundedRect(margin, yPos, contentWidth, 10, 3, 3, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('AnÃ¡lisis de Horarios y Consumo - Tarifa 2.0 TD'), margin + 5, yPos + 6.5);
                    yPos += 12;
                    
                    // === TARJETAS DE HORARIOS ===
                    const cardWidth = (contentWidth - 6) / 2;
                    const cardHeight = 32;
                    const cardX1 = margin;
                    const cardX2 = margin + cardWidth + 6;
                    
                    // Tarjeta 1: Lunes a viernes laborables
                    doc.setFillColor(255, 255, 255);
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.3);
                    doc.roundedRect(cardX1, yPos, cardWidth, cardHeight, 2, 2, 'FD');
                    
                    doc.setTextColor(60, 60, 60);
                    doc.setFontSize(8.5);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('Lunes a viernes laborables'), cardX1 + cardWidth / 2, yPos + 5, { align: 'center' });
                    
                    // Periodos
                    let cardY = yPos + 10;
                    doc.setFontSize(7);
                    
                    // Punta (rojo)
                    doc.setFillColor(254, 242, 242);
                    doc.roundedRect(cardX1 + 3, cardY, cardWidth - 6, 5, 1, 1, 'F');
                    doc.setFillColor(220, 38, 38);
                    doc.circle(cardX1 + 5, cardY + 2.5, 1, 'F');
                    doc.setTextColor(153, 27, 27);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('Punta') + ':', cardX1 + 8, cardY + 3.5);
                    doc.setTextColor(71, 85, 105);
                    doc.setFont('helvetica', 'normal');
                    doc.text('10-14h, 18-22h', cardX1 + 22, cardY + 3.5);
                    cardY += 6;
                    
                    // Llano (amarillo)
                    doc.setFillColor(254, 252, 232);
                    doc.roundedRect(cardX1 + 3, cardY, cardWidth - 6, 5, 1, 1, 'F');
                    doc.setFillColor(250, 204, 21);
                    doc.circle(cardX1 + 5, cardY + 2.5, 1, 'F');
                    doc.setTextColor(161, 98, 7);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('Llano') + ':', cardX1 + 8, cardY + 3.5);
                    doc.setTextColor(71, 85, 105);
                    doc.setFont('helvetica', 'normal');
                    doc.text('8-10h, 14-18h, 22-24h', cardX1 + 22, cardY + 3.5);
                    cardY += 6;
                    
                    // Valle (verde)
                    doc.setFillColor(240, 253, 244);
                    doc.roundedRect(cardX1 + 3, cardY, cardWidth - 6, 5, 1, 1, 'F');
                    doc.setFillColor(22, 163, 74);
                    doc.circle(cardX1 + 5, cardY + 2.5, 1, 'F');
                    doc.setTextColor(22, 101, 52);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('Valle') + ':', cardX1 + 8, cardY + 3.5);
                    doc.setTextColor(71, 85, 105);
                    doc.setFont('helvetica', 'normal');
                    doc.text('0-8h', cardX1 + 22, cardY + 3.5);
                    
                    // Tarjeta 2: SÃ¡bados, domingos y festivos
                    doc.setFillColor(255, 255, 255);
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.3);
                    doc.roundedRect(cardX2, yPos, cardWidth, cardHeight, 2, 2, 'FD');
                    
                    doc.setTextColor(60, 60, 60);
                    doc.setFontSize(8.5);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('SÃ¡bados, domingos y festivos'), cardX2 + cardWidth / 2, yPos + 5, { align: 'center' });
                    
                    // Valle todo el dÃ­a
                    const valleBoxY = yPos + 12;
                    doc.setFillColor(240, 253, 244);
                    doc.roundedRect(cardX2 + 8, valleBoxY, cardWidth - 16, 16, 2, 2, 'F');
                    doc.setFillColor(22, 163, 74);
                    doc.circle(cardX2 + cardWidth / 2 - 8, valleBoxY + 5.5, 1.5, 'F');
                    doc.setTextColor(22, 101, 52);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('Valle'), cardX2 + cardWidth / 2 + 2, valleBoxY + 6, { align: 'center' });
                    doc.setTextColor(71, 85, 105);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'normal');
                    doc.text('24 horas (todo el dÃ­a)', cardX2 + cardWidth / 2, valleBoxY + 12, { align: 'center' });
                    
                    yPos += cardHeight + 8;
                    
                    // === DISTRIBUCIÃ“N DE CONSUMO ===
                    // TÃ­tulo con fondo VERDE y letras BLANCAS
                    doc.setFillColor(...greenColor); // VERDE
                    doc.roundedRect(margin, yPos, contentWidth, 8, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('Tu DistribuciÃ³n de Consumo'), margin + 5, yPos + 5.5);
                    yPos += 10;
                    
                    // Caja blanca para las tarjetas
                    doc.setFillColor(255, 255, 255);
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.3);
                    const consumoBoxHeight = 28;
                    doc.roundedRect(margin, yPos, contentWidth, consumoBoxHeight, 2, 2, 'FD');
                    
                    // Tres tarjetas de periodos
                    const periodoCardWidth = (contentWidth - 12) / 3;
                    const periodoCardX1 = margin + 3;
                    const periodoCardX2 = periodoCardX1 + periodoCardWidth + 3;
                    const periodoCardX3 = periodoCardX2 + periodoCardWidth + 3;
                    const periodoCardY = yPos + 3;
                    const periodoCardHeight = 22;
                    
                    // Punta (rojo)
                    doc.setFillColor(254, 242, 242);
                    doc.setDrawColor(252, 165, 165);
                    doc.setLineWidth(0.5);
                    doc.roundedRect(periodoCardX1, periodoCardY, periodoCardWidth, periodoCardHeight, 2, 2, 'FD');
                    
                    doc.setFillColor(220, 38, 38);
                    doc.circle(periodoCardX1 + periodoCardWidth / 2 - 8, periodoCardY + 3, 1.2, 'F');
                    doc.setTextColor(153, 27, 27);
                    doc.setFontSize(6.5);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('Periodo Punta'), periodoCardX1 + periodoCardWidth / 2 + 2, periodoCardY + 3.5, { align: 'center' });
                    
                    doc.setTextColor(220, 38, 38);
                    doc.setFontSize(13);
                    doc.text(puntaPct + '%', periodoCardX1 + periodoCardWidth / 2, periodoCardY + 10, { align: 'center' });
                    
                    doc.setTextColor(100, 116, 139);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'normal');
                    doc.text(puntaKwh.toFixed(0) + ' kWh', periodoCardX1 + periodoCardWidth / 2, periodoCardY + 14, { align: 'center' });
                    
                    doc.setFillColor(255, 255, 255);
                    doc.roundedRect(periodoCardX1 + 2, periodoCardY + 16, periodoCardWidth - 4, 4.5, 1, 1, 'F');
                    doc.setTextColor(100, 116, 139);
                    doc.setFontSize(4.5);
                    doc.text(tr('Horario mÃ¡s caro'), periodoCardX1 + periodoCardWidth / 2, periodoCardY + 18.5, { align: 'center' });
                    doc.text('10-14h, 18-22h (lab.)', periodoCardX1 + periodoCardWidth / 2, periodoCardY + 20, { align: 'center' });
                    
                    // Llano (amarillo)
                    doc.setFillColor(254, 252, 232);
                    doc.setDrawColor(253, 224, 71);
                    doc.setLineWidth(0.5);
                    doc.roundedRect(periodoCardX2, periodoCardY, periodoCardWidth, periodoCardHeight, 2, 2, 'FD');
                    
                    doc.setFillColor(250, 204, 21);
                    doc.circle(periodoCardX2 + periodoCardWidth / 2 - 8, periodoCardY + 3, 1.2, 'F');
                    doc.setTextColor(161, 98, 7);
                    doc.setFontSize(6.5);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('Periodo Llano'), periodoCardX2 + periodoCardWidth / 2 + 2, periodoCardY + 3.5, { align: 'center' });
                    
                    doc.setTextColor(202, 138, 4);
                    doc.setFontSize(13);
                    doc.text(llanoPct + '%', periodoCardX2 + periodoCardWidth / 2, periodoCardY + 10, { align: 'center' });
                    
                    doc.setTextColor(100, 116, 139);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'normal');
                    doc.text(llanoKwh.toFixed(0) + ' kWh', periodoCardX2 + periodoCardWidth / 2, periodoCardY + 14, { align: 'center' });
                    
                    doc.setFillColor(255, 255, 255);
                    doc.roundedRect(periodoCardX2 + 2, periodoCardY + 16, periodoCardWidth - 4, 4.5, 1, 1, 'F');
                    doc.setTextColor(100, 116, 139);
                    doc.setFontSize(4.5);
                    doc.text(tr('Precio medio'), periodoCardX2 + periodoCardWidth / 2, periodoCardY + 18.5, { align: 'center' });
                    doc.text('8-10h, 14-18h, 22-24h', periodoCardX2 + periodoCardWidth / 2, periodoCardY + 20, { align: 'center' });
                    
                    // Valle (verde)
                    doc.setFillColor(240, 253, 244);
                    doc.setDrawColor(187, 247, 208);
                    doc.setLineWidth(0.5);
                    doc.roundedRect(periodoCardX3, periodoCardY, periodoCardWidth, periodoCardHeight, 2, 2, 'FD');
                    
                    doc.setFillColor(22, 163, 74);
                    doc.circle(periodoCardX3 + periodoCardWidth / 2 - 8, periodoCardY + 3, 1.2, 'F');
                    doc.setTextColor(22, 101, 52);
                    doc.setFontSize(6.5);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('Periodo Valle'), periodoCardX3 + periodoCardWidth / 2 + 2, periodoCardY + 3.5, { align: 'center' });
                    
                    doc.setTextColor(22, 163, 74);
                    doc.setFontSize(13);
                    doc.text(vallePct + '%', periodoCardX3 + periodoCardWidth / 2, periodoCardY + 10, { align: 'center' });
                    
                    doc.setTextColor(100, 116, 139);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'normal');
                    doc.text(valleKwh.toFixed(0) + ' kWh', periodoCardX3 + periodoCardWidth / 2, periodoCardY + 14, { align: 'center' });
                    
                    doc.setFillColor(255, 255, 255);
                    doc.roundedRect(periodoCardX3 + 2, periodoCardY + 16, periodoCardWidth - 4, 4.5, 1, 1, 'F');
                    doc.setTextColor(100, 116, 139);
                    doc.setFontSize(4.5);
                    doc.text(tr('Horario mÃ¡s barato'), periodoCardX3 + periodoCardWidth / 2, periodoCardY + 18.5, { align: 'center' });
                    doc.text('0-8h + fines semana', periodoCardX3 + periodoCardWidth / 2, periodoCardY + 20, { align: 'center' });
                    
                    yPos += consumoBoxHeight + 2;
                    
                    // Barra de progreso
                    const barHeight = 5;
                    const barY = yPos;
                    
                    // Calcular anchos proporcionales
                    const puntaWidth = (puntaPct / 100) * contentWidth;
                    const llanoWidth = (llanoPct / 100) * contentWidth;
                    const valleWidth = (vallePct / 100) * contentWidth;
                    
                    // Punta (rojo)
                    doc.setFillColor(220, 38, 38);
                    doc.roundedRect(margin, barY, puntaWidth, barHeight, 1, 1, 'F');
                    if (puntaPct > 8) {
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(6.5);
                        doc.setFont('helvetica', 'bold');
                        doc.text(puntaPct + '%', margin + puntaWidth / 2, barY + 3.8, { align: 'center' });
                    }
                    
                    // Llano (amarillo)
                    doc.setFillColor(250, 204, 21);
                    doc.rect(margin + puntaWidth, barY, llanoWidth, barHeight, 'F');
                    if (llanoPct > 8) {
                        doc.setTextColor(30, 41, 59);
                        doc.setFontSize(6.5);
                        doc.setFont('helvetica', 'bold');
                        doc.text(llanoPct + '%', margin + puntaWidth + llanoWidth / 2, barY + 3.8, { align: 'center' });
                    }
                    
                    // Valle (verde)
                    doc.setFillColor(22, 163, 74);
                    doc.roundedRect(margin + puntaWidth + llanoWidth, barY, valleWidth, barHeight, 1, 1, 'F');
                    if (vallePct > 8) {
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(6.5);
                        doc.setFont('helvetica', 'bold');
                        doc.text(vallePct + '%', margin + puntaWidth + llanoWidth + valleWidth / 2, barY + 3.8, { align: 'center' });
                    }
                    
                    yPos += barHeight + 3;
                    
                    // RecomendaciÃ³n
                    let recomendacion = '';
                    if (puntaPct > 30) {
                        recomendacion = tr('Consumes mÃ¡s del 30% en horario Punta. Te recomendamos trasladar consumos al periodo Valle (madrugada y fines de semana) para maximizar tu ahorro.');
                    } else if (vallePct > 50) {
                        recomendacion = tr('Â¡Excelente! MÃ¡s del 50% de tu consumo estÃ¡ en Valle, el periodo mÃ¡s econÃ³mico. Sigue asÃ­ para maximizar tu ahorro.');
                    } else {
                        recomendacion = tr('Tu consumo estÃ¡ bien distribuido. Considera trasladar mÃ¡s consumo al periodo Valle para aumentar tu ahorro.');
                    }
                    
                    doc.setFillColor(239, 246, 255);
                    doc.setDrawColor(2, 132, 199);
                    doc.setLineWidth(1);
                    const recoBoxHeight = 11;
                    doc.rect(margin, yPos, 3, recoBoxHeight, 'F'); // LÃ­nea lateral izquierda
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.3);
                    doc.roundedRect(margin, yPos, contentWidth, recoBoxHeight, 2, 2, 'FD');
                    
                    doc.setTextColor(12, 74, 110);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('RecomendaciÃ³n Personalizada'), margin + 5, yPos + 4);
                    
                    doc.setTextColor(51, 65, 85);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'normal');
                    const recoLines = doc.splitTextToSize(recomendacion, contentWidth - 10);
                    doc.text(recoLines, margin + 5, yPos + 8);
                    
                    yPos += recoBoxHeight + 5;
                }
                
                // === NUEVA PÃGINA PARA PRECIOS Y DESGLOSE ===
                // Crear nueva pÃ¡gina ANTES de dibujar precios de la oferta
                doc.addPage();
                yPos = 20;
                
                // === PRECIOS DE LA OFERTA EN PÃGINA 2 ===
                if (!res.isMulti) {
                    // Titulo con fondo VERDE
                    doc.setFillColor(...greenColor); // VERDE
                    doc.roundedRect(margin, yPos, contentWidth, 10, 3, 3, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    // Mostrar Comercializadora - Tarifa completa
                    // Si description existe y es diferente de name, usar "Comercializadora - DescripciÃ³n"
                    // Si no, solo mostrar el nombre
                    const fullOfferTitle = (tarifaCompleta !== comercializadora) 
                        ? `${comercializadora} - ${tarifaCompleta}` 
                        : comercializadora;
                    doc.text(`PRECIOS DE LA OFERTA: ${fullOfferTitle}`, margin + 5, yPos + 6.5);
                    yPos += 12;
                    
                    // Caja con FONDO AZUL OSCURO y BORDE BLANCO
                    doc.setFillColor(...darkColor);
                    doc.setDrawColor(255, 255, 255);
                    doc.setLineWidth(3);
                    const priceBoxHeight = tariffType === '2.0TD' ? 40 : 75;
                    doc.roundedRect(margin, yPos, contentWidth, priceBoxHeight, 3, 3, 'FD');
                    
                    // POTENCIA (texto blanco)
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('POTENCIA:'), margin + 5, yPos + 6);
                    yPos += 9;
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    
                    if (tariffType === '2.0TD') {
                        const p1 = offer.p_potencia_1 / 365;
                        const p2 = offer.p_potencia_2 / 365;
                        doc.text(`P1 (â‚¬/kW/dia):`, margin + 8, yPos);
                        doc.text(numPriceFormula(p1), pageWidth - margin - 8, yPos, { align: 'right' });
                        yPos += 5;
                        doc.text(`P2 (â‚¬/kW/dia):`, margin + 8, yPos);
                        doc.text(numPriceFormula(p2), pageWidth - margin - 8, yPos, { align: 'right' });
                        yPos += 7;
                    } else {
                        for (let i = 1; i <= 6; i++) {
                            const pDay = (offer[`p_potencia_${i}`] || 0) / 365;
                            doc.text(`P${i} (â‚¬/kW/dia):`, margin + 8, yPos);
                            doc.text(numPriceFormula(pDay), pageWidth - margin - 8, yPos, { align: 'right' });
                            yPos += 4.5;
                        }
                        yPos += 3;
                    }
                    
                    // ENERGIA (texto blanco)
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('ENERGIA:'), margin + 5, yPos);
                    yPos += 5;
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    
                    if (tariffType === '2.0TD') {
                        doc.text(`E1 - ${tr('Punta')} (â‚¬/kWh):`, margin + 8, yPos);
                        doc.text(numPriceFormula(offer.p1_price), pageWidth - margin - 8, yPos, { align: 'right' });
                        yPos += 5;
                        doc.text(`E2 - ${tr('Llano')} (â‚¬/kWh):`, margin + 8, yPos);
                        doc.text(numPriceFormula(offer.p2_price), pageWidth - margin - 8, yPos, { align: 'right' });
                        yPos += 5;
                        doc.text(`E3 - ${tr('Valle')} (â‚¬/kWh):`, margin + 8, yPos);
                        doc.text(numPriceFormula(offer.p3_price), pageWidth - margin - 8, yPos, { align: 'right' });
                        yPos += 7;
                    } else {
                        for (let i = 1; i <= 6; i++) {
                            doc.text(`E${i} (â‚¬/kWh):`, margin + 8, yPos);
                            doc.text(numPriceFormula(offer[`p${i}_price`] || 0), pageWidth - margin - 8, yPos, { align: 'right' });
                            yPos += 4.5;
                        }
                        yPos += 5;
                    }
                }
                
                // === DESGLOSE DETALLADO ===
                if (!res.isMulti) {
                    // TÃ­tulo del desglose (ahora en pÃ¡gina 2) - VERDE
                    doc.setFillColor(...greenColor); // VERDE
                    doc.roundedRect(margin, yPos, contentWidth, 10, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    // Mostrar Comercializadora - Tarifa completa
                    // Si description existe y es diferente de name, usar "Comercializadora - DescripciÃ³n"
                    // Si no, solo mostrar el nombre
                    const fullDesgloseTitle = (tarifaCompleta !== comercializadora) 
                        ? `${comercializadora} - ${tarifaCompleta}` 
                        : comercializadora;
                    doc.text(`${tr('DESGLOSE DETALLADO DE LA SIMULACIÃ“N')} (${fullDesgloseTitle})`, margin + 3, yPos + 6.5);
                    
                    yPos += 14;
                    
                    // === TÃ‰RMINO POTENCIA ===
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text('TÃ‰RMINO POTENCIA (Precio en â‚¬/kW DÃ­a)', margin, yPos);
                    yPos += 6;
                    
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    
                    res.powerCosts.forEach((p, idx) => {
                        if (p.kw > 0 || p.period <= config.powerPeriods) {
                            const formula = `P${p.period} (${num(p.kw, 2)} kW x ${res.dias_facturados}d x ${numPriceFormula(p.priceDay)})`;
                            doc.text(formula, margin + 2, yPos);
                            doc.text(`${num(p.cost, 2)} â‚¬`, pageWidth - margin - 2, yPos, { align: 'right' });
                            yPos += 5;
                        }
                    });
                    
                    // Subtotal potencia
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...primaryColor);
                    doc.text(tr('SUBTOTAL POTENCIA'), margin + 2, yPos);
                    doc.text(`${num(res.subPower, 2)} â‚¬`, pageWidth - margin - 2, yPos, { align: 'right' });
                    yPos += 8;
                    
                    // === TÃ‰RMINO ENERGÃA ===
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text('TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)', margin, yPos);
                    yPos += 6;
                    
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    
                    res.energyCosts.forEach((e, idx) => {
                        if (e.kwh > 0 || e.period <= config.periods) {
                            let label = `E${e.period}`;
                            if (tariffType === '2.0TD') {
                                if (e.period === 1) label += ` - ${tr('Punta')}`;
                                if (e.period === 2) label += ` - ${tr('Llano')}`;
                                if (e.period === 3) label += ` - ${tr('Valle')}`;
                            }
                            const formula = `${label} (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)})`;
                            doc.text(formula, margin + 2, yPos);
                            doc.text(`${num(e.cost, 2)} â‚¬`, pageWidth - margin - 2, yPos, { align: 'right' });
                            yPos += 5;
                        }
                    });
                    
                    // Subtotal energÃ­a bruto
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(80, 80, 80);
                    doc.text('Subtotal EnergÃ­a (Bruto)', margin + 2, yPos);
                    doc.text(`${num(res.subEnergy, 2)} â‚¬`, pageWidth - margin - 2, yPos, { align: 'right' });
                    yPos += 5;
                    
                    // Descuento si existe
                    if (res.discountAmount > 0) {
                        doc.setTextColor(...redColor);
                        doc.text(`Descuento Aplicado (${num(res.discountRate * 100, 0)}%)`, margin + 2, yPos);
                        doc.text(`-${num(res.discountAmount, 2)} â‚¬`, pageWidth - margin - 2, yPos, { align: 'right' });
                        yPos += 5;
                        
                        doc.setTextColor(0, 0, 0);
                        doc.text('Subtotal EnergÃ­a (Neto)', margin + 2, yPos);
                        doc.text(`${num(res.subEnergyNet, 2)} â‚¬`, pageWidth - margin - 2, yPos, { align: 'right' });
                        yPos += 5;
                    }
                    
                    yPos += 3;
                    
                    // === TOTALES ===
                    // LÃ­nea separadora
                    doc.setDrawColor(150, 150, 150);
                    doc.setLineWidth(0.3);
                    doc.line(margin, yPos, pageWidth - margin, yPos);
                    yPos += 5;
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(9);
                    
                    // Subtotal base
                    doc.text('SUBTOTAL BASE (P+E)', margin + 2, yPos);
                    doc.text(`${num(res.subBase, 2)} â‚¬`, pageWidth - margin - 2, yPos, { align: 'right' });
                    yPos += 5;
                    
                    // Impuesto elÃ©ctrico
                    doc.setFont('helvetica', 'normal');
                    doc.text(`${tr('Imp. ElÃ©c.')} (${num(res.ieRate * 100, 3)}%)`, margin + 2, yPos);
                    doc.text(`${num(res.costIE, 2)} â‚¬`, pageWidth - margin - 2, yPos, { align: 'right' });
                    yPos += 5;
                    
                    // Base imponible
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    doc.text(tr('BASE IMPONIBLE'), margin + 2, yPos);
                    doc.text(`${num(res.baseImp, 2)} â‚¬`, pageWidth - margin - 2, yPos, { align: 'right' });
                    yPos += 5;
                    
                    // IVA
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                    doc.text(tr('IVA (21%)'), margin + 2, yPos);
                    doc.text(`${num(res.costIVA, 2)} â‚¬`, pageWidth - margin - 2, yPos, { align: 'right' });
                    yPos += 7;
                    
                    // TOTAL FACTURA
                    doc.setFillColor(...darkColor);
                    doc.roundedRect(margin, yPos, contentWidth, 10, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`TOTAL FACTURA (${res.dias_facturados} DÃAS)`, margin + 3, yPos + 6.5);
                    doc.text(eur(res.totalPeriod), pageWidth - margin - 3, yPos + 6.5, { align: 'right' });
                    yPos += 14;
                    
                    // Total aÃ±o
                    doc.setTextColor(...primaryColor);
                    doc.setFontSize(10);
                    doc.text(tr('TOTAL AÃ‘O (PROYECTADO)'), margin + 2, yPos);
                    doc.text(eur(res.totalAnnual), pageWidth - margin - 2, yPos, { align: 'right' });
                    yPos += 8;
                }
                
                } // FIN del else - cierre de seccion individual
                
                // === RESUMEN DE AHORRO FINAL (COMÃšN PARA INDIVIDUAL Y MULTICUPS) ===
                if (yPos > 240) {
                    doc.addPage();
                    yPos = 20;
                } else {
                    yPos += 15; // Espacio antes de la caja verde (para que no se solape con tarifas consolidadas)
                }
                
                doc.setFillColor(...redColor); // ROJO
                doc.roundedRect(margin, yPos, contentWidth, 16, 3, 3, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('TU AHORRO ANUAL ESTIMADO ES:'), margin + 5, yPos + 6);
                
                doc.setFontSize(22);
                doc.text(`${savingsText} ${tr('/ AÃ‘O')}`, margin + 5, yPos + 14);
                
                yPos += 20; // Espacio despuÃ©s de la caja roja (reducido de 30 a 20)
                
                // === CUADRO DE FORMALIZACION CON FONDO AZUL OSCURO ===
                // Cuadro principal con FONDO AZUL OSCURO y BORDE BLANCO (altura reducida)
                doc.setDrawColor(255, 255, 255);
                doc.setLineWidth(3);
                doc.setFillColor(...darkColor);
                doc.roundedRect(margin, yPos, contentWidth, 48, 3, 3, 'FD');
                
                // Encabezado (texto blanco)
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('PARA FORMALIZAR ESTE CONTRATO:', margin + 5, yPos + 7);
                
                yPos += 11;
                
                // Instruccion principal (texto blanco)
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                if (res.isMulti) {
                    doc.text(tr('Responde a este email adjuntando la documentaciÃ³n de los') + ` ${res.individualResults.length} CUPS:`, margin + 5, yPos);
                } else {
                    doc.text(tr('Responde a este email adjuntando la siguiente documentaciÃ³n:'), margin + 5, yPos);
                }
                
                yPos += 5;
                
                // Lista de documentos (texto blanco)
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(255, 255, 255);
                
                const docs = [
                    '1. Foto del DNI/CIF (anverso y reverso)',
                    '2. Ultima factura (minimo 3 meses de antiguedad)',
                    '3. Email de contacto para validacion',
                    '4. Telefono de contacto',
                    '5. Numero de cuenta bancaria (IBAN)'
                ];
                
                docs.forEach((docItem, idx) => {
                    doc.text(docItem, margin + 8, yPos);
                    yPos += 4;
                });
                
                yPos += 1;
                
                // Separador (blanco)
                doc.setDrawColor(255, 255, 255);
                doc.setLineWidth(0.5);
                doc.line(margin + 5, yPos, pageWidth - margin - 5, yPos);
                yPos += 3;
                
                // Email de contacto destacado (texto blanco)
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text('Envia la documentacion al comercial:', margin + 5, yPos);
                yPos += 4;
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(13);
                doc.setFont('helvetica', 'bold');
                doc.text(commercialCode, margin + 5, yPos);
                
                yPos += 10;
                
                // === PIE DE PÃGINA ===
                const footerY = 280;
                doc.setDrawColor(...primaryColor);
                doc.setLineWidth(1.5);
                doc.line(margin, footerY, pageWidth - margin, footerY);
                
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.setFont('helvetica', 'normal');
                doc.text(`[Colaborador: ${commercialCode}] | Este resumen es una simulacion ${res.isMulti ? `consolidada de ${res.individualResults.length} suministros` : 'basada en su ultima factura'}.`, margin, footerY + 5);
                
                doc.setFontSize(7);
                doc.setTextColor(150, 150, 150);
                doc.text(`Generado el ${new Date().toLocaleDateString('es-ES')}`, pageWidth - margin - 35, footerY + 5);
                
                // === GUARDAR PDF ===
                const fileName = res.isMulti 
                    ? `Comparativa_MultiCups_${clientName.replace(/[^a-z0-9]/gi, '_')}_${Date.now()}.pdf`
                    : `Comparativa_${res.cups.substring(0, 10)}_${clientName.replace(/[^a-z0-9]/gi, '_')}_${Date.now()}.pdf`;
                
                doc.save(fileName);
                
                // Cerrar modal y mostrar Ã©xito
                hideErrorModal();
                window.showMessageModal(`âœ… Â¡PDF generado con Ã©xito!\n\nSe ha descargado: ${fileName}\n\nPuedes adjuntarlo directamente en el email para tu cliente.`);
                document.getElementById('send-offer-modal').classList.add('hidden');
                document.getElementById('send-offer-modal').classList.remove('flex');
                
                // NUEVO: Restaurar idioma chino si es necesario
                if (window._wasChineseBeforePDF === true) {
                    // Solo preguntar si el usuario ORIGINALMENTE estaba en chino
                    setTimeout(() => {
                        const userWantsChineseBack = confirm(
                            'âœ… PDFå·²ç”Ÿæˆï¼\n' +
                            'âœ… PDF generated!\n\n' +
                            'æ˜¯å¦è¦åˆ‡æ¢å›žä¸­æ–‡ï¼Ÿ\n' +
                            'Switch back to Chinese?\n\n' +
                            'ç‚¹å‡»"ç¡®å®š"åˆ‡æ¢å›žä¸­æ–‡\n' +
                            'Click OK to switch back to Chinese'
                        );
                        
                        if (userWantsChineseBack && window.LANG) {
                            console.log('ðŸ‡¨ðŸ‡³ Restaurando idioma chino');
                            window.LANG.change('zh', true);
                        }
                        
                        // Limpiar flag
                        window._wasChineseBeforePDF = false;
                    }, 500);
                }
                
            } catch (e) {
                console.error("Error al generar PDF:", e);
                window.showErrorModal(`Error al generar PDF: ${e.message}`);
            }
        }
        
        // --- GENERACIÃ“N DE HTML PARA COMPARACIÃ“N DUAL (FIJO VS INDEXADO) ---
        
        function generateDualStyledHtmlOffer(commercialCode, resFijo, resIndexed) {
            const brand = activeBrand;
            
            const eur = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
            
            // DETECCIÃ“N DE POWER CUP
            const isPowerCup = brand.NAME.includes('POWER');
            
            // Colores dinÃ¡micos
            const HEADER_BLUE = isPowerCup ? '#738257' : '#6B7D8E';
            const DRK_BLUE = isPowerCup ? '#84cc16' : '#0ea5e9';
            const GREEN_SAVE = '#16a34a';
            const RED_CTA = '#DC2626';
            const SLATE_DARK = isPowerCup ? '#5a6b47' : '#475569';
            const SLATE_MED = isPowerCup ? '#738257' : '#64748b';
            
            const BRAND_DISPLAY = isPowerCup ? 'POWER CUP' : 'DRK';
            
            const clientName = document.getElementById('client-name-input').value.trim() || '[NOMBRE COMPLETO CLIENTE]';
            const clientPhone = document.getElementById('client-phone-input').value.trim() || '[TELÃ‰FONO CLIENTE]';
            const clientAddress = document.getElementById('client-address-input').value.trim();
            const clientEmail = document.getElementById('client-email-input').value.trim() || '[EMAIL CLIENTE]';
            
            const ahorroFijo = resFijo.savings;
            const ahorroIndexado = resIndexed.savings;
            
            // Generar desglose de precios FIJO
            let preciosFijoHtml = '';
            preciosFijoHtml += '<div><strong>POTENCIA:</strong></div>';
            resFijo.powerCosts.forEach((p, i) => {
                if (p.kw > 0) {
                    preciosFijoHtml += `<div style="font-size: 9px;">P${i+1}: ${numPriceFormula(p.priceDay)} â‚¬/kW/dÃ­a</div>`;
                }
            });
            preciosFijoHtml += '<div style="margin-top: 4px;"><strong>ENERGÃA:</strong></div>';
            resFijo.energyCosts.forEach((e, i) => {
                if (e.kwh > 0) {
                    preciosFijoHtml += `<div style="font-size: 9px;">E${i+1}: ${numPriceFormula(e.price)} â‚¬/kWh</div>`;
                }
            });
            
            // Generar desglose de precios INDEXADO
            let preciosIndexadoHtml = '';
            preciosIndexadoHtml += '<div><strong>POTENCIA:</strong></div>';
            resIndexed.powerCosts.forEach((p, i) => {
                if (p.kw > 0) {
                    preciosIndexadoHtml += `<div style="font-size: 9px;">P${i+1}: ${numPriceFormula(p.priceDay)} â‚¬/kW/dÃ­a</div>`;
                }
            });
            preciosIndexadoHtml += '<div style="margin-top: 4px;"><strong>ENERGÃA:</strong></div>';
            resIndexed.energyCosts.forEach((e, i) => {
                if (e.kwh > 0) {
                    preciosIndexadoHtml += `<div style="font-size: 9px;">E${i+1}: ${numPriceFormula(e.price)} â‚¬/kWh</div>`;
                }
            });
            
            // Generar desglose detallado FIJO
            let detallesFijoHtml = '';
            resFijo.powerCosts.forEach((p, i) => {
                if (p.kw > 0) {
                    detallesFijoHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; color: #374151;">
                            <span>P${i+1}: (${num(p.kw, 2)} kW x ${numPriceFormula(p.priceDay)} â‚¬/kW/dÃ­a)</span>
                            <span style="font-weight: bold;">${num(p.cost, 2)} â‚¬</span>
                        </div>
                    `;
                }
            });
            
            let energiaFijoHtml = '';
            resFijo.energyCosts.forEach((e, i) => {
                if (e.kwh > 0) {
                    let label = `E${i+1}`;
                    if (resFijo.originalTariffType === '2.0TD') {
                        if (i === 0) label += ` (${tr('Punta')})`;
                        else if (i === 1) label += ` (${tr('Llano')})`;
                        else if (i === 2) label += ` (${tr('Valle')})`;
                    }
                    energiaFijoHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; color: #374151;">
                            <span>${label}: (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)} â‚¬/kWh)</span>
                            <span style="font-weight: bold;">${num(e.cost, 2)} â‚¬</span>
                        </div>
                    `;
                }
            });
            
            // Generar desglose detallado INDEXADO
            let detallesIndexadoHtml = '';
            resIndexed.powerCosts.forEach((p, i) => {
                if (p.kw > 0) {
                    detallesIndexadoHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; color: #374151;">
                            <span>P${i+1}: (${num(p.kw, 2)} kW x ${numPriceFormula(p.priceDay)} â‚¬/kW/dÃ­a)</span>
                            <span style="font-weight: bold;">${num(p.cost, 2)} â‚¬</span>
                        </div>
                    `;
                }
            });
            
            let energiaIndexadoHtml = '';
            resIndexed.energyCosts.forEach((e, i) => {
                if (e.kwh > 0) {
                    let label = `E${i+1}`;
                    if (resIndexed.originalTariffType === '2.0TD') {
                        if (i === 0) label += ' (Punta)';
                        else if (i === 1) label += ' (Llano)';
                        else if (i === 2) label += ' (Valle)';
                    }
                    energiaIndexadoHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; color: #374151;">
                            <span>${label}: (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)} â‚¬/kWh)</span>
                            <span style="font-weight: bold;">${num(e.cost, 2)} â‚¬</span>
                        </div>
                    `;
                }
            });
            
            // EMAIL BODY con precios detallados
            const LB = '%0A';
            const emailBody = `âœ… CONFIRMACIÃ“N DE ACEPTACIÃ“N DE OFERTA COMPARATIVA${LB}${LB}` +
                             `Estimado equipo de ${brand.NAME.toUpperCase()},${LB}${LB}` +
                             `Confirmo mi aceptaciÃ³n de la oferta energÃ©tica que detallo a continuaciÃ³n:${LB}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `ðŸ“‹ DATOS DEL SUMINISTRO${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `ðŸ”Œ CUPS: ${resFijo.cups}${LB}` +
                             `ðŸ“Š Tipo: ${resFijo.originalTariffType}${LB}` +
                             `ðŸ“… DÃ­as facturados: ${resFijo.dias_facturados}${LB}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `ðŸ’° COMPARACIÃ“N DE AHORROS${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `ðŸ’¼ Ahorro con Tarifa FIJA: ${eur(ahorroFijo)}${LB}` +
                             `   Nuevo Coste: ${eur(resFijo.totalAnnual / 12)}/mes (${eur(resFijo.totalAnnual)}/aÃ±o)${LB}${LB}` +
                             `âš¡ Ahorro con Tarifa INDEXADA: ${eur(ahorroIndexado)}${LB}` +
                             `   Nuevo Coste: ${eur(resIndexed.totalAnnual / 12)}/mes (${eur(resIndexed.totalAnnual)}/aÃ±o)${LB}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `ðŸ’¡ PRECIOS DETALLADOS${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `ðŸ“˜ OPCIÃ“N FIJA (${resFijo.offer.name}):${LB}` +
                             `   Potencia:${LB}` +
                             resFijo.powerCosts.map((p, i) => p.kw > 0 ? `   â€¢ P${i+1}: ${numPriceFormula(p.priceDay)} â‚¬/kW/dÃ­a${LB}` : '').join('') +
                             `${LB}   EnergÃ­a:${LB}` +
                             resFijo.energyCosts.map((e, i) => e.kwh > 0 ? `   â€¢ E${i+1}: ${numPriceFormula(e.price)} â‚¬/kWh${LB}` : '').join('') +
                             `${LB}ðŸ“— OPCIÃ“N INDEXADA (${resIndexed.offer.name}):${LB}` +
                             `   Potencia:${LB}` +
                             resIndexed.powerCosts.map((p, i) => p.kw > 0 ? `   â€¢ P${i+1}: ${numPriceFormula(p.priceDay)} â‚¬/kW/dÃ­a${LB}` : '').join('') +
                             `${LB}   EnergÃ­a:${LB}` +
                             resIndexed.energyCosts.map((e, i) => e.kwh > 0 ? `   â€¢ E${i+1}: ${numPriceFormula(e.price)} â‚¬/kWh${LB}` : '').join('') +
                             `${LB}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `âœ… MI DECISIÃ“N (Marca con X):${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `[ ] ACEPTO TARIFA FIJA${LB}` +
                             `    Ahorro: ${eur(ahorroFijo)}${LB}` +
                             `    Coste mensual: ${eur(resFijo.totalAnnual / 12)}${LB}${LB}` +
                             `[ ] ACEPTO TARIFA INDEXADA${LB}` +
                             `    Ahorro: ${eur(ahorroIndexado)}${LB}` +
                             `    Coste mensual: ${eur(resIndexed.totalAnnual / 12)}${LB}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `ðŸ‘¤ DATOS DEL TITULAR${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `ðŸ“› Nombre: ${clientName}${LB}` +
                             `ðŸ“± TelÃ©fono: ${clientPhone}${LB}` +
                             `ðŸ“§ Email: ${clientEmail}${LB}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `ðŸ“Ž DOCUMENTACIÃ“N ADJUNTA${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `âœ“ DNI/CIF (anverso y reverso)${LB}` +
                             `âœ“ Ãšltima factura${LB}` +
                             `âœ“ Email Â· TelÃ©fono Â· IBAN${LB}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `Quedo a la espera de confirmaciÃ³n.${LB}${LB}` +
                             `Atentamente,${LB}${clientName}${LB}` +
                             (clientAddress ? `${tr('DirecciÃ³n:')}: ${clientAddress}${LB}` : '') +
                             `${LB}Comercial: ${commercialCode}`;
            
            const subject = `âœ… FORMALIZACIÃ“N - ${resFijo.cups} - ${brand.NAME.toUpperCase()}`;
            const formalizationRecipients = 'f.araujo@drk.es,r.guerra@drk.es,s.caballero@drk.es';
            const formalizationLink = `mailto:${formalizationRecipients}?subject=${encodeURIComponent(subject)}&body=${emailBody}`;
            
            return `
                <div style="max-width: 900px; margin: 0 auto; font-family: Arial, sans-serif; background-color: #f8f9fa; padding: 20px;">
                    
                    <!-- HEADER ESTILO PDF -->
                    ${isPowerCup ? `
                        <!-- POWER CUP Header -->
                        <div style="border: 3px solid #84cc16; background-color: white; padding: 25px 30px; border-radius: 8px; margin-bottom: 20px;">
                            <table cellpadding="0" cellspacing="0" width="100%">
                                <tr>
                                    <td style="width: 50%; vertical-align: middle;">
                                        <h1 style="color: #3f6212; font-size: 42px; font-weight: bold; margin: 0; letter-spacing: -1px;">POWER CUP</h1>
                                        <p style="color: #65a30d; font-size: 16px; margin: 8px 0 0 0; font-weight: 600;">AsesorÃ­a EnergÃ©tica</p>
                                    </td>
                                    <td style="width: 50%; text-align: right; vertical-align: middle;">
                                        <p style="color: #84cc16; font-size: 13px; margin: 0 0 5px 0; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px;">ESTUDIO DE AHORRO</p>
                                        <p style="color: #3f6212; font-size: 18px; margin: 0; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    ` : `
                        <!-- DRK Header -->
                        <div style="background-color: #2e5266; padding: 25px 30px; border-radius: 8px; margin-bottom: 20px;">
                            <table cellpadding="0" cellspacing="0" width="100%">
                                <tr>
                                    <td style="width: 50%; vertical-align: middle;">
                                        <h1 style="color: white; font-size: 42px; font-weight: bold; margin: 0; letter-spacing: -1px;">DRK ENERGÃA</h1>
                                        <p style="color: rgba(255,255,255,0.9); font-size: 16px; margin: 8px 0 0 0;">Liderando el ahorro y la eficiencia energÃ©tica.</p>
                                    </td>
                                    <td style="width: 50%; text-align: right; vertical-align: middle;">
                                        <p style="color: rgba(255,255,255,0.8); font-size: 13px; margin: 0 0 5px 0; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px;">ESTUDIO DE AHORRO</p>
                                        <p style="color: white; font-size: 18px; margin: 0; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    `}
                    
                    <!-- CAJA PRINCIPAL -->
                    <div style="background-color: white; padding: 30px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="background-color: ${HEADER_BLUE}; color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 25px;">
                            <p style="margin: 0 0 8px 0; font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9;"${tr("LA MEJOR OPCIÃ“N PARA TI ES")}</p>
                            <h2 style="margin: 0; font-size: 32px; font-weight: bold;">${BRAND_DISPLAY}</h2>
                            <p style="margin: 8px 0 0 0; font-size: 12px; opacity: 0.95;">${tr('Ofrece el mayor ahorro consolidado con')} ${brand.NAME.toUpperCase()}.</p>
                        </div>
                        
                        <!-- TRES COLUMNAS -->
                        <table cellpadding="0" cellspacing="0" width="100%" style="margin-bottom: 20px;">
                            <tr>
                                <!-- FACTURA ACTUAL -->
                                <td style="width: 30%; vertical-align: top; text-align: center; padding: 0 10px;">
                                    <div style="padding: 15px; border-right: 1px solid #e5e7eb;">
                                        <p style="margin: 0 0 8px 0; font-size: 10px; color: #6b7280; font-weight: 600; text-transform: uppercase;"${tr("TU FACTURA ACTUAL")}</p>
                                        <div style="margin: 10px 0;">
                                            <p style="margin: 0; font-size: 20px; font-weight: bold; color: ${RED_CTA}; text-decoration: line-through;">${eur(resFijo.originalBillPeriod)}</p>
                                            <p style="margin: 3px 0 0 0; font-size: 9px; color: #9ca3af;"${tr("Total Periodo")}</p>
                                        </div>
                                        <div style="margin-top: 12px;">
                                            <p style="margin: 0; font-size: 20px; font-weight: bold; color: ${RED_CTA}; text-decoration: line-through;">${eur(resFijo.originalBillAnnual)}${tr("/aÃ±o")}</p>
                                        </div>
                                    </div>
                                </td>
                                
                                <!-- AHORRO FIJO -->
                                <td style="width: 35%; vertical-align: top; text-align: center; padding: 0 10px;">
                                    <div style="background-color: ${DRK_BLUE}; color: white; padding: 10px 8px; border-radius: 8px 8px 0 0;">
                                        <p style="margin: 0; font-size: 9px; font-weight: bold; text-transform: uppercase;">${tr("TU AHORRO ANUAL FIJO")}</p>
                                    </div>
                                    <div style="padding: 15px 10px;">
                                        <p style="margin: 0; font-size: 32px; font-weight: bold; color: ${GREEN_SAVE};">${eur(ahorroFijo)}</p>
                                        <div style="margin: 15px 0 0 0;">
                                            <p style="margin: 0 0 3px 0; font-size: 10px; color: #6b7280; font-weight: 600;">${tr('TU NUEVO COSTE')} ${BRAND_DISPLAY}</p>
                                            <p style="margin: 0; font-size: 22px; font-weight: bold; color: ${DRK_BLUE};">${eur(resFijo.totalAnnual / 12)}${tr("/mes")}</p>
                                            <p style="margin: 3px 0 0 0; font-size: 8px; color: #9ca3af;"${tr("Estimado Mensual")}</p>
                                            <p style="margin: 10px 0 0 0; font-size: 20px; font-weight: bold; color: ${DRK_BLUE};">${eur(resFijo.totalAnnual)}${tr("/aÃ±o")}</p>
                                        </div>
                                    </div>
                                </td>
                                
                                <!-- AHORRO INDEXADO -->
                                <td style="width: 35%; vertical-align: top; text-align: center; padding: 0 10px;">
                                    <div style="background-color: ${GREEN_SAVE}; color: white; padding: 10px 8px; border-radius: 8px 8px 0 0;">
                                        <p style="margin: 0; font-size: 9px; font-weight: bold; text-transform: uppercase;">${tr("TU AHORRO ANUAL INDEXADO")}</p>
                                    </div>
                                    <div style="padding: 15px 10px;">
                                        <p style="margin: 0; font-size: 32px; font-weight: bold; color: ${GREEN_SAVE};">${eur(ahorroIndexado)}</p>
                                        <div style="margin: 15px 0 0 0;">
                                            <p style="margin: 0 0 3px 0; font-size: 10px; color: #6b7280; font-weight: 600;">${tr('TU NUEVO COSTE')} ${BRAND_DISPLAY}</p>
                                            <p style="margin: 0; font-size: 22px; font-weight: bold; color: ${GREEN_SAVE};">${eur(resIndexed.totalAnnual / 12)}${tr("/mes")}</p>
                                            <p style="margin: 3px 0 0 0; font-size: 8px; color: #9ca3af;"${tr("Estimado Mensual")}</p>
                                            <p style="margin: 10px 0 0 0; font-size: 20px; font-weight: bold; color: ${GREEN_SAVE};">${eur(resIndexed.totalAnnual)}${tr("/aÃ±o")}</p>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- DESGLOSE DETALLADO -->
                    <div style="background-color: ${HEADER_BLUE}; color: white; padding: 12px 20px; margin: 25px 0 15px 0; border-radius: 12px; text-align: center;">
                        <div style="font-size: 14px; font-weight: bold; letter-spacing: 1px;">DESGLOSE DETALLADO POR SUMINISTRO</div>
                    </div>
                    
                    <table cellpadding="0" cellspacing="0" width="100%" style="margin-bottom: 30px;">
                        <tr>
                            <!-- COLUMNA FIJO -->
                            <td style="width: 48%; vertical-align: top; padding-right: 10px;">
                                <div style="border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; background-color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.07);">
                                    <div style="background-color: ${SLATE_DARK}; color: white; padding: 12px;">
                                        <div style="font-size: 10px; font-weight: bold; margin-bottom: 3px;">[${resFijo.cups}]</div>
                                        <div style="font-size: 9px; opacity: 0.9;">Tipo: ${resFijo.originalTariffType} | DÃ­as: ${resFijo.dias_facturados}</div>
                                        <div style="font-size: 9px; margin-top: 4px; opacity: 0.95;">${BRAND_DISPLAY} - ${resFijo.offer.name}</div>
                                    </div>
                                    
                                    <div style="background-color: ${SLATE_MED}; color: white; padding: 10px;">
                                        <div style="font-size: 10px; font-weight: bold; margin-bottom: 5px;">PRECIOS APLICADOS:</div>
                                        <div style="font-size: 9px;">${preciosFijoHtml}</div>
                                    </div>
                                    
                                    <div style="background-color: ${SLATE_MED}; color: white; padding: 8px; margin-top: 1px; font-size: 10px; font-weight: bold;">POTENCIA</div>
                                    <div style="padding: 10px; background-color: #f8fafc;">${detallesFijoHtml}</div>
                                    
                                    <div style="background-color: ${SLATE_MED}; color: white; padding: 8px; margin-top: 6px; font-size: 10px; font-weight: bold;">ENERGÃA</div>
                                    <div style="padding: 10px; background-color: #f8fafc;">${energiaFijoHtml}</div>
                                    
                                    <div style="background-color: ${SLATE_DARK}; color: white; padding: 12px; display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                                        <span style="font-size: 11px; font-weight: bold;">TOTAL (${resFijo.dias_facturados} DÃAS)</span>
                                        <span style="font-size: 13px; font-weight: bold;">${eur(resFijo.totalPeriod)}</span>
                                    </div>
                                    
                                    <div style="background-color: ${RED_CTA}; color: white; padding: 12px; text-align: center; border-radius: 0 0 12px 12px;">
                                        <div style="font-size: 10px; font-weight: bold; margin-bottom: 3px;">AHORRO:</div>
                                        <div style="font-size: 18px; font-weight: bold;">${eur(ahorroFijo)}</div>
                                    </div>
                                </div>
                            </td>
                            
                            <!-- COLUMNA INDEXADO -->
                            <td style="width: 48%; vertical-align: top; padding-left: 10px;">
                                <div style="border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; background-color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.07);">
                                    <div style="background-color: ${SLATE_DARK}; color: white; padding: 12px;">
                                        <div style="font-size: 10px; font-weight: bold; margin-bottom: 3px;">[${resIndexed.cups}]</div>
                                        <div style="font-size: 9px; opacity: 0.9;">Tipo: ${resIndexed.originalTariffType} | DÃ­as: ${resIndexed.dias_facturados}</div>
                                        <div style="font-size: 9px; margin-top: 4px; opacity: 0.95;">${BRAND_DISPLAY} INDEX - ${resIndexed.offer.name}</div>
                                    </div>
                                    
                                    <div style="background-color: ${SLATE_MED}; color: white; padding: 10px;">
                                        <div style="font-size: 10px; font-weight: bold; margin-bottom: 5px;">PRECIOS APLICADOS:</div>
                                        <div style="font-size: 9px;">${preciosIndexadoHtml}</div>
                                    </div>
                                    
                                    <div style="background-color: ${SLATE_MED}; color: white; padding: 8px; margin-top: 1px; font-size: 10px; font-weight: bold;">POTENCIA</div>
                                    <div style="padding: 10px; background-color: #f8fafc;">${detallesIndexadoHtml}</div>
                                    
                                    <div style="background-color: ${SLATE_MED}; color: white; padding: 8px; margin-top: 6px; font-size: 10px; font-weight: bold;">ENERGÃA</div>
                                    <div style="padding: 10px; background-color: #f8fafc;">${energiaIndexadoHtml}</div>
                                    
                                    <div style="background-color: ${SLATE_DARK}; color: white; padding: 12px; display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                                        <span style="font-size: 11px; font-weight: bold;">TOTAL (${resIndexed.dias_facturados} DÃAS)</span>
                                        <span style="font-size: 13px; font-weight: bold;">${eur(resIndexed.totalPeriod)}</span>
                                    </div>
                                    
                                    <div style="background-color: ${RED_CTA}; color: white; padding: 12px; text-align: center; border-radius: 0 0 12px 12px;">
                                        <div style="font-size: 10px; font-weight: bold; margin-bottom: 3px;">AHORRO:</div>
                                        <div style="font-size: 18px; font-weight: bold;">${eur(ahorroIndexado)}</div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- EXPLICACIÃ“N -->
                    <div style="background-color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.07);">
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: bold; text-align: center; color: #1f2937;">CUAL ES LA DIFERENCIA?</h3>
                        
                        <table cellpadding="0" cellspacing="0" width="100%">
                            <tr>
                                <td style="width: 48%; vertical-align: top; padding-right: 15px;">
                                    <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: bold; color: ${DRK_BLUE};">POR QUE TARIFA FIJA?</h4>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 12px; line-height: 1.8; color: #374151;">
                                        <li>Implica un precio fijo por los kilovatios que consumes (kWh).</li>
                                        <li>El precio se mantiene estable, independientemente de cÃ³mo se comporten los precios en el mercado elÃ©ctrico.</li>
                                        <li>Cuando el precio del mercado estÃ¡ alto, el cliente estÃ¡ protegido frente a sobresaltos.</li>
                                        <li>No tendrÃ¡s que estar pendiente de las variaciones del mercado y podrÃ¡s seguir usando la electricidad como siempre.</li>
                                    </ul>
                                </td>
                                <td style="width: 4%;"></td>
                                <td style="width: 48%; vertical-align: top; padding-left: 15px;">
                                    <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: bold; color: ${GREEN_SAVE};">POR QUE TARIFA INDEXADA?</h4>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 12px; line-height: 1.8; color: #374151;">
                                        <li>Implica un precio variable por los kilovatios que consumes (kWh) cada mes.</li>
                                        <li>Es la tarifa mÃ¡s justa, ya que pagas el coste real de la energÃ­a mes a mes.</li>
                                        <li>Al contratarla, el cliente evita pagar mÃ¡rgenes adicionales cuando el precio de la electricidad es mÃ¡s barato.</li>
                                        <li>A largo plazo, con un indexado 100% funcional, se puede obtener un ahorro aproximado de hasta un 20% en Ã©pocas de mejor precio.</li>
                                    </ul>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- BOTÃ“N EMAIL -->
                    <div style="background-color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.07); border: 3px solid ${isPowerCup ? '#84cc16' : '#0ea5e9'};">
                        <div style="text-align: center;">
                            <div style="margin-bottom: 15px;">
                                <span style="font-size: 20px; margin-right: 8px;">ðŸ“Š</span>
                                <span style="font-size: 16px; font-weight: bold; color: ${isPowerCup ? '#3f6212' : '#0c4a6e'};">
                                    Para formalizar esta oferta:
                                </span>
                            </div>
                            
                            <ol style="margin: 20px 0; padding-left: 20px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto; font-size: 14px; color: #374151; line-height: 2;">
                                <li>${tr('Haz clic en el botÃ³n de abajo')}</li>
                                <li>${tr('Se abrirÃ¡ tu cliente de email')}</li>
                                <li><strong style="color: ${isPowerCup ? '#3f6212' : '#0c4a6e'};">${tr('Adjunta la documentaciÃ³n requerida')}</strong></li>
                                <li>${tr('EnvÃ­a el email')}</li>
                            </ol>
                            
                            <a href="${formalizationLink}" style="display: inline-block; background-color: ${RED_CTA}; color: white; padding: 18px 40px; border-radius: 12px; text-decoration: none; font-size: 16px; font-weight: bold; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3); margin: 20px 0;">
                                ${tr('âœ… CONFIRMAR Y ENVIAR')}
                            </a>
                            
                            <div style="margin-top: 20px; padding: 15px; background-color: #f3f4f6; border-radius: 8px;">
                                <p style="margin: 0 0 8px 0; font-size: 12px; color: #6b7280;">
                                    <strong>ðŸ“Ž Por cada CUPS adjuntar:</strong>
                                </p>
                                <p style="margin: 0; font-size: 11px; color: #6b7280;">
                                    DNI/CIF Â· Ãšltima factura Â· Email Â· TelÃ©fono Â· IBAN
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- FOOTER -->
                    <div style="background-color: #f3f4f6; padding: 15px; border-radius: 8px; text-align: center;">
                        <p style="margin: 0 0 5px 0; font-size: 11px; color: #6b7280;">Comercial: <strong>${commercialCode}</strong></p>
                        ${clientAddress ? `<p style="margin: 0 0 5px 0; font-size: 10px; color: #6b7280;">${tr('DirecciÃ³n:')}: ${clientAddress}</p>` : ''}
                        <p style="margin: 0; font-size: 9px; color: #9ca3af;">Documento generado por ${brand.NAME.toUpperCase()}</p>
                    </div>
                    
                </div>
            `;
        }
        
        function generateMultiDualStyledHtmlOffer(commercialCode) {
            const res = lastComparisonResult;
            const brand = activeBrand;
            
            const eur = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
            
            // DETECCIÃ“N DE POWER CUP para cambiar colores
            const isPowerCup = brand.NAME.includes('POWER');
            
            // Colores dinÃ¡micos segÃºn la marca - TODO EN VERDE OLIVA PARA POWER CUP
            const HEADER_BLUE = isPowerCup ? '#738257' : '#6B7D8E';  // Verde oliva para PowerCup
            const DRK_BLUE = isPowerCup ? '#84cc16' : '#0ea5e9';     // Verde para PowerCup
            const GREEN_SAVE = '#16a34a';
            const RED_CTA = '#DC2626';
            const SLATE_DARK = isPowerCup ? '#5a6b47' : '#475569';   // Verde oliva oscuro para PowerCup
            const SLATE_MED = isPowerCup ? '#738257' : '#64748b';    // Verde oliva medio para PowerCup
            
            const BRAND_DISPLAY = isPowerCup ? 'POWER CUP' : 'DRK';  // Nombre a mostrar
            
            const clientName = document.getElementById('client-name-input').value.trim() || '[NOMBRE COMPLETO CLIENTE]';
            const clientPhone = document.getElementById('client-phone-input').value.trim() || '[TELÃ‰FONO CLIENTE]';
            const clientEmail = document.getElementById('client-email-input').value.trim() || '[EMAIL CLIENTE]';
            
            const ahorroFijo = res.savings;
            const ahorroIndexado = res.indexedTotals ? res.indexedTotals.savings : 0;
            
            let facturaActualTotal = 0;
            let nuevoCosteAnualFijo = 0;
            let nuevoCosteAnualIndexado = 0;
            
            res.individualResults.forEach(supply => {
                facturaActualTotal += supply.originalBillAnnual || 0;
                nuevoCosteAnualFijo += supply.totalAnnual || 0;
                if (supply.indexedComparison) {
                    nuevoCosteAnualIndexado += supply.indexedComparison.totalAnnual || 0;
                }
            });
            
            // Generar emailBody para MULTICUPS con PRECIOS DETALLADOS
            const LB = '%0A';
            let cupsList = '';
            res.individualResults.forEach((supply, idx) => {
                cupsList += `   ${idx + 1}. ${supply.cups}${LB}`;
            });
            
            // Generar desglose detallado de precios por cada CUPS
            let preciosDetalladosHtml = '';
            res.individualResults.forEach((supply, idx) => {
                const tieneIndexado = supply.indexedComparison && 
                                     supply.indexedComparison.powerCosts && 
                                     supply.indexedComparison.energyCosts;
                
                if (tieneIndexado) {
                    preciosDetalladosHtml += `${LB}â”â”â” CUPS ${idx + 1}: ${supply.cups} â”â”â”${LB}${LB}`;
                    
                    // OPCIÃ“N FIJA
                    preciosDetalladosHtml += `ðŸ“˜ OPCIÃ“N FIJA (${supply.offer.name || 'DRK FIJO'}):${LB}`;
                    preciosDetalladosHtml += `   Potencia:${LB}`;
                    supply.powerCosts.forEach((p, i) => {
                        if (p.kw > 0) {
                            preciosDetalladosHtml += `   â€¢ P${i+1}: ${numPriceFormula(p.priceDay)} â‚¬/kW/dÃ­a${LB}`;
                        }
                    });
                    preciosDetalladosHtml += `${LB}   EnergÃ­a:${LB}`;
                    supply.energyCosts.forEach((e, i) => {
                        if (e.kwh > 0) {
                            let label = `E${i+1}`;
                            if (supply.originalTariffType === '2.0TD') {
                                if (i === 0) label += ' (Punta)';
                                else if (i === 1) label += ' (Llano)';
                                else if (i === 2) label += ' (Valle)';
                            }
                            preciosDetalladosHtml += `   â€¢ ${label}: ${numPriceFormula(e.price)} â‚¬/kWh${LB}`;
                        }
                    });
                    preciosDetalladosHtml += `${LB}   ðŸ“Š Coste Anual: ${eur(supply.totalAnnual / 12)}/mes (${eur(supply.totalAnnual)}/aÃ±o)${LB}`;
                    preciosDetalladosHtml += `   ðŸ’° Ahorro: ${eur(supply.savings)}${LB}${LB}`;
                    
                    // OPCIÃ“N INDEXADA
                    const indexData = supply.indexedComparison;
                    preciosDetalladosHtml += `ðŸ“— OPCIÃ“N INDEXADA (${indexData.offer.name || 'DRK INDEX'}):${LB}`;
                    preciosDetalladosHtml += `   Potencia:${LB}`;
                    indexData.powerCosts.forEach((p, i) => {
                        if (p.kw > 0) {
                            preciosDetalladosHtml += `   â€¢ P${i+1}: ${numPriceFormula(p.priceDay)} â‚¬/kW/dÃ­a${LB}`;
                        }
                    });
                    preciosDetalladosHtml += `${LB}   EnergÃ­a:${LB}`;
                    indexData.energyCosts.forEach((e, i) => {
                        if (e.kwh > 0) {
                            let label = `E${i+1}`;
                            if (supply.originalTariffType === '2.0TD') {
                                if (i === 0) label += ' (Punta)';
                                else if (i === 1) label += ' (Llano)';
                                else if (i === 2) label += ' (Valle)';
                            }
                            preciosDetalladosHtml += `   â€¢ ${label}: ${numPriceFormula(e.price)} â‚¬/kWh${LB}`;
                        }
                    });
                    preciosDetalladosHtml += `${LB}   ðŸ“Š Coste Anual: ${eur(indexData.totalAnnual / 12)}/mes (${eur(indexData.totalAnnual)}/aÃ±o)${LB}`;
                    preciosDetalladosHtml += `   ðŸ’° Ahorro: ${eur(indexData.savings)}${LB}${LB}`;
                }
            });
            
            const emailBody = `âœ… CONFIRMACIÃ“N DE ACEPTACIÃ“N DE OFERTA MULTICUPS${LB}${LB}` +
                             `Estimado equipo de ${brand.NAME.toUpperCase()},${LB}${LB}` +
                             `Confirmo mi aceptaciÃ³n de la oferta energÃ©tica consolidada que detallo a continuaciÃ³n:${LB}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `ðŸ“‹ DATOS DE LOS SUMINISTROS${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `ðŸ“Š Total de CUPS: ${res.cups}${LB}${LB}` +
                             `ðŸ”Œ CUPS incluidos:${LB}${cupsList}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `ðŸ’° COMPARACIÃ“N DE AHORROS${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `ðŸ’¼ Ahorro Total con Tarifas FIJAS: ${eur(ahorroFijo)}${LB}` +
                             `   Nuevo Coste Anual: ${eur(nuevoCosteAnualFijo)} (${eur(nuevoCosteAnualFijo / 12)}/mes)${LB}${LB}` +
                             `âš¡ Ahorro Total con Tarifas INDEXADAS: ${eur(ahorroIndexado)}${LB}` +
                             `   Nuevo Coste Anual: ${eur(nuevoCosteAnualIndexado)} (${eur(nuevoCosteAnualIndexado / 12)}/mes)${LB}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `ðŸ’¡ PRECIOS DETALLADOS POR CUPS${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${preciosDetalladosHtml}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `âœ… MI DECISIÃ“N (Marca con X):${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `[ ] ACEPTO TARIFAS FIJAS para todos los CUPS${LB}` +
                             `    Ahorro total: ${eur(ahorroFijo)}${LB}` +
                             `    Coste mensual estimado: ${eur(nuevoCosteAnualFijo / 12)}${LB}${LB}` +
                             `[ ] ACEPTO TARIFAS INDEXADAS para todos los CUPS${LB}` +
                             `    Ahorro total: ${eur(ahorroIndexado)}${LB}` +
                             `    Coste mensual estimado: ${eur(nuevoCosteAnualIndexado / 12)}${LB}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `ðŸ‘¤ DATOS DEL TITULAR${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `ðŸ“› Nombre completo: ${clientName}${LB}` +
                             `ðŸ“± TelÃ©fono: ${clientPhone}${LB}` +
                             `ðŸ“§ Email: ${clientEmail}${LB}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `ðŸ“Ž DOCUMENTACIÃ“N ADJUNTA (Por cada CUPS)${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `Adjunto la siguiente documentaciÃ³n para formalizar los ${res.cups} contratos:${LB}${LB}` +
                             `âœ“ DNI/CIF (anverso y reverso)${LB}` +
                             `âœ“ Ãšltima factura de cada CUPS${LB}` +
                             `âœ“ Email Â· TelÃ©fono Â· IBAN${LB}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `ðŸ’¬ COMENTARIOS ADICIONALES${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `[Escriba aquÃ­ cualquier observaciÃ³n o consulta adicional]${LB}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `Quedo a la espera de la confirmaciÃ³n de la formalizaciÃ³n de los contratos.${LB}${LB}` +
                             `Atentamente,${LB}` +
                             `${clientName}${LB}${LB}` +
                             `Comercial: ${commercialCode}`;
            
            const subject = `âœ… FORMALIZACIÃ“N MULTICUPS - ${res.cups} CUPS - ${brand.NAME.toUpperCase()}`;
            const formalizationRecipients = 'f.araujo@drk.es,r.guerra@drk.es,s.caballero@drk.es';
            const formalizationLink = `mailto:${formalizationRecipients}?subject=${encodeURIComponent(subject)}&body=${emailBody}`;
            
            function generarColumnaDesglosePro(supply, isIndexed) {
                const data = isIndexed ? supply.indexedComparison : supply;
                if (!data || !data.powerCosts || !data.energyCosts) return '';
                
                // Usar el nombre correcto de la marca
                const marcaNombre = isPowerCup ? 'POWER CUP' : 'DRK';
                const nombreTarifa = isIndexed ? 
                    `${marcaNombre} INDEX - ${data.offer.name || (isPowerCup ? 'POWER CUP INDEX 4 2026' : 'DRK INDEX 4 2026')}` : 
                    `${marcaNombre} - ${data.offer.name || (isPowerCup ? 'POWER CUP FIJO 6 META 4' : 'DRK FIJO 6 META 4')}`;
                
                let htmlPotencia = '';
                data.powerCosts.forEach((p, idx) => {
                    if (p.kw > 0) {
                        htmlPotencia += `
                            <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; color: #374151;">
                                <span>P${idx+1}: (${num(p.kw, 2)} kW x ${numPriceFormula(p.priceDay)} â‚¬/kW/dÃ­a)</span>
                                <span style="font-weight: bold;">${num(p.cost, 2)} â‚¬</span>
                            </div>
                        `;
                    }
                });
                
                let htmlEnergia = '';
                data.energyCosts.forEach((e, idx) => {
                    if (e.kwh > 0) {
                        let label = `E${idx+1}`;
                        if (supply.originalTariffType === '2.0TD') {
                            if (idx === 0) label += ' (Punta)';
                            else if (idx === 1) label += ' (Llano)';
                            else if (idx === 2) label += ' (Valle)';
                        }
                        htmlEnergia += `
                            <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; color: #374151;">
                                <span>${label}: (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)} â‚¬/kWh)</span>
                                <span style="font-weight: bold;">${num(e.cost, 2)} â‚¬</span>
                            </div>
                        `;
                    }
                });
                
                let preciosPotenciaHtml = '';
                data.powerCosts.forEach((p, idx) => {
                    preciosPotenciaHtml += `<div style="font-size: 9px;">P${idx+1}: ${numPriceFormula(p.priceDay)} â‚¬/kW/dÃ­a</div>`;
                });
                
                let preciosEnergiaHtml = '';
                data.energyCosts.forEach((e, idx) => {
                    preciosEnergiaHtml += `<div style="font-size: 9px;">E${idx+1}: ${numPriceFormula(e.price)} â‚¬/kWh</div>`;
                });
                
                return `
                    <div style="border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; background-color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.07);">
                        <div style="background-color: ${SLATE_DARK}; color: white; padding: 12px; border-radius: 12px 12px 0 0;">
                            <div style="font-size: 10px; font-weight: bold; margin-bottom: 3px;">[${data.cups}]</div>
                            <div style="font-size: 9px; opacity: 0.9;">Tipo: ${data.originalTariffType} | DÃ­as: ${data.dias_facturados}</div>
                            <div style="font-size: 9px; margin-top: 4px; opacity: 0.95;">${nombreTarifa}</div>
                        </div>
                        
                        <div style="background-color: ${SLATE_MED}; color: white; padding: 10px;">
                            <div style="font-size: 10px; font-weight: bold; margin-bottom: 5px;">PRECIOS APLICADOS:</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <div>
                                    <div style="font-size: 9px; font-weight: bold; margin-bottom: 3px;">POTENCIA:</div>
                                    ${preciosPotenciaHtml}
                                </div>
                                <div>
                                    <div style="font-size: 9px; font-weight: bold; margin-bottom: 3px;">ENERGÃA:</div>
                                    ${preciosEnergiaHtml}
                                </div>
                            </div>
                        </div>
                        
                        <div style="background-color: ${SLATE_MED}; color: white; padding: 8px; margin-top: 1px; font-size: 10px; font-weight: bold;">
                            POTENCIA
                        </div>
                        <div style="padding: 10px; background-color: #f8fafc;">
                            ${htmlPotencia}
                        </div>
                        
                        <div style="background-color: ${SLATE_MED}; color: white; padding: 8px; margin-top: 6px; font-size: 10px; font-weight: bold;">
                            ENERGÃA
                        </div>
                        <div style="padding: 10px; background-color: #f8fafc;">
                            ${htmlEnergia}
                        </div>
                        
                        <div style="background-color: ${SLATE_DARK}; color: white; padding: 12px; display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                            <span style="font-size: 11px; font-weight: bold;">TOTAL (${data.dias_facturados} DÃAS)</span>
                            <span style="font-size: 13px; font-weight: bold;">${eur(data.totalPeriod)}</span>
                        </div>
                        
                        <div style="background-color: ${RED_CTA}; color: white; padding: 12px; text-align: center; border-radius: 0 0 12px 12px;">
                            <div style="font-size: 10px; font-weight: bold; margin-bottom: 3px;">AHORRO:</div>
                            <div style="font-size: 18px; font-weight: bold;">${eur(data.savings)}</div>
                        </div>
                    </div>
                `;
            }
            
            let desarrolloDetalladoHtml = '';
            res.individualResults.forEach((supply, idx) => {
                const tieneIndexado = supply.indexedComparison && 
                                     supply.indexedComparison.powerCosts && 
                                     supply.indexedComparison.energyCosts;
                
                if (tieneIndexado) {
                    desarrolloDetalladoHtml += `
                        <div style="background-color: ${HEADER_BLUE}; color: white; padding: 12px 20px; margin: 25px 0 15px 0; border-radius: 12px; text-align: center;">
                            <div style="font-size: 14px; font-weight: bold; letter-spacing: 1px;">DESARROLLO DETALLADO - SUMINISTRO ${idx + 1} DE ${res.individualResults.length}</div>
                        </div>
                        
                        <table cellpadding="0" cellspacing="0" width="100%" style="margin-bottom: 30px;">
                            <tr>
                                <td style="width: 48%; vertical-align: top; padding-right: 10px;">
                                    ${generarColumnaDesglosePro(supply, false)}
                                </td>
                                <td style="width: 4%;"></td>
                                <td style="width: 48%; vertical-align: top; padding-left: 10px;">
                                    ${generarColumnaDesglosePro(supply, true)}
                                </td>
                            </tr>
                        </table>
                    `;
                }
            });
            
            let resumenTablaFijoHtml = '';
            let resumenTablaIndexadoHtml = '';
            
            res.individualResults.forEach((supply, idx) => {
                const ahorroFijoSupply = supply.savings || 0;
                const ahorroIndexadoSupply = supply.indexedComparison ? supply.indexedComparison.savings : 0;
                
                resumenTablaFijoHtml += `
                    <tr style="background-color: ${idx % 2 === 0 ? '#ffffff' : '#f9fafb'};">
                        <td style="padding: 8px; font-size: 11px; border-bottom: 1px solid #e5e7eb;">${supply.cups}</td>
                        <td style="padding: 8px; font-size: 11px; border-bottom: 1px solid #e5e7eb;">${BRAND_DISPLAY}</td>
                        <td style="padding: 8px; font-size: 12px; font-weight: bold; text-align: right; border-bottom: 1px solid #e5e7eb; color: ${GREEN_SAVE};">${eur(ahorroFijoSupply)}</td>
                    </tr>
                `;
                
                resumenTablaIndexadoHtml += `
                    <tr style="background-color: ${idx % 2 === 0 ? '#ffffff' : '#f9fafb'};">
                        <td style="padding: 8px; font-size: 11px; border-bottom: 1px solid #e5e7eb;">${supply.cups}</td>
                        <td style="padding: 8px; font-size: 11px; border-bottom: 1px solid #e5e7eb;">${BRAND_DISPLAY} INDEX</td>
                        <td style="padding: 8px; font-size: 12px; font-weight: bold; text-align: right; border-bottom: 1px solid #e5e7eb; color: ${GREEN_SAVE};">${eur(ahorroIndexadoSupply)}</td>
                    </tr>
                `;
            });
            
            return `
                <div style="max-width: 900px; margin: 0 auto; font-family: Arial, sans-serif; background-color: #f8f9fa; padding: 20px;">
                    
                    <table cellpadding="0" cellspacing="0" width="100%" style="background: linear-gradient(135deg, ${HEADER_BLUE} 0%, #8B9AA8 100%); border-radius: 16px 16px 0 0; margin-bottom: 0;">
                        <tr>
                            <td style="padding: 25px 30px;">
                                <table cellpadding="0" cellspacing="0" width="100%">
                                    <tr>
                                        <td style="vertical-align: middle; width: 60%;">
                                            <div style="background-color: white; width: 50px; height: 50px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 10px;">
                                                <span style="font-size: 24px;">âš¡</span>
                                            </div>
                                            <h1 style="color: white; font-size: 16px; margin: 0 0 5px 0; font-weight: normal; letter-spacing: 0.5px;">
                                                ${brand.NAME.toUpperCase()}
                                            </h1>
                                            <p style="color: rgba(255,255,255,0.9); font-size: 11px; margin: 0;">Liderando el ahorro y la eficiencia energÃ©tica.</p>
                                        </td>
                                        <td style="text-align: right; vertical-align: middle; width: 40%;">
                                            <p style="color: rgba(255,255,255,0.7); font-size: 9px; margin: 0 0 5px 0; text-transform: uppercase; font-weight: bold;">MULTICUPS</p>
                                            <p style="color: white; font-size: 12px; margin: 0; font-weight: bold;">FIJO VS INDEXADO</p>
                                            <p style="color: rgba(255,255,255,0.9); font-size: 10px; margin: 5px 0 0 0;">Total: ${res.cups} CUPS</p>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                    
                    <div style="background-color: white; padding: 15px 30px; border-bottom: 2px solid #e5e7eb;">
                        <p style="margin: 0; font-size: 12px; color: #374151;"><strong${tr("CLIENTE:")}</strong> ${clientName}</p>
                        <p style="margin: 5px 0 0 0; font-size: 11px; color: #6b7280;">CUPS TOTALES: ${res.cups} CUPS</p>
                    </div>
                    
                    <div style="background-color: white; padding: 30px; border-radius: 0 0 16px 16px; margin-bottom: 20px;">
                        <div style="background-color: ${HEADER_BLUE}; color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 25px;">
                            <p style="margin: 0 0 8px 0; font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9;"${tr("LA MEJOR OPCIÃ“N PARA TI ES")}</p>
                            <h2 style="margin: 0; font-size: 32px; font-weight: bold;">${BRAND_DISPLAY}</h2>
                            <p style="margin: 8px 0 0 0; font-size: 12px; opacity: 0.95;">${tr('Ofrece el mayor ahorro consolidado con')} ${brand.NAME.toUpperCase()}.</p>
                        </div>
                        
                        <table cellpadding="0" cellspacing="0" width="100%" style="margin-bottom: 20px;">
                            <tr>
                                <td style="width: 30%; vertical-align: top; text-align: center; padding: 0 10px;">
                                    <div style="padding: 15px; border-right: 1px solid #e5e7eb;">
                                        <p style="margin: 0 0 8px 0; font-size: 10px; color: #6b7280; font-weight: 600; text-transform: uppercase;"${tr("TU FACTURA ACTUAL")}</p>
                                        <div style="margin: 10px 0;">
                                            <p style="margin: 0; font-size: 24px; font-weight: bold; color: ${RED_CTA}; text-decoration: line-through;">${eur(facturaActualTotal)}</p>
                                            <p style="margin: 3px 0 0 0; font-size: 9px; color: #9ca3af;"${tr("Total Periodo")}</p>
                                        </div>
                                        <div style="margin-top: 12px;">
                                            <p style="margin: 0; font-size: 20px; font-weight: bold; color: ${RED_CTA}; text-decoration: line-through;">${eur(facturaActualTotal)}${tr("/aÃ±o")}</p>
                                        </div>
                                    </div>
                                </td>
                                
                                <td style="width: 35%; vertical-align: top; text-align: center; padding: 0 10px;">
                                    <div style="background-color: ${DRK_BLUE}; color: white; padding: 10px 8px; border-radius: 8px 8px 0 0;">
                                        <p style="margin: 0; font-size: 9px; font-weight: bold; text-transform: uppercase;">${tr("TU AHORRO ANUAL FIJO")}</p>
                                    </div>
                                    <div style="padding: 15px 10px;">
                                        <p style="margin: 0; font-size: 32px; font-weight: bold; color: ${GREEN_SAVE};">${eur(ahorroFijo)}</p>
                                        <div style="margin: 15px 0 0 0;">
                                            <p style="margin: 0 0 3px 0; font-size: 10px; color: #6b7280; font-weight: 600;"${tr("TU NUEVO COSTE DRK")}</p>
                                            <p style="margin: 0; font-size: 22px; font-weight: bold; color: ${DRK_BLUE};">${eur(nuevoCosteAnualFijo / 12)}${tr("/mes")}</p>
                                            <p style="margin: 3px 0 0 0; font-size: 8px; color: #9ca3af;"${tr("Estimado Mensual")}</p>
                                            <p style="margin: 10px 0 0 0; font-size: 20px; font-weight: bold; color: ${DRK_BLUE};">${eur(nuevoCosteAnualFijo)}${tr("/aÃ±o")}</p>
                                        </div>
                                    </div>
                                </td>
                                
                                <td style="width: 35%; vertical-align: top; text-align: center; padding: 0 10px;">
                                    <div style="background-color: ${GREEN_SAVE}; color: white; padding: 10px 8px; border-radius: 8px 8px 0 0;">
                                        <p style="margin: 0; font-size: 9px; font-weight: bold; text-transform: uppercase;">${tr("TU AHORRO ANUAL INDEXADO")}</p>
                                    </div>
                                    <div style="padding: 15px 10px;">
                                        <p style="margin: 0; font-size: 32px; font-weight: bold; color: ${GREEN_SAVE};">${eur(ahorroIndexado)}</p>
                                        <div style="margin: 15px 0 0 0;">
                                            <p style="margin: 0 0 3px 0; font-size: 10px; color: #6b7280; font-weight: 600;"${tr("TU NUEVO COSTE DRK")}</p>
                                            <p style="margin: 0; font-size: 22px; font-weight: bold; color: ${GREEN_SAVE};">${eur(nuevoCosteAnualIndexado / 12)}${tr("/mes")}</p>
                                            <p style="margin: 3px 0 0 0; font-size: 8px; color: #9ca3af;"${tr("Estimado Mensual")}</p>
                                            <p style="margin: 10px 0 0 0; font-size: 20px; font-weight: bold; color: ${GREEN_SAVE};">${eur(nuevoCosteAnualIndexado)}${tr("/aÃ±o")}</p>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </table>
                        
                        <div style="background-color: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px 15px; margin: 20px 0; border-radius: 6px;">
                            <p style="margin: 0; font-size: 11px; color: #92400e; line-height: 1.5;">
                                <strong>âš ï¸ IMPORTANTE:</strong> A continuaciÃ³n encontrarÃ¡s el desglose detallado de cÃ¡lculos para cada suministro, mostrando los desgloses completos de costes tanto para tarifas fijas como indexadas.
                            </p>
                        </div>
                    </div>
                    
                    ${desarrolloDetalladoHtml}
                    
                    <div style="background-color: ${HEADER_BLUE}; color: white; padding: 12px 20px; margin: 30px 0 15px 0; border-radius: 12px; text-align: center;">
                        <h2 style="margin: 0; font-size: 16px; font-weight: bold; letter-spacing: 0.5px;">RESUMEN DE TODOS LOS SUMINISTROS</h2>
                    </div>
                    
                    <table cellpadding="0" cellspacing="0" width="100%" style="margin-bottom: 30px; background-color: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.07);">
                        <tr>
                            <td style="width: 48%; vertical-align: top; padding: 20px;">
                                <div style="background-color: ${HEADER_BLUE}; color: white; padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                                    <h3 style="margin: 0; font-size: 13px; font-weight: bold;">TARIFAS FIJAS</h3>
                                </div>
                                <table cellpadding="0" cellspacing="0" width="100%">
                                    <tr style="background-color: #f3f4f6;">
                                        <th style="padding: 8px; font-size: 10px; text-align: left; color: #374151; font-weight: bold;">CUPS</th>
                                        <th style="padding: 8px; font-size: 10px; text-align: left; color: #374151; font-weight: bold;">TARIFA</th>
                                        <th style="padding: 8px; font-size: 10px; text-align: right; color: #374151; font-weight: bold;">AHORRO</th>
                                    </tr>
                                    ${resumenTablaFijoHtml}
                                </table>
                                <div style="background-color: ${RED_CTA}; color: white; padding: 15px; margin-top: 15px; border-radius: 8px; text-align: center;">
                                    <p style="margin: 0 0 5px 0; font-size: 12px; font-weight: bold;">AHORRO TOTAL FIJAS:</p>
                                    <p style="margin: 0; font-size: 24px; font-weight: bold;">${eur(ahorroFijo)}</p>
                                </div>
                            </td>
                            
                            <td style="width: 4%;"></td>
                            
                            <td style="width: 48%; vertical-align: top; padding: 20px;">
                                <div style="background-color: ${HEADER_BLUE}; color: white; padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                                    <h3 style="margin: 0; font-size: 13px; font-weight: bold;">TARIFAS INDEXADAS</h3>
                                </div>
                                <table cellpadding="0" cellspacing="0" width="100%">
                                    <tr style="background-color: #f3f4f6;">
                                        <th style="padding: 8px; font-size: 10px; text-align: left; color: #374151; font-weight: bold;">CUPS</th>
                                        <th style="padding: 8px; font-size: 10px; text-align: left; color: #374151; font-weight: bold;">TARIFA</th>
                                        <th style="padding: 8px; font-size: 10px; text-align: right; color: #374151; font-weight: bold;">AHORRO</th>
                                    </tr>
                                    ${resumenTablaIndexadoHtml}
                                </table>
                                <div style="background-color: ${RED_CTA}; color: white; padding: 15px; margin-top: 15px; border-radius: 8px; text-align: center;">
                                    <p style="margin: 0 0 5px 0; font-size: 12px; font-weight: bold;">AHORRO TOTAL INDEXADAS:</p>
                                    <p style="margin: 0; font-size: 24px; font-weight: bold;">${eur(ahorroIndexado)}</p>
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <div style="background-color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.07);">
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: bold; text-align: center; color: #1f2937;">CUAL ES LA DIFERENCIA?</h3>
                        
                        <table cellpadding="0" cellspacing="0" width="100%">
                            <tr>
                                <td style="width: 48%; vertical-align: top; padding-right: 15px;">
                                    <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: bold; color: ${DRK_BLUE};">POR QUE TARIFA FIJA?</h4>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 12px; line-height: 1.8; color: #374151;">
                                        <li>Implica un precio fijo por los kilovatios que consumes (kWh).</li>
                                        <li>El precio se mantiene estable, independientemente de cÃ³mo se comporten los precios en el mercado elÃ©ctrico.</li>
                                        <li>Cuando el precio del mercado estÃ¡ alto, el cliente estÃ¡ protegido frente a sobresaltos.</li>
                                        <li>No tendrÃ¡s que estar pendiente de las variaciones del mercado y podrÃ¡s seguir usando la electricidad como siempre.</li>
                                    </ul>
                                </td>
                                <td style="width: 4%;"></td>
                                <td style="width: 48%; vertical-align: top; padding-left: 15px;">
                                    <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: bold; color: ${GREEN_SAVE};">POR QUE TARIFA INDEXADA?</h4>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 12px; line-height: 1.8; color: #374151;">
                                        <li>Implica un precio variable por los kilovatios que consumes (kWh) cada mes.</li>
                                        <li>Es la tarifa mÃ¡s justa, ya que pagas el coste real de la energÃ­a mes a mes.</li>
                                        <li>Al contratarla, el cliente evita pagar mÃ¡rgenes adicionales cuando el precio de la electricidad es mÃ¡s barato.</li>
                                        <li>A largo plazo, con un indexado 100% funcional, se puede obtener un ahorro aproximado de hasta un 20% en Ã©pocas de mejor precio.</li>
                                    </ul>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- BOTÃ“N DE CONFIRMACIÃ“N POR EMAIL -->
                    <div style="background-color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.07); border: 3px solid ${isPowerCup ? '#84cc16' : '#0ea5e9'};">
                        <div style="text-align: center;">
                            <div style="margin-bottom: 15px;">
                                <span style="font-size: 20px; margin-right: 8px;">ðŸ“Š</span>
                                <span style="font-size: 16px; font-weight: bold; color: ${isPowerCup ? '#3f6212' : '#0c4a6e'};">
                                    Para formalizar esta oferta consolidada:
                                </span>
                            </div>
                            
                            <ol style="margin: 20px 0; padding-left: 20px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto; font-size: 14px; color: #374151; line-height: 2;">
                                <li>${tr('Haz clic en el botÃ³n de abajo')}</li>
                                <li>${tr('Se abrirÃ¡ tu cliente de email')}</li>
                                <li><strong style="color: ${isPowerCup ? '#3f6212' : '#0c4a6e'};">${tr('Adjunta la documentaciÃ³n requerida')}</strong></li>
                                <li>${tr('EnvÃ­a el email')}</li>
                            </ol>
                            
                            <a href="${formalizationLink}" style="display: inline-block; background-color: ${RED_CTA}; color: white; padding: 18px 40px; border-radius: 12px; text-decoration: none; font-size: 16px; font-weight: bold; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3); margin: 20px 0;">
                                ${tr('âœ… CONFIRMAR Y ENVIAR')}
                            </a>
                            
                            <div style="margin-top: 20px; padding: 15px; background-color: #f3f4f6; border-radius: 8px;">
                                <p style="margin: 0 0 8px 0; font-size: 12px; color: #6b7280;">
                                    <strong>ðŸ“Ž Por cada CUPS adjuntar:</strong>
                                </p>
                                <p style="margin: 0; font-size: 11px; color: #6b7280;">
                                    DNI/CIF Â· Ãšltima factura Â· Email Â· TelÃ©fono Â· IBAN
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background-color: #f3f4f6; padding: 15px; border-radius: 8px; text-align: center;">
                        <p style="margin: 0 0 5px 0; font-size: 11px; color: #6b7280;">Comercial: <strong>${commercialCode}</strong></p>
                        <p style="margin: 0; font-size: 9px; color: #9ca3af;">Documento generado por ${brand.NAME.toUpperCase()}</p>
                    </div>
                    
                </div>
            `;
        }

        function generateStyledHtmlOffer(commercialCode) {
            const bd = lastComparisonResult;
            const offer = bd.offer;
            const brand = activeBrand;
            
            // FIX: Usar funciones robustas contra NaN
            const eur = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
            
            const DRK_DARK = '#0c4a6e'; const DRK_MED = '#075985'; const DRK_CTA = '#0284c7';
            const PC_DARK = '#3f6212'; const PC_MED = '#65a30d'; const PC_CTA = '#84cc16';

            // --- Dynamic Branding Setup ---
            // If activeBrand is POWER_CUP (comparisonMode === 'overall_best')
            const D_PRIMARY_DARK = brand.NAME.includes('DRK') ? DRK_DARK : PC_DARK;
            const D_PRIMARY_MED = brand.NAME.includes('DRK') ? DRK_MED : PC_MED;
            const D_ACCENT_CTA = brand.NAME.includes('DRK') ? DRK_CTA : PC_CTA;
            const D_BRAND_NAME = brand.NAME;
            const ZONA_GEOGRAFICA = "PENINSULA"; // HARDCODED AS REQUESTED

            const RED_CTA = '#CC0000';
            const BG_LIGHT = brand.NAME.includes('DRK') ? '#f0f9ff' : '#f7fee7';  
            const GREEN_SAVE = '#16a34a';
            
            // --- Shared Section Title Style (Removed margin-top: 10px) ---
            const sectionTitle = `background-color: ${D_PRIMARY_MED}; color: white; font-weight: bold; padding: 8px; font-size: 14px;`;


            const clientName = document.getElementById('client-name-input').value.trim() || '[NOMBRE COMPLETO CLIENTE]';
            const clientPhone = document.getElementById('client-phone-input').value.trim() || '[TELÃ‰FONO CLIENTE]';
            const clientEmail = document.getElementById('client-email-input').value.trim() || '[EMAIL CLIENTE]';
            
            const p1PricePerDay = bd.powerCosts.find(p => p.period === 1)?.priceDay || 0;
            const p2PricePerDay = bd.powerCosts.find(p => p.period === 2)?.priceDay || 0;
            const p3PricePerDay = bd.powerCosts.find(p => p.period === 3)?.priceDay || 0;
            const p4PricePerDay = bd.powerCosts.find(p => p.period === 4)?.priceDay || 0;
            const p5PricePerDay = bd.powerCosts.find(p => p.period === 5)?.priceDay || 0;
            const p6PricePerDay = bd.powerCosts.find(p => p.period === 6)?.priceDay || 0;
            const e1Price = bd.energyCosts.find(e => e.period === 1)?.price || 0;
            const e2Price = bd.energyCosts.find(e => e.period === 2)?.price || 0;
            const e3Price = bd.energyCosts.find(e => e.period === 3)?.price || 0;
            const e4Price = bd.energyCosts.find(e => e.period === 4)?.price || 0;
            const e5Price = bd.energyCosts.find(e => e.period === 5)?.price || 0;
            const e6Price = bd.energyCosts.find(e => e.period === 6)?.price || 0;

            const monthlyEstimate = eur(bd.totalAnnual / 12);
            const totalConsumption = num(bd.energyCosts.reduce((sum, e) => sum + e.kwh, 0), 0) + ' kWh';
            
            const LB = '%0A';
            const discountLine = bd.discountRate > 0 ? `Descuento: ${num(bd.discountRate * 100, 0)}% aplicado a EnergÃ­a.${LB}` : '';

            // MODIFICACIÃ“N: Nombre completo de la tarifa
            const commercialTariffName = bd.isNegativeSavings 
                ? "Tu Tarifa Actual" 
                : (offer.isDrk 
                    ? ((offer.description?.length > offer.name?.length) ? offer.description : offer.name)
                    : offer.name);
            const commercializadoraName = offer.isDrk ? offer.name?.toUpperCase() : (offer.name?.toUpperCase() === 'TU TARIFA ACTUAL' ? 'TU COMERCIALIZADORA' : offer.name?.toUpperCase());

            const emailBody = `âœ… CONFIRMACIÃ“N DE ACEPTACIÃ“N DE OFERTA${LB}${LB}` +
                                 `Estimado equipo de ${D_BRAND_NAME.toUpperCase()},${LB}${LB}` +
                                 `Confirmo mi aceptaciÃ³n de la oferta energÃ©tica que detallo a continuaciÃ³n:${LB}${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                                 `ðŸ“‹ DATOS DEL SUMINISTRO${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `ðŸ”Œ CUPS:${LB}${bd.cups}${LB}${LB}` +
                                 `âš¡ TARIFA CONTRATADA:${LB}${commercialTariffName}${LB}${LB}` +
                                 `ðŸŒ Zona GeogrÃ¡fica: ${ZONA_GEOGRAFICA}${LB}` +
                                 `ðŸ“Š Consumo Facturado: ${totalConsumption}${LB}${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                                 `ðŸ’° BENEFICIO ECONÃ“MICO${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `ðŸ’µ Ahorro Anual Estimado: ${eur(bd.savings)}${LB}` +
                                 `ðŸ“… Coste Mensual Estimado: ${monthlyEstimate}${LB}${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                                 `ðŸ’¡ PRECIOS CONTRATADOS${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `ðŸ”´ POTENCIA:${LB}` +
                                 `   â€¢ P1: ${numPriceFormula(p1PricePerDay)} â‚¬/kW/dÃ­a${LB}` +
                                 `   â€¢ P2: ${numPriceFormula(p2PricePerDay)} â‚¬/kW/dÃ­a${LB}${LB}` +
                                 `ðŸŸ¢ ENERGÃA:${LB}` +
                                 `   â€¢ E1 (Punta): ${numPriceFormula(e1Price)} â‚¬/kWh${LB}` +
                                 `   â€¢ E2 (Llano): ${numPriceFormula(e2Price)} â‚¬/kWh${LB}` +
                                 `   â€¢ E3 (Valle): ${numPriceFormula(e3Price)} â‚¬/kWh${LB}${LB}` +
                                 `${discountLine}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                                 `ðŸ‘¤ DATOS DEL TITULAR${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `ðŸ“› Nombre completo: ${clientName}${LB}` +
                                 `ðŸ“± TelÃ©fono: ${clientPhone}${LB}` +
                                 `ðŸ“§ Email: ${clientEmail}${LB}${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                                 `ðŸ“Ž DOCUMENTACIÃ“N ADJUNTA${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `Adjunto la siguiente documentaciÃ³n para formalizar el contrato:${LB}${LB}` +
                                 `âœ“ 1. Foto DNI/CIF (anverso y reverso)${LB}` +
                                 `âœ“ 2. Ãšltima factura de luz (mÃ­n. 3 meses)${LB}` +
                                 `âœ“ 3. Email de contacto${LB}` +
                                 `âœ“ 4. TelÃ©fono de contacto${LB}` +
                                 `âœ“ 5. NÃºmero de cuenta bancaria (IBAN)${LB}${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                                 `ðŸ’¬ COMENTARIOS ADICIONALES${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `[Escriba aquÃ­ cualquier observaciÃ³n o consulta adicional]${LB}${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `Quedo a la espera de la confirmaciÃ³n de la formalizaciÃ³n del contrato.${LB}${LB}` +
                                 `Atentamente,${LB}` +
                                 `${clientName}`;

            const subject = `âœ… FORMALIZACIÃ“N CONTRATO - CUPS: ${bd.cups}`;
            const formalizationRecipients = 'f.araujo@drk.es,r.guerra@drk.es,s.caballero@drk.es';
            const formalizationLink = `mailto:${formalizationRecipients}?subject=${encodeURIComponent(subject)}&body=${emailBody}`;

            const tableMain = `width: 600px; max-width: 100%; border-collapse: collapse; font-family: Arial, sans-serif; border: 1px solid #ddd; margin: 0 auto; background: white; border-radius: 8px; overflow: hidden;`;
            const headerCell = `background-color: ${D_PRIMARY_DARK}; color: white; padding: 15px; text-align: center; border-radius: 8px 8px 0 0;`;
            const rowLabel = `padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; color: #555; vertical-align: top;`;
            const rowValue = `padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; font-weight: bold; color: #333; text-align: right; white-space: nowrap; vertical-align: top;`;
            const savingsBox = `background-color: ${D_ACCENT_CTA}; color: white; font-size: 20px; font-weight: bold; padding: 15px; text-align: center; border-radius: 8px; margin: 15px 0;`;
            const footerStyle = `background-color: ${D_PRIMARY_MED}; height: 5px; margin-top: 10px; border-radius: 0 0 8px 8px;`;
            const GREEN_SAVE_COLOR = '#16a34a';
            const btnStyle = `display: inline-block; background-color: ${RED_CTA}; color: white; padding: 12px 24px; text-decoration: none; font-weight: bold; border-radius: 6px; margin: 20px 0; font-size: 16px;`;

            // --- PLANTILLA PARA AHORRO NEGATIVO ---
            if (bd.isNegativeSavings) {
                const isDrkBrand = brand.NAME.includes('DRK');
                const companyBanner = isDrkBrand ? `
                    <table cellpadding="0" cellspacing="0" width="600" style="width: 600px; max-width: 100%; margin: 0 auto 20px auto; border-collapse: collapse; background-color: #075985; font-family: Arial, sans-serif;">
                        <tr>
                            <td style="padding: 20px 20px 20px 20px; vertical-align: middle; width: 60%;">
                                <p style="margin: 0; padding: 0; color: #ffffff; font-size: 28px; font-weight: bold; line-height: 1.2;">DRK ENERGÃA</p>
                                <p style="margin: 5px 0 0 0; padding: 0; color: #bae6fd; font-size: 13px; line-height: 1.3;">Liderando el ahorro y la eficiencia energÃ©tica.</p>
                            </td>
                            <td style="padding: 20px 20px 20px 10px; text-align: right; vertical-align: middle; width: 40%;">
                                <p style="margin: 0; padding: 0; color: #e0f2fe; font-size: 9px; font-weight: bold; text-transform: uppercase;">ESTUDIO DE AHORRO</p>
                                <p style="margin: 3px 0 0 0; padding: 0; color: #ffffff; font-size: 14px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                            </td>
                        </tr>
                    </table>
                ` : `
                    <table cellpadding="0" cellspacing="0" width="600" style="width: 600px; max-width: 100%; margin: 0 auto 20px auto; border-collapse: collapse; background-color: #ffffff; border: 2px solid #84cc16; font-family: Arial, sans-serif;">
                        <tr>
                            <td style="padding: 20px 20px 20px 20px; vertical-align: middle; width: 60%;">
                                <p style="margin: 0; padding: 0; color: #365314; font-size: 28px; font-weight: bold; line-height: 1.2;">POWER CUP</p>
                                <p style="margin: 5px 0 0 0; padding: 0; color: #4d7c0f; font-size: 13px; font-weight: bold; line-height: 1.3;">AsesorÃ­a EnergÃ©tica</p>
                            </td>
                            <td style="padding: 20px 20px 20px 10px; text-align: right; vertical-align: middle; width: 40%;">
                                <p style="margin: 0; padding: 0; color: #65a30d; font-size: 9px; font-weight: bold; text-transform: uppercase;">ESTUDIO DE AHORRO</p>
                                <p style="margin: 3px 0 0 0; padding: 0; color: #365314; font-size: 14px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                            </td>
                        </tr>
                    </table>
                `;
                
                return companyBanner + `<table cellpadding="0" cellspacing="0" style="${tableMain}">
                        <tr><td colspan="2" style="${headerCell}">
                            <h1 style="margin:0; font-size: 24px;">ESTUDIO DE AHORRO</h1>
                            <p style="margin:5px 0 0 0; font-size: 14px; opacity: 0.9;">TU TARIFA ACTUAL ES LA MÃS COMPETITIVA</p>
                        </td></tr>
                        <tr><td colspan="2" style="padding: 15px;">
                            <p style="margin: 0; font-size: 13px;"><strong${tr("CLIENTE:")}</strong> ${clientName}</p>
                            <p style="margin: 5px 0 0 0; font-size: 13px;"><strong${tr("CUPS:")}</strong> ${bd.cups}</p>
                            <p style="margin: 5px 0 0 0; font-size: 13px;"><strong${tr("COMERCIAL:")}</strong> ${commercialCode || 'N/A'}</p>
                        </td></tr>
                        <tr><td colspan="2" style="background-color: ${BG_LIGHT}; padding: 25px 20px; text-align: center; border-top: 2px solid ${D_PRIMARY_MED}; border-bottom: 2px solid ${D_PRIMARY_MED};">
                            <div style="font-size: 60px; color: ${GREEN_SAVE_COLOR}; margin-bottom: 10px; line-height: 1;">&#9989;</div>
                            <p style="margin: 0; color: ${D_PRIMARY_DARK}; font-size: 22px; font-weight: bold;">Â¡Excelente Noticia!</p>
                            <h2 style="margin: 5px 0 0 0; color: ${D_PRIMARY_DARK}; font-size: 18px; font-weight: normal;">TU TARIFA ACTUAL ES LA MÃS COMPETITIVA DEL MERCADO</h2>
                            <p style="margin: 0; font-size: 14px; color: #555;">En este momento, no existe una oferta que mejore tu coste actual. Seguiremos estudiando.</p>
                        </td></tr>
                        <tr><td colspan="2" style="padding: 20px; text-align: center;">
                            <p style="font-size: 14px; font-weight: bold; color: ${D_PRIMARY_DARK}; margin-bottom: 5px;">COSTE ANUAL ESTIMADO (ACTUAL):</p>
                            <span style="font-size: 32px; font-weight: bold; color: ${GREEN_SAVE_COLOR}; display: block;">${eur(bd.originalBillAnnual)}</span>
                            <p style="font-size: 12px; color: #888;">${tr('/ AÃ‘O')} (${tr('basado en el consumo de')} ${bd.dias_facturados} ${tr('dÃ­as')})</p>
                            <p style="margin-top: 15px; font-size: 14px; color: #555;">[Colaborador: ${commercialCode}] | Este resumen es una simulaciÃ³n.</p>
                        </td></tr>
                        <tr><td colspan="2" style="padding: 0; height: 10px;"><div style="${footerStyle}"></div></td></tr>
                    </table>`;
            }

            // --- PLANTILLA ESTÃNDAR (Ahorro Positivo) ---
            
            const currentTariffConfig = TARIFF_CONFIG[bd.tariffType];
            
            // Desglose: Potencia
            let desglosePotencia = bd.powerCosts.map(p => {
                if (p.period <= currentTariffConfig.powerPeriods) {
                    return `<tr><td style="${rowLabel} font-family: monospace; font-size: 12px;">P${p.period} (${num(p.kw,2)} kW x ${bd.dias_facturados}d x ${numPriceFormula(p.priceDay)})</td><td style="${rowValue} font-family: monospace; font-size: 12px; white-space: nowrap;">${num(p.cost, 2)} â‚¬</td></tr>`;
                }
                return '';
            }).join('');
            
            // Desglose: EnergÃ­a
            let desgloseEnergia = bd.energyCosts.map(e => {
                if (e.period <= currentTariffConfig.periods) {
                    return `<tr><td style="${rowLabel} font-family: monospace; font-size: 12px;">E${e.period} (${num(e.kwh,0)} kWh x ${numPriceFormula(e.price)})</td><td style="${rowValue} font-family: monospace; font-size: 12px; white-space: nowrap;">${num(e.cost, 2)} â‚¬</td></tr>`;
                }
                return '';
            }).join('');
            
            const discountRowsHtml = bd.discountAmount > 0 ? `
                <tr><td style="${rowLabel} font-weight: bold; color: #CC0000;">DESCUENTO COMERCIAL (${num(bd.discountRate * 100, 0)}%)</td><td style="${rowValue} font-weight: bold; color: #CC0000; white-space: nowrap;">-${num(bd.discountAmount, 2)} â‚¬</td></tr>
                <tr><td style="${rowLabel} background-color: #eee; font-weight: bold; color: ${D_PRIMARY_DARK};">SUBTOTAL ENERGÃA (Neto)</td><td style="${rowValue} background-color: #eee; font-weight: bold; color: ${D_PRIMARY_DARK}; white-space: nowrap;">${num(bd.subEnergyNet, 2)} â‚¬</td></tr>
            ` : '';
            
            const desgloseRows = `
                <tr><td colspan="2"><div style="font-weight: bold; color: ${D_PRIMARY_MED}; padding: 5px 0 2px 0;">TÃ‰RMINO POTENCIA (Precio en â‚¬/kW DÃ­a)</div></td></tr>
                ${desglosePotencia}
                <tr><td style="${rowLabel} border-bottom: 1px solid #eee; font-weight: bold; color: ${D_PRIMARY_DARK};"${tr("SUBTOTAL POTENCIA")}</td><td style="${rowValue} border-bottom: 1px solid #eee; font-weight: bold; color: ${D_PRIMARY_DARK}; white-space: nowrap;">${num(bd.subPower, 2)} â‚¬</td></tr>
                
                <tr><td colspan="2"><div style="font-weight: bold; color: ${D_PRIMARY_MED}; padding: 10px 0 2px 0;">TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)</div></td></tr>
                ${desgloseEnergia}
                <tr><td style="${rowLabel} border-bottom: 2px solid #333; font-weight: bold; color: #555;"${tr("Subtotal EnergÃ­a (Bruto)")}</td><td style="${rowValue} border-bottom: 2px solid #333; font-weight: bold; color: #555; white-space: nowrap;">${num(bd.subEnergy, 2)} â‚¬</td></tr>
                
                ${discountRowsHtml}
                
                <tr><td style="${rowLabel} border-top: 2px solid #333; font-weight: bold; color: ${D_PRIMARY_DARK};"${tr("SUBTOTAL BASE (P+E)")}</td><td style="${rowValue} border-top: 2px solid #333; font-weight: bold; color: ${D_PRIMARY_DARK}; white-space: nowrap;">${num(bd.subBase, 2)} â‚¬</td></tr>
                <tr><td style="${rowLabel}">${tr('Imp. ElÃ©c.')} (${num(bd.ieRate * 100, 3)}%)</td><td style="${rowValue} white-space: nowrap;">${num(bd.costIE, 2)} â‚¬</td></tr>
                <tr><td style="${rowLabel} font-weight: bold;"${tr("BASE IMPONIBLE")}</td><td style="${rowValue} font-weight: bold; white-space: nowrap;">${num(bd.baseImp, 2)} â‚¬</td></tr>
                <tr><td style="${rowLabel}">IVA (21%)</td><td style="${rowValue} white-space: nowrap;">${num(bd.costIVA, 2)} â‚¬</td></tr>
                
                <tr><td style="${rowLabel} background-color: #eee; font-weight: bold;">TOTAL FACTURA (${bd.dias_facturados} DÃAS)</td><td style="${rowValue} background-color: #eee; font-size: 16px; white-space: nowrap;">${eur(bd.totalPeriod)}</td></tr>
                <tr><td style="${rowLabel} background-color: #eee; font-weight: bold;"${tr("TOTAL AÃ‘O (PROYECTADO)")}</td><td style="${rowValue} background-color: #eee; font-size: 16px; white-space: nowrap;">${eur(bd.totalAnnual)}</td></tr>
            `;

            const discountSummaryRow = bd.discountRate > 0 ? `
                <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee; font-weight: bold; color: #CC0000;">DESCUENTO ENERGÃA</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap; color: #CC0000;">${num(bd.discountRate * 100, 0)}%</td></tr>
            ` : '';
            
            const preciosResumenTable = `
                <tr><td colspan="2" style="padding-top: 20px;"><div style="${sectionTitle}">${tr('RESUMEN DE PRECIOS DE LA OFERTA ÃšNICA')}</div></td></tr>
                <tr><td colspan="2" style="padding: 0;">
                    <table width="100%" cellpadding="0" cellspacing="0" style="font-family: Arial, sans-serif; font-size: 12px; table-layout: fixed;">
                        <tr style="background-color: #f5f5f5;">
                            <th style="padding: 5px 8px; text-align: left; color: ${D_PRIMARY_DARK}; width: 60%;">CONCEPTO</th>
                            <th style="padding: 5px 8px; text-align: right; color: ${D_PRIMARY_DARK}; width: 40%;">PRECIO ${commercializadoraName}</th>
                        </tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Potencia P1 (â‚¬/kW/dÃ­a)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">${numPriceFormula(p1PricePerDay)}</td></tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Potencia P2 (â‚¬/kW/dÃ­a)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">${numPriceFormula(p2PricePerDay)}</td></tr>
                        ${bd.tariffType === '3.0TD' ? '<tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Potencia P3 (â‚¬/kW/dÃ­a)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">' + numPriceFormula(p3PricePerDay) + '</td></tr>' : ''}
                        ${bd.tariffType === '3.0TD' ? '<tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Potencia P4 (â‚¬/kW/dÃ­a)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">' + numPriceFormula(p4PricePerDay) + '</td></tr>' : ''}
                        ${bd.tariffType === '3.0TD' ? '<tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Potencia P5 (â‚¬/kW/dÃ­a)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">' + numPriceFormula(p5PricePerDay) + '</td></tr>' : ''}
                        ${bd.tariffType === '3.0TD' ? '<tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Potencia P6 (â‚¬/kW/dÃ­a)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">' + numPriceFormula(p6PricePerDay) + '</td></tr>' : ''}
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">EnergÃ­a E1 (â‚¬/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">${numPriceFormula(e1Price)}</td></tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">EnergÃ­a E2 (â‚¬/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">${numPriceFormula(e2Price)}</td></tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">EnergÃ­a E3 (â‚¬/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">${numPriceFormula(e3Price)}</td></tr>
                        ${bd.tariffType === '3.0TD' ? '<tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">EnergÃ­a E4 (â‚¬/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">' + numPriceFormula(e4Price) + '</td></tr>' : ''}
                        ${bd.tariffType === '3.0TD' ? '<tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">EnergÃ­a E5 (â‚¬/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">' + numPriceFormula(e5Price) + '</td></tr>' : ''}
                        ${bd.tariffType === '3.0TD' ? '<tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">EnergÃ­a E6 (â‚¬/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">' + numPriceFormula(e6Price) + '</td></tr>' : ''}
                        ${discountSummaryRow}
                        <tr style="background-color: #eee; font-weight: bold;"><td style="padding: 8px; color: ${D_PRIMARY_DARK};">AHORRO ANUAL</td><td style="padding: 8px; text-align: right; font-size: 14px; color: ${GREEN_SAVE_COLOR}; white-space: nowrap;">${eur(bd.savings)}</td></tr>
                        <tr style="background-color: white; height: 10px;"><td colspan="2"></td></tr>
                    </table>
                </td></tr>
            `;

            const finalSavingsSummary = `
                <tr><td colspan="2" style="padding: 0 20px 0 20px; text-align: center;">
                    ${bd.savings > 0 ? `
                    <div style="text-align: center; margin: 15px 0 5px 0;">
                        <p style="margin: 0; font-size: 16px; color: #555; font-weight: bold;">${tr('RESUMEN DE AHORRO FINAL')}</p>
                    </div>
                    <div style="background-color: ${BG_LIGHT}; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px;">
                        <p style="margin: 0; font-size: 14px; color: #555;">${tr('TU AHORRO ANUAL ESTIMADO ES:')}</p>
                        <span style="font-size: 32px; font-weight: bold; color: ${GREEN_SAVE_COLOR}; display: block; margin-top: 5px; white-space: nowrap;">${eur(bd.savings)}</span>
                        <p style="font-size: 12px; color: #888;">${tr('/ AÃ‘O')}</p>
                    </div>
                    ` : `
                    <div style="background-color: #f0f9ff; padding: 25px; border-radius: 8px; border: 2px solid ${D_PRIMARY_DARK}; margin-bottom: 20px; text-align: center;">
                        <p style="margin: 0 0 10px 0; font-size: 18px; color: ${D_PRIMARY_DARK}; font-weight: bold;">Â¡ENHORABUENA!</p>
                        <p style="margin: 0 0 15px 0; font-size: 14px; color: #333; font-weight: bold;">Actualmente estÃ¡s en una buena tarifa.</p>
                        <p style="margin: 0; font-size: 13px; color: #666; line-height: 1.6;">Seguiremos estudiando el mercado y te avisaremos cuando encontremos alguna tarifa que se adapte a tu perfil de consumo.</p>
                    </div>
                    `}
                </td></tr>
            `;

            // NUEVO: Banner de empresa para email
            const isDrkBrand = brand.NAME.includes('DRK');
            const companyBanner = isDrkBrand ? `
                <table cellpadding="0" cellspacing="0" width="600" style="width: 600px; max-width: 100%; margin: 0 auto 20px auto; border-collapse: collapse; background-color: #075985; font-family: Arial, sans-serif;">
                    <tr>
                        <td style="padding: 20px 20px 20px 20px; vertical-align: middle; width: 60%;">
                            <p style="margin: 0; padding: 0; color: #ffffff; font-size: 28px; font-weight: bold; line-height: 1.2;">DRK ENERGÃA</p>
                            <p style="margin: 5px 0 0 0; padding: 0; color: #bae6fd; font-size: 13px; line-height: 1.3;">Liderando el ahorro y la eficiencia energÃ©tica.</p>
                        </td>
                        <td style="padding: 20px 20px 20px 10px; text-align: right; vertical-align: middle; width: 40%;">
                            <p style="margin: 0; padding: 0; color: #e0f2fe; font-size: 9px; font-weight: bold; text-transform: uppercase;">ESTUDIO DE AHORRO</p>
                            <p style="margin: 3px 0 0 0; padding: 0; color: #ffffff; font-size: 14px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                        </td>
                    </tr>
                </table>
            ` : `
                <table cellpadding="0" cellspacing="0" width="600" style="width: 600px; max-width: 100%; margin: 0 auto 20px auto; border-collapse: collapse; background-color: #ffffff; border: 2px solid #84cc16; font-family: Arial, sans-serif;">
                    <tr>
                        <td style="padding: 20px 20px 20px 20px; vertical-align: middle; width: 60%;">
                            <p style="margin: 0; padding: 0; color: #365314; font-size: 28px; font-weight: bold; line-height: 1.2;">POWER CUP</p>
                            <p style="margin: 5px 0 0 0; padding: 0; color: #4d7c0f; font-size: 13px; font-weight: bold; line-height: 1.3;">AsesorÃ­a EnergÃ©tica</p>
                        </td>
                        <td style="padding: 20px 20px 20px 10px; text-align: right; vertical-align: middle; width: 40%;">
                            <p style="margin: 0; padding: 0; color: #65a30d; font-size: 9px; font-weight: bold; text-transform: uppercase;">ESTUDIO DE AHORRO</p>
                            <p style="margin: 3px 0 0 0; padding: 0; color: #365314; font-size: 14px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                        </td>
                    </tr>
                </table>
            `;

            return companyBanner + `<table cellpadding="0" cellspacing="0" style="${tableMain}">
                    <tr><td colspan="2" style="${headerCell}">
                        <h1 style="margin:0; font-size: 24px;">ESTUDIO DE AHORRO</h1>
                        <p style="margin:5px 0 0 0; font-size: 14px; opacity: 0.9;">COMPARATIVA PROFESIONAL - ${D_BRAND_NAME.toUpperCase()}</p>
                    </td></tr>
                    
                    <tr><td colspan="2" style="padding: 15px;">
                        <p style="margin: 0; font-size: 13px;"><strong${tr("CLIENTE:")}</strong> ${clientName}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;"><strong${tr("CUPS:")}</strong> ${bd.cups}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;"><strong${tr("COMERCIAL:")}</strong> ${commercialCode || 'N/A'}</p>
                    </td></tr>

                    <tr><td colspan="2" style="background-color: ${BG_LIGHT}; padding: 15px; text-align: center; border-top: 2px solid ${D_PRIMARY_MED}; border-bottom: 2px solid ${D_PRIMARY_MED};">
                        <p style="margin: 0; color: ${D_PRIMARY_MED}; font-size: 12px; font-weight: bold; letter-spacing: 1px;"${tr("LA MEJOR OPCIÃ“N PARA TI ES")}</p>
                        <h2 style="margin: 5px 0 0 0; color: ${D_PRIMARY_DARK}; font-size: 22px;">${commercialTariffName}</h2>
                    </td></tr>

                    <tr><td colspan="2" style="padding: 0 20px;">
                        ${bd.savings > 0 ? `
                        <div style="text-align: center; margin: 25px 0 10px 0;">
                            <p style="margin: 0; font-size: 16px; color: #555; font-weight: bold;">${tr('TU AHORRO ANUAL ESTIMADO ES:')}</p>
                        </div>
                        <div style="${savingsBox}">
                            <span style="font-size: 38px; white-space: nowrap;">${eur(bd.savings)}</span>
                            <p style="margin: 5px 0 0 0; font-size: 18px; font-weight: bold;">${tr('Â¡CONSIGUE TU AHORRO ANUAL!')}</p>
                        </div>
                        ` : `
                        <div style="background-color: #f0f9ff; padding: 25px; border-radius: 8px; border: 2px solid ${D_PRIMARY_DARK}; margin: 25px 0; text-align: center;">
                            <p style="margin: 0 0 10px 0; font-size: 18px; color: ${D_PRIMARY_DARK}; font-weight: bold;">Â¡ENHORABUENA!</p>
                            <p style="margin: 0 0 15px 0; font-size: 14px; color: #333; font-weight: bold;">Actualmente estÃ¡s en una buena tarifa.</p>
                            <p style="margin: 0; font-size: 13px; color: #666; line-height: 1.6;">Seguiremos estudiando el mercado y te avisaremos cuando encontremos alguna tarifa que se adapte a tu perfil de consumo.</p>
                        </div>
                        `}
                    </td></tr>

                    ${bd.savings > 0 ? `
                    <tr><td colspan="2" style="padding: 0 20px;">
                        <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom: 20px; table-layout: fixed;">
                            <tr>
                                <td style="width: 50%; padding: 15px; background-color: #f9fafb; border: 1px solid #ddd; text-align: center; vertical-align: top;">
                                    <div style="font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase;"${tr("TU FACTURA ACTUAL")}</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #ef4444; margin: 5px 0; text-decoration: line-through; white-space: nowrap;">${eur(bd.originalBillAnnual)}</div>
                                    <div style="font-size: 11px; color: #666;">${tr('/ AÃ‘O')}</div>
                                </td>
                                <td style="width: 50%; padding: 15px; background-color: ${BG_LIGHT}; border: 1px solid ${D_PRIMARY_MED}; text-align: center; vertical-align: top;">
                                    <div style="font-size: 11px; font-weight: bold; color: ${D_PRIMARY_MED}; text-transform: uppercase;">${tr('TU NUEVO COSTE')} ${commercializadoraName}</div>
                                    <div style="font-size: 24px; font-weight: bold; color: ${D_PRIMARY_DARK}; margin: 5px 0; white-space: nowrap;">${eur(bd.totalAnnual)}</div>
                                    <div style="font-size: 11px; color: ${D_PRIMARY_MED};">${tr('/ AÃ‘O')}</div>
                                    <div style="font-size: 13px; font-weight: bold; color: ${D_PRIMARY_DARK}; margin-top: 5px; white-space: nowrap;">${eur(bd.totalAnnual/12)} ${tr('/ MES')}</div>
                                </td>
                            </tr>
                        </table>
                    </td></tr>
                    ` : ''}
                    
                    ${preciosResumenTable}
                    
                    <tr><td colspan="2"><div style="${sectionTitle}">${tr('DESGLOSE DETALLADO DE LA SIMULACIÃ“N')} (${commercialTariffName})</div></td></tr>
                    <tr><td colspan="2" style="padding: 0 20px;">
                        <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 10px; margin-bottom: 20px; table-layout: fixed;">
                            ${desgloseRows}
                        </table>
                    </td></tr>
                    
                    ${finalSavingsSummary}

                    <tr><td colspan="2" style="text-align: center; padding: 20px; background-color: #f8f9fa;">
                        <div style="max-width: 500px; margin: 0 auto; padding: 20px; background: white; border-radius: 10px; border: 2px solid ${D_PRIMARY_MED};">
                            <p style="margin: 0 0 15px 0; font-size: 16px; font-weight: bold; color: ${D_PRIMARY_DARK};">${tr('ðŸ“§ Para confirmar esta oferta:')}</p>
                            <p style="margin: 0 0 15px 0; font-size: 13px; color: #555; line-height: 1.6;">
                                1. ${tr('Haz clic en el botÃ³n de abajo')}<br>
                                2. ${tr('Se abrirÃ¡ tu cliente de email')}<br>
                                3. <strong style="color: ${D_PRIMARY_DARK};">${tr('Adjunta la documentaciÃ³n requerida')}</strong><br>
                                4. ${tr('EnvÃ­a el email')}
                            </p>
                            <a href="${formalizationLink}" style="${btnStyle}">${tr('âœ… CONFIRMAR Y ENVIAR')}</a>
                            <p style="margin: 15px 0 0 0; font-size: 11px; color: #666; line-height: 1.5;">
                                ${tr('ðŸ“„ <strong>DocumentaciÃ³n necesaria:</strong><br>')}
                                ${tr('DNI/CIF Â· Ãšltima factura Â· Email Â· TelÃ©fono Â· IBAN')}
                            </p>
                        </div>
                        <p style="font-size: 10px; color: #999; margin-top: 15px;">[Colaborador: ${commercialCode}] | ${tr('Este resumen es una simulacion')} ${tr('basada en su ultima factura')}.</p>
                    </td></tr>

                    <tr><td colspan="2" style="padding: 0; height: 10px;"><div style="${footerStyle}"></div></td></tr>
                </table>`;
        }


        function generateMultiStyledHtmlOffer(commercialCode) {
            const bd = lastComparisonResult; // Resultado acumulado
            const offer = bd.offer;
            const individualResults = bd.individualResults;
            
            // FIX: Usar funciones robustas contra NaN
            const eur = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
            
            const DRK_DARK = '#0c4a6e'; const DRK_MED = '#075985'; const DRK_CTA = '#0284c7';
            const PC_DARK = '#3f6212'; const PC_MED = '#65a30d'; const PC_CTA = '#84cc16';

            // --- Determine Dynamic Branding for Email Copy ---
            const { winningOffers, hasDrkWinner } = getWinningOffersPerType(individualResults);

            let dynamicBrand = activeBrand; // Use the current active brand (set by comparison mode)
            
            const D_PRIMARY_DARK = dynamicBrand.NAME.includes('DRK') ? DRK_DARK : PC_DARK;
            const D_PRIMARY_MED = dynamicBrand.NAME.includes('DRK') ? DRK_MED : PC_MED;
            const D_ACCENT_CTA = dynamicBrand.NAME.includes('DRK') ? DRK_CTA : PC_CTA;
            const D_BRAND_NAME = dynamicBrand.NAME;
            const BG_LIGHT = dynamicBrand.NAME.includes('DRK') ? '#f0f9ff' : '#f7fee7';  

            const ZONA_GEOGRAFICA = "PENINSULA"; // HARDCODED AS REQUESTED

            const RED_CTA = '#CC0000';
            const GREEN_SAVE = '#16a34a';
            
            // --- Shared Section Title Style (Removed margin-top: 10px) ---
            const sectionTitle = `background-color: ${D_PRIMARY_MED}; color: white; font-weight: bold; padding: 8px; font-size: 14px;`;


            const clientName = document.getElementById('client-name-input').value.trim() || '[NOMBRE COMPLETO CLIENTE]';
            const clientPhone = document.getElementById('client-phone-input').value.trim() || '[TELÃ‰FONO CLIENTE]';
            const clientEmail = document.getElementById('client-email-input').value.trim() || '[EMAIL CLIENTE]';

            // Generar tabla de desglose individual
            let individualBreakdowns = '';
            individualResults.forEach((resItem, index) => {
                // La lÃ³gica de cuÃ¡l es la mejor oferta ya se ha aplicado en saveSupply
                const isBest = resItem.isNegativeSavings === false;  
                const currentConfig = TARIFF_CONFIG[resItem.originalTariffType] || TARIFF_CONFIG['2.0TD'];
                const periods = currentConfig.periods;
                const powerPeriods = currentConfig.powerPeriods;
                
                // Determinar el nombre de la tarifa final aplicada
                const appliedOfferName = resItem.offer.isDrk  
                    ? ((resItem.offer.description?.length > resItem.offer.name?.length) 
                        ? resItem.offer.description 
                        : resItem.offer.name)
                    : resItem.offer.name;

                // Desglose: Potencia
                let desglosePotencia = resItem.powerCosts.map(p => {
                    if (p.period <= powerPeriods) {
                        return `<tr><td style="padding: 5px 8px; font-family: monospace; font-size: 11px; color: #555;">P${p.period} (${num(p.kw,2)} kW x ${resItem.dias_facturados}d x ${numPriceFormula(p.priceDay)})</td><td style="padding: 5px 8px; font-family: monospace; font-size: 11px; font-weight: bold; color: #333; text-align: right; white-space: nowrap;">${num(p.cost, 2)} â‚¬</td></tr>`;
                    }
                    return '';
                }).join('');

                // Desglose: EnergÃ­a
                let desgloseEnergia = resItem.energyCosts.map(e => {
                    if (e.period <= periods) {
                        let label = `E${e.period}`;
                        if (resItem.originalTariffType === '2.0TD') {
                            if (e.period === 1) label += ' (Punta)';
                            if (e.period === 2) label += ' (Llano)';
                            if (e.period === 3) label += ' (Valle)';
                            }
                        return `<tr><td style="padding: 5px 8px; font-family: monospace; font-size: 11px; color: #555;">${label} (${num(e.kwh,0)} kWh x ${numPriceFormula(e.price)})</td><td style="padding: 5px 8px; font-family: monospace; font-size: 11px; font-weight: bold; color: #333; text-align: right; white-space: nowrap;">${num(e.cost, 2)} â‚¬</td></tr>`;
                    }
                    return '';
                }).join('');
                
                const discountRowsHtml = resItem.discountAmount > 0 ? `
                    <tr><td style="padding: 5px 8px; font-weight: bold; color: #CC0000;">DESCUENTO COMERCIAL (${num(resItem.discountRate * 100, 0)}%)</td><td style="padding: 5px 8px; text-align: right; font-weight: bold; color: #CC0000; white-space: nowrap;">-${num(resItem.discountAmount, 2)} â‚¬</td></tr>
                    ` : '';

                // MODIFICACIÃ“N #2: Ajuste para eliminar "Sin Ahorro" en el email copy si no hay ahorro, dejando solo el total.
                const ahorroAnualText = isBest
                    ? `. Ahorro Anual: <span style="color: ${GREEN_SAVE}; font-weight: bold;">${eur(resItem.savings)}</span>`
                    : '';

                individualBreakdowns += `
                    <tr><td colspan="2" style="padding: 15px 20px 0 20px; background-color: #f8fafc; border-top: 2px solid #ddd;">
                        <h4 style="margin: 0 0 10px 0; font-size: 16px; color: ${D_PRIMARY_DARK}; font-weight: bold;">[${index + 1}] CUPS: ${resItem.cups} (${resItem.originalTariffType})</h4>
                        <p style="margin: 0 0 5px 0; font-size: 12px; color: #555;">Tarifa Aplicada: <span style="font-weight: bold;">${appliedOfferName}</span></p>
                        <p style="margin: 0 0 10px 0; font-size: 12px; color: #555;">DÃ­as Facturados: ${resItem.dias_facturados}${ahorroAnualText}</p>
                        
                        <table width="100%" cellpadding="0" cellspacing="0" style="table-layout: fixed; margin-bottom: 10px; background-color: white; border: 1px solid #eee;">
                            <tr style="background-color: #f5f5f5;">
                                <th colspan="2" style="padding: 5px 8px; text-align: left; font-size: 12px; color: ${D_PRIMARY_MED}; border-bottom: 1px solid #ddd;">SIMULACIÃ“N DE COSTES POR PERIODO</th>
                            </tr>
                            <tr><td colspan="2" style="padding: 5px 8px; font-weight: bold; color: ${D_PRIMARY_MED};">POTENCIA</td></tr>
                            ${desglosePotencia}
                            <tr><td colspan="2" style="height: 5px;"></td></tr>
                            <tr><td colspan="2" style="padding: 5px 8px; font-weight: bold; color: ${D_PRIMARY_MED};">ENERGÃA</td></tr>
                            ${desgloseEnergia}
                            ${discountRowsHtml}
                            <tr><td colspan="2" style="height: 5px;"></td></tr>
                            <tr><td style="padding: 8px; background-color: ${BG_LIGHT}; font-weight: bold; color: ${D_PRIMARY_DARK};">TOTAL FACTURA (PERIODO)</td><td style="padding: 8px; background-color: ${BG_LIGHT}; font-weight: bold; color: ${D_PRIMARY_DARK}; text-align: right;">${eur(resItem.totalPeriod)}</td></tr>
                        </table>
                    </td></tr>
                `;
            });
            
            const tableMain = `width: 600px; max-width: 100%; border-collapse: collapse; font-family: Arial, sans-serif; border: 1px solid #ddd; margin: 0 auto; background: white; border-radius: 8px; overflow: hidden;`;
            const headerCell = `background-color: ${D_PRIMARY_DARK}; color: white; padding: 15px; text-align: center; border-radius: 8px 8px 0 0;`;
            const savingsBox = `background-color: ${D_ACCENT_CTA}; color: white; font-size: 20px; font-weight: bold; padding: 15px; text-align: center; border-radius: 8px; margin: 15px 0;`;
            const btnStyle = `display: inline-block; background-color: ${RED_CTA}; color: white; padding: 12px 24px; text-decoration: none; font-weight: bold; border-radius: 6px; margin: 20px 0; font-size: 16px;`;
            const footerStyle = `background-color: ${D_PRIMARY_MED}; height: 5px; margin-top: 10px; border-radius: 0 0 8px 8px;`;

            // URL para formalizaciÃ³n
            const LB = '%0A';
            
            // MODIFICACIÃ“N: Nombre completo de la oferta consolidada
            const consolidatedTariffName = (offer.description?.length > offer.name?.length) 
                ? offer.description 
                : offer.name;

            const emailBody = `âœ… CONFIRMACIÃ“N OFERTA CONSOLIDADA - MULTICUPS${LB}${LB}` +
                                 `Estimado equipo de ${D_BRAND_NAME.toUpperCase()},${LB}${LB}` +
                                 `Confirmo mi aceptaciÃ³n de la oferta energÃ©tica consolidada para mÃºltiples suministros:${LB}${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                                 `ðŸ“Š RESUMEN CONSOLIDADO${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `âš¡ OFERTA:${LB}${consolidatedTariffName}${LB}${LB}` +
                                 `ðŸŒ Zona GeogrÃ¡fica: ${ZONA_GEOGRAFICA}${LB}` +
                                 `ðŸ”Œ Total Suministros: ${individualResults.length} CUPS${LB}${LB}` +
                                 `ðŸ“‹ CUPS INCLUIDOS:${LB}${bd.multiCupsList}${LB}${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                                 `ðŸ’° BENEFICIO ECONÃ“MICO TOTAL${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `ðŸ’µ Ahorro Anual Consolidado: ${eur(bd.savings)}${LB}` +
                                 `ðŸ“… Coste Mensual Total: ${eur(bd.totalAnnual / 12)}${LB}${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                                 `ðŸ‘¤ DATOS DEL TITULAR${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `ðŸ“› Nombre completo: ${clientName}${LB}` +
                                 `ðŸ“± TelÃ©fono: ${clientPhone}${LB}` +
                                 `ðŸ“§ Email: ${clientEmail}${LB}${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                                 `ðŸ“Ž DOCUMENTACIÃ“N POR CUPS${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `Adjunto la siguiente documentaciÃ³n para cada CUPS:${LB}${LB}` +
                                 `âœ“ 1. Foto DNI/CIF (anverso y reverso)${LB}` +
                                 `âœ“ 2. Ãšltima factura de cada suministro (mÃ­n. 3 meses)${LB}` +
                                 `âœ“ 3. Email de contacto${LB}` +
                                 `âœ“ 4. TelÃ©fono de contacto${LB}` +
                                 `âœ“ 5. NÃºmero de cuenta bancaria (IBAN)${LB}${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                                 `ðŸ’¬ COMENTARIOS ADICIONALES${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `[Escriba aquÃ­ cualquier observaciÃ³n o consulta adicional]${LB}${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `Quedo a la espera de la confirmaciÃ³n de la formalizaciÃ³n del contrato consolidado.${LB}${LB}` +
                                 `Atentamente,${LB}` +
                                 `${clientName}`;

            const subject = `âœ… FORMALIZACIÃ“N CONSOLIDADA - ${individualResults.length} CUPS`;
            const formalizationRecipients = 'f.araujo@drk.es,r.guerra@drk.es,s.caballero@drk.es';  
            const formalizationLink = `mailto:${formalizationRecipients}?subject=${encodeURIComponent(subject)}&body=${emailBody}`;

            // --- Precios de la Oferta Consolidada (Dynamic Winner) ---
            
            let preciosConsolidadosHTML = '';
            let priceSectionHeader;
            if (hasDrkWinner && comparisonMode !== 'overall_best') {
                priceSectionHeader = 'PRECIOS DE LAS OFERTAS SELECCIONADAS (DRK ENERGÃA)';
            } else if (!hasDrkWinner && comparisonMode === 'overall_best') {
                priceSectionHeader = 'PRECIOS DE LAS OFERTAS SELECCIONADAS (POWER CUP GLOBAL)';
            } else {
                priceSectionHeader = 'PRECIOS DE LAS OFERTAS SELECCIONADAS';
            }

            // 2.0TD Prices - TODAS las ofertas Ãºnicas
            const offers20 = winningOffers['2.0TD'];
            const has20TD = individualResults.some(d => d.originalTariffType === '2.0TD');
            if (offers20 && offers20.length > 0 && has20TD) {
                offers20.forEach((offer20, index) => {
                    const fullTariffName20 = `${offer20.name || 'Tarifa 2.0TD'} - ${offer20.description || 'N/A'}`; 
                    const p1 = offer20.p_potencia_1 / 365;
                    const p2 = offer20.p_potencia_2 / 365;
                    const e1 = offer20.p1_price;
                    const e2 = offer20.p2_price;
                    const e3 = offer20.p3_price;
                    
                    preciosConsolidadosHTML += `
                        <div style="margin-top: 15px; padding: 10px; background-color: #ffffff; border: 1px solid #ddd; border-radius: 6px;">
                            <p style="margin: 0 0 5px 0; font-weight: bold; font-size: 13px; color: ${D_PRIMARY_DARK};">Tarifa 2.0 TD #${index + 1} - ${fullTariffName20}</p>
                            <table width="100%" cellpadding="0" cellspacing="0" style="font-family: Arial, sans-serif; font-size: 11px; table-layout: fixed;">
                                <tr><td style="padding: 2px 0; width: 60%; color: #555;">P1 (â‚¬/kW/dÃ­a):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: #333;">${numPriceFormula(p1)}</td></tr>
                                <tr><td style="padding: 2px 0; color: #555;">P2 (â‚¬/kW/dÃ­a):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: #333;">${numPriceFormula(p2)}</td></tr>
                                <tr style="height: 5px;"><td colspan="2"></td></tr>
                                <tr><td style="padding: 2px 0; font-weight: bold; color: ${GREEN_SAVE};">ENERGÃA E1 (Punta - â‚¬/kWh):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: ${GREEN_SAVE};">${numPriceFormula(e1)}</td></tr>
                                <tr><td style="padding: 2px 0; font-weight: bold; color: ${GREEN_SAVE};">ENERGÃA E2 (Llano - â‚¬/kWh):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: ${GREEN_SAVE};">${numPriceFormula(e2)}</td></tr>
                                <tr><td style="padding: 2px 0; font-weight: bold; color: ${GREEN_SAVE};">ENERGÃA E3 (Valle - â‚¬/kWh):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: ${GREEN_SAVE};">${numPriceFormula(e3)}</td></tr>
                            </table>
                        </div>
                    `;
                });
            }

            // 3.0TD Prices - TODAS las ofertas Ãºnicas  
            const offers30 = winningOffers['3.0TD'];
            const has30TD = individualResults.some(d => d.originalTariffType === '3.0TD');
            if (offers30 && offers30.length > 0 && has30TD) {
                offers30.forEach((offer30, index) => {
                    let pRows = '';
                    for(let i=1; i<=6; i++) {
                        pRows += `<tr><td style="padding: 2px 0; color: #555;">P${i} (â‚¬/kW/dÃ­a):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: #333;">${numPriceFormula(offer30[`p_potencia_${i}`] / 365)}</td></tr>`;
                    }
                    let eRows = '';
                    for(let i=1; i<=6; i++) {
                        eRows += `<tr><td style="padding: 2px 0; font-weight: bold; color: ${GREEN_SAVE};">E${i} (â‚¬/kWh):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: ${GREEN_SAVE};">${numPriceFormula(offer30[`p${i}_price`])}</p></td></tr>`;
                    }
                    const fullTariffName30 = `${offer30.name || 'Tarifa 3.0TD'} - ${offer30.description || 'N/A'}`;

                    preciosConsolidadosHTML += `
                        <div style="margin-top: 15px; padding: 10px; background-color: #ffffff; border: 1px solid #ddd; border-radius: 6px;">
                            <p style="margin: 0 0 5px 0; font-weight: bold; font-size: 13px; color: ${D_PRIMARY_DARK};">Tarifa 3.0 TD #${index + 1} - ${fullTariffName30}</p>
                            <table width="100%" cellpadding="0" cellspacing="0" style="font-family: Arial, sans-serif; font-size: 11px; table-layout: fixed;">
                                <tr><td colspan="2" style="font-weight: bold; color: ${RED_CTA}; padding: 5px 0 2px 0;">POTENCIA</td></tr>
                                ${pRows}
                                <tr><td colspan="2" style="font-weight: bold; color: ${GREEN_SAVE}; padding: 5px 0 2px 0; border-top: 1px dashed #ccc; margin-top: 5px;">ENERGÃA</td></tr>
                                ${eRows}
                            </table>
                        </div>
                    `;
                });
            }
            
            const preciosResumenSection = preciosConsolidadosHTML ? `
                <tr><td colspan="2" style="padding: 20px 20px 0 20px;"><div style="${sectionTitle}">${priceSectionHeader}</div></td></tr>
                <tr><td colspan="2" style="padding: 0 20px 20px 20px;">
                    ${preciosConsolidadosHTML}
                </td></tr>
            ` : '';
            
            // FIX 2: NUEVO RESUMEN DE AHORRO CONSOLIDADO justo antes del botÃ³n
            const finalMultiSavingsSummary = `
                <tr><td colspan="2" style="padding: 0 20px 0 20px; text-align: center;">
                    <div style="text-align: center; margin: 15px 0 5px 0;">
                        <p style="margin: 0; font-size: 16px; color: #555; font-weight: bold;">${tr('AHORRO TOTAL CONSOLIDADO')}</p>
                    </div>
                    <div style="background-color: ${BG_LIGHT}; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px;">
                        <p style="margin: 0; font-size: 14px; color: #555;">${tr('TU AHORRO ANUAL ESTIMADO ES:')}</p>
                        <span style="font-size: 32px; font-weight: bold; color: ${GREEN_SAVE}; display: block; margin-top: 5px; white-space: nowrap;">${eur(bd.savings)}</span>
                        <p style="font-size: 12px; color: #888;">${tr('/ AÃ‘O')}</p>
                    </div>
                </td></tr>
            `;

            // NUEVO: Banner de empresa para email MultiCups
            const isDrkBrand = dynamicBrand.NAME.includes('DRK');
            const companyBanner = isDrkBrand ? `
                <table cellpadding="0" cellspacing="0" width="600" style="width: 600px; max-width: 100%; margin: 0 auto 20px auto; border-collapse: collapse; background-color: #075985; font-family: Arial, sans-serif;">
                    <tr>
                        <td style="padding: 20px 20px 20px 20px; vertical-align: middle; width: 60%;">
                            <p style="margin: 0; padding: 0; color: #ffffff; font-size: 28px; font-weight: bold; line-height: 1.2;">DRK ENERGÃA</p>
                            <p style="margin: 5px 0 0 0; padding: 0; color: #bae6fd; font-size: 13px; line-height: 1.3;">Liderando el ahorro y la eficiencia energÃ©tica.</p>
                        </td>
                        <td style="padding: 20px 20px 20px 10px; text-align: right; vertical-align: middle; width: 40%;">
                            <p style="margin: 0; padding: 0; color: #e0f2fe; font-size: 9px; font-weight: bold; text-transform: uppercase;">ESTUDIO DE AHORRO</p>
                            <p style="margin: 3px 0 0 0; padding: 0; color: #ffffff; font-size: 14px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                        </td>
                    </tr>
                </table>
            ` : `
                <table cellpadding="0" cellspacing="0" width="600" style="width: 600px; max-width: 100%; margin: 0 auto 20px auto; border-collapse: collapse; background-color: #ffffff; border: 2px solid #84cc16; font-family: Arial, sans-serif;">
                    <tr>
                        <td style="padding: 20px 20px 20px 20px; vertical-align: middle; width: 60%;">
                            <p style="margin: 0; padding: 0; color: #365314; font-size: 28px; font-weight: bold; line-height: 1.2;">POWER CUP</p>
                            <p style="margin: 5px 0 0 0; padding: 0; color: #4d7c0f; font-size: 13px; font-weight: bold; line-height: 1.3;">AsesorÃ­a EnergÃ©tica</p>
                        </td>
                        <td style="padding: 20px 20px 20px 10px; text-align: right; vertical-align: middle; width: 40%;">
                            <p style="margin: 0; padding: 0; color: #65a30d; font-size: 9px; font-weight: bold; text-transform: uppercase;">ESTUDIO DE AHORRO</p>
                            <p style="margin: 3px 0 0 0; padding: 0; color: #365314; font-size: 14px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                        </td>
                    </tr>
                </table>
            `;

            return companyBanner + `<table cellpadding="0" cellspacing="0" style="${tableMain}">
                    <tr><td colspan="2" style="${headerCell}">
                        <h1 style="margin:0; font-size: 24px;">ESTUDIO CONSOLIDADO DE AHORRO</h1>
                        <p style="margin:5px 0 0 0; font-size: 14px; opacity: 0.9;">ANÃLISIS DE ${individualResults.length} SUMINISTROS (2.0TD + 3.0TD)</p>
                    </td></tr>
                    
                    <tr><td colspan="2" style="padding: 15px;">
                        <p style="margin: 0; font-size: 13px;"><strong${tr("CLIENTE:")}</strong> ${clientName}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;"><strong>TOTAL CUPS:</strong> ${individualResults.length}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;"><strong>OFERTA CONSOLIDADA:</strong> ${consolidatedTariffName}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;"><strong${tr("COMERCIAL:")}</strong> ${commercialCode || 'N/A'}</p>
                    </td></tr>

                    <tr><td colspan="2" style="padding: 0 20px;">
                        <div style="text-align: center; margin: 25px 0 10px 0;">
                            <p style="margin: 0; font-size: 16px; color: #555; font-weight: bold;">AHORRO ANUAL CONSOLIDADO:</p>
                        </div>
                        <div style="${savingsBox}">
                            <span style="font-size: 38px; white-space: nowrap;">${eur(bd.savings)}</span>
                            <p style="margin: 5px 0 0 0; font-size: 18px; font-weight: bold;">Â¡AHORRO TOTAL PARA ${individualResults.length} SUMINISTROS!</p>
                        </div>
                    </td></tr>

                    <tr><td colspan="2" style="padding: 0 20px;">
                        <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom: 20px; table-layout: fixed;">
                            <tr>
                                <td style="width: 50%; padding: 15px; background-color: #f9fafb; border: 1px solid #ddd; text-align: center; vertical-align: top;">
                                    <div style="font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase;">COSTE ACTUAL ANUAL</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #ef4444; margin: 5px 0; text-decoration: line-through; white-space: nowrap;">${eur(bd.originalBillAnnual)}</div>
                                    <div style="font-size: 11px; color: #666;">${tr('/ AÃ‘O')}</div>
                                </td>
                                <td style="width: 50%; padding: 15px; background-color: ${BG_LIGHT}; border: 1px solid ${D_PRIMARY_MED}; text-align: center; vertical-align: top;">
                                    <div style="font-size: 11px; font-weight: bold; color: ${D_PRIMARY_MED}; text-transform: uppercase;">NUEVO COSTE ${D_BRAND_NAME.toUpperCase()} ANUAL</div>
                                    <div style="font-size: 24px; font-weight: bold; color: ${D_PRIMARY_DARK}; margin: 5px 0; white-space: nowrap;">${eur(bd.totalAnnual)}</div>
                                    <div style="font-size: 11px; color: ${D_PRIMARY_MED};">${tr('/ AÃ‘O')}</div>
                                    <div style="font-size: 13px; font-weight: bold; color: ${D_PRIMARY_DARK}; margin-top: 5px; white-space: nowrap;">${eur(bd.totalAnnual/12)} ${tr('/ MES')}</div>
                                </td>
                            </tr>
                        </table>
                    </td></tr>
                    
                    ${preciosResumenSection}
                    
                    <tr><td colspan="2"><div style="background-color: ${D_PRIMARY_MED}; color: white; font-weight: bold; padding: 8px; font-size: 14px; margin-top: 10px;">DESGLOSE INDIVIDUAL DE AHORRO</div></td></tr>
                    ${individualBreakdowns}
                    
                    ${finalMultiSavingsSummary}

                    <tr><td colspan="2" style="text-align: center; padding: 20px; background-color: #f8f9fa;">
                        <div style="max-width: 500px; margin: 0 auto; padding: 20px; background: white; border-radius: 10px; border: 2px solid ${D_PRIMARY_MED};">
                            <p style="margin: 0 0 15px 0; font-size: 16px; font-weight: bold; color: ${D_PRIMARY_DARK};">${tr('ðŸ“§ Para confirmar esta oferta:')}</p>
                            <p style="margin: 0 0 15px 0; font-size: 13px; color: #555; line-height: 1.6;">
                                1. ${tr('Haz clic en el botÃ³n de abajo')}<br>
                                2. ${tr('Se abrirÃ¡ tu cliente de email')}<br>
                                3. <strong style="color: ${D_PRIMARY_DARK};">${tr('Adjunta la documentaciÃ³n requerida')}</strong><br>
                                4. ${tr('EnvÃ­a el email')}
                            </p>
                            <a href="${formalizationLink}" style="${btnStyle}">${tr('âœ… CONFIRMAR Y ENVIAR')}</a>
                            <p style="margin: 15px 0 0 0; font-size: 11px; color: #666; line-height: 1.5;">
                                ${tr('ðŸ“„ <strong>DocumentaciÃ³n necesaria:</strong><br>')}
                                ${tr('DNI/CIF Â· Ãšltima factura Â· Email Â· TelÃ©fono Â· IBAN')}
                            </p>
                        </div>
                        <p style="font-size: 10px; color: #999; margin-top: 15px;">[Colaborador: ${commercialCode}] | Este resumen es una simulaciÃ³n consolidada de ${individualResults.length} suministros.</p>
                    </td></tr>

                    <tr><td colspan="2" style="padding: 0; height: 5px;"><div style="${footerStyle}"></div></td></tr>
                </table>`;
        }

        // --- MANEJO DE INPUTS MANUALES ---

        function handleManualInput() {
            try {
                console.log('handleManualInput called');
                console.log('currentTariffType:', currentTariffType);
                console.log('comparisonMode:', comparisonMode);
                console.log('optimizedPowerEnabled:', window.optimizedPowerEnabled);
                
                const isMultiCupsMode = currentTariffType === 'MULTICUPS';

                // Usar multiCupsAddType o currentTariffType para el cÃ¡lculo
                const tariffToUse = isMultiCupsMode ? multiCupsAddType : currentTariffType;
                console.log('tariffToUse:', tariffToUse);
                
                if (!tariffToUse) return window.showErrorModal("Error: Seleccione un tipo de tarifa (2.0TD o 3.0TD).");
                
                const getVal = id => parseFloat(document.getElementById(id).value.replace(',','.')) || 0;
                
                const data = {
                    cups: document.getElementById('input-cups').value || 'MANUAL',
                    dias_facturados: parseInt(document.getElementById('input-billing-days').value) || 30,
                    importe_total: getVal('input-total-bill'),
                    fechas: 'Entrada Manual',
                };

                for(let i=1; i<=6; i++) {
                    data[`potencia_p${i}_kw`] = getVal(`input-p${i}-kw`);
                    data[`consumo_p${i}`] = getVal(`input-e${i}-kwh`);
                }
                
                // Llenar consumo_punta/llano/valle para 2.0TD (basado en E1, E2, E3)
                data['consumo_punta'] = data.consumo_p1;
                data['consumo_llano'] = data.consumo_p2;
                data['consumo_valle'] = data.consumo_p3;
                
                console.log('Data prepared:', data);
                
                if (data.importe_total <= 0) return window.showErrorModal("Introduce el total de la factura.");
                
                // NUEVO: Si estÃ¡ activado el comparativo de potencias optimizadas para 3.0TD
                if (window.optimizedPowerEnabled && tariffToUse === '3.0TD' && !isMultiCupsMode) {
                    const optimizedPowers = getOptimizedPowerData();
                    
                    // Validar que se hayan introducido potencias optimizadas
                    if (!optimizedPowers || (optimizedPowers.p1 === 0 && optimizedPowers.p2 === 0)) {
                        return window.showErrorModal("Por favor, introduce las potencias optimizadas.");
                    }
                    
                    // Crear datos con potencias optimizadas
                    const dataOptimized = {...data};
                    for(let i=1; i<=6; i++) {
                        dataOptimized[`potencia_p${i}_kw`] = optimizedPowers[`p${i}`];
                    }
                    
                    // Guardar ambos escenarios en variables globales
                    window.currentPowerScenario = data;
                    window.optimizedPowerScenario = dataOptimized;
                    
                    console.log('Dual power comparison enabled');
                    console.log('Current powers:', data);
                    console.log('Optimized powers:', dataOptimized);
                    
                    closeManualInputModal();
                    
                    // Calcular ambos escenarios
                    compareOffersDualPower(data, dataOptimized);
                    return;
                }
                
                closeManualInputModal();
                
                if (isMultiCupsMode) {
                    console.log('Saving supply for MultiCups - requesting address first');
                    // En modo Multicups, primero solicitar la direcciÃ³n del suministro
                    showSupplyAddressModal(data, tariffToUse);
                } else {
                    console.log('Comparing offers for single tariff');
                    compareOffers(data);
                }
            } catch (error) {
                console.error('Error in handleManualInput:', error);
                window.showErrorModal(`Error al procesar datos: ${error.message}`);
            }
        }
        
        function startManualInputFlow() {
            const isMultiCupsMode = currentTariffType === 'MULTICUPS';
            const isDualMode = window.dualMode === true;
            const tariffToConfigure = isMultiCupsMode ? multiCupsAddType : currentTariffType;
            
            if (isMultiCupsMode && !tariffToConfigure) return window.showErrorModal("Error interno: Seleccione primero 2.0 TD o 3.0 TD en la pantalla anterior.");
            
            // 1. Limpiar inputs
            clearManualInputs('input');
            
            // 2. Configurar el modal para modo Individual, Multi o DUAL
            const selectorWrapper = document.getElementById('manual-tariff-selector-wrapper');
            const selectEl = document.getElementById('manual-input-tariff-select');
            const modalTitleEl = document.getElementById('manual-modal-title');
            
            if (isMultiCupsMode) {
                // MODO MULTICUPS: Ocultamos el selector ya que el tipo es conocido
                selectorWrapper.classList.add('hidden');
                modalTitleEl.textContent = tr('AÃ±adir Suministro') + ` #${multiCupsData.length + 1} (${tariffToConfigure} Manual)`;
                document.getElementById('execute-manual-input-btn').textContent = tr('AÃ‘ADIR SUMINISTRO');
                
                // IMPORTANTE: En modo MULTICUPS, SIEMPRE ocultar la opciÃ³n de potencias optimizadas
                const optimizedToggleWrapper = document.getElementById('optimized-power-toggle-wrapper');
                if (optimizedToggleWrapper) {
                    optimizedToggleWrapper.classList.add('hidden');
                }
                
                // Desactivar el checkbox de potencias optimizadas si estaba activado
                const optimizedCheckbox = document.getElementById('enable-optimized-power');
                if (optimizedCheckbox) {
                    optimizedCheckbox.checked = false;
                    window.optimizedPowerEnabled = false;
                }
                
                // Ocultar los campos de potencias optimizadas si estaban visibles
                const optimizedFields = document.getElementById('optimized-power-fields');
                if (optimizedFields) {
                    optimizedFields.classList.add('hidden');
                }
                
                // Forzar la selecciÃ³n del tipo de CUPS seleccionado en la vista SAGA
                // Solo si el tipo existe en el selector (2.0TD o 3.0TD)
                if (selectEl.querySelector(`option[value="${tariffToConfigure}"]`)) {
                    selectEl.value = tariffToConfigure;
                }
                toggleMultiCupsInputPeriods(tariffToConfigure, 'input');

            } else if (isDualMode) {
                // MODO DUAL: Ocultar selector y opciÃ³n de optimizaciÃ³n
                selectorWrapper.classList.add('hidden');
                modalTitleEl.textContent = tr('Entrada de Datos Manual') + ` (${currentTariffType})`;
                document.getElementById('execute-manual-input-btn').textContent = tr("CALCULAR");
                
                // IMPORTANTE: En modo DUAL, SIEMPRE ocultar la opciÃ³n de potencias optimizadas
                const optimizedToggleWrapper = document.getElementById('optimized-power-toggle-wrapper');
                if (optimizedToggleWrapper) {
                    optimizedToggleWrapper.classList.add('hidden');
                }
                
                // Desactivar el checkbox de potencias optimizadas si estaba activado
                const optimizedCheckbox = document.getElementById('enable-optimized-power');
                if (optimizedCheckbox) {
                    optimizedCheckbox.checked = false;
                    window.optimizedPowerEnabled = false;
                }
                
                // Ocultar los campos de potencias optimizadas si estaban visibles
                const optimizedFields = document.getElementById('optimized-power-fields');
                if (optimizedFields) {
                    optimizedFields.classList.add('hidden');
                }
                
                toggleMultiCupsInputPeriods(currentTariffType, 'input');
                
            } else {
                // MODO INDIVIDUAL: Ocultar selector (solo se usa la tarifa seleccionada en el landing)
                selectorWrapper.classList.add('hidden');
                modalTitleEl.textContent = tr('Entrada de Datos Manual') + ` (${currentTariffType})`;
                document.getElementById('execute-manual-input-btn').textContent = tr("CALCULAR");
                toggleMultiCupsInputPeriods(currentTariffType, 'input');
            }

            // 3. Mostrar Modal
            document.getElementById('manual-input-modal').classList.remove('hidden');
            document.getElementById('manual-input-modal').classList.add('flex');
            document.getElementById('input-cups').focus();
            
            // CRÃTICO: Traducir contenido del modal
            if (window.translateAll) {
                setTimeout(() => window.translateAll(), 50);
            }
        }

        function updateComparisonMode(newMode) {
            comparisonMode = newMode;
            let currentBrandForInput = BRANDS.DRK;
            if (newMode === 'overall_best') currentBrandForInput = BRANDS.POWER_CUP;
            // Aplicar estilos y branding a toda la app
            applyBrandStyles(currentBrandForInput);
            
            // Actualizar estilos especÃ­ficos de los selectores de modo
            document.querySelectorAll('input[name="comparison_mode"]').forEach(r => {
                const label = r.closest('label');
                const isSelected = r.value === newMode;
                const colorClass = r.value === 'overall_best' ? 'powercup' : 'drk';
                
                // Limpiar todas las clases de color
                label.className = 'mode-selector flex-1 px-2 py-2 rounded-lg cursor-pointer transition border-2';

                if (isSelected) {
                    // BotÃ³n SELECCIONADO: fondo de color, texto blanco
                    label.classList.add(`border-${colorClass}-500`, `bg-${colorClass}-500`, 'text-white', `hover:bg-${colorClass}-600`);
                    label.querySelector('.checkmark-icon').classList.remove('hidden');
                } else {
                    // BotÃ³n NO SELECCIONADO: fondo blanco, texto de color oscuro
                    label.classList.add(`border-${colorClass}-300`, 'bg-white', `text-${colorClass}-700`, `hover:bg-${colorClass}-100`, `hover:border-${colorClass}-400`);
                    label.querySelector('.checkmark-icon').classList.add('hidden');
                }
            });
        }
        
        // --- NUEVA FUNCIONALIDAD: Tipo de SelecciÃ³n de Oferta ---
        
        function updateOfferSelectionType(newType) {
            offerSelectionType = newType;
            
            // Actualizar estilos de los botones de tipo de selecciÃ³n
            document.querySelectorAll('input[name="offer_selection_type"]').forEach(r => {
                const container = r.closest('.offer-type-selector').querySelector('div');
                const isSelected = r.value === newType;
                
                if (isSelected) {
                    container.className = 'flex items-start gap-3 p-4 rounded-xl border-2 border-drk-500 bg-drk-500 text-white transition hover:bg-drk-600';
                } else {
                    container.className = 'flex items-start gap-3 p-4 rounded-xl border-2 border-slate-300 bg-white text-slate-700 transition hover:bg-slate-50 hover:border-drk-400';
                }
            });
        }
        
        // --- NUEVO: Modal de DecisiÃ³n (Mejor vs Elegir) ---
        
        function showOfferDecisionModal() {
            document.getElementById('loading-status').classList.add('hidden');
            document.getElementById('offer-decision-modal').classList.remove('hidden');
            document.getElementById('offer-decision-modal').classList.add('flex');
            
            // CRÃTICO: Traducir contenido del modal
            if (window.translateAll) {
                setTimeout(() => window.translateAll(), 50);
            }
            
            // Ocultar el selector de tarifa al abrir el modal (se mostrarÃ¡ solo si es necesario)
            document.getElementById('best-option-tariff-selector')?.classList.add('hidden');
            
            // NUEVO: Si hay comparativo de potencias optimizadas activo O es modo DUAL, OCULTAR el checkbox de Fijo & Indexado
            const checkboxContainer = document.getElementById('powercup-indexed-comparison-checkbox');
            const isDualMode = window.dualMode === true;
            
            if (window.optimizedPowerEnabled || isDualMode) {
                if (isDualMode) {
                    console.log('ðŸ”„ Modo DUAL activo - Ocultando checkbox Fijo & Indexado');
                } else {
                    console.log('âš¡ OptimizaciÃ³n de potencias activa - Ocultando checkbox Fijo & Indexado');
                }
                checkboxContainer?.classList.add('hidden');
                // Asegurar que el checkbox estÃ© desmarcado
                const indexedCheckbox = document.getElementById('compare-with-indexed');
                if (indexedCheckbox) {
                    indexedCheckbox.checked = false;
                    compareWithIndexed = false;
                }
            } else {
                // IMPORTANTE: El checkbox de comparaciÃ³n visible solo si NO es DUAL y NO hay optimizaciÃ³n
                checkboxContainer?.classList.remove('hidden');
            }
            
            // NUEVO: Actualizar textos y colores del selector segÃºn la marca activa
            const isDrkMode = activeBrand.NAME.includes('DRK');
            const brandName = isDrkMode ? 'DRK' : 'POWER CUP';
            const primaryColor = isDrkMode ? 'drk' : 'powercup';
            
            // Actualizar tÃ­tulo del selector
            const selectorTitle = document.getElementById('tariff-selector-title');
            if (selectorTitle) {
                selectorTitle.textContent = `ðŸŽ¯ Â¿QuÃ© tipo de tarifa quieres ver?`;
            }
            
            // Actualizar descripciÃ³n de tarifa INDEXADA
            const indexadaTitle = document.getElementById('tarifa-indexada-title');
            const indexadaDesc = document.getElementById('tarifa-indexada-desc');
            if (indexadaTitle && indexadaDesc) {
                indexadaTitle.textContent = 'ðŸŒ± Tarifa INDEXADA (DRK INDEX)';
                indexadaDesc.textContent = 'Solo muestra DRK INDEX del mercado';
            }
            
            // Actualizar botÃ³n de continuar
            const continueBtn = document.getElementById('tariff-selector-continue-btn');
            if (continueBtn) {
                continueBtn.className = `w-full mt-3 bg-${primaryColor}-600 hover:bg-${primaryColor}-700 text-white font-bold py-3 rounded-lg transition`;
            }
            
            // Resetear selector a FIJA por defecto
            const fijaRadio = document.querySelector('input[name="best-option-tariff-type"][value="fija"]');
            if (fijaRadio) {
                fijaRadio.checked = true;
                updateBestOptionTariffChoice('fija');
            }
            
            // CRÃTICO: Traducir contenido del modal
            if (window.translateAll) {
                setTimeout(() => window.translateAll(), 50);
            }
        }
        
        function closeOfferDecisionModal() {
            document.getElementById('offer-decision-modal').classList.add('hidden');
            document.getElementById('offer-decision-modal').classList.remove('flex');
        }
        
        // NUEVO: Funciones para el modal de modo de presentaciÃ³n
        function showPresentationModeModal() {
            document.getElementById('pdf-presentation-mode-modal').classList.remove('hidden');
            document.getElementById('pdf-presentation-mode-modal').classList.add('flex');
            
            // Resetear a "Dos Columnas" por defecto
            document.getElementById('mode-two-columns').checked = true;
        }
        
        function closePresentationModeModal() {
            document.getElementById('pdf-presentation-mode-modal').classList.add('hidden');
            document.getElementById('pdf-presentation-mode-modal').classList.remove('flex');
        }
        
        async function confirmPresentationMode() {
            const selectedMode = document.querySelector('input[name="presentation-mode"]:checked').value;
            console.log('ðŸ“Š Modo seleccionado:', selectedMode);
            
            // Activar bandera para evitar que se vuelva a mostrar el modal
            window.pdfModeAlreadySelected = true;
            
            closePresentationModeModal();
            
            // Llamar a la funciÃ³n de generaciÃ³n PDF con el modo seleccionado
            await handleGeneratePDF_DualPower(selectedMode);
            
            // Resetear bandera despuÃ©s de generar el PDF
            window.pdfModeAlreadySelected = false;
        }
        
        // NUEVA: Manejar click en VER MEJOR OPCIÃ“N
        function handleBestOptionClick() {
            const selectorDiv = document.getElementById('best-option-tariff-selector');
            const checkboxContainer = document.getElementById('powercup-indexed-comparison-checkbox');
            
            // Detectar contexto
            const isDrkMode = comparisonMode !== 'overall_best';
            const isIndividual = currentTariffType !== 'MULTICUPS';
            const isDualMode = window.dualMode === true;
            
            // IMPORTANTE: En modo DUAL, siempre ocultar el checkbox
            if (isDualMode) {
                console.log('ðŸ”„ Modo DUAL: Ocultando checkbox de comparaciÃ³n indexada');
                if (checkboxContainer) checkboxContainer.classList.add('hidden');
            }
            
            if (isDrkMode) {
                // DRK (Individual o MULTICUPS)
                
                if (compareWithIndexed) {
                    // CHECK MARCADO: Comparar automÃ¡ticamente FIJO vs INDEXADO (NO mostrar selector)
                    console.log('DRK con CHECK marcado: Comparando automÃ¡ticamente FIJO vs INDEXADO');
                    selectorDiv?.classList.add('hidden');
                    // Solo mostrar checkbox si NO es modo DUAL
                    if (checkboxContainer && !isDualMode) checkboxContainer.classList.remove('hidden');
                    selectBestOptionDirect(); // Ejecutar directamente
                } else {
                    // CHECK NO MARCADO: Mostrar selector para elegir FIJA o INDEXADA
                    console.log('DRK sin CHECK: Mostrando selector de tipo de tarifa');
                    selectorDiv?.classList.remove('hidden');
                    // OCULTAR checkbox porque el usuario va a elegir un solo tipo
                    if (checkboxContainer) checkboxContainer.classList.add('hidden');
                }
            } else {
                // POWER CUP
                
                if (compareWithIndexed) {
                    // CHECK MARCADO: Comparar automÃ¡ticamente FIJO vs INDEXADO (NO mostrar selector)
                    console.log('POWER CUP con CHECK marcado: Comparando automÃ¡ticamente FIJO vs INDEXADO');
                    selectorDiv?.classList.add('hidden');
                    if (checkboxContainer) checkboxContainer.classList.remove('hidden');
                    selectBestOptionDirect(); // Ejecutar directamente
                } else {
                    // CHECK NO MARCADO: Mostrar selector para elegir FIJA o INDEXADA
                    console.log('POWER CUP sin CHECK: Mostrando selector de tipo de tarifa');
                    selectorDiv?.classList.remove('hidden');
                    // OCULTAR checkbox porque el usuario va a elegir un solo tipo
                    if (checkboxContainer) checkboxContainer.classList.add('hidden');
                }
            }
        }
        
        // NUEVA: Actualizar elecciÃ³n de tipo de tarifa
        function updateBestOptionTariffChoice(choice) {
            bestOptionTariffChoice = choice;
            console.log('Tipo de tarifa seleccionada en VER MEJOR OPCIÃ“N:', choice);
            
            // Actualizar estilos visuales de los labels segÃºn la marca activa
            const fijaLabel = document.getElementById('best-fija-label');
            const indexadaLabel = document.getElementById('best-indexada-label');
            
            // Detectar si es DRK o POWER CUP
            const isDrkMode = activeBrand.NAME.includes('DRK');
            const primaryColor = isDrkMode ? 'drk' : 'powercup';
            const accentColor = isDrkMode ? 'drk' : 'green';
            
            if (choice === 'fija') {
                fijaLabel.className = `flex items-center gap-3 p-3 rounded-lg border-2 border-${primaryColor}-500 bg-${primaryColor}-50 cursor-pointer transition hover:bg-${primaryColor}-100`;
                indexadaLabel.className = `flex items-center gap-3 p-3 rounded-lg border-2 border-slate-200 bg-white cursor-pointer transition hover:bg-${accentColor}-50`;
            } else {
                fijaLabel.className = `flex items-center gap-3 p-3 rounded-lg border-2 border-slate-200 bg-white cursor-pointer transition hover:bg-${primaryColor}-50`;
                indexadaLabel.className = `flex items-center gap-3 p-3 rounded-lg border-2 border-${accentColor}-500 bg-${accentColor}-50 cursor-pointer transition hover:bg-${accentColor}-100`;
            }
        }
        
        // NUEVA: Ejecutar VER MEJOR OPCIÃ“N con la elecciÃ³n de tarifa
        function selectBestOptionWithChoice() {
            console.log('=================================================');
            console.log('âš¡âš¡âš¡ selectBestOptionWithChoice LLAMADA âš¡âš¡âš¡');
            
            // PROTECCIÃ“N: Prevenir llamadas concurrentes
            if (isProcessingBestOption) {
                console.warn('âš ï¸âš ï¸âš ï¸ LLAMADA CONCURRENTE DETECTADA Y BLOQUEADA');
                console.warn('Ya hay una ejecuciÃ³n de selectBestOptionWithChoice en curso');
                return;
            }
            
            isProcessingBestOption = true;
            console.log('âœ… Bandera isProcessingBestOption activada');
            
            console.log('ElecciÃ³n:', bestOptionTariffChoice);
            console.log('dualMode:', window.dualMode);
            console.log('lastComparisonResult exists:', !!lastComparisonResult);
            console.log('availableOffers.length:', availableOffers.length);
            console.log('=================================================');
            
            // CRÃTICO: Cerrar INMEDIATAMENTE el modal para prevenir eventos duplicados
            closeOfferDecisionModal();
            console.log('âœ… Modal cerrado inmediatamente');
            
            // Cerrar el selector
            document.getElementById('best-option-tariff-selector')?.classList.add('hidden');
            
            // CRÃTICO: Guardar el estado ORIGINAL del CHECK antes de modificarlo
            const checkboxOriginal = document.getElementById('compare-indexed-checkbox');
            const hadCheckMarked = checkboxOriginal ? checkboxOriginal.checked : compareWithIndexed;
            
            console.log('ðŸ” CHECK estaba marcado originalmente:', hadCheckMarked ? 'SÃ' : 'NO');
            console.log('Usuario eligiÃ³ tarifa:', bestOptionTariffChoice);
            
            // CRÃTICO: Preservar _multiCupsContext ANTES de reasignar lastComparisonResult
            const preservedContext = lastComparisonResult?._multiCupsContext 
                ? JSON.parse(JSON.stringify(lastComparisonResult._multiCupsContext))
                : null;
            
            console.log('ðŸ” Contexto MULTICUPS preservado en selectBestOptionWithChoice:', preservedContext ? 'SÃ' : 'NO');
            
            // NUEVA LÃ“GICA: Determinar si estamos en modo DRK o POWER CUP
            const isDrkMode = activeBrand.NAME.includes('DRK');
            console.log('ðŸ” Modo activo:', isDrkMode ? 'DRK' : 'POWER CUP');
            console.log('ðŸ” bestOptionTariffChoice:', bestOptionTariffChoice);
            console.log('ðŸ” availableOffers total:', availableOffers.length);
            
            // Filtrar availableOffers segÃºn la elecciÃ³n Y el modo
            let filteredOffersChosen = availableOffers.filter(offer => {
                const offerName = (offer.offer.name || '').toUpperCase();
                const offerDesc = (offer.offer.description || '').toUpperCase();
                const isIndexed = offerName.includes('INDEX') || offerDesc.includes('INDEX');
                const isDrkOffer = offer.offer.isDrk === true;
                
                // LOG: Ver cada oferta
                console.log(`  - ${offer.offer.name}: isIndexed=${isIndexed}, isDrkOffer=${isDrkOffer}`);
                
                if (bestOptionTariffChoice === 'indexada') {
                    // Usuario eligiÃ³ INDEXADA â†’ Solo DRK INDEX (siempre)
                    const result = isIndexed && isDrkOffer;
                    if (result) console.log(`    âœ… INCLUIDA (INDEXADA)`);
                    return result;
                } else {
                    // Usuario eligiÃ³ FIJA
                    if (isDrkMode) {
                        // Modo DRK â†’ Solo tarifas FIJAS de DRK
                        const result = !isIndexed && isDrkOffer;
                        if (result) console.log(`    âœ… INCLUIDA (FIJA DRK)`);
                        return result;
                    } else {
                        // Modo POWER CUP â†’ Tarifas FIJAS de cualquier comercializadora
                        const result = !isIndexed;
                        if (result) console.log(`    âœ… INCLUIDA (FIJA cualquiera)`);
                        return result;
                    }
                }
            });
            
            console.log('Ofertas filtradas del tipo elegido:', filteredOffersChosen.length, 'de', availableOffers.length);
            
            if (filteredOffersChosen.length === 0) {
                let mensaje;
                if (bestOptionTariffChoice === 'indexada') {
                    mensaje = 'No se encontraron tarifas INDEXADAS de DRK con ahorro positivo.';
                } else {
                    const origen = isDrkMode ? 'de DRK' : 'de cualquier comercializadora';
                    mensaje = `No se encontraron tarifas FIJAS ${origen} con ahorro positivo.`;
                }
                window.showErrorModal(mensaje);
                closeOfferDecisionModal();
                return;
            }
            
            // Seleccionar la mejor de las filtradas (del tipo elegido)
            let bestChosen = filteredOffersChosen.reduce((best, current) => {
                return (current.totalAnnual < best.totalAnnual) ? current : best;
            }, filteredOffersChosen[0]);
            
            console.log('âœ… Mejor tarifa del tipo elegido:', bestChosen.offer.name, 'Ahorro:', bestChosen.savings);
            console.log('   - Nombre completo:', bestChosen.offer.name);
            console.log('   - Es INDEXADA?:', (bestChosen.offer.name || '').toUpperCase().includes('INDEX'));
            console.log('   - bestOptionTariffChoice era:', bestOptionTariffChoice);
            
            // NUEVO: Si hay optimizaciÃ³n de potencias activa, necesitamos calcular tambiÃ©n con potencias ACTUALES
            if (window.lastDualPowerComparison) {
                console.log('âš¡ OptimizaciÃ³n de potencias detectada - Recalculando con potencias actuales');
                
                // Obtener las potencias actuales desde window.lastDualPowerComparison
                const actualData = window.lastDualPowerComparison.actual;
                const tariffType = actualData.originalTariffType || currentTariffType;
                
                // Recalcular la MISMA tarifa pero con potencias ACTUALES
                const resultWithActualPowers = calculateTariffCost(bestChosen.offer, actualData, tariffType);
                resultWithActualPowers.savings = resultWithActualPowers.originalBillAnnual - resultWithActualPowers.totalAnnual;
                
                console.log('âœ… Tarifa recalculada con potencias actuales:', resultWithActualPowers.offer.name);
                console.log('   - Con potencias actuales:', resultWithActualPowers.totalAnnual, 'â‚¬/aÃ±o');
                console.log('   - Con potencias optimizadas:', bestChosen.totalAnnual, 'â‚¬/aÃ±o');
                
                // Actualizar window.lastDualPowerComparison con los nuevos resultados
                window.lastDualPowerComparison.actual = resultWithActualPowers;
                window.lastDualPowerComparison.optimized = bestChosen;
                
                // Actualizar lastComparisonResult para compatibilidad
                lastComparisonResult = bestChosen;
                lastComparisonResult.isMulti = false;
                
                // Cerrar modal
                closeOfferDecisionModal();
                document.getElementById('best-option-tariff-selector')?.classList.add('hidden');
                
                // Renderizar vista dual directamente
                renderDualPowerResultsUI(resultWithActualPowers, bestChosen, window.lastDualPowerComparison.brand);
                
                document.getElementById('initial-view').classList.add('hidden');
                document.getElementById('scanner-view').classList.add('hidden');
                document.getElementById('results-view').classList.remove('hidden');
                document.getElementById('results-view').classList.add('animate-fade-in-up');
                
                // Resetear bandera
                setTimeout(() => {
                    isProcessingBestOption = false;
                    console.log('âœ… Bandera reseteada');
                }, 100);
                
                return; // IMPORTANTE: Salir aquÃ­
            }
            
            // SI EL CHECK ESTABA MARCADO: Calcular tambiÃ©n la mejor del tipo contrario
            let bestOtherType = null;
            if (hadCheckMarked) {
                console.log('ðŸ” CHECK estaba marcado â†’ Calculando mejor del tipo contrario para mantener comparaciÃ³n dual');
                
                // Filtrar ofertas del tipo contrario
                let filteredOffersOther = availableOffers.filter(offer => {
                    const offerName = (offer.offer.name || '').toUpperCase();
                    const offerDesc = (offer.offer.description || '').toUpperCase();
                    const isIndexed = offerName.includes('INDEX') || offerDesc.includes('INDEX');
                    const isDrkOffer = offer.offer.isDrk === true;
                    
                    if (bestOptionTariffChoice === 'indexada') {
                        // Usuario eligiÃ³ INDEXADA â†’ Calcular mejor FIJA
                        if (isDrkMode) {
                            // Modo DRK â†’ Solo tarifas FIJAS de DRK
                            return !isIndexed && isDrkOffer;
                        } else {
                            // Modo POWER CUP â†’ Tarifas FIJAS de cualquier comercializadora
                            return !isIndexed;
                        }
                    } else {
                        // Usuario eligiÃ³ FIJA â†’ Calcular mejor INDEXADA (siempre DRK INDEX)
                        return isIndexed && isDrkOffer;
                    }
                });
                
                if (filteredOffersOther.length > 0) {
                    bestOtherType = filteredOffersOther.reduce((best, current) => {
                        return (current.totalAnnual < best.totalAnnual) ? current : best;
                    }, filteredOffersOther[0]);
                    
                    console.log('âœ… Mejor del tipo contrario:', bestOtherType.offer.name, 'Ahorro:', bestOtherType.savings);
                } else {
                    console.warn('âš ï¸  No se encontraron ofertas del tipo contrario');
                }
            }
            
            // Decidir quÃ© es FIJO y quÃ© es INDEXADO segÃºn lo que eligiÃ³ el usuario
            let resFijo, resIndexado;
            if (bestOptionTariffChoice === 'indexada') {
                // Usuario eligiÃ³ INDEXADA
                resIndexado = bestChosen;
                resFijo = bestOtherType;
            } else {
                // Usuario eligiÃ³ FIJA
                resFijo = bestChosen;
                resIndexado = bestOtherType;
            }
            
            // Actualizar variables globales
            console.log('ðŸ” Asignando lastComparisonResult...');
            
            lastComparisonResult = resFijo || bestChosen;
            
            console.log('âœ… lastComparisonResult asignada, continuando...');
            
            console.log('ðŸ” Evaluando comparaciÃ³n dual...');
            
            if (hadCheckMarked && resIndexado) {
                // Mantener comparaciÃ³n dual
                lastIndexedResult = resIndexado;
                compareWithIndexed = true;
                console.log('âœ… Manteniendo comparaciÃ³n DUAL: FIJO vs INDEXADO');
            } else {
                // Sin comparaciÃ³n dual
                lastIndexedResult = null;
                compareWithIndexed = false;
                console.log('âš ï¸  Sin comparaciÃ³n dual (CHECK no estaba marcado o no hay tarifa del otro tipo)');
            }
            
            console.log('ðŸš€ Ejecutando continuaciÃ³n...');
            
            try {
                console.log('ðŸ” Restaurando contexto si existe...');
                
                // CRÃTICO: RESTAURAR el contexto preservado
                if (preservedContext) {
                    lastComparisonResult._multiCupsContext = preservedContext;
                    console.log('âœ… Contexto MULTICUPS restaurado');
                } else {
                    console.log('âš ï¸  Sin contexto MULTICUPS');
                }
                
                console.log('âœ… Contexto procesado');
                
                // âš¡âš¡âš¡ MODO DUAL - Usar flujo con direcciÃ³n âš¡âš¡âš¡
                if (window.dualMode === true) {
                    console.log('===== ðŸ”¥ MODO DUAL - Usando flujo con direcciÃ³n =====');
                    
                    // Preparar datos para el flujo unificado
                    const tariff = lastComparisonResult.tariffType || currentTariffType || '2.0TD';
                    const data = {
                        cups: lastComparisonResult.cups || 'CUPS-ELECTRICIDAD',
                        tariff: tariff,
                        kwh_p1: parseFloat(lastComparisonResult.kwh_p1) || 0,
                        kwh_p2: parseFloat(lastComparisonResult.kwh_p2) || 0,
                        kwh_p3: parseFloat(lastComparisonResult.kwh_p3) || 0,
                        kwh_p4: parseFloat(lastComparisonResult.kwh_p4) || 0,
                        kwh_p5: parseFloat(lastComparisonResult.kwh_p5) || 0,
                        kwh_p6: parseFloat(lastComparisonResult.kwh_p6) || 0,
                        p1: parseFloat(lastComparisonResult.p1) || 0,
                        p2: parseFloat(lastComparisonResult.p2) || 0,
                        p3: parseFloat(lastComparisonResult.p3) || 0,
                        p4: parseFloat(lastComparisonResult.p4) || 0,
                        p5: parseFloat(lastComparisonResult.p5) || 0,
                        p6: parseFloat(lastComparisonResult.p6) || 0,
                        dias: parseInt(lastComparisonResult.dias) || 30,
                        originalBillAnnual: lastComparisonResult.originalBillAnnual || (lastComparisonResult.importe_total || 0) * 12
                    };
                    
                    // Determinar costos segÃºn modo de comparaciÃ³n
                    const drkCost = lastComparisonResult.totalAnnual || 0;
                    const powercupCost = 0; // Solo hay un resultado en este flujo
                    
                    const results = {
                        drk: comparisonMode === 'overall_best' ? {
                            total: 0,
                            total_anual: 0
                        } : {
                            total: drkCost / 12,
                            total_anual: drkCost
                        },
                        powercup: comparisonMode === 'overall_best' ? {
                            total: drkCost / 12,
                            total_anual: drkCost
                        } : {
                            total: 0,
                            total_anual: 0
                        }
                    };
                    
                    console.log('Llamando a dualAddFromResults desde modal de decisiÃ³n');
                    
                    // Cerrar modales primero
                    const offerModal = document.getElementById('offer-decision-modal');
                    if (offerModal) {
                        offerModal.classList.add('hidden');
                        offerModal.classList.remove('flex');
                    }
                    
                    const tariffSelector = document.getElementById('best-option-tariff-selector');
                    if (tariffSelector) {
                        tariffSelector.classList.add('hidden');
                    }
                    
                    // Usar el flujo con modal de direcciÃ³n, pasando lastComparisonResult completo
                    window.dualAddFromResults('electricidad', tariff, data, results, lastComparisonResult);
                    
                    console.log('âœ… Usuario puede aÃ±adir mÃ¡s suministros');
                    
                    // Resetear bandera
                    setTimeout(() => {
                        isProcessingBestOption = false;
                        console.log('âœ… Bandera reseteada');
                    }, 100);
                    
                    return; // CRÃTICO: Salir aquÃ­
                }
                
                console.log('ðŸ” Ejecutando funciÃ³n apropiada...');
                
                try {
                    console.log('ðŸ” Verificando variables antes del if...');
                    
                    try {
                        console.log('  - hadCheckMarked:', hadCheckMarked);
                    } catch (e) {
                        console.error('  âŒ Error al acceder hadCheckMarked:', e.message);
                    }
                    
                    try {
                        console.log('  - resIndexado exists:', !!resIndexado);
                    } catch (e) {
                        console.error('  âŒ Error al acceder resIndexado:', e.message);
                    }
                    
                    console.log('ðŸ” Variables verificadas, evaluando if...');
                    
                    // CRÃTICO: Ejecutar segÃºn si hay comparaciÃ³n dual o no
                    if (hadCheckMarked && resIndexado) {
                        // Con comparaciÃ³n dual
                        console.log('â†’ Rama: CON comparaciÃ³n dual');
                        console.log('â†’ Llamando selectBestOptionDirectDual');
                        try {
                            selectBestOptionDirectDual();
                            console.log('âœ… selectBestOptionDirectDual ejecutada');
                        } catch (e) {
                            console.error('âŒ Error en selectBestOptionDirectDual:', e);
                        }
                    } else {
                        // Sin comparaciÃ³n dual
                        console.log('â†’ Rama: SIN comparaciÃ³n dual');
                        console.log('â†’ A punto de llamar selectBestOptionDirectSingle');
                        console.log('â†’ typeof selectBestOptionDirectSingle:', typeof selectBestOptionDirectSingle);
                        
                        try {
                            console.log('â†’ Ejecutando selectBestOptionDirectSingle()...');
                            selectBestOptionDirectSingle();
                            console.log('âœ… selectBestOptionDirectSingle ejecutada');
                        } catch (e) {
                            console.error('âŒ Error al llamar selectBestOptionDirectSingle:', e);
                            console.error('Error stack:', e.stack);
                        }
                    }
                    
                    console.log('âœ… FunciÃ³n lanzada');
                    
                    // Resetear bandera despuÃ©s de un pequeÃ±o delay para permitir que las funciones terminen
                    setTimeout(() => {
                        isProcessingBestOption = false;
                        console.log('âœ… Bandera isProcessingBestOption reseteada');
                    }, 100);
                } catch (outerError) {
                    console.error('âŒâŒâŒ ERROR AL EVALUAR IF O EJECUTAR FUNCIONES:');
                    console.error('Error message:', outerError.message);
                    console.error('Error stack:', outerError.stack);
                    console.error('Error completo:', outerError);
                    alert('Error crÃ­tico al ejecutar: ' + outerError.message);
                    
                    // Resetear bandera incluso si hay error
                    isProcessingBestOption = false;
                }
            } catch (error) {
                console.error('âŒâŒâŒ ERROR CRÃTICO en selectBestOptionWithChoice:');
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                console.error('Error completo:', error);
                alert('Error crÃ­tico: ' + error.message);
                
                // Resetear bandera incluso si hay error
                isProcessingBestOption = false;
                console.log('âœ… Bandera isProcessingBestOption reseteada (despuÃ©s de error)');
            }
        }
        
        // FunciÃ³n auxiliar: Extraer datos de consumo desde resultado
        function extractDataFromResult(result) {
            console.log('ðŸ“¦ extractDataFromResult INICIO');
            console.log('  - result.cups:', result?.cups);
            console.log('  - result.kwh_p1:', result?.kwh_p1);
            console.log('  - result.consumo_punta:', result?.consumo_punta);
            console.log('  - result.totalAnnual:', result?.totalAnnual);
            console.log('  - result.tariffType:', result?.tariffType);
            
            // Intentar mÃºltiples ubicaciones
            let kwh_p1 = 0, kwh_p2 = 0, kwh_p3 = 0, kwh_p4 = 0, kwh_p5 = 0, kwh_p6 = 0;
            let p1 = 0, p2 = 0, p3 = 0, p4 = 0, p5 = 0, p6 = 0;
            let dias = 30;
            let originalBillAnnual = 0;
            
            // OpciÃ³n 1: Desde result directamente
            if (result.kwh_p1 !== undefined) {
                console.log('  âœ… Usando OpciÃ³n 1: result.kwh_p1 existe');
                kwh_p1 = parseFloat(result.kwh_p1) || 0;
                kwh_p2 = parseFloat(result.kwh_p2) || 0;
                kwh_p3 = parseFloat(result.kwh_p3) || 0;
                kwh_p4 = parseFloat(result.kwh_p4) || 0;
                kwh_p5 = parseFloat(result.kwh_p5) || 0;
                kwh_p6 = parseFloat(result.kwh_p6) || 0;
                p1 = parseFloat(result.p1) || 0;
                p2 = parseFloat(result.p2) || 0;
                p3 = parseFloat(result.p3) || 0;
                p4 = parseFloat(result.p4) || 0;
                p5 = parseFloat(result.p5) || 0;
                p6 = parseFloat(result.p6) || 0;
                dias = parseInt(result.dias) || 30;
            }
            // OpciÃ³n 2: Desde QR (nombres alternativos)
            else if (result.consumo_punta !== undefined) {
                console.log('  âœ… Usando OpciÃ³n 2: result.consumo_punta existe');
                kwh_p1 = parseFloat(result.consumo_punta) || 0;
                kwh_p2 = parseFloat(result.consumo_llano) || 0;
                kwh_p3 = parseFloat(result.consumo_valle) || 0;
                p1 = parseFloat(result.potencia_p1_kw) || parseFloat(result.p_potencia_1) || 0;
                p2 = parseFloat(result.potencia_p2_kw) || parseFloat(result.p_potencia_2) || 0;
                dias = parseInt(result.dias_facturados) || parseInt(result.dias) || 30;
                console.log('  - kwh_p1:', kwh_p1, 'kwh_p2:', kwh_p2, 'kwh_p3:', kwh_p3);
                console.log('  - p1:', p1, 'p2:', p2);
                console.log('  - dias:', dias);
            } else {
                console.error('  âŒ NO se encontrÃ³ ninguna opciÃ³n vÃ¡lida');
            }
            
            // Capturar factura actual del cliente
            if (result.originalBillAnnual) {
                originalBillAnnual = parseFloat(result.originalBillAnnual);
                console.log('  - originalBillAnnual desde result.originalBillAnnual:', originalBillAnnual);
            } else if (result.factura_actual_anual) {
                originalBillAnnual = parseFloat(result.factura_actual_anual);
                console.log('  - originalBillAnnual desde result.factura_actual_anual:', originalBillAnnual);
            } else if (result.importe_total) {
                // Desde QR: calcular anualizado
                const diasFacturados = dias || 30;
                const factorAnual = 365 / diasFacturados;
                originalBillAnnual = parseFloat(result.importe_total) * factorAnual;
                console.log('  - originalBillAnnual calculado desde importe_total:', result.importe_total, '* factorAnual:', factorAnual, '=', originalBillAnnual);
            } else {
                console.warn('  âš ï¸  NO se pudo obtener originalBillAnnual');
            }
            
            const extracted = {
                tariff: result.tariffType || currentTariffType || '2.0TD',
                kwh_p1, kwh_p2, kwh_p3, kwh_p4, kwh_p5, kwh_p6,
                p1, p2, p3, p4, p5, p6,
                dias,
                originalBillAnnual
            };
            
            console.log('ðŸ“¦ extractDataFromResult RESULTADO:');
            console.log('  - tariff:', extracted.tariff);
            console.log('  - kwh_p1:', extracted.kwh_p1, 'kwh_p2:', extracted.kwh_p2, 'kwh_p3:', extracted.kwh_p3);
            console.log('  - p1:', extracted.p1, 'p2:', extracted.p2);
            console.log('  - dias:', extracted.dias);
            console.log('  - originalBillAnnual:', extracted.originalBillAnnual);
            
            return extracted;
        }
        
        // Nueva funciÃ³n para ejecutar con COMPARACIÃ“N DUAL (cuando CHECK estaba marcado)
        function selectBestOptionDirectDual() {
            closeOfferDecisionModal();
            
            if (!lastComparisonResult || !lastIndexedResult) {
                window.showErrorModal('No hay resultados disponibles para comparaciÃ³n dual');
                return;
            }
            
            console.log('selectBestOptionDirectDual: Mostrando comparaciÃ³n DUAL (FIJO vs INDEXADO)');
            
            // âš¡ INTERCEPTAR MODO DUAL AQUÃ
            if (window.dualMode === true) {
                console.log('===== ðŸ”¥ MODO DUAL - Usando flujo con direcciÃ³n (selectBestOptionDirectDual) =====');
                
                // Preparar datos para el flujo unificado
                const tariff = lastComparisonResult.tariffType || currentTariffType || '2.0TD';
                const data = {
                    cups: lastComparisonResult.cups || 'CUPS-ELECTRICIDAD',
                    tariff: tariff,
                    kwh_p1: parseFloat(lastComparisonResult.kwh_p1) || 0,
                    kwh_p2: parseFloat(lastComparisonResult.kwh_p2) || 0,
                    kwh_p3: parseFloat(lastComparisonResult.kwh_p3) || 0,
                    kwh_p4: parseFloat(lastComparisonResult.kwh_p4) || 0,
                    kwh_p5: parseFloat(lastComparisonResult.kwh_p5) || 0,
                    kwh_p6: parseFloat(lastComparisonResult.kwh_p6) || 0,
                    p1: parseFloat(lastComparisonResult.p1) || 0,
                    p2: parseFloat(lastComparisonResult.p2) || 0,
                    p3: parseFloat(lastComparisonResult.p3) || 0,
                    p4: parseFloat(lastComparisonResult.p4) || 0,
                    p5: parseFloat(lastComparisonResult.p5) || 0,
                    p6: parseFloat(lastComparisonResult.p6) || 0,
                    dias: parseInt(lastComparisonResult.dias) || 30,
                    originalBillAnnual: lastComparisonResult.originalBillAnnual || (lastComparisonResult.importe_total || 0) * 12
                };
                
                const drkCost = lastComparisonResult.totalAnnual || 0;
                
                const results = {
                    drk: comparisonMode === 'overall_best' ? {
                        total: 0,
                        total_anual: 0
                    } : {
                        total: drkCost / 12,
                        total_anual: drkCost
                    },
                    powercup: comparisonMode === 'overall_best' ? {
                        total: drkCost / 12,
                        total_anual: drkCost
                    } : {
                        total: 0,
                        total_anual: 0
                    }
                };
                
                console.log('Llamando a dualAddFromResults desde selectBestOptionDirectDual');
                
                // Usar el flujo con modal de direcciÃ³n, pasando lastComparisonResult completo
                window.dualAddFromResults('electricidad', tariff, data, results, lastComparisonResult);
                
                return;
            }
            
            // Verificar si estamos en contexto MultiCups
            if (lastComparisonResult._multiCupsContext) {
                // Contexto MultiCups: AÃ±adir a la lista CON comparaciÃ³n indexada
                addSupplyToMultiCupsList(lastComparisonResult, lastIndexedResult);
            } else {
                // Contexto individual: Mostrar resultados CON comparaciÃ³n indexada
                renderResultsUI(lastComparisonResult, lastIndexedResult);
                document.getElementById('initial-view').classList.add('hidden');
                document.getElementById('scanner-view').classList.add('hidden');
                document.getElementById('results-view').classList.remove('hidden');
                document.getElementById('results-view').classList.add('animate-fade-in-up');
            }
        }
        
        // Nueva funciÃ³n para ejecutar con UNA sola tarifa (sin comparativa)
        function selectBestOptionDirectSingle() {
            console.log('=================================================');
            console.log('âš¡âš¡âš¡ selectBestOptionDirectSingle LLAMADA âš¡âš¡âš¡');
            console.log('dualMode:', window.dualMode);
            console.log('lastComparisonResult exists:', !!lastComparisonResult);
            console.log('=================================================');
            
            console.log('ðŸ” ANTES de closeOfferDecisionModal:');
            console.log('  - lastComparisonResult.offer.name:', lastComparisonResult?.offer?.name);
            console.log('  - lastComparisonResult.totalAnnual:', lastComparisonResult?.totalAnnual);
            
            closeOfferDecisionModal();
            
            console.log('âœ… DESPUÃ‰S de closeOfferDecisionModal:');
            console.log('  - lastComparisonResult.offer.name:', lastComparisonResult?.offer?.name);
            console.log('  - lastComparisonResult.totalAnnual:', lastComparisonResult?.totalAnnual);
            
            if (!lastComparisonResult) {
                console.error('âŒ No hay lastComparisonResult');
                window.showErrorModal('No hay resultado disponible');
                return;
            }
            
            console.log('âœ… lastComparisonResult OK, continuando...');
            
            // FORZAR: No mostrar comparativa indexada
            lastIndexedResult = null;
            compareWithIndexed = false;
            
            // Desmarcar checkbox fÃ­sicamente
            const checkbox = document.getElementById('compare-indexed-checkbox');
            if (checkbox) {
                checkbox.checked = false;
            }
            
            console.log('selectBestOptionDirectSingle: Forzando vista SIMPLE (sin comparativa)');
            
            console.log('ðŸ”ðŸ”ðŸ” ESTADO JUSTO ANTES DEL INTERCEPTOR DUAL:');
            console.log('  - lastComparisonResult.offer.name:', lastComparisonResult?.offer?.name);
            console.log('  - lastComparisonResult.totalAnnual:', lastComparisonResult?.totalAnnual);
            console.log('  - lastComparisonResult.tariffType:', lastComparisonResult?.tariffType);
            console.log('  - lastComparisonResult.consumo_punta:', lastComparisonResult?.consumo_punta);
            console.log('  - lastComparisonResult.cups:', lastComparisonResult?.cups);
            
            // âš¡ INTERCEPTAR MODO DUAL AQUÃ
            if (window.dualMode === true) {
                console.log('===== ðŸ”¥ MODO DUAL - AÃ±adiendo directamente al array =====');
                
                try {
                    // CREAR el objeto de suministro CON DESGLOSE COMPLETO
                    const newSupply = {
                        type: 'electricidad',
                        cups: lastComparisonResult.cups || '',
                        tariff: lastComparisonResult.tariffType || currentTariffType || '2.0TD',
                        offer: {
                            ...lastComparisonResult.offer,
                            p1_power_price: lastComparisonResult.powerCosts?.[0]?.priceDay || lastComparisonResult.powerCosts?.[0]?.price_euro_kw_day,
                            p2_power_price: lastComparisonResult.powerCosts?.[1]?.priceDay || lastComparisonResult.powerCosts?.[1]?.price_euro_kw_day,
                            p1_price: lastComparisonResult.energyCosts?.[0]?.price || lastComparisonResult.energyCosts?.[0]?.price_euro_kwh,
                            p2_price: lastComparisonResult.energyCosts?.[1]?.price || lastComparisonResult.energyCosts?.[1]?.price_euro_kwh,
                            p3_price: lastComparisonResult.energyCosts?.[2]?.price || lastComparisonResult.energyCosts?.[2]?.price_euro_kwh,
                            p4_price: lastComparisonResult.energyCosts?.[3]?.price || lastComparisonResult.energyCosts?.[3]?.price_euro_kwh,
                            p5_price: lastComparisonResult.energyCosts?.[4]?.price || lastComparisonResult.energyCosts?.[4]?.price_euro_kwh,
                            p6_price: lastComparisonResult.energyCosts?.[5]?.price || lastComparisonResult.energyCosts?.[5]?.price_euro_kwh
                        },
                        totalAnnual: lastComparisonResult.totalAnnual,
                        originalBillAnnual: lastComparisonResult.originalBillAnnual || (lastComparisonResult.importe_total || 0) * 12,
                        data: lastComparisonResult,
                        electricityBreakdown: {
                            energyCosts: lastComparisonResult.energyCosts || [],
                            powerCosts: lastComparisonResult.powerCosts || [],
                            subEnergy: lastComparisonResult.subEnergyNet || 0,
                            subPower: lastComparisonResult.subPower || 0,
                            subBase: lastComparisonResult.subBase || 0,
                            costIE: lastComparisonResult.costIE || 0,
                            baseImp: lastComparisonResult.baseImp || 0,
                            costIVA: lastComparisonResult.costIVA || 0,
                            totalPeriod: lastComparisonResult.totalPeriod || 0,
                            totalAnnual: lastComparisonResult.totalAnnual || 0,
                            ahorro_mensual: (lastComparisonResult.originalBillPeriod || 0) - (lastComparisonResult.totalPeriod || 0),
                            ahorro_anual: (lastComparisonResult.originalBillAnnual || 0) - (lastComparisonResult.totalAnnual || 0),
                            dias: lastComparisonResult.dias_facturados || 30
                        },
                        results: {
                            drk: comparisonMode === 'overall_best' ? {
                                total: 0,
                                total_anual: 0
                            } : {
                                total: lastComparisonResult.totalAnnual / 12,
                                total_anual: lastComparisonResult.totalAnnual
                            },
                            powercup: comparisonMode === 'overall_best' ? {
                                total: lastComparisonResult.totalAnnual / 12,
                                total_anual: lastComparisonResult.totalAnnual
                            } : {
                                total: 0,
                                total_anual: 0
                            }
                        }
                    };
                    
                    // AÃ‘ADIR al array
                    dualSupplies.push(newSupply);
                    
                    console.log('âœ… Suministro aÃ±adido al array');
                    console.log('  - Total suministros:', dualSupplies.length);
                    console.log('  - CUPS:', newSupply.cups);
                    console.log('  - Tarifa:', newSupply.tariff);
                    console.log('  - Coste anual:', newSupply.totalAnnual);
                    
                    // Actualizar UI
                    updateDualSuppliesList();
                    console.log('âœ… UI actualizada');
                    
                    // Cerrar modales
                    const offerModal = document.getElementById('offer-decision-modal');
                    if (offerModal) {
                        offerModal.classList.add('hidden');
                        offerModal.classList.remove('flex');
                    }
                    
                    // Ocultar todas las pantallas
                    hideAllScreens();
                    
                    // Volver a pantalla DUAL
                    document.getElementById('screen-dual').classList.add('active');
                    
                    console.log('âœ… Volviendo a pantalla DUAL');
                    return;
                } catch (error) {
                    console.error('âŒ ERROR en interceptor DUAL:', error);
                    alert('Error al aÃ±adir suministro: ' + error.message);
                    return;
                }
            }
            
            // Verificar si estamos en contexto MultiCups
            if (lastComparisonResult._multiCupsContext) {
                // Contexto MultiCups: AÃ±adir a la lista (sin indexado)
                addSupplyToMultiCupsList(lastComparisonResult, null);
            } else {
                // NUEVO: Verificar si hay comparativo dual de potencias activo
                if (window.lastDualPowerComparison) {
                    console.log('ðŸ”¥ Comparativo DUAL DE POTENCIAS detectado - Renderizando vista dual');
                    const dualComp = window.lastDualPowerComparison;
                    renderDualPowerResultsUI(dualComp.actual, dualComp.optimized, dualComp.brand);
                } else {
                    // Contexto individual normal: Mostrar resultados (sin indexado)
                    renderResultsUI(lastComparisonResult, null);
                }
                
                document.getElementById('initial-view').classList.add('hidden');
                document.getElementById('scanner-view').classList.add('hidden');
                document.getElementById('results-view').classList.remove('hidden');
                document.getElementById('results-view').classList.add('animate-fade-in-up');
            }
        }
        
        function toggleIndexedComparison(checked) {
            compareWithIndexed = checked;
            console.log('ComparaciÃ³n con indexadas:', compareWithIndexed ? 'ACTIVADA' : 'DESACTIVADA');
        }
        
        // Nueva funciÃ³n para calcular la mejor oferta indexada (DRK INDEX)
        function calculateIndexedOffer(data, tariffType) {
            const tariffsToCompare = currentTariffs[tariffType] || [];
            
            // Filtrar solo tarifas DRK INDEX (SIEMPRE de DRK, independientemente del modo)
            const indexedTariffs = tariffsToCompare.filter(t => {
                const name = (t.name || '').toUpperCase();
                const description = (t.description || '').toUpperCase();
                const commercializer = (t.commercializer || '').toUpperCase();
                
                // CRÃTICO: Debe contener "INDEX" Y ser de DRK
                const hasIndex = name.includes('INDEX') || description.includes('INDEX') || commercializer.includes('INDEX');
                const isDrk = t.isDrk === true || commercializer.includes('DRK') || name.includes('DRK');
                
                return hasIndex && isDrk;
            });
            
            console.log(`ðŸ” Tarifas DRK INDEX encontradas para ${tariffType}:`, indexedTariffs.length);
            if (indexedTariffs.length > 0) {
                console.log('ðŸ“‹ Tarifas DRK INDEX:', indexedTariffs.map(t => t.name).join(', '));
            }
            
            if (indexedTariffs.length === 0) {
                console.warn('âš ï¸  No se encontraron tarifas DRK INDEX');
                return null;
            }
            
            // Calcular coste para cada tarifa indexada
            const indexedResults = indexedTariffs.map(t => {
                const result = calculateTariffCost(t, data, tariffType);
                // CRÃTICO: Asegurar que tiene originalTariffType
                if (!result.originalTariffType) {
                    result.originalTariffType = tariffType;
                }
                return result;
            });
            
            // Encontrar la mejor tarifa indexada (menor coste anual)
            let bestIndexed = null;
            indexedResults.forEach(r => {
                r.savings = r.originalBillAnnual - r.totalAnnual;
                if (r.savings > 0) {
                    if (!bestIndexed || r.totalAnnual < bestIndexed.totalAnnual) {
                        bestIndexed = r;
                    }
                }
            });
            
            if (bestIndexed) {
                bestIndexed.isIndexed = true; // Marcar como resultado indexado
                // CRÃTICO: Asegurar que tiene originalTariffType
                if (!bestIndexed.originalTariffType) {
                    bestIndexed.originalTariffType = tariffType;
                }
                console.log('âœ… Mejor tarifa DRK INDEX:', bestIndexed.offer.name, 'Ahorro:', bestIndexed.savings);
                console.log('âœ… originalTariffType asignado:', bestIndexed.originalTariffType);
            } else {
                console.warn('âš ï¸  No se encontrÃ³ ninguna tarifa DRK INDEX con ahorro positivo');
            }
            
            return bestIndexed;
        }
        
        function selectBestOptionDirect() {
            console.log('=================================================');
            console.log('âš¡âš¡âš¡ selectBestOptionDirect LLAMADA âš¡âš¡âš¡');
            console.log('dualMode:', window.dualMode);
            console.log('compareWithIndexed:', compareWithIndexed);
            console.log('lastComparisonResult exists:', !!lastComparisonResult);
            console.log('comparisonMode:', comparisonMode);
            console.log('=================================================');
            
            // Cerrar modal de decisiÃ³n
            closeOfferDecisionModal();
            
            // Usar el resultado que ya estaba calculado (lastComparisonResult)
            if (!lastComparisonResult) {
                console.error('âŒ No hay lastComparisonResult');
                window.showErrorModal('No hay resultado disponible');
                return;
            }
            
            console.log('âœ… lastComparisonResult OK, continuando...');
            
            // âš¡âš¡âš¡ INTERCEPTOR MODO DUAL âš¡âš¡âš¡
            if (window.dualMode === true) {
                console.log('===== ðŸ”¥ MODO DUAL - AÃ±adiendo directamente al array =====');
                
                try {
                    // CREAR el objeto de suministro CON DESGLOSE COMPLETO
                    const newSupply = {
                        type: 'electricidad',
                        cups: lastComparisonResult.cups || '',
                        tariff: lastComparisonResult.tariffType || currentTariffType || '2.0TD',
                        offer: {
                            ...lastComparisonResult.offer,
                            p1_power_price: lastComparisonResult.powerCosts?.[0]?.priceDay || lastComparisonResult.powerCosts?.[0]?.price_euro_kw_day,
                            p2_power_price: lastComparisonResult.powerCosts?.[1]?.priceDay || lastComparisonResult.powerCosts?.[1]?.price_euro_kw_day,
                            p1_price: lastComparisonResult.energyCosts?.[0]?.price || lastComparisonResult.energyCosts?.[0]?.price_euro_kwh,
                            p2_price: lastComparisonResult.energyCosts?.[1]?.price || lastComparisonResult.energyCosts?.[1]?.price_euro_kwh,
                            p3_price: lastComparisonResult.energyCosts?.[2]?.price || lastComparisonResult.energyCosts?.[2]?.price_euro_kwh,
                            p4_price: lastComparisonResult.energyCosts?.[3]?.price || lastComparisonResult.energyCosts?.[3]?.price_euro_kwh,
                            p5_price: lastComparisonResult.energyCosts?.[4]?.price || lastComparisonResult.energyCosts?.[4]?.price_euro_kwh,
                            p6_price: lastComparisonResult.energyCosts?.[5]?.price || lastComparisonResult.energyCosts?.[5]?.price_euro_kwh
                        },
                        totalAnnual: lastComparisonResult.totalAnnual,
                        originalBillAnnual: lastComparisonResult.originalBillAnnual || (lastComparisonResult.importe_total || 0) * 12,
                        data: lastComparisonResult,
                        electricityBreakdown: {
                            energyCosts: lastComparisonResult.energyCosts || [],
                            powerCosts: lastComparisonResult.powerCosts || [],
                            subEnergy: lastComparisonResult.subEnergyNet || 0,
                            subPower: lastComparisonResult.subPower || 0,
                            subBase: lastComparisonResult.subBase || 0,
                            costIE: lastComparisonResult.costIE || 0,
                            baseImp: lastComparisonResult.baseImp || 0,
                            costIVA: lastComparisonResult.costIVA || 0,
                            totalPeriod: lastComparisonResult.totalPeriod || 0,
                            totalAnnual: lastComparisonResult.totalAnnual || 0,
                            ahorro_mensual: (lastComparisonResult.originalBillPeriod || 0) - (lastComparisonResult.totalPeriod || 0),
                            ahorro_anual: (lastComparisonResult.originalBillAnnual || 0) - (lastComparisonResult.totalAnnual || 0),
                            dias: lastComparisonResult.dias_facturados || 30
                        },
                        results: {
                            drk: comparisonMode === 'overall_best' ? {
                                total: 0,
                                total_anual: 0
                            } : {
                                total: lastComparisonResult.totalAnnual / 12,
                                total_anual: lastComparisonResult.totalAnnual
                            },
                            powercup: comparisonMode === 'overall_best' ? {
                                total: lastComparisonResult.totalAnnual / 12,
                                total_anual: lastComparisonResult.totalAnnual
                            } : {
                                total: 0,
                                total_anual: 0
                            }
                        }
                    };
                    
                    // AÃ‘ADIR al array
                    dualSupplies.push(newSupply);
                    
                    console.log('âœ… Suministro aÃ±adido al array');
                    console.log('  - Total suministros:', dualSupplies.length);
                    console.log('  - CUPS:', newSupply.cups);
                    console.log('  - Tarifa:', newSupply.tariff);
                    console.log('  - Coste anual:', newSupply.totalAnnual);
                    
                    // Actualizar UI
                    updateDualSuppliesList();
                    console.log('âœ… UI actualizada');
                    
                    // Cerrar modales
                    const offerModal = document.getElementById('offer-decision-modal');
                    if (offerModal) {
                        offerModal.classList.add('hidden');
                        offerModal.classList.remove('flex');
                    }
                    
                    // Ocultar todas las pantallas
                    hideAllScreens();
                    
                    // Volver a pantalla DUAL
                    document.getElementById('screen-dual').classList.add('active');
                    
                    console.log('âœ… Volviendo a pantalla DUAL');
                    return; // CRÃTICO: Salir aquÃ­
                } catch (error) {
                    console.error('âŒ ERROR en interceptor DUAL:', error);
                    alert('Error al aÃ±adir suministro: ' + error.message);
                    return;
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ARREGLO: Cuando compareWithIndexed = true, calcular FIJO vs INDEXADO correctamente
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (compareWithIndexed) {
                console.log('ðŸ”§ ComparaciÃ³n FIJO vs INDEXADO activada');
                
                const tariffType = lastComparisonResult._multiCupsContext 
                    ? lastComparisonResult._multiCupsContext.tariffType 
                    : lastComparisonResult.originalTariffType || currentTariffType;
                
                const dataForCalc = lastComparisonResult._multiCupsContext 
                    ? lastComparisonResult._multiCupsContext.dataForCalc 
                    : lastComparisonResult;
                
                // CRÃTICO: Preservar _multiCupsContext ANTES de recalcular
                const preservedContext = lastComparisonResult._multiCupsContext 
                    ? JSON.parse(JSON.stringify(lastComparisonResult._multiCupsContext))
                    : null;
                
                console.log('ðŸ” Contexto MULTICUPS preservado:', preservedContext ? 'SÃ' : 'NO');
                
                // PASO 1: Recalcular la MEJOR OFERTA FIJA (sin indexadas)
                console.log('ðŸ“Š Calculando mejor oferta FIJA...');
                console.log('ðŸ” Modo de comparaciÃ³n actual:', comparisonMode);
                console.log('ðŸ” Marca activa:', activeBrand.NAME);
                
                const tarifasDisponibles = currentTariffs[tariffType] || [];
                
                // Filtrar SOLO tarifas FIJAS (excluir indexadas)
                const tarifasFijas = tarifasDisponibles.filter(t => {
                    const name = (t.name || '').toUpperCase();
                    const desc = (t.description || '').toUpperCase();
                    return !name.includes('INDEX') && !desc.includes('INDEX');
                });
                
                console.log(`Tarifas FIJAS encontradas: ${tarifasFijas.length} de ${tarifasDisponibles.length}`);
                
                // NUEVA LÃ“GICA: Filtrar segÃºn DRK o POWER CUP
                const isDrkMode = activeBrand.NAME.includes('DRK');
                
                let tarifasFijasFiltradas;
                if (isDrkMode) {
                    // MODO DRK: Solo tarifas FIJAS de DRK
                    tarifasFijasFiltradas = tarifasFijas.filter(t => t.isDrk);
                    console.log('ðŸ”µ Modo DRK: Filtrando solo tarifas FIJAS de DRK');
                } else {
                    // MODO POWER CUP: Todas las tarifas FIJAS (cualquier comercializadora)
                    tarifasFijasFiltradas = tarifasFijas;
                    console.log('ðŸŸ¢ Modo POWER CUP: Aceptando tarifas FIJAS de cualquier comercializadora');
                }
                
                console.log(`Tarifas FIJAS despuÃ©s de filtro DRK/POWER: ${tarifasFijasFiltradas.length}`);
                
                // Calcular la mejor oferta FIJA
                const resultadosFijos = tarifasFijasFiltradas.map(t => calculateTariffCost(t, dataForCalc, tariffType));
                let mejorFija = null;
                
                resultadosFijos.forEach(r => {
                    if (!mejorFija || r.totalAnnual < mejorFija.totalAnnual) {
                        mejorFija = r;
                    }
                });
                
                if (!mejorFija) {
                    const modoTexto = isDrkMode ? 'DRK' : 'cualquier comercializadora';
                    window.showErrorModal(`No se encontraron tarifas FIJAS de ${modoTexto}.`);
                    return;
                }
                
                console.log('âœ… Mejor oferta FIJA:', mejorFija.offer.name, mejorFija.totalAnnual);
                
                // PASO 2: Calcular la MEJOR OFERTA INDEXADA
                console.log('ðŸ“Š Calculando mejor oferta INDEXADA...');
                lastIndexedResult = calculateIndexedOffer(dataForCalc, tariffType);
                
                if (!lastIndexedResult) {
                    window.showErrorModal('No se encontraron tarifas indexadas DRK INDEX para comparar.');
                    lastIndexedResult = null;
                    compareWithIndexed = false;
                    document.getElementById('compare-indexed-checkbox').checked = false;
                    return;
                }
                
                console.log('âœ… Mejor oferta INDEXADA:', lastIndexedResult.offer.name, lastIndexedResult.totalAnnual);
                
                // PASO 3: Actualizar lastComparisonResult con la mejor FIJA
                lastComparisonResult = mejorFija;
                
                // CRÃTICO: RESTAURAR el contexto preservado
                if (preservedContext) {
                    lastComparisonResult._multiCupsContext = preservedContext;
                    console.log('âœ… Contexto MULTICUPS restaurado correctamente');
                } else {
                    console.log('âš ï¸  No habÃ­a contexto MULTICUPS que restaurar');
                }
            }
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // FIN ARREGLO
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            // Verificar si estamos en contexto MultiCups
            if (lastComparisonResult._multiCupsContext) {
                // Contexto MultiCups: AÃ±adir a la lista
                addSupplyToMultiCupsList(lastComparisonResult, lastIndexedResult);
            } else {
                // NUEVO: Verificar si hay comparativo dual de potencias activo
                if (window.lastDualPowerComparison) {
                    console.log('ðŸ”¥ Comparativo DUAL DE POTENCIAS detectado - Renderizando vista dual');
                    const dualComp = window.lastDualPowerComparison;
                    renderDualPowerResultsUI(dualComp.actual, dualComp.optimized, dualComp.brand);
                } else if (lastIndexedResult && compareWithIndexed) {
                    // Comparativa Fijo vs Indexado
                    renderDualComparisonUI(lastComparisonResult, lastIndexedResult);
                } else {
                    // Contexto individual normal
                    renderResultsUI(lastComparisonResult);
                }
                
                document.getElementById('initial-view').classList.add('hidden');
                document.getElementById('scanner-view').classList.add('hidden');
                document.getElementById('results-view').classList.remove('hidden');
                document.getElementById('results-view').classList.add('animate-fade-in-up');
            }
        }
        
        function selectFromResults() {
            // Cerrar modal de decisiÃ³n
            closeOfferDecisionModal();
            
            // Mostrar modal de selecciÃ³n de ofertas
            if (lastComparisonResult && availableOffers.length > 0) {
                showOfferSelectionModal(lastComparisonResult.cups);
            } else {
                window.showErrorModal('No hay ofertas disponibles para seleccionar');
            }
        }
        
        // NUEVA: FunciÃ³n para hacer copia profunda de una oferta
        function deepCopyOffer(offer) {
            if (!offer) return offer;
            
            // Hacer copia profunda del objeto oferta
            return JSON.parse(JSON.stringify(offer));
        }
        
        // NUEVA: FunciÃ³n para recalcular energyCosts y powerCosts correctamente
        function recalculateCostsForOffer(baseData, selectedOffer) {
            const tariffType = baseData.originalTariffType;
            
            console.log('Recalculating costs for:', selectedOffer.name, '(', tariffType, ')');
            
            // CRÃTICO: Buscar la tarifa ORIGINAL en currentTariffs
            // en lugar de usar selectedOffer que puede estar contaminado
            const originalTariff = currentTariffs[tariffType]?.find(t => 
                t.name === selectedOffer.name && t.description === selectedOffer.description
            );
            
            if (!originalTariff) {
                console.error('âŒ Original tariff not found in currentTariffs for:', selectedOffer.name);
                // Fallback: usar selectedOffer si no se encuentra
                return recalculateCostsFromOffer(baseData, selectedOffer, tariffType);
            }
            
            console.log('âœ… Using original tariff from CSV');
            
            // Usar la tarifa ORIGINAL, no selectedOffer
            return recalculateCostsFromOffer(baseData, originalTariff, tariffType);
        }
        
        // FunciÃ³n auxiliar que hace el cÃ¡lculo real
        function recalculateCostsFromOffer(baseData, tariffOffer, tariffType) {
            const recalculatedEnergyCosts = [];
            const recalculatedPowerCosts = [];
            
            // CRÃTICO: Extraer valores primitivos ANTES de usarlos
            // Esto evita cualquier referencia compartida
            const offerPrices = {
                p1_price: Number(tariffOffer.p1_price) || 0,
                p2_price: Number(tariffOffer.p2_price) || 0,
                p3_price: Number(tariffOffer.p3_price) || 0,
                p4_price: Number(tariffOffer.p4_price) || 0,
                p5_price: Number(tariffOffer.p5_price) || 0,
                p6_price: Number(tariffOffer.p6_price) || 0,
                p_potencia_1: Number(tariffOffer.p_potencia_1) || 0,
                p_potencia_2: Number(tariffOffer.p_potencia_2) || 0,
                p_potencia_3: Number(tariffOffer.p_potencia_3) || 0,
                p_potencia_4: Number(tariffOffer.p_potencia_4) || 0,
                p_potencia_5: Number(tariffOffer.p_potencia_5) || 0,
                p_potencia_6: Number(tariffOffer.p_potencia_6) || 0
            };
            
            console.log('Extracted prices (primitives):', offerPrices);
            
            if (tariffType === '2.0TD') {
                // Calcular energÃ­a para 2.0TD (3 periodos)
                const consumos = [
                    baseData.consumo_punta || 0,
                    baseData.consumo_llano || 0,
                    baseData.consumo_valle || 0
                ];
                const preciosEnergia = [
                    offerPrices.p1_price,
                    offerPrices.p2_price,
                    offerPrices.p3_price
                ];
                
                console.log('2.0TD Consumos:', consumos);
                console.log('2.0TD Precios:', preciosEnergia);
                
                for (let i = 0; i < 3; i++) {
                    recalculatedEnergyCosts.push({
                        period: i + 1,
                        kwh: consumos[i],
                        price: preciosEnergia[i],
                        cost: consumos[i] * preciosEnergia[i]
                    });
                }
                
                // Calcular potencia para 2.0TD (2 periodos)
                const potencias = [
                    baseData.potencia_p1_kw || 0,
                    baseData.potencia_p2_kw || 0
                ];
                const preciosPotencia = [
                    offerPrices.p_potencia_1 / 365,
                    offerPrices.p_potencia_2 / 365
                ];
                const diasFacturados = baseData.dias_facturados || 30;
                
                for (let i = 0; i < 2; i++) {
                    recalculatedPowerCosts.push({
                        period: i + 1,
                        kw: potencias[i],
                        priceDay: preciosPotencia[i],
                        cost: potencias[i] * preciosPotencia[i] * diasFacturados
                    });
                }
            } else if (tariffType === '3.0TD') {
                // IMPORTANTE: Algunas tarifas 3.0TD solo tienen 3 precios definidos
                // Necesitamos propagar los precios existentes a los 6 periodos
                
                // Detectar si la tarifa tiene 6 precios o solo 3
                const hasFull6Periods = offerPrices.p4_price > 0;
                
                let prices = [];
                if (hasFull6Periods) {
                    // Tarifa con 6 periodos completos
                    prices = [
                        offerPrices.p1_price,
                        offerPrices.p2_price,
                        offerPrices.p3_price,
                        offerPrices.p4_price,
                        offerPrices.p5_price,
                        offerPrices.p6_price
                    ];
                } else {
                    // Tarifa con solo 3 precios: propagar P1->P1/P4, P2->P2/P5, P3->P3/P6
                    prices = [
                        offerPrices.p1_price,
                        offerPrices.p2_price,
                        offerPrices.p3_price,
                        offerPrices.p1_price,
                        offerPrices.p2_price,
                        offerPrices.p3_price
                    ];
                    console.log('3.0TD tariff has only 3 periods, propagating prices:', prices);
                }
                
                // Detectar si la tarifa tiene 6 precios de potencia o solo 2
                const hasFull6PowerPrices = offerPrices.p_potencia_3 > 0;
                
                let powerPrices = [];
                if (hasFull6PowerPrices) {
                    powerPrices = [
                        offerPrices.p_potencia_1 / 365,
                        offerPrices.p_potencia_2 / 365,
                        offerPrices.p_potencia_3 / 365,
                        offerPrices.p_potencia_4 / 365,
                        offerPrices.p_potencia_5 / 365,
                        offerPrices.p_potencia_6 / 365
                    ];
                } else {
                    // Solo tiene P1 y P2: propagar P1->P1/P3/P5, P2->P2/P4/P6
                    const p1 = offerPrices.p_potencia_1 / 365;
                    const p2 = offerPrices.p_potencia_2 / 365;
                    powerPrices = [p1, p2, p1, p2, p1, p2];
                    console.log('3.0TD tariff has only 2 power prices, propagating:', powerPrices);
                }
                
                // Calcular energÃ­a para 3.0TD (6 periodos)
                for (let i = 1; i <= 6; i++) {
                    const kwh = baseData[`consumo_p${i}`] || 0;
                    const price = prices[i - 1];
                    console.log(`Period ${i}: kwh=${kwh}, price=${price}`);
                    recalculatedEnergyCosts.push({
                        period: i,
                        kwh: kwh,
                        price: price,
                        cost: kwh * price
                    });
                }
                
                // Calcular potencia para 3.0TD (6 periodos)
                const diasFacturados = baseData.dias_facturados || 30;
                console.log('DÃ­as facturados:', diasFacturados);
                
                for (let i = 1; i <= 6; i++) {
                    const kw = baseData[`potencia_p${i}_kw`] || 0;
                    const priceDay = powerPrices[i - 1];
                    console.log(`Power P${i}: kw=${kw}, priceDay=${priceDay}`);
                    recalculatedPowerCosts.push({
                        period: i,
                        kw: kw,
                        priceDay: priceDay,
                        cost: kw * priceDay * diasFacturados
                    });
                }
            }
            
            console.log('Recalculated energy costs periods:', recalculatedEnergyCosts.length);
            console.log('Recalculated power costs periods:', recalculatedPowerCosts.length);
            
            // Calcular subtotales
            const subPower = recalculatedPowerCosts.reduce((sum, p) => sum + p.cost, 0);
            const subEnergyNet = recalculatedEnergyCosts.reduce((sum, e) => sum + e.cost, 0);
            
            console.log('Recalculated subPower:', subPower);
            console.log('Recalculated subEnergyNet:', subEnergyNet);
            console.log('=== END RECALCULATE DEBUG ===');
            
            return {
                energyCosts: recalculatedEnergyCosts,
                powerCosts: recalculatedPowerCosts,
                subPower: subPower,
                subEnergyNet: subEnergyNet
            };
        }
        
        // Nueva funciÃ³n para aÃ±adir suministro a MultiCups despuÃ©s de elegir
        function addSupplyToMultiCupsList(result, resultIndexed = null) {
            console.log('addSupplyToMultiCupsList called with result:', result);
            console.log('Result offer:', result.offer);
            console.log('Result originalTariffType:', result.originalTariffType);
            console.log('Result tiene indexedComparison?:', !!result.indexedComparison);
            
            if (result.indexedComparison) {
                console.log('indexedComparison encontrado en result:', result.indexedComparison);
                console.log('indexedComparison tiene powerCosts?:', !!result.indexedComparison.powerCosts);
                console.log('indexedComparison tiene energyCosts?:', !!result.indexedComparison.energyCosts);
            }
            
            if (resultIndexed) {
                console.log('TambiÃ©n recibido resultado indexado como parÃ¡metro:', resultIndexed.offer.name);
            }
            
            // IMPORTANTE: Preservar indexedComparison ANTES de recalcular
            // Usar copia profunda para evitar modificaciones por referencia
            const preservedIndexedComparison = result.indexedComparison 
                ? JSON.parse(JSON.stringify(result.indexedComparison))
                : null;
            
            // Asegurar que el originalTariffType estÃ© presente
            if (!result.originalTariffType && result._multiCupsContext) {
                result.originalTariffType = result._multiCupsContext.tariffType;
                console.log('Set originalTariffType from context:', result.originalTariffType);
            }
            
            // IMPORTANTE: Recalcular costes para asegurar que 3.0TD tenga 6 periodos
            if (result.offer && result.originalTariffType) {
                const recalculated = recalculateCostsForOffer(result, result.offer);
                result.energyCosts = recalculated.energyCosts;
                result.powerCosts = recalculated.powerCosts;
                result.subPower = recalculated.subPower;
                result.subEnergyNet = recalculated.subEnergyNet;
                console.log('Costs recalculated for', result.originalTariffType);
                console.log('New subPower:', result.subPower, 'New subEnergyNet:', result.subEnergyNet);
            }
            
            // RESTAURAR indexedComparison preservado
            if (preservedIndexedComparison) {
                result.indexedComparison = preservedIndexedComparison;
                console.log('Restaurado indexedComparison preservado');
            }
            
            // Si hay resultado indexado como parÃ¡metro, tambiÃ©n recalcular sus costes
            if (resultIndexed && resultIndexed.offer && resultIndexed.originalTariffType) {
                console.log('ðŸ” Recalculando costes para resultado INDEXADO:', resultIndexed.offer.name);
                console.log('ðŸ” originalTariffType del indexado:', resultIndexed.originalTariffType);
                console.log('ðŸ” totalAnnual del indexado ANTES de recalcular:', resultIndexed.totalAnnual);
                console.log('ðŸ” savings del indexado ANTES de recalcular:', resultIndexed.savings);
                
                const recalculatedIndexed = recalculateCostsForOffer(resultIndexed, resultIndexed.offer);
                resultIndexed.energyCosts = recalculatedIndexed.energyCosts;
                resultIndexed.powerCosts = recalculatedIndexed.powerCosts;
                resultIndexed.subPower = recalculatedIndexed.subPower;
                resultIndexed.subEnergyNet = recalculatedIndexed.subEnergyNet;
                console.log('âœ… Costs recalculated for indexed:', resultIndexed.originalTariffType);
                console.log('âœ… subPower indexado:', resultIndexed.subPower);
                console.log('âœ… subEnergyNet indexado:', resultIndexed.subEnergyNet);
                console.log('âœ… Ahorro indexado:', resultIndexed.savings);
                console.log('âœ… Total anual indexado:', resultIndexed.totalAnnual);
                
                // AÃ±adirlo al resultado principal
                result.indexedComparison = resultIndexed;
                console.log('âœ… indexedComparison asignado a result');
                console.log('âœ… indexedComparison final:', {
                    offer: result.indexedComparison.offer.name,
                    totalAnnual: result.indexedComparison.totalAnnual,
                    savings: result.indexedComparison.savings,
                    originalTariffType: result.indexedComparison.originalTariffType
                });
            } else if (resultIndexed) {
                console.error('âŒâŒâŒ resultIndexed no tiene offer o originalTariffType âŒâŒâŒ');
                console.error('resultIndexed recibido:', resultIndexed);
                console.error('Details:', {
                    hasOffer: !!resultIndexed.offer,
                    hasOriginalTariffType: !!resultIndexed.originalTariffType,
                    offer: resultIndexed.offer,
                    originalTariffType: resultIndexed.originalTariffType
                });
            } else {
                console.warn('âš ï¸  resultIndexed es null/undefined - NO hay comparaciÃ³n indexada');
            }
            
            // Limpiar el contexto temporal
            delete result._multiCupsContext;
            
            // LOGS FINALES antes de aÃ±adir
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ðŸ“‹ SUMINISTRO LISTO PARA AÃ‘ADIR A multiCupsData:');
            console.log('  CUPS:', result.cups);
            console.log('  Oferta FIJA:', result.offer.name);
            console.log('  Total Annual FIJO:', result.totalAnnual);
            console.log('  Savings FIJO:', result.savings);
            console.log('  originalTariffType FIJO:', result.originalTariffType);
            if (result.indexedComparison) {
                console.log('  âœ… TIENE indexedComparison:');
                console.log('    Oferta INDEXADA:', result.indexedComparison.offer.name);
                console.log('    Total Annual INDEXADO:', result.indexedComparison.totalAnnual);
                console.log('    Savings INDEXADO:', result.indexedComparison.savings);
                console.log('    originalTariffType INDEXADO:', result.indexedComparison.originalTariffType);
            } else {
                console.log('  âŒ NO tiene indexedComparison');
            }
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            // AÃ±adir a la lista
            multiCupsData.push(result);
            console.log('multiCupsData after push:', multiCupsData);
            
            // Actualizar UI y volver a la vista SAGA
            document.getElementById('tariff-display-badge').textContent = multiCupsData.length;
            
            window.showMessageModal(`Suministro ${result.cups} (${result.offer.name}) aÃ±adido. Total: ${multiCupsData.length}`, "Suministro AÃ±adido");
            
            document.getElementById('initial-view').classList.add('hidden');
            showMultiCupsSagaView();
        }
        
        // Funciones para el modal de selecciÃ³n de ofertas
        function showOfferSelectionModal(cups) {
            // Mostrar CUPS en el modal
            document.getElementById('modal-selection-cups').textContent = cups;
            
            // Inicializar contadores y limpiar filtros
            document.getElementById('offers-total-count').textContent = availableOffers.length;
            document.getElementById('offers-visible-count').textContent = availableOffers.length;
            document.getElementById('offer-search-input').value = '';
            document.getElementById('offer-sort-select').value = 'savings_desc';
            
            // Renderizar ofertas
            renderOffersList();
            
            // Mostrar modal
            document.getElementById('offer-selection-modal').classList.remove('hidden');
            document.getElementById('offer-selection-modal').classList.add('flex');
            
            // CRÃTICO: Traducir contenido del modal
            if (window.translateAll) {
                setTimeout(() => window.translateAll(), 50);
            }
            
            // Deshabilitar botÃ³n de confirmar inicialmente
            document.getElementById('confirm-offer-selection-btn').disabled = true;
            manuallySelectedOffer = null;
        }
        
        // NUEVA: FunciÃ³n para renderizar la lista de ofertas
        function renderOffersList() {
            const searchTerm = document.getElementById('offer-search-input').value.toLowerCase();
            const sortBy = document.getElementById('offer-sort-select').value;
            
            const container = document.getElementById('offers-radio-list');
            const noResultsMsg = document.getElementById('no-offers-message');
            
            // Filtrar ofertas
            let filteredOffers = availableOffers.map((offer, originalIndex) => ({
                offer: offer,
                originalIndex: originalIndex
            })).filter(item => {
                if (searchTerm === '') return true;
                
                const offerName = item.offer.offer.name.toLowerCase();
                const commercializer = item.offer.offer.isDrk ? 'drk energÃ­a' : (item.offer.offer.commercializer || '').toLowerCase();
                const description = (item.offer.offer.description || '').toLowerCase();
                
                return offerName.includes(searchTerm) || 
                       commercializer.includes(searchTerm) || 
                       description.includes(searchTerm);
            });
            
            // Ordenar ofertas filtradas
            filteredOffers.sort((a, b) => {
                switch(sortBy) {
                    case 'savings_desc':
                        // Si hay optimizaciÃ³n de potencias, ordenar por ahorro total
                        if (window.optimizedPowerEnabled && a.offer.ahorroTotal !== undefined) {
                            return b.offer.ahorroTotal - a.offer.ahorroTotal;
                        }
                        return b.offer.savings - a.offer.savings;
                    case 'savings_asc':
                        // Si hay optimizaciÃ³n de potencias, ordenar por ahorro total
                        if (window.optimizedPowerEnabled && a.offer.ahorroTotal !== undefined) {
                            return a.offer.ahorroTotal - b.offer.ahorroTotal;
                        }
                        return a.offer.savings - b.offer.savings;
                    case 'name_asc':
                        return a.offer.offer.name.localeCompare(b.offer.offer.name);
                    case 'name_desc':
                        return b.offer.offer.name.localeCompare(a.offer.offer.name);
                    default:
                        return 0;
                }
            });
            
            // Actualizar contador
            document.getElementById('offers-visible-count').textContent = filteredOffers.length;
            
            // Limpiar contenedor
            container.innerHTML = '';
            
            // Mostrar/ocultar mensaje de "no hay resultados"
            if (filteredOffers.length === 0) {
                noResultsMsg.classList.remove('hidden');
                container.classList.add('hidden');
                return;
            } else {
                noResultsMsg.classList.add('hidden');
                container.classList.remove('hidden');
            }
            
            // Renderizar ofertas
            const eur = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n || 0);
            
            filteredOffers.forEach(item => {
                const offer = item.offer;
                const originalIndex = item.originalIndex;
                const commercializer = offer.offer.isDrk ? 'DRK EnergÃ­a' : (offer.offer.commercializer || 'Otra comercializadora');
                const description = offer.offer.description || '';
                const name = offer.offer.name || '';
                
                // Para DRK, usar el campo que tenga mÃ¡s informaciÃ³n como tÃ­tulo
                let displayTitle, displaySubtitle;
                if (offer.offer.isDrk) {
                    // Si description es mÃ¡s largo que name, usarlo como tÃ­tulo
                    if (description.length > name.length) {
                        displayTitle = description;
                        displaySubtitle = name; // Usar name como subtÃ­tulo
                    } else {
                        // Si name es mÃ¡s largo o igual, usarlo como tÃ­tulo
                        displayTitle = name;
                        displaySubtitle = description; // Usar description como subtÃ­tulo
                    }
                } else {
                    displayTitle = name;
                    displaySubtitle = `${commercializer}${description && description !== name ? ' - ' + description : ''}`;
                }
                
                const offerCard = document.createElement('label');
                offerCard.className = 'offer-radio-card block cursor-pointer';
                offerCard.innerHTML = `
                    <input type="radio" name="selected_offer" value="${originalIndex}" class="hidden">
                    <div class="offer-card-content flex items-start gap-4 p-4 rounded-xl border-2 border-slate-300 bg-white transition hover:border-drk-400 hover:bg-drk-50">
                        <svg class="w-5 h-5 mt-0.5 flex-shrink-0 text-slate-400 checkmark-offer hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <div class="flex-1">
                            <p class="font-bold text-base text-slate-900">${displayTitle}</p>
                            <p class="text-sm text-slate-600">${displaySubtitle}</p>
                        </div>
                        <div class="text-right flex-shrink-0">
                            ${window.optimizedPowerEnabled && offer.ahorroTotal !== undefined ? `
                                <p class="text-xs text-slate-500">${tr('Ahorro anual')}</p>
                                <p class="text-sm font-bold text-green-600">${eur(offer.savingsActual)}</p>
                                <p class="text-xs text-orange-600 font-semibold">+ ${eur(offer.ahorroAdicional)} opt.</p>
                                <p class="text-xl font-black text-green-700">${eur(offer.ahorroTotal)}</p>
                            ` : `
                                <p class="text-xs text-slate-500">${tr('Ahorro anual')}</p>
                                <p class="text-xl font-black text-green-600">${eur(offer.savings)}</p>
                            `}
                        </div>
                    </div>
                `;
                container.appendChild(offerCard);
            });
            
            // AÃ±adir event listeners a los radio buttons
            document.querySelectorAll('input[name="selected_offer"]').forEach(radio => {
                radio.addEventListener('change', handleOfferRadioChange);
            });
        }
        
        // NUEVAS FUNCIONES: Filtrado y ordenaciÃ³n de ofertas
        function filterAndSortOffers() {
            renderOffersList();
        }
        
        function clearOfferFilters() {
            document.getElementById('offer-search-input').value = '';
            document.getElementById('offer-sort-select').value = 'savings_desc';
            renderOffersList();
        }
        
        function handleOfferRadioChange(e) {
            const selectedIndex = parseInt(e.target.value);
            
            // CRÃTICO: No guardar el objeto completo de availableOffers
            // Solo guardar la informaciÃ³n necesaria para buscar la tarifa original despuÃ©s
            const selectedOffer = availableOffers[selectedIndex];
            manuallySelectedOffer = {
                ...selectedOffer,
                // Guardar identificadores para buscar la tarifa original
                _needsOriginalLookup: true,
                _tariffName: selectedOffer.offer.name,
                _tariffDescription: selectedOffer.offer.description,
                _tariffType: selectedOffer.originalTariffType || lastComparisonResult?.originalTariffType
            };
            
            // Actualizar estilos visuales
            document.querySelectorAll('.offer-radio-card').forEach((card) => {
                const radio = card.querySelector('input[type="radio"]');
                const radioValue = parseInt(radio.value);
                const content = card.querySelector('.offer-card-content');
                const check = card.querySelector('.checkmark-offer');
                
                // Comparar por el VALUE del radio, no por el Ã­ndice del DOM
                if (radioValue === selectedIndex) {
                    content.className = 'offer-card-content flex items-start gap-4 p-4 rounded-xl border-2 border-drk-500 bg-drk-50 transition';
                    check.classList.remove('hidden');
                    check.classList.add('text-drk-600');
                } else {
                    content.className = 'offer-card-content flex items-start gap-4 p-4 rounded-xl border-2 border-slate-300 bg-white transition hover:border-drk-400 hover:bg-drk-50';
                    check.classList.add('hidden');
                }
            });
            
            // Habilitar botÃ³n de confirmar
            document.getElementById('confirm-offer-selection-btn').disabled = false;
        }
        
        function closeOfferSelectionModal() {
            document.getElementById('offer-selection-modal').classList.add('hidden');
            document.getElementById('offer-selection-modal').classList.remove('flex');
            // NO limpiar manuallySelectedOffer aquÃ­, se limpiarÃ¡ despuÃ©s de usarlo
        }
        
        function confirmOfferSelection() {
            if (!manuallySelectedOffer) return;
            
            // Cerrar modal
            document.getElementById('offer-selection-modal').classList.add('hidden');
            document.getElementById('offer-selection-modal').classList.remove('flex');
            
            // Continuar con el flujo normal mostrando el resultado
            continueWithSelectedOffer();
        }
        
        function continueWithSelectedOffer() {
            console.log('continueWithSelectedOffer called');
            console.log('manuallySelectedOffer:', manuallySelectedOffer);
            console.log('lastComparisonResult:', lastComparisonResult);
            
            // NUEVO: Si hay optimizaciÃ³n de potencias activa, recalcular con potencias actuales y optimizadas
            if (window.lastDualPowerComparison && manuallySelectedOffer) {
                console.log('âš¡ OptimizaciÃ³n de potencias detectada en ELEGIR ENTRE RESULTADOS');
                console.log('   Oferta seleccionada manualmente:', manuallySelectedOffer.offer.name);
                
                // Obtener las potencias actuales y optimizadas
                const actualData = window.lastDualPowerComparison.actual;
                const optimizedData = window.lastDualPowerComparison.optimized;
                const tariffType = actualData.originalTariffType || currentTariffType;
                
                // Recalcular la oferta seleccionada con potencias ACTUALES
                const resultWithActualPowers = calculateTariffCost(manuallySelectedOffer.offer, actualData, tariffType);
                resultWithActualPowers.savings = resultWithActualPowers.originalBillAnnual - resultWithActualPowers.totalAnnual;
                
                // Recalcular la misma oferta con potencias OPTIMIZADAS
                const resultWithOptimizedPowers = calculateTariffCost(manuallySelectedOffer.offer, optimizedData, tariffType);
                resultWithOptimizedPowers.savings = resultWithOptimizedPowers.originalBillAnnual - resultWithOptimizedPowers.totalAnnual;
                
                console.log('âœ… Oferta recalculada:');
                console.log('   - Con potencias actuales:', resultWithActualPowers.totalAnnual, 'â‚¬/aÃ±o, ahorro:', resultWithActualPowers.savings);
                console.log('   - Con potencias optimizadas:', resultWithOptimizedPowers.totalAnnual, 'â‚¬/aÃ±o, ahorro:', resultWithOptimizedPowers.savings);
                
                // Actualizar window.lastDualPowerComparison
                window.lastDualPowerComparison.actual = resultWithActualPowers;
                window.lastDualPowerComparison.optimized = resultWithOptimizedPowers;
                
                // Actualizar lastComparisonResult para compatibilidad
                lastComparisonResult = resultWithOptimizedPowers;
                lastComparisonResult.isMulti = false;
                
                // Cerrar modales
                document.getElementById('offer-decision-modal').classList.add('hidden');
                document.getElementById('offer-decision-modal').classList.remove('flex');
                document.getElementById('offer-selection-modal').classList.add('hidden');
                document.getElementById('offer-selection-modal').classList.remove('flex');
                
                // Renderizar vista dual
                renderDualPowerResultsUI(resultWithActualPowers, resultWithOptimizedPowers, window.lastDualPowerComparison.brand);
                
                document.getElementById('initial-view').classList.add('hidden');
                document.getElementById('scanner-view').classList.add('hidden');
                document.getElementById('results-view').classList.remove('hidden');
                document.getElementById('results-view').classList.add('animate-fade-in-up');
                
                return; // IMPORTANTE: Salir aquÃ­ para no ejecutar el resto
            }
            
            // Usar la oferta seleccionada manualmente
            let result = manuallySelectedOffer;
            
            if (!result) {
                console.error('No result available!');
                return;
            }
            
            console.log('Result offer:', result.offer.name);
            
            // Verificar si estamos en contexto MultiCups
            const isMultiCupsContext = lastComparisonResult && lastComparisonResult._multiCupsContext;
            
            if (isMultiCupsContext) {
                // Contexto MultiCups: Necesitamos TODOS los datos de lastComparisonResult
                // pero con la OFERTA seleccionada manualmente
                console.log('MultiCups context: recalculating costs for selected offer');
                
                // CRÃTICO: Si la oferta viene de selecciÃ³n manual, buscar la tarifa ORIGINAL
                let offerToUse = result.offer;
                
                if (result._needsOriginalLookup) {
                    const tariffType = lastComparisonResult.originalTariffType;
                    console.log('ðŸ” Looking up original tariff in currentTariffs[' + tariffType + ']');
                    console.log('Searching for:', result.offer.name, '/', result.offer.description);
                    
                    const originalTariff = currentTariffs[tariffType]?.find(t => 
                        t.name === result.offer.name && t.description === result.offer.description
                    );
                    
                    if (originalTariff) {
                        console.log('âœ… Found original tariff, using it instead of contaminated offer');
                        offerToUse = originalTariff;
                    } else {
                        console.error('âŒ Original tariff not found, using provided offer (may be contaminated)');
                    }
                }
                
                // Usar la funciÃ³n centralizada para recalcular costes
                const recalculated = recalculateCostsForOffer(lastComparisonResult, offerToUse);
                
                // CRÃTICO: Recalcular totalAnnual y savings usando los costes recalculados
                // No usar result.totalAnnual que puede estar contaminado
                const IVA_RATE = 0.21;
                const IE_RATE = 0.05113;
                const diasFacturados = lastComparisonResult.dias_facturados || 30;
                const factorAnual = 365 / diasFacturados;
                
                const subBase = recalculated.subPower + recalculated.subEnergyNet;
                const costIE = subBase * IE_RATE;
                const baseImp = subBase + costIE;
                const costIVA = baseImp * IVA_RATE;
                const totalPeriod = baseImp + costIVA;
                const totalAnnual = totalPeriod * factorAnual;
                const originalBillAnnual = lastComparisonResult.originalBillAnnual;
                const savings = originalBillAnnual - totalAnnual;
                
                console.log('Recalculated totalAnnual:', totalAnnual, 'savings:', savings);
                
                // Crear un nuevo objeto combinando lastComparisonResult (datos base) 
                // con la oferta elegida manualmente y los costes recalculados
                const combinedResult = {
                    ...lastComparisonResult,  // Todos los datos base (CUPS, consumos, potencias, etc.)
                    offer: deepCopyOffer(offerToUse),  // COPIA PROFUNDA de la oferta ORIGINAL
                    totalAnnual: totalAnnual,  // Coste anual RECALCULADO
                    totalPeriod: totalPeriod,  // Coste periodo RECALCULADO
                    savings: savings,          // Ahorro RECALCULADO
                    energyCosts: recalculated.energyCosts,  // Desglose RECALCULADO de energÃ­a
                    powerCosts: recalculated.powerCosts,    // Desglose RECALCULADO de potencia
                    subPower: recalculated.subPower,        // Subtotal RECALCULADO de potencia
                    subEnergyNet: recalculated.subEnergyNet, // Subtotal RECALCULADO de energÃ­a
                    subBase: subBase,
                    costIE: costIE,
                    baseImp: baseImp,
                    costIVA: costIVA,
                    isNegativeSavings: savings <= 0
                };
                
                console.log('Combined result with recalculated costs:', combinedResult);
                console.log('Energy costs periods:', combinedResult.energyCosts.length);
                console.log('Power costs periods:', combinedResult.powerCosts.length);
                
                // IMPORTANTE: Si compareWithIndexed estÃ¡ activo, calcular resultado indexado ANTES de aÃ±adir a la lista
                if (compareWithIndexed) {
                    const tariffType = lastComparisonResult.originalTariffType;
                    const dataForCalc = lastComparisonResult;
                    const indexedResult = calculateIndexedOffer(dataForCalc, tariffType);
                    
                    if (indexedResult) {
                        // Recalcular costes para resultado indexado
                        const recalculatedIndexed = recalculateCostsForOffer(indexedResult, indexedResult.offer);
                        indexedResult.energyCosts = recalculatedIndexed.energyCosts;
                        indexedResult.powerCosts = recalculatedIndexed.powerCosts;
                        indexedResult.subPower = recalculatedIndexed.subPower;
                        indexedResult.subEnergyNet = recalculatedIndexed.subEnergyNet;
                        
                        // Calcular todos los costes adicionales para indexedResult
                        const subEnergyNetIndexed = indexedResult.subEnergyNet || 0;
                        const subPowerIndexed = indexedResult.subPower || 0;
                        const subBaseIndexed = subPowerIndexed + subEnergyNetIndexed;
                        const costIEIndexed = subBaseIndexed * IE_RATE;
                        const baseImpIndexed = subBaseIndexed + costIEIndexed;
                        const costIVAIndexed = baseImpIndexed * IVA_RATE;
                        const totalPeriodIndexed = baseImpIndexed + costIVAIndexed;
                        const totalAnnualIndexed = totalPeriodIndexed * factorAnual;
                        const savingsIndexed = originalBillAnnual - totalAnnualIndexed;
                        
                        // AÃ±adir los campos calculados al indexedResult
                        indexedResult.subBase = subBaseIndexed;
                        indexedResult.costIE = costIEIndexed;
                        indexedResult.baseImp = baseImpIndexed;
                        indexedResult.costIVA = costIVAIndexed;
                        indexedResult.totalPeriod = totalPeriodIndexed;
                        indexedResult.totalAnnual = totalAnnualIndexed;
                        indexedResult.savings = savingsIndexed;
                        indexedResult.dias_facturados = combinedResult.dias_facturados;
                        indexedResult.originalBillAnnual = originalBillAnnual;
                        indexedResult.originalBillPeriod = lastComparisonResult.originalBillPeriod;
                        indexedResult.cups = combinedResult.cups;
                        indexedResult.originalTariffType = combinedResult.originalTariffType; // CRÃTICO
                        indexedResult.ieRate = IE_RATE; // AÃ±adir la tasa del impuesto elÃ©ctrico
                        indexedResult.discountAmount = indexedResult.discountAmount || 0; // Preservar o inicializar
                        indexedResult.discountRate = indexedResult.discountRate || 0; // Preservar o inicializar
                        indexedResult.subEnergy = indexedResult.subEnergy || indexedResult.subEnergyNet; // Por compatibilidad
                        
                        console.log('indexedResult completo con todos los campos:', {
                            originalTariffType: indexedResult.originalTariffType,
                            powerCosts: indexedResult.powerCosts?.length,
                            energyCosts: indexedResult.energyCosts?.length,
                            dias_facturados: indexedResult.dias_facturados
                        });
                        
                        // AÃ±adir al resultado combinado ANTES de aÃ±adir a la lista
                        combinedResult.indexedComparison = indexedResult;
                        console.log('AÃ±adido resultado indexado completo al combinedResult:', indexedResult);
                    }
                }
                
                // Ahora sÃ­, aÃ±adir a la lista (ya con indexedComparison si corresponde)
                addSupplyToMultiCupsList(combinedResult);
            } else {
                // Contexto individual: Mostrar resultados
                console.log('Individual context, showing results');
                
                // CRÃTICO: Aplicar branding segÃºn el modo de comparaciÃ³n
                // Si el usuario eligiÃ³ "POWER CUP Global", SIEMPRE usar POWER CUP
                // Si eligiÃ³ "DRK Prioritario", usar la marca de la tarifa ganadora
                let brand;
                if (comparisonMode === 'overall_best') {
                    // POWER CUP Global: SIEMPRE verde, independiente de quiÃ©n gane
                    brand = BRANDS.POWER_CUP;
                    console.log('Modo POWER CUP Global: Forzando branding POWER CUP (verde)');
                } else {
                    // DRK Prioritario: Usar marca de la tarifa ganadora
                    brand = result.offer.isDrk ? BRANDS.DRK : BRANDS.POWER_CUP;
                    console.log('Modo DRK Prioritario: Branding segÃºn ganador:', brand.NAME);
                }
                
                console.log('Applying brand:', brand.NAME);
                applyBrandStyles(brand);
                activeBrand = brand;
                
                // Asignar como resultado final
                lastComparisonResult = result;
                lastComparisonResult.isMulti = false;
                
                // Si compareWithIndexed estÃ¡ activo, calcular resultado indexado
                let indexedResult = null;
                if (compareWithIndexed) {
                    const tariffType = result.originalTariffType || currentTariffType;
                    indexedResult = calculateIndexedOffer(result, tariffType);
                    
                    if (indexedResult) {
                        lastIndexedResult = indexedResult;
                        console.log('Calculado resultado indexado para contexto individual:', indexedResult.offer.name);
                    }
                }
                
                console.log('About to render results UI');
                
                // âš¡âš¡âš¡ MODO DUAL - USAR FLUJO CON DIRECCIÃ“N âš¡âš¡âš¡
                if (window.dualMode === true) {
                    console.log('===== ðŸ”¥ MODO DUAL - Usando flujo con direcciÃ³n (selecciÃ³n manual) =====');
                    
                    // Preparar datos para el flujo unificado
                    const tariff = result.tariffType || result.originalTariffType || currentTariffType || '2.0TD';
                    const data = {
                        cups: result.cups || 'CUPS-ELECTRICIDAD',
                        tariff: tariff,
                        kwh_p1: parseFloat(result.kwh_p1) || 0,
                        kwh_p2: parseFloat(result.kwh_p2) || 0,
                        kwh_p3: parseFloat(result.kwh_p3) || 0,
                        kwh_p4: parseFloat(result.kwh_p4) || 0,
                        kwh_p5: parseFloat(result.kwh_p5) || 0,
                        kwh_p6: parseFloat(result.kwh_p6) || 0,
                        p1: parseFloat(result.p1) || 0,
                        p2: parseFloat(result.p2) || 0,
                        p3: parseFloat(result.p3) || 0,
                        p4: parseFloat(result.p4) || 0,
                        p5: parseFloat(result.p5) || 0,
                        p6: parseFloat(result.p6) || 0,
                        dias: parseInt(result.dias) || 30,
                        originalBillAnnual: result.originalBillAnnual || (result.importe_total || 0) * 12
                    };
                    
                    const drkCost = result.totalAnnual || 0;
                    const powercupCost = indexedResult ? (indexedResult.totalAnnual || 0) : 0;
                    
                    const results = {
                        drk: {
                            total: drkCost / 12,
                            total_anual: drkCost
                        },
                        powercup: {
                            total: powercupCost / 12,
                            total_anual: powercupCost
                        }
                    };
                    
                    console.log('Llamando a dualAddFromResults desde selecciÃ³n manual');
                    
                    // Cerrar modal de decisiÃ³n primero
                    const offerModal = document.getElementById('offer-decision-modal');
                    if (offerModal) {
                        offerModal.classList.add('hidden');
                        offerModal.classList.remove('flex');
                    }
                    
                    // Usar el flujo con modal de direcciÃ³n, pasando result completo
                    window.dualAddFromResults('electricidad', tariff, data, results, result);
                    
                    return;
                }
                
                // NUEVO: Verificar si hay comparativo dual de potencias activo
                if (window.lastDualPowerComparison) {
                    console.log('ðŸ”¥ Comparativo DUAL DE POTENCIAS detectado - Renderizando vista dual');
                    const dualComp = window.lastDualPowerComparison;
                    renderDualPowerResultsUI(dualComp.actual, dualComp.optimized, dualComp.brand);
                } else if (indexedResult && compareWithIndexed) {
                    // Comparativa Fijo vs Indexado
                    renderDualComparisonUI(result, indexedResult);
                } else {
                    // Mostrar resultados normales
                    renderResultsUI(result);
                }
                
                console.log('Hiding initial-view and showing results-view');
                document.getElementById('loading-status').classList.add('hidden');
                document.getElementById('initial-view').classList.add('hidden');
                document.getElementById('scanner-view').classList.add('hidden');
                document.getElementById('results-view').classList.remove('hidden');
                document.getElementById('results-view').classList.add('animate-fade-in-up');
                
                // CRÃTICO: Si el resultado tiene needsImprovementRequest, abrir automÃ¡ticamente el modal
                if (result.needsImprovementRequest && comparisonMode === 'drk_only') {
                    console.log('ðŸ”” DRK ÃšNICAMENTE sin ahorro detectado - Abriendo modal de solicitud de mejora automÃ¡ticamente');
                    setTimeout(() => {
                        const improvementModal = document.getElementById('request-improvement-modal');
                        if (improvementModal) {
                            improvementModal.classList.remove('hidden');
                            improvementModal.classList.add('flex');
                        }
                    }, 500); // PequeÃ±o delay para que se muestre primero la pantalla de resultados
                }
                
                console.log('Done showing results');
            }
        }
        
        function populateOfferSelector() {
            // Esta funciÃ³n ya no se usa, pero la mantenemos por compatibilidad
        }
        
        function handleManualOfferSelection(e) {
            // Esta funciÃ³n ya no se usa, pero la mantenemos por compatibilidad
        }
        
        // --- FIX: CancelaciÃ³n del EscÃ¡ner ---
        function cancelScanner() {
            stopScanner(); // Detiene el stream de la cÃ¡mara
            document.getElementById('scanner-view').classList.add('hidden');
            // Vuelve a la vista de selecciÃ³n de entrada (initial-view)
            document.getElementById('initial-view').classList.remove('hidden');
            document.getElementById('loading-status').classList.add('hidden');
        }

        // --- INIT ---

        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar texto del botÃ³n de desglose
            const detailsToggleText = document.getElementById('details-toggle-text');
            if (detailsToggleText) {
                detailsToggleText.textContent = 'Ver desglose detallado del cÃ¡lculo';
            }
            
            // Setup Event Listeners
            document.getElementById('manual-input-btn').onclick = startManualInputFlow;
            document.getElementById('execute-manual-input-btn').onclick = handleManualInput;
            
            // FIX APLICADO: El botÃ³n de cancelar del escÃ¡ner ahora vuelve a la vista de input, no a resetToLanding
            document.getElementById('stop-scan-btn').onclick = cancelScanner;  
            
            document.getElementById('start-scan-btn').onclick = startScanner;
            document.getElementById('capture-photo-btn').onclick = capturePhoto;
            
            // ModificaciÃ³n del botÃ³n de volver para la vista de entrada
            document.querySelector('#initial-view button:first-child').onclick = () => {
                currentTariffType === 'MULTICUPS' ? showMultiCupsSagaView() : goBackFromInitialView();
            };
            
            document.getElementById('upload-menu-btn').onclick = () => {
                document.getElementById('qr-options-modal').classList.remove('hidden');
                document.getElementById('qr-options-modal').classList.add('flex');
            };
            
            // NUEVO: BotÃ³n Capturar Foto QR - Abre cÃ¡mara nativa
            document.getElementById('camera-capture-btn').onclick = () => {
                document.getElementById('qr-options-modal').classList.add('hidden');
                document.getElementById('qr-options-modal').classList.remove('flex');
                document.getElementById('camera-capture-input').click();
            };
            
            document.getElementById('camera-capture-input').addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    console.log('ðŸ“¸ Imagen capturada desde cÃ¡mara nativa');
                    decodeQRFromImage(e.target.files[0]);
                    e.target.value = ''; // Limpiar input
                }
            });
            
            // BotÃ³n de Finalizar MULTICUPS (en la nueva vista SAGA)
            document.getElementById('multicups-finalize-btn-saga').onclick = finalizeMultiCups;

            // BotÃ³n para subir imagen
            document.getElementById('modal-upload-file-btn').addEventListener('click', () => document.getElementById('image-file-input').click());
            document.getElementById('image-file-input').addEventListener('change', (e) => {
                document.getElementById('qr-options-modal').classList.add('hidden');
                document.getElementById('qr-options-modal').classList.remove('flex');
                if (e.target.files[0]) decodeQRFromImage(e.target.files[0]);
                e.target.value = '';
            });
            
            setupPasteCatcher(); // <-- Llamada ahora segura

            // === NUEVO: Event listeners para "Pegar CÃ³digo Completo" ===
            document.getElementById('modal-paste-url-btn').addEventListener('click', () => {
                console.log('ðŸ“‹ [PASTE URL] Abriendo modal para pegar cÃ³digo completo');
                // Cerrar modal de opciones
                document.getElementById('qr-options-modal').classList.add('hidden');
                document.getElementById('qr-options-modal').classList.remove('flex');
                // Abrir modal de paste URL
                document.getElementById('paste-url-modal').classList.remove('hidden');
                document.getElementById('paste-url-modal').classList.add('flex');
                // Limpiar textarea
                document.getElementById('paste-url-textarea').value = '';
                // Focus en textarea
                setTimeout(() => document.getElementById('paste-url-textarea').focus(), 100);
            });

            document.getElementById('paste-url-process-btn').addEventListener('click', () => {
                const urlText = document.getElementById('paste-url-textarea').value.trim();
                
                if (!urlText) {
                    alert('Por favor, pega el cÃ³digo QR completo en el Ã¡rea de texto.');
                    return;
                }
                
                console.log('âœ… [PASTE URL] Procesando URL pegada');
                console.log(`ðŸ“Š URL: ${urlText.substring(0, 100)}...`);
                
                // Cerrar modal
                document.getElementById('paste-url-modal').classList.add('hidden');
                document.getElementById('paste-url-modal').classList.remove('flex');
                
                // Procesar como si fuera un QR leÃ­do
                handleQRRead(urlText);
            });

            document.getElementById('paste-url-cancel-btn').addEventListener('click', () => {
                console.log('âŒ [PASTE URL] Cancelado');
                document.getElementById('paste-url-modal').classList.add('hidden');
                document.getElementById('paste-url-modal').classList.remove('flex');
            });
            // === FIN Event listeners Pegar CÃ³digo Completo ===

            document.getElementById('send-offer-btn').onclick = () => {
                if (lastComparisonResult) {
                    document.getElementById('send-offer-modal').classList.remove('hidden');
                    document.getElementById('send-offer-modal').classList.add('flex');
                    // Aplicar focus ring de la marca a los inputs
                    document.querySelectorAll('#send-offer-modal input').forEach(input => {
                        input.classList.remove('focus:ring-drk-500', 'focus:ring-powercup-500');
                        input.classList.add(activeBrand.NAME.includes('DRK') ? 'focus:ring-drk-500' : 'focus:ring-powercup-500');
                    });
                } else {
                    window.showErrorModal("Por favor, analice una factura primero para generar una oferta.");
                }
            };
            
            document.getElementById('execute-send-offer-btn').addEventListener('click', handleCopyOffer);
            document.getElementById('execute-pdf-offer-btn').addEventListener('click', handleGeneratePDF);
            
            // NUEVO: Event listeners para solicitar mejora a DRK
            document.getElementById('request-improvement-btn').onclick = () => {
                if (lastComparisonResult) {
                    document.getElementById('request-improvement-modal').classList.remove('hidden');
                    document.getElementById('request-improvement-modal').classList.add('flex');
                } else {
                    window.showErrorModal("Por favor, analice una factura primero.");
                }
            };
            
            // NUEVO: Event listener para botÃ³n de solicitar mejora en GAS
            const gasImprovementBtn = document.getElementById('gas-request-improvement-btn');
            if (gasImprovementBtn) {
                gasImprovementBtn.onclick = () => {
                    if (window.lastGasComparisonResult) {
                        document.getElementById('request-improvement-modal').classList.remove('hidden');
                        document.getElementById('request-improvement-modal').classList.add('flex');
                    } else {
                        window.showErrorModal("Por favor, analice una factura primero.");
                    }
                };
            }
            
            // NUEVO: Event listener para botÃ³n de solicitar mejora en DUAL
            const dualImprovementBtn = document.getElementById('dual-request-improvement-btn');
            if (dualImprovementBtn) {
                dualImprovementBtn.onclick = () => {
                    if (window.dualGlobalResults && dualSupplies.length >= 2) {
                        document.getElementById('request-improvement-modal').classList.remove('hidden');
                        document.getElementById('request-improvement-modal').classList.add('flex');
                    } else {
                        window.showErrorModal("Por favor, realice una comparaciÃ³n DUAL primero.");
                    }
                };
            }
            
            document.getElementById('execute-improvement-request-btn').addEventListener('click', handleRequestImprovement);

            document.getElementById('qr-toggle-checkbox').addEventListener('change', (e) => {
                const wrapper = document.getElementById('qr-content-wrapper');
                if (e.target.checked) {
                    generateQRCode(activeBrand);
                    wrapper.classList.add('active');
                } else {
                    wrapper.classList.remove('active');
                }
            });

            document.querySelectorAll('input[name="comparison_mode"]').forEach(r => {
                r.addEventListener('change', (e) => updateComparisonMode(e.target.value));
            });
            
            // Event listener para botÃ³n de confirmar selecciÃ³n de oferta
            document.getElementById('confirm-offer-selection-btn').addEventListener('click', confirmOfferSelection);
            
            // Disparar evento de cambio inicial para aplicar el branding pre-seleccionado
            const initialModeInput = document.querySelector('input[name="comparison_mode"]:checked');
            if (initialModeInput) {
                updateComparisonMode(initialModeInput.value);
            }
        });
        
        // FUNCIÃ“N MEJORADA: Preprocesar imagen para mejor detecciÃ³n de QR
        function preprocessImage(imageData, options = {}) {
            const {
                brightness = 0,
                contrast = 1.0,
                sharpen = false,
                scale = 1.0
            } = options;
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = Math.floor(imageData.width * scale);
            canvas.height = Math.floor(imageData.height * scale);
            
            // Crear ImageData temporal
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = imageData.width;
            tempCanvas.height = imageData.height;
            tempCtx.putImageData(imageData, 0, 0);
            
            // Escalar si es necesario
            ctx.drawImage(tempCanvas, 0, 0, canvas.width, canvas.height);
            
            // Aplicar ajustes de brillo y contraste
            if (brightness !== 0 || contrast !== 1.0) {
                ctx.filter = `brightness(${1 + brightness}) contrast(${contrast})`;
                ctx.drawImage(canvas, 0, 0);
                ctx.filter = 'none';
            }
            
            const processedData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = processedData.data;
            
            // Aplicar nitidez (sharpening) si estÃ¡ habilitado
            if (sharpen) {
                const width = processedData.width;
                const height = processedData.height;
                const kernel = [-1, -1, -1, -1, 9, -1, -1, -1, -1]; // Kernel de nitidez
                const output = new Uint8ClampedArray(data.length);
                
                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        const idx = (y * width + x) * 4;
                        let r = 0, g = 0, b = 0;
                        
                        for (let ky = -1; ky <= 1; ky++) {
                            for (let kx = -1; kx <= 1; kx++) {
                                const kidx = ((y + ky) * width + (x + kx)) * 4;
                                const k = kernel[(ky + 1) * 3 + (kx + 1)];
                                r += data[kidx] * k;
                                g += data[kidx + 1] * k;
                                b += data[kidx + 2] * k;
                            }
                        }
                        
                        output[idx] = Math.min(255, Math.max(0, r));
                        output[idx + 1] = Math.min(255, Math.max(0, g));
                        output[idx + 2] = Math.min(255, Math.max(0, b));
                        output[idx + 3] = data[idx + 3];
                    }
                }
                
                for (let i = 0; i < data.length; i++) {
                    data[i] = output[i];
                }
            }
            
            return processedData;
        }
        
        // NUEVA FUNCIÃ“N: Detectar automÃ¡ticamente regiÃ³n del QR y recortar
        function detectAndCropQR(imageData) {
            const width = imageData.width;
            const height = imageData.height;
            const data = imageData.data;
            
            // Convertir a escala de grises y detectar bordes
            const gray = new Uint8ClampedArray(width * height);
            for (let i = 0; i < data.length; i += 4) {
                const idx = i / 4;
                gray[idx] = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
            }
            
            // Binarizar con threshold adaptativo mÃ¡s sensible
            const binary = new Uint8ClampedArray(width * height);
            const threshold = 140; // MÃ¡s sensible para detectar QR pequeÃ±os
            for (let i = 0; i < gray.length; i++) {
                binary[i] = gray[i] < threshold ? 0 : 255;
            }
            
            // Encontrar lÃ­mites del contenido (no blanco)
            let minX = width, maxX = 0, minY = height, maxY = 0;
            let darkPixels = 0;
            
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const idx = y * width + x;
                    // Si el pÃ­xel es oscuro (parte del QR)
                    if (binary[idx] < 128) {
                        darkPixels++;
                        if (x < minX) minX = x;
                        if (x > maxX) maxX = x;
                        if (y < minY) minY = y;
                        if (y > maxY) maxY = y;
                    }
                }
            }
            
            // Si no hay suficiente contenido oscuro, devolver imagen original
            const darkPixelRatio = darkPixels / (width * height);
            if (darkPixels === 0 || maxX <= minX || maxY <= minY || darkPixelRatio < 0.01) {
                console.log('ðŸ” No hay suficiente contenido oscuro para recortar');
                return imageData;
            }
            
            // AÃ±adir margen mÃ¡s generoso (15% para screenshots)
            const marginX = Math.floor((maxX - minX) * 0.15);
            const marginY = Math.floor((maxY - minY) * 0.15);
            
            minX = Math.max(0, minX - marginX);
            maxX = Math.min(width - 1, maxX + marginX);
            minY = Math.max(0, minY - marginY);
            maxY = Math.min(height - 1, maxY + marginY);
            
            const cropWidth = maxX - minX + 1;
            const cropHeight = maxY - minY + 1;
            
            // Para screenshots: aceptar recortes mÃ¡s pequeÃ±os (5% en lugar de 20%)
            const minSize = Math.min(width, height) * 0.05;
            if (cropWidth < minSize || cropHeight < minSize) {
                console.log('ðŸ” Recorte demasiado pequeÃ±o, usando imagen completa');
                return imageData;
            }
            
            // Crear nueva imagen recortada
            const croppedCanvas = document.createElement('canvas');
            const croppedCtx = croppedCanvas.getContext('2d');
            croppedCanvas.width = cropWidth;
            croppedCanvas.height = cropHeight;
            
            // Copiar regiÃ³n recortada
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = width;
            tempCanvas.height = height;
            tempCtx.putImageData(imageData, 0, 0);
            
            croppedCtx.drawImage(tempCanvas, minX, minY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
            
            const croppedData = croppedCtx.getImageData(0, 0, cropWidth, cropHeight);
            
            const reductionPercent = Math.round((1 - (cropWidth*cropHeight)/(width*height)) * 100);
            console.log(`ðŸ“ QR recortado: ${width}x${height} â†’ ${cropWidth}x${cropHeight} (-${reductionPercent}% Ã¡rea)`);
            
            return croppedData;
        }
        
        // NUEVA FUNCIÃ“N: Mejorar contraste con binarizaciÃ³n adaptativa
        function enhanceQRContrast(imageData) {
            const width = imageData.width;
            const height = imageData.height;
            const data = new Uint8ClampedArray(imageData.data);
            
            // Convertir a escala de grises
            const gray = new Uint8ClampedArray(width * height);
            for (let i = 0; i < data.length; i += 4) {
                const idx = i / 4;
                gray[idx] = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
            }
            
            // Calcular threshold adaptativo (mÃ©todo de Otsu simplificado)
            let histogram = new Array(256).fill(0);
            for (let i = 0; i < gray.length; i++) {
                histogram[Math.floor(gray[i])]++;
            }
            
            let sum = 0;
            for (let i = 0; i < 256; i++) {
                sum += i * histogram[i];
            }
            
            let sumB = 0;
            let wB = 0;
            let wF = 0;
            let maxVariance = 0;
            let threshold = 0;
            
            for (let i = 0; i < 256; i++) {
                wB += histogram[i];
                if (wB === 0) continue;
                
                wF = gray.length - wB;
                if (wF === 0) break;
                
                sumB += i * histogram[i];
                const mB = sumB / wB;
                const mF = (sum - sumB) / wF;
                const variance = wB * wF * (mB - mF) * (mB - mF);
                
                if (variance > maxVariance) {
                    maxVariance = variance;
                    threshold = i;
                }
            }
            
            // Aplicar binarizaciÃ³n
            for (let i = 0; i < gray.length; i++) {
                const binary = gray[i] < threshold ? 0 : 255;
                const idx = i * 4;
                data[idx] = binary;
                data[idx + 1] = binary;
                data[idx + 2] = binary;
                // Alpha no se toca
            }
            
            console.log(`ðŸŽ¨ BinarizaciÃ³n aplicada con threshold: ${threshold}`);
            
            return new ImageData(data, width, height);
        }

        // NUEVA FUNCIÃ“N: Detectar regiÃ³n del QR y recortar AGRESIVAMENTE
        function smartCropQRRegion(imageData) {
            const width = imageData.width;
            const height = imageData.height;
            const data = imageData.data;
            
            console.log(`ðŸ” Buscando regiÃ³n QR en imagen ${width}x${height}...`);
            
            // Convertir a escala de grises
            const gray = new Uint8ClampedArray(width * height);
            for (let i = 0; i < data.length; i += 4) {
                const idx = i / 4;
                gray[idx] = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
            }
            
            // Calcular threshold adaptativo (mÃ©todo Otsu)
            let histogram = new Array(256).fill(0);
            for (let i = 0; i < gray.length; i++) {
                histogram[gray[i]]++;
            }
            
            let total = gray.length;
            let sum = 0;
            for (let i = 0; i < 256; i++) {
                sum += i * histogram[i];
            }
            
            let sumB = 0;
            let wB = 0;
            let wF = 0;
            let maxVariance = 0;
            let threshold = 0;
            
            for (let i = 0; i < 256; i++) {
                wB += histogram[i];
                if (wB === 0) continue;
                
                wF = total - wB;
                if (wF === 0) break;
                
                sumB += i * histogram[i];
                let mB = sumB / wB;
                let mF = (sum - sumB) / wF;
                let variance = wB * wF * (mB - mF) * (mB - mF);
                
                if (variance > maxVariance) {
                    maxVariance = variance;
                    threshold = i;
                }
            }
            
            console.log(`ðŸ“Š Threshold Otsu calculado: ${threshold}`);
            
            // Binarizar con threshold adaptativo
            const binary = new Uint8ClampedArray(width * height);
            for (let i = 0; i < gray.length; i++) {
                binary[i] = gray[i] < threshold ? 0 : 255;
            }
            
            // Detectar bloques con alta densidad de pÃ­xeles oscuros (QR)
            const blockSize = Math.min(50, Math.floor(Math.min(width, height) / 10));
            const blocksX = Math.ceil(width / blockSize);
            const blocksY = Math.ceil(height / blockSize);
            const blockDensity = [];
            
            for (let by = 0; by < blocksY; by++) {
                for (let bx = 0; bx < blocksX; bx++) {
                    let darkPixels = 0;
                    let totalPixels = 0;
                    
                    for (let y = by * blockSize; y < Math.min((by + 1) * blockSize, height); y++) {
                        for (let x = bx * blockSize; x < Math.min((bx + 1) * blockSize, width); x++) {
                            const idx = y * width + x;
                            totalPixels++;
                            if (binary[idx] === 0) darkPixels++;
                        }
                    }
                    
                    const density = darkPixels / totalPixels;
                    blockDensity.push({ bx, by, density });
                }
            }
            
            // Encontrar bloques con densidad entre 15% y 70% (tÃ­pico de QR)
            const qrBlocks = blockDensity.filter(b => b.density > 0.15 && b.density < 0.70);
            
            if (qrBlocks.length === 0) {
                console.log('âš ï¸ No se encontraron bloques QR, usando imagen completa');
                return imageData;
            }
            
            // Encontrar regiÃ³n que contiene los bloques QR
            let minBx = Math.min(...qrBlocks.map(b => b.bx));
            let maxBx = Math.max(...qrBlocks.map(b => b.bx));
            let minBy = Math.min(...qrBlocks.map(b => b.by));
            let maxBy = Math.max(...qrBlocks.map(b => b.by));
            
            // Convertir bloques a pÃ­xeles con margen generoso (30%)
            let minX = Math.max(0, minBx * blockSize - blockSize * 2);
            let maxX = Math.min(width - 1, (maxBx + 1) * blockSize + blockSize * 2);
            let minY = Math.max(0, minBy * blockSize - blockSize * 2);
            let maxY = Math.min(height - 1, (maxBy + 1) * blockSize + blockSize * 2);
            
            const cropWidth = maxX - minX;
            const cropHeight = maxY - minY;
            
            // Si el recorte es muy pequeÃ±o (< 3% de la imagen), no recortar
            const cropArea = cropWidth * cropHeight;
            const totalArea = width * height;
            const cropPercent = (cropArea / totalArea) * 100;
            
            if (cropPercent < 3) {
                console.log(`âš ï¸ RegiÃ³n QR muy pequeÃ±a (${cropPercent.toFixed(1)}%), usando imagen completa`);
                return imageData;
            }
            
            // Crear canvas recortado
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = width;
            tempCanvas.height = height;
            tempCtx.putImageData(imageData, 0, 0);
            
            const croppedCanvas = document.createElement('canvas');
            const croppedCtx = croppedCanvas.getContext('2d');
            croppedCanvas.width = cropWidth;
            croppedCanvas.height = cropHeight;
            
            croppedCtx.drawImage(tempCanvas, minX, minY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
            
            const croppedData = croppedCtx.getImageData(0, 0, cropWidth, cropHeight);
            
            console.log(`âœ‚ï¸ RegiÃ³n QR recortada: ${width}x${height} â†’ ${cropWidth}x${cropHeight} (${cropPercent.toFixed(1)}% de imagen)`);
            
            return croppedData;
        }
        
        function decodeQRFromImage(imageFileOrBlob) {
            // Mostrar overlay grande
            const overlay = document.getElementById('qr-processing-overlay');
            const progressMsg = document.getElementById('qr-progress-message');
            const attemptCounter = document.getElementById('qr-attempt-counter');
            
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            progressMsg.textContent = 'Cargando imagen...';
            attemptCounter.textContent = '0 / 15';
            
            // TIMEOUT DE SEGURIDAD (60 segundos para imÃ¡genes grandes)
            let processingComplete = false;
            const timeoutId = setTimeout(() => {
                if (!processingComplete) {
                    console.error('â±ï¸ TIMEOUT: Procesamiento tomÃ³ mÃ¡s de 60s');
                    overlay.classList.add('hidden');
                    overlay.classList.remove('flex');
                    window.showErrorModal(
                        "â±ï¸ El procesamiento tardÃ³ demasiado.\n\n" +
                        "ðŸ’¡ Intenta:\n" +
                        "â€¢ Usar el ESCÃNER EN VIVO\n" +
                        "â€¢ Hacer nueva foto mÃ¡s cerca del QR\n" +
                        "â€¢ Capturar solo el QR (no toda la pÃ¡gina)"
                    );
                }
            }, 60000); // 60 segundos
            
            const img = new Image();
            const url = URL.createObjectURL(imageFileOrBlob);
            
            img.onload = () => {
                try {
                    URL.revokeObjectURL(url);
                    
                    console.log(`ðŸ“¸ Imagen original: ${img.width}x${img.height}`);
                    
                    // OPTIMIZACIÃ“N CRÃTICA: Reducir imÃ¡genes muy grandes ANTES
                    const MAX_DIMENSION = 2000; // TamaÃ±o mÃ¡ximo para procesamiento rÃ¡pido
                    let workingCanvas = document.createElement('canvas');
                    let workingCtx = workingCanvas.getContext('2d');
                    
                    if (img.width > MAX_DIMENSION || img.height > MAX_DIMENSION) {
                        // Reducir imagen proporcionalmente
                        const scale = MAX_DIMENSION / Math.max(img.width, img.height);
                        workingCanvas.width = Math.floor(img.width * scale);
                        workingCanvas.height = Math.floor(img.height * scale);
                        console.log(`âš¡ Optimizando: ${img.width}x${img.height} â†’ ${workingCanvas.width}x${workingCanvas.height}`);
                        progressMsg.textContent = 'âš¡ Optimizando imagen grande...';
                    } else {
                        workingCanvas.width = img.width;
                        workingCanvas.height = img.height;
                    }
                    
                    workingCtx.drawImage(img, 0, 0, workingCanvas.width, workingCanvas.height);
                    const baseImageData = workingCtx.getImageData(0, 0, workingCanvas.width, workingCanvas.height);
                    
                    // PASO CRÃTICO: Detectar y recortar regiÃ³n QR PRIMERO
                    progressMsg.textContent = 'ðŸ” Detectando regiÃ³n QR...';
                    const croppedImageData = smartCropQRRegion(baseImageData);
                    
                    // Crear nuevo canvas con imagen recortada
                    const croppedCanvas = document.createElement('canvas');
                    const croppedCtx = croppedCanvas.getContext('2d');
                    croppedCanvas.width = croppedImageData.width;
                    croppedCanvas.height = croppedImageData.height;
                    croppedCtx.putImageData(croppedImageData, 0, 0);
                    
                    let attemptNum = 0;
                    
                    // FUNCIÃ“N PARA PROBAR UN ESCALADO CON PROTECCIÃ“N
                    const tryScale = (scale, label, canvas = croppedCanvas) => {
                        attemptNum++;
                        console.log(`ðŸ” Intento ${attemptNum}: ${label} (escala ${scale}x)`);
                        
                        // Actualizar UI
                        progressMsg.textContent = label;
                        attemptCounter.textContent = `${attemptNum} / 12`;
                        
                        try {
                            // Calcular tamaÃ±o resultante
                            const targetWidth = Math.floor(canvas.width * scale);
                            const targetHeight = Math.floor(canvas.height * scale);
                            
                            // LÃMITE DE SEGURIDAD: No mÃ¡s de 6000x6000 (reducido para velocidad)
                            if (targetWidth > 6000 || targetHeight > 6000) {
                                console.warn(`âš ï¸ Escalado ${scale}x limitado para velocidad`);
                                const limitScale = Math.min(6000 / canvas.width, 6000 / canvas.height);
                                return tryScaleSafe(limitScale, label, canvas);
                            }
                            
                            return tryScaleSafe(scale, label, canvas);
                        } catch (e) {
                            console.error(`âŒ Error en ${label}:`, e);
                            return false;
                        }
                    };
                    
                    // FunciÃ³n interna segura
                    const tryScaleSafe = (scale, label, canvas) => {
                        try {
                            const scaledCanvas = document.createElement('canvas');
                            const scaledCtx = scaledCanvas.getContext('2d');
                            scaledCanvas.width = Math.floor(canvas.width * scale);
                            scaledCanvas.height = Math.floor(canvas.height * scale);
                            
                            scaledCtx.drawImage(canvas, 0, 0, scaledCanvas.width, scaledCanvas.height);
                            const scaledData = scaledCtx.getImageData(0, 0, scaledCanvas.width, scaledCanvas.height);
                            
                            // Intentar detectar
                            const code = jsQR(scaledData.data, scaledData.width, scaledData.height, {
                                inversionAttempts: "attemptBoth"
                            });
                            
                            if (code) {
                                processingComplete = true;
                                clearTimeout(timeoutId);
                                console.log(`âœ… Â¡QR ENCONTRADO! en intento ${attemptNum}`);
                                progressMsg.textContent = 'âœ… Â¡QR Detectado!';
                                setTimeout(() => {
                                    overlay.classList.add('hidden');
                                    overlay.classList.remove('flex');
                                    handleQRRead(code.data);
                                }, 500);
                                return true;
                            }
                            return false;
                        } catch (e) {
                            console.error('Error en tryScaleSafe:', e);
                            return false;
                        }
                    };
                    
                    // SECUENCIA OPTIMIZADA (12 intentos, mÃ¡s rÃ¡pida)
                    const runAttempts = () => {
                        try {
                            // Intentos 1-6: Escalados progresivos sobre regiÃ³n recortada
                            if (tryScale(1.0, "ðŸ“· RegiÃ³n QR")) return;
                            
                            setTimeout(() => { try {
                                if (tryScale(2.0, "ðŸ” 2x")) return;
                                
                                setTimeout(() => { try {
                                    if (tryScale(3.0, "ðŸ”Ž 3x")) return;
                                    
                                    setTimeout(() => { try {
                                        if (tryScale(4.0, "ðŸ”¬ 4x")) return;
                                        
                                        setTimeout(() => { try {
                                            if (tryScale(6.0, "ðŸŽ¯ 6x")) return;
                                            
                                            setTimeout(() => { try {
                                                if (tryScale(8.0, "ðŸš€ 8x")) return;
                                                
                                                setTimeout(() => { try {
                                                    // Intento 7: Escalado 10x (QR muy pequeÃ±os)
                                                    if (tryScale(10.0, "ðŸ’ª 10x")) return;
                                                    
                                                    setTimeout(() => { try {
                                                        // Intento 8: Reducir desenfoque
                                                        attemptNum++;
                                                        progressMsg.textContent = 'ðŸ”§ Reduciendo desenfoque...';
                                                        attemptCounter.textContent = '8 / 12';
                                                        
                                                        const reducedCanvas = document.createElement('canvas');
                                                        const reducedCtx = reducedCanvas.getContext('2d');
                                                        reducedCanvas.width = Math.floor(croppedCanvas.width / 2);
                                                        reducedCanvas.height = Math.floor(croppedCanvas.height / 2);
                                                        reducedCtx.drawImage(croppedCanvas, 0, 0, reducedCanvas.width, reducedCanvas.height);
                                                        
                                                        const reducedData = reducedCtx.getImageData(0, 0, reducedCanvas.width, reducedCanvas.height);
                                                        const code = jsQR(reducedData.data, reducedData.width, reducedData.height, {
                                                            inversionAttempts: "attemptBoth"
                                                        });
                                                        
                                                        if (code) {
                                                            processingComplete = true;
                                                            clearTimeout(timeoutId);
                                                            progressMsg.textContent = 'âœ… Â¡QR Detectado!';
                                                            setTimeout(() => {
                                                                overlay.classList.add('hidden');
                                                                overlay.classList.remove('flex');
                                                                handleQRRead(code.data);
                                                            }, 500);
                                                            return;
                                                        }
                                                        
                                                        setTimeout(() => { try {
                                                            // Intentos 9-10: Imagen completa con escalados moderados
                                                            if (tryScale(2.0, "ðŸ“¸ Completa 2x", workingCanvas)) return;
                                                            
                                                            setTimeout(() => { try {
                                                                if (tryScale(4.0, "ðŸ“¸ Completa 4x", workingCanvas)) return;
                                                                
                                                                setTimeout(() => { try {
                                                                    // Intento 11: Original sin procesar
                                                                    attemptNum++;
                                                                    progressMsg.textContent = 'ðŸ“· Original...';
                                                                    attemptCounter.textContent = '11 / 12';
                                                                    
                                                                    const code = jsQR(baseImageData.data, baseImageData.width, baseImageData.height, {
                                                                        inversionAttempts: "attemptBoth"
                                                                    });
                                                                    
                                                                    if (code) {
                                                                        processingComplete = true;
                                                                        clearTimeout(timeoutId);
                                                                        progressMsg.textContent = 'âœ… Â¡QR Detectado!';
                                                                        setTimeout(() => {
                                                                            overlay.classList.add('hidden');
                                                                            overlay.classList.remove('flex');
                                                                            handleQRRead(code.data);
                                                                        }, 500);
                                                                        return;
                                                                    }
                                                                    
                                                                    setTimeout(() => { try {
                                                                        // Intento 12: Ãšltimo recurso
                                                                        attemptNum++;
                                                                        progressMsg.textContent = 'ðŸ”§ Ãšltimo intento...';
                                                                        attemptCounter.textContent = '12 / 12';
                                                                        
                                                                        const finalCanvas = document.createElement('canvas');
                                                                        const finalCtx = finalCanvas.getContext('2d');
                                                                        finalCanvas.width = Math.floor(workingCanvas.width / 2);
                                                                        finalCanvas.height = Math.floor(workingCanvas.height / 2);
                                                                        finalCtx.drawImage(workingCanvas, 0, 0, finalCanvas.width, finalCanvas.height);
                                                                        
                                                                        const finalData = finalCtx.getImageData(0, 0, finalCanvas.width, finalCanvas.height);
                                                                        const code = jsQR(finalData.data, finalData.width, finalData.height, {
                                                                            inversionAttempts: "attemptBoth"
                                                                        });
                                                                        
                                                                        processingComplete = true;
                                                                        clearTimeout(timeoutId);
                                                                        
                                                                        if (code) {
                                                                            progressMsg.textContent = 'âœ… Â¡QR Detectado!';
                                                                            setTimeout(() => {
                                                                                overlay.classList.add('hidden');
                                                                                overlay.classList.remove('flex');
                                                                                handleQRRead(code.data);
                                                                            }, 500);
                                                                        } else {
                                                                            // NO ENCONTRADO
                                                                            console.log('âŒ QR no detectado despuÃ©s de 12 intentos');
                                                                            overlay.classList.add('hidden');
                                                                            overlay.classList.remove('flex');
                                                                            window.showErrorModal(
                                                                                "âŒ No se detectÃ³ el cÃ³digo QR.\n\n" +
                                                                                "ðŸ’¡ Para mejores resultados:\n\n" +
                                                                                "ðŸ“¸ Usa el ESCÃNER EN VIVO\n" +
                                                                                "ðŸ” Haz foto CERCA del QR\n" +
                                                                                "ðŸ’¡ Buena iluminaciÃ³n\n" +
                                                                                "âœ‚ï¸ O recorta solo el QR"
                                                                            );
                                                                        }
                                                                    } catch (e) { handleFinalError(e); }
                                                                    }, 150);
                                                                } catch (e) { handleFinalError(e); }
                                                                }, 150);
                                                            } catch (e) { handleFinalError(e); }
                                                            }, 150);
                                                        } catch (e) { handleFinalError(e); }
                                                        }, 150);
                                                    } catch (e) { handleFinalError(e); }
                                                    }, 150);
                                                } catch (e) { handleFinalError(e); }
                                                }, 150);
                                            } catch (e) { handleFinalError(e); }
                                            }, 150);
                                        } catch (e) { handleFinalError(e); }
                                        }, 150);
                                    } catch (e) { handleFinalError(e); }
                                    }, 150);
                                } catch (e) { handleFinalError(e); }
                                }, 150);
                            } catch (e) { handleFinalError(e); }
                            }, 150);
                        } catch (e) {
                            handleFinalError(e);
                        }
                    };
                    
                    // FunciÃ³n para manejar errores finales
                    const handleFinalError = (e) => {
                        processingComplete = true;
                        clearTimeout(timeoutId);
                        console.error('âŒ Error crÃ­tico:', e);
                        overlay.classList.add('hidden');
                        overlay.classList.remove('flex');
                        window.showErrorModal(
                            "âŒ Error al procesar la imagen.\n\n" +
                            "ðŸ’¡ Intenta:\n" +
                            "â€¢ Usar el ESCÃNER EN VIVO\n" +
                            "â€¢ Hacer una foto nueva\n" +
                            "â€¢ Foto mÃ¡s cerca del QR"
                        );
                    };
                    
                    runAttempts();
                    
                } catch (e) {
                    processingComplete = true;
                    clearTimeout(timeoutId);
                    URL.revokeObjectURL(url);
                    console.error('âŒ Error al cargar:', e);
                    overlay.classList.add('hidden');
                    overlay.classList.remove('flex');
                    window.showErrorModal("âŒ Error al procesar la imagen.");
                }
            };
            
            img.onerror = () => {
                processingComplete = true;
                clearTimeout(timeoutId);
                URL.revokeObjectURL(url);
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
                window.showErrorModal("âŒ No se pudo cargar la imagen.");
            };
            
            img.src = url;
        }
        
        function startScanner() {
            // Use multiCupsAddType for the check if we are in MultiCups mode
            const currentTypeCheck = currentTariffType === 'MULTICUPS' ? multiCupsAddType : currentTariffType;

            if (currentTypeCheck !== '2.0TD') {
                return window.showErrorModal("El escÃ¡ner QR solo es compatible con la tarifa 2.0 TD.");
            }
            // Si las tarifas aÃºn no estÃ¡n cargadas, esperamos automÃ¡ticamente sin mostrar modal
            if (currentTariffs['2.0TD'].length === 0) {
                console.log('â³ Esperando que se carguen las tarifas 2.0TD...');
                const checkInterval = setInterval(() => {
                    if (currentTariffs['2.0TD'].length > 0) {
                        clearInterval(checkInterval);
                        console.log('âœ… Tarifas 2.0TD cargadas. Iniciando escÃ¡ner...');
                        startScanner(); // Reintentar
                    }
                }, 200); // Verificar cada 200ms
                return;
            }
            if (scannerRunning) return;
            
            // FEEDBACK INMEDIATO: Mostrar que estÃ¡ cargando
            document.getElementById('initial-view').classList.add('hidden');
            document.getElementById('scanner-view').classList.remove('hidden');
            document.getElementById('scanner-view').classList.add('flex');
            
            // Mostrar mensaje de carga en el contenedor interactivo
            const interactive = document.getElementById('interactive');
            interactive.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; background: #1e293b;">
                    <div style="width: 60px; height: 60px; border: 4px solid #22c55e; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
                    <p style="color: white; margin-top: 20px; font-size: 16px; font-weight: 600;">ðŸ“· Abriendo cÃ¡mara...</p>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
            
            scannerRunning = true;
            
            // Iniciar cÃ¡mara con mÃ­nimas opciones para mÃ¡xima velocidad
            // ðŸ”¥ CONFIGURACIÃ“N Ã“PTIMA (del cÃ³digo que funciona)
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: "environment",
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                } 
            }).then(s => {
                stream = s; 
                
                // Crear video
                video = document.createElement('video');
                video.autoplay = true; 
                video.playsInline = true;
                video.muted = true; // CRÃTICO para iOS
                video.srcObject = s;
                
                // Crear canvas con configuraciÃ³n optimizada
                canvas = document.createElement('canvas'); 
                canvasCtx = canvas.getContext('2d', { alpha: false, willReadFrequently: true });
                
                // Limpiar el mensaje de carga y mostrar video
                interactive.innerHTML = '';
                interactive.appendChild(video);
                
                video.onloadedmetadata = () => { 
                    video.play(); 
                    // Iniciar escaneo inmediatamente
                    scanLoop(); 
                };
            }).catch(err => {
                console.error(err); 
                stopScanner(); 
                cancelScanner(); 
                window.showErrorModal("Error al acceder a la cÃ¡mara. Intente subir una imagen.");
            });
        }
        function scanLoop() {
            if (!scannerRunning || !video || video.readyState !== video.HAVE_ENOUGH_DATA) { 
                animationFrameId = requestAnimationFrame(scanLoop); 
                return; 
            }
            
            if (canvas.width !== video.videoWidth) { 
                canvas.width = video.videoWidth; 
                canvas.height = video.videoHeight; 
            }
            
            canvasCtx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // ðŸ”¥ðŸ”¥ðŸ”¥ CICLO HÃBRIDO + AUTO-PROCESAMIENTO INMEDIATO (DEL CÃ“DIGO QUE FUNCIONA)
            let code = null;
            frameCount++;

            // Ciclo de 3 modos para detectar QRs de cualquier tamaÃ±o
            const mode = frameCount % 3;
            
            if (mode === 0) {
                // MODO PANORÃMICO: Escanea toda la imagen (QRs grandes o lejanos)
                const imageData = canvasCtx.getImageData(0, 0, canvas.width, canvas.height);
                code = jsQR(imageData.data, imageData.width, imageData.height);
            } 
            else if (mode === 1) {
                // MODO PAPEL: Zoom central 50% (QRs pequeÃ±os en papel)
                const size = Math.min(canvas.width, canvas.height) * 0.5;
                const sx = (canvas.width - size) / 2;
                const sy = (canvas.height - size) / 2;
                const imageData = canvasCtx.getImageData(sx, sy, size, size);
                code = jsQR(imageData.data, imageData.width, imageData.height);
            }
            else {
                // MODO PRECISIÃ“N: Zoom 75% + InversiÃ³n (QRs difÃ­ciles)
                const size = Math.min(canvas.width, canvas.height) * 0.75;
                const sx = (canvas.width - size) / 2;
                const sy = (canvas.height - size) / 2;
                const imageData = canvasCtx.getImageData(sx, sy, size, size);
                code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "attemptBoth" });
            }

            scanLoopCount++;
            
            // Actualizar barra de progreso
            const powerBar = document.getElementById('scan-power-bar');
            const powerLabel = document.getElementById('scan-power-label');
            const container = document.getElementById('interactive');
            
            // ðŸ”¥ AUTO-PROCESAMIENTO INMEDIATO (como el cÃ³digo que funciona)
            if (code) {
                // QR DETECTADO â†’ PROCESAR INMEDIATAMENTE
                console.log('âœ… QR DETECTADO - Procesando automÃ¡ticamente...');
                if (powerLabel) powerLabel.textContent = 'âš¡ PROCESANDO...';
                if (powerBar) {
                    powerBar.style.width = '100%';
                    powerBar.className = 'bg-gradient-to-r from-green-500 to-green-600 h-full transition-all duration-300';
                }
                
                // VibraciÃ³n (si estÃ¡ soportada)
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                
                // PROCESAR INMEDIATAMENTE - SIN ESPERAS
                handleQRRead(code.data);
                return; // Salir del loop
            } else {
                // No detecta QR â†’ Seguir buscando
                if (powerLabel && !qrRegionDetected) {
                    const progress = Math.min(80, (scanLoopCount / 60) * 80);
                    if (powerBar) powerBar.style.width = progress + '%';
                    powerLabel.textContent = `ðŸ” Buscando (Modo ${mode + 1}/3)...`;
                    if (powerBar) powerBar.className = 'bg-gradient-to-r from-blue-400 to-blue-600 h-full transition-all duration-500';
                }
            }
            
            animationFrameId = requestAnimationFrame(scanLoop);
        }
        
        function increaseContrast(imageData, factor = 1.5) {
            const data = new Uint8ClampedArray(imageData.data);
            const intercept = 128 * (1 - factor);
            
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, Math.max(0, data[i] * factor + intercept));         // R
                data[i + 1] = Math.min(255, Math.max(0, data[i + 1] * factor + intercept)); // G
                data[i + 2] = Math.min(255, Math.max(0, data[i + 2] * factor + intercept)); // B
                // Alpha (i+3) no se toca
            }
            
            return new ImageData(data, imageData.width, imageData.height);
        }
        
        function stopScanner() {
            scannerRunning = false;
            scanLoopCount = 0; // Reset del contador de frames
            
            // Reset variables de tracking QR
            qrRegionDetected = null;
            qrDetectionFrame = 0;
            qrStableFrames = 0; // Reset contador de estabilidad
            
            // Ocultar marco Google Lens
            const frame = document.getElementById('qr-detection-frame');
            if (frame) frame.classList.add('hidden');
            
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            if (stream) stream.getTracks().forEach(t => t.stop());
            video = null; stream = null;
        }
        
        function capturePhoto() {
            if (!video || video.readyState !== video.HAVE_ENOUGH_DATA) return;
            
            console.log('ðŸ“¸ Usuario pulsÃ³ capturar');
            
            // Capturar frame actual del video
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            tempCtx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
            
            let captureCanvas, captureCtx;
            
            // Si hay regiÃ³n QR detectada, capturar solo esa regiÃ³n
            if (qrRegionDetected) {
                console.log('ðŸ“¸ Capturando regiÃ³n QR detectada');
                
                captureCanvas = document.createElement('canvas');
                captureCtx = captureCanvas.getContext('2d');
                
                // AÃ±adir margen 30% para asegurar captura completa
                const marginX = qrRegionDetected.width * 0.3;
                const marginY = qrRegionDetected.height * 0.3;
                const captureX = Math.max(0, qrRegionDetected.x - marginX);
                const captureY = Math.max(0, qrRegionDetected.y - marginY);
                const captureWidth = Math.min(tempCanvas.width - captureX, qrRegionDetected.width + marginX * 2);
                const captureHeight = Math.min(tempCanvas.height - captureY, qrRegionDetected.height + marginY * 2);
                
                captureCanvas.width = captureWidth;
                captureCanvas.height = captureHeight;
                
                // Extraer regiÃ³n con margen
                captureCtx.drawImage(
                    tempCanvas,
                    captureX, captureY, captureWidth, captureHeight,
                    0, 0, captureWidth, captureHeight
                );
                
                console.log(`ðŸ“¸ RegiÃ³n QR capturada: ${captureWidth}x${captureHeight}px`);
            } else {
                // Capturar frame completo
                console.log('ðŸ“¸ Capturando frame completo (no hay regiÃ³n detectada)');
                captureCanvas = tempCanvas;
            }
            
            // Convertir a Blob y procesar
            captureCanvas.toBlob((blob) => {
                if (!blob) {
                    window.showErrorModal("Error al capturar la foto.");
                    return;
                }
                
                console.log('ðŸ“¸ Procesando con motor potente (12 intentos)...');
                stopScanner(); // Detener escÃ¡ner
                
                // Usar el motor de fotos que funciona perfecto
                decodeQRFromImage(blob);
            }, 'image/jpeg', 0.95);
        }
        
        
        function handleQRRead(raw) {
            stopScanner();
            const p = {};
            raw.split('&').forEach(part => {  
                let [key, ...rest] = part.split('=');
                let value = rest.join('=');
                try { p[key] = decodeURIComponent(value || '').replace(',', '.'); } catch (e) { p[key] = value || ''; }
            });
            
            let billingDays = 30;  
            let dateRangeStr = "No disponible";  
            let startDateStr = null;  
            let endDateStr = null;
            const isoDateRegex = /(\d{4}-\d{2}-\d{2})/i;
            const dmyDateRegex = /(\d{2}\/\d{2}\/\d{4})/i;  
            
            const iniF_key = Object.keys(p).find(k => k.toLowerCase() === 'inif');
            const finF_key = Object.keys(p).find(k => k.toLowerCase() === 'finf');  
            const iniA_key = Object.keys(p).find(k => k.toLowerCase() === 'inia');  
            let rawStartDate = iniF_key ? p[iniF_key] : null;
            let rawEndDate = finF_key ? p[finF_key] : (iniA_key ? p[iniA_key] : null);  
            
            if (rawStartDate) { let match = rawStartDate.match(isoDateRegex); if (match) { startDateStr = formatIsoToDmy(match[1]); } else { match = rawStartDate.match(dmyDateRegex); if (match) startDateStr = match[1]; } }
            if (rawEndDate) { let match = rawEndDate.match(isoDateRegex); if (match) { endDateStr = formatIsoToDmy(match[1]); } else { match = rawEndDate.match(dmyDateRegex); if (match) endDateStr = match[1]; } }
            
            if (startDateStr && endDateStr) {
                billingDays = calculateDays(startDateStr, endDateStr);
                dateRangeStr = `${startDateStr} - ${endDateStr}`;
            }

            const directData = {
                cups: p.cups || 'QR SCAN',
                dias_facturados: billingDays,
                importe_total: parseFloat(p.imp || 0), // FIX: asegurar que es float, default a 0
                potencia_p1_kw: parseFloat(p.pP1 || 0),
                potencia_p2_kw: parseFloat(p.pP2 || 0),
                // Solo se reciben 3 consumos del QR de la CNMC (P1, P2, P3 -> Punta, Llano, Valle)
                consumo_punta: parseFloat(p.cfP1 || 0),
                consumo_llano: parseFloat(p.cfP2 || 0),
                consumo_valle: parseFloat(p.cfP3 || 0),
                fechas: dateRangeStr,
                rawQR: raw  
            };
            
            const isMultiCupsMode = currentTariffType === 'MULTICUPS';

            if (directData.importe_total <= 0) return window.showErrorModal("QR incompleto. No se detectÃ³ el Importe Total de la factura.");

            document.getElementById('scanner-view').classList.add('hidden');
            document.getElementById('loading-status').classList.add('hidden');

            if (isMultiCupsMode) {
                // En modo MultiCups, el QR solo puede ser 2.0TD
                // Creamos un objeto que imita el input manual
                const dataForSave = { ...directData, originalTariffType: '2.0TD' };  

                // Forzamos 2.0TD para la confirmaciÃ³n
                tempQrData = dataForSave;
                // El tipo de tarifa a sugerir para la confirmaciÃ³n es el seleccionado en la vista saga (o 2.0TD por defecto si es QR)
                const defaultTariffForConfirmation = multiCupsAddType || '2.0TD';
                document.getElementById('confirm-tariff-select').value = defaultTariffForConfirmation;  
                document.getElementById('confirm-tariff-select').innerHTML = `<option value="2.0TD">2.0 TD (Punta, Llano, Valle)</option><option value="3.0TD">3.0 TD (6 Periodos - Se mapearÃ¡n P1/P2/P3)</option>`;

                // Mostrar modal de confirmaciÃ³n (permitiendo al usuario cambiar a 3.0TD si lo necesita)
                showQRConfirmationModal(dataForSave);
            } else {
                // Modo Individual: Precarga inputs y compara directamente si es 2.0TD
                document.getElementById('input-cups').value = directData.cups;
                document.getElementById('input-total-bill').value = directData.importe_total;
                document.getElementById('input-billing-days').value = directData.dias_facturados;
                document.getElementById('input-p1-kw').value = directData.potencia_p1_kw;
                document.getElementById('input-p2-kw').value = directData.potencia_p2_kw;
                document.getElementById('input-e1-kwh').value = directData.consumo_punta;
                document.getElementById('input-e2-kwh').value = directData.consumo_llano;
                document.getElementById('input-e3-kwh').value = directData.consumo_valle;
                
                // Aseguramos que los 6 periodos estÃ©n ocultos si es 2.0TD.
                toggleMultiCupsInputPeriods(currentTariffType, 'input');

                if (currentTariffType === '2.0TD' && currentTariffs['2.0TD'].length > 0) {
                    compareOffers(directData);
                } else if (currentTariffs[currentTariffType]?.length > 0) {
                     window.showMessageModal(`QR leÃ­do. Por favor, revise y complete los datos faltantes para tarifas ${currentTariffType}.`, "Completar Datos Manuales");
                     document.getElementById('manual-input-modal').classList.remove('hidden');
                     document.getElementById('manual-input-modal').classList.add('flex');
                } else {
                    window.showErrorModal("Las tarifas no han cargado aÃºn. Por favor, intente de nuevo.");
                }
            }
        }

        // --- FUNCIONES MULTICUPS AÃ‘ADIDAS ---

        function showQRConfirmationModal(data) {
            tempQrData = data;
            const modal = document.getElementById('qr-confirm-modal');
            const summaryEl = document.getElementById('qr-data-summary');
            const selectEl = document.getElementById('confirm-tariff-select');
            const selectorWrapper = document.getElementById('tariff-selector-wrapper');
            
            // Si estamos en MultiCups Mode, ocultamos el selector
            if (currentTariffType === 'MULTICUPS') {
                // OCULTAR el selector completo
                selectorWrapper.style.display = 'none';
                
                // Establecer el valor (aunque estÃ© oculto)
                selectEl.value = multiCupsAddType;
                
                // Actualizar tÃ­tulo y descripciÃ³n
                modal.querySelector('h3').textContent = `${tr('Confirmar Suministro MultiCups')} (${multiCupsAddType})`;
                modal.querySelector('p').textContent = tr('Revisa los datos extraÃ­dos del QR antes de aÃ±adir este suministro a la lista.');
            } else {
                // Modo Individual: MOSTRAR el selector
                selectorWrapper.style.display = 'block';
                
                // Opciones del selector
                selectEl.innerHTML = `<option value="2.0TD">2.0 TD (Punta, Llano, Valle)</option><option value="3.0TD">3.0 TD (6 Periodos)</option>`;
                selectEl.value = data.originalTariffType && data.originalTariffType !== '6.1TD' ? data.originalTariffType : '2.0TD';
                
                // Textos originales
                modal.querySelector('h3').textContent = `Confirmar Suministro`;
                modal.querySelector('p').textContent = `Revisa los datos extraÃ­dos y selecciona el tipo de tarifa para aÃ±adir a la lista.`;
            }

            summaryEl.innerHTML = `
                <p class="font-bold text-slate-800 mb-2">${tr('Datos ExtraÃ­dos del QR')}</p>
                <div class="grid grid-cols-2 gap-1 text-xs">
                    <span>${tr('CUPS:')}</span><span class="font-mono text-right">${data.cups}</span>
                    <span>${tr('DÃ­as Fact:')}</span><span class="font-mono text-right">${data.dias_facturados}</span>
                    <span>${tr('Total')} ${tr('Factura:')}</span><span class="font-mono text-right">${data.importe_total.toFixed(2)} â‚¬</span>
                    <span class="col-span-2 border-t pt-1 mt-1 font-bold">${tr('Potencias (kW)')}:</span>
                    <span>P1:</span><span class="font-mono text-right">${data.potencia_p1_kw.toFixed(2)}</span>
                    <span>P2:</span><span class="font-mono text-right">${data.potencia_p2_kw.toFixed(2)}</span>
                    <span class="col-span-2 border-t pt-1 mt-1 font-bold">${tr('Consumos (kWh)')}:</span>
                    <span>${tr('Punta')} (E1):</span><span class="font-mono text-right">${data.consumo_punta}</span>
                    <span>${tr('Llano')} (E2):</span><span class="font-mono text-right">${data.consumo_llano}</span>
                    <span>${tr('Valle')} (E3):</span><span class="font-mono text-right">${data.consumo_valle}</span>
                </div>
            `;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // CRÃTICO: Traducir contenido del modal
            if (window.translateAll) {
                setTimeout(() => window.translateAll(), 50);
            }
        }

        document.getElementById('confirm-save-supply-btn').onclick = () => {
            if (!tempQrData) return;
            const tariffType = document.getElementById('confirm-tariff-select').value;
            
            // Cerrar modal de confirmaciÃ³n
            document.getElementById('qr-confirm-modal').classList.add('hidden');
            
            // En modo Multicups, solicitar direcciÃ³n antes de guardar
            if (currentTariffType === 'MULTICUPS') {
                showSupplyAddressModal(tempQrData, tariffType);
            } else {
                saveSupply(tempQrData, tariffType);
            }
            
            tempQrData = null;  
        };

        function saveSupply(data, tariffType) {
            // CRÃTICO: Limpiar variables globales para evitar contaminaciÃ³n de CUPS anteriores
            availableOffers = [];
            lastComparisonResult = null;
            manuallySelectedOffer = null;  // â† CRÃTICO: Limpiar selecciÃ³n manual anterior
            
            console.log('=== VERIFICACIÃ“N CURRENTTARIFFS ===');
            console.log('currentTariffs keys:', Object.keys(currentTariffs));
            console.log('currentTariffs[2.0TD] length:', currentTariffs['2.0TD']?.length);
            console.log('currentTariffs[3.0TD] length:', currentTariffs['3.0TD']?.length);
            if (currentTariffs['2.0TD']?.[0]) {
                console.log('Primera tarifa 2.0TD - name:', currentTariffs['2.0TD'][0].name);
                console.log('Primera tarifa 2.0TD - p1_price:', currentTariffs['2.0TD'][0].p1_price);
            }
            if (currentTariffs['3.0TD']?.[0]) {
                console.log('Primera tarifa 3.0TD - name:', currentTariffs['3.0TD'][0].name);
                console.log('Primera tarifa 3.0TD - p1_price:', currentTariffs['3.0TD'][0].p1_price);
            }
            
            const tariffsToCompare = currentTariffs[tariffType];
            if (!tariffsToCompare || tariffsToCompare.length === 0) {
                window.showErrorModal(`Las tarifas ${tariffType} no estÃ¡n cargadas.`);
                return;
            }
            
            console.log('=== SAVE SUPPLY DEBUG ===');
            console.log('TariffType:', tariffType);
            console.log('Tarifas disponibles:', tariffsToCompare.length);
            console.log('Primera tarifa name:', tariffsToCompare[0]?.name);
            console.log('Primera tarifa p1_price:', tariffsToCompare[0]?.p1_price);
            console.log('Primera tarifa p_potencia_1:', tariffsToCompare[0]?.p_potencia_1);
            
            // Creamos un nuevo objeto de datos para el cÃ¡lculo, ya que el cÃ¡lculo interno necesita los campos correctos (consumo_p1, consumo_p2, etc.)
            let dataForCalc = { ...data };
            
            const p1_kw = data.potencia_p1_kw || 0;
            const p2_kw = data.potencia_p2_kw || 0;
            const p3_kw_input = data.potencia_p3_kw || 0;
            const e4_kwh_input = data.consumo_p4 || 0;

            // 1. Manejo de mapeo de Potencias y Consumos
            // Simplificamos la condiciÃ³n, ya que solo 3.0TD es de alto voltaje
            if (tariffType === '3.0TD') {
                // Verificar si se introdujeron manualmente los 6 periodos
                const isManual6PeriodInput = p3_kw_input > 0 || e4_kwh_input > 0 || (data.consumo_p4 > 0 || data.consumo_p5 > 0 || data.consumo_p6 > 0);
                
                if (!isManual6PeriodInput) {
                    // Si es QR o Input Manual simplificado (solo 3 consumos/2 potencias)
                    // IMPORTANTE: Para 3.0TD las facturas muestran solo Punta/Llano/Valle
                    // pero la tarifa tiene 6 periodos de precios
                    
                    // Potencias: Propagar P1 y P2 a los 6 periodos
                    dataForCalc.potencia_p1_kw = p1_kw;
                    dataForCalc.potencia_p2_kw = p2_kw;
                    dataForCalc.potencia_p3_kw = p1_kw;
                    dataForCalc.potencia_p4_kw = p2_kw;
                    dataForCalc.potencia_p5_kw = p1_kw;  
                    dataForCalc.potencia_p6_kw = p2_kw;  
                    
                    // Consumos: Distribuir Punta/Llano/Valle entre los 6 periodos
                    // Estrategia: Asignar cada consumo a 2 periodos (duplicar)
                    const punta = data.consumo_punta || 0;
                    const llano = data.consumo_llano || 0;
                    const valle = data.consumo_valle || 0;
                    
                    // DistribuciÃ³n tÃ­pica en tarifas 3.0TD:
                    // P1, P4 = Punta (horas mÃ¡s caras)
                    // P2, P5 = Llano (horas medias)
                    // P3, P6 = Valle (horas mÃ¡s baratas)
                    dataForCalc.consumo_p1 = punta / 2;  // Mitad de punta
                    dataForCalc.consumo_p2 = llano / 2;  // Mitad de llano
                    dataForCalc.consumo_p3 = valle / 2;  // Mitad de valle
                    dataForCalc.consumo_p4 = punta / 2;  // Otra mitad de punta
                    dataForCalc.consumo_p5 = llano / 2;  // Otra mitad de llano
                    dataForCalc.consumo_p6 = valle / 2;  // Otra mitad de valle
                    
                    console.log('3.0TD QR Mode: Distributing consumptions across 6 periods');
                    console.log('Original - Punta:', punta, 'Llano:', llano, 'Valle:', valle);
                    console.log('Distributed - P1:', dataForCalc.consumo_p1, 'P2:', dataForCalc.consumo_p2, 'P3:', dataForCalc.consumo_p3);
                    console.log('Distributed - P4:', dataForCalc.consumo_p4, 'P5:', dataForCalc.consumo_p5, 'P6:', dataForCalc.consumo_p6);
                    
                } else {
                    // Es una entrada manual completa de 6 periodos
                    for(let i=1; i<=6; i++) {
                        dataForCalc[`consumo_p${i}`] = data[`consumo_p${i}`] || 0;
                        dataForCalc[`potencia_p${i}_kw`] = data[`potencia_p${i}_kw`] || 0;
                    }
                }
            } else if (tariffType === '2.0TD') {
                 // Para 2.0TD, aseguramos que los campos 'consumo_punta/llano/valle' estÃ¡n llenos.
                 dataForCalc.consumo_punta = data.consumo_punta !== undefined ? data.consumo_punta : (data.consumo_p1 || 0);
                 dataForCalc.consumo_llano = data.consumo_llano !== undefined ? data.consumo_llano : (data.consumo_p2 || 0);
                 dataForCalc.consumo_valle = data.consumo_valle !== undefined ? data.consumo_valle : (data.consumo_p3 || 0);
                 // Solo usamos potencias P1 y P2
                 dataForCalc.potencia_p1_kw = data.potencia_p1_kw || 0;
                 dataForCalc.potencia_p2_kw = data.potencia_p2_kw || 0;
            }
            
            // 2. Ejecutar la comparaciÃ³n con el objeto de datos corregido
            const results = tariffsToCompare.map(t => calculateTariffCost(t, dataForCalc, tariffType));
            
            let bestOverall = null; // Absolute best (DRK or Power Cup)
            let bestDrk = null;  // Best DRK only
            
            results.forEach(r => {
                // Siempre comparamos por el coste anual
                const annualCost = r.totalAnnual;
                
                // Best overall is the one with the lowest annual cost
                if (!bestOverall || annualCost < bestOverall.totalAnnual) {
                    bestOverall = r;
                }

                // Best DRK is the DRK one with the lowest annual cost
                if (r.offer.isDrk && r.offer.name !== 'Tu Tarifa Actual') {
                    if (!bestDrk || annualCost < bestDrk.totalAnnual) {
                            bestDrk = r;
                    }
                }
            });
            
            let finalIndividualResult = bestOverall;
            
            // --- GUARDAR OFERTAS PARA SELECCIÃ“N MANUAL ---
            // En MultiCups, permitir elegir entre TODAS las ofertas (con o sin ahorro)
            // para dar al usuario la mÃ¡xima flexibilidad
            // CRÃTICO: Verificar currentTariffType (que indica el modo general)
            // NO tariffType (que es el tipo especÃ­fico del CUPS actual: 2.0TD o 3.0TD)
            const isInMultiCupsFlow = currentTariffType === 'MULTICUPS';
            
            console.log('=== FILTER AVAILABLE OFFERS ===');
            console.log('currentTariffType (flow):', currentTariffType);
            console.log('tariffType (this CUPS):', tariffType);
            console.log('isInMultiCupsFlow:', isInMultiCupsFlow);
            console.log('comparisonMode:', comparisonMode);
            console.log('Total results:', results.length);
            
            availableOffers = results.filter(r => {
                // Si modo es "DRK ÃšNICAMENTE", filtrar solo ofertas DRK
                if (comparisonMode === 'drk_only') {
                    // En MultiCups: mostrar TODAS las ofertas DRK (con o sin ahorro)
                    // En Individual: solo ofertas DRK con ahorro positivo
                    if (isInMultiCupsFlow) {
                        return r.offer.isDrk && r.offer.name !== 'Tu Tarifa Actual';
                    } else {
                        const hasPositiveSavings = r.savings > 0 && r.totalAnnual < r.originalBillAnnual;
                        return hasPositiveSavings && r.offer.isDrk;
                    }
                }
                
                // En otros modos, mostrar ofertas con ahorro
                const hasPositiveSavings = r.savings > 0 && r.totalAnnual < r.originalBillAnnual;
                return hasPositiveSavings;
            });
            
            console.log('Filtered availableOffers.length:', availableOffers.length);
            
            console.log('=== AVAILABLE OFFERS DEBUG ===');
            console.log('Total availableOffers:', availableOffers.length);
            availableOffers.forEach((offer, idx) => {
                console.log(`Offer ${idx}: ${offer.offer.name}, p1_price: ${offer.offer.p1_price}, p_potencia_1: ${offer.offer.p_potencia_1}`);
            });
            
            // --- LÃ“GICA DE SELECCIÃ“N INDIVIDUAL SEGÃšN MODO DE COMPARACIÃ“N ---
            let brand = activeBrand;
            
            // Si hay una oferta seleccionada manualmente (desde el modal), usarla
            if (manuallySelectedOffer) {
                finalIndividualResult = manuallySelectedOffer;
                
                // Aplicar branding segÃºn la oferta seleccionada
                if (finalIndividualResult.offer.isDrk) {
                    brand = BRANDS.DRK;
                } else {
                    brand = BRANDS.POWER_CUP;
                }
            } else {
                // Modo automÃ¡tico segÃºn el modo de comparaciÃ³n
                if (comparisonMode === 'overall_best') {
                    // Modo POWER CUP: Buscar la mejor oferta absoluta (con o sin DRK)
                    finalIndividualResult = bestOverall;
                    
                    // Aplicar branding segÃºn quiÃ©n ganÃ³
                    if (finalIndividualResult.offer.isDrk) {
                        brand = BRANDS.DRK;
                    } else {
                        brand = BRANDS.POWER_CUP;
                    }
                } else {
                    // Modos DRK (drk_only, drk_prioritized)
                    if (comparisonMode === 'drk_only') {
                        // DRK ÃšNICAMENTE: SIEMPRE usar DRK, NUNCA otra comercializadora
                        // Si no hay DRK con ahorro, marcar para abrir modal de solicitud de mejora
                        if (bestDrk && bestDrk.totalAnnual < bestDrk.originalBillAnnual) {
                            // Hay DRK con ahorro
                            finalIndividualResult = bestDrk;
                        } else {
                            // NO hay DRK con ahorro: usar DRK de todas formas y marcar para modal
                            // Si existe bestDrk pero sin ahorro, usarlo; si no existe, crear uno nuevo
                            if (bestDrk) {
                                finalIndividualResult = bestDrk;
                                finalIndividualResult.isNegativeSavings = true;
                                finalIndividualResult.needsImprovementRequest = true;
                            } else {
                                // No existe ninguna tarifa DRK, crear resultado placeholder
                                finalIndividualResult = {
                                    offer: { 
                                        name: "DRK EnergÃ­a", 
                                        description: "Solicita una oferta personalizada", 
                                        isDrk: true 
                                    },
                                    totalAnnual: dataForCalc.originalBillAnnual || 0,
                                    originalBillAnnual: dataForCalc.originalBillAnnual || 0,
                                    importe_total: dataForCalc.importe_total || 0,
                                    dias_facturados: dataForCalc.dias_facturados || 30,
                                    cups: dataForCalc.cups || '',
                                    savings: 0,
                                    isNegativeSavings: true,
                                    needsImprovementRequest: true,
                                    energyCosts: [],
                                    powerCosts: []
                                };
                            }
                        }
                        // DRK ÃšNICAMENTE: SIEMPRE mantener branding DRK (azul)
                        brand = BRANDS.DRK;
                    } else if (comparisonMode === 'drk_prioritized') {
                        // Usar DRK si tiene ahorro, sino usar la mejor absoluta
                        finalIndividualResult = (bestDrk && bestDrk.totalAnnual < bestDrk.originalBillAnnual) ? bestDrk : bestOverall;
                        
                        // DRK PRIORITARIO: Solo cambiar a POWER_CUP si ganÃ³ una comercializadora NO-DRK
                        if (finalIndividualResult.offer.isDrk) {
                            brand = BRANDS.DRK;
                        } else {
                            brand = BRANDS.POWER_CUP;
                        }
                    }
                }
            }

            if (!finalIndividualResult) return window.showErrorModal("No se pudo calcular el ahorro para esta CUPS.");
            
            // Recalcular el ahorro basado en el resultado final seleccionado
            finalIndividualResult.savings = finalIndividualResult.originalBillAnnual - finalIndividualResult.totalAnnual;
            
            // Manejar casos sin ahorro
            if (finalIndividualResult.savings <= 0) {
                finalIndividualResult.isNegativeSavings = true;
                finalIndividualResult.savings = 0;
                finalIndividualResult.totalAnnual = finalIndividualResult.originalBillAnnual;
                
                // CRÃTICO: En modo DRK ÃšNICAMENTE, NO cambiar la oferta a "Tu Tarifa Actual"
                // Mantener la oferta DRK y marcar para solicitar mejora
                if (comparisonMode === 'drk_only') {
                    // Mantener la oferta DRK existente y marcar para modal
                    if (!finalIndividualResult.offer || !finalIndividualResult.offer.isDrk) {
                        finalIndividualResult.offer = { 
                            name: "DRK EnergÃ­a", 
                            description: "Solicita una oferta personalizada", 
                            isDrk: true 
                        };
                    }
                    finalIndividualResult.needsImprovementRequest = true;
                    brand = BRANDS.DRK;
                } else {
                    // En otros modos, cambiar a "Tu Tarifa Actual"
                    finalIndividualResult.offer = { 
                        name: "Tu Tarifa Actual", 
                        description: "Es la mejor opciÃ³n detectada", 
                        isDrk: false 
                    };
                    // Mantener el branding segÃºn el modo seleccionado
                    brand = comparisonMode === 'overall_best' ? BRANDS.POWER_CUP : BRANDS.DRK;
                }
            }

            // Apply branding here just for consistency before saving/showing modal
            applyBrandStyles(brand);
            
            // Ensure the correct tariff type used for calculation is stored
            finalIndividualResult.originalTariffType = tariffType;
            
            // Copiar datos base del suministro (CUPS, dÃ­as facturados, importe, etc.)
            finalIndividualResult.cups = data.cups || '';
            finalIndividualResult.importe_total = data.importe_total || 0;
            finalIndividualResult.dias_facturados = data.dias_facturados || 30;

            // Copy back the 6-period power and consumption values in case they were generated (for 3.0TD)
            if (tariffType === '3.0TD') {
                for (let i = 1; i <= 6; i++) {
                    finalIndividualResult[`consumo_p${i}`] = dataForCalc[`consumo_p${i}`] || 0;
                    finalIndividualResult[`potencia_p${i}_kw`] = dataForCalc[`potencia_p${i}_kw`] || 0;
                }
            } else if (tariffType === '2.0TD') {
                // Para 2.0TD tambiÃ©n copiar los datos
                finalIndividualResult.consumo_punta = dataForCalc.consumo_punta || 0;
                finalIndividualResult.consumo_llano = dataForCalc.consumo_llano || 0;
                finalIndividualResult.consumo_valle = dataForCalc.consumo_valle || 0;
                finalIndividualResult.potencia_p1_kw = dataForCalc.potencia_p1_kw || 0;
                finalIndividualResult.potencia_p2_kw = dataForCalc.potencia_p2_kw || 0;
            }
            
            // --- NUEVA LÃ“GICA: Modal de decisiÃ³n en MultiCups (TODOS LOS MODOS) ---
            // Si hay mÃ¡s de 1 oferta, permitir elegir (en cualquier modo)
            if (availableOffers.length > 1) {
                console.log('MultiCups: Showing decision modal with', availableOffers.length, 'offers');
                
                // Guardar temporalmente el resultado para usarlo despuÃ©s
                lastComparisonResult = finalIndividualResult;
                lastComparisonResult.isMulti = false;
                lastComparisonResult._multiCupsContext = {
                    tariffType: tariffType,
                    dataForCalc: dataForCalc
                };
                
                // Mostrar modal de decisiÃ³n
                showOfferDecisionModal();
                return; // No aÃ±adir todavÃ­a, esperar decisiÃ³n del usuario
            }
            
            // AÃ±adir directamente si solo hay 1 oferta o ninguna
            // CRÃTICO: Asegurar que el resultado tenga el contexto MULTICUPS
            finalIndividualResult._multiCupsContext = {
                tariffType: tariffType,
                dataForCalc: dataForCalc
            };
            
            // IMPORTANTE: Usar addSupplyToMultiCupsList para que recalcule costes correctamente
            addSupplyToMultiCupsList(finalIndividualResult);
            
            // La funciÃ³n addSupplyToMultiCupsList ya actualiza la UI, pero como estamos
            // en saveSupply, NO llamamos a showMultiCupsSagaView aquÃ­
            // (se llama dentro de addSupplyToMultiCupsList)
            return; // Salir para no ejecutar cÃ³digo duplicado
        }

        // --- FETCH & PARSE (Actualizado para MÃºltiples Tarifas) ---

        async function fetchTariffsForMultiCups() {
            const statusEl = document.getElementById('loading-status-saga');
            statusEl.textContent = `Cargando tarifas 2.0TD y 3.0TD...`;
            updateMultiCupsSagaView(); // Update visibility to show loading
            
            // Fetch 2.0TD and 3.0TD tariffs simultaneously
            await Promise.all([
                fetchTariffsFromSheet('2.0TD'),
                fetchTariffsFromSheet('3.0TD')  
            ]);
            
            updateMultiCupsSagaView(); // Update visibility to hide loading and enable buttons
            
            if (currentTariffs['2.0TD'].length === 0 || currentTariffs['3.0TD'].length === 0) {
                 // Use a more specific error message based on which failed
                 const failed = [];
                 if (currentTariffs['2.0TD'].length === 0) failed.push('2.0TD');
                 if (currentTariffs['3.0TD'].length === 0) failed.push('3.0TD');
                 window.showErrorModal(`Error: Las tarifas ${failed.join(' y ')} para MultiCups no se han cargado correctamente. Intente de nuevo.`);
            }
        }
        
        async function fetchTariffsFromSheet(tariffType) {
            const config = TARIFF_CONFIG[tariffType];
            const sheetId = config.sheetId;

            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=0&t=${Date.now()}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Error red para ${tariffType}`);
                const text = await response.text();
                currentTariffs[tariffType] = parseCSV(text, tariffType);
                
                if (currentTariffType !== 'MULTICUPS' && tariffType === currentTariffType) {
                    const count = currentTariffs[currentTariffType].length;
                    document.getElementById('tariff-display-badge').textContent = count;
                }

            } catch (e) {
                console.error(`Error al cargar ${tariffType}:`, e);
                currentTariffs[tariffType] = [];  
                if (currentTariffType !== 'MULTICUPS' && tariffType === currentTariffType) {
                    document.getElementById('tariff-display-badge').textContent = 'Error';
                }
            } finally {
                if (currentTariffType !== 'MULTICUPS' && tariffType === currentTariffType) {
                    document.getElementById('loading-status').classList.add('hidden');
                }
            }
        }

        function parseCSV(text, tariffType) {
             const lines = text.trim().split('\n');
             if (lines.length < 2) return [];
             
             const rawHeader = lines[0];
             const delimiter = rawHeader.includes(';') ? ';' : ',';
             
             const headers = rawHeader.split(delimiter).map(h => h.trim().toLowerCase().replace(/"/g, ''));
             const data = [];

             for(let i=1; i<lines.length; i++) {
                 const row = lines[i].trim();
                 if(!row) continue;
                 
                 const regex = new RegExp(`(?:^|${delimiter})(\"(?:[^\"]|\"\")*\"|[^${delimiter}]*)`,"g");
                 const values = [];
                 let match = null;
                 regex.lastIndex = 0;  
                 // Custom parsing to handle quoted fields correctly
                 let lastIndex = 0;
                 while(match = regex.exec(row)){
                      let val = match[1].replace(/^"|"$/g, '').replace(/""/g, '"');
                      // If the first capture group starts with the delimiter, it means the content is empty or the previous field was empty.
                      if (match.index > lastIndex) {
                           // Add empty string for missed fields
                           for (let j = 0; j < (match.index - lastIndex) / delimiter.length; j++) {
                                values.push('');
                           }
                      }
                      values.push(val.trim());
                      lastIndex = match.index + match[0].length;
                 }
                 // Add trailing empty fields
                 if (values.length < headers.length) {
                      for (let j = values.length; j < headers.length; j++) {
                           values.push('');
                      }
                 }


                 if(values.length < headers.length) continue;

                 let item = { cups_match: [tariffType] };
                 headers.forEach((h, idx) => {
                      let val = values[idx];
                       if (h.includes('price') || h.includes('potencia') || h === 'descuento') {
                            val = parseFloat(val?.replace(',', '.') || 0);
                             if(isNaN(val)) val = 0;
                       }
                       item[h] = val;
                 });

                 // Marcar como DRK si el nombre O la descripciÃ³n O commercializer contienen "DRK"
                 item.isDrk = item.name?.toUpperCase().includes('DRK') || 
                              item.description?.toUpperCase().includes('DRK') ||
                              item.commercializer?.toUpperCase().includes('DRK');
                 
                 // Check a mandatory field to ensure it's a valid row (using p1_price as a key indicator)
                 if(item.p1_price !== undefined) {
                     data.push(item);
                 }
               }
               return data;
        }
        
        // ===== FUNCIONES DE NAVEGACIÃ“N =====
        function hideAllScreens() {
            // Pantallas principales
            document.getElementById('screen-inicio').classList.remove('active');
            document.getElementById('screen-electricidad').classList.remove('active');
            document.getElementById('screen-gas').classList.remove('active');
            document.getElementById('screen-gas-results').classList.remove('active');
            
            // Pantallas DUAL
            document.getElementById('screen-dual').classList.remove('active');
            document.getElementById('screen-dual-add-type').classList.remove('active');
            document.getElementById('screen-dual-results').classList.remove('active');
            document.getElementById('screen-dual-confirm').classList.remove('active');
            
            // Vistas del flujo normal (initial-view, scanner-view, results-view, multicups-saga-view)
            const initialView = document.getElementById('initial-view');
            const scannerView = document.getElementById('scanner-view');
            const resultsView = document.getElementById('results-view');
            const multicupsSagaView = document.getElementById('multicups-saga-view');
            
            if (initialView) initialView.classList.add('hidden');
            if (scannerView) scannerView.classList.add('hidden');
            if (resultsView) resultsView.classList.add('hidden');
            if (multicupsSagaView) multicupsSagaView.classList.add('hidden');
        }

        function goToInicio() {
            // Limpiar flag de modo DUAL
            window.dualMode = false;
            
            hideAllScreens();
            document.getElementById('screen-inicio').classList.add('active');
            // Mostrar el modo de comparaciÃ³n
            document.getElementById('modo-comparacion-section').style.display = 'block';
        }

        function goToElectricidad() {
            // Desactivar modo DUAL (solo activo cuando se navega desde dualSelectTariff)
            window.dualMode = false;
            checkDualMode(); // Actualizar visibilidad del botÃ³n DUAL
            hideAllScreens();
            document.getElementById('screen-electricidad').classList.add('active');
            // Ocultar el modo de comparaciÃ³n (ya estÃ¡ seleccionado)
            document.getElementById('modo-comparacion-section').style.display = 'none';
        }

        function goToGas() {
            // Desactivar modo DUAL (solo activo cuando se navega desde dualSelectTariff)
            window.dualMode = false;
            checkDualMode(); // Actualizar visibilidad del botÃ³n DUAL
            
            // Limpiar resultados anteriores de GAS
            window.lastGasComparisonResult = null;
            
            hideAllScreens();
            document.getElementById('screen-gas').classList.add('active');
            // Ocultar el modo de comparaciÃ³n (ya estÃ¡ seleccionado)
            document.getElementById('modo-comparacion-section').style.display = 'none';
        }
        
        // ========================================
        // NUEVO: FUNCIONES MÃ“DULO DUAL
        // ========================================
        
        // Variables globales para DUAL
        window.dualSupplies = window.dualSupplies || []; // Array para almacenar todos los suministros
        let dualSupplies = window.dualSupplies; // Mantener referencia local por compatibilidad
        let dualCurrentType = null; // 'electricidad' o 'gas'
        let dualTempData = null; // Datos temporales del suministro actual
        let dualTempSupply = null; // Suministro temporal pendiente de confirmaciÃ³n
        
        // FunciÃ³n: Ir a pantalla DUAL
        function goToDual() {
            hideAllScreens();
            document.getElementById('screen-dual').classList.add('active');
            // Ocultar el modo de comparaciÃ³n cuando estamos en DUAL
            document.getElementById('modo-comparacion-section').style.display = 'none';
            updateDualSuppliesList();
        }
        
        // FunciÃ³n: Volver al gestor DUAL
        function backToDualManager() {
            // IMPORTANTE: NO desactivar dualMode aquÃ­ - debe permanecer activo
            // Solo se desactiva cuando sales completamente del DUAL
            console.log('=== backToDualManager - Volviendo al gestor DUAL ===');
            console.log('- dualMode sigue activo:', window.dualMode);
            console.log('- Total suministros en lista:', dualSupplies.length);
            
            hideAllScreens();
            document.getElementById('screen-dual').classList.add('active');
            // Ocultar el modo de comparaciÃ³n cuando estamos en DUAL
            document.getElementById('modo-comparacion-section').style.display = 'none';
            updateDualSuppliesList();
            
            console.log('=== Gestor DUAL mostrado correctamente ===');
        }
        
        // FunciÃ³n: AÃ±adir suministro
        function dualAddSupply() {
            console.log('=== dualAddSupply - Iniciando nuevo suministro ===');
            console.log('Estado ANTES de limpiar:');
            console.log('- dualTempSupply:', dualTempSupply);
            console.log('- lastComparisonResult:', lastComparisonResult);
            console.log('- lastIndexedResult:', lastIndexedResult);
            console.log('- availableOffers:', availableOffers.length);
            console.log('- dualMode:', window.dualMode);
            
            // CRÃTICO: Activar modo DUAL
            window.dualMode = true;
            
            // Limpiar variables anteriores para empezar limpio
            dualTempSupply = null;
            lastComparisonResult = null;
            lastIndexedResult = null;
            availableOffers = [];
            compareWithIndexed = false;
            
            // Limpiar el checkbox de comparaciÃ³n
            const checkbox = document.getElementById('compare-indexed-checkbox');
            if (checkbox) {
                checkbox.checked = false;
            }
            
            console.log('Estado DESPUÃ‰S de limpiar:');
            console.log('- dualTempSupply:', dualTempSupply);
            console.log('- lastComparisonResult:', lastComparisonResult);
            console.log('- dualMode:', window.dualMode);
            console.log('=== FIN limpieza - estado listo para nuevo suministro ===');
            
            hideAllScreens();
            document.getElementById('screen-dual-add-type').classList.add('active');
        }
        
        // FunciÃ³n: Seleccionar tipo de suministro (OBSOLETA - mantenida por compatibilidad)
        function dualSelectType(type) {
            dualCurrentType = type;
            
            if (type === 'electricidad') {
                // Redirigir a pantalla de electricidad en modo DUAL
                hideAllScreens();
                document.getElementById('screen-electricidad').classList.add('active');
                // Marcar que estamos en modo DUAL
                window.dualMode = true;
            } else if (type === 'gas') {
                // Redirigir a pantalla de gas en modo DUAL
                hideAllScreens();
                document.getElementById('screen-gas').classList.add('active');
                // Marcar que estamos en modo DUAL
                window.dualMode = true;
            }
        }
        
        // NUEVA: FunciÃ³n para seleccionar tarifa directamente
        function dualSelectTariff(type, tariff) {
            console.log('=================================================');
            console.log('=== dualSelectTariff LLAMADA ===');
            console.log('Type:', type);
            console.log('Tariff:', tariff);
            console.log('Estado ANTES:');
            console.log('- dualMode:', window.dualMode);
            console.log('- lastComparisonResult:', lastComparisonResult ? 'EXISTS' : 'NULL');
            console.log('- availableOffers:', availableOffers.length);
            console.log('=================================================');
            
            dualCurrentType = type;
            window.dualMode = true;
            checkDualMode(); // Actualizar visibilidad del botÃ³n DUAL
            
            if (type === 'electricidad') {
                // Configurar el tipo de tarifa ANTES de cambiar pantallas
                currentTariffType = tariff;
                console.log('âœ… Tarifa configurada:', currentTariffType);
                
                // Ocultar todas las pantallas
                hideAllScreens();
                
                // Mostrar la pantalla de electricidad
                document.getElementById('screen-electricidad').classList.add('active');
                
                // Limpiar vistas internas de electricidad
                document.getElementById('landing-view').classList.add('hidden');
                document.getElementById('scanner-view').classList.add('hidden');
                document.getElementById('results-view').classList.add('hidden');
                document.getElementById('multicups-saga-view').classList.add('hidden');
                
                // Mostrar initial-view
                document.getElementById('initial-view').classList.remove('hidden');
                
                console.log('âœ… Pantallas configuradas, llamando a selectTariffType...');
                
                // IMPORTANTE: Llamar a selectTariffType DESPUÃ‰S de configurar las pantallas
                setTimeout(() => {
                    selectTariffType(tariff);
                    console.log('âœ… selectTariffType ejecutado para:', tariff);
                }, 50);
                
            } else if (type === 'gas') {
                // Para gas, establecer la tarifa
                currentGasTariff = tariff;
                console.log('Tarifa gas configurada:', currentGasTariff);
                
                // Ocultar todas las pantallas
                hideAllScreens();
                
                // Mostrar la pantalla de gas
                document.getElementById('screen-gas').classList.add('active');
                
                // Abrir modal de entrada de gas con un pequeÃ±o delay
                setTimeout(() => {
                    selectGasTariff(tariff);
                    console.log('Modal gas abierto para:', tariff);
                }, 100);
            }
        }
        
        // FunciÃ³n: Actualizar lista de suministros
        function updateDualSuppliesList() {
            const container = document.getElementById('dual-supplies-container');
            const count = document.getElementById('dual-supplies-count');
            const calculateBtn = document.getElementById('dual-calculate-btn');
            
            count.textContent = dualSupplies.length;
            
            if (dualSupplies.length === 0) {
                container.innerHTML = `<p class="text-sm text-slate-400 text-center py-4">${tr('No hay suministros aÃ±adidos')}</p>`;
                calculateBtn.disabled = true;
                calculateBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                calculateBtn.disabled = false;
                calculateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                calculateBtn.classList.remove('bg-slate-600', 'hover:bg-slate-700');
                calculateBtn.style.background = 'linear-gradient(135deg, #0ea5e9 0%, #84cc16 100%)';
                
                container.innerHTML = dualSupplies.map((supply, index) => {
                    const monthlyPrice = (supply.totalAnnual / 12).toFixed(2);
                    const annualPrice = supply.totalAnnual.toFixed(2);
                    const displayInfo = supply.cups || `${monthlyPrice}â‚¬/mes`;
                    
                    // Calcular ahorro
                    const ahorro = (supply.originalBillAnnual || 0) - (supply.totalAnnual || 0);
                    const tieneAhorro = ahorro > 0;
                    
                    return `
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200">
                        <div class="flex items-center gap-3 flex-1">
                            <span class="text-2xl">${supply.type === 'electricidad' ? 'âš¡' : 'ðŸ”¥'}</span>
                            <div class="flex-1">
                                <p class="text-sm font-bold text-slate-800">${supply.type === 'electricidad' ? 'Electricidad' : 'Gas'} - ${supply.tariff}</p>
                                <p class="text-xs text-slate-500">${displayInfo}</p>
                                ${!tieneAhorro ? '<p class="text-xs text-slate-400 mt-1">No hay ahorro</p>' : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-bold text-blue-600">${monthlyPrice}â‚¬/mes</p>
                            <p class="text-xs ${tieneAhorro ? 'text-green-600' : 'text-slate-400'}">${annualPrice}â‚¬/aÃ±o</p>
                        </div>
                    </div>
                `;
                }).join('');
            }
        }
        
        // FunciÃ³n: Eliminar suministro
        function dualRemoveSupply(index) {
            dualSupplies.splice(index, 1);
            updateDualSuppliesList();
        }
        
        // FunciÃ³n: Limpiar todo
        function dualReset() {
            if (confirm('Â¿EstÃ¡s seguro de que quieres eliminar todos los suministros?')) {
                window.dualSupplies = [];
                dualSupplies = window.dualSupplies; // Mantener referencia
                updateDualSuppliesList();
            }
        }
        
        // FunciÃ³n: Calcular comparativa global
        function dualCalculate() {
            console.log('===== dualCalculate LLAMADA =====');
            console.log('Suministros en array:', dualSupplies.length);
            
            if (dualSupplies.length === 0) {
                window.showErrorModal('Debes aÃ±adir al menos un suministro antes de calcular.', 'âš ï¸ No hay suministros');
                return;
            }
            
            // CORREGIDO: Si solo hay 1 suministro, avisar que falta el otro
            if (dualSupplies.length === 1) {
                console.log('âš ï¸ Solo 1 suministro detectado');
                const supply = dualSupplies[0];
                const tipoActual = supply.type;
                const tipoFaltante = tipoActual === 'electricidad' ? 'GAS' : 'ELECTRICIDAD';
                
                window.showErrorModal(
                    `Para hacer una comparativa DUAL necesitas aÃ±adir tanto ELECTRICIDAD como GAS.\n\n` +
                    `Actualmente solo tienes: ${tipoActual.toUpperCase()}\n\n` +
                    `Por favor, aÃ±ade un suministro de ${tipoFaltante}.`,
                    'âš ï¸ Falta aÃ±adir suministro'
                );
                console.log(`Usuario necesita aÃ±adir: ${tipoFaltante}`);
                return;
            }
            
            // NUEVO: Verificar que hay tanto electricidad como gas
            const hasElectricidad = dualSupplies.some(s => s.type === 'electricidad');
            const hasGas = dualSupplies.some(s => s.type === 'gas');
            
            if (!hasElectricidad || !hasGas) {
                const tipoFaltante = !hasElectricidad ? 'ELECTRICIDAD' : 'GAS';
                window.showErrorModal(
                    `Para hacer una comparativa DUAL necesitas aÃ±adir tanto ELECTRICIDAD como GAS.\n\n` +
                    `Falta aÃ±adir: ${tipoFaltante}\n\n` +
                    `Por favor, aÃ±ade un suministro de ${tipoFaltante}.`,
                    'âš ï¸ Falta tipo de suministro'
                );
                console.log(`Falta aÃ±adir: ${tipoFaltante}`);
                return;
            }
            
            // CÃ³digo original para mÃºltiples suministros (2 o mÃ¡s)
            
            // Calcular totales DRK y Power Cup
            let totalDRK = 0;
            let totalPowerCup = 0;
            let totalDaysWeighted = 0;
            let totalOriginalBill = 0; // NUEVO: Total factura actual
            
            // NUEVO: Analizar ahorros individuales
            const suppliesWithSavings = [];
            const suppliesWithoutSavings = [];
            
            dualSupplies.forEach(supply => {
                if (supply.results) {
                    const drkCost = supply.results.drk?.total_anual || 0;
                    const powercupCost = supply.results.powercup?.total_anual || 0;
                    const originalBill = supply.originalBillAnnual || 0;
                    
                    totalDRK += drkCost;
                    totalPowerCup += powercupCost;
                    totalDaysWeighted += supply.data.dias || 30;
                    totalOriginalBill += originalBill;
                    
                    // Determinar si este suministro tiene ahorro
                    const isPowerCupMode = comparisonMode === 'overall_best';
                    const currentCost = isPowerCupMode ? powercupCost : drkCost;
                    const savings = originalBill - currentCost;
                    
                    if (savings > 0) {
                        suppliesWithSavings.push({...supply, savings});
                    } else {
                        suppliesWithoutSavings.push({...supply, savings});
                    }
                }
            });
            
            // Calcular ahorro total
            const isPowerCupMode = comparisonMode === 'overall_best';
            const totalNew = isPowerCupMode ? totalPowerCup : totalDRK;
            const totalSavings = Math.max(0, totalOriginalBill - totalNew); // Siempre >= 0
            
            console.log('ðŸ“Š AnÃ¡lisis de ahorros:');
            console.log('- Con ahorro:', suppliesWithSavings.length);
            console.log('- Sin ahorro:', suppliesWithoutSavings.length);
            console.log('- Ahorro total:', totalSavings.toFixed(2), 'â‚¬');
            
            // Guardar resultados globales (incluyendo anÃ¡lisis de ahorros)
            window.dualGlobalResults = {
                comparisonMode: comparisonMode,
                totalDRK,
                totalPowerCup,
                totalOriginalBill,
                totalSavings,
                diff: totalPowerCup - totalDRK,
                supplies: dualSupplies.length,
                avgDays: Math.round(totalDaysWeighted / dualSupplies.length),
                suppliesWithSavings: suppliesWithSavings.length,
                suppliesWithoutSavings: suppliesWithoutSavings.length
            };
            
            // Mostrar resultados
            showDualResults();
        }
        
        // FunciÃ³n: Mostrar resultados DUAL
        function showDualResults() {
            hideAllScreens();
            document.getElementById('screen-dual-results').classList.add('active');
            
            const container = document.getElementById('dual-results-container');
            const count = document.getElementById('dual-results-count');
            const results = window.dualGlobalResults;
            
            count.textContent = results.supplies;
            
            const formatEuro = (val) => val.toFixed(2).replace('.', ',') + ' â‚¬';
            
            container.innerHTML = `
                <!-- Resumen por tipo -->
                <div class="bg-slate-50 rounded-xl p-4 mb-4">
                    <h3 class="text-sm font-bold text-slate-700 mb-3">${tr('Resumen de suministros')}</h3>
                    <div class="space-y-3">
                        ${dualSupplies.map((s, idx) => {
                            // CORREGIDO: Usar s.totalAnnual directamente (ya tiene la lÃ³gica correcta)
                            const isPowerCupMode = results.comparisonMode === 'overall_best';
                            const currentCost = s.totalAnnual || 0; // Usar s.totalAnnual en lugar de results
                            const originalBill = s.originalBillAnnual || 0;
                            const savings = originalBill - currentCost;
                            
                            // DEBUG: Logging detallado
                            console.log(`ðŸ“Š Suministro ${idx + 1} (${s.type}):`);
                            console.log('  - originalBillAnnual:', s.originalBillAnnual);
                            console.log('  - s.totalAnnual (USADO):', s.totalAnnual);
                            console.log('  - currentCost:', currentCost);
                            console.log('  - results.drk.total_anual:', s.results.drk?.total_anual);
                            console.log('  - results.powercup.total_anual:', s.results.powercup?.total_anual);
                            console.log('  - savings calculado:', savings);
                            
                            // Construir nombre completo de tarifa: COMERCIALIZADORA - TARIFA
                            const comercializadora = s.offer?.name || '';
                            const tarifa = s.offer?.description || '';
                            const tariffName = (comercializadora && tarifa && comercializadora !== tarifa) 
                                ? `${comercializadora} - ${tarifa}` 
                                : (tarifa || comercializadora || 'Tarifa DRK');
                            
                            // Para GAS, mostrar desglose completo
                            if (s.type === 'gas' && s.gasBreakdown) {
                                const gb = s.gasBreakdown;
                                return `
                                <div class="bg-white rounded-lg p-3 border border-slate-200">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center gap-2">
                                            <span class="text-lg">ðŸ”¥</span>
                                            <span class="text-xs font-semibold text-slate-600">${s.tariff}</span>
                                        </div>
                                        <span class="text-sm font-bold text-slate-900">${formatEuro(currentCost)}</span>
                                    </div>
                                    <div class="text-xs text-slate-700 font-medium mb-2">${tariffName}</div>
                                    
                                    <!-- Desglose GAS -->
                                    <div class="bg-slate-50 rounded p-2 space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span>${tr('TÃ©rmino fijo (')}${gb.dias} ${tr('dÃ­as')})</span>
                                            <span>${formatEuro(gb.termino_fijo)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>${tr('EnergÃ­a')} (${gb.kwh} kWh)</span>
                                            <span>${formatEuro(gb.energia)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>${tr('Imp. hidrocarburos')}</span>
                                            <span>${formatEuro(gb.impuesto_hidrocarburos)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>IVA (21%)</span>
                                            <span>${formatEuro(gb.iva)}</span>
                                        </div>
                                        <div class="flex justify-between font-semibold pt-1 border-t border-slate-200">
                                            <span>${tr('TOTAL MENSUAL')}</span>
                                            <span>${formatEuro(gb.total)}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center justify-between mt-2 pt-2 border-t border-slate-200">
                                        <span class="text-xs text-slate-600">${tr('Factura actual:')} ${formatEuro(originalBill / 12)}${tr('/mes')}</span>
                                        <span class="text-xs font-semibold ${savings > 0 ? 'text-green-600' : 'text-slate-500'}">${tr('Ahorro:')} ${formatEuro(Math.max(0, savings))}${tr('/aÃ±o')}</span>
                                    </div>
                                </div>
                            `;
                            }
                            
                            // Para ELECTRICIDAD, mostrar desglose completo tambiÃ©n
                            if (s.type === 'electricidad' && s.electricityBreakdown) {
                                const eb = s.electricityBreakdown;
                                const totalKwh = eb.energyCosts?.reduce((sum, e) => sum + (e.kwh || 0), 0) || 0;
                                
                                return `
                                <div class="bg-white rounded-lg p-3 border border-slate-200">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center gap-2">
                                            <span class="text-lg">âš¡</span>
                                            <span class="text-xs font-semibold text-slate-600">${s.tariff}</span>
                                        </div>
                                        <span class="text-sm font-bold text-slate-900">${formatEuro(currentCost)}</span>
                                    </div>
                                    <div class="text-xs text-slate-700 font-medium mb-2">${tariffName}</div>
                                    
                                    <!-- Desglose ELECTRICIDAD -->
                                    <div class="bg-slate-50 rounded p-2 space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span>${tr('Potencia')} (${eb.dias} ${tr('dÃ­as')})</span>
                                            <span>${formatEuro(eb.subPower)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>${tr('EnergÃ­a')} (${totalKwh.toFixed(0)} kWh)</span>
                                            <span>${formatEuro(eb.subEnergy)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>${tr('Imp. elÃ©ctrico (5.113%)')}</span>
                                            <span>${formatEuro(eb.costIE)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>IVA (21%)</span>
                                            <span>${formatEuro(eb.costIVA)}</span>
                                        </div>
                                        <div class="flex justify-between font-semibold pt-1 border-t border-slate-200">
                                            <span>${tr('TOTAL PERIODO')}</span>
                                            <span>${formatEuro(eb.totalPeriod)}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center justify-between mt-2 pt-2 border-t border-slate-200">
                                        <span class="text-xs text-slate-600">${tr('Factura actual:')} ${formatEuro(originalBill / 12)}${tr('/mes')}</span>
                                        <span class="text-xs font-semibold ${savings > 0 ? 'text-green-600' : 'text-slate-500'}">${tr('Ahorro:')} ${formatEuro(Math.max(0, savings))}${tr('/aÃ±o')}</span>
                                    </div>
                                </div>
                            `;
                            }
                            
                            // Fallback simple si no hay desglose
                            return `
                            <div class="bg-white rounded-lg p-3 border border-slate-200">
                                <div class="flex items-center justify-between mb-1">
                                    <div class="flex items-center gap-2">
                                        <span class="text-lg">${s.type === 'electricidad' ? 'âš¡' : 'ðŸ”¥'}</span>
                                        <span class="text-xs font-semibold text-slate-600">${s.tariff}</span>
                                    </div>
                                    <span class="text-sm font-bold text-slate-900">${formatEuro(currentCost)}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-slate-700 font-medium">${tariffName}</span>
                                    <span class="text-xs font-semibold ${savings > 0 ? 'text-green-600' : 'text-slate-500'}">${tr('Ahorro')}: ${formatEuro(Math.max(0, savings))}</span>
                                </div>
                            </div>
                        `;
                        }).join('')}
                    </div>
                </div>
                
                <!-- Tarjeta AHORRO TOTAL (SOLO si NO es modo Power Cup) -->
                ${(() => {
                    // Verificar si TODOS los suministros tienen ahorro <= 0
                    let allWithoutSavings = true;
                    dualSupplies.forEach(s => {
                        const currentCost = s.totalAnnual || 0;
                        const originalBill = s.originalBillAnnual || 0;
                        const savings = originalBill - currentCost;
                        if (savings > 0) allWithoutSavings = false;
                    });
                    
                    if (results.comparisonMode !== 'overall_best' && results.totalSavings > 0 && !allWithoutSavings) {
                        return `
                <div class="rounded-2xl shadow-2xl p-6 mb-6" style="background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%); border: 2px solid #5BA3F5;">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-2xl font-bold text-white">ðŸ’° Ahorro Total</h3>
                        <div class="bg-white bg-opacity-20 p-3 rounded-xl">
                            <span class="text-2xl">ðŸ“Š</span>
                        </div>
                    </div>
                    <div class="bg-white bg-opacity-10 rounded-xl p-4 mb-3">
                        <p class="text-sm text-white opacity-90 mb-2">Factura actual total:</p>
                        <p class="text-2xl font-bold text-white">${formatEuro(results.totalOriginalBill)}</p>
                    </div>
                    <div class="bg-white bg-opacity-10 rounded-xl p-4 mb-3">
                        <p class="text-sm text-white opacity-90 mb-2">Con DRK pagarÃ­as:</p>
                        <p class="text-2xl font-bold text-white">${formatEuro(results.totalDRK)}</p>
                    </div>
                    <div class="rounded-xl p-4" style="background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.3);">
                        <p class="text-sm text-white opacity-90 mb-2">ðŸŽ‰ Ahorro anual generado:</p>
                        <p class="text-4xl font-bold text-white">${formatEuro(results.totalSavings)}</p>
                        <p class="text-sm text-white opacity-80 mt-2">${(results.totalSavings / 12).toFixed(2).replace('.', ',')} â‚¬ al mes</p>
                    </div>
                </div>
                        `;
                    } else if (results.comparisonMode !== 'overall_best' && allWithoutSavings) {
                        return `
                <div class="rounded-2xl shadow-2xl p-6 mb-6" style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); border: 2px solid #0ea5e9;">
                    <div class="text-center text-white">
                        <h3 class="text-3xl font-bold mb-4">Â¡ENHORABUENA!</h3>
                        <div class="bg-white bg-opacity-10 rounded-xl p-6 mb-4">
                            <p class="text-xl font-bold mb-3">Actualmente estÃ¡s en buenas tarifas</p>
                            <p class="text-base opacity-90">Tanto en ELECTRICIDAD como en GAS tienes tarifas competitivas.</p>
                        </div>
                        <div class="bg-white bg-opacity-10 rounded-xl p-4">
                            <p class="text-sm opacity-80">ðŸ“Š Factura actual total anual:</p>
                            <p class="text-3xl font-bold mt-2">${formatEuro(results.totalOriginalBill)}</p>
                        </div>
                    </div>
                </div>
                        `;
                    }
                    return '';
                })()}
                
                <!-- Tarjeta AHORRO TOTAL para Power Cup (SOLO si es modo Power Cup) -->
                ${(() => {
                    // Verificar si TODOS los suministros tienen ahorro <= 0
                    let allWithoutSavings = true;
                    dualSupplies.forEach(s => {
                        const currentCost = s.totalAnnual || 0;
                        const originalBill = s.originalBillAnnual || 0;
                        const savings = originalBill - currentCost;
                        if (savings > 0) allWithoutSavings = false;
                    });
                    
                    if (results.comparisonMode === 'overall_best' && results.totalSavings > 0 && !allWithoutSavings) {
                        return `
                <div class="bg-gradient-to-br from-powercup-600 to-powercup-800 text-white rounded-2xl shadow-2xl p-6 border-2 border-powercup-500 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-2xl font-bold">ðŸ’° Ahorro Total</h3>
                        <div class="bg-white bg-opacity-20 p-3 rounded-xl">
                            <span class="text-2xl">ðŸ“Š</span>
                        </div>
                    </div>
                    <div class="bg-white bg-opacity-10 rounded-xl p-4 mb-3">
                        <p class="text-sm text-powercup-100 mb-2">Factura actual total:</p>
                        <p class="text-2xl font-bold">${formatEuro(results.totalOriginalBill)}</p>
                    </div>
                    <div class="bg-white bg-opacity-10 rounded-xl p-4 mb-3">
                        <p class="text-sm text-powercup-100 mb-2">Con Power Cup pagarÃ­as:</p>
                        <p class="text-2xl font-bold">${formatEuro(results.totalPowerCup)}</p>
                    </div>
                    <div class="rounded-xl p-4" style="background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.3);">
                        <p class="text-sm text-powercup-100 mb-2">ðŸŽ‰ Ahorro anual generado:</p>
                        <p class="text-4xl font-bold">${formatEuro(results.totalSavings)}</p>
                        <p class="text-sm text-powercup-100 mt-2">${(results.totalSavings / 12).toFixed(2).replace('.', ',')} â‚¬ al mes</p>
                    </div>
                </div>
                        `;
                    } else if (results.comparisonMode === 'overall_best' && allWithoutSavings) {
                        return `
                <div class="bg-gradient-to-br from-powercup-600 to-powercup-800 text-white rounded-2xl shadow-2xl p-6 border-2 border-powercup-500 mb-6">
                    <div class="text-center">
                        <h3 class="text-3xl font-bold mb-4">Â¡ENHORABUENA!</h3>
                        <div class="bg-white bg-opacity-10 rounded-xl p-6 mb-4">
                            <p class="text-xl font-bold mb-3">Actualmente estÃ¡s en buenas tarifas</p>
                            <p class="text-base opacity-90">Tanto en ELECTRICIDAD como en GAS tienes tarifas competitivas.</p>
                        </div>
                        <div class="bg-white bg-opacity-10 rounded-xl p-4">
                            <p class="text-sm opacity-80">ðŸ“Š Factura actual total anual:</p>
                            <p class="text-3xl font-bold mt-2">${formatEuro(results.totalOriginalBill)}</p>
                        </div>
                    </div>
                </div>
                        `;
                    }
                    return '';
                })()}
            `;
            
            // NUEVO: Mostrar/ocultar botÃ³n de solicitar mejora
            // Verificar si AMBOS suministros tienen ahorro <= 0
            let allSuppliesWithoutSavings = true;
            
            dualSupplies.forEach(s => {
                const isPowerCupMode = results.comparisonMode === 'overall_best';
                const currentCost = s.totalAnnual || 0;
                const originalBill = s.originalBillAnnual || 0;
                const savings = originalBill - currentCost;
                
                if (savings > 0) {
                    allSuppliesWithoutSavings = false;
                }
            });
            
            const dualImprovementBtn = document.getElementById('dual-request-improvement-container');
            if (dualImprovementBtn) {
                if (allSuppliesWithoutSavings) {
                    dualImprovementBtn.style.display = 'block';
                    console.log('âœ… DUAL: Mostrando botÃ³n SOLICITAR MEJORA (ambos sin ahorro)');
                } else {
                    dualImprovementBtn.style.display = 'none';
                    console.log('âŒ DUAL: Ocultando botÃ³n (al menos uno tiene ahorro)');
                }
            }
        }
        
        // FunciÃ³n: Mostrar modal de datos del comercial y cliente
        function showClientDataModal() {
            if (!dualSupplies || dualSupplies.length === 0) {
                alert('No hay suministros para generar la propuesta.');
                return;
            }
            
            const results = window.dualGlobalResults;
            if (!results) {
                alert('Calcula la comparativa primero.');
                return;
            }
            
            // Mostrar el modal
            document.getElementById('client-data-modal').classList.remove('hidden');
            document.getElementById('client-data-modal').classList.add('flex');
        }
        
        // FunciÃ³n: Cerrar modal de datos del cliente
        function closeClientDataModal() {
            document.getElementById('client-data-modal').classList.remove('flex');
            document.getElementById('client-data-modal').classList.add('hidden');
        }
        
        // FunciÃ³n: Copiar HTML comparativo al portapapeles
        function copyDualHTML() {
            try {
                const currentLang = localStorage.getItem('appLanguage') || 'es';
                console.log('ðŸ” copyDualHTML llamado, idioma:', currentLang);
                
                // NUEVO: Para CHINO, leer datos del DOM y construir HTML con tablas
                if (currentLang === 'zh') {
                    console.log('ðŸ‡¨ðŸ‡³ Modo chino detectado - extrayendo datos del DOM y construyendo tablas');
                    
                    // Detectar si es Power Cup o DRK
                    const results = window.dualGlobalResults || {};
                    const isPowerCup = results.comparisonMode === 'overall_best';
                    const bannerColor = isPowerCup ? '#84cc16' : '#0ea5e9'; // Verde Power Cup o Azul DRK
                    const savingsColor = isPowerCup ? '#4d7c0f' : '#16a34a'; // Verde oscuro Power Cup o Verde DRK
                    const brandName = isPowerCup ? 'POWER CUP' : 'DRK';
                    console.log('ðŸ·ï¸ Marca detectada:', brandName, '| Color banner:', bannerColor);
                    
                    // Verificar que hay resultados renderizados en el DOM
                    const resultsContainer = document.getElementById('dual-results-container');
                    if (!resultsContainer || resultsContainer.innerHTML.trim().length < 100) {
                        console.error('âŒ No hay resultados renderizados en el DOM');
                        alert('æ²¡æœ‰è¦å¤åˆ¶çš„ç»“æžœ / No results to copy\n\nè¯·å…ˆè®¡ç®—ç»“æžœ / Please calculate results first');
                        return;
                    }
                    
                    // Extraer tarjetas de suministros del DOM
                    const supplyCards = resultsContainer.querySelectorAll('.bg-white.rounded-lg.border.border-slate-200');
                    console.log('ðŸ“¦ Tarjetas encontradas:', supplyCards.length);
                    
                    if (supplyCards.length === 0) {
                        alert('âŒ No se encontraron tarjetas de suministros\n\nPlease try again');
                        return;
                    }
                    
                    let suppliesHTML = '';
                    
                    // Procesar cada tarjeta
                    supplyCards.forEach((card, index) => {
                        // Determinar tipo (electricidad o gas) por el icono
                        const iconElement = card.querySelector('.text-lg');
                        const iconText = iconElement ? iconElement.textContent.trim() : '';
                        const isElec = iconText.includes('âš¡');
                        const icon = isElec ? 'âš¡' : 'ðŸ”¥';
                        const bgColor = isElec ? '#f0fdf4' : '#fff7ed';
                        const borderColor = isElec ? '#86efac' : '#fed7aa';
                        
                        // Extraer datos de la tarjeta
                        const tariffElement = card.querySelector('.text-xs.font-semibold.text-slate-600');
                        const tariff = tariffElement ? tariffElement.textContent.trim() : '';
                        
                        const totalElement = card.querySelector('.text-sm.font-bold.text-slate-900');
                        const total = totalElement ? totalElement.textContent.trim() : '0,00 â‚¬';
                        
                        const nameElement = card.querySelector('.text-xs.text-slate-700.font-medium');
                        const name = nameElement ? nameElement.textContent.trim() : 'DRK';
                        
                        // Extraer lÃ­neas de desglose de la secciÃ³n bg-slate-50
                        const detailsSection = card.querySelector('.bg-slate-50');
                        let detailsHTML = '';
                        
                        if (detailsSection) {
                            const detailRows = detailsSection.querySelectorAll('.flex.justify-between');
                            detailRows.forEach(row => {
                                const spans = row.querySelectorAll('span');
                                if (spans.length === 2) {
                                    const label = spans[0].textContent.trim();
                                    const value = spans[1].textContent.trim();
                                    
                                    const isBold = row.classList.contains('font-semibold') || label.includes('TOTAL');
                                    const style = isBold 
                                        ? 'padding: 8px 0; font-weight: bold; color: #1e293b; border-top: 2px solid #e2e8f0;'
                                        : 'padding: 4px 0; color: #64748b;';
                                    
                                    detailsHTML += `
                                        <tr>
                                            <td style="${style}">${label}</td>
                                            <td style="${style} text-align: right;">${value}</td>
                                        </tr>
                                    `;
                                }
                            });
                        }
                        
                        // Extraer ahorro de la secciÃ³n inferior
                        const savingsSection = card.querySelector('.flex.items-center.justify-between.mt-2');
                        let currentBill = '0,00 â‚¬/æœˆ';
                        let savings = '0,00 â‚¬/å¹´';
                        
                        if (savingsSection) {
                            const spans = savingsSection.querySelectorAll('span');
                            if (spans.length >= 2) {
                                const currentText = spans[0].textContent;
                                const savingsText = spans[1].textContent;
                                
                                const currentMatch = currentText.match(/([0-9,.]+\s*â‚¬\/[^)]+)/);
                                const savingsMatch = savingsText.match(/([0-9,.]+\s*â‚¬\/[^)]+)/);
                                
                                if (currentMatch) currentBill = currentMatch[1];
                                if (savingsMatch) savings = savingsMatch[1];
                            }
                        }
                        
                        // Construir HTML de la tarjeta
                        suppliesHTML += `
                            <!-- Tarjeta de suministro ${index + 1} -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background: white; border: 2px solid ${borderColor}; border-radius: 12px; margin-bottom: 20px;">
                                <tr>
                                    <td style="padding: 20px;">
                                        <!-- Encabezado del suministro -->
                                        <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom: 15px;">
                                            <tr>
                                                <td style="font-size: 32px; width: 50px;">${icon}</td>
                                                <td style="text-align: left; padding-left: 10px;">
                                                    <div style="font-size: 20px; font-weight: bold; color: #1e293b;">${tariff}</div>
                                                </td>
                                                <td style="text-align: right;">
                                                    <div style="font-size: 28px; font-weight: bold; color: #1e293b;">${total}</div>
                                                </td>
                                            </tr>
                                        </table>
                                        
                                        <!-- Nombre de tarifa -->
                                        <div style="font-size: 16px; font-weight: bold; color: #475569; margin-bottom: 15px;">
                                            ${name}
                                        </div>
                                        
                                        <!-- Detalles del breakdown -->
                                        <table width="100%" cellpadding="0" cellspacing="0" style="font-size: 14px; margin-bottom: 15px;">
                                            ${detailsHTML}
                                        </table>
                                        
                                        <!-- Ahorro -->
                                        <table width="100%" cellpadding="0" cellspacing="0" style="background: ${bgColor}; border-radius: 8px; padding: 12px;">
                                            <tr>
                                                <td style="font-size: 14px; color: #64748b; width: 50%;">å½“å‰è´¦å•ï¼š</td>
                                                <td style="text-align: center; font-size: 16px; font-weight: bold; color: #1e293b; width: 25%;">${currentBill}</td>
                                                <td style="font-size: 14px; color: #16a34a; text-align: right; width: 12%;">èŠ‚çœï¼š</td>
                                                <td style="text-align: right; font-size: 16px; font-weight: bold; color: #16a34a; width: 13%;">${savings}</td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        `;
                    });
                    
                    // Extraer totales del resumen
                    const totalSavingsSection = resultsContainer.querySelector('.rounded-2xl.shadow-2xl');
                    let totalOriginal = '0,00 â‚¬';
                    let totalNew = '0,00 â‚¬';
                    let totalAhorro = '0,00 â‚¬';
                    let ahorroMes = '0,00 â‚¬';
                    
                    if (totalSavingsSection) {
                        const allParagraphs = totalSavingsSection.querySelectorAll('p');
                        allParagraphs.forEach(p => {
                            const text = p.textContent.trim();
                            
                            // Buscar "Factura actual total:" seguido del valor
                            if (text.includes('Factura actual total')) {
                                const nextP = p.nextElementSibling;
                                if (nextP && nextP.tagName === 'P') {
                                    totalOriginal = nextP.textContent.trim();
                                }
                            }
                            // Buscar "Con DRK pagarÃ­as:"
                            else if (text.includes('Con DRK pagarÃ­as')) {
                                const nextP = p.nextElementSibling;
                                if (nextP && nextP.tagName === 'P') {
                                    totalNew = nextP.textContent.trim();
                                }
                            }
                            // Buscar "Ahorro anual generado:"
                            else if (text.includes('Ahorro anual generado')) {
                                const nextP = p.nextElementSibling;
                                if (nextP && nextP.tagName === 'P') {
                                    totalAhorro = nextP.textContent.trim();
                                }
                                // El siguiente despuÃ©s del ahorro anual es el mensual
                                const mensualP = nextP ? nextP.nextElementSibling : null;
                                if (mensualP && mensualP.tagName === 'P') {
                                    // Extraer solo el valor numÃ©rico, sin "al mes"
                                    let mensualText = mensualP.textContent.trim();
                                    // Eliminar "al mes" si existe
                                    mensualText = mensualText.replace(/\s*al mes\s*/gi, '').trim();
                                    ahorroMes = mensualText;
                                }
                            }
                        });
                    }
                    
                    // Construir HTML completo
                    const htmlContent = `
                        <!DOCTYPE html>
                        <html lang="zh">
                        <head>
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <title>DRK èƒ½æº - DUAL æ¯”è¾ƒç»“æžœ</title>
                        </head>
                        <body style="font-family: Arial, sans-serif; background: #f1f5f9; margin: 0; padding: 20px;">
                            <!-- Encabezado -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${bannerColor}; border-radius: 12px; margin-bottom: 20px;">
                                <tr>
                                    <td style="padding: 30px; text-align: center;">
                                        <div style="font-size: 48px; margin-bottom: 10px;">âš¡ðŸ”¥</div>
                                        <h1 style="margin: 0; font-size: 36px; font-weight: 900; color: #ffffff;">COMPARATIVA GLOBAL</h1>
                                        <p style="margin: 10px 0 0 0; font-size: 18px; color: #ffffff; opacity: 0.95;">å¤šé‡ä¾›åº”ç®¡ç† / Multi-supply Management</p>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- TÃ­tulo de secciÃ³n -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background: white; border-radius: 12px; margin-bottom: 20px;">
                                <tr>
                                    <td style="padding: 20px;">
                                        <h2 style="margin: 0; font-size: 24px; color: #1e293b; font-weight: bold;">ä¾›åº”æ‘˜è¦</h2>
                                    </td>
                                </tr>
                            </table>
                            
                            ${suppliesHTML}
                            
                            <!-- Resumen de ahorro total -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${savingsColor}; border-radius: 12px; margin-top: 30px;">
                                <tr>
                                    <td style="padding: 30px; text-align: center;">
                                        <div style="font-size: 48px; margin-bottom: 10px;">ðŸ’°</div>
                                        <h2 style="margin: 0 0 20px 0; font-size: 28px; color: white; font-weight: bold;">æ€»èŠ‚çœ</h2>
                                        
                                        <table width="100%" cellpadding="0" cellspacing="0" style="max-width: 500px; margin: 0 auto;">
                                            <tr>
                                                <td style="padding: 10px; text-align: left; font-size: 16px; color: white; opacity: 0.9;">ðŸ“Š å½“å‰è´¦å•æ€»é¢ï¼š</td>
                                                <td style="padding: 10px; text-align: right; font-size: 20px; color: white; font-weight: bold;">${totalOriginal}</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 10px; text-align: left; font-size: 16px; color: white; opacity: 0.9;">ä½¿ç”¨ DRK æ‚¨å°†æ”¯ä»˜ï¼š</td>
                                                <td style="padding: 10px; text-align: right; font-size: 20px; color: white; font-weight: bold;">${totalNew}</td>
                                            </tr>
                                            <tr style="border-top: 2px solid rgba(255,255,255,0.3);">
                                                <td style="padding: 15px 10px; text-align: left; font-size: 18px; color: white;">ðŸŽ‰ å¹´åº¦èŠ‚çœé‡‘é¢ï¼š</td>
                                                <td style="padding: 15px 10px; text-align: right; font-size: 32px; color: white; font-weight: bold;">${totalAhorro}</td>
                                            </tr>
                                            <tr>
                                                <td colspan="2" style="padding: 10px; text-align: center; font-size: 18px; color: white; opacity: 0.95;">${ahorroMes} æ¯æœˆ</td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        </body>
                        </html>
                    `;
                    
                    // Copiar al portapapeles
                    const tempContainer = document.createElement('div');
                    tempContainer.style.position = 'fixed';
                    tempContainer.style.left = '-9999px';
                    tempContainer.innerHTML = htmlContent;
                    document.body.appendChild(tempContainer);
                    
                    const range = document.createRange();
                    range.selectNodeContents(tempContainer);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                    
                    try {
                        const successful = document.execCommand('copy');
                        console.log('ðŸ“‹ execCommand copy result:', successful);
                        if (successful) {
                            alert('âœ… æˆåŠŸï¼HTMLå·²å¤åˆ¶ï¼ˆä¸­æ–‡ï¼‰\nâœ… Success! HTML copied (Chinese)\n\nçŽ°åœ¨å¯ä»¥ç²˜è´´åˆ°Outlookï¼\nNow you can paste into Outlook!');
                            console.log('âœ… HTML DUAL copiado con tablas desde DOM');
                        } else {
                            throw new Error('execCommand fallÃ³');
                        }
                    } catch (err) {
                        console.error('Error en execCommand:', err);
                        alert('âŒ å¤åˆ¶å¤±è´¥ / Copy failed\n\nError: ' + err.message);
                    } finally {
                        selection.removeAllRanges();
                        document.body.removeChild(tempContainer);
                    }
                    return;
                }
                
                // Para otros idiomas, proceso normal
                const comercialCode = document.getElementById('comercial-code').value.trim();
                if (!comercialCode) {
                    alert('Por favor, introduce el cÃ³digo comercial (obligatorio)');
                    document.getElementById('comercial-code').focus();
                    return;
                }
            
                const clientName = document.getElementById('client-name').value.trim() || tr('[NOMBRE COMPLETO CLIENTE]');
                const clientPhone = document.getElementById('client-phone').value.trim() || '';
                const clientEmail = document.getElementById('client-email').value.trim() || '';
                
                // Cerrar el modal
                closeClientDataModal();
                
                // Llamar a la funciÃ³n que genera el HTML (igual que el PDF)
                const html = generateDualHTMLContent(comercialCode, clientName, clientPhone, clientEmail);
                
                if (!html) {
                    return; // Ya se mostrÃ³ el error en generateDualHTMLContent
                }
                
                // NUEVO: Copiar como HTML renderizado (no como texto)
                // Crear un contenedor temporal invisible
                const tempContainer = document.createElement('div');
                tempContainer.style.position = 'fixed';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '0';
                tempContainer.innerHTML = html;
                document.body.appendChild(tempContainer);
                
                // Seleccionar todo el contenido del contenedor
                const range = document.createRange();
                range.selectNodeContents(tempContainer);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                
                // Intentar copiar
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        alert('âœ… HTML copiado correctamente!\n\nAhora puedes:\n1. Abrir tu correo (Gmail/Outlook)\n2. Hacer clic en "Redactar"\n3. Pegar (Ctrl+V o Cmd+V)\n\nSe pegarÃ¡ el diseÃ±o completo, no el cÃ³digo.');
                        console.log('âœ… HTML renderizado copiado');
                    } else {
                        throw new Error('execCommand fallÃ³');
                    }
                } catch (err) {
                    console.error('Error al copiar:', err);
                    alert('âŒ No se pudo copiar automÃ¡ticamente.\n\nPor favor, usa el botÃ³n "CREAR PDF COMPARATIVO" en su lugar.');
                } finally {
                    // Limpiar: deseleccionar y eliminar el contenedor temporal
                    selection.removeAllRanges();
                    document.body.removeChild(tempContainer);
                }
            } catch (globalError) {
                console.error('âŒ Error global en copyDualHTML:', globalError);
                console.error('Stack:', globalError.stack);
                alert('âŒ Error al copiar HTML\n\n' + globalError.message + '\n\nè¯·æŸ¥çœ‹æŽ§åˆ¶å°èŽ·å–è¯¦ç»†ä¿¡æ¯\nPlease check console for details');
            }
        }
        
        // FunciÃ³n auxiliar para formatear euros en email
        function formatEuroEmail(value) {
            return (value || 0).toFixed(2).replace('.', ',') + ' â‚¬';
        }
        
        // FunciÃ³n auxiliar para generar mailto link
        function generateMailtoLink(comercialCode, clientName, clientPhone, clientEmail, supplies, results, isPowerCup, brandName, totalSavings, totalOriginalBill, totalNew) {
            const recipients = 'f.araujo@drk.es;rguerra@drk.es;s.caballero@drk.es';
            const subject = `âœ… CONFIRMACIÃ“N - DUAL ${brandName} - ${clientName}`;
            
            let emailBody = `âœ… CONFIRMACIÃ“N DE ACEPTACIÃ“N DE OFERTA DUAL

Estimado equipo de DRK,

Confirmo mi aceptaciÃ³n de la oferta energÃ©tica DUAL que detallo a continuaciÃ³n:

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“‹ RESUMEN GENERAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ’¼ Comercial: ${comercialCode}
ðŸŽ¯ Modalidad: DUAL (Electricidad + Gas)
ðŸ“Š Marca: ${brandName}
ðŸ“… Total Suministros: ${supplies.length}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ’° BENEFICIO ECONÃ“MICO TOTAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ’µ Factura Actual Total: ${formatEuroEmail(totalOriginalBill)}/aÃ±o
ðŸ’š Con ${brandName} Total: ${formatEuroEmail(totalNew)}/aÃ±o
ðŸŽ‰ Ahorro Anual Total: ${formatEuroEmail(totalSavings)}
ðŸ“… Ahorro Mensual: ${formatEuroEmail(totalSavings / 12)}/mes

`;

            supplies.forEach((supply, index) => {
                const isElec = supply.type === 'electricidad';
                const emoji = isElec ? 'âš¡' : 'ðŸ”¥';
                const tipo = isElec ? 'ELECTRICIDAD' : 'GAS';
                const currentCost = isPowerCup ? (supply.results.powercup?.total_anual || 0) : (supply.results.drk?.total_anual || 0);
                const ahorro = Math.max(0, (supply.originalBillAnnual || 0) - currentCost); // Mostrar 0 si negativo
                
                // Construir nombre completo de tarifa: COMERCIALIZADORA - TARIFA
                const comercializadora = supply.offer?.name || '';
                const tarifa = supply.offer?.description || '';
                const tarifaCompleta = (comercializadora && tarifa && comercializadora !== tarifa) 
                    ? `${comercializadora} - ${tarifa}` 
                    : (tarifa || comercializadora || 'N/A');
                
                emailBody += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
${emoji} SUMINISTRO ${index + 1}: ${tipo}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ”Œ CUPS: ${supply.cups}
âš¡ TARIFA CONTRATADA: ${tarifaCompleta}

ðŸ’° Ahorro Anual: ${formatEuroEmail(ahorro)}
ðŸ“… Coste Mensual: ${formatEuroEmail(currentCost / 12)}

`;
            });

            emailBody += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ‘¤ DATOS DEL TITULAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ“› Nombre: ${clientName}
ðŸ“± TelÃ©fono: ${clientPhone}
ðŸ“§ Email: ${clientEmail}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“Ž DOCUMENTACIÃ“N ADJUNTA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ 1. Foto DNI/CIF (anverso y reverso)
âœ“ 2. Ãšltimas facturas (mÃ­n. 3 meses)
âœ“ 3. AutorizaciÃ³n cambio titular (si aplica)
âœ“ 4. TelÃ©fono de contacto
âœ“ 5. IBAN

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Atentamente,
${clientName}
`;

            return `mailto:${recipients}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
        }
        
        // FunciÃ³n auxiliar: Generar HTML DUAL (usada por PDF y copiar HTML)
        function generateDualHTMLContent(comercialCode, clientName, clientPhone = '', clientEmail = '') {
            console.log('ðŸ“„ Generando HTML DUAL con datos capturados:');
            console.log('  - comercialCode:', comercialCode);
            console.log('  - clientName:', clientName);
            
            if (!dualSupplies || dualSupplies.length === 0) {
                alert('No hay suministros para generar la propuesta.');
                return null;
            }
            
            const results = window.dualGlobalResults;
            if (!results) {
                alert('Calcula la comparativa primero.');
                return null;
            }
            
            const isPowerCup = results.comparisonMode === 'overall_best';
            const brandName = isPowerCup ? 'POWER CUP' : 'DRK';
            const primaryColor = isPowerCup ? '#4d7c0f' : '#546e7a';
            const accentColor = isPowerCup ? '#84cc16' : '#607d8b';
            const bannerColor = isPowerCup ? '#84cc16' : '#0ea5e9'; // Verde Power Cup o Azul DRK
            
            // CAMBIO: Mostrar TODOS los suministros, no filtrar
            // Usar s.totalAnnual que ya tiene la lÃ³gica correcta
            let totalOriginalBill = 0;
            let totalNew = 0;
            
            dualSupplies.forEach(s => {
                const currentCost = s.totalAnnual || 0; // Usar s.totalAnnual directamente
                totalOriginalBill += s.originalBillAnnual || 0;
                totalNew += currentCost;
            });
            
            const totalSavings = Math.max(0, totalOriginalBill - totalNew); // MÃ¡ximo 0
            
            console.log('ðŸ“Š Suministros en documento:', dualSupplies.length);
            console.log('ðŸ’° Ahorro total:', totalSavings.toFixed(2), 'â‚¬');
            
            const eur = n => new Intl.NumberFormat('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(n || 0) + ' â‚¬';
            
            // Generar desgloses detallados (USAR dualSupplies - TODOS)
            const desgloses = dualSupplies.map((s, i) => {
                // Construir nombre completo de tarifa: COMERCIALIZADORA - TARIFA
                const comercializadora = s.offer?.name || '';
                const tarifa = s.offer?.description || '';
                const tarifaCompleta = (comercializadora && tarifa && comercializadora !== tarifa) 
                    ? `${comercializadora} - ${tarifa}` 
                    : (tarifa || comercializadora || 'N/A');
                
                if (s.type === 'electricidad' && s.electricityBreakdown) {
                    const eb = s.electricityBreakdown;
                    return `
                        <div style="margin-bottom:20px">
                            <div style="background:${accentColor};color:white;padding:12px 20px;border-radius:8px 8px 0 0;font-weight:bold;font-size:13px">
                                [${i+1}] ${(s.cups||'N/A').substring(0,30)}...
                                <div style="font-size:11px;opacity:0.9;margin-top:3px">${tr('Tipo:')}: ${s.tariff} | ${tr('DÃ­as:')}: ${eb.dias} ${tr('dÃ­as')} | CUPS: [${i+1}]</div>
                                <div style="font-size:11px;opacity:0.95;margin-top:5px;background:rgba(0,0,0,0.15);padding:6px 10px;border-radius:4px">
                                    <strong>${tr('TARIFA:')}</strong> ${tarifaCompleta}
                                </div>
                            </div>
                            <div style="background:#f8fafc;padding:15px 20px;border:1px solid #e2e8f0;border-top:none">
                                <div style="margin-bottom:12px">
                                    <div style="font-weight:bold;color:${accentColor};margin-bottom:5px;font-size:12px">${tr('PRECIOS APLICADOS:')}</div>
                                    <div style="font-size:11px;color:#64748b">
                                        <strong>${tr('POTENCIA:')}</strong><br>
                                        ${s.offer ? [
                                            s.offer.p1_power_price ? `P1: ${s.offer.p1_power_price.toFixed(6)} â‚¬/kW/dÃ­a` : null,
                                            s.offer.p2_power_price ? `P2: ${s.offer.p2_power_price.toFixed(6)} â‚¬/kW/dÃ­a` : null
                                        ].filter(Boolean).join('<br>') : 'N/A'}
                                    </div>
                                    <div style="font-size:11px;color:#64748b;margin-top:8px">
                                        <strong>${tr('ENERGÃA:')}</strong><br>
                                        ${s.offer ? [
                                            s.offer.p1_price ? `E1: ${s.offer.p1_price.toFixed(6)} â‚¬/kWh` : null,
                                            s.offer.p2_price ? `E2: ${s.offer.p2_price.toFixed(6)} â‚¬/kWh` : null,
                                            s.offer.p3_price ? `E3: ${s.offer.p3_price.toFixed(6)} â‚¬/kWh` : null,
                                            s.offer.p4_price ? `E4: ${s.offer.p4_price.toFixed(6)} â‚¬/kWh` : null,
                                            s.offer.p5_price ? `E5: ${s.offer.p5_price.toFixed(6)} â‚¬/kWh` : null,
                                            s.offer.p6_price ? `E6: ${s.offer.p6_price.toFixed(6)} â‚¬/kWh` : null
                                        ].filter(Boolean).join('<br>') : 'N/A'}
                                    </div>
                                </div>
                                
                                <div style="background:${accentColor};color:white;padding:8px 12px;margin:10px 0;border-radius:4px;font-size:12px;font-weight:bold">${tr('POTENCIA')}</div>
                                ${(eb.powerCosts||[]).map((pc, idx) => {
                                    const priceKey = idx === 0 ? 'p1_power_price' : 'p2_power_price';
                                    const precio = s.offer?.[priceKey] || pc.priceDay || pc.price_euro_kw_day || 0;
                                    return `
                                    <div style="display:flex;justify-content:space-between;padding:5px 0;font-size:11px">
                                        <span>P${pc.period||'?'} (${pc.power_kw||0} kW x ${eb.dias} x ${precio.toFixed(6)})</span>
                                        <span style="font-weight:bold">${(pc.cost_euros||0).toFixed(2)} â‚¬</span>
                                    </div>
                                `;}).join('')}
                                
                                <div style="background:${accentColor};color:white;padding:8px 12px;margin:10px 0;border-radius:4px;font-size:12px;font-weight:bold">${tr('ENERGÃA')}</div>
                                ${(eb.energyCosts||[]).map((ec, idx) => {
                                    const priceKey = `p${idx+1}_price`;
                                    const precio = s.offer?.[priceKey] || ec.price || ec.price_euro_kwh || 0;
                                    return `
                                    <div style="display:flex;justify-content:space-between;padding:5px 0;font-size:11px">
                                        <span>E${ec.period||'?'} (${ec.kwh||0} kWh x ${precio.toFixed(6)})</span>
                                        <span style="font-weight:bold">${(ec.cost_euros||0).toFixed(2)} â‚¬</span>
                                    </div>
                                `;}).join('')}
                                
                                <div style="background:#e2e8f0;padding:10px;margin-top:10px;border-radius:4px;display:flex;justify-content:space-between;font-weight:bold">
                                    <span>${tr('TOTAL')} (${eb.dias} ${tr('DÃAS')})</span>
                                    <span>${(eb.totalPeriod||0).toFixed(2)} â‚¬</span>
                                </div>
                                
                                <div style="background:#ef4444;color:white;padding:10px;margin-top:10px;border-radius:4px;text-align:center;font-weight:bold">
                                    ${tr('AHORRO:')}: ${(eb.ahorro_anual||0).toFixed(2)} â‚¬
                                </div>
                            </div>
                        </div>
                    `;
                } else if (s.type === 'gas' && s.gasBreakdown) {
                    const gb = s.gasBreakdown;
                    return `
                        <div style="margin-bottom:20px">
                            <div style="background:${accentColor};color:white;padding:12px 20px;border-radius:8px 8px 0 0;font-weight:bold;font-size:13px">
                                [${i+1}] ${(s.cups||'N/A').substring(0,30)}...
                                <div style="font-size:11px;opacity:0.9;margin-top:3px">${tr('Tipo:')}: ${s.tariff} | ${tr('DÃ­as:')}: ${gb.dias} ${tr('dÃ­as')} | CUPS: [${i+1}]</div>
                                <div style="font-size:11px;opacity:0.95;margin-top:5px;background:rgba(0,0,0,0.15);padding:6px 10px;border-radius:4px">
                                    <strong>${tr('TARIFA:')}</strong> ${tarifaCompleta}
                                </div>
                            </div>
                            <div style="background:#f8fafc;padding:15px 20px;border:1px solid #e2e8f0;border-top:none">
                                <div style="margin-bottom:12px">
                                    <div style="font-weight:bold;color:${accentColor};margin-bottom:5px;font-size:12px">${tr('PRECIOS APLICADOS:')}</div>
                                    <div style="font-size:11px;color:#64748b">
                                        ${tr('TÃ©rmino fijo:')}: ${(s.offer?.p_fijo_diario||0).toFixed(6)} â‚¬/dÃ­a<br>
                                        ${tr('EnergÃ­a:')}: ${(s.offer?.p1_price||0).toFixed(6)} â‚¬/kWh
                                    </div>
                                </div>
                                
                                <div style="background:${accentColor};color:white;padding:8px 12px;margin:10px 0;border-radius:4px;font-size:12px;font-weight:bold">${tr('DESGLOSE GAS')}</div>
                                <div style="display:flex;justify-content:space-between;padding:5px 0;font-size:11px">
                                    <span>${tr('TÃ©rmino fijo')} (${gb.dias} ${tr('dÃ­as')})</span>
                                    <span style="font-weight:bold">${(gb.termino_fijo||0).toFixed(2)} â‚¬</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;padding:5px 0;font-size:11px">
                                    <span>${tr('EnergÃ­a')} (${gb.kwh||0} kWh)</span>
                                    <span style="font-weight:bold">${(gb.energia||0).toFixed(2)} â‚¬</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;padding:5px 0;font-size:11px">
                                    <span>${tr('Impuesto hidrocarburos')}</span>
                                    <span style="font-weight:bold">${(gb.impuesto_hidrocarburos||0).toFixed(2)} â‚¬</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;padding:5px 0;font-size:11px">
                                    <span>${tr('Subtotal')}</span>
                                    <span style="font-weight:bold">${(gb.subtotal||0).toFixed(2)} â‚¬</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;padding:5px 0;font-size:11px">
                                    <span>IVA (21%)</span>
                                    <span style="font-weight:bold">${(gb.iva||0).toFixed(2)} â‚¬</span>
                                </div>
                                
                                <div style="background:#e2e8f0;padding:10px;margin-top:10px;border-radius:4px;display:flex;justify-content:space-between;font-weight:bold">
                                    <span>${tr('TOTAL')} (${gb.dias} ${tr('DÃAS')})</span>
                                    <span>${(gb.total||0).toFixed(2)} â‚¬</span>
                                </div>
                                
                                <div style="background:#ef4444;color:white;padding:10px;margin-top:10px;border-radius:4px;text-align:center;font-weight:bold">
                                    ${tr('AHORRO:')}: ${(gb.ahorro_anual||0).toFixed(2)} â‚¬
                                </div>
                            </div>
                        </div>
                    `;
                }
                return '';
            }).join('');
            
            const html = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Propuesta ${brandName}</title>
</head>
<body style="margin:0;padding:0;font-family:Arial,sans-serif;background-color:#f5f5f5">
    <div style="max-width:600px;margin:0 auto;background:white">
        
        <!-- BANNER SUPERIOR MEJORADO -->
        <table width="100%" cellpadding="0" cellspacing="0" style="background:${bannerColor}">
            <tr>
                <td style="padding:25px 30px;vertical-align:middle;width:60%">
                    <h1 style="margin:0 0 8px 0;font-size:32px;font-weight:900;color:white;letter-spacing:1px">${brandName} ${tr('ENERGÃA')}</h1>
                    <p style="margin:0;font-size:13px;color:white;opacity:0.95;line-height:1.4">${tr('Liderando el ahorro y la eficiencia energÃ©tica.')}</p>
                </td>
                <td style="padding:25px 30px;text-align:right;vertical-align:middle;width:40%">
                    <p style="margin:0 0 5px 0;font-size:12px;color:white;font-weight:600;letter-spacing:0.5px">${tr('ESTUDIO DE AHORRO')}</p>
                    <p style="margin:0;font-size:15px;font-weight:bold;color:white;letter-spacing:1px">${tr('COMPARATIVA PROFESIONAL')}</p>
                </td>
            </tr>
        </table>
        
        <!-- TÃTULO ESTUDIO DE AHORRO -->
        <div style="background:${bannerColor};padding:20px 30px;text-align:center;border-top:2px solid rgba(255,255,255,0.2)">
            <h2 style="margin:0 0 5px 0;font-size:24px;font-weight:bold;color:white;letter-spacing:1.5px">${tr('ESTUDIO DE AHORRO')}</h2>
            <p style="margin:0;font-size:13px;color:white;font-weight:600;letter-spacing:0.5px">${tr('COMPARATIVA PROFESIONAL')} - ${brandName}</p>
        </div>
        
        <!-- DATOS CLIENTE -->
        <div style="padding:15px 30px;background:#f8f9fa">
            <p style="margin:0 0 5px 0;font-size:11px;color:#1e293b"><strong>${tr("CLIENTE:")}</strong> ${clientName}</p>
            <p style="margin:0 0 5px 0;font-size:11px;color:#1e293b"><strong>${tr("CUPS:")}</strong> ${dualSupplies && dualSupplies[0] && dualSupplies[0].cups ? dualSupplies[0].cups : 'N/A'}</p>
            <p style="margin:0;font-size:11px;color:#1e293b"><strong>${tr("COMERCIAL:")}</strong> ${comercialCode}</p>
        </div>
        
        <!-- LA MEJOR OPCIÃ“N -->
        <div style="padding:15px 30px;background:white;text-align:center">
            <p style="margin:0 0 5px 0;font-size:11px;color:#546e7a;font-weight:600;letter-spacing:0.5px">${tr("LA MEJOR OPCIÃ“N PARA TI ES")}</p>
            <p style="margin:0;font-size:18px;color:#546e7a;font-weight:bold;letter-spacing:1px">${brandName}</p>
        </div>
        
        <!-- RESUMEN TABLA -->
        <div style="margin:25px 30px;padding:20px;background:white;border:3px solid #e5e7eb;border-radius:10px">
            <p style="margin:0 0 15px 0;font-size:14px;color:#1e293b;font-weight:bold;text-align:center;text-transform:uppercase">${tr("RESUMEN DE SUMINISTROS INCLUIDOS")}</p>
            <table width="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse">
                <thead>
                    <tr style="background:#f1f5f9">
                        <th style="padding:10px 8px;font-size:10px;color:#475569;text-align:left;border-bottom:2px solid #cbd5e1">#</th>
                        <th style="padding:10px 8px;font-size:10px;color:#475569;text-align:left;border-bottom:2px solid #cbd5e1">CUPS</th>
                        <th style="padding:10px 8px;font-size:10px;color:#475569;text-align:center;border-bottom:2px solid #cbd5e1">${tr('Tipo')}</th>
                        <th style="padding:10px 8px;font-size:10px;color:#475569;text-align:center;border-bottom:2px solid #cbd5e1">${tr('Tarifa')}</th>
                        <th style="padding:10px 8px;font-size:10px;color:#475569;text-align:right;border-bottom:2px solid #cbd5e1">${tr('Ahorro Anual')}</th>
                    </tr>
                </thead>
                <tbody>
                ${dualSupplies.map((s, i) => {
                    const ahorro = Math.max(0, (s.originalBillAnnual||0) - (s.totalAnnual||0)); // Mostrar 0 si es negativo
                    const emoji = s.type === 'electricidad' ? 'âš¡' : 'ðŸ”¥';
                    const tipo = s.type === 'electricidad' ? tr('Electricidad') : tr('Gas');
                    return `
                    <tr style="border-bottom:1px solid #f1f5f9">
                        <td style="padding:12px 8px;font-size:11px;color:#1e293b;font-weight:bold">${i+1}</td>
                        <td style="padding:12px 8px;font-size:9px;color:#64748b">${s.cups}</td>
                        <td style="padding:12px 8px;font-size:10px;color:#1e293b;text-align:center">${emoji} ${tipo}</td>
                        <td style="padding:12px 8px;font-size:11px;color:#1e293b;text-align:center;font-weight:bold">${s.tariff}</td>
                        <td style="padding:12px 8px;font-size:12px;color:${ahorro > 0 ? '#22c55e' : '#9ca3af'};text-align:right;font-weight:bold">${ahorro.toFixed(2)} â‚¬</td>
                    </tr>
                    `;
                }).join('')}
                </tbody>
                <tfoot>
                    <tr style="background:#f1f5f9">
                        <td colspan="4" style="padding:15px 8px;font-size:13px;color:#1e293b;text-align:right;font-weight:bold;border-top:3px solid #cbd5e1">${tr('TOTAL AHORRO:')}</td>
                        <td style="padding:15px 8px;font-size:14px;color:#22c55e;text-align:right;font-weight:bold;border-top:3px solid #cbd5e1">${totalSavings.toFixed(2)} â‚¬</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <!-- AHORRO ANUAL - DISEÃ‘O LIMPIO -->
        <div style="padding:50px 30px 20px 30px;margin:20px 0;background:#ffffff;text-align:center">
            <p style="margin:0 0 20px 0;font-size:13px;color:#9ca3af;font-weight:600;text-transform:uppercase;letter-spacing:1px">${totalSavings > 0 ? tr('TU AHORRO ANUAL ESTIMADO') : tr('RESULTADO DE LA COMPARATIVA')}</p>
            <p style="margin:0;font-size:52px;color:${totalSavings > 0 ? '#22c55e' : '#9ca3af'};font-weight:600;letter-spacing:-1px">${totalSavings.toFixed(2)} â‚¬</p>
            ${totalSavings === 0 ? `<p style="margin:10px 0 0 0;font-size:14px;color:#9ca3af;">${tr('Sin ahorro conseguido')}</p>` : ''}
        </div>
        
        <!-- TABLA COMPARATIVA - DISEÃ‘O LIMPIO -->
        <div style="padding:30px 30px 40px 30px;margin:0;background:#ffffff;border-top:1px solid #f3f4f6">
            <table width="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse">
                <tr>
                    <!-- TU FACTURA ACTUAL -->
                    <td style="width:45%;padding:0;text-align:center;vertical-align:top">
                        <p style="margin:0 0 15px 0;font-size:11px;color:#9ca3af;font-weight:600;text-transform:uppercase;letter-spacing:0.5px">${tr("TU FACTURA ACTUAL")}</p>
                        <p style="margin:0;font-size:24px;color:#dc2626;font-weight:normal;text-decoration:line-through">${(totalOriginalBill/12).toFixed(2)} ${tr('â‚¬/mes')}</p>
                        <p style="margin:8px 0 0 0;font-size:10px;color:#cbd5e1">${tr("Total Periodo")} (31 ${tr('dÃ­as')})</p>
                        <p style="margin:20px 0 0 0;font-size:24px;color:#dc2626;font-weight:normal;text-decoration:line-through">${totalOriginalBill.toFixed(2)} ${tr('â‚¬/aÃ±o')}</p>
                    </td>
                    
                    <!-- SEPARADOR VERTICAL -->
                    <td style="width:10%;padding:0;text-align:center">
                        <div style="width:1px;height:150px;background:#e5e7eb;margin:0 auto"></div>
                    </td>
                    
                    <!-- TU NUEVO COSTE -->
                    <td style="width:45%;padding:0;text-align:center;vertical-align:top">
                        <p style="margin:0 0 15px 0;font-size:11px;color:#9ca3af;font-weight:600;text-transform:uppercase;letter-spacing:0.5px">${tr('TU NUEVO COSTE')} ${brandName}</p>
                        <p style="margin:0;font-size:28px;color:#475569;font-weight:500">${(totalNew/12).toFixed(2)} ${tr('â‚¬/mes')}</p>
                        <p style="margin:8px 0 0 0;font-size:10px;color:#cbd5e1">${tr("Estimado Mensual")}</p>
                        <p style="margin:20px 0 0 0;font-size:28px;color:#475569;font-weight:500">${totalNew.toFixed(2)} ${tr('â‚¬/aÃ±o')}</p>
                    </td>
                </tr>
            </table>
        </div>
        
        <!-- BANDA VERDE DESGLOSE -->
        <div style="background:#22c55e;padding:10px 30px">
            <p style="margin:0;font-size:12px;color:white;font-weight:bold;text-transform:uppercase">${tr('DESGLOSE DETALLADO POR SUMINISTRO')}</p>
        </div>
        
        <!-- DESGLOSES -->
        <div style="padding:0">
            ${dualSupplies.map((s, i) => {
                const eb = s.electricityBreakdown;
                const gb = s.gasBreakdown;
                const isElec = s.type === 'electricidad';
                const dias = isElec ? eb?.dias : gb?.dias || 30;
                const totalPeriod = isElec ? eb?.totalPeriod : gb?.total || 0;
                const ahorroAnual = Math.max(0, (s.originalBillAnnual || 0) - (s.totalAnnual || 0)); // Mostrar 0 si negativo
                
                // Construir nombre completo de tarifa: COMERCIALIZADORA - TARIFA
                const comercializadora = s.offer?.name || '';
                const tarifa = s.offer?.description || '';
                const tarifaCompleta = (comercializadora && tarifa && comercializadora !== tarifa) 
                    ? `${comercializadora} - ${tarifa}` 
                    : (tarifa || comercializadora || 'N/A');
                
                return `
                <div style="margin:15px 30px;background:${primaryColor};padding:12px;border-radius:5px">
                    <p style="margin:0 0 5px 0;font-size:11px;color:white;font-weight:bold">[${i+1}] ${s.cups}</p>
                    <p style="margin:0;font-size:10px;color:white">${tr('Tipo:')}: ${s.tariff} | ${tr('DÃ­as:')}: ${dias} ${tr('dÃ­as')} | CUPS: [${i+1}]</p>
                    <p style="margin:5px 0 0 0;font-size:10px;color:white"><strong>${tr('TARIFA:')}</strong> ${tarifaCompleta}</p>
                </div>
                
                <div style="margin:0 30px 15px 30px;padding:15px;background:#f8f9fa;border:1px solid #e2e8f0">
                    <p style="margin:0 0 8px 0;font-size:11px;color:#1e293b;font-weight:bold">${tr('PRECIOS APLICADOS:')}</p>
                    
                    ${isElec ? `
                    <p style="margin:0 0 3px 0;font-size:10px;color:#64748b"><strong>${tr('POTENCIA:')}</strong></p>
                    ${s.offer?.p1_power_price ? `<p style="margin:0 0 2px 0;font-size:9px;color:#64748b">P1: ${s.offer.p1_power_price.toFixed(6)} â‚¬/kW/dÃ­a</p>` : ''}
                    ${s.offer?.p2_power_price ? `<p style="margin:0 0 2px 0;font-size:9px;color:#64748b">P2: ${s.offer.p2_power_price.toFixed(6)} â‚¬/kW/dÃ­a</p>` : ''}
                    
                    <p style="margin:8px 0 3px 0;font-size:10px;color:#64748b"><strong>${tr('ENERGÃA:')}</strong></p>
                    ${s.offer?.p1_price ? `<p style="margin:0 0 2px 0;font-size:9px;color:#64748b">E1: ${s.offer.p1_price.toFixed(6)} â‚¬/kWh</p>` : ''}
                    ${s.offer?.p2_price ? `<p style="margin:0 0 2px 0;font-size:9px;color:#64748b">E2: ${s.offer.p2_price.toFixed(6)} â‚¬/kWh</p>` : ''}
                    ${s.offer?.p3_price ? `<p style="margin:0 0 2px 0;font-size:9px;color:#64748b">E3: ${s.offer.p3_price.toFixed(6)} â‚¬/kWh</p>` : ''}
                    ` : `
                    <p style="margin:0 0 2px 0;font-size:9px;color:#64748b">${tr('TÃ©rmino fijo:')}: ${(s.offer?.p_fijo_diario||0).toFixed(6)} â‚¬/dÃ­a</p>
                    <p style="margin:0 0 2px 0;font-size:9px;color:#64748b">${tr('EnergÃ­a:')}: ${(s.offer?.p1_price||0).toFixed(6)} â‚¬/kWh</p>
                    `}
                    
                    ${isElec ? `
                    <!-- ELECTRICIDAD: POTENCIA -->
                    <div style="margin-top:12px;padding:10px;background:${primaryColor};color:white;border-radius:5px">
                        <p style="margin:0;font-size:11px;font-weight:bold">${tr('POTENCIA')}</p>
                    </div>
                    ${eb?.powerCosts ? eb.powerCosts.map(pc => `
                        <div style="padding:8px 10px;background:white;border-bottom:1px solid #e2e8f0">
                            <div style="display:table;width:100%">
                                <div style="display:table-cell;font-size:10px;color:#1e293b">P${pc.period} (${pc.kw||0} kW x ${dias}d x ${(pc.priceDay||0).toFixed(6)} â‚¬/kW/dÃ­a)</div>
                                <div style="display:table-cell;text-align:right;font-size:10px;color:#1e293b;font-weight:bold">${(pc.cost||0).toFixed(2)} â‚¬</div>
                            </div>
                        </div>
                    `).join('') : `<div style="padding:8px 10px;background:white;font-size:10px;color:#64748b">${tr('No hay datos de potencia')}</div>`}
                    
                    <!-- ELECTRICIDAD: ENERGÃA -->
                    <div style="margin-top:12px;padding:10px;background:${primaryColor};color:white;border-radius:5px">
                        <p style="margin:0;font-size:11px;font-weight:bold">${tr('ENERGÃA')}</p>
                    </div>
                    ${eb?.energyCosts ? eb.energyCosts.map(ec => `
                        <div style="padding:8px 10px;background:white;border-bottom:1px solid #e2e8f0">
                            <div style="display:table;width:100%">
                                <div style="display:table-cell;font-size:10px;color:#1e293b">E${ec.period} (${ec.kwh||0} kWh x ${(ec.price||0).toFixed(6)} â‚¬/kWh)</div>
                                <div style="display:table-cell;text-align:right;font-size:10px;color:#1e293b;font-weight:bold">${(ec.cost||0).toFixed(2)} â‚¬</div>
                            </div>
                        </div>
                    `).join('') : `<div style="padding:8px 10px;background:white;font-size:10px;color:#64748b">${tr('No hay datos de energÃ­a')}</div>`}
                    
                    <!-- ANÃLISIS DE HORARIOS Y CONSUMO - SOLO PARA TARIFA 2.0TD -->
                    ${s.tariff === '2.0TD' && eb?.energyCosts && eb.energyCosts.length >= 3 ? (() => {
                        const puntaKwh = eb.energyCosts[0]?.kwh || 0;
                        const llanoKwh = eb.energyCosts[1]?.kwh || 0;
                        const valleKwh = eb.energyCosts[2]?.kwh || 0;
                        const totalKwh = puntaKwh + llanoKwh + valleKwh;
                        
                        const puntaPct = totalKwh > 0 ? (puntaKwh / totalKwh * 100).toFixed(1) : 0;
                        const llanoPct = totalKwh > 0 ? (llanoKwh / totalKwh * 100).toFixed(1) : 0;
                        const vallePct = totalKwh > 0 ? (valleKwh / totalKwh * 100).toFixed(1) : 0;
                        
                        let recomendacion = '';
                        if (puntaPct > 30) {
                            recomendacion = tr('Consumes mÃ¡s del 30% en horario Punta. Te recomendamos trasladar consumos al periodo Valle (madrugada y fines de semana) para maximizar tu ahorro.');
                        } else if (vallePct > 50) {
                            recomendacion = tr('Â¡Excelente! MÃ¡s del 50% de tu consumo estÃ¡ en Valle, el periodo mÃ¡s econÃ³mico. Sigue asÃ­ para maximizar tu ahorro.');
                        } else {
                            recomendacion = tr('Tu consumo estÃ¡ bien distribuido. Considera trasladar mÃ¡s consumo al periodo Valle para aumentar tu ahorro.');
                        }
                        
                        return `
                        <!-- ANÃLISIS DE HORARIOS (Solo 2.0TD) -->
                        <div style="margin-top:20px;padding:20px;background:#f8fafc;border-radius:8px">
                            <div style="padding-bottom:15px">
                                <h3 style="margin:0;color:#1e293b;font-size:14px;font-weight:bold;">
                                    ðŸ• ${tr('AnÃ¡lisis de Horarios y Consumo - Tarifa 2.0 TD')}
                                </h3>
                            </div>
                            
                            <!-- Tarjetas de Horarios -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom:15px">
                                <tr>
                                    <td width="48%" valign="top" style="background:#ffffff;padding:15px;border-radius:8px">
                                        <p style="margin:0 0 10px 0;text-align:center;font-weight:bold;color:#334155;font-size:12px">${tr('Lunes a viernes laborables')}</p>
                                        <table width="100%" cellpadding="5" cellspacing="0">
                                            <tr>
                                                <td style="background:#fef2f2;padding:8px;border-radius:6px;margin-bottom:5px">
                                                    <span style="display:inline-block;width:10px;height:10px;background:#dc2626;border-radius:50%;margin-right:5px"></span>
                                                    <span style="font-weight:bold;color:#991b1b;font-size:10px">${tr('Punta')}:</span>
                                                    <span style="color:#475569;font-size:10px">10-14h, 18-22h</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="background:#fefce8;padding:8px;border-radius:6px;margin-bottom:5px">
                                                    <span style="display:inline-block;width:10px;height:10px;background:#facc15;border-radius:50%;margin-right:5px"></span>
                                                    <span style="font-weight:bold;color:#a16207;font-size:10px">${tr('Llano')}:</span>
                                                    <span style="color:#475569;font-size:10px">8-10h, 14-18h, 22-24h</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="background:#f0fdf4;padding:8px;border-radius:6px">
                                                    <span style="display:inline-block;width:10px;height:10px;background:#16a34a;border-radius:50%;margin-right:5px"></span>
                                                    <span style="font-weight:bold;color:#166534;font-size:10px">${tr('Valle')}:</span>
                                                    <span style="color:#475569;font-size:10px">0-8h</span>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                    <td width="4%"></td>
                                    <td width="48%" valign="top" style="background:#ffffff;padding:15px;border-radius:8px">
                                        <p style="margin:0 0 10px 0;text-align:center;font-weight:bold;color:#334155;font-size:12px">${tr('SÃ¡bados, domingos y festivos')}</p>
                                        <table width="100%" cellpadding="15" cellspacing="0">
                                            <tr>
                                                <td style="background:#f0fdf4;padding:20px;border-radius:8px;text-align:center">
                                                    <span style="display:inline-block;width:14px;height:14px;background:#16a34a;border-radius:50%;margin-right:5px;vertical-align:middle"></span>
                                                    <span style="font-weight:bold;color:#166534;font-size:13px;vertical-align:middle">${tr('Valle')}</span>
                                                    <p style="margin:8px 0 0 0;color:#475569;font-size:10px">24 horas (todo el dÃ­a)</p>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- DistribuciÃ³n de Consumo -->
                            <div style="padding-bottom:15px">
                                <h4 style="margin:0;color:#1e293b;font-size:13px;font-weight:bold">
                                    ðŸ“Š ${tr('Tu DistribuciÃ³n de Consumo')}
                                </h4>
                            </div>
                            
                            <table width="100%" cellpadding="8" cellspacing="0">
                                <tr>
                                    <!-- Punta -->
                                    <td width="32%" style="background:#fef2f2;padding:12px;border-radius:8px;border:2px solid #fecaca;text-align:center">
                                        <span style="display:inline-block;width:12px;height:12px;background:#dc2626;border-radius:50%;margin-right:5px;vertical-align:middle"></span>
                                        <span style="font-weight:bold;color:#991b1b;font-size:11px;vertical-align:middle">${tr('Periodo Punta')}</span>
                                        <p style="margin:8px 0 5px 0;color:#dc2626;font-size:20px;font-weight:bold">${puntaPct}%</p>
                                        <p style="margin:0 0 5px 0;color:#64748b;font-size:10px">${puntaKwh.toFixed(0)} kWh</p>
                                        <p style="margin:0;background:#ffffff;padding:6px;border-radius:4px;color:#64748b;font-size:8px">
                                            ${tr('Horario mÃ¡s caro')}<br>10-14h, 18-22h (lab.)
                                        </p>
                                    </td>
                                    <td width="2%"></td>
                                    <!-- Llano -->
                                    <td width="32%" style="background:#fefce8;padding:12px;border-radius:8px;border:2px solid #fde047;text-align:center">
                                        <span style="display:inline-block;width:12px;height:12px;background:#facc15;border-radius:50%;margin-right:5px;vertical-align:middle"></span>
                                        <span style="font-weight:bold;color:#a16207;font-size:11px;vertical-align:middle">${tr('Periodo Llano')}</span>
                                        <p style="margin:8px 0 5px 0;color:#ca8a04;font-size:20px;font-weight:bold">${llanoPct}%</p>
                                        <p style="margin:0 0 5px 0;color:#64748b;font-size:10px">${llanoKwh.toFixed(0)} kWh</p>
                                        <p style="margin:0;background:#ffffff;padding:6px;border-radius:4px;color:#64748b;font-size:8px">
                                            ${tr('Precio medio')}<br>8-10h, 14-18h, 22-24h
                                        </p>
                                    </td>
                                    <td width="2%"></td>
                                    <!-- Valle -->
                                    <td width="32%" style="background:#f0fdf4;padding:12px;border-radius:8px;border:2px solid #bbf7d0;text-align:center">
                                        <span style="display:inline-block;width:12px;height:12px;background:#16a34a;border-radius:50%;margin-right:5px;vertical-align:middle"></span>
                                        <span style="font-weight:bold;color:#166534;font-size:11px;vertical-align:middle">${tr('Periodo Valle')}</span>
                                        <p style="margin:8px 0 5px 0;color:#16a34a;font-size:20px;font-weight:bold">${vallePct}%</p>
                                        <p style="margin:0 0 5px 0;color:#64748b;font-size:10px">${valleKwh.toFixed(0)} kWh</p>
                                        <p style="margin:0;background:#ffffff;padding:6px;border-radius:4px;color:#64748b;font-size:8px">
                                            ${tr('Horario mÃ¡s barato')}<br>0-8h + fines semana
                                        </p>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- Barra de progreso -->
                            <div style="padding-top:12px">
                                <table width="100%" cellpadding="0" cellspacing="0" style="height:25px;border-radius:6px;overflow:hidden">
                                    <tr>
                                        <td width="${puntaPct}%" style="background:#dc2626;color:#ffffff;text-align:center;font-size:9px;font-weight:bold;padding:5px">
                                            ${puntaPct > 8 ? puntaPct + '%' : ''}
                                        </td>
                                        <td width="${llanoPct}%" style="background:#facc15;color:#1e293b;text-align:center;font-size:9px;font-weight:bold;padding:5px">
                                            ${llanoPct > 8 ? llanoPct + '%' : ''}
                                        </td>
                                        <td width="${vallePct}%" style="background:#16a34a;color:#ffffff;text-align:center;font-size:9px;font-weight:bold;padding:5px">
                                            ${vallePct > 8 ? vallePct + '%' : ''}
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            
                            <!-- RecomendaciÃ³n -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background:#eff6ff;padding:12px;border-radius:8px;border-left:4px solid #0284c7;margin-top:15px">
                                <tr>
                                    <td>
                                        <p style="margin:0 0 5px 0;font-weight:bold;color:#0c4a6e;font-size:11px">ðŸ’¡ ${tr('RecomendaciÃ³n Personalizada')}</p>
                                        <p style="margin:0;color:#334155;font-size:10px;line-height:1.5">${recomendacion}</p>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        `;
                    })() : ''}
                    ` : `
                    <!-- GAS: DESGLOSE (sin secciÃ³n POTENCIA) -->
                    <div style="margin-top:12px;padding:10px;background:${primaryColor};color:white;border-radius:5px">
                        <p style="margin:0;font-size:11px;font-weight:bold">${tr('DESGLOSE DE COSTES')}</p>
                    </div>
                    ${gb ? `
                        <div style="padding:8px 10px;background:white;border-bottom:1px solid #e2e8f0">
                            <div style="display:table;width:100%">
                                <div style="display:table-cell;font-size:10px;color:#1e293b">${tr('TÃ©rmino fijo')} (${dias} ${tr('dÃ­as')} x ${(gb.termino_fijo_diario||0).toFixed(6)} â‚¬/dÃ­a)</div>
                                <div style="display:table-cell;text-align:right;font-size:10px;color:#1e293b;font-weight:bold">${(gb.termino_fijo||0).toFixed(2)} â‚¬</div>
                            </div>
                        </div>
                        <div style="padding:8px 10px;background:white;border-bottom:1px solid #e2e8f0">
                            <div style="display:table;width:100%">
                                <div style="display:table-cell;font-size:10px;color:#1e293b">${tr('EnergÃ­a')} (${gb.kwh||0} kWh x ${(s.offer?.p1_price||0).toFixed(6)} â‚¬/kWh)</div>
                                <div style="display:table-cell;text-align:right;font-size:10px;color:#1e293b;font-weight:bold">${(gb.energia||0).toFixed(2)} â‚¬</div>
                            </div>
                        </div>
                    ` : `<div style="padding:8px 10px;background:white;font-size:10px;color:#64748b">${tr('No hay datos')}</div>`}
                    `}
                    
                    <div style="margin-top:12px;padding:10px;background:#e2e8f0">
                        <div style="display:table;width:100%">
                            <div style="display:table-cell;font-size:11px;color:#1e293b;font-weight:bold">${tr('TOTAL')} (${dias} ${tr('DÃAS')}):</div>
                            <div style="display:table-cell;text-align:right;font-size:11px;color:#1e293b;font-weight:bold">${totalPeriod.toFixed(2)} â‚¬</div>
                        </div>
                    </div>
                    
                    <div style="margin-top:8px;padding:12px;background:#ef4444;text-align:center;border-radius:5px">
                        <p style="margin:0;font-size:12px;color:white;font-weight:bold">${tr('AHORRO:')}: ${ahorroAnual.toFixed(2)} â‚¬</p>
                    </div>
                </div>
                `;
            }).join('')}
        </div>
        
        <!-- AHORRO FINAL EN ROJO -->
        <div style="margin:25px 30px 30px 30px;padding:30px;background:${primaryColor};border-radius:10px;text-align:center">
            <p style="margin:0 0 15px 0;font-size:15px;color:white;font-weight:bold;text-transform:uppercase;letter-spacing:1px">ðŸŽ‰ ${tr('TU AHORRO ANUAL TOTAL')} ðŸŽ‰</p>
            <p style="margin:0 0 15px 0;font-size:48px;color:white;font-weight:bold">${eur(totalSavings)}</p>
            <p style="margin:0;font-size:15px;color:white;font-weight:bold;text-transform:uppercase">${tr('Â¡AHORRA')} ${(totalSavings/12).toFixed(2).replace('.', ',')} â‚¬ ${tr('CADA MES!')} </p>
        </div>
        
        <!-- FOOTER INSTRUCCIONES -->
        <div style="background:${primaryColor};padding:20px 30px;margin-top:20px">
            <p style="margin:0 0 10px 0;font-size:11px;color:white;font-weight:bold">${tr('PARA FORMALIZAR ESTE CONTRATO:')}</p>
            <p style="margin:0 0 8px 0;font-size:10px;color:white">${tr('Responde a este email adjuntando la documentaciÃ³n de los')} ${dualSupplies.length} CUPS:</p>
            <ol style="margin:0;padding-left:20px;font-size:10px;color:white;line-height:1.6">
                <li>${tr('Foto del DNI/CIF (anverso y reverso)')}</li>
                <li>${tr('Ãšltima factura (menos de 3 meses de antigÃ¼edad)')}</li>
                <li>${tr('AutorizaciÃ³n de cambio de titular (si aplica)')}</li>
                <li>${tr('TelÃ©fono de contacto')}</li>
                <li>${tr('NÃºmero de cuenta bancaria (IBAN)')}</li>
            </ol>
            <div style="margin-top:12px;padding:10px;background:rgba(255,255,255,0.2);border-radius:4px;text-align:center">
                <p style="margin:0;font-size:10px;color:white">${tr('EnvÃ­a la documentaciÃ³n al comercial:')}<strong>${comercialCode}</strong></p>
            </div>
        </div>
        
        <!-- BOTÃ“N CONFIRMAR Y ENVIAR -->
        <div style="background:#ffffff;padding:30px;margin:30px;border-radius:8px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.1)">
            <p style="margin:0 0 20px 0;font-size:18px;color:#1e293b;font-weight:bold">${tr('ðŸ“‹ Para confirmar esta oferta:')}</p>
            <p style="margin:0 0 10px 0;font-size:14px;color:#64748b">${tr('Haz clic en el botÃ³n de abajo')}</p>
            <p style="margin:0 0 20px 0;font-size:14px;color:#64748b">${tr('Se abrirÃ¡ tu cliente de email')}</p>
            <p style="margin:0 0 20px 0;font-size:14px;color:#64748b;font-weight:bold">${tr('Adjunta la documentaciÃ³n requerida')}</p>
            <p style="margin:0 0 25px 0;font-size:14px;color:#64748b">${tr('EnvÃ­a el email')}</p>
            
            <a href="${generateMailtoLink(comercialCode, clientName, clientPhone, clientEmail, dualSupplies, results, isPowerCup, brandName, totalSavings, totalOriginalBill, totalNew)}" 
               style="display:inline-block;background:#22c55e;color:white;text-decoration:none;padding:16px 40px;border-radius:8px;font-size:16px;font-weight:bold;box-shadow:0 4px 6px rgba(34,197,94,0.3)">
                ${tr('âœ… CONFIRMAR Y ENVIAR')}
            </a>
        </div>
        
    </div>
</body>
</html>`;
            
            return html;
        }
        
        // FunciÃ³n: Generar PDF con datos capturados
        function generateDualPDF() {
            const comercialCode = document.getElementById('comercial-code').value.trim();
            if (!comercialCode) {
                alert('Por favor, introduce el cÃ³digo comercial (obligatorio)');
                document.getElementById('comercial-code').focus();
                return;
            }
            
            const clientName = document.getElementById('client-name').value.trim() || tr('[NOMBRE COMPLETO CLIENTE]');
            const clientPhone = document.getElementById('client-phone').value.trim() || '';
            const clientAddress = document.getElementById('client-address').value.trim() || '';
            const clientEmail = document.getElementById('client-email').value.trim() || '';
            
            // Cerrar el modal
            closeClientDataModal();
            
            // Generar PDF
            dualGeneratePDF(comercialCode, clientName, clientPhone, clientEmail, clientAddress);
        }
        
        // FunciÃ³n: Generar PDF DUAL
        async function dualGeneratePDF(comercialCode = 'D=00', clientName = '', clientPhone = '', clientEmail = '', clientAddress = '') {
            if (!clientName) {
                clientName = tr('[NOMBRE COMPLETO CLIENTE]');
            }
            
            console.log('Generando PDF DUAL PROFESIONAL COMPLETO');
            console.log('dualSupplies:', dualSupplies);
            console.log('dualGlobalResults:', window.dualGlobalResults);
            
            // Verificar datos
            if (!window.dualGlobalResults || !dualSupplies || dualSupplies.length === 0) {
                alert('Error: No se encontraron los datos de comparaciÃ³n. Por favor, calcula de nuevo.');
                return;
            }
            
            // Detectar si es DRK o POWER CUP
            const isDrk = window.dualGlobalResults.comparisonMode === 'drk_only';
            const brandName = isDrk ? 'DRK' : 'POWER CUP';
            console.log('Modo detectado:', brandName);
            
            // Detectar idioma actual o usar espaÃ±ol por defecto
            let currentLang = localStorage.getItem('appLanguage');
            
            // Si no hay idioma guardado, detectar del navegador o usar espaÃ±ol
            if (!currentLang) {
                const browserLang = navigator.language || navigator.userLanguage;
                if (browserLang.startsWith('zh')) {
                    currentLang = 'zh';
                } else if (browserLang.startsWith('en')) {
                    currentLang = 'en';
                } else {
                    currentLang = 'es'; // EspaÃ±ol por defecto
                }
                console.log('No hay idioma guardado. Detectado del navegador:', browserLang, 'â†’', currentLang);
            } else {
                console.log('Idioma guardado encontrado:', currentLang);
            }
            
            const wasChineseMode = currentLang === 'zh';
            
            console.log('=== DETECCIÃ“N DE IDIOMA PARA PDF ===');
            console.log('Idioma que se usarÃ¡:', currentLang);
            console.log('Â¿Es modo chino?:', wasChineseMode);
            
            if (wasChineseMode) {
                alert('Generando PDF...\nGenerating PDF...');
                window.LANG.change('en', true);
                console.log('Cambiado a inglÃ©s temporalmente para modo chino');
            } else {
                // Asegurar que el idioma actual estÃ© activo
                console.log('Aplicando idioma:', currentLang);
                if (window.LANG && window.LANG.change) {
                    window.LANG.change(currentLang, true);
                }
            }
            
            // Esperar un momento para que el idioma se aplique
            await new Promise(resolve => setTimeout(resolve, 200));
            
            try {
                window.showMessageModal("Generando PDF DUAL profesional (3-4 paginas)... Por favor espere.");
                
                const { jsPDF } = window.jspdf;
                let doc = new jsPDF('p', 'mm', 'a4');
                const results = window.dualGlobalResults;
                
                // Funciones de formato
                const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
                const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
                
                // Variables globales
                let yPos = 0;
                const pageWidth = 210;
                const margin = 10;
                const contentWidth = pageWidth - (2 * margin);
                
                // Colores profesionales segÃºn el modo
                const azulDrk = [41, 128, 185];
                const azulClaro = [59, 130, 246];
                const verdeDrk = [22, 163, 74];
                const verdeClaro = [132, 204, 22];  // Power Cup verde
                const verdeFuerte = [22, 163, 74];
                const verdeAguaClaro = [240, 253, 244];
                const rojoFuerte = [220, 38, 38];
                const rojoClaro = [254, 242, 242];
                const grisOscuro = [71, 85, 105];
                const grisClaro = [248, 250, 252];
                
                // Colores principales segÃºn marca
                const colorPrincipal = isDrk ? azulDrk : verdeDrk;
                const colorSecundario = isDrk ? azulClaro : verdeClaro;
                
                console.log('Iniciando generacion de PDF...');
                
                // PAGINA 1: PORTADA Y RESUMEN
                
                // HEADER CON RAYAS VERTICALES (estilo individual)
                const headerHeight = 45;
                
                // Fondo con rayas verticales
                for (let i = 0; i < pageWidth; i++) {
                    if (isDrk) {
                        // Degradado azul DRK
                        const ratio = i / pageWidth;
                        const r = Math.round(41 + (59 - 41) * ratio);
                        const g = Math.round(128 + (130 - 128) * ratio);
                        const b = Math.round(185 + (246 - 185) * ratio);
                        doc.setFillColor(r, g, b);
                    } else {
                        // Rayas verticales verde POWER CUP
                        const stripeWidth = 2;
                        if (Math.floor(i / stripeWidth) % 2 === 0) {
                            doc.setFillColor(100, 130, 90); // Verde oscuro
                        } else {
                            doc.setFillColor(130, 160, 110); // Verde mÃ¡s claro
                        }
                    }
                    doc.rect(i, 0, 1, headerHeight, 'F');
                }
                
                // Logo segÃºn marca
                const logoX = margin + 8;
                const logoY = 15;
                const logoRadius = 6;
                
                if (isDrk) {
                    // Logo circular DRK (anillo multicolor)
                    doc.setFillColor(219, 68, 55); // Rojo
                    doc.circle(logoX - 1, logoY + 1, logoRadius * 0.8, 'F');
                    doc.setFillColor(66, 133, 244); // Azul
                    doc.circle(logoX + 1, logoY - 1, logoRadius * 0.8, 'F');
                    doc.setFillColor(244, 180, 0); // Amarillo
                    doc.circle(logoX - 1, logoY - 1, logoRadius * 0.7, 'F');
                    doc.setFillColor(15, 157, 88); // Verde
                    doc.circle(logoX + 1, logoY + 1, logoRadius * 0.7, 'F');
                    
                    // CÃ­rculo central blanco
                    doc.setFillColor(255, 255, 255);
                    doc.circle(logoX, logoY, logoRadius * 0.4, 'F');
                } else {
                    // Logo POWER CUP (taza con niveles de energÃ­a y rayo)
                    
                    // Plato/base (verde oscuro)
                    doc.setFillColor(60, 90, 50);
                    doc.rect(logoX - 5, logoY + 4, 10, 1, 'F');
                    
                    // Borde de la taza (verde oscuro)
                    doc.setDrawColor(60, 90, 50);
                    doc.setLineWidth(1.2);
                    doc.roundedRect(logoX - 3.5, logoY - 2, 7, 6, 0.5, 0.5, 'S');
                    
                    // Asa de la taza (usando lÃ­nea curva)
                    doc.setLineWidth(1);
                    doc.line(logoX + 3.5, logoY, logoX + 5, logoY - 0.5);
                    doc.line(logoX + 5, logoY - 0.5, logoX + 5.5, logoY + 1);
                    doc.line(logoX + 5.5, logoY + 1, logoX + 5, logoY + 2.5);
                    doc.line(logoX + 5, logoY + 2.5, logoX + 3.5, logoY + 2);
                    
                    // Niveles de energÃ­a dentro de la taza (lÃ­neas verdes horizontales)
                    doc.setFillColor(100, 150, 70);
                    doc.rect(logoX - 3, logoY + 2.5, 6, 0.8, 'F');  // Nivel 1
                    doc.rect(logoX - 3, logoY + 0.8, 6, 0.8, 'F');  // Nivel 2
                    doc.rect(logoX - 3, logoY - 0.9, 6, 0.8, 'F');  // Nivel 3
                    
                    // Rayo amarillo encima de la taza
                    doc.setFillColor(255, 200, 0);
                    const rayX = logoX;
                    const rayY = logoY - 7;
                    // Parte superior del rayo
                    doc.triangle(rayX - 1, rayY, rayX - 2, rayY + 2.5, rayX, rayY + 2, 'F');
                    // Parte inferior del rayo
                    doc.triangle(rayX, rayY + 2, rayX - 1, rayY + 4.5, rayX + 1.5, rayY + 4.5, 'F');
                }
                
                yPos = 12;
                
                // Texto "DRK/POWER CUP ENERGÃA" a la derecha del logo
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                const brandText = isDrk ? 'DRK' : 'POWER CUP';
                doc.text(brandText, logoX + 12, yPos + 3);
                
                // "ENERGÃA" debajo
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text('ENERGÃA', logoX + 12, yPos + 11);
                
                // Tagline
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(200, 220, 240);
                doc.text(tr('Liderando el ahorro y la'), logoX + 12, yPos + 19);
                doc.text(tr('eficiencia energÃ©tica.'), logoX + 12, yPos + 24);
                
                // Texto derecha "ESTUDIO DE AHORRO COMPARATIVA PROFESIONAL"
                doc.setTextColor(40, 60, 80);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('ESTUDIO DE AHORRO'), pageWidth - margin - 3, yPos + 5, { align: 'right' });
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('COMPARATIVA', pageWidth - margin - 3, yPos + 13, { align: 'right' });
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(100, 120, 140);
                doc.text('PROFESIONAL', pageWidth - margin - 3, yPos + 21, { align: 'right' });
                
                yPos = 50;
                
                // === INFORMACIÃ“N DEL CLIENTE (REDISEÃ‘ADA) ===
                // Barra superior verde/azul
                doc.setFillColor(...colorPrincipal);
                doc.roundedRect(margin, yPos, contentWidth, 8, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('ESTUDIO DE AHORRO'), margin + 5, yPos + 5.5);
                
                // Caja blanca con borde
                doc.setFillColor(255, 255, 255);
                doc.setDrawColor(...colorPrincipal);
                doc.setLineWidth(1);
                doc.roundedRect(margin, yPos + 8, contentWidth, 20, 3, 3, 'FD');
                
                doc.setTextColor(...colorPrincipal);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('COMPARATIVA PROFESIONAL - ') + brandName, margin + 5, yPos + 14);
                
                doc.setTextColor(80, 80, 80);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text(tr('CLIENTE: ') + clientName, margin + 5, yPos + 20);
                
                // CUPS del primer suministro (usar de dualSupplies si existe)
                if (dualSupplies && dualSupplies.length > 0 && dualSupplies[0].cups) {
                    doc.text(tr('CUPS: ') + dualSupplies[0].cups, margin + 5, yPos + 25);
                } else {
                    doc.text(tr('CUPS: ') + 'N/A', margin + 5, yPos + 25);
                }
                
                // Comercial en caja destacada
                doc.setFillColor(...grisClaro);
                doc.roundedRect(pageWidth - margin - 45, yPos + 17, 45, 8, 2, 2, 'F');
                doc.setTextColor(...colorPrincipal);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(8);
                doc.text(tr('COMERCIAL: ') + comercialCode, pageWidth - margin - 43, yPos + 22.5);
                
                // DirecciÃ³n debajo del comercial (si existe)
                if (clientAddress) {
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(7);
                    doc.text(tr('DirecciÃ³n:') + ' ' + clientAddress, pageWidth - margin - 43, yPos + 27);
                }
                
                yPos += 35;
                
                // === CABECERA CON MARCA (estilo individual) ===
                // Verde oliva para POWER CUP, Azul para DRK
                if (!isDrk) {
                    doc.setFillColor(133, 146, 104); // Verde oliva RGB(133, 146, 104)
                } else {
                    doc.setFillColor(...colorPrincipal); // Azul DRK
                }
                doc.roundedRect(margin, yPos, contentWidth, 32, 4, 4, 'F');
                
                // "LA MEJOR OPCIÃ“N PARA TI ES"
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('LA MEJOR OPCIÃ“N PARA TI ES'), pageWidth / 2, yPos + 8, { align: 'center' });
                
                // Marca - TamaÃ±o ajustado segÃºn marca
                if (!isDrk) {
                    // POWER CUP: mÃ¡s grande
                    doc.setFontSize(32);
                    doc.setFont('helvetica', 'bold');
                    doc.text(brandName, pageWidth / 2, yPos + 20, { align: 'center' });
                } else {
                    // DRK: tamaÃ±o intermedio con nombre de tarifa abajo
                    doc.setFontSize(26);
                    doc.setFont('helvetica', 'bold');
                    doc.text('DRK', pageWidth / 2, yPos + 18, { align: 'center' });
                    
                    // Nombre de tarifa mÃ¡s pequeÃ±o debajo
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text('DRK 1', pageWidth / 2, yPos + 27, { align: 'center' });
                }
                
                yPos += 37;
                
                // CAJA "RESUMEN DE SUMINISTROS"
                doc.setFillColor(240, 249, 255);
                doc.roundedRect(margin, yPos, contentWidth, 10, 3, 3, 'F');
                doc.setDrawColor(...colorPrincipal);
                doc.setLineWidth(1);
                doc.roundedRect(margin, yPos, contentWidth, 10, 3, 3, 'S');
                
                doc.setTextColor(...grisOscuro);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('RESUMEN DE SUMINISTROS INCLUIDOS'), pageWidth / 2, yPos + 7, { align: 'center' });
                
                yPos += 15;
                
                // TABLA DE SUMINISTROS - calcular altura dinÃ¡micamente segÃºn direcciones
                let tablaHeightDynamic = 10 + 12; // Header + footer
                dualSupplies.forEach(supply => {
                    // 9 base + 4 adicionales si tiene direcciÃ³n
                    const hasAddress = supply.supplyAddress && supply.supplyAddress !== 'No especificada';
                    tablaHeightDynamic += hasAddress ? 13 : 9;
                });
                const tablaHeight = tablaHeightDynamic;
                
                doc.setFillColor(255, 255, 255);
                doc.roundedRect(margin, yPos, contentWidth, tablaHeight, 2, 2, 'F');
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.5);
                doc.roundedRect(margin, yPos, contentWidth, tablaHeight, 2, 2, 'S');
                
                // Titulo tabla
                doc.setFontSize(11);
                doc.setTextColor(...grisOscuro);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('RESUMEN DE SUMINISTROS INCLUIDOS'), pageWidth / 2, yPos + 7, { align: 'center' });
                
                yPos += 12;
                
                // Cabecera columnas
                doc.setFillColor(...grisClaro);
                doc.rect(margin + 2, yPos, contentWidth - 4, 7, 'F');
                
                doc.setFontSize(8);
                doc.setTextColor(100, 116, 139);
                doc.setFont('helvetica', 'bold');
                doc.text('#', margin + 5, yPos + 4.5);
                doc.text(tr('CUPS / DIRECCIÃ“N'), margin + 15, yPos + 4.5);
                doc.text(tr('Tipo'), margin + 100, yPos + 4.5);
                doc.text(tr('Tarifa'), margin + 130, yPos + 4.5);
                doc.text(tr('Ahorro Anual'), pageWidth - margin - 12, yPos + 4.5, { align: 'right' });
                
                yPos += 9;
                
                // Filas de suministros
                dualSupplies.forEach((supply, idx) => {
                    console.log('Supply', idx, ':', supply);
                    
                    // Altura de fila ajustada segÃºn si hay direcciÃ³n
                    const rowHeight = supply.supplyAddress && supply.supplyAddress !== 'No especificada' ? 11 : 7;
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(71, 85, 105);
                    doc.setFontSize(8);
                    
                    doc.text(String(idx + 1), margin + 5, yPos + 3.5);
                    
                    // CUPS (primera lÃ­nea)
                    const cupsShort = supply.cups || 'N/A';
                    doc.text(cupsShort, margin + 15, yPos + 3.5);
                    
                    // DIRECCIÃ“N (segunda lÃ­nea, si existe)
                    if (supply.supplyAddress && supply.supplyAddress !== 'No especificada') {
                        doc.setFontSize(6);
                        doc.setTextColor(100, 116, 139); // Gris para la direcciÃ³n
                        const direccionCorta = supply.supplyAddress.length > 35 
                            ? supply.supplyAddress.substring(0, 32) + '...' 
                            : supply.supplyAddress;
                        doc.text(direccionCorta, margin + 15, yPos + 7.5);
                        doc.setTextColor(71, 85, 105);
                    }
                    
                    // Tipo SIN emojis
                    doc.setFontSize(8);
                    const tipoText = supply.type === 'electricidad' ? tr('Electricidad') : tr('Gas');
                    doc.text(tipoText, margin + 100, yPos + 3.5);
                    
                    doc.text(supply.tariff || supply.originalTariffType || 'N/A', margin + 130, yPos + 3.5);
                    
                    // Obtener ahorro segÃºn el tipo
                    const breakdown = supply.type === 'electricidad' ? supply.electricityBreakdown : supply.gasBreakdown;
                    const ahorro = (breakdown && breakdown.ahorro_anual) || 0;
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...verdeFuerte);
                    doc.setFontSize(9);
                    doc.text(eur(ahorro), pageWidth - margin - 12, yPos + 3.5, { align: 'right' });
                    
                    yPos += rowHeight;
                    
                    if (idx < dualSupplies.length - 1) {
                        doc.setDrawColor(226, 232, 240);
                        doc.line(margin + 5, yPos, pageWidth - margin - 5, yPos);
                    }
                    yPos += 2;
                });
                
                // Total ahorro
                doc.setFillColor(...verdeClaro);
                doc.rect(margin + 2, yPos, contentWidth - 4, 10, 'F');
                
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...verdeFuerte);
                doc.setFontSize(11);
                doc.text(tr('TOTAL AHORRO:'), margin + 10, yPos + 7);
                doc.setFontSize(13);
                doc.text(eur(results.totalSavings || 0), pageWidth - margin - 12, yPos + 7, { align: 'right' });
                
                yPos += 18;
                
                // AHORRO ANUAL DESTACADO - Color segÃºn marca
                if (isDrk) {
                    doc.setFillColor(41, 128, 185); // Azul DRK
                } else {
                    doc.setFillColor(133, 146, 104); // Verde oliva POWER CUP
                }
                doc.roundedRect(margin, yPos, contentWidth, 32, 3, 3, 'F');
                
                doc.setTextColor(255, 255, 255); // Texto blanco
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(tr('TU AHORRO ANUAL TOTAL'), pageWidth / 2, yPos + 8, { align: 'center' });
                
                doc.setTextColor(255, 255, 255); // Texto blanco
                doc.setFontSize(32);
                doc.setFont('helvetica', 'bold');
                doc.text(num(results.totalSavings || 0, 2) + ' EUR', pageWidth / 2, yPos + 25, { align: 'center' });
                
                // "AHORRA X EUR CADA MES" en blanco tambiÃ©n
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text(tr('AHORRA ') + num((results.totalSavings || 0) / 12, 2) + tr(' EUR CADA MES'), pageWidth / 2, yPos + 30, { align: 'center' });
                
                // PAGINA 2: COMPARATIVA Y DESGLOSE
                
                doc.addPage();
                yPos = 20;
                
                // COMPARATIVA VISUAL
                const boxWidth = (contentWidth / 2) - 5;
                const boxHeight = 60;
                
                // CAJA IZQUIERDA - FACTURA ACTUAL (ROJA TACHADA)
                doc.setFillColor(...rojoClaro);
                doc.roundedRect(margin, yPos, boxWidth, boxHeight, 3, 3, 'F');
                doc.setDrawColor(...rojoFuerte);
                doc.setLineWidth(2);
                doc.roundedRect(margin, yPos, boxWidth, boxHeight, 3, 3, 'S');
                
                doc.setTextColor(127, 29, 29);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('TU FACTURA ACTUAL'), margin + (boxWidth / 2), yPos + 10, { align: 'center' });
                
                const costoMensualActual = (results.totalOriginalBill || 0) / 12;
                doc.setTextColor(...rojoFuerte);
                doc.setFontSize(20);
                const text1 = eur(costoMensualActual) + '/mes';
                const textWidth1 = doc.getTextWidth(text1);
                const textX1 = margin + (boxWidth / 2) - (textWidth1 / 2);
                doc.text(text1, margin + (boxWidth / 2), yPos + 24, { align: 'center' });
                doc.setLineWidth(1);
                doc.line(textX1, yPos + 22.5, textX1 + textWidth1, yPos + 22.5);
                
                doc.setFontSize(8);
                doc.setTextColor(100, 116, 139);
                doc.setFont('helvetica', 'normal');
                const avgDays = results.avgDays || 31;
                doc.text(tr('Total Periodo') + ` (${avgDays} ` + tr('dias') + `)`, margin + (boxWidth / 2), yPos + 33, { align: 'center' });
                
                doc.setFontSize(18);
                doc.setTextColor(...rojoFuerte);
                doc.setFont('helvetica', 'bold');
                const text2 = eur(results.totalOriginalBill || 0) + '/ano';
                const textWidth2 = doc.getTextWidth(text2);
                const textX2 = margin + (boxWidth / 2) - (textWidth2 / 2);
                doc.text(text2, margin + (boxWidth / 2), yPos + 48, { align: 'center' });
                doc.line(textX2, yPos + 46.5, textX2 + textWidth2, yPos + 46.5);
                
                // CAJA DERECHA - NUEVO COSTE (DEGRADADO VERDE OLIVA)
                // Degradado vertical verde oliva (mÃ¡s oscuro arriba, mÃ¡s claro abajo)
                const boxX = margin + boxWidth + 10;
                const gradientSteps = 60;
                for (let i = 0; i < gradientSteps; i++) {
                    const ratio = i / gradientSteps;
                    // De verde oliva oscuro (arriba) a verde lima claro (abajo)
                    const r = Math.round(60 + (180 - 60) * ratio);    // 60 â†’ 180
                    const g = Math.round(120 + (220 - 120) * ratio);  // 120 â†’ 220
                    const b = Math.round(70 + (120 - 70) * ratio);    // 70 â†’ 120
                    doc.setFillColor(r, g, b);
                    const sliceHeight = boxHeight / gradientSteps;
                    doc.rect(boxX, yPos + (i * sliceHeight), boxWidth, sliceHeight + 0.5, 'F');
                }
                
                // Borde redondeado verde oscuro encima del degradado
                doc.setDrawColor(60, 120, 70); // Verde oscuro
                doc.setLineWidth(3);
                doc.roundedRect(boxX, yPos, boxWidth, boxHeight, 3, 3, 'S');
                
                // Texto en BLANCO
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('TU NUEVO COSTE ') + brandName, boxX + (boxWidth / 2), yPos + 10, { align: 'center' });
                
                const totalNuevo = results.totalDRK || 0;
                const costoMensualNuevo = totalNuevo / 12;
                doc.setTextColor(255, 255, 255);  // Blanco
                doc.setFontSize(20);
                doc.text(eur(costoMensualNuevo) + '/mes', boxX + (boxWidth / 2), yPos + 24, { align: 'center' });
                
                doc.setFontSize(8);
                doc.setTextColor(255, 255, 255);  // Blanco (cambiado de verde grisÃ¡ceo)
                doc.setFont('helvetica', 'normal');
                doc.text(tr('Estimado Mensual'), boxX + (boxWidth / 2), yPos + 33, { align: 'center' });
                
                doc.setFontSize(18);
                doc.setTextColor(255, 255, 255);  // Blanco
                doc.setFont('helvetica', 'bold');
                doc.text(eur(totalNuevo) + '/ano', boxX + (boxWidth / 2), yPos + 48, { align: 'center' });
                
                yPos += boxHeight + 15;
                
                // BANNER VERDE
                doc.setFillColor(...verdeFuerte);
                doc.rect(margin, yPos, contentWidth, 12, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(13);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('DESGLOSE DETALLADO POR SUMINISTRO'), margin + 5, yPos + 8);
                
                yPos += 17;
                
                // DESGLOSE DE CADA SUMINISTRO
                dualSupplies.forEach((supply, idx) => {
                    console.log('Procesando suministro', idx, 'para desglose:', supply);
                    console.log('  - offer:', supply.offer);
                    console.log('  - electricityBreakdown:', supply.electricityBreakdown);
                    console.log('  - gasBreakdown:', supply.gasBreakdown);
                    
                    // Obtener breakdown segÃºn el tipo (una sola vez para todo el forEach)
                    const breakdown = supply.type === 'electricidad' ? supply.electricityBreakdown : supply.gasBreakdown;
                    
                    if (yPos > 240) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    // CABECERA GRIS DEL SUMINISTRO
                    doc.setFillColor(...grisOscuro);
                    doc.rect(margin, yPos, contentWidth, 14, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    const cupsDisplay = supply.cups || 'N/A';
                    doc.text(`[${idx + 1}] ${cupsDisplay}`, margin + 3, yPos + 6);
                    
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    const tariffDisplay = supply.tariff || supply.originalTariffType || 'N/A';
                    const diasDisplay = (breakdown && breakdown.dias) || supply.dias || supply.days || 30;
                    doc.text(tr('Tipo:') + `: ${tariffDisplay} | ` + tr('Dias:') + `: ${diasDisplay} ` + tr('dias') + ` | CUPS: [${idx + 1}]`, margin + 3, yPos + 11);
                    
                    yPos += 16;
                    
                    // CAJA CON TARIFA Y PRECIOS
                    const preciosHeight = supply.type === 'electricidad' ? 32 : 25;
                    doc.setFillColor(255, 255, 255);
                    doc.rect(margin, yPos, contentWidth, preciosHeight, 'F');
                    doc.setDrawColor(226, 232, 240);
                    doc.setLineWidth(0.5);
                    doc.rect(margin, yPos, contentWidth, preciosHeight, 'S');
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('TARIFA:'), margin + 5, yPos + 6);
                    doc.setFont('helvetica', 'normal');
                    
                    // Obtener comercializadora y nombre de tarifa correcto
                    let comercializadora = 'DRK';
                    let tarifaName = '';
                    
                    // Primero intentar obtener de offer
                    let offerObj = supply.offer || (supply.data && supply.data.offer) || (supply.data && supply.data.bestOffer);
                    
                    if (offerObj) {
                        comercializadora = offerObj.comercializadora || offerObj.name || 'DRK';
                        tarifaName = offerObj.name || offerObj.description || '';
                        
                        // Si name y comercializadora son iguales, buscar description
                        if (tarifaName === comercializadora && offerObj.description) {
                            tarifaName = offerObj.description;
                        }
                    } else if (supply.type === 'electricidad') {
                        tarifaName = 'DRK FIJO 4';
                    } else {
                        tarifaName = 'DRK 1';
                    }
                    
                    const tarifaCompleta = tarifaName ? `${comercializadora} - ${tarifaName}` : comercializadora;
                    doc.text(tr('TARIFA:') + ` ${tarifaCompleta}`, margin + 5, yPos + 6);
                    
                    doc.setFont('helvetica', 'bold');
                    doc.text(tr('PRECIOS APLICADOS:'), margin + 5, yPos + 12);
                    
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    
                    // Obtener precios de la oferta
                    let offerData = supply.offer || (supply.data && supply.data.offer) || (supply.data && supply.data.bestOffer);
                    
                    if (supply.type === 'electricidad') {
                        doc.setFont('helvetica', 'bold');
                        doc.text(tr('POTENCIA:'), margin + 8, yPos + 17);
                        doc.setFont('helvetica', 'normal');
                        const p1 = (offerData && offerData.p_potencia_1) ? offerData.p_potencia_1 / 365 : 0;
                        const p2 = (offerData && offerData.p_potencia_2) ? offerData.p_potencia_2 / 365 : 0;
                        doc.text(`P1: ${p1.toFixed(6)} EUR/kW/${tr('dia')}`, margin + 30, yPos + 17);
                        doc.text(`P2: ${p2.toFixed(6)} EUR/kW/${tr('dia')}`, margin + 90, yPos + 17);
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text(tr('ENERGIA:'), margin + 8, yPos + 22);
                        doc.setFont('helvetica', 'normal');
                        const e1 = (offerData && offerData.p1_price) ? offerData.p1_price : 0;
                        const e2 = (offerData && offerData.p2_price) ? offerData.p2_price : 0;
                        const e3 = (offerData && offerData.p3_price) ? offerData.p3_price : 0;
                        doc.text(`E1: ${e1.toFixed(6)} EUR/kWh`, margin + 30, yPos + 22);
                        doc.text(`E2: ${e2.toFixed(6)} EUR/kWh`, margin + 90, yPos + 22);
                        doc.text(`E3: ${e3.toFixed(6)} EUR/kWh`, margin + 30, yPos + 27);
                        
                    } else {
                        const termFijo = (offerData && offerData.p_fijo_diario) ? offerData.p_fijo_diario : 0;
                        const energia = (offerData && offerData.p1_price) ? offerData.p1_price : 0;
                        doc.text(tr('Termino fijo') + `:: ${termFijo.toFixed(6)} EUR/${tr('dia')}`, margin + 10, yPos + 17);
                        doc.text(tr('Energia') + `:: ${energia.toFixed(6)} EUR/kWh`, margin + 90, yPos + 17);
                    }
                    
                    yPos += preciosHeight + 2;
                    
                    // DESGLOSE DE COSTES
                    if (supply.type === 'electricidad') {
                        // POTENCIA
                        doc.setFillColor(71, 85, 105);
                        doc.rect(margin, yPos, contentWidth, 8, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text(tr('POTENCIA'), margin + 5, yPos + 5.5);
                        yPos += 10;
                        
                        doc.setFillColor(255, 255, 255);
                        
                        // Obtener costes de potencia (solo electricidad)
                        let powerCosts = (supply.electricityBreakdown && supply.electricityBreakdown.powerCosts) || [];
                        console.log('powerCosts original:', powerCosts);
                        console.log('powerCosts length:', powerCosts.length);
                        if (powerCosts.length > 0) {
                            console.log('powerCosts[0]:', powerCosts[0]);
                        }
                        
                        // Si powerCosts estÃ¡ vacÃ­o pero tenemos el offer, calcularlo
                        if ((!powerCosts || powerCosts.length === 0) && offerData) {
                            const dias = (breakdown && breakdown.dias) || supply.dias || 60;
                            powerCosts = [];
                            
                            // P1
                            if (offerData.p_potencia_1 && supply.data && supply.data.p1) {
                                const p1_diario = offerData.p_potencia_1 / 365;
                                powerCosts.push({
                                    kw: supply.data.p1,
                                    priceDay: p1_diario,
                                    cost: supply.data.p1 * dias * p1_diario
                                });
                            }
                            
                            // P2
                            if (offerData.p_potencia_2 && supply.data && supply.data.p2) {
                                const p2_diario = offerData.p_potencia_2 / 365;
                                powerCosts.push({
                                    kw: supply.data.p2,
                                    priceDay: p2_diario,
                                    cost: supply.data.p2 * dias * p2_diario
                                });
                            }
                        }
                        
                        if (powerCosts && powerCosts.length > 0) {
                            powerCosts.forEach((pc, pidx) => {
                                if (pc && pc.kw > 0) {
                                    doc.setFontSize(8);
                                    doc.setTextColor(0, 0, 0);
                                    doc.setFont('helvetica', 'normal');
                                    const dias = (supply.electricityBreakdown && supply.electricityBreakdown.dias) || supply.dias || 30;
                                    const label = `P${pidx + 1} (${pc.kw} kW x ${dias}${tr('d')} x ${(pc.priceDay || pc.precio || 0).toFixed(6)} EUR/kW/${tr('dia')})`;
                                    doc.text(label, margin + 5, yPos + 4);
                                    doc.setFont('helvetica', 'bold');
                                    doc.text(eur(pc.cost || pc.total || 0), pageWidth - margin - 5, yPos + 4, { align: 'right' });
                                        yPos += 6;
                                }
                            });
                        } else {
                            doc.setFontSize(8);
                            doc.setTextColor(150, 150, 150);
                            doc.text(tr('No hay datos de potencia disponibles'), margin + 5, yPos + 4);
                            yPos += 6;
                        }
                        
                        yPos += 2;
                        
                        // ENERGIA
                        doc.setFillColor(71, 85, 105);
                        doc.rect(margin, yPos, contentWidth, 8, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text(tr('ENERGIA'), margin + 5, yPos + 5.5);
                        yPos += 10;
                        
                        doc.setFillColor(255, 255, 255);
                        
                        // Obtener costes de energÃ­a (solo electricidad)
                        let energyCosts = (supply.electricityBreakdown && supply.electricityBreakdown.energyCosts) || [];
                        console.log('energyCosts original:', energyCosts);
                        console.log('energyCosts length:', energyCosts.length);
                        if (energyCosts.length > 0) {
                            console.log('energyCosts[0]:', energyCosts[0]);
                        }
                        
                        // Si energyCosts estÃ¡ vacÃ­o pero tenemos el offer, calcularlo
                        if ((!energyCosts || energyCosts.length === 0) && offerData) {
                            energyCosts = [];
                            
                            // E1
                            if (offerData.p1_price && supply.data && supply.data.e1) {
                                energyCosts.push({
                                    kwh: supply.data.e1,
                                    price: offerData.p1_price,
                                    cost: supply.data.e1 * offerData.p1_price
                                });
                            }
                            
                            // E2
                            if (offerData.p2_price && supply.data && supply.data.e2) {
                                energyCosts.push({
                                    kwh: supply.data.e2,
                                    price: offerData.p2_price,
                                    cost: supply.data.e2 * offerData.p2_price
                                });
                            }
                            
                            // E3
                            if (offerData.p3_price && supply.data && supply.data.e3) {
                                energyCosts.push({
                                    kwh: supply.data.e3,
                                    price: offerData.p3_price,
                                    cost: supply.data.e3 * offerData.p3_price
                                });
                            }
                        }
                        
                        if (energyCosts && energyCosts.length > 0) {
                            energyCosts.forEach((ec, eidx) => {
                                if (ec && ec.kwh > 0) {
                                    doc.setFontSize(8);
                                    doc.setTextColor(0, 0, 0);
                                    doc.setFont('helvetica', 'normal');
                                    const label = `E${eidx + 1} (${ec.kwh} kWh x ${(ec.price || ec.precio || 0).toFixed(6)} EUR/kWh)`;
                                    doc.text(label, margin + 5, yPos + 4);
                                    doc.setFont('helvetica', 'bold');
                                    doc.text(eur(ec.cost || ec.total || 0), pageWidth - margin - 5, yPos + 4, { align: 'right' });
                                    yPos += 6;
                                }
                            });
                        } else {
                            doc.setFontSize(8);
                            doc.setTextColor(150, 150, 150);
                            doc.text(tr('No hay datos de energia disponibles'), margin + 5, yPos + 4);
                            yPos += 6;
                        }
                        
                        yPos += 2;
                        
                    } else {
                        // GAS
                        doc.setFillColor(71, 85, 105);
                        doc.rect(margin, yPos, contentWidth, 8, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text(tr('DESGLOSE DE COSTES'), margin + 5, yPos + 5.5);
                        yPos += 10;
                        
                        doc.setFillColor(255, 255, 255);
                        doc.setFontSize(8);
                        doc.setTextColor(0, 0, 0);
                        doc.setFont('helvetica', 'normal');
                        
                        const termFijo = (offerData && offerData.p_fijo_diario) ? offerData.p_fijo_diario : 0;
                        const dias = (supply.gasBreakdown && supply.gasBreakdown.dias) || supply.dias || supply.days || 30;
                        const costoTermFijo = termFijo * dias;
                        doc.text(tr('Termino fijo') + ` (${dias} ` + tr('dias') + ` x ${termFijo.toFixed(6)} EUR/${tr('dia')})`, margin + 5, yPos + 4);
                        doc.setFont('helvetica', 'bold');
                        doc.text(eur(costoTermFijo), pageWidth - margin - 5, yPos + 4, { align: 'right' });
                        yPos += 6;
                        
                        doc.setFont('helvetica', 'normal');
                        const kwh = (supply.gasBreakdown && supply.gasBreakdown.kwh) || supply.kwh || 0;
                        const precioEnergia = (offerData && offerData.p1_price) ? offerData.p1_price : 0;
                        const costoEnergia = kwh * precioEnergia;
                        doc.text(tr('Energia') + ` (${kwh} kWh x ${precioEnergia.toFixed(6)} EUR/kWh)`, margin + 5, yPos + 4);
                        doc.setFont('helvetica', 'bold');
                        doc.text(eur(costoEnergia), pageWidth - margin - 5, yPos + 4, { align: 'right' });
                        yPos += 8;
                    }
                    
                    // TOTAL DEL PERIODO
                    doc.setFillColor(...grisClaro);
                    doc.rect(margin, yPos, contentWidth, 10, 'F');
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont('helvetica', 'bold');
                    
                    // Usar breakdown ya declarado al inicio del forEach
                    const dias = (breakdown && breakdown.dias) || supply.dias || supply.days || 30;
                    doc.text(tr('TOTAL') + ` (${dias} ` + tr('DIAS') + `):`, margin + 5, yPos + 6.5);
                    
                    // Obtener total segÃºn tipo
                    let total = 0;
                    if (supply.type === 'electricidad') {
                        total = (breakdown && breakdown.totalPeriod) || supply.totalPeriod || supply.total || 0;
                    } else {
                        // Para gas, el campo se llama 'total', no 'totalPeriod'
                        total = (breakdown && breakdown.total) || supply.total || supply.totalPeriod || 0;
                    }
                    
                    doc.text(eur(total), pageWidth - margin - 5, yPos + 6.5, { align: 'right' });
                    
                    yPos += 12;
                    
                    // AHORRO
                    doc.setFillColor(254, 226, 226);
                    doc.rect(margin, yPos, contentWidth, 10, 'F');
                    
                    doc.setTextColor(...rojoFuerte);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    const ahorro = (breakdown && breakdown.ahorro_anual) || 0;
                    doc.text(tr('AHORRO:') + `: ${eur(ahorro)}`, pageWidth / 2, yPos + 7, { align: 'center' });
                    
                    yPos += 16;
                });
                
                // ULTIMA PAGINA: AHORRO Y CONTRATACION
                
                if (yPos > 200) {
                    doc.addPage();
                    yPos = 20;
                }
                
                yPos += 10;
                
                // CAJA DE AHORRO TOTAL - Color segÃºn marca
                if (isDrk) {
                    doc.setFillColor(41, 128, 185); // Azul DRK
                } else {
                    doc.setFillColor(133, 146, 104); // Verde oliva POWER CUP
                }
                doc.roundedRect(margin, yPos, contentWidth, 50, 3, 3, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('TU AHORRO ANUAL TOTAL'), pageWidth / 2, yPos + 14, { align: 'center' });
                
                doc.setFontSize(36);
                doc.text(num(results.totalSavings || 0, 2) + ' EUR', pageWidth / 2, yPos + 32, { align: 'center' });
                
                const ahorroMensual = (results.totalSavings || 0) / 12;
                doc.setFontSize(13);
                doc.text(tr('AHORRA ') + num(ahorroMensual, 2) + tr(' EUR CADA MES'), pageWidth / 2, yPos + 44, { align: 'center' });
                
                yPos += 58;
                
                // INSTRUCCIONES DE CONTRATACION
                doc.setFillColor(...grisOscuro);
                doc.rect(margin, yPos, contentWidth, 12, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('PARA FORMALIZAR ESTE CONTRATO:'), margin + 5, yPos + 8);
                
                yPos += 14;
                
                const docsHeight = 75;
                doc.setFillColor(...grisClaro);
                doc.rect(margin, yPos, contentWidth, docsHeight, 'F');
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.5);
                doc.rect(margin, yPos, contentWidth, docsHeight, 'S');
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text(tr('Responde a este email adjuntando la documentacion de los ') + dualSupplies.length + tr(' CUPS:'), margin + 5, yPos + 7);
                
                yPos += 12;
                
                const docs = [
                    tr('1. Foto del DNI/CIF (anverso y reverso)'),
                    tr('2. Ultima factura (menos de 3 meses de antiguedad)'),
                    tr('3. Autorizacion de cambio de titular (si aplica)'),
                    tr('4. Telefono de contacto'),
                    tr('5. Numero de cuenta bancaria (IBAN)')
                ];
                
                docs.forEach(docItem => {
                    doc.setFontSize(9);
                    doc.text(docItem, margin + 10, yPos);
                    yPos += 7;
                });
                
                yPos += 6;
                
                doc.setFillColor(...grisOscuro);
                doc.rect(margin + 10, yPos, contentWidth - 20, 12, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(tr('Envia la documentacion al comercial:') + comercialCode, pageWidth / 2, yPos + 8, { align: 'center' });
                
                // PIE DE PAGINA
                doc.setFontSize(7);
                doc.setTextColor(100, 116, 139);
                doc.setFont('helvetica', 'italic');
                doc.text(tr('Documento generado el ') + new Date().toLocaleDateString('es-ES'), margin, 285);
                doc.text(brandName + tr(' Energia - Comparativa Profesional'), pageWidth - margin, 285, { align: 'right' });
                
                // GUARDAR
                const filename = `Comparativa_DUAL_${comercialCode}_${new Date().toISOString().slice(0,10)}.pdf`;
                doc.save(filename);
                
                console.log(tr('PDF DUAL generado correctamente'));
                window.showMessageModal("PDF generado correctamente - Revisa tu carpeta de descargas");
                
            } catch (error) {
                console.error(tr('Error al generar PDF DUAL:'), error);
                alert(tr('Error al generar el PDF: ') + error.message);
            }
            
            if (wasChineseMode) {
                setTimeout(() => {
                    console.log(tr('Restaurando idioma chino'));
                    window.LANG.change('zh', true);
                }, 500);
            }
        }
        
        function showDualConfirm(type, tariff, data, results) {
            // DEPRECATED: Esta funciÃ³n ya no deberÃ­a usarse en modo DUAL
            // Si se llama, es porque falta aÃ±adir el otro tipo de suministro
            console.error('âš ï¸ showDualConfirm fue llamada incorrectamente');
            console.error('Esta funciÃ³n estÃ¡ obsoleta para modo DUAL');
            window.showErrorModal(
                'Esta funcionalidad ya no estÃ¡ disponible.\n\n' +
                'Por favor, aÃ±ade tanto ELECTRICIDAD como GAS antes de calcular.',
                'âš ï¸ FunciÃ³n obsoleta'
            );
            return;
            
            // CÃ³digo antiguo comentado (por si se necesita en el futuro)
            /*
            console.log('=== showDualConfirm ===');
            console.log('Type:', type);
            console.log('Tariff:', tariff);
            console.log('Data:', data);
            console.log('Results:', results);
            
            // Guardar datos temporalmente
            dualTempSupply = { type, tariff, data, results };
            
            // Actualizar UI
            const formatEuro = (val) => val.toFixed(2).replace('.', ',') + ' â‚¬';
            
            document.getElementById('dual-confirm-icon').textContent = type === 'electricidad' ? 'âš¡' : 'ðŸ”¥';
            document.getElementById('dual-confirm-type').textContent = type === 'electricidad' ? 'Electricidad' : 'Gas';
            document.getElementById('dual-confirm-tariff').textContent = tariff;
            
            let totalKwh = 0;
            if (type === 'electricidad') {
                totalKwh = (parseFloat(data.kwh_p1) || 0) + 
                          (parseFloat(data.kwh_p2) || 0) + 
                          (parseFloat(data.kwh_p3) || 0) + 
                          (parseFloat(data.kwh_p4) || 0) + 
                          (parseFloat(data.kwh_p5) || 0) + 
                          (parseFloat(data.kwh_p6) || 0);
                console.log('Total kWh electricidad:', totalKwh);
            } else {
                totalKwh = parseFloat(data.kwh) || 0;
                console.log('Total kWh gas:', totalKwh);
            }
            
            document.getElementById('dual-confirm-consumption').textContent = totalKwh.toFixed(0) + ' kWh';
            document.getElementById('dual-confirm-days').textContent = data.dias + ' dÃ­as';
            document.getElementById('dual-confirm-drk').textContent = formatEuro(results.drk.total_anual);
            document.getElementById('dual-confirm-powercup').textContent = formatEuro(results.powercup.total_anual);
            
            // NUEVO: Calcular y mostrar el ahorro anual estimado
            // El mejor coste es el menor entre DRK y PowerCup (o solo DRK si PowerCup es 0)
            let mejorCoste = results.drk.total_anual;
            if (results.powercup.total_anual > 0 && results.powercup.total_anual < mejorCoste) {
                mejorCoste = results.powercup.total_anual;
            }
            
            // Buscar la factura actual del cliente
            // Puede venir de mÃºltiples lugares segÃºn el flujo
            let facturaActual = 0;
            
            if (data.originalBillAnnual) {
                facturaActual = parseFloat(data.originalBillAnnual);
            } else if (data.factura_actual_anual) {
                facturaActual = parseFloat(data.factura_actual_anual);
            } else if (results.originalBillAnnual) {
                facturaActual = parseFloat(results.originalBillAnnual);
            } else if (lastComparisonResult && lastComparisonResult.originalBillAnnual) {
                facturaActual = parseFloat(lastComparisonResult.originalBillAnnual);
            }
            
            const ahorroAnual = facturaActual - mejorCoste;
            
            console.log('CÃ¡lculo de ahorro:');
            console.log('- Factura actual anual:', facturaActual);
            console.log('- Mejor coste DRK/PowerCup:', mejorCoste);
            console.log('- Ahorro anual:', ahorroAnual);
            
            // Mostrar ahorro (puede ser negativo si no hay ahorro)
            if (ahorroAnual > 0) {
                document.getElementById('dual-confirm-savings').textContent = formatEuro(ahorroAnual);
                document.getElementById('dual-confirm-savings').classList.remove('text-red-600');
                document.getElementById('dual-confirm-savings').classList.add('text-green-600');
            } else if (ahorroAnual < 0) {
                document.getElementById('dual-confirm-savings').textContent = formatEuro(Math.abs(ahorroAnual)) + ' mÃ¡s';
                document.getElementById('dual-confirm-savings').classList.remove('text-green-600');
                document.getElementById('dual-confirm-savings').classList.add('text-red-600');
            } else {
                document.getElementById('dual-confirm-savings').textContent = '0,00 â‚¬';
            }
            
            // CRÃTICO: Ocultar TODAS las pantallas y vistas
            hideAllScreens();
            
            // Ocultar tambiÃ©n las vistas internas de electricidad
            document.getElementById('landing-view')?.classList.add('hidden');
            document.getElementById('initial-view')?.classList.add('hidden');
            document.getElementById('scanner-view')?.classList.add('hidden');
            document.getElementById('results-view')?.classList.add('hidden');
            document.getElementById('multicups-saga-view')?.classList.add('hidden');
            
            // Ocultar modal de decisiÃ³n si estÃ¡ abierto
            const decisionModal = document.getElementById('offer-decision-modal');
            if (decisionModal) {
                decisionModal.classList.remove('flex');
                decisionModal.classList.add('hidden');
                decisionModal.style.display = 'none'; // Forzar tambiÃ©n con style
                console.log('Modal de decisiÃ³n FORZADO a oculto');
            }
            
            // Mostrar pantalla de confirmaciÃ³n DUAL
            document.getElementById('screen-dual-confirm').classList.add('active');
            
            // CRÃTICO: Usar setTimeout para asegurar que el modal se oculte DESPUÃ‰S de cualquier cÃ³digo asÃ­ncrono
            setTimeout(() => {
                const modal = document.getElementById('offer-decision-modal');
                if (modal) {
                    modal.classList.remove('flex');
                    modal.classList.add('hidden');
                    modal.style.display = 'none';
                    console.log('Modal ocultado con setTimeout');
                }
            }, 50);
            
            console.log('Pantalla de confirmaciÃ³n DUAL mostrada');
            */
        }
        
        // FunciÃ³n: Confirmar y aÃ±adir a DUAL
        function dualConfirmAdd() {
            if (!dualTempSupply) {
                alert('Error: No hay datos para aÃ±adir');
                return;
            }
            
            const { type, tariff, data, results } = dualTempSupply;
            window.dualAddFromResults(type, tariff, data, results);
            
            // Limpiar temporal
            dualTempSupply = null;
        }
        
        // FunciÃ³n: Cancelar y volver al gestor
        function dualCancelAdd() {
            dualTempSupply = null;
            backToDualManager();
        }
        
        // FunciÃ³n: Confirmar y enviar email
        
        // FunciÃ³n auxiliar: AÃ±adir suministro desde resultados
        window.dualAddFromResults = function(type, tariff, data, results, finalResult = null) {
            console.log('=== dualAddFromResults ===');
            console.log('Type:', type);
            console.log('Tariff:', tariff);
            console.log('Data:', data);
            console.log('Results:', results);
            console.log('FinalResult:', finalResult);
            console.log('Results.drk.total_anual:', results.drk.total_anual);
            console.log('Results.powercup.total_anual:', results.powercup.total_anual);
            
            if (results.drk.total_anual === 0 && results.powercup.total_anual === 0) {
                console.error('âš ï¸âš ï¸âš ï¸ PROBLEMA: Ambos costes son 0 al aÃ±adir suministro');
                console.error('Results completo:', JSON.stringify(results, null, 2));
            }
            
            // NUEVO: Guardar finalResult para usarlo al procesar
            window.pendingDualFinalResult = finalResult;
            
            // NUEVO: Solicitar direcciÃ³n del suministro antes de aÃ±adir
            console.log('ðŸŸ¢ Llamando a window.showDualSupplyAddressModal...');
            window.showDualSupplyAddressModal(type, tariff, data, results);
            console.log('ðŸŸ¢ window.showDualSupplyAddressModal deberÃ­a haberse ejecutado');
        };
        
        // FunciÃ³n: AÃ±adir resultado actual a DUAL
        window.addCurrentToDual = function() {
            console.log('=== AÃ‘ADIENDO A DUAL ===');
            console.log('lastComparisonResult:', window.lastComparisonResult);
            console.log('gasCalculationParams:', window.gasCalculationParams);
            
            let type, tariff, data, results;
            
            // Intentar detectar si es electricidad
            if (window.lastComparisonResult) {
                const result = window.lastComparisonResult;
                console.log('Tipo de resultado:', result);
                
                // Es electricidad
                type = 'electricidad';
                tariff = result.tariffType || currentTariffType || '2.0TD';
                
                // Construir data desde lastComparisonResult
                data = {
                    tariff: tariff,
                    kwh_p1: parseFloat(result.kwh_p1) || 0,
                    kwh_p2: parseFloat(result.kwh_p2) || 0,
                    kwh_p3: parseFloat(result.kwh_p3) || 0,
                    kwh_p4: parseFloat(result.kwh_p4) || 0,
                    kwh_p5: parseFloat(result.kwh_p5) || 0,
                    kwh_p6: parseFloat(result.kwh_p6) || 0,
                    p1: parseFloat(result.p1) || 0,
                    p2: parseFloat(result.p2) || 0,
                    p3: parseFloat(result.p3) || 0,
                    p4: parseFloat(result.p4) || 0,
                    p5: parseFloat(result.p5) || 0,
                    p6: parseFloat(result.p6) || 0,
                    dias: parseInt(result.dias) || 30
                };
                
                console.log('Data construida:', data);
                
                // Construir results
                let drkCost = 0;
                let powercupCost = 0;
                
                // Intentar obtener costos de diferentes fuentes
                if (result.bestOffer) {
                    drkCost = parseFloat(result.bestOffer.annual_cost) || parseFloat(result.bestOffer.total_cost_period) * 12 || 0;
                    console.log('DRK cost from bestOffer:', drkCost);
                }
                
                if (result.indexedResult) {
                    powercupCost = parseFloat(result.indexedResult.annual_cost) || parseFloat(result.indexedResult.total_cost_period) * 12 || 0;
                    console.log('PowerCup cost from indexedResult:', powercupCost);
                }
                
                // Si no hay costos, intentar calcular desde aggregatedData
                if (drkCost === 0 && result.aggregatedData) {
                    drkCost = parseFloat(result.aggregatedData.total_anual_drk) || 0;
                    console.log('DRK cost from aggregatedData:', drkCost);
                }
                
                if (powercupCost === 0 && result.aggregatedData) {
                    powercupCost = parseFloat(result.aggregatedData.total_anual_powercup) || 0;
                    console.log('PowerCup cost from aggregatedData:', powercupCost);
                }
                
                // Si aÃºn no hay costos, usar offer directamente
                if (drkCost === 0 && result.offer) {
                    drkCost = parseFloat(result.offer.annual_cost) || 0;
                    console.log('DRK cost from offer:', drkCost);
                }
                
                results = {
                    drk: {
                        total: drkCost / 12,
                        total_anual: drkCost
                    },
                    powercup: {
                        total: powercupCost / 12,
                        total_anual: powercupCost
                    }
                };
                
                console.log('Results construidos:', results);
                
            } else if (window.gasCalculationParams && window.gasCalculationParams.kwh) {
                // Es gas
                type = 'gas';
                tariff = currentGasTariff;
                data = window.gasCalculationParams;
                
                console.log('Es GAS - data:', data);
                
                // Obtener resultados de gas desde las variables globales
                results = {
                    drk: window.lastGasDRKResult || { total: 0, total_anual: 0 },
                    powercup: window.lastGasPowerCupResult || { total: 0, total_anual: 0 }
                };
                
                console.log('Results de gas:', results);
            } else {
                console.error('No se pudo determinar el tipo de suministro');
                alert('âŒ No se pudo determinar el tipo de suministro. Por favor, calcula primero una comparativa.');
                return;
            }
            
            // Validar que tenemos datos vÃ¡lidos
            if (results.drk.total_anual === 0 && results.powercup.total_anual === 0) {
                console.error('No hay costos vÃ¡lidos para aÃ±adir');
                alert('âŒ No se pudieron obtener los costos. Por favor, calcula primero una comparativa.');
                return;
            }
            
            console.log('AÃ±adiendo suministro:', { type, tariff, data, results });
            window.dualAddFromResults(type, tariff, data, results);
        };
        
        // FunciÃ³n especÃ­fica para aÃ±adir gas a DUAL
        window.addCurrentGasToDual = function() {
            if (!window.gasCalculationParams || !window.gasCalculationParams.kwh) {
                alert('No hay datos de gas para aÃ±adir');
                return;
            }
            
            const type = 'gas';
            const tariff = currentGasTariff;
            const data = window.gasCalculationParams;
            
            // Obtener resultados de gas desde las variables globales
            const results = {
                drk: window.lastGasDRKResult || { total: 0, total_anual: 0 },
                powercup: window.lastGasPowerCupResult || { total: 0, total_anual: 0 }
            };
            
            window.dualAddFromResults(type, tariff, data, results);
        };
        
        // FunciÃ³n: Detectar y mostrar botÃ³n DUAL si estamos en modo DUAL
        window.checkDualMode = function() {
            const dualBtn = document.getElementById('add-to-dual-btn');
            if (dualBtn) {
                if (window.dualMode === true) {
                    dualBtn.style.display = 'flex';
                } else {
                    dualBtn.style.display = 'none';
                }
            }
            
            // Para gas
            const gasDualContainer = document.getElementById('gas-dual-button-container');
            if (gasDualContainer) {
                if (window.dualMode === true) {
                    gasDualContainer.style.display = 'block';
                } else {
                    gasDualContainer.style.display = 'none';
                }
            }
        };
        
        // FIN FUNCIONES MÃ“DULO DUAL
        
        // ===== CALCULADOR DE GAS =====
        
        // Variables globales para GAS
        let currentGasTariff = '';
        let gasTariffsData = [];
        let gasCalculationParams = {}; // Guardar parÃ¡metros de cÃ¡lculo
        const GAS_SHEET_ID = '1P_OSzj-sqDgT7_3KAdp7Y6ySA3ytsFHQKFvfZjAjsjE';
        
        // FunciÃ³n: Actualizar UI segÃºn modo de selecciÃ³n
        function updateGasSelectionUI() {
            const selectionMode = document.querySelector('input[name="gas-selection-mode"]:checked').value;
            const compareChecked = document.getElementById('gas-compare-indexed-fixed').checked;
            const typeButtons = document.getElementById('gas-type-buttons');
            const calculateBtn = document.getElementById('gas-calculate-btn');
            const bestDescription = document.getElementById('gas-best-description');
            
            if (selectionMode === 'best') {
                // Modo "Mejores tarifas"
                if (compareChecked) {
                    // Comparar indexada vs fija: mostrar botÃ³n calcular
                    typeButtons.style.display = 'none';
                    calculateBtn.style.display = 'block'; // MOSTRAR el botÃ³n
                    calculateBtn.textContent = 'Calcular';
                    bestDescription.textContent = 'CompararÃ¡ automÃ¡ticamente la mejor tarifa indexada DRK vs la mejor tarifa fija DRK.';
                } else {
                    // Usuario elige tipo: mostrar botones
                    typeButtons.style.display = 'block';
                    calculateBtn.style.display = 'none'; // Ocultar botÃ³n principal
                    bestDescription.textContent = 'Elige si quieres ver la mejor tarifa fija o indexada.';
                }
            } else {
                // Modo "Elegir entre resultados"
                typeButtons.style.display = 'none';
                calculateBtn.style.display = 'block';
                calculateBtn.textContent = 'Ver tarifas disponibles';
            }
        }
        
        // FunciÃ³n: Toggle modo de comparaciÃ³n
        function toggleGasComparisonMode() {
            updateGasSelectionUI();
        }
        
        // FunciÃ³n: Calcular con tipo especÃ­fico (fija o indexada)
        function calculateGasWithType(type) {
            // Validar inputs
            const cups = document.getElementById('gas-cups').value.trim();
            const dias = parseFloat(document.getElementById('gas-dias').value);
            const kwh = parseFloat(document.getElementById('gas-kwh').value);
            const totalCliente = parseFloat(document.getElementById('gas-total-cliente').value);
            
            if (!dias || !kwh || !totalCliente) {
                alert(tr('Por favor, completa todos los campos'));
                return;
            }
            
            if (dias <= 0 || kwh <= 0 || totalCliente <= 0) {
                alert('Los valores deben ser mayores a 0');
                return;
            }
            
            // Guardar parÃ¡metros (CRÃTICO: tambiÃ©n en window para modo DUAL)
            gasCalculationParams = { cups, dias, kwh, totalCliente, type, mode: 'best' };
            window.gasCalculationParams = gasCalculationParams;
            console.log('âœ… gasCalculationParams guardado en window:', window.gasCalculationParams);
            
            // Cerrar modal y calcular
            closeGasModal();
            performGasCalculation();
        }
        
        // FunciÃ³n: Proceder a cÃ¡lculo segÃºn configuraciÃ³n
        function proceedToGasCalculation() {
            // Validar inputs
            const cups = document.getElementById('gas-cups').value.trim();
            const dias = parseFloat(document.getElementById('gas-dias').value);
            const kwh = parseFloat(document.getElementById('gas-kwh').value);
            const totalCliente = parseFloat(document.getElementById('gas-total-cliente').value);
            
            if (!dias || !kwh || !totalCliente) {
                alert(tr('Por favor, completa todos los campos'));
                return;
            }
            
            if (dias <= 0 || kwh <= 0 || totalCliente <= 0) {
                alert('Los valores deben ser mayores a 0');
                return;
            }
            
            const selectionMode = document.querySelector('input[name="gas-selection-mode"]:checked').value;
            const compareChecked = document.getElementById('gas-compare-indexed-fixed').checked;
            
            // Guardar parÃ¡metros (CRÃTICO: tambiÃ©n en window para modo DUAL)
            gasCalculationParams = {
                cups,
                dias,
                kwh,
                totalCliente,
                mode: selectionMode,
                compareIndexedVsFixed: compareChecked
            };
            window.gasCalculationParams = gasCalculationParams;
            console.log('âœ… gasCalculationParams guardado en window:', window.gasCalculationParams);
            
            // Cerrar modal
            closeGasModal();
            
            if (selectionMode === 'best') {
                // Modo "Mejores tarifas"
                if (compareChecked) {
                    // Comparar indexada vs fija automÃ¡ticamente
                    performGasCalculation();
                }
            } else {
                // Modo "Elegir entre resultados" - mostrar selector de tarifas
                showGasTariffSelector();
            }
        }
        
        // FunciÃ³n: Realizar cÃ¡lculo de GAS
        function performGasCalculation() {
            const { dias, kwh, totalCliente, type, mode, compareIndexedVsFixed } = gasCalculationParams;
            const comparisonMode = document.querySelector('input[name="comparison_mode"]:checked').value;
            
            // Convertir RL1 â†’ RL.1 para buscar en el Excel
            const searchTariff = currentGasTariff.replace(/RL(\d)/, 'RL.$1');
            
            console.log(`ðŸ” Buscando tarifa: ${currentGasTariff} â†’ ${searchTariff}`);
            console.log(`ðŸ“‹ Modo: ${mode}, Tipo: ${type || 'auto'}, Comparar: ${compareIndexedVsFixed}`);
            
            // Buscar en la columna "Tarifa"
            let filteredTariffs = gasTariffsData.filter(t => {
                const tariffValue = (t.Tarifa || '').trim().toUpperCase();
                const searchValue = searchTariff.toUpperCase();
                return tariffValue === searchValue;
            });
            
            console.log(`ðŸ“Š Tarifas encontradas para ${searchTariff}: ${filteredTariffs.length}`);
            
            // Aplicar filtro DRK si corresponde
            if (comparisonMode === 'drk_only' || comparisonMode === 'drk_prioritized') {
                filteredTariffs = filteredTariffs.filter(t => {
                    const name = (t.name || t.Name || '').toLowerCase();
                    return name.includes('drk') || name.includes('direct');
                });
                console.log(`ðŸ“Š DespuÃ©s de filtro DRK: ${filteredTariffs.length}`);
            }
            
            if (filteredTariffs.length === 0) {
                alert(`No se encontraron tarifas DRK para ${searchTariff}`);
                return;
            }
            
            let results = [];
            
            if (compareIndexedVsFixed) {
                // MODO: Comparar Indexada vs Fija
                // Indexada = name contiene "INDEX" o "DRK INDEX"
                // Fija = name NO contiene "INDEX" o description contiene "FIJO"/"FIJA"
                const indexedTariffs = filteredTariffs.filter(t => {
                    const name = (t.name || t.Name || '').toUpperCase();
                    return name.includes('INDEX');
                });
                
                const fixedTariffs = filteredTariffs.filter(t => {
                    const name = (t.name || t.Name || '').toUpperCase();
                    const desc = (t.description || t.Description || '').toUpperCase();
                    // Es FIJA si NO tiene INDEX en name, o si tiene FIJO/FIJA en descripciÃ³n
                    return !name.includes('INDEX') || desc.includes('FIJO') || desc.includes('FIJA');
                });
                
                console.log(`ðŸŸ  Indexadas: ${indexedTariffs.length}, ðŸ”µ Fijas: ${fixedTariffs.length}`);
                
                // Encontrar mejor indexada (normalmente solo hay 1 DRK INDEX por categorÃ­a)
                if (indexedTariffs.length > 0) {
                    const bestIndexed = indexedTariffs[0]; // Primera DRK INDEX
                    results.push(calculateGasTariff(bestIndexed, dias, kwh, totalCliente));
                }
                
                // Encontrar mejor fija
                if (fixedTariffs.length > 0) {
                    const calculatedFixed = fixedTariffs.map(t => calculateGasTariff(t, dias, kwh, totalCliente));
                    const bestFixed = calculatedFixed.sort((a, b) => b.ahorro_anual - a.ahorro_anual)[0];
                    results.push(bestFixed);
                }
                
            } else if (mode === 'best' && type) {
                // MODO: Mejores tarifas - Usuario eligiÃ³ Fija o Indexada
                let targetTariffs;
                
                if (type === 'fija') {
                    // Buscar FIJAS: name NO contiene INDEX, o description contiene FIJO
                    targetTariffs = filteredTariffs.filter(t => {
                        const name = (t.name || t.Name || '').toUpperCase();
                        const desc = (t.description || t.Description || '').toUpperCase();
                        return !name.includes('INDEX') || desc.includes('FIJO') || desc.includes('FIJA');
                    });
                } else {
                    // Buscar INDEXADAS: name contiene INDEX
                    targetTariffs = filteredTariffs.filter(t => {
                        const name = (t.name || t.Name || '').toUpperCase();
                        return name.includes('INDEX');
                    });
                }
                
                console.log(`ðŸ“Š Tarifas ${type}: ${targetTariffs.length}`);
                
                if (targetTariffs.length === 0) {
                    alert(`No se encontraron tarifas ${type} para esta categorÃ­a`);
                    return;
                }
                
                // Calcular todas y encontrar la mejor
                const calculated = targetTariffs.map(t => calculateGasTariff(t, dias, kwh, totalCliente));
                const best = calculated.sort((a, b) => b.ahorro_anual - a.ahorro_anual)[0];
                results = [best];
            }
            
            if (results.length === 0) {
                alert('No se pudieron calcular resultados');
                return;
            }
            
            // Mostrar resultados
            showGasResults(results, dias, kwh, totalCliente);
        }
        
        // FunciÃ³n: Seleccionar tarifa de GAS y abrir modal
        function selectGasTariff(tariff) {
            currentGasTariff = tariff;
            // Mostrar con formato correcto (Rl1 en lugar de RL1)
            const displayTariff = tariff.charAt(0).toUpperCase() + tariff.charAt(1).toLowerCase() + tariff.slice(2);
            document.getElementById('gas-selected-tariff').textContent = displayTariff;
            
            // Resetear formulario
            document.getElementById('gas-cups').value = '';
            document.getElementById('gas-dias').value = '';
            document.getElementById('gas-kwh').value = '';
            document.getElementById('gas-total-cliente').value = '';
            document.getElementById('gas-compare-indexed-fixed').checked = false;
            document.querySelector('input[name="gas-selection-mode"][value="best"]').checked = true;
            
            // Actualizar UI
            updateGasSelectionUI();
            
            // CRÃTICO: Verificar modo DUAL para ocultar/mostrar botÃ³n DUAL
            if (window.checkDualMode) {
                window.checkDualMode();
            }
            
            // NUEVO: Ocultar checkbox de comparaciÃ³n indexada si estÃ¡ en modo DUAL
            const gasIndexedSection = document.getElementById('gas-indexed-comparison-section');
            if (window.dualMode === true && gasIndexedSection) {
                console.log('ðŸ”„ Modo DUAL en Gas: Ocultando checkbox de comparaciÃ³n indexada');
                gasIndexedSection.classList.add('hidden');
                // Asegurar que el checkbox estÃ© desmarcado
                document.getElementById('gas-compare-indexed-fixed').checked = false;
            } else if (gasIndexedSection) {
                // Mostrar la secciÃ³n si NO es modo DUAL
                gasIndexedSection.classList.remove('hidden');
            }
            
            // Mostrar modal
            document.getElementById('gas-manual-input-modal').classList.remove('hidden');
            document.getElementById('gas-manual-input-modal').classList.add('flex');
            
            // Cargar datos si no estÃ¡n cargados
            if (gasTariffsData.length === 0) {
                loadGasData();
            }
            
            console.log(`ðŸ“‹ Tarifa seleccionada: ${tariff} (buscarÃ¡: ${tariff.toLowerCase()})`);
            console.log(`ðŸ” Modo DUAL: ${window.dualMode}`);
        }
        
        // FunciÃ³n: Mostrar selector de tarifas manual
        function showGasTariffSelector() {
            const { dias, kwh, totalCliente, compareIndexedVsFixed } = gasCalculationParams;
            const comparisonMode = document.querySelector('input[name="comparison_mode"]:checked').value;
            const searchTariff = currentGasTariff.replace(/RL(\d)/, 'RL.$1');
            
            // Filtrar tarifas disponibles
            let filteredTariffs = gasTariffsData.filter(t => {
                const tariffValue = (t.Tarifa || '').trim().toUpperCase();
                return tariffValue === searchTariff.toUpperCase();
            });
            
            // Aplicar filtro DRK si corresponde
            if (comparisonMode === 'drk_only' || comparisonMode === 'drk_prioritized') {
                filteredTariffs = filteredTariffs.filter(t => {
                    const name = (t.name || t.Name || '').toLowerCase();
                    return name.includes('drk') || name.includes('direct');
                });
            }
            
            // Si comparar indexada vs fija, solo mostrar FIJAS para selecciÃ³n manual
            if (compareIndexedVsFixed) {
                filteredTariffs = filteredTariffs.filter(t => {
                    const name = (t.name || t.Name || '').toUpperCase();
                    const desc = (t.description || t.Description || '').toUpperCase();
                    // Es FIJA si NO tiene INDEX en name, o si tiene FIJO/FIJA en descripciÃ³n
                    return !name.includes('INDEX') || desc.includes('FIJO') || desc.includes('FIJA');
                });
            }
            
            if (filteredTariffs.length === 0) {
                alert('No hay tarifas disponibles para selecciÃ³n manual');
                return;
            }
            
            // CALCULAR TODAS LAS TARIFAS PARA MOSTRAR AHORRO
            const calculatedTariffs = filteredTariffs.map(tariff => {
                const result = calculateGasTariff(tariff, dias, kwh, totalCliente);
                return {
                    tariff: tariff,
                    calculation: result,
                    name: tariff.name || tariff.Name,
                    description: tariff.description || tariff.Description || (tariff.name || tariff.Name),
                    isIndexed: (tariff.name || tariff.Name || '').toUpperCase().includes('INDEX'),
                    ahorro: result.ahorro_anual
                };
            });
            
            console.log(`ðŸ’° Tarifas calculadas: ${calculatedTariffs.length}`);
            
            // Guardar para usar en ordenamiento
            window.gasCalculatedTariffs = calculatedTariffs;
            
            // Renderizar UI con ordenamiento por defecto (mayor ahorro)
            renderGasTariffSelector('ahorro-desc');
            
            // Mostrar pantalla de resultados
            hideAllScreens();
            document.getElementById('screen-gas-results').classList.add('active');
            
            // NO mostrar botÃ³n DUAL aquÃ­ - esta es la pantalla de selecciÃ³n manual
            // Ocultar explÃ­citamente el botÃ³n DUAL
            const gasDualContainer = document.getElementById('gas-dual-button-container');
            if (gasDualContainer) {
                gasDualContainer.style.display = 'none';
            }
        }
        
        // FunciÃ³n: Renderizar selector de tarifas con ordenamiento
        function renderGasTariffSelector(sortBy = 'ahorro-desc') {
            const calculatedTariffs = window.gasCalculatedTariffs;
            const compareIndexedVsFixed = gasCalculationParams.compareIndexedVsFixed;
            
            // Ordenar segÃºn criterio
            let sortedTariffs = [...calculatedTariffs];
            
            if (sortBy === 'ahorro-desc') {
                sortedTariffs.sort((a, b) => b.ahorro - a.ahorro);
            } else if (sortBy === 'ahorro-asc') {
                sortedTariffs.sort((a, b) => a.ahorro - b.ahorro);
            } else if (sortBy === 'nombre') {
                sortedTariffs.sort((a, b) => a.name.localeCompare(b.name));
            }
            
            // Crear UI de selecciÃ³n
            const container = document.getElementById('gas-results-container');
            let html = `
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-drk-900 mb-4">Selecciona las tarifas a comparar:</h3>
                    <p class="text-sm text-slate-600 mb-4">
                        ${compareIndexedVsFixed ? 'La tarifa indexada DRK se compararÃ¡ automÃ¡ticamente con las tarifas fijas que selecciones.' : 'Selecciona una o mÃ¡s tarifas para comparar.'}
                    </p>
                    
                    <!-- Buscador de texto -->
                    <div class="mb-4 p-4 bg-slate-50 rounded-lg">
                        <label class="block text-sm font-bold text-slate-700 mb-2">ðŸ” Buscar comercializadora:</label>
                        <div class="flex gap-2">
                            <input 
                                type="text" 
                                id="gas-search-input"
                                placeholder="Escribe el nombre de la comercializadora..."
                                onkeyup="applyGasSearch()"
                                class="flex-1 px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-red-500 focus:outline-none"
                            >
                            <button 
                                onclick="clearGasSearch()"
                                class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-bold hover:bg-slate-300 transition"
                                title="Limpiar bÃºsqueda"
                            >
                                âœ•
                            </button>
                        </div>
                        <p class="text-xs text-slate-500 mt-2" id="gas-search-count"></p>
                    </div>
                    
                    <!-- Filtros de ordenamiento -->
                    <div class="mb-4 p-4 bg-slate-50 rounded-lg">
                        <label class="block text-sm font-bold text-slate-700 mb-2">Ordenar por:</label>
                        <div class="flex gap-2 flex-wrap">
                            <button 
                                onclick="renderGasTariffSelector('ahorro-desc')"
                                class="px-4 py-2 rounded-lg text-sm font-bold transition ${sortBy === 'ahorro-desc' ? 'bg-green-500 text-white' : 'bg-white text-slate-700 border-2 border-slate-200 hover:border-green-300'}"
                            >
                                ðŸ’° Mayor ahorro primero
                            </button>
                            <button 
                                onclick="renderGasTariffSelector('ahorro-asc')"
                                class="px-4 py-2 rounded-lg text-sm font-bold transition ${sortBy === 'ahorro-asc' ? 'bg-red-500 text-white' : 'bg-white text-slate-700 border-2 border-slate-200 hover:border-red-300'}"
                            >
                                ðŸ“‰ Menor ahorro primero
                            </button>
                            <button 
                                onclick="renderGasTariffSelector('nombre')"
                                class="px-4 py-2 rounded-lg text-sm font-bold transition ${sortBy === 'nombre' ? 'bg-blue-500 text-white' : 'bg-white text-slate-700 border-2 border-slate-200 hover:border-blue-300'}"
                            >
                                ðŸ”¤ Por nombre
                            </button>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
            `;
            
            sortedTariffs.forEach((item, index) => {
                const typeLabel = item.isIndexed ? 'ðŸŸ  INDEXADA' : 'ðŸ”µ FIJA';
                const ahorroAnual = item.ahorro;
                const isPositive = ahorroAnual > 0;
                const ahorroClass = isPositive ? 'text-green-600' : 'text-red-600';
                const ahorroSign = isPositive ? '+' : '';
                
                html += `
                    <label class="flex items-center gap-3 p-4 border-2 ${isPositive ? 'border-green-200 bg-green-50' : 'border-slate-200'} rounded-lg hover:border-red-300 cursor-pointer transition">
                        <input 
                            type="checkbox" 
                            class="gas-tariff-checkbox w-5 h-5 text-red-600 rounded flex-shrink-0"
                            data-index="${index}"
                        >
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-drk-900">${item.name}</span>
                                <span class="text-xs px-2 py-1 rounded ${item.isIndexed ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}">${typeLabel}</span>
                            </div>
                            <p class="text-sm text-slate-600">${item.description}</p>
                        </div>
                        <div class="flex flex-col items-end text-right flex-shrink-0 ml-2">
                            <span class="text-xs text-slate-500 font-semibold">Ahorro anual:</span>
                            <span class="text-lg font-black ${ahorroClass}">${ahorroSign}${ahorroAnual.toFixed(2)}â‚¬</span>
                        </div>
                    </label>
                `;
            });
            
            html += `
                    </div>
                    
                    <button 
                        onclick="calculateSelectedGasTariffs()"
                        class="w-full mt-6 px-6 py-3 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600 transition"
                    >
                        Calcular tarifas seleccionadas
                    </button>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Ocultar botÃ³n DUAL en selector manual
            const gasDualContainer = document.getElementById('gas-dual-button-container');
            if (gasDualContainer) {
                gasDualContainer.style.display = 'none';
            }
            
            // Guardar ordenamiento actual
            window.gasSortedTariffs = sortedTariffs;
        }
        
        // FunciÃ³n: Calcular tarifas seleccionadas manualmente
        function calculateSelectedGasTariffs() {
            const checkboxes = document.querySelectorAll('.gas-tariff-checkbox:checked');
            
            if (checkboxes.length === 0) {
                alert('Selecciona al menos una tarifa');
                return;
            }
            
            const { dias, kwh, totalCliente, compareIndexedVsFixed } = gasCalculationParams;
            
            // Usar las tarifas ya ordenadas
            const sortedTariffs = window.gasSortedTariffs || window.gasCalculatedTariffs;
            
            const selectedCalculations = Array.from(checkboxes).map(cb => {
                const index = parseInt(cb.dataset.index);
                return sortedTariffs[index].calculation;
            });
            
            let results = selectedCalculations;
            
            // Si comparar indexada vs fija, agregar la indexada DRK al inicio
            if (compareIndexedVsFixed) {
                const comparisonMode = document.querySelector('input[name="comparison_mode"]:checked').value;
                const searchTariff = currentGasTariff.replace(/RL(\d)/, 'RL.$1');
                
                let allTariffs = gasTariffsData.filter(t => {
                    const tariffValue = (t.Tarifa || '').trim().toUpperCase();
                    return tariffValue === searchTariff.toUpperCase();
                });
                
                if (comparisonMode === 'drk_only' || comparisonMode === 'drk_prioritized') {
                    allTariffs = allTariffs.filter(t => {
                        const name = (t.name || t.Name || '').toLowerCase();
                        return name.includes('drk') || name.includes('direct');
                    });
                }
                
                // Buscar indexada por name (contiene INDEX)
                const indexedTariff = allTariffs.find(t => {
                    const name = (t.name || t.Name || '').toUpperCase();
                    return name.includes('INDEX');
                });
                
                if (indexedTariff) {
                    results.unshift(calculateGasTariff(indexedTariff, dias, kwh, totalCliente));
                }
            }
            
            // Mostrar resultados
            showGasResults(results, dias, kwh, totalCliente);
        }
        
        // FunciÃ³n: Cerrar modal
        function closeGasModal() {
            document.getElementById('gas-manual-input-modal').classList.add('hidden');
            document.getElementById('gas-manual-input-modal').classList.remove('flex');
        }
        
        // FunciÃ³n: Cargar datos del Google Sheets de GAS
        async function loadGasData() {
            console.log('ðŸ”„ Cargando datos de GAS desde Google Sheets...');
            const url = `https://docs.google.com/spreadsheets/d/${GAS_SHEET_ID}/export?format=csv&gid=0&t=${Date.now()}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                
                if (!text || text.length < 10) {
                    throw new Error('El archivo CSV estÃ¡ vacÃ­o o no se pudo cargar');
                }
                
                console.log('ðŸ“¥ CSV recibido, primeras 200 caracteres:', text.substring(0, 200));
                
                gasTariffsData = parseGasCSV(text);
                
                if (gasTariffsData.length === 0) {
                    console.error('âŒ No se pudieron parsear datos del CSV');
                    alert('Error: No se encontraron datos en el Excel de GAS');
                } else {
                    console.log(`âœ… Cargadas ${gasTariffsData.length} tarifas de GAS`);
                }
            } catch (error) {
                console.error('âŒ Error al cargar datos de GAS:', error);
                gasTariffsData = [];
                alert('Error al cargar datos de GAS. Verifica la conexiÃ³n y permisos del Excel.');
            }
        }
        
        // FunciÃ³n: Parsear CSV de GAS
        function parseGasCSV(csvText) {
            const lines = csvText.split('\n');
            if (lines.length === 0) return [];
            
            // Limpiar y extraer headers (mantener nombres exactos)
            const headerLine = lines[0];
            const headers = headerLine.split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            
            console.log('ðŸ“‹ Headers del Excel:', headers);
            
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Parsear CSV manejando comillas
                const values = [];
                let currentValue = '';
                let insideQuotes = false;
                
                for (let char of line) {
                    if (char === '"') {
                        insideQuotes = !insideQuotes;
                    } else if (char === ',' && !insideQuotes) {
                        values.push(currentValue.trim().replace(/^"|"$/g, ''));
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                values.push(currentValue.trim().replace(/^"|"$/g, ''));
                
                // Crear objeto manteniendo nombres exactos de headers
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                
                // Verificar que tenga datos vÃ¡lidos
                // Columnas crÃ­ticas: name, p1_price, Tarifa
                const hasName = row.name || row.Name;
                const hasPrice = row.p1_price || row.P1_price;
                const hasTarifa = row.Tarifa;
                
                if (hasName && hasPrice && hasTarifa) {
                    data.push(row);
                    
                    // Log de las primeras 3 filas para debug
                    if (data.length <= 3) {
                        console.log(`ðŸ“Š Fila ${data.length}:`, {
                            name: row.name || row.Name,
                            description: row.description || row.Description,
                            Tarifa: row.Tarifa,
                            p1_price: row.p1_price,
                            p_fijo_1: row.p_fijo_1
                        });
                    }
                }
            }
            
            console.log(`âœ… Parseadas ${data.length} tarifas de GAS`);
            
            // Mostrar las tarifas Ãºnicas encontradas
            const uniqueTariffs = [...new Set(data.map(d => d.Tarifa))].sort();
            console.log('ðŸ·ï¸ Tarifas Ãºnicas encontradas:', uniqueTariffs);
            
            return data;
        }
        
        /* FUNCIÃ“N ANTIGUA - YA NO SE USA
        // FunciÃ³n: Realizar cÃ¡lculos de GAS
        function calculateGas() {
            // ... cÃ³digo comentado ...
        }
        */
        
        // FunciÃ³n: Calcular una tarifa especÃ­fica de GAS
        function calculateGasTariff(tariff, dias, kwh, totalCliente) {
            // FunciÃ³n auxiliar para convertir string europeo a nÃºmero
            const parseEuropeanNumber = (value) => {
                if (!value) return 0;
                // Convertir coma a punto y luego parsear
                const cleanValue = String(value).replace(',', '.');
                return parseFloat(cleanValue) || 0;
            };
            
            // Extraer datos de la tarifa (usando nombres exactos del Excel)
            const p1_price = parseEuropeanNumber(tariff.p1_price || tariff.P1_price);
            const descuento_energia = parseEuropeanNumber(tariff.Descuento_Energia) / 100;
            const p_fijo_anual = parseEuropeanNumber(tariff.p_fijo_1 || tariff.P_fijo_1);
            const descuento_potencia = parseEuropeanNumber(tariff.Descuento_Potencia) / 100;
            
            console.log('ðŸ§® Calculando:', {
                name: tariff.name || tariff.Name,
                p1_price: p1_price + ' (original: ' + (tariff.p1_price || tariff.P1_price) + ')',
                descuento_energia: (descuento_energia * 100) + '%',
                p_fijo_anual: p_fijo_anual + ' (original: ' + (tariff.p_fijo_1 || tariff.P_fijo_1) + ')',
                descuento_potencia: (descuento_potencia * 100) + '%',
                dias: dias
            });
            
            // 1. TÃ‰RMINO FIJO
            const p_fijo_diario = p_fijo_anual / 365;
            const p_fijo_descuento = p_fijo_diario * descuento_potencia;
            const p_fijo_diario_final = p_fijo_diario - p_fijo_descuento;
            const total_fijo = p_fijo_diario_final * dias;
            
            console.log('ðŸ“Š TÃ©rmino fijo:', {
                'p_fijo_anual': p_fijo_anual.toFixed(6),
                'p_fijo_diario': p_fijo_diario.toFixed(6),
                'descuento_por_dia': p_fijo_descuento.toFixed(6),
                'p_fijo_diario_final': p_fijo_diario_final.toFixed(6),
                'dias': dias,
                'total_fijo': total_fijo.toFixed(2)
            });
            
            // 2. ENERGÃA
            const p1_descuento = p1_price * descuento_energia;
            const total_energia = kwh * (p1_price - p1_descuento);
            
            // 3. IMPUESTO DE HIDROCARBUROS
            const impuesto_hidrocarburo = 0.00234 * kwh;
            
            // 4. ALQUILER DE CONTADOR - QUITADO (ya no se incluye)
            // const alquiler_contador = 1.07;
            
            // 5. SUBTOTAL (antes de IVA) - SIN alquiler contador
            const subtotal = total_fijo + total_energia + impuesto_hidrocarburo;
            
            // 6. IVA
            const iva = 0.21 * subtotal;
            
            // 7. TOTAL FINAL
            const total = subtotal + iva;
            
            // 8. AHORRO
            const ahorro_periodo = totalCliente - total;
            const ahorro_mensual = dias !== 30 ? (ahorro_periodo * 30) / dias : ahorro_periodo;
            const ahorro_anual = ahorro_mensual * 12;
            
            console.log('ðŸ’° Resultado:', {
                total_fijo: total_fijo.toFixed(2) + 'â‚¬',
                total_energia: total_energia.toFixed(2) + 'â‚¬',
                subtotal: subtotal.toFixed(2) + 'â‚¬',
                iva: iva.toFixed(2) + 'â‚¬',
                total: total.toFixed(2) + 'â‚¬',
                ahorro_anual: ahorro_anual.toFixed(2) + 'â‚¬'
            });
            
            return {
                name: tariff.name || tariff.Name,
                descripcion: tariff.description || tariff.Description || tariff.name || tariff.Name,
                tarifa: tariff.Tarifa,
                // Desglose
                p_fijo_diario: p_fijo_diario,
                p_fijo_descuento: p_fijo_descuento,
                total_fijo: total_fijo,
                p1_price: p1_price,
                p1_descuento: p1_descuento,
                total_energia: total_energia,
                impuesto_hidrocarburo: impuesto_hidrocarburo,
                alquiler_contador: 0, // Quitado
                subtotal: subtotal,
                iva: iva,
                total: total,
                // Ahorro
                ahorro_periodo: ahorro_periodo,
                ahorro_mensual: ahorro_mensual,
                ahorro_anual: ahorro_anual
            };
        }
        
        // FunciÃ³n: Mostrar resultados de GAS
        function showGasResults(results, dias, kwh, totalCliente) {
            console.log('=== showGasResults ===');
            console.log('Mode DUAL:', window.dualMode);
            console.log('Results:', results);
            console.log('Params:', { dias, kwh, totalCliente });
            
            // CRÃTICO: Interceptar DUAL AL PRINCIPIO, antes de procesar HTML
            if (window.dualMode === true) {
                console.log('âš¡ Modo DUAL detectado en GAS - aÃ±adiendo al array');
                
                try {
                    // Ordenar por mejor ahorro
                    results.sort((a, b) => b.ahorro_anual - a.ahorro_anual);
                    
                    // Extraer mejor resultado para DUAL
                    const bestResult = results[0];
                    console.log('===== DEBUG GAS =====');
                    console.log('Best gas result:', bestResult);
                    console.log('Propiedades de bestResult:', Object.keys(bestResult));
                    console.log('  - name:', bestResult.name);
                    console.log('  - descripcion:', bestResult.descripcion);
                    console.log('  - tarifa:', bestResult.tarifa);
                    console.log('  - total (mensual):', bestResult.total);
                    console.log('  - total * 12 (anual):', bestResult.total * 12);
                    console.log('  - ahorro_anual:', bestResult.ahorro_anual);
                    console.log('====================');
                    
                    const data = window.gasCalculationParams || {};
                    console.log('Gas calculation params:', data);
                    
                    // Calcular anual desde el mensual
                    const totalMensual = bestResult.total || 0;
                    const totalAnual = totalMensual * 12;
                    
                    // Obtener factura original desde gasCalculationParams
                    // NOTA: gasCalculationParams usa 'totalCliente', no 'importe_factura'
                    const importeFacturaMensual = data.totalCliente || data.importe_factura || 0;
                    const originalBillAnnual = importeFacturaMensual * 12;
                    
                    console.log('CÃ¡lculos:');
                    console.log('  - Total mensual DRK:', totalMensual);
                    console.log('  - Total anual DRK:', totalAnual);
                    console.log('  - Factura original mensual:', importeFacturaMensual);
                    console.log('  - Factura original anual:', originalBillAnnual);
                    console.log('  - Ahorro anual:', originalBillAnnual - totalAnual);
                    console.log('  - Ahorro mensual:', importeFacturaMensual - totalMensual);
                    
                    // Parsear valores correctamente (pueden venir como "11.18â‚¬" o "11,18")
                    const parseGasValue = (val) => {
                        if (!val) return 0;
                        if (typeof val === 'number') return val;
                        // Eliminar sÃ­mbolo â‚¬ y convertir comas a puntos
                        return parseFloat(val.toString().replace('â‚¬', '').replace(',', '.').trim()) || 0;
                    };
                    
                    console.log('Valores parseados:');
                    console.log('  - total_fijo:', parseGasValue(bestResult.total_fijo));
                    console.log('  - total_energia:', parseGasValue(bestResult.total_energia));
                    console.log('  - impuesto_hidrocarburos:', parseGasValue(bestResult.impuesto_hidrocarburos));
                    
                    // CREAR el objeto de suministro para GAS (con DESGLOSE COMPLETO)
                    const newSupply = {
                        type: 'gas',
                        cups: data.cups || 'N/A', // CUPS de GAS capturado del formulario
                        tariff: currentGasTariff || bestResult.tarifa || 'Gas',
                        offer: {
                            name: bestResult.name || 'DRK',
                            description: bestResult.descripcion || bestResult.name || 'DRK Gas',  // âœ… DESCRIPTION
                            isDrk: true,
                            // AÃ±adir precios para mostrar en PDF
                            p_fijo_diario: parseFloat(bestResult.p_fijo_diario) || 0,
                            p1_price: parseFloat(bestResult.p1_price) || 0
                        },
                        totalAnnual: totalAnual,
                        originalBillAnnual: originalBillAnnual,
                        // NUEVO: AÃ±adir desglose completo (PROPIEDADES CORREGIDAS)
                        gasBreakdown: {
                            termino_fijo: parseGasValue(bestResult.total_fijo),      // âœ… CORREGIDO: total_fijo
                            termino_fijo_diario: parseFloat(bestResult.p_fijo_diario) || 0,
                            energia: parseGasValue(bestResult.total_energia),         // âœ… CORREGIDO: total_energia
                            impuesto_hidrocarburos: parseGasValue(bestResult.impuesto_hidrocarburos), // âœ…
                            subtotal: parseGasValue(bestResult.subtotal),
                            iva: parseGasValue(bestResult.iva),
                            total: parseGasValue(bestResult.total),
                            total_anual: totalAnual,
                            ahorro_mensual: importeFacturaMensual - totalMensual,
                            ahorro_anual: originalBillAnnual - totalAnual,
                            kwh: data.kwh || 0,
                            dias: data.dias || 30
                        },
                        data: {
                            kwh: data.kwh || 0,
                            kwh_p1: 0,
                            kwh_p2: 0,
                            kwh_p3: 0,
                            consumo_anual_kwh: data.kwh || 0,
                            importe_factura: importeFacturaMensual,
                            dias: data.dias || 30
                        },
                        results: {
                            drk: {
                                total: totalMensual,
                                total_anual: totalAnual
                            },
                            powercup: {
                                // Para GAS, usar el mismo valor que DRK si no hay segunda tarifa
                                total: results.length > 1 ? results[1].total : totalMensual,
                                total_anual: results.length > 1 ? results[1].total_anual : totalAnual
                            }
                        }
                    };
                    
                    console.log('Llamando a dualAddFromResults para GAS');
                    
                    // Construir datos para el flujo unificado
                    const gasData = {
                        cups: data.cups || 'N/A',
                        kwh: data.kwh || 0,
                        dias: data.dias || 30,
                        totalCliente: importeFacturaMensual,
                        originalBillAnnual: originalBillAnnual
                    };
                    
                    const gasResults = {
                        drk: {
                            total: totalMensual,
                            total_anual: totalAnual
                        },
                        powercup: {
                            total: results.length > 1 ? results[1].total : totalMensual,
                            total_anual: results.length > 1 ? results[1].total_anual : totalAnual
                        }
                    };
                    
                    // Usar el flujo con modal de direcciÃ³n, pasando bestResult completo
                    window.dualAddFromResults('gas', currentGasTariff || 'RL1', gasData, gasResults, bestResult);
                    
                    // Cerrar modal de gas
                    const gasModal = document.getElementById('gas-modal');
                    if (gasModal) {
                        gasModal.classList.add('hidden');
                    }
                    
                    // Ocultar TODAS las pantallas
                    hideAllScreens();
                    
                    // Volver a la pantalla DUAL
                    document.getElementById('screen-dual').classList.add('active');
                    
                    console.log('âœ… Usuario puede aÃ±adir mÃ¡s suministros o calcular');
                    
                    return; // IMPORTANTE: Salir aquÃ­
                } catch (error) {
                    console.error('Error en modo DUAL para GAS:', error);
                    console.error('Error stack:', error.stack);
                    alert('Error al procesar el suministro de gas: ' + error.message);
                    backToDualManager();
                    return;
                }
            }
            
            // FLUJO NORMAL (no DUAL) - continuar con el procesamiento normal
            const container = document.getElementById('gas-results-container');
            
            // Ordenar por mejor ahorro
            results.sort((a, b) => b.ahorro_anual - a.ahorro_anual);
            
            // NUEVO: Detectar si NO hay ahorro en ninguna tarifa
            const bestSaving = results.length > 0 ? results[0].ahorro_anual : 0;
            const noSavings = bestSaving <= 0;
            
            let html = '';
            
            // NUEVO: Si no hay ahorro, mostrar mensaje especial
            if (noSavings) {
                html += `
                <div class="mb-6 p-6 border-4 border-red-500 bg-red-50 rounded-2xl">
                    <div class="text-center mb-6">
                        <h3 class="text-3xl font-black text-red-600 mb-4"${tr("LA MEJOR OPCIÃ“N PARA TI ES")}</h3>
                        <h2 class="text-5xl font-black text-red-700 mb-3">Tu Tarifa Actual</h2>
                        <p class="text-lg text-red-600 font-semibold">Es la mejor opciÃ³n detectada</p>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl border-2 border-red-200">
                        <h4 class="text-2xl font-bold text-red-600 mb-3 text-center">Â¡ENHORABUENA!</h4>
                        <p class="text-lg leading-tight font-bold text-red-700 text-center mb-3">Actualmente estÃ¡s en una buena tarifa.</p>
                        <p class="text-base text-red-600 text-center leading-relaxed">Seguiremos estudiando el mercado y te avisaremos cuando encontremos alguna tarifa que se adapte a tu perfil de consumo.</p>
                    </div>
                    
                    <div class="mt-6 p-4 bg-red-100 rounded-xl">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-red-800">TU COSTE ACTUAL CONSOLIDADO</span>
                        </div>
                        <div class="flex justify-between items-center text-2xl">
                            <span class="font-bold text-red-700">Total factura:</span>
                            <span class="font-bold text-red-700">${totalCliente.toFixed(2)} â‚¬</span>
                        </div>
                        <div class="flex justify-between items-center mt-2 text-xl">
                            <span class="font-bold text-red-700">EstimaciÃ³n anual:</span>
                            <span class="font-bold text-red-700">${(totalCliente * 365 / dias).toFixed(2)} â‚¬/aÃ±o</span>
                        </div>
                    </div>
                </div>
                `;
                
                // Mostrar botÃ³n "SOLICITAR MEJORA A DRK" para GAS
                const gasImprovementContainer = document.getElementById('gas-request-improvement-container');
                if (gasImprovementContainer) {
                    gasImprovementContainer.style.display = 'block';
                }
                
            } else {
                // HAY AHORRO: Mostrar comparativo normal
                
                // Ocultar botÃ³n de solicitar mejora para GAS
                const gasImprovementContainer = document.getElementById('gas-request-improvement-container');
                if (gasImprovementContainer) {
                    gasImprovementContainer.style.display = 'none';
                }
                
                results.forEach((result, index) => {
                    const isPositiveSaving = result.ahorro_anual > 0;
                    const savingClass = isPositiveSaving ? 'text-green-600' : 'text-red-600';
                    
                    html += `
                    <div class="mb-6 p-4 border-2 ${isPositiveSaving ? 'border-green-200 bg-green-50' : 'border-slate-200'} rounded-xl">
                        <h3 class="text-xl font-bold text-drk-900 mb-2">${result.name}</h3>
                        <p class="text-sm text-slate-600 mb-4">${result.descripcion}</p>
                    
                    <table class="w-full text-sm">
                        <tr class="border-b">
                            <td class="py-2">TÃ©rmino fijo (${dias} dÃ­as)</td>
                            <td class="text-right font-bold">${result.total_fijo.toFixed(2)} â‚¬</td>
                        </tr>
                        ${result.p_fijo_descuento > 0 ? `
                        <tr class="border-b text-green-600">
                            <td class="py-2 pl-4">â†³ Descuento potencia</td>
                            <td class="text-right font-bold">-${(dias * result.p_fijo_descuento).toFixed(2)} â‚¬</td>
                        </tr>
                        ` : ''}
                        <tr class="border-b">
                            <td class="py-2">EnergÃ­a (${kwh} kWh)</td>
                            <td class="text-right font-bold">${result.total_energia.toFixed(2)} â‚¬</td>
                        </tr>
                        ${result.p1_descuento > 0 ? `
                        <tr class="border-b text-green-600">
                            <td class="py-2 pl-4">â†³ Descuento energÃ­a</td>
                            <td class="text-right font-bold">-${(kwh * result.p1_descuento).toFixed(2)} â‚¬</td>
                        </tr>
                        ` : ''}
                        <tr class="border-b">
                            <td class="py-2">Impuesto hidrocarburos</td>
                            <td class="text-right">${result.impuesto_hidrocarburo.toFixed(2)} â‚¬</td>
                        </tr>
                        <tr class="border-b">
                            <td class="py-2">IVA (21%)</td>
                            <td class="text-right">${result.iva.toFixed(2)} â‚¬</td>
                        </tr>
                        <tr class="border-t-2 border-drk-500 font-bold text-lg">
                            <td class="py-2">TOTAL</td>
                            <td class="text-right">${result.total.toFixed(2)} â‚¬</td>
                        </tr>
                    </table>
                    
                    <div class="mt-4 p-3 bg-slate-100 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="font-bold">Tu factura actual:</span>
                            <span class="font-bold">${totalCliente.toFixed(2)} â‚¬</span>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <span class="font-bold">Con esta tarifa:</span>
                            <span class="font-bold">${result.total.toFixed(2)} â‚¬</span>
                        </div>
                        <div class="flex justify-between items-center mt-2 text-lg ${savingClass}">
                            <span class="font-bold">Ahorro mensual:</span>
                            <span class="font-bold">${isPositiveSaving ? '+' : ''}${result.ahorro_mensual.toFixed(2)} â‚¬</span>
                        </div>
                        <div class="flex justify-between items-center mt-1 text-xl ${savingClass}">
                            <span class="font-bold">Ahorro anual:</span>
                            <span class="font-bold">${isPositiveSaving ? '+' : ''}${result.ahorro_anual.toFixed(2)} â‚¬</span>
                        </div>
                    </div>
                </div>
                `;
            });
            
            } // FIN del else (cuando HAY ahorro)
            
            // GUARDAR DATOS PARA EXPORTAR (NUEVO)
            const comparisonMode = document.querySelector('input[name="comparison_mode"]:checked')?.value || 'drk_only';
            window.gasExportData = { results, dias, kwh, totalCliente, comparisonMode };
            console.log('ðŸ’¾ Guardando gasExportData:', {results: results.map(r => ({name: r.name, ahorro: r.ahorro_anual})), comparisonMode});
            
            // NUEVO: Guardar resultado para solicitud de mejora cuando no hay ahorro
            if (noSavings) {
                window.lastGasComparisonResult = {
                    isGas: true,
                    results: results,
                    dias: dias,
                    kwh: kwh,
                    totalCliente: totalCliente,
                    tariffType: currentGasTariff,
                    bestSaving: bestSaving
                };
                console.log('ðŸ’¾ Guardando lastGasComparisonResult para solicitud de mejora:', window.lastGasComparisonResult);
            }
            
            // NUEVO: Guardar resultados para DUAL
            // Identificar si hay DRK y PowerCup
            let drkResult = null;
            let powercupResult = null;
            
            results.forEach(r => {
                const name = (r.name || '').toUpperCase();
                if (name.includes('INDEX')) {
                    powercupResult = r;
                } else {
                    drkResult = r;
                }
            });
            
            // Si no se identificaron correctamente, usar el primer resultado para DRK
            if (!drkResult && results.length > 0) {
                drkResult = results[0];
            }
            
            // Guardar en variables globales
            window.lastGasDRKResult = drkResult ? {
                total: drkResult.total,
                total_anual: drkResult.total_anual
            } : { total: 0, total_anual: 0 };
            
            window.lastGasPowerCupResult = powercupResult ? {
                total: powercupResult.total,
                total_anual: powercupResult.total_anual
            } : { total: 0, total_anual: 0 };
            
            console.log('ðŸ’¾ Guardando para DUAL:', {
                drk: window.lastGasDRKResult,
                powercup: window.lastGasPowerCupResult
            });
            
            // AGREGAR BOTONES DE EXPORTAR (solo si HAY ahorro)
            if (!noSavings) {
                html += `
                    <div class="mt-8 p-6 bg-gradient-to-r from-slate-50 to-slate-100 rounded-xl border-2 border-slate-200">
                        <h3 class="text-xl font-bold text-drk-900 mb-4 text-center">ðŸ“¤ Exportar PresentaciÃ³n</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- BotÃ³n PDF -->
                            <button
                                onclick="generateGasPDF()"
                                class="flex items-center justify-center gap-3 px-6 py-4 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600 transition shadow-lg"
                            >
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                </svg>
                                <span>Generar PDF</span>
                            </button>
                            
                            <!-- BotÃ³n HTML -->
                            <button
                                onclick="generateGasHTML()"
                                class="flex items-center justify-center gap-3 px-6 py-4 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition shadow-lg"
                            >
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                                <span>Generar HTML para Email</span>
                            </button>
                        </div>
                        
                        <p class="text-xs text-slate-500 text-center mt-4">
                            Genera documentos profesionales para presentar al cliente
                        </p>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            // Mostrar pantalla de resultados
            hideAllScreens();
            document.getElementById('screen-gas-results').classList.add('active');
            
            // Detectar modo DUAL y mostrar botÃ³n si corresponde (para flujo no-DUAL)
            if (window.checkDualMode) window.checkDualMode();
        }
        
        // ===== FUNCIONES DE BÃšSQUEDA (filtran DOM sin re-renderizar) =====
        
        function applyGasSearch() {
            const searchInput = document.getElementById('gas-search-input');
            if (!searchInput) return;
            
            const searchText = searchInput.value.toLowerCase();
            const checkboxes = document.querySelectorAll('.gas-tariff-checkbox');
            let visibleCount = 0;
            let totalCount = checkboxes.length;
            
            checkboxes.forEach(checkbox => {
                const label = checkbox.closest('label');
                if (!label) return;
                
                const name = label.querySelector('.font-bold')?.textContent.toLowerCase() || '';
                const desc = label.querySelector('.text-sm.text-slate-600')?.textContent.toLowerCase() || '';
                
                if (searchText === '' || name.includes(searchText) || desc.includes(searchText)) {
                    label.style.display = '';
                    visibleCount++;
                } else {
                    label.style.display = 'none';
                }
            });
            
            // Actualizar contador
            const countEl = document.getElementById('gas-search-count');
            if (countEl) {
                if (searchText === '') {
                    countEl.textContent = '';
                } else {
                    countEl.textContent = `Mostrando ${visibleCount} de ${totalCount} tarifas`;
                }
            }
        }
        
        function clearGasSearch() {
            const searchInput = document.getElementById('gas-search-input');
            if (searchInput) {
                searchInput.value = '';
                applyGasSearch();
            }
        }
        
        // ========== FUNCIONES DE EXPORTACIÃ“N PDF PARA GAS ==========
        
        async function generateGasPDF() {
            if (!window.gasExportData) {
                alert(window.tr('No hay datos para exportar'));
                return;
            }
            
            // Detectar si estÃ¡ en chino
            const currentLang = window.LANG ? window.LANG.getCurrentLang() : 'es';
            const wasChineseMode = currentLang === 'zh';
            
            // IMPORTANTE: Pedir datos PRIMERO (en el idioma actual, chino si corresponde)
            const comercialCode = prompt(window.tr('CÃ“DIGO COMERCIAL (Obligatorio):'), 'D=00');
            if (!comercialCode || comercialCode.trim() === '') {
                alert(window.tr('El cÃ³digo comercial es obligatorio'));
                return;
            }
            
            const clientName = prompt(window.tr('NOMBRE DEL CLIENTE:'), window.tr('[NOMBRE COMPLETO CLIENTE]')) || window.tr('[NOMBRE COMPLETO CLIENTE]');
            const clientAddress = prompt(window.tr('DIRECCIÃ“N DE SUMINISTRO:'), '') || '';
            
            // AHORA SÃ: Si estÃ¡ en chino, cambiar temporalmente a inglÃ©s para el PDF
            if (wasChineseMode) {
                console.log('ðŸ‡¨ðŸ‡³ Idioma chino detectado - cambiando a inglÃ©s para PDF');
                // Informar al usuario en chino e inglÃ©s
                alert('ðŸ‡¨ðŸ‡³ ç”ŸæˆPDFæ–‡ä»¶ä¸­...\nä¸ºäº†ç¡®ä¿å­—ç¬¦æ­£ç¡®æ˜¾ç¤ºï¼ŒPDFå°†ä½¿ç”¨è‹±è¯­ç”Ÿæˆã€‚\n\nðŸ‡¬ðŸ‡§ Generating PDF...\nTo ensure correct character display, the PDF will be generated in English.');
                // Cambiar temporalmente a inglÃ©s
                window.LANG.change('en', true); // skipReload = true
            }
            
            const { results, dias, kwh, totalCliente, comparisonMode } = window.gasExportData;
            
            try {
                // Detectar si es POWER CUP o DRK basado en comparisonMode
                const isPowerCup = comparisonMode === 'overall_best';
                
                const isDual = results.length === 2 && 
                              results.some(r => r.name.toUpperCase().includes('INDEX')) &&
                              results.some(r => !r.name.toUpperCase().includes('INDEX'));
                
                if (isDual) {
                    const resIndexed = results.find(r => r.name.toUpperCase().includes('INDEX'));
                    const resFijo = results.find(r => !r.name.toUpperCase().includes('INDEX'));
                    
                    if (isPowerCup) {
                        await generateGasPDF_Dual_PowerCup(resFijo, resIndexed, dias, kwh, totalCliente, clientName, comercialCode, clientAddress);
                    } else {
                        await generateGasPDF_Dual(resFijo, resIndexed, dias, kwh, totalCliente, clientName, comercialCode, clientAddress);
                    }
                } else {
                    if (isPowerCup) {
                        await generateGasPDF_Simple_PowerCup(results[0], dias, kwh, totalCliente, clientName, comercialCode, clientAddress);
                    } else {
                        await generateGasPDF_Simple(results[0], dias, kwh, totalCliente, clientName, comercialCode, clientAddress);
                    }
                }
                
                // NUEVO: Restaurar idioma chino despuÃ©s de generar el PDF
                if (wasChineseMode) {
                    setTimeout(() => {
                        console.log('ðŸ‡¨ðŸ‡³ Restaurando idioma chino');
                        window.LANG.change('zh', true);
                    }, 1000);
                }
            } catch (error) {
                console.error('Error generando PDF:', error);
                window.showMessageModal("âŒ Error: " + error.message, false);
                
                // Restaurar idioma si hubo error
                if (wasChineseMode) {
                    window.LANG.change('zh', true);
                }
            }
        }
        
        async function generateGasHTML() {
            if (!window.gasExportData) {
                window.showMessageModal("âš ï¸ No hay datos para exportar", false);
                return;
            }
            
            const { results, dias, kwh, totalCliente } = window.gasExportData;
            console.log('ðŸ“§ Generando HTML - results:', results.map(r => ({name: r.name, ahorro: r.ahorro_anual})));
            
            // Detectar si es modo comparativo (Fija vs Indexada)
            const isComparisonMode = document.getElementById('gas-compare-indexed-fixed') && 
                                     document.getElementById('gas-compare-indexed-fixed').checked;
            
            if (isComparisonMode && results.length === 2) {
                // Modo comparativo: mostrar ambas tarifas lado a lado
                generateGasHTMLComparison(results, dias, kwh, totalCliente);
            } else {
                // Modo individual: mostrar solo la mejor tarifa
                generateGasHTMLSingle(results[0], dias, kwh, totalCliente);
            }
        }
        
        // FunciÃ³n especÃ­fica para generar HTML en CHINO (GAS - Tarifa Ãºnica)
        function generateGasHTMLSingle_Chinese(result, dias, kwh, totalCliente, isDrk, primaryColor, accentColor, brandName) {
            const eur = n => new Intl.NumberFormat('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(n || 0) + ' â‚¬';
            const num = (n, d=6) => new Intl.NumberFormat('es-ES', {minimumFractionDigits: d, maximumFractionDigits: d}).format(n || 0);
            
            const tariffName = result.descripcion ? `${result.name} - ${result.descripcion}` : result.name;
            const ahorroAnual = result.ahorro_anual;
            const facturaActualAnio = totalCliente * 365 / dias;
            const nuevoAnio = result.total * 365 / dias;
            const nuevoMes = result.total * 30 / dias;
            
            const htmlContent = `
            <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; background: white;">
                
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white;">
                    <tr>
                        <td style="padding: 30px 40px;">
                            <h1 style="margin: 0; font-size: 32px; font-weight: bold;">${brandName} èƒ½æº</h1>
                            <p style="margin: 8px 0 0 0; font-size: 14px;">å¼•é¢†èŠ‚çœå’Œèƒ½æºæ•ˆçŽ‡</p>
                        </td>
                        <td style="padding: 30px 40px; text-align: right;">
                            <p style="margin: 0; font-size: 14px; font-weight: bold;">èŠ‚çœç ”ç©¶</p>
                            <p style="margin: 4px 0 0 0; font-size: 16px; font-weight: bold;">ä¸“ä¸šæ¯”è¾ƒ</p>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${accentColor}; color: white;">
                    <tr>
                        <td style="padding: 15px 40px; text-align: center;">
                            <h2 style="margin: 0; font-size: 20px; font-weight: bold;">èŠ‚çœç ”ç©¶ - å¤©ç„¶æ°”</h2>
                            <p style="margin: 4px 0 0 0; font-size: 14px;">ä¸“ä¸šæ¯”è¾ƒ - ${brandName}</p>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 20px;">
                    <tr>
                        <td style="padding: 30px 40px; text-align: center;">
                            <p style="margin: 0 0 10px 0; font-size: 16px;">æœ€é€‚åˆæ‚¨çš„é€‰é¡¹æ˜¯</p>
                            <h2 style="margin: 0; font-size: 36px; font-weight: bold;">${tariffName}</h2>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 20px;">
                    <tr>
                        <td style="padding: 20px 40px; text-align: center;">
                            <p style="margin: 0 0 10px 0; font-size: 16px; color: #666; font-weight: bold;">æ‚¨çš„é¢„è®¡å¹´åº¦èŠ‚çœä¸ºï¼š</p>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${accentColor}; border-radius: 12px; margin: 0 40px; width: calc(100% - 80px);">
                    <tr>
                        <td style="padding: 30px; text-align: center;">
                            <h1 style="margin: 0; font-size: 48px; font-weight: bold; color: white;">${eur(ahorroAnual)}</h1>
                            <p style="margin: 10px 0 0 0; font-size: 18px; color: white; font-weight: bold;">å®žçŽ°æ‚¨çš„å¹´åº¦èŠ‚çœï¼</p>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 30px;">
                    <tr>
                        <td style="width: 48%; padding: 20px; border: 2px solid #e0e0e0; text-align: center;">
                            <p style="margin: 0 0 15px 0; font-size: 14px; color: #888; font-weight: bold;">æ‚¨å½“å‰çš„è´¦å•</p>
                            <h2 style="margin: 0; font-size: 32px; font-weight: bold; color: #dc2626; text-decoration: line-through;">${eur(facturaActualAnio)}</h2>
                            <p style="margin: 8px 0 0 0; font-size: 14px; color: #666;">/ å¹´</p>
                        </td>
                        <td style="width: 4%;"></td>
                        <td style="width: 48%; padding: 20px; border: 2px solid #e0e0e0; text-align: center;">
                            <p style="margin: 0 0 15px 0; font-size: 14px; color: #888; font-weight: bold;">æ‚¨çš„æ–°${brandName}æˆæœ¬</p>
                            <h2 style="margin: 0; font-size: 32px; font-weight: bold; color: ${primaryColor};">${eur(nuevoAnio)}</h2>
                            <p style="margin: 8px 0 0 0; font-size: 14px; color: #666;">/ å¹´</p>
                            <p style="margin: 8px 0 0 0; font-size: 16px; color: ${primaryColor}; font-weight: bold;">${eur(nuevoMes)} / æœˆ</p>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 30px;">
                    <tr>
                        <td style="padding: 15px 40px;">
                            <h3 style="margin: 0; font-size: 16px; font-weight: bold;">ä»·æ ¼æ‘˜è¦</h3>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="border: 1px solid #e0e0e0; border-top: none;">
                    <tr style="background-color: #f5f5f5;">
                        <td style="padding: 12px 40px; font-weight: bold; font-size: 14px;">æ¦‚å¿µ</td>
                        <td style="padding: 12px 40px; font-weight: bold; font-size: 14px; text-align: right;">${brandName}ä»·æ ¼</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px 40px; border-top: 1px solid #e0e0e0; font-size: 13px;">å›ºå®šä»·æ ¼ (â‚¬/å¤©)</td>
                        <td style="padding: 10px 40px; border-top: 1px solid #e0e0e0; font-size: 13px; text-align: right;">${num(result.p_fijo_diario / 365)}</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px 40px; border-top: 1px solid #e0e0e0; font-size: 13px;">èƒ½æº (â‚¬/kWh)</td>
                        <td style="padding: 10px 40px; border-top: 1px solid #e0e0e0; font-size: 13px; text-align: right;">${num(result.p1_price)}</td>
                    </tr>
                    <tr style="background-color: #f0fdf4;">
                        <td style="padding: 12px 40px; border-top: 2px solid ${accentColor}; font-weight: bold; font-size: 14px;">å¹´åº¦èŠ‚çœ</td>
                        <td style="padding: 12px 40px; border-top: 2px solid ${accentColor}; font-weight: bold; font-size: 14px; text-align: right; color: #16a34a;">${eur(ahorroAnual)}</td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 30px;">
                    <tr>
                        <td style="padding: 15px 40px;">
                            <h3 style="margin: 0; font-size: 16px; font-weight: bold;">è¯¦ç»†æ˜Žç»† (${tariffName})</h3>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="border: 1px solid #e0e0e0; border-top: none;">
                    <tr>
                        <td style="padding: 15px 40px;" colspan="2">
                            <p style="margin: 0 0 10px 0; font-size: 15px; font-weight: bold; color: ${primaryColor};">å›ºå®šæœŸé™ï¼ˆâ‚¬/å¤©ï¼‰</p>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 40px; padding-left: 60px; font-size: 13px;">å›ºå®šä»·æ ¼ (${dias} å¤© x ${num(result.p_fijo_diario / 365)})</td>
                        <td style="padding: 8px 40px; font-size: 13px; text-align: right; font-weight: bold;">${eur(result.total_fijo)}</td>
                    </tr>
                    <tr style="background-color: #f9f9f9;">
                        <td style="padding: 10px 40px; font-size: 14px; font-weight: bold;">å°è®¡åŠŸçŽ‡</td>
                        <td style="padding: 10px 40px; font-size: 14px; text-align: right; font-weight: bold;">${eur(result.total_fijo)}</td>
                    </tr>
                    
                    <tr>
                        <td style="padding: 15px 40px; padding-top: 20px;" colspan="2">
                            <p style="margin: 0 0 10px 0; font-size: 15px; font-weight: bold; color: ${primaryColor};">èƒ½æºæœŸé™ï¼ˆâ‚¬/kWhï¼‰</p>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 40px; padding-left: 60px; font-size: 13px;">èƒ½æº (${kwh} kWh x ${num(result.p1_price)})</td>
                        <td style="padding: 8px 40px; font-size: 13px; text-align: right; font-weight: bold;">${eur(result.total_energia)}</td>
                    </tr>
                    <tr style="background-color: #f9f9f9;">
                        <td style="padding: 10px 40px; font-size: 14px; font-weight: bold;">å°è®¡èƒ½æºï¼ˆæ¯›é¢ï¼‰</td>
                        <td style="padding: 10px 40px; font-size: 14px; text-align: right; font-weight: bold;">${eur(result.total_energia)}</td>
                    </tr>
                    
                    <tr>
                        <td style="padding: 15px 40px; padding-top: 20px; font-size: 15px; font-weight: bold; color: ${primaryColor};" colspan="2">å°è®¡åŸºç¡€ (P+E)</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 40px; padding-left: 60px; font-size: 13px;">ç¢³æ°¢åŒ–åˆç‰©ç¨Ž (â‚¬0,00234 x ${kwh} kWh)</td>
                        <td style="padding: 8px 40px; font-size: 13px; text-align: right;">${eur(result.impuesto_hidrocarburo)}</td>
                    </tr>
                    <tr style="background-color: #f9f9f9;">
                        <td style="padding: 10px 40px; font-size: 14px; font-weight: bold;">åº”ç¨ŽåŸºç¡€</td>
                        <td style="padding: 10px 40px; font-size: 14px; text-align: right; font-weight: bold;">${eur(result.total_fijo + result.total_energia + result.impuesto_hidrocarburo)}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 40px; padding-left: 60px; font-size: 13px;">å¢žå€¼ç¨Ž (21%)</td>
                        <td style="padding: 8px 40px; font-size: 13px; text-align: right;">${eur(result.iva)}</td>
                    </tr>
                    <tr style="background-color: ${primaryColor}; color: white;">
                        <td style="padding: 15px 40px; font-size: 16px; font-weight: bold;">æ€»è®¡è´¦å• (${dias} å¤©)</td>
                        <td style="padding: 15px 40px; font-size: 16px; text-align: right; font-weight: bold;">${eur(result.total)}</td>
                    </tr>
                    <tr style="background-color: #f0f0f0;">
                        <td style="padding: 12px 40px; font-size: 14px; font-weight: bold;">å¹´åº¦æ€»è®¡ï¼ˆé¢„è®¡ï¼‰</td>
                        <td style="padding: 12px 40px; font-size: 14px; text-align: right; font-weight: bold;">${eur(nuevoAnio)}</td>
                    </tr>
                </table>
                
            </div>
            `;
            
            showHTMLPreview(htmlContent);
        }
        
        // FunciÃ³n para generar HTML individual (una sola tarifa)
        function generateGasHTMLSingle(result, dias, kwh, totalCliente) {
            const eur = n => new Intl.NumberFormat('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(n || 0) + ' â‚¬';
            const num = (n, d=6) => new Intl.NumberFormat('es-ES', {minimumFractionDigits: d, maximumFractionDigits: d}).format(n || 0);
            
            // Determinar marca (DRK o POWER CUP)
            const comparisonMode = document.querySelector('input[name="comparison_mode"]:checked').value;
            const isDrk = (comparisonMode === 'drk_only' || comparisonMode === 'drk_prioritized');
            
            // Colores segÃºn marca
            const primaryColor = isDrk ? '#3b5875' : '#4d7c0f';
            const accentColor = isDrk ? '#4a90e2' : '#84cc16';
            const lightBg = isDrk ? '#e8f4fd' : '#f0fdf4';
            const brandName = isDrk ? 'DRK' : 'POWER CUP';
            
            // NUEVO: Detectar si estÃ¡ en chino y llamar a versiÃ³n especÃ­fica
            const currentLang = window.LANG ? window.LANG.getCurrentLang() : 'es';
            if (currentLang === 'zh') {
                generateGasHTMLSingle_Chinese(result, dias, kwh, totalCliente, isDrk, primaryColor, accentColor, brandName);
                return;
            }
            
            const tariffName = result.descripcion ? `${result.name} - ${result.descripcion}` : result.name;
            console.log('ðŸ” DEBUG HTML GAS - tariffName:', tariffName, 'result completo:', result);
            const ahorroAnual = result.ahorro_anual;
            const ahorroMensual = result.ahorro_mensual;
            
            // Calcular valores anuales y mensuales
            const facturaActualMes = totalCliente * 30 / dias;
            const facturaActualAnio = totalCliente * 365 / dias;
            const nuevoMes = result.total * 30 / dias;
            const nuevoAnio = result.total * 365 / dias;
            
            const htmlContent = `
            <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; background: white;">
                
                <!-- HEADER -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white;">
                    <tr>
                        <td style="padding: 30px 40px;">
                            <h1 style="margin: 0; font-size: 32px; font-weight: bold;">${brandName} ENERGÃA</h1>
                            <p style="margin: 8px 0 0 0; font-size: 14px;">${tr('Liderando el ahorro y la eficiencia energÃ©tica.')}</p>
                        </td>
                        <td style="padding: 30px 40px; text-align: right;">
                            <p style="margin: 0; font-size: 14px; font-weight: bold;">${tr('ESTUDIO DE AHORRO')}</p>
                            <p style="margin: 4px 0 0 0; font-size: 16px; font-weight: bold;">${tr('COMPARATIVA PROFESIONAL')}</p>
                        </td>
                    </tr>
                </table>
                
                <!-- BANNER ESTUDIO DE AHORRO -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${accentColor}; color: white;">
                    <tr>
                        <td style="padding: 15px 40px; text-align: center;">
                            <h2 style="margin: 0; font-size: 20px; font-weight: bold;">${tr('ESTUDIO DE AHORRO')} - GAS</h2>
                            <p style="margin: 4px 0 0 0; font-size: 14px;">${tr('COMPARATIVA PROFESIONAL')} - ${brandName}</p>
                        </td>
                    </tr>
                </table>
                
                <!-- DATOS DEL CLIENTE -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: white; border: 1px solid #e0e0e0; margin-top: 20px;">
                    <tr>
                        <td style="padding: 20px 40px;">
                            <p style="margin: 0 0 8px 0; font-size: 14px;"><strong${tr("CLIENTE:")}</strong> [NOMBRE COMPLETO CLIENTE]</p>
                            <p style="margin: 0 0 8px 0; font-size: 14px;"><strong${tr("CUPS:")}</strong> ES0021000020679723GY</p>
                            <p style="margin: 0; font-size: 14px;"><strong${tr("COMERCIAL:")}</strong> zdvxzc</p>
                        </td>
                    </tr>
                </table>
                
                <!-- LA MEJOR OPCIÃ“N -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 20px;">
                    <tr>
                        <td style="padding: 30px 40px; text-align: center;">
                            <p style="margin: 0 0 10px 0; font-size: 16px;"${tr("LA MEJOR OPCIÃ“N PARA TI ES")}</p>
                            <h2 style="margin: 0; font-size: 36px; font-weight: bold;">${tariffName}</h2>
                        </td>
                    </tr>
                </table>
                
                <!-- TU AHORRO ANUAL -->
                <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 20px;">
                    <tr>
                        <td style="padding: 20px 40px; text-align: center;">
                            <p style="margin: 0 0 10px 0; font-size: 16px; color: #666; font-weight: bold;">${tr('TU AHORRO ANUAL ESTIMADO ES:')}</p>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${accentColor}; border-radius: 12px; margin: 0 40px; width: calc(100% - 80px);">
                    <tr>
                        <td style="padding: 30px; text-align: center;">
                            <h1 style="margin: 0; font-size: 48px; font-weight: bold; color: white;">${eur(ahorroAnual)}</h1>
                            <p style="margin: 10px 0 0 0; font-size: 18px; color: white; font-weight: bold;">${tr('Â¡CONSIGUE TU AHORRO ANUAL!')}</p>
                        </td>
                    </tr>
                </table>
                
                <!-- COMPARATIVA FACTURA ACTUAL VS NUEVO COSTE -->
                <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 30px;">
                    <tr>
                        <td style="width: 48%; padding: 20px; border: 2px solid #e0e0e0; text-align: center; vertical-align: top;">
                            <p style="margin: 0 0 15px 0; font-size: 14px; color: #888; font-weight: bold;">${tr("TU FACTURA ACTUAL")}</p>
                            <h2 style="margin: 0; font-size: 32px; font-weight: bold; color: #dc2626; text-decoration: line-through;">${eur(facturaActualAnio)}</h2>
                            <p style="margin: 8px 0 0 0; font-size: 14px; color: #666;">${tr('/aÃ±o')}</p>
                        </td>
                        <td style="width: 4%;"></td>
                        <td style="width: 48%; padding: 20px; border: 2px solid #e0e0e0; text-align: center; vertical-align: top;">
                            <p style="margin: 0 0 15px 0; font-size: 14px; color: #888; font-weight: bold;">${tr('TU NUEVO COSTE')} ${brandName}</p>
                            <h2 style="margin: 0; font-size: 32px; font-weight: bold; color: ${primaryColor};">${eur(nuevoAnio)}</h2>
                            <p style="margin: 8px 0 0 0; font-size: 14px; color: #666;">${tr('/aÃ±o')}</p>
                            <p style="margin: 8px 0 0 0; font-size: 16px; color: ${primaryColor}; font-weight: bold;">${eur(nuevoMes)} ${tr('/mes')}</p>
                        </td>
                    </tr>
                </table>
                
                <!-- RESUMEN DE PRECIOS -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 30px;">
                    <tr>
                        <td style="padding: 15px 40px;">
                            <h3 style="margin: 0; font-size: 16px; font-weight: bold;">${tr('RESUMEN DE PRECIOS DE LA OFERTA ÃšNICA')}</h3>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="border: 1px solid #e0e0e0; border-top: none;">
                    <tr style="background-color: #f5f5f5;">
                        <td style="padding: 12px 40px; font-weight: bold; font-size: 14px;">CONCEPTO</td>
                        <td style="padding: 12px 40px; font-weight: bold; font-size: 14px; text-align: right;">PRECIO ${brandName}</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px 40px; border-top: 1px solid #e0e0e0; font-size: 13px;">Precio fijo (â‚¬/dÃ­a)</td>
                        <td style="padding: 10px 40px; border-top: 1px solid #e0e0e0; font-size: 13px; text-align: right;">${num(result.p_fijo_diario / 365)}</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px 40px; border-top: 1px solid #e0e0e0; font-size: 13px;">EnergÃ­a (â‚¬/kWh)</td>
                        <td style="padding: 10px 40px; border-top: 1px solid #e0e0e0; font-size: 13px; text-align: right;">${num(result.p1_price)}</td>
                    </tr>
                    <tr style="background-color: #f0fdf4;">
                        <td style="padding: 12px 40px; border-top: 2px solid ${accentColor}; font-weight: bold; font-size: 14px;">AHORRO ANUAL</td>
                        <td style="padding: 12px 40px; border-top: 2px solid ${accentColor}; font-weight: bold; font-size: 14px; text-align: right; color: #16a34a;">${eur(ahorroAnual)}</td>
                    </tr>
                </table>
                
                <!-- DESGLOSE DETALLADO -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 30px;">
                    <tr>
                        <td style="padding: 15px 40px;">
                            <h3 style="margin: 0; font-size: 16px; font-weight: bold;">${tr('DESGLOSE DETALLADO DE LA SIMULACIÃ“N')} (${tariffName})</h3>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="border: 1px solid #e0e0e0; border-top: none;">
                    <tr>
                        <td style="padding: 15px 40px;" colspan="2">
                            <p style="margin: 0 0 10px 0; font-size: 15px; font-weight: bold; color: ${primaryColor};">TÃ‰RMINO FIJO (Precio en â‚¬/dÃ­a)</p>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 40px; padding-left: 60px; font-size: 13px;">Precio fijo (${dias} dÃ­as x ${num(result.p_fijo_diario / 365)})</td>
                        <td style="padding: 8px 40px; font-size: 13px; text-align: right; font-weight: bold;">${eur(result.total_fijo)}</td>
                    </tr>
                    <tr style="background-color: #f9f9f9;">
                        <td style="padding: 10px 40px; font-size: 14px; font-weight: bold;"${tr("SUBTOTAL POTENCIA")}</td>
                        <td style="padding: 10px 40px; font-size: 14px; text-align: right; font-weight: bold;">${eur(result.total_fijo)}</td>
                    </tr>
                    
                    <tr>
                        <td style="padding: 15px 40px; padding-top: 20px;" colspan="2">
                            <p style="margin: 0 0 10px 0; font-size: 15px; font-weight: bold; color: ${primaryColor};">TÃ‰RMINO ENERGÃA (Precio en â‚¬/kWh)</p>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 40px; padding-left: 60px; font-size: 13px;">EnergÃ­a (${kwh} kWh x ${num(result.p1_price)})</td>
                        <td style="padding: 8px 40px; font-size: 13px; text-align: right; font-weight: bold;">${eur(result.total_energia)}</td>
                    </tr>
                    <tr style="background-color: #f9f9f9;">
                        <td style="padding: 10px 40px; font-size: 14px; font-weight: bold;"${tr("Subtotal EnergÃ­a (Bruto)")}</td>
                        <td style="padding: 10px 40px; font-size: 14px; text-align: right; font-weight: bold;">${eur(result.total_energia)}</td>
                    </tr>
                    
                    <tr>
                        <td style="padding: 15px 40px; padding-top: 20px; font-size: 15px; font-weight: bold; color: ${primaryColor};" colspan="2"${tr("SUBTOTAL BASE (P+E)")}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 40px; padding-left: 60px; font-size: 13px;">Imp. Hidrocarburos (â‚¬0,00234 x ${kwh} kWh)</td>
                        <td style="padding: 8px 40px; font-size: 13px; text-align: right;">${eur(result.impuesto_hidrocarburo)}</td>
                    </tr>
                    <tr style="background-color: #f9f9f9;">
                        <td style="padding: 10px 40px; font-size: 14px; font-weight: bold;"${tr("BASE IMPONIBLE")}</td>
                        <td style="padding: 10px 40px; font-size: 14px; text-align: right; font-weight: bold;">${eur(result.total_fijo + result.total_energia + result.impuesto_hidrocarburo)}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 40px; padding-left: 60px; font-size: 13px;">IVA (21%)</td>
                        <td style="padding: 8px 40px; font-size: 13px; text-align: right;">${eur(result.iva)}</td>
                    </tr>
                    <tr style="background-color: ${primaryColor}; color: white;">
                        <td style="padding: 15px 40px; font-size: 16px; font-weight: bold;">TOTAL FACTURA (${dias} DÃAS)</td>
                        <td style="padding: 15px 40px; font-size: 16px; text-align: right; font-weight: bold;">${eur(result.total)}</td>
                    </tr>
                    <tr style="background-color: #f0f0f0;">
                        <td style="padding: 12px 40px; font-size: 14px; font-weight: bold;"${tr("TOTAL AÃ‘O (PROYECTADO)")}</td>
                        <td style="padding: 12px 40px; font-size: 14px; text-align: right; font-weight: bold;">${eur(nuevoAnio)}</td>
                    </tr>
                </table>
                
                <!-- RESUMEN DE AHORRO FINAL -->
                <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 30px;">
                    <tr>
                        <td style="padding: 20px 40px; text-align: center;">
                            <h2 style="margin: 0 0 20px 0; font-size: 24px; color: #333;">${tr('RESUMEN DE AHORRO FINAL')}</h2>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${lightBg}; border: 2px solid ${accentColor}; border-radius: 12px; margin: 0 40px 30px 40px; width: calc(100% - 80px);">
                    <tr>
                        <td style="padding: 30px; text-align: center;">
                            <p style="margin: 0 0 15px 0; font-size: 16px; color: #666;">${tr('TU AHORRO ANUAL ESTIMADO ES:')}</p>
                            <h1 style="margin: 0; font-size: 42px; font-weight: bold; color: #16a34a;">${eur(ahorroAnual)}</h1>
                            <p style="margin: 10px 0 0 0; font-size: 14px; color: #666;">${tr('/ AÃ‘O')}</p>
                        </td>
                    </tr>
                </table>
                
                <!-- PARA CONFIRMAR ESTA OFERTA -->
                <table width="100%" cellpadding="0" cellspacing="0" style="border: 3px solid ${primaryColor}; border-radius: 12px; margin: 30px 40px; width: calc(100% - 80px);">
                    <tr>
                        <td style="padding: 30px; text-align: center;">
                            <p style="margin: 0 0 20px 0; font-size: 18px; font-weight: bold; color: ${primaryColor};">${tr('ðŸ“§ Para confirmar esta oferta:')}</p>
                            <ol style="text-align: left; display: inline-block; font-size: 14px; line-height: 1.8; color: #333;">
                                <li>${tr('Haz clic en el botÃ³n de abajo')}</li>
                                <li>${tr('Se abrirÃ¡ tu cliente de email')}</li>
                                <li><strong style="color: ${primaryColor};">${tr('Adjunta la documentaciÃ³n requerida')}</strong></li>
                                <li>${tr('EnvÃ­a el email')}</li>
                            </ol>
                            
                            <table cellpadding="0" cellspacing="0" style="margin: 20px auto;">
                                <tr>
                                    <td style="background-color: #dc2626; border-radius: 8px; text-align: center;">
                                        <a href="mailto:contratacion@example.com?subject=ConfirmaciÃ³n Oferta GAS - ${tariffName}&body=Adjunto documentaciÃ³n requerida para confirmar la oferta." style="display: inline-block; padding: 15px 40px; color: white; text-decoration: none; font-weight: bold; font-size: 16px;">
                                            ${tr('âœ… CONFIRMAR Y ENVIAR')}
                                        </a>
                                    </td>
                                </tr>
                            </table>
                            
                            <p style="margin: 20px 0 0 0; font-size: 12px; color: #888;">ðŸ“Ž <strong>DocumentaciÃ³n necesaria:</strong><br>DNI/CIF Â· Ãšltima factura Â· Email Â· TelÃ©fono Â· IBAN</p>
                        </td>
                    </tr>
                </table>
                
                <!-- FOOTER -->
                <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 30px; padding: 20px 40px; background-color: #f5f5f5;">
                    <tr>
                        <td style="text-align: center; font-size: 12px; color: #888;">
                            <p style="margin: 0;">[Colaborador: zdvxzc] | Este resumen es una simulaciÃ³n basada en su Ãºltima factura.</p>
                        </td>
                    </tr>
                </table>
                
            </div>
            `;
            
            showHTMLPreview(htmlContent);
        }
        
        // FunciÃ³n para generar HTML comparativo (Fija vs Indexada)
        function generateGasHTMLComparison(results, dias, kwh, totalCliente) {
            const eur = n => new Intl.NumberFormat('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(n || 0) + ' â‚¬';
            const num = (n, d=6) => new Intl.NumberFormat('es-ES', {minimumFractionDigits: d, maximumFractionDigits: d}).format(n || 0);
            
            // Determinar marca (DRK o POWER CUP)
            const comparisonMode = document.querySelector('input[name="comparison_mode"]:checked').value;
            const isDrk = (comparisonMode === 'drk_only' || comparisonMode === 'drk_prioritized');
            
            // Colores segÃºn marca
            const primaryColor = isDrk ? '#3b5875' : '#4d7c0f';
            const accentColor = isDrk ? '#4a90e2' : '#84cc16';
            const lightBg = isDrk ? '#e8f4fd' : '#f0fdf4';
            const brandName = isDrk ? 'DRK' : 'POWER CUP';
            
            // Identificar cuÃ¡l es fija y cuÃ¡l indexada
            const resFijo = results.find(r => r.name.includes('FIJO') || r.name.includes('META')) || results[0];
            const resIndexed = results.find(r => r.name.includes('INDEX')) || results[1];
            
            console.log('ðŸ” DEBUG HTML GAS COMPARATIVO - resFijo.name:', resFijo.name, 'resIndexed.name:', resIndexed.name);
            
            // Calcular valores anuales
            const facturaActualAnio = totalCliente * 365 / dias;
            
            const htmlContent = `
            <div style="font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; background: white;">
                
                <!-- HEADER -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white;">
                    <tr>
                        <td style="padding: 30px 40px;">
                            <h1 style="margin: 0; font-size: 32px; font-weight: bold;">${brandName} ENERGÃA</h1>
                            <p style="margin: 8px 0 0 0; font-size: 14px;">${tr('Liderando el ahorro y la eficiencia energÃ©tica.')}</p>
                        </td>
                        <td style="padding: 30px 40px; text-align: right;">
                            <p style="margin: 0; font-size: 14px; font-weight: bold;">${tr('ESTUDIO DE AHORRO')}</p>
                            <p style="margin: 4px 0 0 0; font-size: 16px; font-weight: bold;">${tr('COMPARATIVA PROFESIONAL')}</p>
                        </td>
                    </tr>
                </table>
                
                <!-- SECCIÃ“N 1: LA MEJOR OPCIÃ“N Y COMPARATIVA 3 COLUMNAS -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 20px;">
                    <tr>
                        <td style="padding: 25px 40px; text-align: center;">
                            <p style="margin: 0 0 10px 0; font-size: 16px;"${tr("LA MEJOR OPCIÃ“N PARA TI ES")}</p>
                            <h2 style="margin: 0; font-size: 36px; font-weight: bold;">${brandName}</h2>
                            <p style="margin: 10px 0 0 0; font-size: 14px;">${tr('Ofrece el mayor ahorro consolidado con')} ${brandName}.</p>
                        </td>
                    </tr>
                </table>
                
                <!-- COMPARATIVA 3 COLUMNAS: FACTURA ACTUAL vs FIJO vs INDEXADO -->
                <table width="100%" cellpadding="20" cellspacing="0" style="margin-top: 30px;">
                    <tr>
                        <!-- COLUMNA 1: FACTURA ACTUAL -->
                        <td style="width: 30%; vertical-align: top; text-align: center;">
                            <p style="margin: 0 0 15px 0; font-size: 13px; color: #888; font-weight: bold;"${tr("TU FACTURA ACTUAL")}</p>
                            <h2 style="margin: 0; font-size: 24px; font-weight: bold; color: #dc2626; text-decoration: line-through;">${eur(totalCliente)}</h2>
                            <p style="margin: 8px 0; font-size: 11px; color: #888;"${tr("Total Periodo")}</p>
                            <h2 style="margin: 0; font-size: 22px; font-weight: bold; color: #dc2626; text-decoration: line-through;">${eur(facturaActualAnio)}/aÃ±o</h2>
                        </td>
                        
                        <!-- COLUMNA 2: AHORRO FIJO -->
                        <td style="width: 35%; vertical-align: top;">
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${accentColor}; border-radius: 8px;">
                                <tr>
                                    <td style="padding: 10px; text-align: center; color: white;">
                                        <p style="margin: 0; font-size: 11px; font-weight: bold;">${tr("TU AHORRO ANUAL FIJO")}</p>
                                    </td>
                                </tr>
                            </table>
                            <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 10px;">
                                <tr>
                                    <td style="text-align: center;">
                                        <h2 style="margin: 0; font-size: 28px; font-weight: bold; color: #16a34a;">${eur(resFijo.ahorro_anual)}</h2>
                                    </td>
                                </tr>
                            </table>
                            <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 10px;">
                                <tr>
                                    <td style="text-align: center;">
                                        <p style="margin: 0 0 5px 0; font-size: 11px; color: #666;">${tr('TU NUEVO COSTE')} ${brandName}</p>
                                        <p style="margin: 0; font-size: 18px; font-weight: bold; color: ${primaryColor};">${eur(resFijo.total * 30 / dias)}${tr("/mes")}</p>
                                        <p style="margin: 5px 0 0 0; font-size: 10px; color: #888;"${tr("Estimado Mensual")}</p>
                                        <p style="margin: 5px 0 0 0; font-size: 16px; font-weight: bold; color: ${primaryColor};">${eur(resFijo.total * 365 / dias)}${tr("/aÃ±o")}</p>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        
                        <!-- COLUMNA 3: AHORRO INDEXADO -->
                        <td style="width: 35%; vertical-align: top;">
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #16a34a; border-radius: 8px;">
                                <tr>
                                    <td style="padding: 10px; text-align: center; color: white;">
                                        <p style="margin: 0; font-size: 11px; font-weight: bold;">${tr("TU AHORRO ANUAL INDEXADO")}</p>
                                    </td>
                                </tr>
                            </table>
                            <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 10px;">
                                <tr>
                                    <td style="text-align: center;">
                                        <h2 style="margin: 0; font-size: 28px; font-weight: bold; color: #16a34a;">${eur(resIndexed.ahorro_anual)}</h2>
                                    </td>
                                </tr>
                            </table>
                            <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 10px;">
                                <tr>
                                    <td style="text-align: center;">
                                        <p style="margin: 0 0 5px 0; font-size: 11px; color: #666;">${tr('TU NUEVO COSTE')} ${brandName}</p>
                                        <p style="margin: 0; font-size: 18px; font-weight: bold; color: #16a34a;">${eur(resIndexed.total * 30 / dias)}${tr("/mes")}</p>
                                        <p style="margin: 5px 0 0 0; font-size: 10px; color: #888;"${tr("Estimado Mensual")}</p>
                                        <p style="margin: 5px 0 0 0; font-size: 16px; font-weight: bold; color: #16a34a;">${eur(resIndexed.total * 365 / dias)}${tr("/aÃ±o")}</p>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
                
                <!-- SECCIÃ“N 2: DESGLOSE DETALLADO POR SUMINISTRO -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 40px;">
                    <tr>
                        <td style="padding: 15px 40px; text-align: center;">
                            <h2 style="margin: 0; font-size: 18px; font-weight: bold;">DESGLOSE DETALLADO POR SUMINISTRO</h2>
                        </td>
                    </tr>
                </table>
                
                <!-- COMPARATIVA LADO A LADO -->
                <table width="100%" cellpadding="20" cellspacing="0" style="margin-top: 20px;">
                    <tr>
                        <!-- COLUMNA IZQUIERDA: FIJA -->
                        <td style="width: 48%; vertical-align: top;">
                            
                            <!-- Header Fija -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; border-radius: 8px; margin-bottom: 15px;">
                                <tr>
                                    <td style="padding: 15px;">
                                        <p style="margin: 0 0 5px 0; font-size: 11px;">[ES0021000020679723GY]</p>
                                        <p style="margin: 0 0 5px 0; font-size: 13px; font-weight: bold;">Tipo: 2.0TD | DÃ­as: ${dias}</p>
                                        <p style="margin: 0; font-size: 12px; font-weight: bold;">${resFijo.descripcion ? resFijo.name + ' - ' + resFijo.descripcion : resFijo.name}</p>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- Precios Aplicados Fija -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #6c7a89; color: white; margin-bottom: 10px;">
                                <tr>
                                    <td style="padding: 10px; font-size: 12px; font-weight: bold;">PRECIOS APLICADOS:</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f8fafc; padding: 10px; border: 1px solid #e0e0e0;">
                                <tr>
                                    <td style="font-size: 11px; font-weight: bold; padding: 5px;">POTENCIA:</td>
                                </tr>
                                <tr>
                                    <td style="font-size: 10px; padding: 2px 5px;">P1: ${num(resFijo.p_fijo_diario / 365)} â‚¬/kW/dÃ­a</td>
                                </tr>
                                <tr>
                                    <td style="font-size: 11px; font-weight: bold; padding: 5px; padding-top: 10px;">ENERGÃA:</td>
                                </tr>
                                <tr>
                                    <td style="font-size: 10px; padding: 2px 5px;">E1: ${num(resFijo.p1_price)} â‚¬/kWh</td>
                                </tr>
                            </table>
                            
                            <!-- Desglose Fija -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #6c7a89; color: white; margin-top: 10px;">
                                <tr>
                                    <td style="padding: 10px; font-size: 12px; font-weight: bold;">POTENCIA</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f8fafc; border: 1px solid #e0e0e0; border-top: none;">
                                <tr>
                                    <td style="padding: 8px; font-size: 11px;">Precio fijo (${dias} dÃ­as)</td>
                                    <td style="padding: 8px; font-size: 11px; text-align: right; font-weight: bold;">${eur(resFijo.total_fijo)}</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #6c7a89; color: white; margin-top: 10px;">
                                <tr>
                                    <td style="padding: 10px; font-size: 12px; font-weight: bold;">ENERGÃA</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f8fafc; border: 1px solid #e0e0e0; border-top: none;">
                                <tr>
                                    <td style="padding: 8px; font-size: 11px;">EnergÃ­a (${kwh} kWh)</td>
                                    <td style="padding: 8px; font-size: 11px; text-align: right; font-weight: bold;">${eur(resFijo.total_energia)}</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 10px;">
                                <tr>
                                    <td style="padding: 12px; font-size: 13px; font-weight: bold;">TOTAL (${dias} DÃAS)</td>
                                    <td style="padding: 12px; font-size: 13px; text-align: right; font-weight: bold;">${eur(resFijo.total)}</td>
                                </tr>
                            </table>
                            
                            <!-- Ahorro Anual Fija -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #dc2626; border-radius: 8px; margin-top: 15px;">
                                <tr>
                                    <td style="padding: 15px; text-align: center; color: white;">
                                        <p style="margin: 0 0 8px 0; font-size: 11px; font-weight: bold;">AHORRO:</p>
                                        <p style="margin: 0; font-size: 20px; font-weight: bold;">${eur(resFijo.ahorro_anual)}</p>
                                    </td>
                                </tr>
                            </table>
                            
                        </td>
                        
                        <!-- COLUMNA DERECHA: INDEXADA -->
                        <td style="width: 48%; vertical-align: top;">
                            
                            <!-- Header Indexada -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; border-radius: 8px; margin-bottom: 15px;">
                                <tr>
                                    <td style="padding: 15px;">
                                        <p style="margin: 0 0 5px 0; font-size: 11px;">[ES0021000020679723GY]</p>
                                        <p style="margin: 0 0 5px 0; font-size: 13px; font-weight: bold;">Tipo: 2.0TD | DÃ­as: ${dias}</p>
                                        <p style="margin: 0; font-size: 12px; font-weight: bold;">${resIndexed.descripcion ? resIndexed.name + ' - ' + resIndexed.descripcion : resIndexed.name}</p>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- Precios Aplicados Indexada -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #6c7a89; color: white; margin-bottom: 10px;">
                                <tr>
                                    <td style="padding: 10px; font-size: 12px; font-weight: bold;">PRECIOS APLICADOS:</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f8fafc; padding: 10px; border: 1px solid #e0e0e0;">
                                <tr>
                                    <td style="font-size: 11px; font-weight: bold; padding: 5px;">POTENCIA:</td>
                                </tr>
                                <tr>
                                    <td style="font-size: 10px; padding: 2px 5px;">P1: ${num(resIndexed.p_fijo_diario / 365)} â‚¬/kW/dÃ­a</td>
                                </tr>
                                <tr>
                                    <td style="font-size: 11px; font-weight: bold; padding: 5px; padding-top: 10px;">ENERGÃA:</td>
                                </tr>
                                <tr>
                                    <td style="font-size: 10px; padding: 2px 5px;">E1: ${num(resIndexed.p1_price)} â‚¬/kWh</td>
                                </tr>
                            </table>
                            
                            <!-- Desglose Indexada -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #6c7a89; color: white; margin-top: 10px;">
                                <tr>
                                    <td style="padding: 10px; font-size: 12px; font-weight: bold;">POTENCIA</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f8fafc; border: 1px solid #e0e0e0; border-top: none;">
                                <tr>
                                    <td style="padding: 8px; font-size: 11px;">Precio fijo (${dias} dÃ­as)</td>
                                    <td style="padding: 8px; font-size: 11px; text-align: right; font-weight: bold;">${eur(resIndexed.total_fijo)}</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #6c7a89; color: white; margin-top: 10px;">
                                <tr>
                                    <td style="padding: 10px; font-size: 12px; font-weight: bold;">ENERGÃA</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f8fafc; border: 1px solid #e0e0e0; border-top: none;">
                                <tr>
                                    <td style="padding: 8px; font-size: 11px;">EnergÃ­a (${kwh} kWh)</td>
                                    <td style="padding: 8px; font-size: 11px; text-align: right; font-weight: bold;">${eur(resIndexed.total_energia)}</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 10px;">
                                <tr>
                                    <td style="padding: 12px; font-size: 13px; font-weight: bold;">TOTAL (${dias} DÃAS)</td>
                                    <td style="padding: 12px; font-size: 13px; text-align: right; font-weight: bold;">${eur(resIndexed.total)}</td>
                                </tr>
                            </table>
                            
                            <!-- Ahorro Anual Indexada -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #dc2626; border-radius: 8px; margin-top: 15px;">
                                <tr>
                                    <td style="padding: 15px; text-align: center; color: white;">
                                        <p style="margin: 0 0 8px 0; font-size: 11px; font-weight: bold;">AHORRO:</p>
                                        <p style="margin: 0; font-size: 20px; font-weight: bold;">${eur(resIndexed.ahorro_anual)}</p>
                                    </td>
                                </tr>
                            </table>
                            
                        </td>
                    </tr>
                </table>
                
                <!-- SECCIÃ“N 3: CUAL ES LA DIFERENCIA -->
                <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 40px;">
                    <tr>
                        <td style="padding: 20px 40px; text-align: center;">
                            <h2 style="margin: 0; font-size: 24px; font-weight: bold;">CUAL ES LA DIFERENCIA?</h2>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="20" cellspacing="0">
                    <tr>
                        <!-- COLUMNA IZQUIERDA: POR QUE TARIFA FIJA -->
                        <td style="width: 48%; vertical-align: top;">
                            <h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: bold; color: ${accentColor};">POR QUE TARIFA FIJA?</h3>
                            <ul style="margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.8; color: #333;">
                                <li>Implica un precio fijo por los kilovatios que consumes (kWh).</li>
                                <li>El precio se mantiene estable, independientemente de cÃ³mo se comporten los precios en el mercado elÃ©ctrico.</li>
                                <li>Cuando el precio del mercado estÃ¡ alto, el cliente estÃ¡ protegido frente a sobresaltos.</li>
                                <li>No tendrÃ¡s que estar pendiente de las variaciones del mercado y podrÃ¡s seguir usando la electricidad como siempre.</li>
                            </ul>
                        </td>
                        
                        <!-- COLUMNA DERECHA: POR QUE TARIFA INDEXADA -->
                        <td style="width: 48%; vertical-align: top;">
                            <h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: bold; color: #16a34a;">POR QUE TARIFA INDEXADA?</h3>
                            <ul style="margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.8; color: #333;">
                                <li>Implica un precio variable por los kilovatios que consumes (kWh) cada mes.</li>
                                <li>Es la tarifa mÃ¡s justa, ya que pagas el coste real de la energÃ­a mes a mes.</li>
                                <li>Al contratarla, el cliente evita pagar mÃ¡rgenes adicionales cuando el precio de la electricidad es mÃ¡s barato.</li>
                                <li>A largo plazo, con un indexado 100% funcional, se puede obtener un ahorro aproximado de hasta un 20% en Ã©pocas de mejor precio.</li>
                            </ul>
                        </td>
                    </tr>
                </table>
                
                <!-- SECCIÃ“N 4: PARA FORMALIZAR ESTA OFERTA -->
                <table width="100%" cellpadding="0" cellspacing="0" style="border: 3px solid ${accentColor}; border-radius: 12px; margin: 30px 40px 40px 40px; width: calc(100% - 80px);">
                    <tr>
                        <td style="padding: 30px; text-align: center;">
                            <p style="margin: 0 0 20px 0; font-size: 18px; font-weight: bold; color: ${primaryColor};">${tr('ðŸ“§ Para confirmar esta oferta:')}</p>
                            <ol style="text-align: left; display: inline-block; font-size: 14px; line-height: 2; color: #333; margin: 0 0 20px 0;">
                                <li>${tr('Haz clic en el botÃ³n de abajo')}</li>
                                <li>${tr('Se abrirÃ¡ tu cliente de email')}</li>
                                <li><strong style="color: ${primaryColor};">${tr('Adjunta la documentaciÃ³n requerida')}</strong></li>
                                <li>${tr('EnvÃ­a el email')}</li>
                            </ol>
                            
                            <table cellpadding="0" cellspacing="0" style="margin: 20px auto;">
                                <tr>
                                    <td style="background-color: #dc2626; border-radius: 8px; text-align: center;">
                                        <a href="mailto:contratacion@example.com?subject=ConfirmaciÃ³n Oferta GAS Comparativa&body=Adjunto documentaciÃ³n requerida." style="display: inline-block; padding: 15px 40px; color: white; text-decoration: none; font-weight: bold; font-size: 16px;">
                                            ${tr('âœ… CONFIRMAR Y ENVIAR')}
                                        </a>
                                    </td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f5f5f5; border-radius: 8px; margin-top: 20px;">
                                <tr>
                                    <td style="padding: 15px; text-align: center;">
                                        <p style="margin: 0; font-size: 11px; color: #888;">ðŸ“Ž Por cada CUPS adjuntar:</p>
                                        <p style="margin: 5px 0 0 0; font-size: 12px; color: #333;">DNI/CIF Â· Ãšltima factura Â· Email Â· TelÃ©fono Â· IBAN</p>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
                
            </div>
            `;
            
            showHTMLPreview(htmlContent);
        }
        
        // FunciÃ³n para mostrar el preview HTML y permitir copiar
        function showHTMLPreview(htmlContent) {
            // Detectar idioma actual
            const currentLang = window.LANG ? window.LANG.getCurrentLang() : 'es';
            const isChineseMode = currentLang === 'zh';
            
            // Crear modal si no existe
            let modal = document.getElementById('html-preview-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'html-preview-modal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: none; overflow: auto; padding: 20px;';
                document.body.appendChild(modal);
            }
            
            // Construir HTML segÃºn idioma
            if (isChineseMode) {
                // MODO CHINO: Solo botÃ³n "Seleccionar Todo"
                modal.innerHTML = `
                    <div style="max-width: 900px; margin: 0 auto; position: relative;">
                        <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h2 style="margin: 0; color: #0c4a6e;">ðŸ“§ HTMLé‚®ä»¶æ ¼å¼ - å¤©ç„¶æ°”</h2>
                                <button onclick="closeHTMLPreview()" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px;">âœ• å…³é—­</button>
                            </div>
                            <p style="margin: 0 0 15px 0; color: #64748b; font-size: 14px; line-height: 1.6;">
                                <strong>ðŸ“‹ è¯´æ˜Žï¼š</strong><br>
                                ç‚¹å‡»æŒ‰é’®é€‰æ‹©æ‰€æœ‰å†…å®¹ï¼Œç„¶åŽæŒ‰Ctrl+Cï¼ˆWindows/Linuxï¼‰æˆ–Cmd+Cï¼ˆMacï¼‰è¿›è¡Œå¤åˆ¶
                            </p>
                            <button onclick="selectAllContent()" style="background: #f59e0b; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; width: 100%;">
                                âœ¨ å…¨é€‰
                            </button>
                        </div>
                        
                        <!-- Preview del HTML -->
                        <div id="html-preview-content" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                            ${htmlContent}
                        </div>
                    </div>
                `;
            } else {
                // MODO NORMAL: Ambos botones (como estaba antes)
                modal.innerHTML = `
                    <div style="max-width: 900px; margin: 0 auto; position: relative;">
                        <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h2 style="margin: 0; color: #0c4a6e;">ðŸ“§ HTML para Email - GAS</h2>
                                <button onclick="closeHTMLPreview()" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px;">âœ• Cerrar</button>
                            </div>
                            <p style="margin: 0 0 15px 0; color: #64748b; font-size: 14px; line-height: 1.6;">
                                <strong>ðŸ“‹ Instrucciones:</strong><br>
                                <span style="color: #16a34a; font-weight: bold;">OPCIÃ“N 1:</span> Haz clic en "Copiar HTML" (automÃ¡tico)<br>
                                <span style="color: #f59e0b; font-weight: bold;">OPCIÃ“N 2:</span> Si no funciona, usa "Seleccionar Todo" y luego Ctrl+C
                            </p>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <button onclick="copyHTMLToClipboard()" style="background: #0ea5e9; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">
                                    ðŸ“‹ Copiar HTML
                                </button>
                                <button onclick="selectAllContent()" style="background: #f59e0b; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">
                                    âœ¨ Seleccionar Todo
                                </button>
                            </div>
                        </div>
                        
                        <!-- Preview del HTML -->
                        <div id="html-preview-content" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                            ${htmlContent}
                        </div>
                    </div>
                `;
            }
            
            modal.style.display = 'block';
            
            // Guardar el HTML content para copiar
            window.currentHTMLContent = htmlContent;
        }
        
        // FunciÃ³n para seleccionar todo el contenido
        window.selectAllContent = function() {
            const contentDiv = document.getElementById('html-preview-content');
            if (!contentDiv) return;
            
            const range = document.createRange();
            range.selectNodeContents(contentDiv);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            // Cambiar el botÃ³n para indicar que ya estÃ¡ seleccionado
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'âœ… Â¡Seleccionado! Ahora Ctrl+C';
            btn.style.background = '#16a34a';
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '#f59e0b';
            }, 3000);
            
            // Mostrar alerta con instrucciones
            setTimeout(() => {
                alert('âœ… Contenido seleccionado\n\nðŸ“‹ Ahora presiona:\nâ€¢ Ctrl+C (Windows/Linux)\nâ€¢ Cmd+C (Mac)\n\nLuego pega en tu correo con Ctrl+V');
            }, 100);
        };
        
        // FunciÃ³n para cerrar el preview
        window.closeHTMLPreview = function() {
            const modal = document.getElementById('html-preview-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        };
        
        // FunciÃ³n para copiar HTML al portapapeles
        window.copyHTMLToClipboard = async function() {
            try {
                const currentLang = localStorage.getItem('appLanguage') || 'es';
                let htmlContent;
                
                // NUEVO: Para CHINO, copiar directamente el DOM visible (ya traducido)
                if (currentLang === 'zh') {
                    console.log('ðŸ‡¨ðŸ‡³ Modo chino detectado - copiando DOM visible');
                    
                    // Detectar si estamos en pantalla de GAS o ELECTRICIDAD
                    const gasContainer = document.getElementById('gas-results-container');
                    const isGasScreen = gasContainer && gasContainer.innerHTML.trim().length > 100;
                    
                    if (isGasScreen) {
                        // ===== MODO GAS =====
                        console.log('ðŸ”¥ Pantalla GAS detectada');
                        
                        if (!gasContainer || gasContainer.innerHTML.trim().length < 100) {
                            alert('æ²¡æœ‰è¦å¤åˆ¶çš„ç»“æžœ / No results to copy');
                            return;
                        }
                        
                        // Crear HTML completo para GAS con estilos embebidos
                        htmlContent = `
                            <!DOCTYPE html>
                            <html lang="zh">
                            <head>
                                <meta charset="UTF-8">
                                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                                <title>DRK èƒ½æº - GAS æ¯”è¾ƒç»“æžœ</title>
                                <style>
                                    body { font-family: Arial, sans-serif; padding: 20px; background: #f1f5f9; }
                                    .container { max-width: 900px; margin: 0 auto; }
                                    .header { background: linear-gradient(135deg, #f97316 0%, #dc2626 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
                                    .content { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
                                    h1 { margin: 0; font-size: 36px; font-weight: 900; }
                                    h2 { color: #1e293b; font-size: 24px; font-weight: bold; margin: 20px 0 10px 0; }
                                    h3 { color: #1e293b; font-size: 18px; font-weight: bold; border-left: 4px solid #f97316; padding-left: 12px; margin: 20px 0 10px 0; }
                                    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
                                    .text-sm { font-size: 14px; }
                                    .text-xs { font-size: 12px; }
                                    .font-bold { font-weight: bold; }
                                    .text-slate-500 { color: #64748b; }
                                    .text-slate-600 { color: #475569; }
                                    .text-slate-700 { color: #334155; }
                                    .text-slate-800 { color: #1e293b; }
                                    .text-slate-900 { color: #0f172a; }
                                    .text-green-600 { color: #16a34a; }
                                    .text-red-600 { color: #dc2626; }
                                    .text-orange-600 { color: #ea580c; }
                                    .border-t { border-top: 1px solid #e2e8f0; padding-top: 8px; margin-top: 8px; }
                                    .flex { display: flex; justify-content: space-between; margin-bottom: 4px; }
                                    .mono { font-family: 'Courier New', monospace; }
                                    .text-center { text-align: center; }
                                    .mb-2 { margin-bottom: 8px; }
                                    .mb-3 { margin-bottom: 12px; }
                                    .mb-4 { margin-bottom: 16px; }
                                    .mb-6 { margin-bottom: 24px; }
                                    .mt-4 { margin-top: 16px; }
                                    .p-4 { padding: 16px; }
                                    .p-6 { padding: 24px; }
                                    .rounded { border-radius: 8px; }
                                    .rounded-lg { border-radius: 10px; }
                                    .rounded-xl { border-radius: 12px; }
                                    .shadow { box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
                                    .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
                                    .bg-white { background-color: white; }
                                    .bg-slate-50 { background-color: #f8fafc; }
                                    .bg-orange-50 { background-color: #fff7ed; }
                                    .bg-green-50 { background-color: #f0fdf4; }
                                    .border { border: 1px solid #e2e8f0; }
                                    .border-2 { border: 2px solid #e2e8f0; }
                                    .border-orange-200 { border-color: #fed7aa; }
                                    .border-green-200 { border-color: #bbf7d0; }
                                </style>
                            </head>
                            <body>
                                <div class="container">
                                    <div class="header">
                                        <h1>ðŸ”¥ DRK èƒ½æº - GAS</h1>
                                        <p style="margin: 10px 0 0 0; opacity: 0.9; font-size: 18px;">ç‡ƒæ°”æ¯”è¾ƒç»“æžœ / Gas Comparison Results</p>
                                    </div>
                                    <div class="content">
                                        ${gasContainer.innerHTML}
                                    </div>
                                </div>
                            </body>
                            </html>
                        `;
                    } else {
                        // ===== MODO ELECTRICIDAD =====
                        console.log('âš¡ Pantalla ELECTRICIDAD detectada');
                        
                        const resultCard = document.getElementById('result-card');
                        const detailsContainer = document.getElementById('details-container');
                        
                        if (!resultCard && !detailsContainer) {
                            alert('æ²¡æœ‰è¦å¤åˆ¶çš„ç»“æžœ / No results to copy');
                            return;
                        }
                        
                        // Crear HTML completo con estilos embebidos para ELECTRICIDAD
                        htmlContent = `
                            <!DOCTYPE html>
                            <html lang="zh">
                            <head>
                                <meta charset="UTF-8">
                                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                                <title>DRK èƒ½æº - æ¯”è¾ƒç»“æžœ</title>
                                <style>
                                    body { font-family: Arial, sans-serif; padding: 20px; background: #f1f5f9; }
                                    .container { max-width: 800px; margin: 0 auto; }
                                    .header { background: linear-gradient(to right, #16a34a, #15803d); color: white; padding: 30px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
                                    .content { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
                                    h1 { margin: 0; font-size: 32px; font-weight: 900; }
                                    h2 { color: #1e293b; font-size: 24px; font-weight: bold; margin: 20px 0 10px 0; }
                                    h3 { color: #1e293b; font-size: 18px; font-weight: bold; border-left: 4px solid #16a34a; padding-left: 12px; margin: 20px 0 10px 0; }
                                    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
                                    .text-sm { font-size: 14px; }
                                    .text-xs { font-size: 12px; }
                                    .font-bold { font-weight: bold; }
                                    .text-slate-500 { color: #64748b; }
                                    .text-slate-700 { color: #334155; }
                                    .text-slate-800 { color: #1e293b; }
                                    .border-t { border-top: 1px solid #e2e8f0; padding-top: 8px; margin-top: 8px; }
                                    .flex { display: flex; justify-content: space-between; margin-bottom: 4px; }
                                    .mono { font-family: 'Courier New', monospace; }
                                    .text-center { text-align: center; }
                                    .mb-4 { margin-bottom: 16px; }
                                    .mb-6 { margin-bottom: 24px; }
                                    .p-6 { padding: 24px; }
                                    .rounded-xl { border-radius: 12px; }
                                    .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
                                </style>
                            </head>
                            <body>
                                <div class="container">
                                    <div class="header">
                                        <h1>DRK èƒ½æº</h1>
                                        <p style="margin: 10px 0 0 0; opacity: 0.9;">å¼•é¢†èŠ‚çœå’Œèƒ½æºæ•ˆçŽ‡</p>
                                    </div>
                                    ${resultCard ? `<div class="content">${resultCard.outerHTML}</div>` : ''}
                                    ${detailsContainer ? `<div class="content">${detailsContainer.outerHTML}</div>` : ''}
                                </div>
                            </body>
                            </html>
                        `;
                    }
                } else {
                    // Para otros idiomas, usar el HTML generado como antes
                    htmlContent = window.currentHTMLContent;
                }
                
                // MÃ‰TODO 1: Intentar con ClipboardItem (navegadores modernos)
                try {
                    const blob = new Blob([htmlContent], { type: 'text/html' });
                    const clipboardItem = new ClipboardItem({
                        'text/html': blob
                    });
                    await navigator.clipboard.write([clipboardItem]);
                    
                    // Mostrar mensaje de Ã©xito (traducido)
                    const btn = event.target;
                    const originalText = btn.textContent;
                    
                    // Mensaje especÃ­fico para chino
                    if (currentLang === 'zh') {
                        btn.textContent = 'âœ… å·²å¤åˆ¶ä¸­æ–‡HTMLï¼ç²˜è´´åˆ°é‚®ä»¶';
                        alert('âœ… æˆåŠŸï¼\n\n' +
                              'HTMLå·²å¤åˆ¶ï¼ˆæ‰€æœ‰æ–‡æœ¬å‡ä¸ºä¸­æ–‡ï¼‰\n' +
                              'HTML copied (all text in Chinese)\n\n' +
                              'æ‚¨å¯ä»¥ï¼š\n' +
                              'You can:\n' +
                              'â€¢ ç²˜è´´åˆ°ç”µå­é‚®ä»¶\n' +
                              '  Paste into email\n' +
                              'â€¢ åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹\n' +
                              '  View in browser\n' +
                              'â€¢ æ‰“å°ä¸ºPDF\n' +
                              '  Print as PDF\n\n' +
                              'å¦‚éœ€ç”ŸæˆPDFæ–‡ä»¶ï¼Œè¯·åˆ‡æ¢åˆ°è‹±è¯­ ðŸ‡¬ðŸ‡§\n' +
                              'For PDF file, switch to English ðŸ‡¬ðŸ‡§');
                    } else {
                        btn.textContent = tr('âœ… Â¡Copiado! Pega en tu email');
                    }
                    
                    btn.style.background = '#16a34a';
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#0ea5e9';
                    }, 3000);
                    
                    return;
                } catch (clipboardError) {
                    console.log('ClipboardItem fallÃ³, intentando mÃ©todo alternativo...');
                }
                
                // MÃ‰TODO 2: Usar execCommand (mÃ¡s compatible)
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;
                tempDiv.style.position = 'fixed';
                tempDiv.style.left = '-9999px';
                tempDiv.contentEditable = true;
                document.body.appendChild(tempDiv);
                
                // Seleccionar el contenido
                const range = document.createRange();
                range.selectNodeContents(tempDiv);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                
                // Copiar
                const success = document.execCommand('copy');
                
                // Limpiar
                selection.removeAllRanges();
                document.body.removeChild(tempDiv);
                
                if (success) {
                    // Mostrar mensaje de Ã©xito
                    const btn = event.target;
                    const originalText = btn.textContent;
                    
                    // Mensaje especÃ­fico para chino
                    if (currentLang === 'zh') {
                        btn.textContent = 'âœ… å·²å¤åˆ¶ä¸­æ–‡HTMLï¼';
                        alert('âœ… æˆåŠŸï¼\n\n' +
                              'HTMLå·²å¤åˆ¶ï¼ˆæ‰€æœ‰æ–‡æœ¬å‡ä¸ºä¸­æ–‡ï¼‰\n' +
                              'HTML copied (all text in Chinese)\n\n' +
                              'æ‚¨å¯ä»¥ï¼š\n' +
                              'You can:\n' +
                              'â€¢ ç²˜è´´åˆ°ç”µå­é‚®ä»¶\n' +
                              '  Paste into email\n' +
                              'â€¢ åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹\n' +
                              '  View in browser\n' +
                              'â€¢ æ‰“å°ä¸ºPDF\n' +
                              '  Print as PDF\n\n' +
                              'å¦‚éœ€ç”ŸæˆPDFæ–‡ä»¶ï¼Œè¯·åˆ‡æ¢åˆ°è‹±è¯­ ðŸ‡¬ðŸ‡§\n' +
                              'For PDF file, switch to English ðŸ‡¬ðŸ‡§');
                    } else {
                        btn.textContent = tr('âœ… Â¡Copiado! Pega en tu email');
                    }
                    
                    btn.style.background = '#16a34a';
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#0ea5e9';
                    }, 3000);
                } else {
                    throw new Error('execCommand fallÃ³');
                }
                
            } catch (err) {
                console.error('Error al copiar:', err);
                
                // Mostrar instrucciones al usuario
                alert('No se pudo copiar automÃ¡ticamente.\n\nâœ… SOLUCIÃ“N:\n\n1. Haz clic derecho sobre el contenido abajo\n2. Selecciona "Copiar"\n3. Pega en tu correo electrÃ³nico\n\nO usa Ctrl+A para seleccionar todo y luego Ctrl+C para copiar.');
            }
        };

        
        // PDF INDIVIDUAL
        async function generateGasPDF_Simple(bestResult, dias, kwh, totalCliente, clientName = '[NOMBRE COMPLETO CLIENTE]', comercialCode = 'D=00', clientAddress = '') {
            console.log('ðŸ­ GAS PDF Simple - ParÃ¡metros recibidos:');
            console.log('  - clientName:', clientName);
            console.log('  - comercialCode:', comercialCode);
            console.log('  - ðŸ  clientAddress:', clientAddress);
            
            window.showMessageModal("â³ Generando PDF... Por favor espere.");
            
            const { jsPDF } = window.jspdf;
            let doc = new jsPDF('p', 'mm', 'a4');
            
            // CRÃTICO: Activar traducciÃ³n automÃ¡tica de textos
            if (window.setupPDFTranslation) {
                doc = window.setupPDFTranslation(doc);
            }
            
            const comparisonMode = document.querySelector('input[name="comparison_mode"]:checked').value;
            const isDrk = (comparisonMode === 'drk_only' || comparisonMode === 'drk_prioritized');
            
            const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            
            const pageWidth = 210;
            const margin = 12;
            let yPos = 0;
            
            // === PÃGINA 1: RESUMEN ===
            
            // CABECERA con degradado gris azulado
            const headerHeight = 55;
            for (let i = 0; i < pageWidth; i++) {
                const ratio = i / pageWidth;
                const r = Math.round(107 + (180 - 107) * ratio);
                const g = Math.round(125 + (190 - 125) * ratio);
                const b = Math.round(142 + (200 - 142) * ratio);
                doc.setFillColor(r, g, b);
                doc.rect(i, 0, 1, headerHeight, 'F');
            }
            
            // Logo DRK (anillo multicolor)
            const logoX = margin + 15;
            const logoY = 18;
            const logoRadius = 8;
            
            doc.setFillColor(219, 68, 55);
            doc.circle(logoX - 1.5, logoY + 1.5, logoRadius * 0.8, 'F');
            doc.setFillColor(66, 133, 244);
            doc.circle(logoX + 1.5, logoY - 1.5, logoRadius * 0.8, 'F');
            doc.setFillColor(244, 180, 0);
            doc.circle(logoX - 1.5, logoY - 1.5, logoRadius * 0.7, 'F');
            doc.setFillColor(15, 157, 88);
            doc.circle(logoX + 1.5, logoY + 1.5, logoRadius * 0.7, 'F');
            doc.setFillColor(255, 255, 255);
            doc.circle(logoX, logoY, logoRadius * 0.4, 'F');
            
            // Texto DRK ENERGÃA
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(24);
            doc.text('DRK', logoX + logoRadius + 6, logoY - 4);
            doc.text('ENERGÃA', logoX + logoRadius + 6, logoY + 5);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text(tr('Liderando el ahorro y la'), logoX + logoRadius + 6, logoY + 13);
            doc.text(tr('eficiencia energÃ©tica.'), logoX + logoRadius + 6, logoY + 18);
            
            // Texto derecha
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(40, 60, 80);
            doc.text(tr('ESTUDIO DE AHORRO'), pageWidth - margin, 15, { align: 'right' });
            doc.setFontSize(16);
            doc.setTextColor(255, 255, 255);
            doc.text('COMPARATIVA', pageWidth - margin, 25, { align: 'right' });
            doc.setFontSize(12);
            doc.setTextColor(100, 120, 140);
            doc.text('PROFESIONAL', pageWidth - margin, 35, { align: 'right' });
            
            yPos = headerHeight + 8;
            
            // CAJA VERDE "ESTUDIO DE AHORRO"
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 10, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text(tr('ESTUDIO DE AHORRO'), margin + 5, yPos + 7);
            
            yPos += 12;
            
            // Info del cliente (caja con borde) - altura aumentada para 4 lÃ­neas
            doc.setDrawColor(76, 175, 80);
            doc.setLineWidth(1.5);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 27, 2, 2, 'S');
            
            doc.setTextColor(75, 85, 99);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('COMPARATIVA PROFESIONAL GAS - DRK', margin + 5, yPos + 6);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text(tr('CLIENTE:') + ' ' + clientName, margin + 5, yPos + 11);
            // Agregar CUPS
            const gasParams = window.gasCalculationParams || {};
            const cups = gasParams.cups || 'N/A';
            doc.text('CUPS: ' + cups, margin + 5, yPos + 16);
            doc.text('TARIFA: ' + currentGasTariff, margin + 5, yPos + 21);
            
            doc.setFont('helvetica', 'bold');
            doc.text('COMERCIAL: ' + comercialCode, pageWidth - margin - 45, yPos + 11);
            
            // DirecciÃ³n debajo del comercial (si existe)
            if (clientAddress) {
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.text(tr('DirecciÃ³n:') + ' ' + clientAddress, pageWidth - margin - 45, yPos + 16);
            }
            
            yPos += 33;
            
            // CAJA GRIS "LA MEJOR OPCIÃ“N"
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 35, 3, 3, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(11);
            doc.text(tr('LA MEJOR OPCIÃ“N PARA TI ES'), pageWidth / 2, yPos + 10, { align: 'center' });
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(20);
            doc.text(bestResult.name.toUpperCase(), pageWidth / 2, yPos + 20, { align: 'center' });
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text(bestResult.descripcion, pageWidth / 2, yPos + 28, { align: 'center' });
            
            yPos += 42;
            
            // AHORRO ANUAL
            doc.setFillColor(255, 255, 255);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 35, 2, 2, 'F');
            
            doc.setTextColor(100, 120, 140);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text(tr('TU AHORRO ANUAL ESTIMADO'), pageWidth / 2, yPos + 8, { align: 'center' });
            
            doc.setTextColor(76, 175, 80);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(36);
            doc.text(eur(bestResult.ahorro_anual), pageWidth / 2, yPos + 25, { align: 'center' });
            
            yPos += 40;
            
            // COMPARATIVA ACTUAL VS NUEVA
            const colWidth = (pageWidth - (2 * margin) - 10) / 2;
            
            // Izquierda: Factura actual
            doc.setTextColor(100, 120, 140);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text(tr('TU FACTURA ACTUAL'), margin + colWidth / 2, yPos, { align: 'center' });
            
            doc.setTextColor(220, 38, 38);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            const facturaActualMes = totalCliente * 30 / dias;
            doc.text(eur(facturaActualMes) + tr('/mes'), margin + colWidth / 2, yPos + 10, { align: 'center' });
            
            // LÃ­nea tachada
            const textWidth = doc.getTextWidth(eur(facturaActualMes) + tr('/mes'));
            doc.setDrawColor(220, 38, 38);
            doc.setLineWidth(1.2);
            doc.line(
                margin + (colWidth - textWidth) / 2,
                yPos + 7,
                margin + (colWidth + textWidth) / 2,
                yPos + 7
            );
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.text(tr('Total Periodo') + ' (' + dias + ' ' + tr('dÃ­as') + ')', margin + colWidth / 2, yPos + 16, { align: 'center' });
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            const facturaActualAnio = totalCliente * 365 / dias;
            doc.text(eur(facturaActualAnio) + tr('/aÃ±o'), margin + colWidth / 2, yPos + 24, { align: 'center' });
            
            const textWidth2 = doc.getTextWidth(eur(facturaActualAnio) + tr('/aÃ±o'));
            doc.line(
                margin + (colWidth - textWidth2) / 2,
                yPos + 21,
                margin + (colWidth + textWidth2) / 2,
                yPos + 21
            );
            
            // Derecha: Nuevo coste
            doc.setTextColor(100, 120, 140);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text(tr('TU NUEVO COSTE DRK'), margin + colWidth + 10 + colWidth / 2, yPos, { align: 'center' });
            
            doc.setTextColor(59, 130, 246);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            const nuevaCosteMes = bestResult.total * 30 / dias;
            doc.text(eur(nuevaCosteMes) + tr('/mes'), margin + colWidth + 10 + colWidth / 2, yPos + 10, { align: 'center' });
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.text(tr('Estimado Mensual'), margin + colWidth + 10 + colWidth / 2, yPos + 16, { align: 'center' });
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            const nuevaCosteAnio = bestResult.total * 365 / dias;
            doc.text(eur(nuevaCosteAnio) + tr('/aÃ±o'), margin + colWidth + 10 + colWidth / 2, yPos + 24, { align: 'center' });
            
            yPos += 32;
            
            // PRECIOS DE LA OFERTA
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 10, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('PRECIOS DE LA OFERTA: DRK - ' + bestResult.descripcion.toUpperCase(), margin + 5, yPos + 7);
            
            yPos += 13;
            
            // TABLA PRECIOS
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 35, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('TÃ‰RMINO FIJO:', margin + 5, yPos + 8);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text('Precio fijo diario (â‚¬/dÃ­a):', margin + 10, yPos + 15);
            doc.text(num(bestResult.p_fijo_diario / 365, 6), pageWidth - margin - 5, yPos + 15, { align: 'right' });
            
            yPos += 20;
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('ENERGÃA:', margin + 5, yPos);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text('Precio energÃ­a (â‚¬/kWh):', margin + 10, yPos + 7);
            doc.text(num(bestResult.p1_price, 6), pageWidth - margin - 5, yPos + 7, { align: 'right' });
            
            // === PÃGINA 2: DESGLOSE ===
            doc.addPage();
            yPos = 15;
            
            // TÃ­tulo verde
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 12, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text(tr('DESGLOSE DETALLADO DE LA SIMULACIÃ“N') + ' (DRK - ' + bestResult.descripcion.toUpperCase() + ')', margin + 5, yPos + 8);
            
            yPos += 18;
            
            // TÃ‰RMINO FIJO
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('TÃ‰RMINO FIJO (Precio en â‚¬/dÃ­a)', margin, yPos);
            yPos += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            const p_fijo_diario = bestResult.p_fijo_diario / 365;
            doc.text(tr('Precio fijo') + ' (' + dias + ' ' + tr('dÃ­as') + ' x ' + num(p_fijo_diario, 6) + ')', margin + 5, yPos);
            doc.text(eur(bestResult.total_fijo), pageWidth - margin - 5, yPos, { align: 'right' });
            yPos += 6;
            
            doc.setFont('helvetica', 'bold');
            doc.text(tr('SUBTOTAL POTENCIA'), margin + 5, yPos);
            doc.text(eur(bestResult.total_fijo), pageWidth - margin - 5, yPos, { align: 'right' });
            yPos += 10;
            
            // TÃ‰RMINO ENERGÃA
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)', margin, yPos);
            yPos += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text('EnergÃ­a (' + kwh + ' kWh x ' + num(bestResult.p1_price, 6) + ')', margin + 5, yPos);
            doc.text(eur(bestResult.total_energia), pageWidth - margin - 5, yPos, { align: 'right' });
            yPos += 6;
            
            doc.setFont('helvetica', 'bold');
            doc.text('Subtotal EnergÃ­a (Bruto)', margin + 5, yPos);
            doc.text(eur(bestResult.total_energia), pageWidth - margin - 5, yPos, { align: 'right' });
            yPos += 10;
            
            // SUBTOTAL BASE
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            const subtotalBase = bestResult.total_fijo + bestResult.total_energia;
            doc.text('SUBTOTAL BASE (P+E)', margin, yPos);
            doc.text(eur(subtotalBase), pageWidth - margin - 5, yPos, { align: 'right' });
            yPos += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text('Imp. Hidrocarburos (â‚¬0,00234 x ' + kwh + ' kWh)', margin, yPos);
            doc.text(eur(bestResult.impuesto_hidrocarburo), pageWidth - margin - 5, yPos, { align: 'right' });
            yPos += 6;
            
            doc.setFont('helvetica', 'bold');
            doc.text(tr('BASE IMPONIBLE'), margin, yPos);
            doc.text(eur(subtotalBase + bestResult.impuesto_hidrocarburo), pageWidth - margin - 5, yPos, { align: 'right' });
            yPos += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.text(tr('IVA (21%)'), margin, yPos);
            doc.text(eur(bestResult.iva), pageWidth - margin - 5, yPos, { align: 'right' });
            yPos += 10;
            
            // TOTAL FACTURA
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(margin, yPos - 3, pageWidth - (2 * margin), 12, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text('TOTAL FACTURA (' + dias + ' DÃAS)', margin + 5, yPos + 5);
            doc.text(eur(bestResult.total), pageWidth - margin - 5, yPos + 5, { align: 'right' });
            
            yPos += 14;
            
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text(tr('TOTAL AÃ‘O (PROYECTADO)'), margin, yPos);
            doc.text(eur(bestResult.total * 365 / dias), pageWidth - margin - 5, yPos, { align: 'right' });
            
            yPos += 15;
            
            // AHORRO
            doc.setFillColor(211, 47, 47);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 25, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text(tr('TU AHORRO ANUAL ESTIMADO ES:'), margin + 5, yPos + 10);
            
            doc.setFontSize(20);
            doc.text(eur(bestResult.ahorro_anual) + tr('/ AÃ‘O'), margin + 5, yPos + 20);
            
            yPos += 35;
            
            // FORMALIZAR CONTRATO
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 60, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text(tr('PARA FORMALIZAR ESTE CONTRATO:'), margin + 5, yPos + 8);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text(tr('Responde a este email adjuntando la siguiente documentaciÃ³n:'), margin + 5, yPos + 15);
            
            const docList = [
                tr('1. Foto del DNI/CIF (anverso y reverso)'),
                tr('2. Ãšltima factura (mÃ­nimo 3 meses de antigÃ¼edad)'),
                tr('3. Email de contacto para validaciÃ³n'),
                tr('4. TelÃ©fono de contacto'),
                tr('5. NÃºmero de cuenta bancaria (IBAN)')
            ];
            
            let listY = yPos + 22;
            docList.forEach(item => {
                doc.text(item, margin + 8, listY);
                listY += 5;
            });
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text(tr('EnvÃ­a la documentaciÃ³n al comercial:'), margin + 5, listY + 5);
            doc.setFontSize(11);
            doc.text('zdc', margin + 5, listY + 11);
            
            // Pie de pÃ¡gina
            doc.setFont('helvetica', 'italic');
            doc.setFontSize(7);
            doc.setTextColor(120, 120, 120);
            doc.text(tr('Documento generado automÃ¡ticamente - DRK EnergÃ­a'), pageWidth / 2, 285, { align: 'center' });
            doc.text('Fecha: ' + new Date().toLocaleDateString('es-ES'), pageWidth / 2, 290, { align: 'center' });
            
            // Descargar
            doc.save('Comparativa_GAS_' + currentGasTariff + '_DRK_' + new Date().toISOString().slice(0,10) + '.pdf');
            
            setTimeout(() => {
                window.showMessageModal("âœ… PDF de GAS generado correctamente");
            }, 500);
        }
        
        // PDF DUAL
        async function generateGasPDF_Dual(resFijo, resIndexed, dias, kwh, totalCliente, clientName = '[NOMBRE COMPLETO CLIENTE]', comercialCode = 'D=00', clientAddress = '') {
            window.showMessageModal("â³ Generando PDF comparativo...");
            const { jsPDF } = window.jspdf;
            let doc = new jsPDF('p', 'mm', 'a4');
            
            // CRÃTICO: Activar traducciÃ³n automÃ¡tica de textos
            if (window.setupPDFTranslation) {
                doc = window.setupPDFTranslation(doc);
            }
            
            const eur = n => new Intl.NumberFormat('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(n || 0) + ' â‚¬';
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', {minimumFractionDigits: d, maximumFractionDigits: d}).format(n || 0);
            
            // PÃGINA 1: DISEÃ‘O PROFESIONAL BONITO
            const pageWidth = 210;
            const pageHeight = 297;
            let y = 0;
            
            // HEADER CON RAYAS VERTICALES (fondo gris con patrÃ³n)
            doc.setFillColor(107, 125, 142);
            doc.rect(0, 0, pageWidth, 40, 'F');
            
            // Rayas verticales mÃ¡s claras
            doc.setDrawColor(120, 140, 155);
            doc.setLineWidth(0.3);
            for (let i = 0; i < pageWidth; i += 2) {
                doc.line(i, 0, i, 40);
            }
            
            // Logo DRK multicolor (izquierda)
            const logoX = 25;
            const logoY = 20;
            const logoR = 8;
            doc.setFillColor(219, 68, 55); // Rojo
            doc.circle(logoX - 2, logoY + 2, logoR * 0.75, 'F');
            doc.setFillColor(66, 133, 244); // Azul
            doc.circle(logoX + 2, logoY - 2, logoR * 0.75, 'F');
            doc.setFillColor(244, 180, 0); // Amarillo
            doc.circle(logoX - 2, logoY - 2, logoR * 0.65, 'F');
            doc.setFillColor(15, 157, 88); // Verde
            doc.circle(logoX + 2, logoY + 2, logoR * 0.65, 'F');
            doc.setFillColor(255, 255, 255); // Centro blanco
            doc.circle(logoX, logoY, logoR * 0.35, 'F');
            
            // Texto DRK ENERGÃA (derecha del logo)
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(24);
            doc.text('DRK', logoX + 15, 16);
            doc.setFontSize(22);
            doc.text('ENERGÃA', logoX + 15, 25);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            doc.text(tr('Liderando el ahorro y la'), logoX + 15, 30);
            doc.text(tr('eficiencia energÃ©tica.'), logoX + 15, 34);
            
            // Texto derecha del header
            doc.setTextColor(40, 60, 80);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text(tr('ESTUDIO DE AHORRO'), pageWidth - 12, 12, { align: 'right' });
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.text('COMPARATIVA', pageWidth - 12, 20, { align: 'right' });
            
            doc.setTextColor(100, 120, 140);
            doc.setFontSize(9);
            doc.text('PROFESIONAL', pageWidth - 12, 28, { align: 'right' });
            
            // === INFORMACIÃ“N DEL CLIENTE (DISEÃ‘O PROFESIONAL) ===
            y = 50;
            
            // Barra superior verde
            doc.setFillColor(76, 175, 80); // Verde
            doc.roundedRect(12, y, 186, 8, 3, 3, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text(tr('ESTUDIO DE AHORRO'), 17, y + 5.5);
            
            // Caja blanca con borde
            doc.setFillColor(255, 255, 255);
            doc.setDrawColor(107, 125, 142);
            doc.setLineWidth(1);
            doc.roundedRect(12, y + 8, 186, 20, 3, 3, 'FD');
            
            // TÃ­tulo principal
            doc.setTextColor(107, 125, 142);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(tr('COMPARATIVA PROFESIONAL') + ' - DRK', 17, y + 14);
            
            // Info del cliente
            doc.setTextColor(80, 80, 80);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text(`CLIENTE: ${clientName}`, 17, y + 20);
            // Usar cups de gasCalculationParams
            const gasParams = window.gasCalculationParams || {};
            const cups = gasParams.cups || 'N/A';
            doc.text(`CUPS: ${cups}`, 17, y + 25);
            
            // Comercial en caja destacada (derecha)
            doc.setFillColor(240, 245, 248);
            doc.roundedRect(pageWidth - 12 - 45, y + 17, 45, 8, 2, 2, 'F');
            doc.setTextColor(107, 125, 142);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text(`COMERCIAL: ${comercialCode}`, pageWidth - 12 - 43, y + 22.5);
            
            // DirecciÃ³n debajo del comercial (si existe)
            console.log('ðŸ” Verificando clientAddress en PDF:', clientAddress);
            console.log('ðŸ” Â¿Es truthy?', !!clientAddress);
            console.log('ðŸ” Tipo:', typeof clientAddress);
            if (clientAddress) {
                console.log('âœ… ENTRANDO en if(clientAddress) - Mostrando direcciÃ³n');
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(7);
                doc.text(tr('DirecciÃ³n:') + ' ' + clientAddress, pageWidth - 12 - 43, y + 27);
                console.log('âœ… DirecciÃ³n aÃ±adida al PDF en posiciÃ³n y=' + (y + 27));
            } else {
                console.log('âŒ NO ENTRANDO en if(clientAddress) - clientAddress es falsy');
            }
            
            y += 35;
            
            // CAJA GRIS "LA MEJOR OPCIÃ“N"
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(40, y, 130, 38, 4, 4, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text(tr('LA MEJOR OPCIÃ“N PARA TI ES'), pageWidth / 2, y + 10, { align: 'center' });
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(28);
            doc.text('DRK', pageWidth / 2, y + 24, { align: 'center' });
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.text(tr('Ofrece el mayor ahorro consolidado con') + ' DRK ENERGÃA.', pageWidth / 2, y + 33, { align: 'center' });
            
            y += 55;
            
            // CÃLCULOS
            const factMes = totalCliente * 30 / dias;
            const factAnio = totalCliente * 365 / dias;
            const fijoMes = resFijo.total * 30 / dias;
            const fijoAnio = resFijo.total * 365 / dias;
            const indexMes = resIndexed.total * 30 / dias;
            const indexAnio = resIndexed.total * 365 / dias;
            
            // LAYOUT 3 COLUMNAS CON SEPARADORES VERTICALES
            const col1X = 12;
            const col2X = 75;
            const col3X = 145;
            
            // LÃ­neas separadoras verticales (muy suaves)
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.3);
            doc.line(70, y - 5, 70, y + 90);
            doc.line(140, y - 5, 140, y + 90);
            
            // COLUMNA 1: TU FACTURA ACTUAL (izquierda)
            doc.setTextColor(70, 80, 90);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text(tr('TU FACTURA ACTUAL'), col1X, y);
            
            y += 10;
            doc.setTextColor(220, 38, 38);
            doc.setFontSize(18);
            const txtMes = eur(factMes);
            doc.text(txtMes, col1X, y);
            
            // LÃ­nea tachada
            const wMes = doc.getTextWidth(txtMes);
            doc.setDrawColor(220, 38, 38);
            doc.setLineWidth(1.8);
            doc.line(col1X, y - 5, col1X + wMes, y - 5);
            
            y += 6;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(6.5);
            doc.setTextColor(120, 130, 140);
            doc.text(tr('Total Periodo') + ' (' + dias + ' ' + tr('dÃ­as') + ')', col1X, y);
            
            y += 10;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(15);
            doc.setTextColor(220, 38, 38);
            const txtAnio = eur(factAnio) + tr('/aÃ±o');
            doc.text(txtAnio, col1X, y);
            
            const wAnio = doc.getTextWidth(txtAnio);
            doc.setDrawColor(220, 38, 38);
            doc.setLineWidth(1.8);
            doc.line(col1X, y - 4, col1X + wAnio, y - 4);
            
            y -= 26;
            
            // COLUMNA 2: TU AHORRO ANUAL FIJO (centro)
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(col2X, y - 4, 60, 9, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(7.5);
            doc.text('TU AHORRO ANUAL FIJO', col2X + 30, y + 2, { align: 'center' });
            
            y += 12;
            doc.setTextColor(76, 175, 80);
            doc.setFontSize(22);
            doc.text(eur(resFijo.ahorro_anual), col2X + 30, y, { align: 'center' });
            
            y += 10;
            doc.setTextColor(100, 110, 120);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text(tr('TU NUEVO COSTE DRK'), col2X + 30, y, { align: 'center' });
            
            y += 8;
            doc.setTextColor(59, 130, 246);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(15);
            doc.text(eur(fijoMes) + tr('/mes'), col2X + 30, y, { align: 'center' });
            
            y += 5;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(6.5);
            doc.setTextColor(120, 130, 140);
            doc.text(tr('Estimado Mensual'), col2X + 30, y, { align: 'center' });
            
            y += 9;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(13);
            doc.setTextColor(59, 130, 246);
            doc.text(eur(fijoAnio) + tr('/aÃ±o'), col2X + 30, y, { align: 'center' });
            
            y -= 44;
            
            // COLUMNA 3: TU AHORRO ANUAL INDEXADO (derecha)
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(col3X, y - 4, 60, 9, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(7.5);
            doc.text('TU AHORRO ANUAL INDEXADO', col3X + 30, y + 2, { align: 'center' });
            
            y += 12;
            doc.setTextColor(76, 175, 80);
            doc.setFontSize(22);
            doc.text(eur(resIndexed.ahorro_anual), col3X + 30, y, { align: 'center' });
            
            y += 10;
            doc.setTextColor(100, 110, 120);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text(tr('TU NUEVO COSTE DRK'), col3X + 30, y, { align: 'center' });
            
            y += 8;
            doc.setTextColor(76, 175, 80);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(15);
            doc.text(eur(indexMes) + tr('/mes'), col3X + 30, y, { align: 'center' });
            
            y += 5;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(6.5);
            doc.setTextColor(120, 130, 140);
            doc.text(tr('Estimado Mensual'), col3X + 30, y, { align: 'center' });
            
            y += 9;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(13);
            doc.setTextColor(76, 175, 80);
            doc.text(eur(indexAnio) + tr('/aÃ±o'), col3X + 30, y, { align: 'center' });
            
            // PÃGINA 2: DESGLOSE DETALLADO
            doc.addPage();
            y = 15;
            
            // TÃ­tulo verde
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(12, y, 186, 12, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('DESGLOSE DETALLADO POR SUMINISTRO', 105, y + 8, { align: 'center' });
            
            y += 18;
            const colW = 90;
            const leftX = 12;
            const rightX = 110;
            
            // COLUMNA IZQUIERDA: FIJA
            let leftY = y;
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(leftX, leftY, colW, 18, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.text(('[' + (window.gasCalculationParams && window.gasCalculationParams.cups ? window.gasCalculationParams.cups : 'N/A') + ']'), leftX + 3, leftY + 5);
            doc.text('Tipo: ' + currentGasTariff, leftX + colW - 3, leftY + 5, { align: 'right' });
            doc.text('DÃ­as: ' + dias, leftX + colW - 3, leftY + 10, { align: 'right' });
            doc.setFontSize(8);
            doc.text('DRK - ' + resFijo.name, leftX + 3, leftY + 13);
            
            leftY += 22;
            // TÃ‰RMINO FIJO
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('TÃ‰RMINO FIJO (Precio en â‚¬/dÃ­a)', leftX, leftY);
            leftY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            const pFijoDiario = resFijo.p_fijo_diario / 365;
            doc.text(tr('Precio fijo') + ' (' + dias + ' ' + tr('dÃ­as') + ' x ' + num(pFijoDiario, 6) + ')', leftX + 3, leftY);
            doc.text(eur(resFijo.total_fijo), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text(tr('SUBTOTAL POTENCIA'), leftX + 3, leftY);
            doc.text(eur(resFijo.total_fijo), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 10;
            
            // TÃ‰RMINO ENERGÃA
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)', leftX, leftY);
            leftY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('EnergÃ­a (' + kwh + ' kWh x ' + num(resFijo.p1_price, 6) + ')', leftX + 3, leftY);
            doc.text(eur(resFijo.total_energia), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text('Subtotal EnergÃ­a (Bruto)', leftX + 3, leftY);
            doc.text(eur(resFijo.total_energia), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 10;
            
            // SUBTOTAL BASE
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            const subtotalBase = resFijo.total_fijo + resFijo.total_energia;
            doc.text('SUBTOTAL BASE (P+E)', leftX, leftY);
            doc.text(eur(subtotalBase), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('Imp. Hidrocarburos (â‚¬0,00234 x ' + kwh + ' kWh)', leftX, leftY);
            doc.text(eur(resFijo.impuesto_hidrocarburo), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text(tr('BASE IMPONIBLE'), leftX, leftY);
            doc.text(eur(subtotalBase + resFijo.impuesto_hidrocarburo), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 5;
            
            doc.setFont('helvetica', 'normal');
            doc.text(tr('IVA (21%)'), leftX, leftY);
            doc.text(eur(resFijo.iva), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 10;
            
            // TOTAL
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(leftX, leftY - 3, colW, 12, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('TOTAL FACTURA (' + dias + ' DÃAS)', leftX + 3, leftY + 5);
            doc.text(eur(resFijo.total), leftX + colW - 3, leftY + 5, { align: 'right' });
            
            leftY += 14;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text(tr('TOTAL AÃ‘O (PROYECTADO)'), leftX, leftY);
            doc.text(eur(resFijo.total * 365 / dias), leftX + colW - 2, leftY, { align: 'right' });
            
            leftY += 12;
            doc.setFillColor(211, 47, 47);
            doc.roundedRect(leftX, leftY, colW, 18, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.text(tr('TU AHORRO ANUAL ESTIMADO ES:'), leftX + 3, leftY + 8);
            doc.setFontSize(13);
            doc.text(eur(resFijo.ahorro_anual) + tr('/ AÃ‘O'), leftX + 3, leftY + 15);
            
            // COLUMNA DERECHA: INDEXADA
            let rightY = y;
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(rightX, rightY, colW, 18, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.text(('[' + (window.gasCalculationParams && window.gasCalculationParams.cups ? window.gasCalculationParams.cups : 'N/A') + ']'), rightX + 3, rightY + 5);
            doc.text('Tipo: ' + currentGasTariff, rightX + colW - 3, rightY + 5, { align: 'right' });
            doc.text('DÃ­as: ' + dias, rightX + colW - 3, rightY + 10, { align: 'right' });
            doc.setFontSize(8);
            doc.text('DRK INDEX - ' + resIndexed.name, rightX + 3, rightY + 13);
            
            rightY += 22;
            // TÃ‰RMINO FIJO
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('TÃ‰RMINO FIJO (Precio en â‚¬/dÃ­a)', rightX, rightY);
            rightY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            const pIndexDiario = resIndexed.p_fijo_diario / 365;
            doc.text(tr('Precio fijo') + ' (' + dias + ' ' + tr('dÃ­as') + ' x ' + num(pIndexDiario, 6) + ')', rightX + 3, rightY);
            doc.text(eur(resIndexed.total_fijo), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text(tr('SUBTOTAL POTENCIA'), rightX + 3, rightY);
            doc.text(eur(resIndexed.total_fijo), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 10;
            
            // TÃ‰RMINO ENERGÃA
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)', rightX, rightY);
            rightY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('EnergÃ­a (' + kwh + ' kWh x ' + num(resIndexed.p1_price, 6) + ')', rightX + 3, rightY);
            doc.text(eur(resIndexed.total_energia), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text('Subtotal EnergÃ­a (Bruto)', rightX + 3, rightY);
            doc.text(eur(resIndexed.total_energia), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 10;
            
            // SUBTOTAL BASE
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            const subtotalBaseIndex = resIndexed.total_fijo + resIndexed.total_energia;
            doc.text('SUBTOTAL BASE (P+E)', rightX, rightY);
            doc.text(eur(subtotalBaseIndex), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('Imp. Hidrocarburos (â‚¬0,00234 x ' + kwh + ' kWh)', rightX, rightY);
            doc.text(eur(resIndexed.impuesto_hidrocarburo), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text(tr('BASE IMPONIBLE'), rightX, rightY);
            doc.text(eur(subtotalBaseIndex + resIndexed.impuesto_hidrocarburo), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 5;
            
            doc.setFont('helvetica', 'normal');
            doc.text(tr('IVA (21%)'), rightX, rightY);
            doc.text(eur(resIndexed.iva), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 10;
            
            // TOTAL
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(rightX, rightY - 3, colW, 12, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('TOTAL FACTURA (' + dias + ' DÃAS)', rightX + 3, rightY + 5);
            doc.text(eur(resIndexed.total), rightX + colW - 3, rightY + 5, { align: 'right' });
            
            rightY += 14;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text(tr('TOTAL AÃ‘O (PROYECTADO)'), rightX, rightY);
            doc.text(eur(resIndexed.total * 365 / dias), rightX + colW - 2, rightY, { align: 'right' });
            
            rightY += 12;
            doc.setFillColor(211, 47, 47);
            doc.roundedRect(rightX, rightY, colW, 18, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.text(tr('TU AHORRO ANUAL ESTIMADO ES:'), rightX + 3, rightY + 8);
            doc.setFontSize(13);
            doc.text(eur(resIndexed.ahorro_anual) + tr('/ AÃ‘O'), rightX + 3, rightY + 15);
            
            // PÃGINA 3: CUAL ES LA DIFERENCIA
            doc.addPage();
            y = 40;
            
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            doc.text('CUAL ES LA DIFERENCIA?', 105, y, { align: 'center' });
            
            y += 15;
            
            // Columna izquierda: FIJA
            doc.setTextColor(59, 130, 246);
            doc.setFontSize(12);
            doc.text(tr('POR QUE TARIFA FIJA?'), leftX, y);
            
            y += 8;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            const fijaTexts = [
                'â€¢ Implica un precio fijo por los kilovatios que',
                '  consumes (kWh).',
                '',
                'â€¢ El precio se mantiene estable,',
                '  independientemente de cÃ³mo se comporten los',
                '  precios en el mercado elÃ©ctrico.',
                '',
                'â€¢ Cuando el precio del mercado estÃ¡ alto, el',
                '  cliente estÃ¡ protegido frente a sobresaltos.',
                '',
                'â€¢ No tendrÃ¡s que estar pendiente de las',
                '  variaciones del mercado y podrÃ¡s seguir',
                '  usando la electricidad como siempre.'
            ];
            
            fijaTexts.forEach(line => {
                doc.text(tr(line), leftX, y);
                y += 4;
            });
            
            y = 55;
            
            // Columna derecha: INDEXADA
            doc.setTextColor(76, 175, 80);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text(tr('POR QUE TARIFA INDEXADA?'), rightX, y);
            
            y += 8;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            const indexTexts = [
                'â€¢ Implica un precio variable por los kilovatios',
                '  que consumes (kWh) cada mes.',
                '',
                'â€¢ Es la tarifa mÃ¡s justa, ya que pagas el coste',
                '  real de la energÃ­a mes a mes.',
                '',
                'â€¢ Al contratarla, el cliente evita pagar',
                '  mÃ¡rgenes adicionales cuando el precio de la',
                '  electricidad es mÃ¡s barato.',
                '',
                'â€¢ A largo plazo, con un indexado 100%',
                '  funcional, se puede obtener un ahorro',
                '  aproximado de hasta un 20% en Ã©pocas de',
                '  mejor precio.'
            ];
            
            indexTexts.forEach(line => {
                doc.text(tr(line), rightX, y);
                y += 4;
            });
            
            doc.save('GAS_Dual_' + currentGasTariff + '.pdf');
            window.showMessageModal("âœ… PDF generado correctamente");
        }
        
        // ============================================
        // FUNCIONES PDF PARA POWER CUP
        // ============================================
        
        // PDF INDIVIDUAL POWER CUP
        async function generateGasPDF_Simple_PowerCup(bestResult, dias, kwh, totalCliente, clientName = '[NOMBRE COMPLETO CLIENTE]', comercialCode = 'D=00', clientAddress = '') {
            window.showMessageModal("â³ Generando PDF POWER CUP...");
            
            const { jsPDF } = window.jspdf;
            let doc = new jsPDF('p', 'mm', 'a4');
            
            // CRÃTICO: Activar traducciÃ³n automÃ¡tica de textos
            if (window.setupPDFTranslation) {
                doc = window.setupPDFTranslation(doc);
            }
            
            const eur = n => new Intl.NumberFormat('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(n || 0) + ' â‚¬';
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', {minimumFractionDigits: d, maximumFractionDigits: d}).format(n || 0);
            
            const pageWidth = 210;
            const pageHeight = 297;
            let y = 0;
            
            // HEADER VERDE OLIVA CON RAYAS (estÃ©tica mejorada)
            doc.setFillColor(119, 132, 109);
            doc.rect(0, 0, pageWidth, 55, 'F');
            
            // Rayas verticales sutiles y elegantes
            doc.setDrawColor(130, 145, 120);
            doc.setLineWidth(0.5);
            for (let i = 0; i < pageWidth; i += 2.5) {
                doc.line(i, 0, i, 55);
            }
            
            // LOGO TAZA DE CAFÃ‰ PROFESIONAL
            const logoX = 40;
            const logoY = 27.5;
            
            // Cuerpo de la taza (rectangular con bordes redondeados)
            doc.setFillColor(70, 80, 65);
            doc.roundedRect(logoX - 12, logoY - 8, 24, 16, 2, 2, 'F');
            
            // Interior de la taza (cafÃ©) - color mÃ¡s claro
            doc.setFillColor(95, 108, 90);
            doc.roundedRect(logoX - 10, logoY - 6, 20, 10, 1.5, 1.5, 'F');
            
            // Asa de la taza (lÃ­neas elegantes)
            doc.setDrawColor(70, 80, 65);
            doc.setLineWidth(2.2);
            doc.line(logoX + 12, logoY - 3, logoX + 16, logoY - 1);
            doc.line(logoX + 16, logoY - 1, logoX + 16.5, logoY + 2);
            doc.line(logoX + 16.5, logoY + 2, logoX + 12, logoY + 3);
            
            // Vapor (lÃ­neas sutiles amarillas/naranjas)
            doc.setDrawColor(255, 190, 50);
            doc.setLineWidth(1.5);
            
            // Vapor izquierda
            doc.line(logoX - 4, logoY - 10, logoX - 3, logoY - 14);
            
            // Vapor centro
            doc.line(logoX, logoY - 10, logoX, logoY - 15);
            
            // Vapor derecha  
            doc.line(logoX + 4, logoY - 10, logoX + 3, logoY - 14);
            
            // TEXTO "POWER CUP ENERGÃA"
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(24);
            doc.text('POWER CUP', logoX + 30, 20);
            
            doc.setFontSize(22);
            doc.text('ENERGÃA', logoX + 30, 32);
            
            // SubtÃ­tulo descriptivo
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.setTextColor(230, 240, 230);
            doc.text(tr('Liderando el ahorro y la'), logoX + 30, 40);
            doc.text(tr('eficiencia energÃ©tica.'), logoX + 30, 44.5);
            
            // TEXTO DERECHA DEL HEADER
            doc.setTextColor(40, 60, 80);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text(tr('ESTUDIO DE AHORRO'), pageWidth - 12, 16, { align: 'right' });
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(13);
            doc.text('COMPARATIVA', pageWidth - 12, 27, { align: 'right' });
            
            doc.setTextColor(100, 120, 140);
            doc.setFontSize(11);
            doc.text('PROFESIONAL', pageWidth - 12, 37, { align: 'right' });
            
            // Banner verde "ESTUDIO DE AHORRO"
            y = 63;
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(20, y, 170, 12, 4, 4, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text(tr('ESTUDIO DE AHORRO'), 105, y + 8, { align: 'center' });
            
            // Recuadro con borde verde oliva para info del cliente
            y += 18;
            doc.setDrawColor(119, 132, 109);
            doc.setLineWidth(2);
            doc.roundedRect(20, y, 170, 25, 3, 3, 'D');
            
            doc.setFillColor(255, 255, 255);
            doc.roundedRect(20, y, 170, 25, 3, 3, 'F');
            
            y += 8;
            doc.setTextColor(70, 80, 70);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(13);
            doc.text('COMPARATIVA PROFESIONAL - POWER CUP', 25, y);
            
            y += 7;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.setTextColor(100, 110, 100);
            doc.text(tr('CLIENTE:') + ' ' + clientName + '', 25, y);
            
            y += 5;
            // Usar CUPS de gasCalculationParams
            const gasParams = window.gasCalculationParams || {};
            const cups = gasParams.cups || 'N/A';
            doc.text(`CUPS: ${cups}`, 25, y);
            
            // Texto "COMERCIAL: <cz" en la esquina derecha
            doc.setTextColor(130, 140, 130);
            doc.setFontSize(8);
            doc.text(tr('COMERCIAL:') + ' ' + comercialCode + '', 185, y, { align: 'right' });
            if (clientAddress) {
                y += 5;
                doc.text(tr('DirecciÃ³n:') + ' ' + clientAddress, 185, y, { align: 'right' });
            }
            
            y += 15;
            
            // Caja verde oliva "LA MEJOR OPCIÃ“N" (mÃ¡s grande)
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(20, y, 170, 50, 5, 5, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text(tr('LA MEJOR OPCIÃ“N PARA TI ES'), pageWidth / 2, y + 13, { align: 'center' });
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(32);
            const tariffName = bestResult.name.split('-')[0].trim();
            doc.text(tariffName, pageWidth / 2, y + 30, { align: 'center' });
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text('POWER CUP', pageWidth / 2, y + 42, { align: 'center' });
            
            y += 63;
            
            // Caja blanca con borde gris suave para ahorro y comparaciÃ³n
            doc.setDrawColor(220, 220, 220);
            doc.setLineWidth(1.5);
            doc.setFillColor(255, 255, 255);
            doc.roundedRect(20, y, 170, 95, 5, 5, 'FD');
            
            y += 15;
            doc.setTextColor(120, 130, 120);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text(tr('TU AHORRO ANUAL ESTIMADO'), pageWidth / 2, y, { align: 'center' });
            
            y += 18;
            doc.setTextColor(76, 175, 80);
            doc.setFontSize(34);
            doc.text(eur(bestResult.ahorro_anual), pageWidth / 2, y, { align: 'center' });
            
            y += 18;
            
            // Separador vertical
            doc.setDrawColor(220, 220, 220);
            doc.setLineWidth(1);
            doc.line(pageWidth / 2, y - 30, pageWidth / 2, y + 35);
            
            // Columna izquierda: Factura actual
            doc.setTextColor(110, 120, 110);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text(tr('TU FACTURA ACTUAL'), 57, y, { align: 'center' });
            
            y += 10;
            const factMes = totalCliente * 30 / dias;
            doc.setTextColor(220, 38, 38);
            doc.setFontSize(18);
            const txtMes = eur(factMes);
            doc.text(txtMes, 57, y, { align: 'center' });
            
            // LÃ­nea tachada
            const wMes = doc.getTextWidth(txtMes);
            doc.setDrawColor(220, 38, 38);
            doc.setLineWidth(2);
            doc.line(57 - wMes/2, y - 5, 57 + wMes/2, y - 5);
            
            y += 7;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            doc.setTextColor(140, 150, 140);
            doc.text(tr('Total Periodo') + ' (' + dias + ' ' + tr('dÃ­as') + ')', 57, y, { align: 'center' });
            
            y += 11;
            const factAnio = totalCliente * 365 / dias;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(15);
            doc.setTextColor(220, 38, 38);
            const txtAnio = eur(factAnio) + tr('/aÃ±o');
            doc.text(txtAnio, 57, y, { align: 'center' });
            
            const wAnio = doc.getTextWidth(txtAnio);
            doc.setLineWidth(2);
            doc.line(57 - wAnio/2, y - 4, 57 + wAnio/2, y - 4);
            
            y -= 28;
            
            // Columna derecha: Nuevo coste POWER CUP
            doc.setTextColor(110, 120, 110);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text(tr('TU NUEVO COSTE POWER CUP'), 153, y, { align: 'center' });
            
            y += 10;
            const nuevoMes = bestResult.total * 30 / dias;
            doc.setTextColor(119, 132, 109);
            doc.setFontSize(18);
            doc.text(eur(nuevoMes) + tr('/mes'), 153, y, { align: 'center' });
            
            y += 7;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            doc.setTextColor(140, 150, 140);
            doc.text(tr('Estimado Mensual'), 153, y, { align: 'center' });
            
            y += 11;
            const nuevoAnio = bestResult.total * 365 / dias;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(15);
            doc.setTextColor(119, 132, 109);
            doc.text(eur(nuevoAnio) + tr('/aÃ±o'), 153, y, { align: 'center' });
            
            // PÃGINA 2: DESGLOSE
            doc.addPage();
            y = 15;
            
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(12, y, 186, 12, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text(tr('DESGLOSE DETALLADO DE LA SIMULACIÃ“N') + ' (' + tariffName + ')', 105, y + 8, { align: 'center' });
            
            y += 18;
            
            // TÃ‰RMINO FIJO
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('TÃ‰RMINO FIJO (Precio en â‚¬/dÃ­a)', 12, y);
            y += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            const pFijoDiario = bestResult.p_fijo_diario / 365;
            doc.text(tr('Precio fijo') + ' (' + dias + ' ' + tr('dÃ­as') + ' x ' + num(pFijoDiario, 6) + ')', 15, y);
            doc.text(eur(bestResult.total_fijo), 195, y, { align: 'right' });
            y += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text(tr('SUBTOTAL POTENCIA'), 15, y);
            doc.text(eur(bestResult.total_fijo), 195, y, { align: 'right' });
            y += 10;
            
            // TÃ‰RMINO ENERGÃA
            doc.setFontSize(10);
            doc.text('TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)', 12, y);
            y += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.text('EnergÃ­a (' + kwh + ' kWh x ' + num(bestResult.p1_price, 6) + ')', 15, y);
            doc.text(eur(bestResult.total_energia), 195, y, { align: 'right' });
            y += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text('Subtotal EnergÃ­a (Bruto)', 15, y);
            doc.text(eur(bestResult.total_energia), 195, y, { align: 'right' });
            y += 10;
            
            // SUBTOTAL BASE
            const subtotalBase = bestResult.total_fijo + bestResult.total_energia;
            doc.setFontSize(10);
            doc.text('SUBTOTAL BASE (P+E)', 12, y);
            doc.text(eur(subtotalBase), 195, y, { align: 'right' });
            y += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.text('Imp. Hidrocarburos (â‚¬0,00234 x ' + kwh + ' kWh)', 12, y);
            doc.text(eur(bestResult.impuesto_hidrocarburo), 195, y, { align: 'right' });
            y += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text(tr('BASE IMPONIBLE'), 12, y);
            doc.text(eur(subtotalBase + bestResult.impuesto_hidrocarburo), 195, y, { align: 'right' });
            y += 5;
            
            doc.setFont('helvetica', 'normal');
            doc.text(tr('IVA (21%)'), 12, y);
            doc.text(eur(bestResult.iva), 195, y, { align: 'right' });
            y += 10;
            
            // TOTAL
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(12, y - 3, 186, 12, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('TOTAL FACTURA (' + dias + ' DÃAS)', 15, y + 5);
            doc.text(eur(bestResult.total), 195, y + 5, { align: 'right' });
            
            y += 14;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(9);
            doc.text(tr('TOTAL AÃ‘O (PROYECTADO)'), 12, y);
            doc.text(eur(bestResult.total * 365 / dias), 195, y, { align: 'right' });
            
            y += 12;
            doc.setFillColor(211, 47, 47);
            doc.roundedRect(12, y, 186, 20, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.text(tr('TU AHORRO ANUAL ESTIMADO ES:'), 15, y + 8);
            doc.setFontSize(16);
            doc.text(eur(bestResult.ahorro_anual) + tr('/ AÃ‘O'), 15, y + 16);
            
            doc.save('GAS_PowerCup_' + tariffName + '_' + new Date().toISOString().slice(0,10) + '.pdf');
            window.showMessageModal("âœ… PDF POWER CUP generado correctamente");
        }
        
        // PDF DUAL POWER CUP
        async function generateGasPDF_Dual_PowerCup(resFijo, resIndexed, dias, kwh, totalCliente, clientName = '[NOMBRE COMPLETO CLIENTE]', comercialCode = 'D=00', clientAddress = '') {
            window.showMessageModal("â³ Generando PDF comparativo POWER CUP...");
            const { jsPDF} = window.jspdf;
            let doc = new jsPDF('p', 'mm', 'a4');
            
            // CRÃTICO: Activar traducciÃ³n automÃ¡tica de textos
            if (window.setupPDFTranslation) {
                doc = window.setupPDFTranslation(doc);
            }
            
            const eur = n => new Intl.NumberFormat('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(n || 0) + ' â‚¬';
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', {minimumFractionDigits: d, maximumFractionDigits: d}).format(n || 0);
            
            const pageWidth = 210;
            let y = 0;
            
            // HEADER VERDE OLIVA CON RAYAS (estÃ©tica mejorada - Dual)
            doc.setFillColor(119, 132, 109);
            doc.rect(0, 0, pageWidth, 55, 'F');
            
            // Rayas verticales sutiles y elegantes
            doc.setDrawColor(130, 145, 120);
            doc.setLineWidth(0.5);
            for (let i = 0; i < pageWidth; i += 2.5) {
                doc.line(i, 0, i, 55);
            }
            
            // LOGO TAZA DE CAFÃ‰ PROFESIONAL
            const logoX = 40;
            const logoY = 27.5;
            
            // Cuerpo de la taza (rectangular con bordes redondeados)
            doc.setFillColor(70, 80, 65);
            doc.roundedRect(logoX - 12, logoY - 8, 24, 16, 2, 2, 'F');
            
            // Interior de la taza (cafÃ©) - color mÃ¡s claro
            doc.setFillColor(95, 108, 90);
            doc.roundedRect(logoX - 10, logoY - 6, 20, 10, 1.5, 1.5, 'F');
            
            // Asa de la taza (lÃ­neas elegantes)
            doc.setDrawColor(70, 80, 65);
            doc.setLineWidth(2.2);
            doc.line(logoX + 12, logoY - 3, logoX + 16, logoY - 1);
            doc.line(logoX + 16, logoY - 1, logoX + 16.5, logoY + 2);
            doc.line(logoX + 16.5, logoY + 2, logoX + 12, logoY + 3);
            
            // Vapor (lÃ­neas sutiles amarillas/naranjas)
            doc.setDrawColor(255, 190, 50);
            doc.setLineWidth(1.5);
            
            // Vapor izquierda
            doc.line(logoX - 4, logoY - 10, logoX - 3, logoY - 14);
            
            // Vapor centro
            doc.line(logoX, logoY - 10, logoX, logoY - 15);
            
            // Vapor derecha  
            doc.line(logoX + 4, logoY - 10, logoX + 3, logoY - 14);
            
            // TEXTO "POWER CUP ENERGÃA"
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(24);
            doc.text('POWER CUP', logoX + 30, 20);
            
            doc.setFontSize(22);
            doc.text('ENERGÃA', logoX + 30, 32);
            
            // SubtÃ­tulo descriptivo
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.setTextColor(230, 240, 230);
            doc.text(tr('Liderando el ahorro y la'), logoX + 30, 40);
            doc.text(tr('eficiencia energÃ©tica.'), logoX + 30, 44.5);
            
            // TEXTO DERECHA DEL HEADER
            doc.setTextColor(40, 60, 80);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text(tr('ESTUDIO DE AHORRO'), pageWidth - 12, 16, { align: 'right' });
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(13);
            doc.text('COMPARATIVA', pageWidth - 12, 27, { align: 'right' });
            
            doc.setTextColor(100, 120, 140);
            doc.setFontSize(11);
            doc.text('PROFESIONAL', pageWidth - 12, 37, { align: 'right' });
            
            // Banner verde "ESTUDIO DE AHORRO"
            y = 63;
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(20, y, 170, 8, 3, 3, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text(tr('ESTUDIO DE AHORRO'), 25, y + 5.5);
            
            y += 8;
            
            // Caja blanca con borde para info del cliente
            doc.setFillColor(255, 255, 255);
            doc.setDrawColor(119, 132, 109);
            doc.setLineWidth(1);
            doc.roundedRect(20, y, 170, 20, 3, 3, 'FD');
            
            // TÃ­tulo principal
            doc.setTextColor(119, 132, 109);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text('COMPARATIVA PROFESIONAL - POWER CUP', 25, y + 6);
            
            // Info del cliente
            doc.setTextColor(80, 80, 80);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text(tr('CLIENTE:') + ' ' + clientName, 25, y + 12);
            // Usar CUPS de gasCalculationParams
            const gasParams = window.gasCalculationParams || {};
            const cups = gasParams.cups || 'N/A';
            doc.text(`CUPS: ${cups}`, 25, y + 17);
            
            // Comercial en caja destacada (derecha)
            doc.setFillColor(240, 245, 240);
            doc.roundedRect(pageWidth - 20 - 45, y + 9, 45, 8, 2, 2, 'F');
            doc.setTextColor(119, 132, 109);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text(tr('COMERCIAL:') + ' ' + comercialCode, pageWidth - 20 - 43, y + 14.5);
            
            // DirecciÃ³n debajo del comercial (si existe)
            if (clientAddress) {
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(7);
                doc.text(tr('DirecciÃ³n:') + ' ' + clientAddress, pageWidth - 20 - 43, y + 19);
            }
            
            y += 25;
            
            
            // Caja verde oliva "LA MEJOR OPCIÃ“N" (mÃ¡s grande)
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(20, y, 170, 50, 5, 5, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text(tr('LA MEJOR OPCIÃ“N PARA TI ES'), pageWidth / 2, y + 13, { align: 'center' });
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(32);
            // Extraer el nombre de la tarifa (ej: "ELEIA" de "ELEIA - Tarifa XYZ")
            const bestTariff = resFijo.ahorro_anual > resIndexed.ahorro_anual ? resFijo : resIndexed;
            const tariffName = bestTariff.name.split('-')[0].trim();
            doc.text(tariffName, pageWidth / 2, y + 30, { align: 'center' });
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text('POWER CUP', pageWidth / 2, y + 42, { align: 'center' });
            
            y += 63;
            
            const factMes = totalCliente * 30 / dias;
            const factAnio = totalCliente * 365 / dias;
            const fijoMes = resFijo.total * 30 / dias;
            const fijoAnio = resFijo.total * 365 / dias;
            const indexMes = resIndexed.total * 30 / dias;
            const indexAnio = resIndexed.total * 365 / dias;
            
            const col1X = 12;
            const col2X = 75;
            const col3X = 145;
            
            // Separadores verticales
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.3);
            doc.line(70, y - 5, 70, y + 85);
            doc.line(140, y - 5, 140, y + 85);
            
            // COLUMNA 1: ACTUAL
            doc.setTextColor(70, 80, 70);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text(tr('TU FACTURA ACTUAL'), col1X, y);
            
            y += 9;
            doc.setTextColor(220, 38, 38);
            doc.setFontSize(16);
            const txtMes = eur(factMes);
            doc.text(txtMes, col1X, y);
            const wMes = doc.getTextWidth(txtMes);
            doc.setDrawColor(220, 38, 38);
            doc.setLineWidth(1.5);
            doc.line(col1X, y - 4, col1X + wMes, y - 4);
            
            y += 5;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(6);
            doc.setTextColor(120, 130, 120);
            doc.text(tr('Total Periodo') + ' (' + dias + ' ' + tr('dÃ­as') + ')', col1X, y);
            
            y += 9;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(13);
            doc.setTextColor(220, 38, 38);
            const txtAnio = eur(factAnio) + tr('/aÃ±o');
            doc.text(txtAnio, col1X, y);
            const wAnio = doc.getTextWidth(txtAnio);
            doc.line(col1X, y - 3, col1X + wAnio, y - 3);
            
            y -= 23;
            
            // COLUMNA 2: FIJO
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(col2X, y - 3, 60, 8, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(7);
            doc.text('TU AHORRO ANUAL FIJO', col2X + 30, y + 2, { align: 'center' });
            
            y += 11;
            doc.setTextColor(76, 175, 80);
            doc.setFontSize(20);
            doc.text(eur(resFijo.ahorro_anual), col2X + 30, y, { align: 'center' });
            
            y += 9;
            doc.setTextColor(100, 110, 100);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            doc.text(tr('TU NUEVO COSTE POWER CUP'), col2X + 30, y, { align: 'center' });
            
            y += 7;
            doc.setTextColor(119, 132, 109);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text(eur(fijoMes) + tr('/mes'), col2X + 30, y, { align: 'center' });
            
            y += 4;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(6);
            doc.setTextColor(120, 130, 120);
            doc.text(tr('Estimado Mensual'), col2X + 30, y, { align: 'center' });
            
            y += 8;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(119, 132, 109);
            doc.text(eur(fijoAnio) + tr('/aÃ±o'), col2X + 30, y, { align: 'center' });
            
            y -= 39;
            
            // COLUMNA 3: INDEXADO
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(col3X, y - 3, 60, 8, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(7);
            doc.text('TU AHORRO ANUAL INDEXADO', col3X + 30, y + 2, { align: 'center' });
            
            y += 11;
            doc.setTextColor(76, 175, 80);
            doc.setFontSize(20);
            doc.text(eur(resIndexed.ahorro_anual), col3X + 30, y, { align: 'center' });
            
            y += 9;
            doc.setTextColor(100, 110, 100);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            doc.text(tr('TU NUEVO COSTE POWER CUP'), col3X + 30, y, { align: 'center' });
            
            y += 7;
            doc.setTextColor(76, 175, 80);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text(eur(indexMes) + tr('/mes'), col3X + 30, y, { align: 'center' });
            
            y += 4;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(6);
            doc.setTextColor(120, 130, 120);
            doc.text(tr('Estimado Mensual'), col3X + 30, y, { align: 'center' });
            
            y += 8;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(76, 175, 80);
            doc.text(eur(indexAnio) + tr('/aÃ±o'), col3X + 30, y, { align: 'center' });
            
            // PÃGINA 2: DESGLOSE DETALLADO
            doc.addPage();
            y = 15;
            
            // TÃ­tulo verde
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(12, y, 186, 12, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('DESGLOSE DETALLADO POR SUMINISTRO', 105, y + 8, { align: 'center' });
            
            y += 18;
            const colW = 90;
            const leftX = 12;
            const rightX = 110;
            
            // COLUMNA IZQUIERDA: FIJA
            let leftY = y;
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(leftX, leftY, colW, 18, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.text(('[' + (window.gasCalculationParams && window.gasCalculationParams.cups ? window.gasCalculationParams.cups : 'N/A') + ']'), leftX + 3, leftY + 5);
            doc.text('Tipo: ' + currentGasTariff, leftX + colW - 3, leftY + 5, { align: 'right' });
            doc.text('DÃ­as: ' + dias, leftX + colW - 3, leftY + 10, { align: 'right' });
            doc.setFontSize(8);
            doc.text('POWER CUP - ' + resFijo.name, leftX + 3, leftY + 13);
            
            leftY += 22;
            // TÃ‰RMINO FIJO
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('TÃ‰RMINO FIJO (Precio en â‚¬/dÃ­a)', leftX, leftY);
            leftY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            const pFijoDiario = resFijo.p_fijo_diario / 365;
            doc.text(tr('Precio fijo') + ' (' + dias + ' ' + tr('dÃ­as') + ' x ' + num(pFijoDiario, 6) + ')', leftX + 3, leftY);
            doc.text(eur(resFijo.total_fijo), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text(tr('SUBTOTAL POTENCIA'), leftX + 3, leftY);
            doc.text(eur(resFijo.total_fijo), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 10;
            
            // TÃ‰RMINO ENERGÃA
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)', leftX, leftY);
            leftY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('EnergÃ­a (' + kwh + ' kWh x ' + num(resFijo.p1_price, 6) + ')', leftX + 3, leftY);
            doc.text(eur(resFijo.total_energia), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text('Subtotal EnergÃ­a (Bruto)', leftX + 3, leftY);
            doc.text(eur(resFijo.total_energia), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 10;
            
            // SUBTOTAL BASE
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            const subtotalBase = resFijo.total_fijo + resFijo.total_energia;
            doc.text('SUBTOTAL BASE (P+E)', leftX, leftY);
            doc.text(eur(subtotalBase), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('Imp. Hidrocarburos (â‚¬0,00234 x ' + kwh + ' kWh)', leftX, leftY);
            doc.text(eur(resFijo.impuesto_hidrocarburo), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text(tr('BASE IMPONIBLE'), leftX, leftY);
            doc.text(eur(subtotalBase + resFijo.impuesto_hidrocarburo), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 5;
            
            doc.setFont('helvetica', 'normal');
            doc.text(tr('IVA (21%)'), leftX, leftY);
            doc.text(eur(resFijo.iva), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 10;
            
            // TOTAL
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(leftX, leftY - 3, colW, 12, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('TOTAL FACTURA (' + dias + ' DÃAS)', leftX + 3, leftY + 5);
            doc.text(eur(resFijo.total), leftX + colW - 3, leftY + 5, { align: 'right' });
            
            leftY += 14;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text(tr('TOTAL AÃ‘O (PROYECTADO)'), leftX, leftY);
            doc.text(eur(resFijo.total * 365 / dias), leftX + colW - 2, leftY, { align: 'right' });
            
            leftY += 12;
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(leftX, leftY, colW, 18, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.text(tr('TU AHORRO ANUAL ESTIMADO ES:'), leftX + 3, leftY + 8);
            doc.setFontSize(13);
            doc.text(eur(resFijo.ahorro_anual) + tr('/ AÃ‘O'), leftX + 3, leftY + 15);
            
            // COLUMNA DERECHA: INDEXADA
            let rightY = y;
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(rightX, rightY, colW, 18, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.text(('[' + (window.gasCalculationParams && window.gasCalculationParams.cups ? window.gasCalculationParams.cups : 'N/A') + ']'), rightX + 3, rightY + 5);
            doc.text('Tipo: ' + currentGasTariff, rightX + colW - 3, rightY + 5, { align: 'right' });
            doc.text('DÃ­as: ' + dias, rightX + colW - 3, rightY + 10, { align: 'right' });
            doc.setFontSize(8);
            doc.text('POWER CUP INDEX - ' + resIndexed.name, rightX + 3, rightY + 13);
            
            rightY += 22;
            // TÃ‰RMINO FIJO
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('TÃ‰RMINO FIJO (Precio en â‚¬/dÃ­a)', rightX, rightY);
            rightY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            const pIndexDiario = resIndexed.p_fijo_diario / 365;
            doc.text(tr('Precio fijo') + ' (' + dias + ' ' + tr('dÃ­as') + ' x ' + num(pIndexDiario, 6) + ')', rightX + 3, rightY);
            doc.text(eur(resIndexed.total_fijo), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text(tr('SUBTOTAL POTENCIA'), rightX + 3, rightY);
            doc.text(eur(resIndexed.total_fijo), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 10;
            
            // TÃ‰RMINO ENERGÃA
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)', rightX, rightY);
            rightY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('EnergÃ­a (' + kwh + ' kWh x ' + num(resIndexed.p1_price, 6) + ')', rightX + 3, rightY);
            doc.text(eur(resIndexed.total_energia), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text('Subtotal EnergÃ­a (Bruto)', rightX + 3, rightY);
            doc.text(eur(resIndexed.total_energia), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 10;
            
            // SUBTOTAL BASE
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            const subtotalBaseIndex = resIndexed.total_fijo + resIndexed.total_energia;
            doc.text('SUBTOTAL BASE (P+E)', rightX, rightY);
            doc.text(eur(subtotalBaseIndex), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('Imp. Hidrocarburos (â‚¬0,00234 x ' + kwh + ' kWh)', rightX, rightY);
            doc.text(eur(resIndexed.impuesto_hidrocarburo), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text(tr('BASE IMPONIBLE'), rightX, rightY);
            doc.text(eur(subtotalBaseIndex + resIndexed.impuesto_hidrocarburo), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 5;
            
            doc.setFont('helvetica', 'normal');
            doc.text(tr('IVA (21%)'), rightX, rightY);
            doc.text(eur(resIndexed.iva), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 10;
            
            // TOTAL
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(rightX, rightY - 3, colW, 12, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('TOTAL FACTURA (' + dias + ' DÃAS)', rightX + 3, rightY + 5);
            doc.text(eur(resIndexed.total), rightX + colW - 3, rightY + 5, { align: 'right' });
            
            rightY += 14;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text(tr('TOTAL AÃ‘O (PROYECTADO)'), rightX, rightY);
            doc.text(eur(resIndexed.total * 365 / dias), rightX + colW - 2, rightY, { align: 'right' });
            
            rightY += 12;
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(rightX, rightY, colW, 18, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.text(tr('TU AHORRO ANUAL ESTIMADO ES:'), rightX + 3, rightY + 8);
            doc.setFontSize(13);
            doc.text(eur(resIndexed.ahorro_anual) + tr('/ AÃ‘O'), rightX + 3, rightY + 15);
            
            // PÃGINA 3: CUAL ES LA DIFERENCIA
            doc.addPage();
            y = 40;
            
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            doc.text('CUAL ES LA DIFERENCIA?', 105, y, { align: 'center' });
            
            y += 15;
            
            // Columna izquierda: FIJA
            doc.setTextColor(59, 130, 246);
            doc.setFontSize(12);
            doc.text(tr('POR QUE TARIFA FIJA?'), leftX, y);
            
            y += 8;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            const fijaTexts = [
                'â€¢ Implica un precio fijo por los kilovatios que',
                '  consumes (kWh).',
                '',
                'â€¢ El precio se mantiene estable,',
                '  independientemente de cÃ³mo se comporten los',
                '  precios en el mercado elÃ©ctrico.',
                '',
                'â€¢ Cuando el precio del mercado estÃ¡ alto, el',
                '  cliente estÃ¡ protegido frente a sobresaltos.',
                '',
                'â€¢ No tendrÃ¡s que estar pendiente de las',
                '  variaciones del mercado y podrÃ¡s seguir',
                '  usando la electricidad como siempre.'
            ];
            
            fijaTexts.forEach(line => {
                doc.text(tr(line), leftX, y);
                y += 4;
            });
            
            y = 55;
            
            // Columna derecha: INDEXADA
            doc.setTextColor(76, 175, 80);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text(tr('POR QUE TARIFA INDEXADA?'), rightX, y);
            
            y += 8;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            const indexTexts = [
                'â€¢ Implica un precio variable por los kilovatios',
                '  que consumes (kWh) cada mes.',
                '',
                'â€¢ Es la tarifa mÃ¡s justa, ya que pagas el coste',
                '  real de la energÃ­a mes a mes.',
                '',
                'â€¢ Al contratarla, el cliente evita pagar',
                '  mÃ¡rgenes adicionales cuando el precio de la',
                '  electricidad es mÃ¡s barato.',
                '',
                'â€¢ A largo plazo, con un indexado 100%',
                '  funcional, se puede obtener un ahorro',
                '  aproximado de hasta un 20% en Ã©pocas de',
                '  mejor precio.'
            ];
            
            indexTexts.forEach(line => {
                doc.text(tr(line), rightX, y);
                y += 4;
            });
            
            doc.save('GAS_PowerCup_Dual_' + currentGasTariff + '.pdf');
            window.showMessageModal("âœ… PDF comparativo POWER CUP generado", false);
        }

        // ============================================================================
        // SISTEMA ULTRA-COMPLETO DE TRADUCCIÃ“N MULTIIDIOMA
        // Traduce TODO: Pantallas, Modales, Botones, Mensajes
        // ============================================================================

        (function() {
            // Mapa COMPLETO de traducciones - TODOS los textos visibles
            const TR = {
                // ============================================================
                // TRADUCCIONES PARA TARIFA 2.0 TD - ANÃLISIS DE HORARIOS
                // ============================================================
                "AnÃ¡lisis de Horarios y Consumo - Tarifa 2.0 TD": { 
                    en: "Schedule and Consumption Analysis - Tariff 2.0 TD", 
                    zh: "æ—¶é—´è¡¨å’Œæ¶ˆè€—åˆ†æž - èµ„è´¹ 2.0 TD", 
                    de: "Zeitplan- und Verbrauchsanalyse - Tarif 2.0 TD", 
                    fr: "Analyse des Horaires et de la Consommation - Tarif 2.0 TD" 
                },
                "AnÃ¡lisis de Horarios": { 
                    en: "Schedule Analysis", 
                    zh: "æ—¶é—´è¡¨åˆ†æž", 
                    de: "Zeitplananalyse", 
                    fr: "Analyse des Horaires" 
                },
                "Lunes a viernes laborables": { 
                    en: "Monday to Friday (working days)", 
                    zh: "å‘¨ä¸€è‡³å‘¨äº”ï¼ˆå·¥ä½œæ—¥ï¼‰", 
                    de: "Montag bis Freitag (Werktage)", 
                    fr: "Lundi au vendredi (jours ouvrables)" 
                },
                "SÃ¡bados, domingos y festivos": { 
                    en: "Saturdays, Sundays and holidays", 
                    zh: "å‘¨å…­ã€å‘¨æ—¥å’ŒèŠ‚å‡æ—¥", 
                    de: "Samstags, sonntags und an Feiertagen", 
                    fr: "Samedis, dimanches et jours fÃ©riÃ©s" 
                },
                "Tu DistribuciÃ³n de Consumo": { 
                    en: "Your Consumption Distribution", 
                    zh: "æ‚¨çš„æ¶ˆè€—åˆ†å¸ƒ", 
                    de: "Ihre Verbrauchsverteilung", 
                    fr: "Votre Distribution de Consommation" 
                },
                "Periodo Punta": { 
                    en: "Peak Period", 
                    zh: "å³°å€¼æ—¶æ®µ", 
                    de: "Spitzenlastperiode", 
                    fr: "PÃ©riode de Pointe" 
                },
                "Periodo Llano": { 
                    en: "Flat Period", 
                    zh: "å¹³æ®µæ—¶æœŸ", 
                    de: "Mittellastperiode", 
                    fr: "PÃ©riode Pleine" 
                },
                "Periodo Valle": { 
                    en: "Valley Period", 
                    zh: "è°·æ®µæ—¶æœŸ", 
                    de: "Schwachlastperiode", 
                    fr: "PÃ©riode Creuse" 
                },
                "Peak": { 
                    en: "Peak", 
                    zh: "å³°å€¼", 
                    de: "Spitzenlast", 
                    fr: "Pointe" 
                },
                "Flat": { 
                    en: "Flat", 
                    zh: "å¹³æ®µ", 
                    de: "Mittellast", 
                    fr: "Plein" 
                },
                "Valleyy": { 
                    en: "Valley", 
                    zh: "è°·æ®µ", 
                    de: "Schwachlast", 
                    fr: "Creuse" 
                },
                "Off-peak": { 
                    en: "Off-peak", 
                    zh: "éžé«˜å³°", 
                    de: "Nebenlast", 
                    fr: "Heures creuses" 
                },
                "10-14h, 18-22h": { 
                    en: "10-14h, 18-22h", 
                    zh: "10-14æ—¶, 18-22æ—¶", 
                    de: "10-14 Uhr, 18-22 Uhr", 
                    fr: "10-14h, 18-22h" 
                },
                "8-10h, 14-18h, 22-24h": { 
                    en: "8-10h, 14-18h, 22-24h", 
                    zh: "8-10æ—¶, 14-18æ—¶, 22-24æ—¶", 
                    de: "8-10 Uhr, 14-18 Uhr, 22-24 Uhr", 
                    fr: "8-10h, 14-18h, 22-24h" 
                },
                "0-8h": { 
                    en: "0-8h", 
                    zh: "0-8æ—¶", 
                    de: "0-8 Uhr", 
                    fr: "0-8h" 
                },
                "24 horas (todo el dÃ­a)": { 
                    en: "24 hours (all day)", 
                    zh: "24å°æ—¶ï¼ˆå…¨å¤©ï¼‰", 
                    de: "24 Stunden (den ganzen Tag)", 
                    fr: "24 heures (toute la journÃ©e)" 
                },
                "Horario mÃ¡s caro": { 
                    en: "Most expensive schedule", 
                    zh: "æœ€è´µçš„æ—¶æ®µ", 
                    de: "Teuerste Zeit", 
                    fr: "Horaire le plus cher" 
                },
                "Precio medio": { 
                    en: "Average price", 
                    zh: "å¹³å‡ä»·æ ¼", 
                    de: "Durchschnittspreis", 
                    fr: "Prix moyen" 
                },
                "Horario mÃ¡s barato": { 
                    en: "Cheapest schedule", 
                    zh: "æœ€ä¾¿å®œçš„æ—¶æ®µ", 
                    de: "GÃ¼nstigste Zeit", 
                    fr: "Horaire le moins cher" 
                },
                "Horario intermedio": { 
                    en: "Intermediate schedule", 
                    zh: "ä¸­é—´æ—¶æ®µ", 
                    de: "Zwischenzeit", 
                    fr: "Horaire intermÃ©diaire" 
                },
                "Horario mÃ¡s barato 0-8h + fines semana": { 
                    en: "Cheapest schedule 0-8h + weekends", 
                    zh: "æœ€ä¾¿å®œçš„æ—¶æ®µ 0-8æ—¶ + å‘¨æœ«", 
                    de: "GÃ¼nstigste Zeit 0-8 Uhr + Wochenenden", 
                    fr: "Horaire le moins cher 0-8h + week-ends" 
                },
                "RecomendaciÃ³n Personalizada": { 
                    en: "Personalized Recommendation", 
                    zh: "ä¸ªæ€§åŒ–æŽ¨è", 
                    de: "Personalisierte Empfehlung", 
                    fr: "Recommandation PersonnalisÃ©e" 
                },
                "Consumes mÃ¡s del 30% en horario Punta. Te recomendamos trasladar consumos al periodo Valle (madrugada y fines de semana) para maximizar tu ahorro.": {
                    en: "You consume more than 30% during Peak hours. We recommend shifting consumption to Valley period (early morning and weekends) to maximize your savings.",
                    zh: "æ‚¨åœ¨å³°å€¼æ—¶æ®µæ¶ˆè€—è¶…è¿‡30%ã€‚æˆ‘ä»¬å»ºè®®å°†æ¶ˆè€—è½¬ç§»åˆ°è°·æ®µæ—¶æœŸï¼ˆå‡Œæ™¨å’Œå‘¨æœ«ï¼‰ä»¥æœ€å¤§åŒ–æ‚¨çš„èŠ‚çœã€‚",
                    de: "Sie verbrauchen mehr als 30% wÃ¤hrend der Spitzenzeiten. Wir empfehlen, den Verbrauch in die Schwachlastperiode (frÃ¼her Morgen und Wochenenden) zu verlagern, um Ihre Einsparungen zu maximieren.",
                    fr: "Vous consommez plus de 30% pendant les heures de pointe. Nous recommandons de dÃ©placer la consommation vers la pÃ©riode creuse (tÃ´t le matin et week-ends) pour maximiser vos Ã©conomies."
                },
                "Â¡Excelente! MÃ¡s del 50% de tu consumo estÃ¡ en Valle, el periodo mÃ¡s econÃ³mico. Sigue asÃ­ para maximizar tu ahorro.": {
                    en: "Excellent! More than 50% of your consumption is in Valley period, the most economical. Keep it up to maximize your savings.",
                    zh: "å¤ªå¥½äº†ï¼æ‚¨è¶…è¿‡50%çš„æ¶ˆè€—åœ¨è°·æ®µæ—¶æœŸï¼Œè¿™æ˜¯æœ€ç»æµŽçš„ã€‚ç»§ç»­ä¿æŒä»¥æœ€å¤§åŒ–æ‚¨çš„èŠ‚çœã€‚",
                    de: "Ausgezeichnet! Mehr als 50% Ihres Verbrauchs liegt in der Schwachlastperiode, der wirtschaftlichsten. Machen Sie so weiter, um Ihre Einsparungen zu maximieren.",
                    fr: "Excellent ! Plus de 50% de votre consommation est en pÃ©riode creuse, la plus Ã©conomique. Continuez ainsi pour maximiser vos Ã©conomies."
                },
                "Tu consumo estÃ¡ bien distribuido. Considera trasladar mÃ¡s consumo al periodo Valle para aumentar tu ahorro.": {
                    en: "Your consumption is well distributed. Consider shifting more consumption to Valley period to increase your savings.",
                    zh: "æ‚¨çš„æ¶ˆè€—åˆ†å¸ƒè‰¯å¥½ã€‚è€ƒè™‘å°†æ›´å¤šæ¶ˆè€—è½¬ç§»åˆ°è°·æ®µæ—¶æœŸä»¥å¢žåŠ æ‚¨çš„èŠ‚çœã€‚",
                    de: "Ihr Verbrauch ist gut verteilt. ErwÃ¤gen Sie, mehr Verbrauch in die Schwachlastperiode zu verlagern, um Ihre Einsparungen zu erhÃ¶hen.",
                    fr: "Votre consommation est bien rÃ©partie. Envisagez de dÃ©placer plus de consommation vers la pÃ©riode creuse pour augmenter vos Ã©conomies."
                },
                "å³°": { en: "Peak", zh: "å³°", de: "Spitze", fr: "Pointe" },
                "å€¼": { en: "Value", zh: "å€¼", de: "Wert", fr: "Valeur" },
                "å¹³": { en: "Flat", zh: "å¹³", de: "Mittel", fr: "Plat" },
                "æ®µ": { en: "Period", zh: "æ®µ", de: "Periode", fr: "PÃ©riode" },
                "è°·": { en: "Valley", zh: "è°·", de: "Tal", fr: "VallÃ©e" },
                "å³°å€¼": { en: "Peak", zh: "å³°å€¼", de: "Spitzenwert", fr: "Pointe" },
                "å¹³æ®µ": { en: "Flat", zh: "å¹³æ®µ", de: "Mittellast", fr: "Plat" },
                "è°·æ®µ": { en: "Valley", zh: "è°·æ®µ", de: "Schwachlast", fr: "VallÃ©e" },
                // ============================================================
                "Analizar Factura": { en: "Analyze Invoice", zh: "åˆ†æžè´¦å•", de: "Rechnung analysieren", fr: "Analyser la Facture" },
                "Escanea el cÃ³digo QR o introduce datos manualmente.": { en: "Scan the QR code or enter data manually.", zh: "æ‰«æäºŒç»´ç æˆ–æ‰‹åŠ¨è¾“å…¥æ•°æ®ã€‚", de: "Scannen Sie den QR-Code oder geben Sie Daten manuell ein.", fr: "Scannez le code QR ou saisissez les donnÃ©es manuellement." },
                "ESCANEAR QR AHORA": { en: "SCAN QR NOW", zh: "ç«‹å³æ‰«æäºŒç»´ç ", de: "QR JETZT SCANNEN", fr: "SCANNER QR MAINTENANT" },
                "OTRAS OPCIONES DE CAPTURA": { en: "OTHER CAPTURE OPTIONS", zh: "å…¶ä»–æ•èŽ·é€‰é¡¹", de: "ANDERE AUFNAHMEOPTIONEN", fr: "AUTRES OPTIONS DE CAPTURE" },
                "DATOS A MANO": { en: "MANUAL DATA", zh: "æ‰‹åŠ¨æ•°æ®", de: "MANUELLE DATEN", fr: "DONNÃ‰ES MANUELLES" },
                "Volver a selecciÃ³n": { en: "Back to selection", zh: "è¿”å›žé€‰æ‹©", de: "ZurÃ¼ck zur Auswahl", fr: "Retour Ã  la sÃ©lection" },
                "Seleccione OpciÃ³n QR": { en: "Select QR Option", zh: "é€‰æ‹©äºŒç»´ç é€‰é¡¹", de: "QR-Option wÃ¤hlen", fr: "SÃ©lectionner l'Option QR" },
                "Capturar Foto": { en: "Capture Photo", zh: "æ‹ç…§", de: "Foto aufnehmen", fr: "Capturer une Photo" },
                "Subir Imagen": { en: "Upload Image", zh: "ä¸Šä¼ å›¾ç‰‡", de: "Bild hochladen", fr: "TÃ©lÃ©charger une Image" },
                "Pegar Imagen (CTRL+V)": { en: "Paste Image (CTRL+V)", zh: "ç²˜è´´å›¾ç‰‡ (CTRL+V)", de: "Bild einfÃ¼gen (STRG+V)", fr: "Coller l'Image (CTRL+V)" },
                "Cancelar": { en: "Cancel", zh: "å–æ¶ˆ", de: "Abbrechen", fr: "Annuler" },
                "Selecciona la tarifa que deseas analizar.": { en: "Select the rate you want to analyze.", zh: "é€‰æ‹©æ‚¨æƒ³åˆ†æžçš„è´¹çŽ‡ã€‚", de: "WÃ¤hlen Sie den Tarif, den Sie analysieren mÃ¶chten.", fr: "SÃ©lectionnez le tarif que vous souhaitez analyser." },
                "Gestor de mÃºltiples contratos (2.0TD + 3.0TD)": { en: "Multiple contracts manager (2.0TD + 3.0TD)", zh: "å¤šåˆåŒç®¡ç†å™¨ (2.0TD + 3.0TD)", de: "Mehrfachvertrags-Manager (2.0TD + 3.0TD)", fr: "Gestionnaire de contrats multiples (2.0TD + 3.0TD)" },
                "Hogar / PequeÃ±o Negocio (Individual)": { en: "Home / Small Business (Individual)", zh: "å®¶åº­ / å°åž‹ä¼ä¸šï¼ˆå•ç‹¬ï¼‰", de: "Zuhause / Kleinunternehmen (Einzeln)", fr: "Maison / Petite Entreprise (Individuel)" },
                "Empresa / Negocio (Individual)": { en: "Company / Business (Individual)", zh: "å…¬å¸ / ä¼ä¸šï¼ˆå•ç‹¬ï¼‰", de: "Unternehmen / GeschÃ¤ft (Einzeln)", fr: "Entreprise / Commerce (Individuel)" },
                "Industria / Gran Consumo (Individual)": { en: "Industry / Large Consumption (Individual)", zh: "å·¥ä¸š / å¤§åž‹æ¶ˆè´¹ï¼ˆå•ç‹¬ï¼‰", de: "Industrie / GroÃŸverbrauch (Einzeln)", fr: "Industrie / Grande Consommation (Individuel)" },
                "ABRIR EN EL MÃ“VIL": { en: "OPEN ON MOBILE", zh: "åœ¨æ‰‹æœºä¸Šæ‰“å¼€", de: "AUF MOBIL Ã–FFNEN", fr: "OUVRIR SUR MOBILE" },
                "CÃ¡lculo Completado": { en: "Calculation Complete", zh: "è®¡ç®—å®Œæˆ", de: "Berechnung abgeschlossen", fr: "Calcul TerminÃ©" },
                "âœ… CÃ¡lculo Completado": { en: "âœ… Calculation Complete", zh: "âœ… è®¡ç®—å®Œæˆ", de: "âœ… Berechnung abgeschlossen", fr: "âœ… Calcul TerminÃ©" },
                "Hemos encontrado ofertas con ahorro. Â¿CÃ³mo quieres continuar?": { en: "We found offers with savings. How do you want to continue?", zh: "æˆ‘ä»¬æ‰¾åˆ°äº†èŠ‚çœä¼˜æƒ ã€‚æ‚¨æƒ³å¦‚ä½•ç»§ç»­ï¼Ÿ", de: "Wir haben Angebote mit Einsparungen gefunden. Wie mÃ¶chten Sie fortfahren?", fr: "Nous avons trouvÃ© des offres avec des Ã©conomies. Comment souhaitez-vous continuer ?" },
                "Comparar FIJO vs INDEXADO": { en: "Compare FIXED vs INDEXED", zh: "æ¯”è¾ƒå›ºå®šä¸ŽæŒ‡æ•°", de: "FEST vs INDEXIERT vergleichen", fr: "Comparer FIXE vs INDEXÃ‰" },
                "Genera comparativa dual: tarifa fija y tarifa indexada DRK INDEX (precio variable del mercado).": { en: "Generate dual comparison: fixed rate and DRK INDEX indexed rate (variable market price).", zh: "ç”ŸæˆåŒé‡æ¯”è¾ƒï¼šå›ºå®šè´¹çŽ‡å’ŒDRK INDEXæŒ‡æ•°è´¹çŽ‡ï¼ˆå¸‚åœºå¯å˜ä»·æ ¼ï¼‰ã€‚", de: "Dualer Vergleich generieren: Festpreis und DRK INDEX indexierter Tarif (variabler Marktpreis).", fr: "GÃ©nÃ©rer une comparaison duale : tarif fixe et tarif indexÃ© DRK INDEX (prix variable du marchÃ©)." },
                "VER MEJOR OPCIÃ“N": { en: "SEE BEST OPTION", zh: "æŸ¥çœ‹æœ€ä½³é€‰é¡¹", de: "BESTE OPTION SEHEN", fr: "VOIR LA MEILLEURE OPTION" },
                "Muestra automÃ¡ticamente la oferta con mayor ahorro y genera la comparativa": { en: "Automatically shows the offer with the highest savings and generates the comparison", zh: "è‡ªåŠ¨æ˜¾ç¤ºèŠ‚çœæœ€å¤šçš„ä¼˜æƒ å¹¶ç”Ÿæˆæ¯”è¾ƒ", de: "Zeigt automatisch das Angebot mit den hÃ¶chsten Einsparungen und generiert den Vergleich", fr: "Affiche automatiquement l'offre avec les Ã©conomies les plus Ã©levÃ©es et gÃ©nÃ¨re la comparaison" },
                "ELEGIR ENTRE RESULTADOS": { en: "CHOOSE FROM RESULTS", zh: "ä»Žç»“æžœä¸­é€‰æ‹©", de: "AUS ERGEBNISSEN WÃ„HLEN", fr: "CHOISIR PARMI LES RÃ‰SULTATS" },
                "Revisa todas las ofertas con ahorro positivo y elige la que prefieras": { en: "Review all offers with positive savings and choose your preferred one", zh: "æŸ¥çœ‹æ‰€æœ‰æ­£èŠ‚çœçš„ä¼˜æƒ å¹¶é€‰æ‹©æ‚¨å–œæ¬¢çš„", de: "ÃœberprÃ¼fen Sie alle Angebote mit positiven Einsparungen und wÃ¤hlen Sie Ihr bevorzugtes", fr: "Examinez toutes les offres avec des Ã©conomies positives et choisissez celle que vous prÃ©fÃ©rez" },
                "Consejo:": { en: "Advice:", zh: "å»ºè®®ï¼š", de: "Rat:", fr: "Conseil :" },
                "Â¿QuÃ© tipo de tarifa DRK quieres ver?": { en: "What type of DRK rate do you want to see?", zh: "æ‚¨æƒ³æŸ¥çœ‹å“ªç§ç±»åž‹çš„DRKè´¹çŽ‡ï¼Ÿ", de: "Welchen DRK-Tariftyp mÃ¶chten Sie sehen?", fr: "Quel type de tarif DRK souhaitez-vous voir ?" },
                "ðŸŽ¯ Â¿QuÃ© tipo de tarifa DRK quieres ver?": { en: "ðŸŽ¯ What type of DRK rate do you want to see?", zh: "ðŸŽ¯ æ‚¨æƒ³æŸ¥çœ‹å“ªç§ç±»åž‹çš„DRKè´¹çŽ‡ï¼Ÿ", de: "ðŸŽ¯ Welchen DRK-Tariftyp mÃ¶chten Sie sehen?", fr: "ðŸŽ¯ Quel type de tarif DRK souhaitez-vous voir ?" },
                "Tarifa FIJA": { en: "FIXED Rate", zh: "å›ºå®šè´¹çŽ‡", de: "FESTPREIS-Tarif", fr: "Tarif FIXE" },
                "âš¡ Tarifa FIJA": { en: "âš¡ FIXED Rate", zh: "âš¡ å›ºå®šè´¹çŽ‡", de: "âš¡ FESTPREIS-Tarif", fr: "âš¡ Tarif FIXE" },
                "Precio fijo estable (excluye DRK INDEX)": { en: "Stable fixed price (excludes DRK INDEX)", zh: "ç¨³å®šå›ºå®šä»·æ ¼ï¼ˆä¸åŒ…æ‹¬DRK INDEXï¼‰", de: "Stabiler Festpreis (ohne DRK INDEX)", fr: "Prix fixe stable (exclut DRK INDEX)" },
                "Tarifa INDEXADA (DRK INDEX)": { en: "INDEXED Rate (DRK INDEX)", zh: "æŒ‡æ•°è´¹çŽ‡ï¼ˆDRK INDEXï¼‰", de: "INDEXIERTER Tarif (DRK INDEX)", fr: "Tarif INDEXÃ‰ (DRK INDEX)" },
                "ðŸŒ± Tarifa INDEXADA (DRK INDEX)": { en: "ðŸŒ± INDEXED Rate (DRK INDEX)", zh: "ðŸŒ± æŒ‡æ•°è´¹çŽ‡ï¼ˆDRK INDEXï¼‰", de: "ðŸŒ± INDEXIERTER Tarif (DRK INDEX)", fr: "ðŸŒ± Tarif INDEXÃ‰ (DRK INDEX)" },
                "Solo muestra DRK INDEX del mercado": { en: "Only shows market DRK INDEX", zh: "ä»…æ˜¾ç¤ºå¸‚åœºDRK INDEX", de: "Zeigt nur Markt-DRK INDEX", fr: "Affiche uniquement le DRK INDEX du marchÃ©" },
                "Continuar con esta opciÃ³n â†’": { en: "Continue with this option â†’", zh: "ç»§ç»­æ­¤é€‰é¡¹ â†’", de: "Mit dieser Option fortfahren â†’", fr: "Continuer avec cette option â†’" },
                "DRK ENERGÃA": { en: "DRK ENERGY", zh: "DRK èƒ½æº", de: "DRK ENERGIE", fr: "DRK Ã‰NERGIE" },
                "Liderando el ahorro y la eficiencia energÃ©tica": { en: "Leading savings and energy efficiency", zh: "å¼•é¢†èŠ‚çœå’Œèƒ½æºæ•ˆçŽ‡", de: "FÃ¼hrend bei Einsparungen und Energieeffizienz", fr: "Leader des Ã©conomies et de l'efficacitÃ© Ã©nergÃ©tique" },
                "AnÃ¡lisis Completado": { en: "Analysis Complete", zh: "åˆ†æžå®Œæˆ", de: "Analyse abgeschlossen", fr: "Analyse TerminÃ©e" },
                "Resultado del Estudio": { en: "Study Result", zh: "ç ”ç©¶ç»“æžœ", de: "Studienergebnis", fr: "RÃ©sultat de l'Ã‰tude" },
                "LA MEJOR OPCIÃ“N PARA TI ES": { en: "THE BEST OPTION FOR YOU IS", zh: "æœ€é€‚åˆæ‚¨çš„é€‰æ‹©æ˜¯", de: "DIE BESTE OPTION FÃœR SIE IST", fr: "LA MEILLEURE OPTION POUR VOUS EST" },
                "TU AHORRO ANUAL ESTIMADO": { en: "YOUR ESTIMATED ANNUAL SAVINGS", zh: "æ‚¨çš„é¢„è®¡å¹´åº¦èŠ‚çœ", de: "IHRE GESCHÃ„TZTE JÃ„HRLICHE ERSPARNIS", fr: "VOS Ã‰CONOMIES ANNUELLES ESTIMÃ‰ES" },
                "TU FACTURA ACTUAL": { en: "YOUR CURRENT BILL", zh: "æ‚¨å½“å‰çš„è´¦å•", de: "IHRE AKTUELLE RECHNUNG", fr: "VOTRE FACTURE ACTUELLE" },
                "Total Periodo": { en: "Period Total", zh: "æœŸé—´æ€»é¢", de: "Periodensumme", fr: "Total de la PÃ©riode" },
                "TU NUEVO COSTE DRK": { en: "YOUR NEW DRK COST", zh: "æ‚¨çš„æ–°DRKæˆæœ¬", de: "IHRE NEUEN DRK-KOSTEN", fr: "VOTRE NOUVEAU COÃ›T DRK" },
                "Estimado Mensual": { en: "Monthly Estimate", zh: "æ¯æœˆä¼°ç®—", de: "Monatliche SchÃ¤tzung", fr: "Estimation Mensuelle" },
                "Datos del Comercial y Cliente": { en: "Sales Representative and Client Data", zh: "é”€å”®ä»£è¡¨å’Œå®¢æˆ·æ•°æ®", de: "Vertriebs- und Kundendaten", fr: "DonnÃ©es du Commercial et du Client" },
                "Rellene sus datos. El resumen profesional de la oferta se copiarÃ¡ a su portapapeles (Ctrl+V).": { en: "Fill in your details. The professional offer summary will be copied to your clipboard (Ctrl+V).", zh: "å¡«å†™æ‚¨çš„è¯¦ç»†ä¿¡æ¯ã€‚ä¸“ä¸šä¼˜æƒ æ‘˜è¦å°†å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼ˆCtrl+Vï¼‰ã€‚", de: "FÃ¼llen Sie Ihre Daten aus. Die professionelle AngebotsÃ¼bersicht wird in Ihre Zwischenablage kopiert (Strg+V).", fr: "Remplissez vos donnÃ©es. Le rÃ©sumÃ© professionnel de l'offre sera copiÃ© dans votre presse-papiers (Ctrl+V)." },
                "CÃ“DIGO COMERCIAL (Obligatorio)": { en: "SALES CODE (Required)", zh: "é”€å”®ä»£ç ï¼ˆå¿…å¡«ï¼‰", de: "VERTRIEBSCODE (Erforderlich)", fr: "CODE COMMERCIAL (Obligatoire)" },
                "Nombre Cliente": { en: "Client Name", zh: "å®¢æˆ·å§“å", de: "Kundenname", fr: "Nom du Client" },
                "TelÃ©fono": { en: "Phone", zh: "ç”µè¯", de: "Telefon", fr: "TÃ©lÃ©phone" },
                "NOTA PARA USUARIOS DE iPHONE:": { en: "NOTE FOR iPHONE USERS:", zh: "iPHONEç”¨æˆ·æ³¨æ„ï¼š", de: "HINWEIS FÃœR iPHONE-BENUTZER:", fr: "NOTE POUR LES UTILISATEURS D'iPHONE :" },
                "COPIAR COMPARATIVO (HTML)": { en: "COPY COMPARISON (HTML)", zh: "å¤åˆ¶æ¯”è¾ƒï¼ˆHTMLï¼‰", de: "VERGLEICH KOPIEREN (HTML)", fr: "COPIER LA COMPARAISON (HTML)" },
                "CREAR PDF COMPARATIVO": { en: "CREATE PDF COMPARISON", zh: "åˆ›å»ºPDFæ¯”è¾ƒ", de: "PDF-VERGLEICH ERSTELLEN", fr: "CRÃ‰ER UN PDF COMPARATIF" },
                "MODO DE COMPARACIÃ“N": { en: "COMPARISON MODE", zh: "æ¯”è¾ƒæ¨¡å¼", de: "VERGLEICHSMODUS", fr: "MODE DE COMPARAISON" },
                "DRK Ãšnicamente": { en: "DRK Only", zh: "ä»…DRK", de: "Nur DRK", fr: "DRK Uniquement" },
                "DRK Prioritario": { en: "DRK Prioritized", zh: "DRKä¼˜å…ˆ", de: "DRK PrioritÃ¤t", fr: "DRK Prioritaire" },
                "Global": { en: "Global", zh: "å…¨çƒ", de: "Global", fr: "Global" },
                "DRK COMPARADOR": { en: "DRK COMPARATOR", zh: "DRK æ¯”è¾ƒå™¨", de: "DRK VERGLEICHER", fr: "COMPARATEUR DRK" },
                "Selecciona el tipo de suministro.": { en: "Select the type of supply.", zh: "é€‰æ‹©ä¾›åº”ç±»åž‹ã€‚", de: "WÃ¤hlen Sie die Art der Versorgung.", fr: "SÃ©lectionnez le type d'approvisionnement." },
                "TIPO DE SUMINISTRO": { en: "SUPPLY TYPE", zh: "ä¾›åº”ç±»åž‹", de: "VERSORGUNGSTYP", fr: "TYPE D'APPROVISIONNEMENT" },
                "ELECTRICIDAD": { en: "ELECTRICITY", zh: "ç”µåŠ›", de: "ELEKTRIZITÃ„T", fr: "Ã‰LECTRICITÃ‰" },
                "MULTICUPS Â· 2.0 TD Â· 3.0 TD": { en: "MULTICUPS Â· 2.0 TD Â· 3.0 TD", zh: "å¤šåˆåŒ Â· 2.0 TD Â· 3.0 TD", de: "MULTICUPS Â· 2.0 TD Â· 3.0 TD", fr: "MULTICUPS Â· 2.0 TD Â· 3.0 TD" },
                "RL1 Â· RL2 Â· RL3 Â· RL4 Â· RL5 Â· RL6": { en: "RL1 Â· RL2 Â· RL3 Â· RL4 Â· RL5 Â· RL6", zh: "RL1 Â· RL2 Â· RL3 Â· RL4 Â· RL5 Â· RL6", de: "RL1 Â· RL2 Â· RL3 Â· RL4 Â· RL5 Â· RL6", fr: "RL1 Â· RL2 Â· RL3 Â· RL4 Â· RL5 Â· RL6" },
                "ELECTRICIDAD + GAS": { en: "ELECTRICITY + GAS", zh: "ç”µåŠ› + å¤©ç„¶æ°”", de: "ELEKTRIZITÃ„T + GAS", fr: "Ã‰LECTRICITÃ‰ + GAZ" },
                "MÃºltiples suministros Â· Comparativa global": { en: "Multiple supplies Â· Global comparison", zh: "å¤šä¸ªä¾›åº” Â· å…¨é¢æ¯”è¾ƒ", de: "Mehrere Versorgungen Â· Globaler Vergleich", fr: "Multiples approvisionnements Â· Comparaison globale" },
                "Continuar": { en: "Continue", zh: "ç»§ç»­", de: "Fortfahren", fr: "Continuer" },
                "Volver": { en: "Back", zh: "è¿”å›ž", de: "ZurÃ¼ck", fr: "Retour" },
                "Calcular Ahorro": { en: "Calculate Savings", zh: "è®¡ç®—èŠ‚çœ", de: "Ersparnis berechnen", fr: "Calculer les Ã‰conomies" },
                
                // === TRADUCCIONES DE OPTIMIZACIÃ“N DE POTENCIAS ===
                "Activar Comparativo con Potencia Optimizada": { en: "Activate Comparison with Optimized Power", zh: "å¯ç”¨ä¼˜åŒ–åŠŸçŽ‡æ¯”è¾ƒ", de: "Vergleich mit optimierter Leistung aktivieren", fr: "Activer la Comparaison avec Puissance OptimisÃ©e" },
                "Permite comparar las potencias actuales vs. potencias optimizadas": { en: "Allows you to compare current power vs. optimized power", zh: "å…è®¸æ¯”è¾ƒå½“å‰åŠŸçŽ‡ä¸Žä¼˜åŒ–åŠŸçŽ‡", de: "ErmÃ¶glicht den Vergleich aktueller Leistung vs. optimierter Leistung", fr: "Permet de comparer la puissance actuelle vs. puissance optimisÃ©e" },
                "Potencias Optimizadas (kW)": { en: "Optimized Power (kW)", zh: "ä¼˜åŒ–åŠŸçŽ‡ (kW)", de: "Optimierte Leistung (kW)", fr: "Puissance OptimisÃ©e (kW)" },
                "General Data": { es: "Datos Generales", zh: "ä¸€èˆ¬æ•°æ®", de: "Allgemeine Daten", fr: "DonnÃ©es GÃ©nÃ©rales" },
                "Power (kW)": { es: "Potencias (kW)", zh: "åŠŸçŽ‡ (kW)", de: "Leistung (kW)", fr: "Puissance (kW)" },
                "Energy (kWh)": { es: "EnergÃ­a (kWh)", zh: "èƒ½æº (kWh)", de: "Energie (kWh)", fr: "Ã‰nergie (kWh)" },
                "Introduce las potencias optimizadas que propones al cliente": { en: "Enter the optimized power you propose to the client", zh: "è¾“å…¥æ‚¨å‘å®¢æˆ·å»ºè®®çš„ä¼˜åŒ–åŠŸçŽ‡", de: "Geben Sie die optimierte Leistung ein, die Sie dem Kunden vorschlagen", fr: "Entrez la puissance optimisÃ©e que vous proposez au client" },
                "Potencias Optimizadas": { en: "Optimized Power", zh: "ä¼˜åŒ–åŠŸçŽ‡", de: "Optimierte Leistung", fr: "Puissance OptimisÃ©e" },
                "PROPUESTA": { en: "PROPOSAL", zh: "å»ºè®®", de: "VORSCHLAG", fr: "PROPOSITION" },
                "COMPARATIVO: POTENCIAS ACTUALES vs POTENCIAS OPTIMIZADAS": { en: "COMPARISON: CURRENT POWER vs OPTIMIZED POWER", zh: "æ¯”è¾ƒï¼šå½“å‰åŠŸçŽ‡ä¸Žä¼˜åŒ–åŠŸçŽ‡", de: "VERGLEICH: AKTUELLE LEISTUNG vs OPTIMIERTE LEISTUNG", fr: "COMPARATIF : PUISSANCE ACTUELLE vs PUISSANCE OPTIMISÃ‰E" },
                "Desglose Detallado - Potencias Actuales": { en: "Detailed Breakdown - Current Power", zh: "è¯¦ç»†åˆ†è§£ - å½“å‰åŠŸçŽ‡", de: "Detaillierte AufschlÃ¼sselung - Aktuelle Leistung", fr: "RÃ©partition DÃ©taillÃ©e - Puissance Actuelle" },
                "Potencia Contratada": { en: "Contracted Power", zh: "åˆåŒåŠŸçŽ‡", de: "Vertragsleistung", fr: "Puissance ContractÃ©e" },
                "CÃ¡lculo con Potencias Optimizadas": { en: "Calculation with Optimized Power", zh: "ä¼˜åŒ–åŠŸçŽ‡è®¡ç®—", de: "Berechnung mit optimierter Leistung", fr: "Calcul avec Puissance OptimisÃ©e" },
                "CÃ¡lculo con Potencias Actuales": { en: "Calculation with Current Power", zh: "å½“å‰åŠŸçŽ‡è®¡ç®—", de: "Berechnung mit aktueller Leistung", fr: "Calcul avec Puissance Actuelle" },
                "EnergÃ­a Consumida": { en: "Energy Consumed", zh: "èƒ½æºæ¶ˆè€—", de: "Verbrauchte Energie", fr: "Ã‰nergie ConsommÃ©e" },
                "Rellene sus datos para generar el comparativo.": { en: "Fill in your details to generate the comparison.", zh: "å¡«å†™æ‚¨çš„è¯¦ç»†ä¿¡æ¯ä»¥ç”Ÿæˆæ¯”è¾ƒã€‚", de: "FÃ¼llen Sie Ihre Daten aus, um den Vergleich zu generieren.", fr: "Remplissez vos donnÃ©es pour gÃ©nÃ©rer la comparaison." },
                "Modo de PresentaciÃ³n de Potencias Optimizadas": { en: "Optimized Power Presentation Mode", zh: "ä¼˜åŒ–åŠŸçŽ‡æ¼”ç¤ºæ¨¡å¼", de: "Optimierte LeistungsprÃ¤sentationsmodus", fr: "Mode de PrÃ©sentation de Puissance OptimisÃ©e" },
                "Modo A - Dos Columnas": { en: "Mode A - Two Columns", zh: "æ¨¡å¼ A - ä¸¤åˆ—", de: "Modus A - Zwei Spalten", fr: "Mode A - Deux Colonnes" },
                "Muestra potencias actuales y optimizadas lado a lado. El cliente VE las potencias propuestas.": { en: "Shows current and optimized power side by side. The client SEES the proposed power.", zh: "å¹¶æŽ’æ˜¾ç¤ºå½“å‰åŠŸçŽ‡å’Œä¼˜åŒ–åŠŸçŽ‡ã€‚å®¢æˆ·çœ‹åˆ°å»ºè®®çš„åŠŸçŽ‡ã€‚", de: "Zeigt aktuelle und optimierte Leistung nebeneinander. Der Kunde SIEHT die vorgeschlagene Leistung.", fr: "Affiche la puissance actuelle et optimisÃ©e cÃ´te Ã  cÃ´te. Le client VOIT la puissance proposÃ©e." },
                "Modo B - Una Columna": { en: "Mode B - One Column", zh: "æ¨¡å¼ B - å•åˆ—", de: "Modus B - Eine Spalte", fr: "Mode B - Une Colonne" },
                "Solo potencias actuales. Al final resumen de ahorros. El cliente NO ve quÃ© potencias bajar.": { en: "Only current power. Savings summary at the end. The client does NOT see which power to reduce.", zh: "ä»…å½“å‰åŠŸçŽ‡ã€‚æœ€åŽçš„èŠ‚çœæ‘˜è¦ã€‚å®¢æˆ·çœ‹ä¸åˆ°è¦é™ä½Žå“ªäº›åŠŸçŽ‡ã€‚", de: "Nur aktuelle Leistung. Einsparungszusammenfassung am Ende. Der Kunde SIEHT NICHT, welche Leistung zu reduzieren ist.", fr: "Seulement la puissance actuelle. RÃ©sumÃ© des Ã©conomies Ã  la fin. Le client ne VOIT PAS quelle puissance rÃ©duire." },
                
                // Textos adicionales que faltan
                "TU AHORRO ANUAL CON OPTIMIZACIÃ“N": { en: "YOUR ANNUAL SAVINGS WITH OPTIMIZATION", zh: "ä¼˜åŒ–åŽçš„å¹´åº¦èŠ‚çœ", de: "IHRE JÃ„HRLICHE ERSPARNIS MIT OPTIMIERUNG", fr: "VOS Ã‰CONOMIES ANNUELLES AVEC OPTIMISATION" },
                "YOUR NEW COST DRK": { es: "TU NUEVO COSTE DRK", zh: "æ‚¨çš„æ–°DRKæˆæœ¬", de: "IHRE NEUEN DRK-KOSTEN", fr: "VOTRE NOUVEAU COÃ›T DRK" },
                "Monthly Estimate": { es: "Estimado Mensual", zh: "æ¯æœˆä¼°ç®—", de: "Monatliche SchÃ¤tzung", fr: "Estimation Mensuelle" },
                "DATOS DEL CLIENTE": { en: "CLIENT DATA", zh: "å®¢æˆ·æ•°æ®", de: "KUNDENDATEN", fr: "DONNÃ‰ES DU CLIENT" },
                "TU FACTURA ACTUAL": { en: "YOUR CURRENT BILL", zh: "æ‚¨å½“å‰çš„è´¦å•", de: "IHRE AKTUELLE RECHNUNG", fr: "VOTRE FACTURE ACTUELLE" },
                "TU NUEVA TARIFA": { en: "YOUR NEW RATE", zh: "æ‚¨çš„æ–°è´¹çŽ‡", de: "IHR NEUER TARIF", fr: "VOTRE NOUVEAU TARIF" },
                "TU AHORRO ANUAL": { en: "YOUR ANNUAL SAVINGS", zh: "æ‚¨çš„å¹´åº¦èŠ‚çœ", de: "IHRE JÃ„HRLICHE ERSPARNIS", fr: "VOS Ã‰CONOMIES ANNUELLES" },
                "TU NUEVO COSTE": { en: "YOUR NEW COST", zh: "æ‚¨çš„æ–°æˆæœ¬", de: "IHRE NEUEN KOSTEN", fr: "VOTRE NOUVEAU COÃ›T" },
                "POTENCIAS CONTRATADAS (kW)": { en: "CONTRACTED POWER (kW)", zh: "åˆåŒåŠŸçŽ‡ (kW)", de: "VERTRAGSLEISTUNG (kW)", fr: "PUISSANCE CONTRACTÃ‰E (kW)" },
                "POTENCIAL DE OPTIMIZACION": { en: "OPTIMIZATION POTENTIAL", zh: "ä¼˜åŒ–æ½œåŠ›", de: "OPTIMIERUNGSPOTENTIAL", fr: "POTENTIEL D'OPTIMISATION" },
                "Con tu tarifa actual y potencias contratadas:": { en: "With your current rate and contracted power:", zh: "ä½¿ç”¨å½“å‰è´¹çŽ‡å’ŒåˆåŒåŠŸçŽ‡ï¼š", de: "Mit Ihrem aktuellen Tarif und Vertragsleistung:", fr: "Avec votre tarif actuel et puissance contractÃ©e :" },
                "Con optimizaciÃ³n de potencias:": { en: "With power optimization:", zh: "ä½¿ç”¨åŠŸçŽ‡ä¼˜åŒ–ï¼š", de: "Mit Leistungsoptimierung:", fr: "Avec optimisation de puissance :" },
                "Con optimizaciÃ³n de potencias (ajuste tÃ©cnico):": { en: "With power optimization (technical adjustment):", zh: "ä½¿ç”¨åŠŸçŽ‡ä¼˜åŒ–ï¼ˆæŠ€æœ¯è°ƒæ•´ï¼‰ï¼š", de: "Mit Leistungsoptimierung (technische Anpassung):", fr: "Avec optimisation de puissance (ajustement technique) :" },
                "AHORRO TOTAL OPTIMIZADO:": { en: "TOTAL OPTIMIZED SAVINGS:", zh: "æ€»ä¼˜åŒ–èŠ‚çœï¼š", de: "GESAMT OPTIMIERTE ERSPARNIS:", fr: "Ã‰CONOMIES TOTALES OPTIMISÃ‰ES :" },
                "Ahorro adicional optimizando:": { en: "Additional savings with optimization:", zh: "ä¼˜åŒ–å¸¦æ¥çš„é¢å¤–èŠ‚çœï¼š", de: "ZusÃ¤tzliche Ersparnis durch Optimierung:", fr: "Ã‰conomies supplÃ©mentaires avec optimisation :" },
                "DESGLOSE DETALLADO POR SUMINISTRO": { en: "DETAILED BREAKDOWN PER SUPPLY", zh: "æ¯ä¸ªä¾›åº”çš„è¯¦ç»†åˆ†è§£", de: "DETAILLIERTE AUFSCHLÃœSSELUNG PRO VERSORGUNG", fr: "RÃ‰PARTITION DÃ‰TAILLÃ‰E PAR APPROVISIONNEMENT" },
                "[ES] - CON TU TARIFA ACTUAL": { en: "[ES] - WITH YOUR CURRENT RATE", zh: "[ES] - ä½¿ç”¨å½“å‰è´¹çŽ‡", de: "[ES] - MIT IHREM AKTUELLEN TARIF", fr: "[ES] - AVEC VOTRE TARIF ACTUEL" },
                "[ES] - POTENCIAS ACTUALES": { en: "[ES] - CURRENT POWER", zh: "[ES] - å½“å‰åŠŸçŽ‡", de: "[ES] - AKTUELLE LEISTUNG", fr: "[ES] - PUISSANCE ACTUELLE" },
                "[ES] - POTENCIAS OPTIMIZADAS": { en: "[ES] - OPTIMIZED POWER", zh: "[ES] - ä¼˜åŒ–åŠŸçŽ‡", de: "[ES] - OPTIMIERTE LEISTUNG", fr: "[ES] - PUISSANCE OPTIMISÃ‰E" },
                "PRECIOS APLICADOS:": { en: "APPLIED PRICES:", zh: "åº”ç”¨ä»·æ ¼ï¼š", de: "ANGEWANDTE PREISE:", fr: "PRIX APPLIQUÃ‰S :" },
                "POTENCIA:": { en: "POWER:", zh: "åŠŸçŽ‡ï¼š", de: "LEISTUNG:", fr: "PUISSANCE :" },
                "ENERGÃA:": { en: "ENERGY:", zh: "èƒ½æºï¼š", de: "ENERGIE:", fr: "Ã‰NERGIE :" },
                "POTENCIA": { en: "POWER", zh: "åŠŸçŽ‡", de: "LEISTUNG", fr: "PUISSANCE" },
                "ENERGÃA": { en: "ENERGY", zh: "èƒ½æº", de: "ENERGIE", fr: "Ã‰NERGIE" },
                "TOTAL (30 DÃAS)": { en: "TOTAL (30 DAYS)", zh: "æ€»è®¡ï¼ˆ30å¤©ï¼‰", de: "GESAMT (30 TAGE)", fr: "TOTAL (30 JOURS)" },
                "AHORRO:": { en: "SAVINGS:", zh: "èŠ‚çœï¼š", de: "ERSPARNIS:", fr: "Ã‰CONOMIES :" },
                "AHORRO:": { en: "SAVINGS:", zh: "èŠ‚çœï¼š", de: "ERSPARNIS:", fr: "Ã‰CONOMIES :" },
                "Ahorro": { en: "Savings", zh: "èŠ‚çœ", de: "Ersparnis", fr: "Ã‰conomies" },
                "Ahorro adicional": { en: "Additional savings", zh: "é¢å¤–èŠ‚çœ", de: "ZusÃ¤tzliche Ersparnis", fr: "Ã‰conomies supplÃ©mentaires" },
                "RESUMEN DE AHORRO ANUAL": { en: "ANNUAL SAVINGS SUMMARY", zh: "å¹´åº¦èŠ‚çœæ‘˜è¦", de: "ZUSAMMENFASSUNG DER JÃ„HRLICHEN ERSPARNIS", fr: "RÃ‰SUMÃ‰ DES Ã‰CONOMIES ANNUELLES" },
                "Con potencias actuales:": { en: "With current power:", zh: "ä½¿ç”¨å½“å‰åŠŸçŽ‡ï¼š", de: "Mit aktueller Leistung:", fr: "Avec puissance actuelle :" },
                "Ahorro adicional optimizando:": { en: "Additional savings optimizing:", zh: "ä¼˜åŒ–é¢å¤–èŠ‚çœï¼š", de: "ZusÃ¤tzliche Ersparnis durch Optimierung:", fr: "Ã‰conomies supplÃ©mentaires en optimisant :" },
                "PARA FORMALIZAR ESTE CONTRATO:": { en: "TO FORMALIZE THIS CONTRACT:", zh: "æ­£å¼åŒ–æ­¤åˆåŒï¼š", de: "UM DIESEN VERTRAG ZU FORMALISIEREN:", fr: "POUR FORMALISER CE CONTRAT :" },
                "Responde a este email adjuntando la siguiente documentacion:": { en: "Reply to this email attaching the following documentation:", zh: "å›žå¤æ­¤ç”µå­é‚®ä»¶å¹¶é™„ä¸Šä»¥ä¸‹æ–‡ä»¶ï¼š", de: "Antworten Sie auf diese E-Mail und fÃ¼gen Sie die folgende Dokumentation bei:", fr: "RÃ©pondez Ã  cet e-mail en joignant la documentation suivante :" },
                "PARA FORMALIZAR ESTE CONTRATO:": { en: "TO FORMALIZE THIS CONTRACT:", zh: "æ­£å¼åŒ–æ­¤åˆåŒï¼š", de: "UM DIESEN VERTRAG ZU FORMALISIEREN:", fr: "POUR FORMALISER CE CONTRAT :" },
                "Responde a este email adjuntando la siguiente documentacion:": { en: "Reply to this email attaching the following documentation:", zh: "å›žå¤æ­¤ç”µå­é‚®ä»¶å¹¶é™„ä¸Šä»¥ä¸‹æ–‡ä»¶ï¼š", de: "Antworten Sie auf diese E-Mail und fÃ¼gen Sie die folgende Dokumentation bei:", fr: "RÃ©pondez Ã  cet e-mail en joignant la documentation suivante :" },
                "1. Foto del DNI/CIF (anverso y reverso)": { en: "1. Photo of ID/CIF (front and back)", zh: "1. èº«ä»½è¯/CIFç…§ç‰‡ï¼ˆæ­£åé¢ï¼‰", de: "1. Foto des Ausweises/CIF (Vorder- und RÃ¼ckseite)", fr: "1. Photo de la carte d'identitÃ©/CIF (recto et verso)" },
                "2. Ultima factura (minimo 3 meses de antiguedad)": { en: "2. Last invoice (minimum 3 months old)", zh: "2. æœ€åŽå‘ç¥¨ï¼ˆè‡³å°‘3ä¸ªæœˆå‰ï¼‰", de: "2. Letzte Rechnung (mindestens 3 Monate alt)", fr: "2. DerniÃ¨re facture (minimum 3 mois d'anciennetÃ©)" },
                "3. Email de contacto para validacion": { en: "3. Contact email for validation", zh: "3. éªŒè¯è”ç³»ç”µå­é‚®ä»¶", de: "3. Kontakt-E-Mail zur Validierung", fr: "3. E-mail de contact pour validation" },
                "4. Telefono de contacto": { en: "4. Contact phone", zh: "4. è”ç³»ç”µè¯", de: "4. Kontakttelefon", fr: "4. TÃ©lÃ©phone de contact" },
                "5. Numero de cuenta bancaria (IBAN)": { en: "5. Bank account number (IBAN)", zh: "5. é“¶è¡Œè´¦å·ï¼ˆIBANï¼‰", de: "5. Bankkontonummer (IBAN)", fr: "5. NumÃ©ro de compte bancaire (IBAN)" },
                "Envia la documentacion al comercial:": { en: "Send the documentation to the sales representative:", zh: "å°†æ–‡ä»¶å‘é€ç»™é”€å”®ä»£è¡¨ï¼š", de: "Senden Sie die Dokumentation an den Vertriebsmitarbeiter:", fr: "Envoyez la documentation au commercial :" },
                "Foto del DNI/CIF (anverso y reverso)": { en: "Photo of ID/CIF (front and back)", zh: "èº«ä»½è¯/CIFç…§ç‰‡ï¼ˆæ­£åé¢ï¼‰", de: "Foto des Ausweises/CIF (Vorder- und RÃ¼ckseite)", fr: "Photo de la carte d'identitÃ©/CIF (recto et verso)" },
                "Ultima factura (minimo 3 meses de antiguedad)": { en: "Last invoice (minimum 3 months old)", zh: "æœ€åŽå‘ç¥¨ï¼ˆè‡³å°‘3ä¸ªæœˆå‰ï¼‰", de: "Letzte Rechnung (mindestens 3 Monate alt)", fr: "DerniÃ¨re facture (minimum 3 mois d'anciennetÃ©)" },
                "Email de contacto para validacion": { en: "Contact email for validation", zh: "éªŒè¯è”ç³»ç”µå­é‚®ä»¶", de: "Kontakt-E-Mail zur Validierung", fr: "E-mail de contact pour validation" },
                "Telefono de contacto": { en: "Contact phone", zh: "è”ç³»ç”µè¯", de: "Kontakttelefon", fr: "TÃ©lÃ©phone de contact" },
                "Numero de cuenta bancaria (IBAN)": { en: "Bank account number (IBAN)", zh: "é“¶è¡Œè´¦å·ï¼ˆIBANï¼‰", de: "Bankkontonummer (IBAN)", fr: "NumÃ©ro de compte bancaire (IBAN)" },
                "Envia la documentacion al comercial:": { en: "Send the documentation to the sales representative:", zh: "å°†æ–‡ä»¶å‘é€ç»™é”€å”®ä»£è¡¨ï¼š", de: "Senden Sie die Dokumentation an den Vertriebsmitarbeiter:", fr: "Envoyez la documentation au commercial :" },
                "COMPARATIVO 3.0TD CON OPTIMIZACION DE POTENCIAS": { en: "3.0TD COMPARISON WITH POWER OPTIMIZATION", zh: "3.0TDåŠŸçŽ‡ä¼˜åŒ–æ¯”è¾ƒ", de: "3.0TD-VERGLEICH MIT LEISTUNGSOPTIMIERUNG", fr: "COMPARATIF 3.0TD AVEC OPTIMISATION DE PUISSANCE" },
                "CON POTENCIAS ACTUALES": { en: "WITH CURRENT POWER", zh: "ä½¿ç”¨å½“å‰åŠŸçŽ‡", de: "MIT AKTUELLER LEISTUNG", fr: "AVEC PUISSANCE ACTUELLE" },
                "CON POTENCIAS OPTIMIZADAS": { en: "WITH OPTIMIZED POWER", zh: "ä½¿ç”¨ä¼˜åŒ–åŠŸçŽ‡", de: "MIT OPTIMIERTER LEISTUNG", fr: "AVEC PUISSANCE OPTIMISÃ‰E" },
                "POTENCIAS OPTIMIZADAS (kW)": { en: "OPTIMIZED POWER (kW)", zh: "ä¼˜åŒ–åŠŸçŽ‡ (kW)", de: "OPTIMIERTE LEISTUNG (kW)", fr: "PUISSANCE OPTIMISÃ‰E (kW)" },
                "AHORRO ADICIONAL POR OPTIMIZACION DE POTENCIAS": { en: "ADDITIONAL SAVINGS FROM POWER OPTIMIZATION", zh: "åŠŸçŽ‡ä¼˜åŒ–å¸¦æ¥çš„é¢å¤–èŠ‚çœ", de: "ZUSÃ„TZLICHE ERSPARNIS DURCH LEISTUNGSOPTIMIERUNG", fr: "Ã‰CONOMIES SUPPLÃ‰MENTAIRES PAR OPTIMISATION DE PUISSANCE" },
                "TU AHORRO CON OPTIMIZACIÃ“N": { en: "YOUR SAVINGS WITH OPTIMIZATION", zh: "æ‚¨çš„ä¼˜åŒ–èŠ‚çœ", de: "IHRE ERSPARNIS MIT OPTIMIERUNG", fr: "VOS Ã‰CONOMIES AVEC OPTIMISATION" },
                "Comparativa: Potencias Actuales vs Optimizadas": { en: "Comparison: Current Power vs Optimized", zh: "æ¯”è¾ƒï¼šå½“å‰åŠŸçŽ‡ä¸Žä¼˜åŒ–åŠŸçŽ‡", de: "Vergleich: Aktuelle Leistung vs Optimierte", fr: "Comparaison : Puissance Actuelle vs OptimisÃ©e" },
                "CÃ³digo Comercial:": { en: "Sales Code:", zh: "é”€å”®ä»£ç ï¼š", de: "Vertriebscode:", fr: "Code Commercial :" },
                
                "EnergÃ­a": { en: "Energy", zh: "èƒ½æº", de: "Energie", fr: "Ã‰nergie" },
                "èƒ½æº": { es: "EnergÃ­a", en: "Energy", zh: "èƒ½æº", de: "Energie", fr: "Ã‰nergie" },
                "å¼•é¢†èŠ‚çœå’Œèƒ½æºæ•ˆçŽ‡": { es: "Liderando el ahorro y la eficiencia energÃ©tica", en: "Leading savings and energy efficiency", zh: "å¼•é¢†èŠ‚çœå’Œèƒ½æºæ•ˆçŽ‡", de: "FÃ¼hrend bei Einsparungen und Energieeffizienz", fr: "Leader en Ã©conomies et efficacitÃ© Ã©nergÃ©tique" },
                "ä¸ºæ‚¨æä¾›çš„æœ€ä½³é€‰æ‹©": { es: "La mejor opciÃ³n para ti", en: "The best option for you", zh: "ä¸ºæ‚¨æä¾›çš„æœ€ä½³é€‰æ‹©", de: "Die beste Option fÃ¼r Sie", fr: "La meilleure option pour vous" },
                "æ‚¨çš„é¢„è®¡å¹´åº¦èŠ‚çœ": { es: "Tu ahorro anual estimado", en: "Your estimated annual savings", zh: "æ‚¨çš„é¢„è®¡å¹´åº¦èŠ‚çœ", de: "Ihre geschÃ¤tzte jÃ¤hrliche Ersparnis", fr: "Vos Ã©conomies annuelles estimÃ©es" },
                "æ‚¨çš„å½“å‰è´¦å•": { es: "Tu factura actual", en: "Your current bill", zh: "æ‚¨çš„å½“å‰è´¦å•", de: "Ihre aktuelle Rechnung", fr: "Votre facture actuelle" },
                "æ‚¨çš„æ–°DRKæˆæœ¬": { es: "Tu nuevo coste DRK", en: "Your new DRK cost", zh: "æ‚¨çš„æ–°DRKæˆæœ¬", de: "Ihre neuen DRK-Kosten", fr: "Votre nouveau coÃ»t DRK" },
                "æå–æ•°æ®": { es: "Datos extraÃ­dos", en: "Extracted data", zh: "æå–æ•°æ®", de: "Extrahierte Daten", fr: "DonnÃ©es extraites" },
                "æœŸé—´": { es: "Periodo", en: "Period", zh: "æœŸé—´", de: "Zeitraum", fr: "PÃ©riode" },
                "å¤©": { es: "dÃ­as", en: "days", zh: "å¤©", de: "Tage", fr: "jours" },
                "æ—¥æœŸ": { es: "Fecha", en: "Date", zh: "æ—¥æœŸ", de: "Datum", fr: "Date" },
                "æœŸé—´æ¶ˆè€— (kWh)": { es: "Consumo del periodo (kWh)", en: "Period consumption (kWh)", zh: "æœŸé—´æ¶ˆè€— (kWh)", de: "Verbrauch im Zeitraum (kWh)", fr: "Consommation de la pÃ©riode (kWh)" },
                "å³°å€¼": { es: "Punta", en: "Peak", zh: "å³°å€¼", de: "Spitzenlast", fr: "Pointe" },
                "å¹³æ®µ": { es: "Llano", en: "Mid-peak", zh: "å¹³æ®µ", de: "Mittellast", fr: "Heures pleines" },
                "è°·æ®µ": { es: "Valle", en: "Off-peak", zh: "è°·æ®µ", de: "Schwachlast", fr: "Heures creuses" },
                "æ€»æ¶ˆè€—": { es: "Consumo total", en: "Total consumption", zh: "æ€»æ¶ˆè€—", de: "Gesamtverbrauch", fr: "Consommation totale" },
                "ç­¾çº¦åŠŸçŽ‡ (kW)": { es: "Potencia contratada (kW)", en: "Contracted power (kW)", zh: "ç­¾çº¦åŠŸçŽ‡ (kW)", de: "Vertragsleistung (kW)", fr: "Puissance contractÃ©e (kW)" },
                "åˆå¹¶æŠ¥ä»·ä»·æ ¼": { es: "Precios de la oferta combinada", en: "Combined offer prices", zh: "åˆå¹¶æŠ¥ä»·ä»·æ ¼", de: "Kombinierte Angebotspreise", fr: "Prix de l'offre combinÃ©e" },
                "èµ„è´¹ 2.0 TD": { es: "Tarifa 2.0 TD", en: "Tariff 2.0 TD", zh: "èµ„è´¹ 2.0 TD", de: "Tarif 2.0 TD", fr: "Tarif 2.0 TD" },
                "æ—¥": { es: "dÃ­a", en: "day", zh: "æ—¥", de: "Tag", fr: "jour" },
                "èƒ½æº (â‚¬/kWh)": { es: "EnergÃ­a (â‚¬/kWh)", en: "Energy (â‚¬/kWh)", zh: "èƒ½æº (â‚¬/kWh)", de: "Energie (â‚¬/kWh)", fr: "Ã‰nergie (â‚¬/kWh)" },
                "æ˜¾ç¤ºçš„ä»·æ ¼æ¥è‡ªä¸­æ ‡æŠ¥ä»·ã€‚": { es: "Los precios mostrados son de la oferta ganadora.", en: "Displayed prices are from the winning offer.", zh: "æ˜¾ç¤ºçš„ä»·æ ¼æ¥è‡ªä¸­æ ‡æŠ¥ä»·ã€‚", de: "Angezeigte Preise stammen aus dem Gewinner-Angebot.", fr: "Les prix affichÃ©s proviennent de l'offre gagnante." },
                "å®˜æ–¹è®¡ç®—": { es: "CÃ¡lculo oficial", en: "Official calculation", zh: "å®˜æ–¹è®¡ç®—", de: "Offizielle Berechnung", fr: "Calcul officiel" },
                "æ¨¡æ‹Ÿ": { es: "SimulaciÃ³n", en: "Simulation", zh: "æ¨¡æ‹Ÿ", de: "Simulation", fr: "Simulation" },
                "åŠŸçŽ‡ (â‚¬/kW æ—¥)": { es: "Potencia (â‚¬/kW dÃ­a)", en: "Power (â‚¬/kW day)", zh: "åŠŸçŽ‡ (â‚¬/kW æ—¥)", de: "Leistung (â‚¬/kW Tag)", fr: "Puissance (â‚¬/kW jour)" },
                "åŠŸçŽ‡å°è®¡": { es: "Subtotal potencia", en: "Power subtotal", zh: "åŠŸçŽ‡å°è®¡", de: "Leistung Zwischensumme", fr: "Sous-total puissance" },
                "å¢žå€¼ç¨Žï¼ˆ21%ï¼‰": { es: "IVA (21%)", en: "VAT (21%)", zh: "å¢žå€¼ç¨Žï¼ˆ21%ï¼‰", de: "MwSt. (21%)", fr: "TVA (21%)" },
                "æ€»è´¦å•": { es: "Factura total", en: "Total bill", zh: "æ€»è´¦å•", de: "Gesamtrechnung", fr: "Facture totale" },
                "ä¼°è®¡å¹´åº¦æ€»é¢": { es: "Total anual estimado", en: "Estimated annual total", zh: "ä¼°è®¡å¹´åº¦æ€»é¢", de: "GeschÃ¤tzte Jahressumme", fr: "Total annuel estimÃ©" },
                "æ‰€æœ‰æ–‡æœ¬å‡ä¸ºä¸­æ–‡ Â· å¯ç›´æŽ¥ä½¿ç”¨": { es: "Todo el texto en idioma actual Â· Listo para usar", en: "All text in current language Â· Ready to use", zh: "æ‰€æœ‰æ–‡æœ¬å‡ä¸ºä¸­æ–‡ Â· å¯ç›´æŽ¥ä½¿ç”¨", de: "Alle Texte in aktueller Sprache Â· Sofort einsatzbereit", fr: "Tout le texte dans la langue actuelle Â· PrÃªt Ã  l'emploi" },
                "Selector": { en: "Selector", zh: "é€‰æ‹©å™¨", de: "Auswahl", fr: "SÃ©lecteur" },
                "MULTICUPS": { en: "MULTICUPS", zh: "å¤šåˆåŒ", de: "MULTICUPS", fr: "MULTICUPS" },
                "GAS": { en: "GAS", zh: "å¤©ç„¶æ°”", de: "GAS", fr: "GAZ" },
                "DUAL": { en: "DUAL", zh: "åŒé‡", de: "DUAL", fr: "DUAL" },
                "dÃ­as": { en: "days", zh: "å¤©", de: "Tage", fr: "jours" },
                
                // Botones y acciones PDF/Copiar
                "Descargar PDF Global": { en: "Download Global PDF", zh: "ä¸‹è½½å…¨å±€PDF", de: "Globales PDF herunterladen", fr: "TÃ©lÃ©charger PDF Global" },
                "Copiar HTML": { en: "Copy HTML", zh: "å¤åˆ¶HTML", de: "HTML kopieren", fr: "Copier HTML" },
                "COPIAR COMPARATIVO": { en: "COPY COMPARISON", zh: "å¤åˆ¶æ¯”è¾ƒ", de: "VERGLEICH KOPIEREN", fr: "COPIER LA COMPARAISON" },
                "ðŸ“‹ COPIAR COMPARATIVO (HTML)": { en: "ðŸ“‹ COPY COMPARISON (HTML)", zh: "ðŸ“‹ å¤åˆ¶æ¯”è¾ƒï¼ˆHTMLï¼‰", de: "ðŸ“‹ VERGLEICH KOPIEREN (HTML)", fr: "ðŸ“‹ COPIER LA COMPARAISON (HTML)" },
                "ðŸ“„ CREAR PDF COMPARATIVO": { en: "ðŸ“„ CREATE PDF COMPARISON", zh: "ðŸ“„ åˆ›å»ºPDFæ¯”è¾ƒ", de: "ðŸ“„ PDF-VERGLEICH ERSTELLEN", fr: "ðŸ“„ CRÃ‰ER UN PDF COMPARATIF" },
                "ðŸ“§ COPIAR COMPARATIVO (HTML)": { en: "ðŸ“§ COPY COMPARISON (HTML)", zh: "ðŸ“§ å¤åˆ¶æ¯”è¾ƒï¼ˆHTMLï¼‰", de: "ðŸ“§ VERGLEICH KOPIEREN (HTML)", fr: "ðŸ“§ COPIER LA COMPARAISON (HTML)" },
                
                // Modales y mensajes
                "Entendido": { en: "Understood", zh: "æ˜Žç™½", de: "Verstanden", fr: "Compris" },
                "Ã‰xito": { en: "Success", zh: "æˆåŠŸ", de: "Erfolg", fr: "SuccÃ¨s" },
                "Â¡AtenciÃ³n!": { en: "Attention!", zh: "æ³¨æ„ï¼", de: "Achtung!", fr: "Attention!" },
                
                // Mensajes de error y validaciÃ³n
                "No se detectÃ³ ninguna imagen en el portapapeles.": { en: "No image detected in clipboard.", zh: "æœªåœ¨å‰ªè´´æ¿ä¸­æ£€æµ‹åˆ°å›¾åƒã€‚", de: "Kein Bild in der Zwischenablage erkannt.", fr: "Aucune image dÃ©tectÃ©e dans le presse-papiers." },
                "AÃ±ada al menos un suministro.": { en: "Add at least one supply.", zh: "è‡³å°‘æ·»åŠ ä¸€ä¸ªä¾›åº”ã€‚", de: "FÃ¼gen Sie mindestens eine Versorgung hinzu.", fr: "Ajoutez au moins un approvisionnement." },
                "No hay suministros para comparar.": { en: "No supplies to compare.", zh: "æ²¡æœ‰è¦æ¯”è¾ƒçš„ä¾›åº”ã€‚", de: "Keine Versorgungen zum Vergleichen.", fr: "Aucun approvisionnement Ã  comparer." },
                "Primero realice una comparaciÃ³n.": { en: "First perform a comparison.", zh: "è¯·å…ˆè¿›è¡Œæ¯”è¾ƒã€‚", de: "FÃ¼hren Sie zuerst einen Vergleich durch.", fr: "Effectuez d'abord une comparaison." },
                "Indique el CÃ³digo Comercial.": { en: "Enter the Sales Code.", zh: "è¾“å…¥é”€å”®ä»£ç ã€‚", de: "Geben Sie den Vertriebscode ein.", fr: "Indiquez le Code Commercial." },
                "No se pudo copiar el diseÃ±o visual. Intente desde un PC o contacte a soporte.": { en: "Could not copy visual design. Try from a PC or contact support.", zh: "æ— æ³•å¤åˆ¶è§†è§‰è®¾è®¡ã€‚è¯·ä»ŽPCå°è¯•æˆ–è”ç³»æ”¯æŒã€‚", de: "Visuelles Design konnte nicht kopiert werden. Versuchen Sie es von einem PC aus oder kontaktieren Sie den Support.", fr: "Impossible de copier le design visuel. Essayez depuis un PC ou contactez le support." },
                "No se pudo copiar el contenido. Por favor, contacte a soporte.": { en: "Could not copy content. Please contact support.", zh: "æ— æ³•å¤åˆ¶å†…å®¹ã€‚è¯·è”ç³»æ”¯æŒã€‚", de: "Inhalt konnte nicht kopiert werden. Bitte kontaktieren Sie den Support.", fr: "Impossible de copier le contenu. Veuillez contacter le support." },
                
                // Mensajes de generaciÃ³n de PDF
                "â³ Generando PDF con comparaciÃ³n Fijo vs Indexado... Por favor espere.": { en: "â³ Generating PDF with Fixed vs Indexed comparison... Please wait.", zh: "â³ æ­£åœ¨ç”Ÿæˆå›ºå®šä¸ŽæŒ‡æ•°æ¯”è¾ƒPDF...è¯·ç¨å€™ã€‚", de: "â³ PDF mit Vergleich Fest vs. Indexiert wird erstellt... Bitte warten.", fr: "â³ GÃ©nÃ©ration du PDF avec comparaison Fixe vs IndexÃ©... Veuillez patienter." },
                "â³ Generando PDF MULTICUPS con comparaciÃ³n Fijo vs Indexado... Por favor espere.": { en: "â³ Generating MULTICUPS PDF with Fixed vs Indexed comparison... Please wait.", zh: "â³ æ­£åœ¨ç”Ÿæˆå¤šåˆåŒå›ºå®šä¸ŽæŒ‡æ•°æ¯”è¾ƒPDF...è¯·ç¨å€™ã€‚", de: "â³ MULTICUPS-PDF mit Vergleich Fest vs. Indexiert wird erstellt... Bitte warten.", fr: "â³ GÃ©nÃ©ration du PDF MULTICUPS avec comparaison Fixe vs IndexÃ©... Veuillez patienter." },
                "â³ Generando PDF profesional... Por favor espere.": { en: "â³ Generating professional PDF... Please wait.", zh: "â³ æ­£åœ¨ç”Ÿæˆä¸“ä¸šPDF...è¯·ç¨å€™ã€‚", de: "â³ Professionelles PDF wird erstellt... Bitte warten.", fr: "â³ GÃ©nÃ©ration du PDF professionnel... Veuillez patienter." },
                "â³ Generando PDF... Por favor espere.": { en: "â³ Generating PDF... Please wait.", zh: "â³ æ­£åœ¨ç”ŸæˆPDF...è¯·ç¨å€™ã€‚", de: "â³ PDF wird erstellt... Bitte warten.", fr: "â³ GÃ©nÃ©ration du PDF... Veuillez patienter." },
                "â³ Generando PDF comparativo...": { en: "â³ Generating comparison PDF...", zh: "â³ æ­£åœ¨ç”Ÿæˆæ¯”è¾ƒPDF...", de: "â³ Vergleichs-PDF wird erstellt...", fr: "â³ GÃ©nÃ©ration du PDF comparatif..." },
                "â³ Generando PDF POWER CUP...": { en: "â³ Generating POWER CUP PDF...", zh: "â³ æ­£åœ¨ç”ŸæˆPOWER CUP PDF...", de: "â³ POWER CUP PDF wird erstellt...", fr: "â³ GÃ©nÃ©ration du PDF POWER CUP..." },
                "â³ Generando PDF comparativo POWER CUP...": { en: "â³ Generating POWER CUP comparison PDF...", zh: "â³ æ­£åœ¨ç”ŸæˆPOWER CUPæ¯”è¾ƒPDF...", de: "â³ POWER CUP Vergleichs-PDF wird erstellt...", fr: "â³ GÃ©nÃ©ration du PDF comparatif POWER CUP..." },
                
                // Mensajes de alertas
                "âŒ No se pudo copiar automÃ¡ticamente.\\n\\nPor favor, usa el botÃ³n \"CREAR PDF COMPARATIVO\" en su lugar.": { en: "âŒ Could not copy automatically.\\n\\nPlease use the \"CREATE PDF COMPARISON\" button instead.", zh: "âŒ æ— æ³•è‡ªåŠ¨å¤åˆ¶ã€‚\\n\\nè¯·æ”¹ç”¨\"åˆ›å»ºPDFæ¯”è¾ƒ\"æŒ‰é’®ã€‚", de: "âŒ Automatisches Kopieren fehlgeschlagen.\\n\\nBitte verwenden Sie stattdessen die SchaltflÃ¤che \"PDF-VERGLEICH ERSTELLEN\".", fr: "âŒ Impossible de copier automatiquement.\\n\\nVeuillez utiliser le bouton \"CRÃ‰ER UN PDF COMPARATIF\" Ã  la place." },
                "No se pudo copiar automÃ¡ticamente.\\n\\nâœ… SOLUCIÃ“N:\\n\\n1. Haz clic derecho sobre el contenido abajo\\n2. Selecciona \"Copiar\"\\n3. Pega en tu correo electrÃ³nico\\n\\nO usa Ctrl+A para seleccionar todo y luego Ctrl+C para copiar.": { en: "Could not copy automatically.\\n\\nâœ… SOLUTION:\\n\\n1. Right-click on the content below\\n2. Select \"Copy\"\\n3. Paste into your email\\n\\nOr use Ctrl+A to select all and then Ctrl+C to copy.", zh: "æ— æ³•è‡ªåŠ¨å¤åˆ¶ã€‚\\n\\nâœ… è§£å†³æ–¹æ¡ˆï¼š\\n\\n1. å³é”®å•å‡»ä¸‹é¢çš„å†…å®¹\\n2. é€‰æ‹©\"å¤åˆ¶\"\\n3. ç²˜è´´åˆ°æ‚¨çš„ç”µå­é‚®ä»¶\\n\\næˆ–ä½¿ç”¨Ctrl+Aé€‰æ‹©å…¨éƒ¨ï¼Œç„¶åŽä½¿ç”¨Ctrl+Cå¤åˆ¶ã€‚", de: "Automatisches Kopieren fehlgeschlagen.\\n\\nâœ… LÃ–SUNG:\\n\\n1. Rechtsklick auf den Inhalt unten\\n2. \"Kopieren\" auswÃ¤hlen\\n3. In Ihre E-Mail einfÃ¼gen\\n\\nOder verwenden Sie Strg+A zum AuswÃ¤hlen und dann Strg+C zum Kopieren.", fr: "Impossible de copier automatiquement.\\n\\nâœ… SOLUTION :\\n\\n1. Clic droit sur le contenu ci-dessous\\n2. SÃ©lectionnez \"Copier\"\\n3. Collez dans votre e-mail\\n\\nOu utilisez Ctrl+A pour tout sÃ©lectionner puis Ctrl+C pour copier." },
                "<span style=\"color: #16a34a; font-weight: bold;\">OPCIÃ“N 1:</span> Haz clic en \"Copiar HTML\" (automÃ¡tico)": { en: "<span style=\"color: #16a34a; font-weight: bold;\">OPTION 1:</span> Click \"Copy HTML\" (automatic)", zh: "<span style=\"color: #16a34a; font-weight: bold;\">é€‰é¡¹1ï¼š</span> ç‚¹å‡»\"å¤åˆ¶HTML\"ï¼ˆè‡ªåŠ¨ï¼‰", de: "<span style=\"color: #16a34a; font-weight: bold;\">OPTION 1:</span> Klicken Sie auf \"HTML kopieren\" (automatisch)", fr: "<span style=\"color: #16a34a; font-weight: bold;\">OPTION 1 :</span> Cliquez sur \"Copier HTML\" (automatique)" },
                
                // Textos del PDF y visualizador comparativo
                "ðŸ“Š ESTUDIO DE AHORRO": { en: "ðŸ“Š SAVINGS STUDY", zh: "ðŸ“Š èŠ‚çœç ”ç©¶", de: "ðŸ“Š EINSPARUNGSSTUDIE", fr: "ðŸ“Š Ã‰TUDE D'Ã‰CONOMIES" },
                "ESTUDIO DE AHORRO": { en: "SAVINGS STUDY", zh: "èŠ‚çœç ”ç©¶", de: "EINSPARUNGSSTUDIE", fr: "Ã‰TUDE D'Ã‰CONOMIES" },
                "COMPARATIVA PROFESIONAL": { en: "PROFESSIONAL COMPARISON", zh: "ä¸“ä¸šæ¯”è¾ƒ", de: "PROFESSIONELLER VERGLEICH", fr: "COMPARAISON PROFESSIONNELLE" },
                "AsesorÃ­a EnergÃ©tica": { en: "Energy Consulting", zh: "èƒ½æºå’¨è¯¢", de: "Energieberatung", fr: "Conseil Ã‰nergÃ©tique" },
                "Liderando el ahorro y la eficiencia energÃ©tica.": { en: "Leading savings and energy efficiency.", zh: "å¼•é¢†èŠ‚çœå’Œèƒ½æºæ•ˆçŽ‡ã€‚", de: "FÃ¼hrend bei Einsparungen und Energieeffizienz.", fr: "Leader des Ã©conomies et de l'efficacitÃ© Ã©nergÃ©tique." },
                "Ofrece el mayor ahorro consolidado con": { en: "Offers the highest consolidated savings with", zh: "æä¾›æœ€é«˜çš„ç»¼åˆèŠ‚çœä¸Ž", de: "Bietet die hÃ¶chsten konsolidierten Einsparungen mit", fr: "Offre les Ã©conomies consolidÃ©es les plus Ã©levÃ©es avec" },
                "TU FACTURA ACTUAL": { en: "YOUR CURRENT BILL", zh: "æ‚¨å½“å‰çš„è´¦å•", de: "IHRE AKTUELLE RECHNUNG", fr: "VOTRE FACTURE ACTUELLE" },
                "TU AHORRO ANUAL FIJO": { en: "YOUR ANNUAL FIXED SAVINGS", zh: "æ‚¨çš„å¹´åº¦å›ºå®šèŠ‚çœ", de: "IHRE JÃ„HRLICHEN FESTEN EINSPARUNGEN", fr: "VOS Ã‰CONOMIES ANNUELLES FIXES" },
                "TU AHORRO ANUAL INDEXADO": { en: "YOUR ANNUAL INDEXED SAVINGS", zh: "æ‚¨çš„å¹´åº¦æŒ‡æ•°èŠ‚çœ", de: "IHRE JÃ„HRLICHEN INDEXIERTEN EINSPARUNGEN", fr: "VOS Ã‰CONOMIES ANNUELLES INDEXÃ‰ES" },
                "Tu Ahorro Anual Estimado": { en: "Your Estimated Annual Savings", zh: "æ‚¨çš„é¢„è®¡å¹´åº¦èŠ‚çœ", de: "Ihre geschÃ¤tzten jÃ¤hrlichen Einsparungen", fr: "Vos Ã‰conomies Annuelles EstimÃ©es" },
                "ðŸ’° Ahorro Total": { en: "ðŸ’° Total Savings", zh: "ðŸ’° æ€»èŠ‚çœ", de: "ðŸ’° Gesamtersparnis", fr: "ðŸ’° Ã‰conomies Totales" },
                "Ahorro Anual": { en: "Annual Savings", zh: "å¹´åº¦èŠ‚çœ", de: "JÃ¤hrliche Einsparungen", fr: "Ã‰conomies Annuelles" },
                "ðŸ’µ Ahorro Anual Estimado:": { en: "ðŸ’µ Estimated Annual Savings:", zh: "ðŸ’µ é¢„è®¡å¹´åº¦èŠ‚çœï¼š", de: "ðŸ’µ GeschÃ¤tzte jÃ¤hrliche Einsparungen:", fr: "ðŸ’µ Ã‰conomies Annuelles EstimÃ©es :" },
                "ðŸ’µ Ahorro Anual Consolidado:": { en: "ðŸ’µ Consolidated Annual Savings:", zh: "ðŸ’µ ç»¼åˆå¹´åº¦èŠ‚çœï¼š", de: "ðŸ’µ Konsolidierte jÃ¤hrliche Einsparungen:", fr: "ðŸ’µ Ã‰conomies Annuelles ConsolidÃ©es :" },
                "ðŸŽ‰ Ahorro Anual Total:": { en: "ðŸŽ‰ Total Annual Savings:", zh: "ðŸŽ‰ å¹´åº¦æ€»èŠ‚çœï¼š", de: "ðŸŽ‰ JÃ¤hrliche Gesamtersparnis:", fr: "ðŸŽ‰ Ã‰conomies Annuelles Totales :" },
                "ðŸ’¼ Ahorro Total con Tarifas FIJAS:": { en: "ðŸ’¼ Total Savings with FIXED Rates:", zh: "ðŸ’¼ å›ºå®šè´¹çŽ‡æ€»èŠ‚çœï¼š", de: "ðŸ’¼ Gesamtersparnis mit FESTEN Tarifen:", fr: "ðŸ’¼ Ã‰conomies Totales avec Tarifs FIXES :" },
                "âš¡ Ahorro Total con Tarifas INDEXADAS:": { en: "âš¡ Total Savings with INDEXED Rates:", zh: "âš¡ æŒ‡æ•°è´¹çŽ‡æ€»èŠ‚çœï¼š", de: "âš¡ Gesamtersparnis mit INDEXIERTEN Tarifen:", fr: "âš¡ Ã‰conomies Totales avec Tarifs INDEXÃ‰S :" },
                "CUPS:": { en: "CUPS:", zh: "CUPSï¼š", de: "CUPS:", fr: "CUPS :" },
                "ðŸ”Œ CUPS:": { en: "ðŸ”Œ CUPS:", zh: "ðŸ”Œ CUPSï¼š", de: "ðŸ”Œ CUPS:", fr: "ðŸ”Œ CUPS :" },
                "aÃ±o": { en: "year", zh: "å¹´", de: "Jahr", fr: "an" },
                "/aÃ±o": { en: "/year", zh: "/å¹´", de: "/Jahr", fr: "/an" },
                "basado en el consumo de": { en: "based on consumption of", zh: "åŸºäºŽæ¶ˆè€—", de: "basierend auf einem Verbrauch von", fr: "basÃ© sur une consommation de" },
                "ðŸ“Š Total de CUPS:": { en: "ðŸ“Š Total CUPS:", zh: "ðŸ“Š æ€»CUPSï¼š", de: "ðŸ“Š Gesamt-CUPS:", fr: "ðŸ“Š Total CUPS :" },
                "TOTAL CUPS:": { en: "TOTAL CUPS:", zh: "æ€»CUPSï¼š", de: "GESAMT-CUPS:", fr: "TOTAL CUPS :" },
                "ðŸ“Š COMPARATIVA MULTICUPS:": { en: "ðŸ“Š MULTICUPS COMPARISON:", zh: "ðŸ“Š å¤šåˆåŒæ¯”è¾ƒï¼š", de: "ðŸ“Š MULTICUPS-VERGLEICH:", fr: "ðŸ“Š COMPARAISON MULTICUPS :" },
                
                // Textos adicionales del PDF
                "CLIENTE:": { en: "CLIENT:", zh: "å®¢æˆ·ï¼š", de: "KUNDE:", fr: "CLIENT :" },
                "COMERCIAL:": { en: "SALES REP:", zh: "é”€å”®ä»£è¡¨ï¼š", de: "VERTRIEB:", fr: "COMMERCIAL :" },
                "PRECIOS DE LA OFERTA:": { en: "OFFER PRICES:", zh: "æŠ¥ä»·ä»·æ ¼ï¼š", de: "ANGEBOTSPREISE:", fr: "PRIX DE L'OFFRE :" },
                "POTENCIA:": { en: "POWER:", zh: "åŠŸçŽ‡ï¼š", de: "LEISTUNG:", fr: "PUISSANCE :" },
                "ENERGIA:": { en: "ENERGY:", zh: "èƒ½æºï¼š", de: "ENERGIE:", fr: "Ã‰NERGIE :" },
                "DESGLOSE DETALLADO POR SUMINISTRO": { en: "DETAILED BREAKDOWN BY SUPPLY", zh: "æŒ‰ä¾›åº”è¯¦ç»†åˆ†ç±»", de: "DETAILLIERTE AUFSCHLÃœSSELUNG NACH VERSORGUNG", fr: "RÃ‰PARTITION DÃ‰TAILLÃ‰E PAR APPROVISIONNEMENT" },
                "DESARROLLO DETALLADO - SUMINISTRO": { en: "DETAILED BREAKDOWN - SUPPLY", zh: "è¯¦ç»†å¼€å‘ - ä¾›åº”", de: "DETAILLIERTE ENTWICKLUNG - VERSORGUNG", fr: "DÃ‰VELOPPEMENT DÃ‰TAILLÃ‰ - APPROVISIONNEMENT" },
                "DE": { en: "OF", zh: "çš„", de: "VON", fr: "DE" },
                "TARIFAS FIJAS": { en: "FIXED RATES", zh: "å›ºå®šè´¹çŽ‡", de: "FESTE TARIFE", fr: "TARIFS FIXES" },
                "TARIFAS INDEXADAS": { en: "INDEXED RATES", zh: "æŒ‡æ•°è´¹çŽ‡", de: "INDEXIERTE TARIFE", fr: "TARIFS INDEXÃ‰S" },
                "CUAL ES LA DIFERENCIA?": { en: "WHAT'S THE DIFFERENCE?", zh: "æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ", de: "WAS IST DER UNTERSCHIED?", fr: "QUELLE EST LA DIFFÃ‰RENCE ?" },
                "POR QUE TARIFA FIJA?": { en: "WHY FIXED RATE?", zh: "ä¸ºä»€ä¹ˆé€‰æ‹©å›ºå®šè´¹çŽ‡ï¼Ÿ", de: "WARUM FESTER TARIF?", fr: "POURQUOI UN TARIF FIXE ?" },
                "POR QUE TARIFA INDEXADA?": { en: "WHY INDEXED RATE?", zh: "ä¸ºä»€ä¹ˆé€‰æ‹©æŒ‡æ•°è´¹çŽ‡ï¼Ÿ", de: "WARUM INDEXIERTER TARIF?", fr: "POURQUOI UN TARIF INDEXÃ‰ ?" },
                "â€¢ Implica un precio fijo por los kilovatios que": { en: "â€¢ Means a fixed price for the kilowatts", zh: "â€¢ æ„å‘³ç€åƒç“¦ä»·æ ¼å›ºå®š", de: "â€¢ Bedeutet einen festen Preis fur Kilowatt", fr: "â€¢ Implique un prix fixe pour les kilowatts" },
                "  consumes (kWh).": { en: "  you consume (kWh).", zh: "  æ‚¨æ¶ˆè´¹ï¼ˆkWhï¼‰ã€‚", de: "  die Sie verbrauchen (kWh).", fr: "  que vous consommez (kWh)." },
                "â€¢ El precio se mantiene estable,": { en: "â€¢ The price remains stable,", zh: "â€¢ ä»·æ ¼ä¿æŒç¨³å®šï¼Œ", de: "â€¢ Der Preis bleibt stabil,", fr: "â€¢ Le prix reste stable," },
                "  independientemente de como se comporten los": { en: "  regardless of how prices behave in", zh: "  ä¸å—å¸‚åœºä»·æ ¼", de: "  unabhangig davon, wie sich die Preise auf", fr: "  quel que soit le comportement des prix sur" },
                "  precios en el mercado electrico.": { en: "  the electricity market.", zh: "  åœ¨ç”µåŠ›å¸‚åœºçš„å½±å“ã€‚", de: "  dem Strommarkt verhalten.", fr: "  le marche de l'electricite." },
                "â€¢ Cuando el precio del mercado esta alto, el": { en: "â€¢ When the market price is high, the", zh: "â€¢ å½“å¸‚åœºä»·æ ¼é«˜æ—¶ï¼Œ", de: "â€¢ Wenn der Marktpreis hoch ist, ist", fr: "â€¢ Lorsque le prix du marche est eleve, le" },
                "  cliente esta protegido frente a sobresaltos.": { en: "  customer is protected from sudden increases.", zh: "  å®¢æˆ·å¯ä»¥å…å—çªç„¶ä¸Šæ¶¨çš„å½±å“ã€‚", de: "  der Kunde vor plotzlichen Anstiegen geschutzt.", fr: "  client est protege contre les hausses soudaines." },
                "â€¢ No tendras que estar pendiente de las": { en: "â€¢ You won't have to worry about", zh: "â€¢ æ‚¨æ— éœ€æ‹…å¿ƒå¸‚åœº", de: "â€¢ Sie mussen sich keine Gedanken uber", fr: "â€¢ Vous n'aurez pas a vous soucier des" },
                "  variaciones del mercado y podras seguir": { en: "  market fluctuations and can continue", zh: "  æ³¢åŠ¨ï¼Œå¯ä»¥ç…§å¸¸", de: "  Marktschwankungen machen und konnen weiterhin", fr: "  fluctuations du marche et pourrez continuer" },
                "  usando la electricidad como siempre.": { en: "  using electricity as usual.", zh: "  ä½¿ç”¨ç”µåŠ›ã€‚", de: "  Strom wie gewohnt nutzen.", fr: "  a utiliser l'electricite comme d'habitude." },
                "â€¢ Implica un precio variable por los kilovatios": { en: "â€¢ Means a variable price for the kilowatts", zh: "â€¢ æ„å‘³ç€åƒç“¦ä»·æ ¼å¯å˜", de: "â€¢ Bedeutet einen variablen Preis fur Kilowatt", fr: "â€¢ Implique un prix variable pour les kilowatts" },
                "  que consumes (kWh) cada mes.": { en: "  you consume (kWh) each month.", zh: "  æ¯æœˆæ¶ˆè´¹ï¼ˆkWhï¼‰ã€‚", de: "  die Sie monatlich verbrauchen (kWh).", fr: "  que vous consommez (kWh) chaque mois." },
                "â€¢ Es la tarifa mas justa, ya que pagas el coste": { en: "â€¢ It's the fairest rate, as you pay the real", zh: "â€¢ è¿™æ˜¯æœ€å…¬å¹³çš„è´¹çŽ‡ï¼Œå› ä¸ºæ‚¨æ”¯ä»˜", de: "â€¢ Es ist der fairste Tarif, da Sie die tatsachlichen", fr: "â€¢ C'est le tarif le plus juste, car vous payez le cout" },
                "  real de la energia mes a mes.": { en: "  cost of energy month by month.", zh: "  æ¯æœˆèƒ½æºçš„å®žé™…æˆæœ¬ã€‚", de: "  Energiekosten Monat fur Monat zahlen.", fr: "  reel de l'energie mois apres mois." },
                "â€¢ Al contratarla, el cliente evita pagar": { en: "â€¢ By contracting it, the customer avoids paying", zh: "â€¢ ç­¾è®¢åˆåŒåŽï¼Œå®¢æˆ·å¯ä»¥é¿å…æ”¯ä»˜", de: "â€¢ Durch den Abschluss vermeidet der Kunde", fr: "â€¢ En le contractant, le client evite de payer" },
                "  margenes adicionales cuando el precio de la": { en: "  additional margins when the electricity", zh: "  å½“ç”µä»·ä¾¿å®œæ—¶çš„é¢å¤–", de: "  zusatzliche Margen, wenn die Strom", fr: "  des marges supplementaires lorsque le prix de" },
                "  electricidad es mas barato.": { en: "  price is cheaper.", zh: "  åˆ©æ¶¦ã€‚", de: "  preise gunstiger sind.", fr: "  l'electricite est moins cher." },
                "â€¢ A largo plazo, con un indexado 100%": { en: "â€¢ In the long term, with 100%", zh: "â€¢ ä»Žé•¿è¿œæ¥çœ‹ï¼Œé€šè¿‡100%", de: "â€¢ Langfristig konnen mit einer", fr: "â€¢ A long terme, avec une indexation 100%" },
                "  funcional, se puede obtener un ahorro": { en: "  functional indexation, savings of up", zh: "  åŠŸèƒ½æ€§çš„æŒ‡æ•°åŒ–ï¼Œå¯ä»¥èŠ‚çœ", de: "  voll funktionsfahigen 100%igen Indexierung", fr: "  fonctionnelle, des economies pouvant" },
                "  aproximado de hasta un 20% en epocas de": { en: "  to 20% can be achieved during periods", zh: "  åœ¨ä»·æ ¼è¾ƒå¥½çš„æ—¶æœŸé«˜è¾¾", de: "  Einsparungen von bis zu 20% in Zeiten", fr: "  aller jusqu'a 20% peuvent etre realisees pendant" },
                "  mejor precio.": { en: "  of better prices.", zh: "  20%ã€‚", de: "  besserer Preise erzielt werden.", fr: "  les periodes de meilleurs prix." },
                "â€¢ Implica un precio fijo por los kilovatios que": { en: "â€¢ Means a fixed price for the kilowatts", zh: "â€¢ æ„å‘³ç€åƒç“¦ä»·æ ¼å›ºå®š", de: "â€¢ Bedeutet einen festen Preis fur Kilowatt", fr: "â€¢ Implique un prix fixe pour les kilowatts" },
                "  consumes (kWh).": { en: "  you consume (kWh).", zh: "  æ‚¨æ¶ˆè´¹ï¼ˆkWhï¼‰ã€‚", de: "  die Sie verbrauchen (kWh).", fr: "  que vous consommez (kWh)." },
                "â€¢ El precio se mantiene estable,": { en: "â€¢ The price remains stable,", zh: "â€¢ ä»·æ ¼ä¿æŒç¨³å®šï¼Œ", de: "â€¢ Der Preis bleibt stabil,", fr: "â€¢ Le prix reste stable," },
                "  independientemente de cÃ³mo se comporten los": { en: "  regardless of how prices behave in", zh: "  ä¸å—å¸‚åœºä»·æ ¼", de: "  unabhangig davon, wie sich die Preise auf", fr: "  quel que soit le comportement des prix sur" },
                "  precios en el mercado elÃ©ctrico.": { en: "  the electricity market.", zh: "  åœ¨ç”µåŠ›å¸‚åœºçš„å½±å“ã€‚", de: "  dem Strommarkt verhalten.", fr: "  le marche de l'electricite." },
                "â€¢ Cuando el precio del mercado estÃ¡ alto, el": { en: "â€¢ When the market price is high, the", zh: "â€¢ å½“å¸‚åœºä»·æ ¼é«˜æ—¶ï¼Œ", de: "â€¢ Wenn der Marktpreis hoch ist, ist", fr: "â€¢ Lorsque le prix du marche est eleve, le" },
                "  cliente estÃ¡ protegido frente a sobresaltos.": { en: "  customer is protected from sudden increases.", zh: "  å®¢æˆ·å¯ä»¥å…å—çªç„¶ä¸Šæ¶¨çš„å½±å“ã€‚", de: "  der Kunde vor plotzlichen Anstiegen geschutzt.", fr: "  client est protege contre les hausses soudaines." },
                "â€¢ No tendrÃ¡s que estar pendiente de las": { en: "â€¢ You won't have to worry about", zh: "â€¢ æ‚¨æ— éœ€æ‹…å¿ƒå¸‚åœº", de: "â€¢ Sie mussen sich keine Gedanken uber", fr: "â€¢ Vous n'aurez pas a vous soucier des" },
                "  variaciones del mercado y podrÃ¡s seguir": { en: "  market fluctuations and can continue", zh: "  æ³¢åŠ¨ï¼Œå¯ä»¥ç…§å¸¸", de: "  Marktschwankungen machen und konnen weiterhin", fr: "  fluctuations du marche et pourrez continuer" },
                "  usando la electricidad como siempre.": { en: "  using electricity as usual.", zh: "  ä½¿ç”¨ç”µåŠ›ã€‚", de: "  Strom wie gewohnt nutzen.", fr: "  a utiliser l'electricite comme d'habitude." },
                "â€¢ Implica un precio variable por los kilovatios": { en: "â€¢ Means a variable price for the kilowatts", zh: "â€¢ æ„å‘³ç€åƒç“¦ä»·æ ¼å¯å˜", de: "â€¢ Bedeutet einen variablen Preis fur Kilowatt", fr: "â€¢ Implique un prix variable pour les kilowatts" },
                "  que consumes (kWh) cada mes.": { en: "  you consume (kWh) each month.", zh: "  æ¯æœˆæ¶ˆè´¹ï¼ˆkWhï¼‰ã€‚", de: "  die Sie monatlich verbrauchen (kWh).", fr: "  que vous consommez (kWh) chaque mois." },
                "â€¢ Es la tarifa mÃ¡s justa, ya que pagas el coste": { en: "â€¢ It's the fairest rate, as you pay the real", zh: "â€¢ è¿™æ˜¯æœ€å…¬å¹³çš„è´¹çŽ‡ï¼Œå› ä¸ºæ‚¨æ”¯ä»˜", de: "â€¢ Es ist der fairste Tarif, da Sie die tatsachlichen", fr: "â€¢ C'est le tarif le plus juste, car vous payez le cout" },
                "  real de la energÃ­a mes a mes.": { en: "  cost of energy month by month.", zh: "  æ¯æœˆèƒ½æºçš„å®žé™…æˆæœ¬ã€‚", de: "  Energiekosten Monat fur Monat zahlen.", fr: "  reel de l'energie mois apres mois." },
                "â€¢ Al contratarla, el cliente evita pagar": { en: "â€¢ By contracting it, the customer avoids paying", zh: "â€¢ ç­¾è®¢åˆåŒåŽï¼Œå®¢æˆ·å¯ä»¥é¿å…æ”¯ä»˜", de: "â€¢ Durch den Abschluss vermeidet der Kunde", fr: "â€¢ En le contractant, le client evite de payer" },
                "  mÃ¡rgenes adicionales cuando el precio de la": { en: "  additional margins when the electricity", zh: "  å½“ç”µä»·ä¾¿å®œæ—¶çš„é¢å¤–", de: "  zusatzliche Margen, wenn die Strom", fr: "  des marges supplementaires lorsque le prix de" },
                "  electricidad es mÃ¡s barato.": { en: "  price is cheaper.", zh: "  åˆ©æ¶¦ã€‚", de: "  preise gunstiger sind.", fr: "  l'electricite est moins cher." },
                "â€¢ A largo plazo, con un indexado 100%": { en: "â€¢ In the long term, with 100%", zh: "â€¢ ä»Žé•¿è¿œæ¥çœ‹ï¼Œé€šè¿‡100%", de: "â€¢ Langfristig konnen mit einer", fr: "â€¢ A long terme, avec une indexation 100%" },
                "  funcional, se puede obtener un ahorro": { en: "  functional indexation, savings of up", zh: "  åŠŸèƒ½æ€§çš„æŒ‡æ•°åŒ–ï¼Œå¯ä»¥èŠ‚çœ", de: "  voll funktionsfahigen 100%igen Indexierung", fr: "  fonctionnelle, des economies pouvant" },
                "  aproximado de hasta un 20% en Ã©pocas de": { en: "  to 20% can be achieved during periods", zh: "  åœ¨ä»·æ ¼è¾ƒå¥½çš„æ—¶æœŸé«˜è¾¾", de: "  Einsparungen von bis zu 20% in Zeiten", fr: "  aller jusqu'a 20% peuvent etre realisees pendant" },
                "  mejor precio.": { en: "  of better prices.", zh: "  20%ã€‚", de: "  besserer Preise erzielt werden.", fr: "  les periodes de meilleurs prix." },
                "Implica un precio fijo por los kilovatios que consumes (kWh).": { 
                    en: "Means a fixed price for the kilowatts you consume (kWh).", 
                    zh: "æ„å‘³ç€æ‚¨æ¶ˆè´¹çš„åƒç“¦ï¼ˆkWhï¼‰ä»·æ ¼å›ºå®šã€‚", 
                    de: "Bedeutet einen festen Preis fÃ¼r die verbrauchten Kilowatt (kWh).", 
                    fr: "Implique un prix fixe pour les kilowatts que vous consommez (kWh)." 
                },
                "El precio se mantiene estable, independientemente de cÃ³mo se comporten los precios en el mercado elÃ©ctrico.": { 
                    en: "The price remains stable, regardless of how prices behave in the electricity market.", 
                    zh: "ä»·æ ¼ä¿æŒç¨³å®šï¼Œä¸å—ç”µåŠ›å¸‚åœºä»·æ ¼æ³¢åŠ¨çš„å½±å“ã€‚", 
                    de: "Der Preis bleibt stabil, unabhÃ¤ngig davon, wie sich die Preise auf dem Strommarkt verhalten.", 
                    fr: "Le prix reste stable, quel que soit le comportement des prix sur le marchÃ© de l'Ã©lectricitÃ©." 
                },
                "Cuando el precio del mercado estÃ¡ alto, el cliente estÃ¡ protegido frente a sobresaltos.": { 
                    en: "When the market price is high, the customer is protected from sudden increases.", 
                    zh: "å½“å¸‚åœºä»·æ ¼é«˜æ—¶ï¼Œå®¢æˆ·å¯ä»¥å…å—çªç„¶ä¸Šæ¶¨çš„å½±å“ã€‚", 
                    de: "Wenn der Marktpreis hoch ist, ist der Kunde vor plÃ¶tzlichen Anstiegen geschÃ¼tzt.", 
                    fr: "Lorsque le prix du marchÃ© est Ã©levÃ©, le client est protÃ©gÃ© contre les hausses soudaines." 
                },
                "No tendrÃ¡s que estar pendiente de las variaciones del mercado y podrÃ¡s seguir usando la electricidad como siempre.": { 
                    en: "You won't have to worry about market fluctuations and can continue using electricity as usual.", 
                    zh: "æ‚¨æ— éœ€æ‹…å¿ƒå¸‚åœºæ³¢åŠ¨ï¼Œå¯ä»¥ç…§å¸¸ä½¿ç”¨ç”µåŠ›ã€‚", 
                    de: "Sie mÃ¼ssen sich keine Gedanken Ã¼ber Marktschwankungen machen und kÃ¶nnen weiterhin Strom wie gewohnt nutzen.", 
                    fr: "Vous n'aurez pas Ã  vous soucier des fluctuations du marchÃ© et pourrez continuer Ã  utiliser l'Ã©lectricitÃ© comme d'habitude." 
                },
                "Implica un precio variable por los kilovatios que consumes (kWh) cada mes.": { 
                    en: "Means a variable price for the kilowatts you consume (kWh) each month.", 
                    zh: "æ„å‘³ç€æ¯æœˆæ¶ˆè´¹çš„åƒç“¦ï¼ˆkWhï¼‰ä»·æ ¼å¯å˜ã€‚", 
                    de: "Bedeutet einen variablen Preis fÃ¼r die monatlich verbrauchten Kilowatt (kWh).", 
                    fr: "Implique un prix variable pour les kilowatts que vous consommez (kWh) chaque mois." 
                },
                "Es la tarifa mÃ¡s justa, ya que pagas el coste real de la energÃ­a mes a mes.": { 
                    en: "It's the fairest rate, as you pay the real cost of energy month by month.", 
                    zh: "è¿™æ˜¯æœ€å…¬å¹³çš„è´¹çŽ‡ï¼Œå› ä¸ºæ‚¨æ¯æœˆæ”¯ä»˜èƒ½æºçš„å®žé™…æˆæœ¬ã€‚", 
                    de: "Es ist der fairste Tarif, da Sie Monat fÃ¼r Monat die tatsÃ¤chlichen Energiekosten zahlen.", 
                    fr: "C'est le tarif le plus juste, car vous payez le coÃ»t rÃ©el de l'Ã©nergie mois aprÃ¨s mois." 
                },
                "Al contratarla, el cliente evita pagar mÃ¡rgenes adicionales cuando el precio de la electricidad es mÃ¡s barato.": { 
                    en: "By contracting it, the customer avoids paying additional margins when electricity prices are cheaper.", 
                    zh: "ç­¾è®¢åˆåŒåŽï¼Œå½“ç”µä»·ä¾¿å®œæ—¶ï¼Œå®¢æˆ·å¯ä»¥é¿å…æ”¯ä»˜é¢å¤–çš„åˆ©æ¶¦ã€‚", 
                    de: "Durch den Abschluss vermeidet der Kunde zusÃ¤tzliche Margen, wenn die Strompreise gÃ¼nstiger sind.", 
                    fr: "En la contractant, le client Ã©vite de payer des marges supplÃ©mentaires lorsque les prix de l'Ã©lectricitÃ© sont moins chers." 
                },
                "A largo plazo, con un indexado 100% funcional, se puede obtener un ahorro aproximado de hasta un 20% en Ã©pocas de mejor precio.": { 
                    en: "In the long term, with a fully functional 100% indexation, savings of up to 20% can be achieved during periods of better prices.", 
                    zh: "ä»Žé•¿è¿œæ¥çœ‹ï¼Œé€šè¿‡100%åŠŸèƒ½æ€§çš„æŒ‡æ•°åŒ–ï¼Œåœ¨ä»·æ ¼è¾ƒå¥½çš„æ—¶æœŸå¯ä»¥èŠ‚çœé«˜è¾¾20%ã€‚", 
                    de: "Langfristig kÃ¶nnen mit einer voll funktionsfÃ¤higen 100%igen Indexierung Einsparungen von bis zu 20% in Zeiten besserer Preise erzielt werden.", 
                    fr: "Ã€ long terme, avec une indexation 100% fonctionnelle, des Ã©conomies pouvant aller jusqu'Ã  20% peuvent Ãªtre rÃ©alisÃ©es pendant les pÃ©riodes de meilleurs prix." 
                },
                "DESGLOSE DETALLADO DE LA SIMULACIÃ“N": { en: "DETAILED SIMULATION BREAKDOWN", zh: "è¯¦ç»†æ¨¡æ‹Ÿåˆ†ç±»", de: "DETAILLIERTE SIMULATIONSAUFSCHLÃœSSELUNG", fr: "RÃ‰PARTITION DÃ‰TAILLÃ‰E DE LA SIMULATION" },
                "TÃ‰RMINO POTENCIA (Precio en â‚¬/kW DÃ­a)": { en: "POWER TERM (Price in â‚¬/kW Day)", zh: "åŠŸçŽ‡æ¡æ¬¾ï¼ˆä»·æ ¼â‚¬/kWæ—¥ï¼‰", de: "LEISTUNGSTERM (Preis in â‚¬/kW Tag)", fr: "TERME PUISSANCE (Prix en â‚¬/kW Jour)" },
                "TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)": { en: "ENERGY TERM (Prices in â‚¬/kWh)", zh: "èƒ½æºæ¡æ¬¾ï¼ˆä»·æ ¼â‚¬/kWhï¼‰", de: "ENERGIETERM (Preise in â‚¬/kWh)", fr: "TERME Ã‰NERGIE (Prix en â‚¬/kWh)" },
                "SUBTOTAL POTENCIA": { en: "POWER SUBTOTAL", zh: "åŠŸçŽ‡å°è®¡", de: "LEISTUNG ZWISCHENSUMME", fr: "SOUS-TOTAL PUISSANCE" },
                "Subtotal EnergÃ­a (Bruto)": { en: "Energy Subtotal (Gross)", zh: "èƒ½æºå°è®¡ï¼ˆæ¯›é¢ï¼‰", de: "Energie Zwischensumme (Brutto)", fr: "Sous-total Ã‰nergie (Brut)" },
                "Subtotal EnergÃ­a (Neto)": { en: "Energy Subtotal (Net)", zh: "èƒ½æºå°è®¡ï¼ˆå‡€é¢ï¼‰", de: "Energie Zwischensumme (Netto)", fr: "Sous-total Ã‰nergie (Net)" },
                "SUBTOTAL BASE (P+E)": { en: "BASE SUBTOTAL (P+E)", zh: "åŸºç¡€å°è®¡ï¼ˆP+Eï¼‰", de: "BASIS ZWISCHENSUMME (P+E)", fr: "SOUS-TOTAL BASE (P+E)" },
                "BASE IMPONIBLE": { en: "TAXABLE BASE", zh: "åº”ç¨ŽåŸºæ•°", de: "STEUERBEMESSUNGSGRUNDLAGE", fr: "BASE IMPOSABLE" },
                "Imp. ElÃ©c.": { en: "Elec. Tax", zh: "ç”µåŠ›ç¨Ž", de: "Strom-Steuer", fr: "Taxe Ã‰lec." },
                "IVA (21%)": { en: "VAT (21%)", zh: "å¢žå€¼ç¨Žï¼ˆ21%ï¼‰", de: "MwSt. (21%)", fr: "TVA (21%)" },
                "TOTAL FACTURA": { en: "TOTAL BILL", zh: "æ€»è´¦å•", de: "GESAMTRECHNUNG", fr: "FACTURE TOTALE" },
                "TOTAL AÃ‘O (PROYECTADO)": { en: "TOTAL YEAR (PROJECTED)", zh: "å¹´åº¦æ€»è®¡ï¼ˆé¢„è®¡ï¼‰", de: "GESAMTJAHR (PROGNOSTIZIERT)", fr: "TOTAL ANNÃ‰E (PROJETÃ‰)" },
                "TOTAL FACTURA ACTUAL:": { en: "CURRENT TOTAL BILL:", zh: "å½“å‰æ€»è´¦å•ï¼š", de: "AKTUELLE GESAMTRECHNUNG:", fr: "FACTURE TOTALE ACTUELLE :" },
                "TU AHORRO ANUAL ESTIMADO ES:": { en: "YOUR ESTIMATED ANNUAL SAVINGS IS:", zh: "æ‚¨çš„é¢„è®¡å¹´åº¦èŠ‚çœä¸ºï¼š", de: "IHRE GESCHÃ„TZTEN JÃ„HRLICHEN EINSPARUNGEN BETRAGEN:", fr: "VOS Ã‰CONOMIES ANNUELLES ESTIMÃ‰ES SONT :" },
                "Â¡CONSIGUE TU AHORRO ANUAL!": { en: "GET YOUR ANNUAL SAVINGS!", zh: "èŽ·å–æ‚¨çš„å¹´åº¦èŠ‚çœï¼", de: "HOLEN SIE SICH IHRE JÃ„HRLICHEN EINSPARUNGEN!", fr: "OBTENEZ VOS Ã‰CONOMIES ANNUELLES !" },
                "AHORRO TOTAL CONSOLIDADO": { en: "TOTAL CONSOLIDATED SAVINGS", zh: "åˆå¹¶æ€»èŠ‚çœ", de: "KONSOLIDIERTE GESAMTEINSPARUNGEN", fr: "Ã‰CONOMIES TOTALES CONSOLIDÃ‰ES" },
                "RESUMEN DE AHORRO FINAL": { en: "FINAL SAVINGS SUMMARY", zh: "æœ€ç»ˆèŠ‚çœæ‘˜è¦", de: "ENDGÃœLTIGE EINSPARUNGSZUSAMMENFASSUNG", fr: "RÃ‰SUMÃ‰ FINAL DES Ã‰CONOMIES" },
                "RESUMEN DE PRECIOS DE LA OFERTA ÃšNICA": { en: "SINGLE OFFER PRICE SUMMARY", zh: "å•ä¸€æŠ¥ä»·ä»·æ ¼æ‘˜è¦", de: "PREISZUSAMMENFASSUNG DES EINZELANGEBOTS", fr: "RÃ‰SUMÃ‰ DES PRIX DE L'OFFRE UNIQUE" },
                "/ AÃ‘O": { en: "/ YEAR", zh: "/ å¹´", de: "/ JAHR", fr: "/ AN" },
                
                // DocumentaciÃ³n y formalizaciÃ³n
                "PARA FORMALIZAR ESTE CONTRATO:": { en: "TO FORMALIZE THIS CONTRACT:", zh: "ä¸ºäº†æ­£å¼ç­¾è®¢æœ¬åˆåŒï¼š", de: "UM DIESEN VERTRAG ZU FORMALISIEREN:", fr: "POUR FORMALISER CE CONTRAT :" },
                "Responde a este email adjuntando la siguiente documentacion:": { en: "Reply to this email attaching the following documentation:", zh: "å›žå¤æ­¤é‚®ä»¶å¹¶é™„ä¸Šä»¥ä¸‹æ–‡ä»¶ï¼š", de: "Antworten Sie auf diese E-Mail mit folgenden Unterlagen:", fr: "RÃ©pondez Ã  cet e-mail en joignant les documents suivants :" },
                "Responde a este email adjuntando la siguiente documentaciÃ³n:": { en: "Reply to this email attaching the following documentation:", zh: "å›žå¤æ­¤é‚®ä»¶å¹¶é™„ä¸Šä»¥ä¸‹æ–‡ä»¶ï¼š", de: "Antworten Sie auf diese E-Mail mit folgenden Unterlagen:", fr: "RÃ©pondez Ã  cet e-mail en joignant les documents suivants :" },
                "1. Foto del DNI/CIF (anverso y reverso)": { en: "1. Photo of ID/Tax ID (front and back)", zh: "1. èº«ä»½è¯/ç¨Žå·ç…§ç‰‡ï¼ˆæ­£åé¢ï¼‰", de: "1. Foto des Personalausweises/Steuernummer (Vorder- und RÃ¼ckseite)", fr: "1. Photo de la carte d'identitÃ©/numÃ©ro fiscal (recto et verso)" },
                "2. Ultima factura (minimo 3 meses de antiguedad)": { en: "2. Latest invoice (minimum 3 months old)", zh: "2. æœ€æ–°è´¦å•ï¼ˆè‡³å°‘3ä¸ªæœˆå‰ï¼‰", de: "2. Letzte Rechnung (mindestens 3 Monate alt)", fr: "2. DerniÃ¨re facture (minimum 3 mois d'anciennetÃ©)" },
                "2. Ãšltima factura (mÃ­nimo 3 meses de antigÃ¼edad)": { en: "2. Latest invoice (minimum 3 months old)", zh: "2. æœ€æ–°è´¦å•ï¼ˆè‡³å°‘3ä¸ªæœˆå‰ï¼‰", de: "2. Letzte Rechnung (mindestens 3 Monate alt)", fr: "2. DerniÃ¨re facture (minimum 3 mois d'anciennetÃ©)" },
                "3. Email de contacto para validacion": { en: "3. Contact email for validation", zh: "3. éªŒè¯è”ç³»é‚®ç®±", de: "3. Kontakt-E-Mail zur Validierung", fr: "3. E-mail de contact pour validation" },
                "3. Email de contacto para validaciÃ³n": { en: "3. Contact email for validation", zh: "3. éªŒè¯è”ç³»é‚®ç®±", de: "3. Kontakt-E-Mail zur Validierung", fr: "3. E-mail de contact pour validation" },
                "4. Telefono de contacto": { en: "4. Contact phone", zh: "4. è”ç³»ç”µè¯", de: "4. Kontakttelefon", fr: "4. TÃ©lÃ©phone de contact" },
                "4. TelÃ©fono de contacto": { en: "4. Contact phone", zh: "4. è”ç³»ç”µè¯", de: "4. Kontakttelefon", fr: "4. TÃ©lÃ©phone de contact" },
                "5. Numero de cuenta bancaria (IBAN)": { en: "5. Bank account number (IBAN)", zh: "5. é“¶è¡Œè´¦å·ï¼ˆIBANï¼‰", de: "5. Bankkontonummer (IBAN)", fr: "5. NumÃ©ro de compte bancaire (IBAN)" },
                "5. NÃºmero de cuenta bancaria (IBAN)": { en: "5. Bank account number (IBAN)", zh: "5. é“¶è¡Œè´¦å·ï¼ˆIBANï¼‰", de: "5. Bankkontonummer (IBAN)", fr: "5. NumÃ©ro de compte bancaire (IBAN)" },
                "Envia la documentacion al comercial:": { en: "Send the documentation to the sales rep:", zh: "å°†æ–‡ä»¶å‘é€ç»™é”€å”®ä»£è¡¨ï¼š", de: "Senden Sie die Unterlagen an den Vertrieb:", fr: "Envoyez la documentation au commercial :" },
                "EnvÃ­a la documentaciÃ³n al comercial:": { en: "Send the documentation to the sales rep:", zh: "å°†æ–‡ä»¶å‘é€ç»™é”€å”®ä»£è¡¨ï¼š", de: "Senden Sie die Unterlagen an den Vertrieb:", fr: "Envoyez la documentation au commercial :" },
                "Responde a este email adjuntando la documentaciÃ³n de los": { en: "Reply to this email attaching the documentation of the", zh: "å›žå¤æ­¤é‚®ä»¶å¹¶é™„ä¸Šä»¥ä¸‹", de: "Antworten Sie auf diese E-Mail mit den Unterlagen der", fr: "RÃ©pondez Ã  cet e-mail en joignant la documentation des" },
                "Ãšltima factura (menos de 3 meses de antigÃ¼edad)": { en: "Latest invoice (less than 3 months old)", zh: "æœ€æ–°è´¦å•ï¼ˆä¸è¶…è¿‡3ä¸ªæœˆï¼‰", de: "Letzte Rechnung (weniger als 3 Monate alt)", fr: "DerniÃ¨re facture (moins de 3 mois d'anciennetÃ©)" },
                "AutorizaciÃ³n de cambio de titular (si aplica)": { en: "Authorization to change holder (if applicable)", zh: "æ›´æ¢æŒæœ‰äººæŽˆæƒï¼ˆå¦‚é€‚ç”¨ï¼‰", de: "Genehmigung zur Ã„nderung des Inhabers (falls zutreffend)", fr: "Autorisation de changement de titulaire (le cas Ã©chÃ©ant)" },
                "Documento generado automÃ¡ticamente - DRK EnergÃ­a": { en: "Automatically generated document - DRK Energy", zh: "è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ - DRK èƒ½æº", de: "Automatisch generiertes Dokument - DRK Energie", fr: "Document gÃ©nÃ©rÃ© automatiquement - DRK Ã‰nergie" },
                "Para confirmar esta oferta:": { en: "To confirm this offer:", zh: "ç¡®è®¤æ­¤æŠ¥ä»·ï¼š", de: "Um dieses Angebot zu bestÃ¤tigen:", fr: "Pour confirmer cette offre :" },
                "ðŸ“‹ Para confirmar esta oferta:": { en: "ðŸ“‹ To confirm this offer:", zh: "ðŸ“‹ ç¡®è®¤æ­¤æŠ¥ä»·ï¼š", de: "ðŸ“‹ Um dieses Angebot zu bestÃ¤tigen:", fr: "ðŸ“‹ Pour confirmer cette offre :" },
                "ðŸ“§ Para confirmar esta oferta:": { en: "ðŸ“§ To confirm this offer:", zh: "ðŸ“§ ç¡®è®¤æ­¤æŠ¥ä»·ï¼š", de: "ðŸ“§ Um dieses Angebot zu bestÃ¤tigen:", fr: "ðŸ“§ Pour confirmer cette offre :" },
                "Haz clic en el botÃ³n de abajo": { en: "Click the button below", zh: "ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®", de: "Klicken Sie auf die SchaltflÃ¤che unten", fr: "Cliquez sur le bouton ci-dessous" },
                "Se abrirÃ¡ tu cliente de email": { en: "Your email client will open", zh: "å°†æ‰“å¼€æ‚¨çš„ç”µå­é‚®ä»¶å®¢æˆ·ç«¯", de: "Ihr E-Mail-Client wird geÃ¶ffnet", fr: "Votre client de messagerie s'ouvrira" },
                "Adjunta la documentaciÃ³n requerida": { en: "Attach the required documentation", zh: "é™„ä¸Šæ‰€éœ€æ–‡ä»¶", de: "FÃ¼gen Sie die erforderlichen Unterlagen bei", fr: "Joignez la documentation requise" },
                "EnvÃ­a el email": { en: "Send the email", zh: "å‘é€ç”µå­é‚®ä»¶", de: "E-Mail senden", fr: "Envoyez l'e-mail" },
                "âœ… CONFIRMAR Y ENVIAR": { en: "âœ… CONFIRM AND SEND", zh: "âœ… ç¡®è®¤å¹¶å‘é€", de: "âœ… BESTÃ„TIGEN UND SENDEN", fr: "âœ… CONFIRMER ET ENVOYER" },
                "CONFIRMAR Y ENVIAR": { en: "CONFIRM AND SEND", zh: "ç¡®è®¤å¹¶å‘é€", de: "BESTÃ„TIGEN UND SENDEN", fr: "CONFIRMER ET ENVOYER" },
                "ðŸ“„ <strong>DocumentaciÃ³n necesaria:</strong><br>": { en: "ðŸ“„ <strong>Required documentation:</strong><br>", zh: "ðŸ“„ <strong>æ‰€éœ€æ–‡ä»¶ï¼š</strong><br>", de: "ðŸ“„ <strong>Erforderliche Unterlagen:</strong><br>", fr: "ðŸ“„ <strong>Documentation nÃ©cessaire :</strong><br>" },
                "DNI/CIF Â· Ãšltima factura Â· Email Â· TelÃ©fono Â· IBAN": { en: "ID/Tax ID Â· Latest invoice Â· Email Â· Phone Â· IBAN", zh: "èº«ä»½è¯/ç¨Žå· Â· æœ€æ–°è´¦å• Â· ç”µå­é‚®ä»¶ Â· ç”µè¯ Â· IBAN", de: "Personalausweis/Steuernummer Â· Letzte Rechnung Â· E-Mail Â· Telefon Â· IBAN", fr: "Carte d'identitÃ©/nÂ° fiscal Â· DerniÃ¨re facture Â· E-mail Â· TÃ©lÃ©phone Â· IBAN" },
                "Este resumen es una simulacion": { en: "This summary is a simulation", zh: "æ­¤æ‘˜è¦ä¸ºæ¨¡æ‹Ÿ", de: "Diese Zusammenfassung ist eine Simulation", fr: "Ce rÃ©sumÃ© est une simulation" },
                "basada en su ultima factura": { en: "based on your latest invoice", zh: "åŸºäºŽæ‚¨çš„æœ€æ–°è´¦å•", de: "basierend auf Ihrer letzten Rechnung", fr: "basÃ©e sur votre derniÃ¨re facture" },
                "Foto del DNI/CIF (anverso y reverso)": { en: "Photo of ID/Tax ID (front and back)", zh: "èº«ä»½è¯/ç¨Žå·ç…§ç‰‡ï¼ˆæ­£åé¢ï¼‰", de: "Foto des Personalausweises/Steuernummer (Vorder- und RÃ¼ckseite)", fr: "Photo de la carte d'identitÃ©/numÃ©ro fiscal (recto et verso)" },
                "Ultima factura (minimo 3 meses de antiguedad)": { en: "Latest invoice (minimum 3 months old)", zh: "æœ€æ–°è´¦å•ï¼ˆè‡³å°‘3ä¸ªæœˆå‰ï¼‰", de: "Letzte Rechnung (mindestens 3 Monate alt)", fr: "DerniÃ¨re facture (minimum 3 mois d'anciennetÃ©)" },
                "Email de contacto para validaciÃ³n": { en: "Contact email for validation", zh: "éªŒè¯è”ç³»é‚®ç®±", de: "Kontakt-E-Mail zur Validierung", fr: "E-mail de contact pour validation" },
                "Telefono de contacto": { en: "Contact phone", zh: "è”ç³»ç”µè¯", de: "Kontakttelefon", fr: "TÃ©lÃ©phone de contact" },
                "Numero de cuenta bancaria (IBAN)": { en: "Bank account number (IBAN)", zh: "é“¶è¡Œè´¦å·ï¼ˆIBANï¼‰", de: "Bankkontonummer (IBAN)", fr: "NumÃ©ro de compte bancaire (IBAN)" },
                
                // MÃ¡s textos del PDF
                "DATOS DEL CLIENTE:": { en: "CLIENT DATA:", zh: "å®¢æˆ·æ•°æ®ï¼š", de: "KUNDENDATEN:", fr: "DONNÃ‰ES DU CLIENT :" },
                "DESGLOSE DETALLADO DE CÃLCULOS:": { en: "DETAILED CALCULATION BREAKDOWN:", zh: "è¯¦ç»†è®¡ç®—æ˜Žç»†ï¼š", de: "DETAILLIERTE BERECHNUNGSAUFSCHLÃœSSELUNG:", fr: "RÃ‰PARTITION DÃ‰TAILLÃ‰E DES CALCULS :" },
                "COSTES DE POTENCIA:": { en: "POWER COSTS:", zh: "åŠŸçŽ‡æˆæœ¬ï¼š", de: "LEISTUNGSKOSTEN:", fr: "COÃ›TS DE PUISSANCE :" },
                "TOTAL POTENCIA:": { en: "TOTAL POWER:", zh: "æ€»åŠŸçŽ‡ï¼š", de: "GESAMTLEISTUNG:", fr: "PUISSANCE TOTALE :" },
                "PRECIOS POTENCIA:": { en: "POWER PRICES:", zh: "åŠŸçŽ‡ä»·æ ¼ï¼š", de: "LEISTUNGSPREISE:", fr: "PRIX PUISSANCE :" },
                "Generado el": { en: "Generated on", zh: "ç”ŸæˆäºŽ", de: "Erstellt am", fr: "GÃ©nÃ©rÃ© le" },
                "Colaborador:": { en: "Collaborator:", zh: "åˆä½œè€…ï¼š", de: "Mitarbeiter:", fr: "Collaborateur :" },
                "consolidada de": { en: "consolidated from", zh: "åˆå¹¶è‡ª", de: "konsolidiert von", fr: "consolidÃ©e de" },
                "suministros": { en: "supplies", zh: "ä¾›åº”", de: "Versorgungen", fr: "approvisionnements" },
                "Total Periodo (60 dÃ­as)": { en: "Period Total (60 days)", zh: "æœŸé—´æ€»é¢ï¼ˆ60å¤©ï¼‰", de: "Periodensumme (60 Tage)", fr: "Total de la PÃ©riode (60 jours)" },
                "Total Periodo": { en: "Period Total", zh: "æœŸé—´æ€»é¢", de: "Periodensumme", fr: "Total de la PÃ©riode" },
                "Estimado Mensual": { en: "Monthly Estimate", zh: "æ¯æœˆä¼°ç®—", de: "Monatliche SchÃ¤tzung", fr: "Estimation Mensuelle" },
                "[NOMBRE COMPLETO CLIENTE]": { en: "[FULL CLIENT NAME]", zh: "[å®¢æˆ·å…¨å]", de: "[VOLLSTÃ„NDIGER KUNDENNAME]", fr: "[NOM COMPLET DU CLIENT]" },
                "Responde a este email adjuntando la documentacion de los": { en: "Reply to this email attaching the documentation of the", zh: "å›žå¤æ­¤é‚®ä»¶å¹¶é™„ä¸Šä»¥ä¸‹æ–‡ä»¶", de: "Antworten Sie auf diese E-Mail mit den Unterlagen der", fr: "RÃ©pondez Ã  cet e-mail en joignant la documentation des" },
                "Adjunto la siguiente documentaciÃ³n para cada CUPS:": { en: "Attached is the following documentation for each CUPS:", zh: "é™„ä¸Šæ¯ä¸ªCUPSçš„ä»¥ä¸‹æ–‡ä»¶ï¼š", de: "Anbei die folgenden Unterlagen fÃ¼r jede CUPS:", fr: "Ci-joint la documentation suivante pour chaque CUPS :" },
                "âœ“ 3. Email de contacto": { en: "âœ“ 3. Contact email", zh: "âœ“ 3. è”ç³»é‚®ç®±", de: "âœ“ 3. Kontakt-E-Mail", fr: "âœ“ 3. E-mail de contact" },
                
                // Formulario de GAS
                "Datos de la Factura de GAS": { en: "GAS Invoice Data", zh: "å¤©ç„¶æ°”è´¦å•æ•°æ®", de: "GAS-Rechnungsdaten", fr: "DonnÃ©es de la Facture de GAZ" },
                "Tarifa:": { en: "Rate:", zh: "è´¹çŽ‡ï¼š", de: "Tarif:", fr: "Tarif :" },
                "CUPS (Opcional)": { en: "CUPS (Optional)", zh: "CUPSï¼ˆå¯é€‰ï¼‰", de: "CUPS (Optional)", fr: "CUPS (Optionnel)" },
                "Se incluirÃ¡ en el PDF si lo proporcionas": { en: "Will be included in the PDF if you provide it", zh: "å¦‚æžœæ‚¨æä¾›ï¼Œå°†åŒ…å«åœ¨PDFä¸­", de: "Wird in das PDF aufgenommen, wenn Sie es angeben", fr: "Sera inclus dans le PDF si vous le fournissez" },
                "DÃ­as de facturaciÃ³n": { en: "Billing days", zh: "è®¡è´¹å¤©æ•°", de: "Abrechnungstage", fr: "Jours de facturation" },
                "kWh consumidos": { en: "kWh consumed", zh: "æ¶ˆè€—çš„kWh", de: "Verbrauchte kWh", fr: "kWh consommÃ©s" },
                "Total factura actual (â‚¬)": { en: "Current total bill (â‚¬)", zh: "å½“å‰æ€»è´¦å•ï¼ˆâ‚¬ï¼‰", de: "Aktuelle Gesamtrechnung (â‚¬)", fr: "Facture totale actuelle (â‚¬)" },
                "Comparar Indexada vs Fija": { en: "Compare Indexed vs Fixed", zh: "æ¯”è¾ƒæŒ‡æ•°ä¸Žå›ºå®š", de: "Indexiert vs. Fest vergleichen", fr: "Comparer IndexÃ© vs Fixe" },
                "Activa para comparar automÃ¡ticamente tarifa indexada DRK contra tarifas fijas.": { en: "Activate to automatically compare DRK indexed rate against fixed rates.", zh: "æ¿€æ´»ä»¥è‡ªåŠ¨æ¯”è¾ƒDRKæŒ‡æ•°è´¹çŽ‡ä¸Žå›ºå®šè´¹çŽ‡ã€‚", de: "Aktivieren Sie, um den DRK-Indexierten Tarif automatisch mit festen Tarifen zu vergleichen.", fr: "Activez pour comparer automatiquement le tarif indexÃ© DRK avec les tarifs fixes." },
                "Modo de selecciÃ³n:": { en: "Selection mode:", zh: "é€‰æ‹©æ¨¡å¼ï¼š", de: "Auswahlmodus:", fr: "Mode de sÃ©lection :" },
                "Mejores tarifas": { en: "Best rates", zh: "æœ€ä½³è´¹çŽ‡", de: "Beste Tarife", fr: "Meilleurs tarifs" },
                "Elige si quieres ver la mejor tarifa fija o indexada.": { en: "Choose if you want to see the best fixed or indexed rate.", zh: "é€‰æ‹©æ‚¨æ˜¯å¦æƒ³æŸ¥çœ‹æœ€ä½³å›ºå®šæˆ–æŒ‡æ•°è´¹çŽ‡ã€‚", de: "WÃ¤hlen Sie, ob Sie den besten festen oder indexierten Tarif sehen mÃ¶chten.", fr: "Choisissez si vous souhaitez voir le meilleur tarif fixe ou indexÃ©." },
                
                // Modal de resultados "Tu Tarifa Actual"
                "Tu Tarifa Actual": { en: "Your Current Rate", zh: "æ‚¨çš„å½“å‰è´¹çŽ‡", de: "Ihr aktueller Tarif", fr: "Votre Tarif Actuel" },
                "Es la mejor opciÃ³n detectada": { en: "It's the best option detected", zh: "è¿™æ˜¯æ£€æµ‹åˆ°çš„æœ€ä½³é€‰æ‹©", de: "Es ist die beste erkannte Option", fr: "C'est la meilleure option dÃ©tectÃ©e" },
                "Es la mejor opciÃ³n consolidada": { en: "It's the best consolidated option", zh: "è¿™æ˜¯æœ€ä½³ç»¼åˆé€‰æ‹©", de: "Es ist die beste konsolidierte Option", fr: "C'est la meilleure option consolidÃ©e" },
                "Â¡ENHORABUENA!": { en: "CONGRATULATIONS!", zh: "æ­å–œï¼", de: "GLÃœCKWUNSCH!", fr: "FÃ‰LICITATIONS !" },
                "Actualmente estÃ¡s en una buena tarifa.": { en: "You are currently on a good rate.", zh: "æ‚¨ç›®å‰ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªå¥½çš„è´¹çŽ‡ã€‚", de: "Sie haben derzeit einen guten Tarif.", fr: "Vous Ãªtes actuellement sur un bon tarif." },
                "Seguiremos estudiando el mercado y te avisaremos cuando encontremos alguna tarifa que se adapte a tu perfil de consumo.": { en: "We will continue studying the market and notify you when we find a rate that suits your consumption profile.", zh: "æˆ‘ä»¬å°†ç»§ç»­ç ”ç©¶å¸‚åœºï¼Œå½“æ‰¾åˆ°é€‚åˆæ‚¨æ¶ˆè´¹æƒ…å†µçš„è´¹çŽ‡æ—¶ä¼šé€šçŸ¥æ‚¨ã€‚", de: "Wir werden den Markt weiter untersuchen und Sie benachrichtigen, wenn wir einen Tarif finden, der zu Ihrem Verbrauchsprofil passt.", fr: "Nous continuerons Ã  Ã©tudier le marchÃ© et vous informerons lorsque nous trouverons un tarif adaptÃ© Ã  votre profil de consommation." },
                "TU COSTE ACTUAL CONSOLIDADO": { en: "YOUR CURRENT CONSOLIDATED COST", zh: "æ‚¨å½“å‰çš„ç»¼åˆæˆæœ¬", de: "IHRE AKTUELLEN KONSOLIDIERTEN KOSTEN", fr: "VOTRE COÃ›T CONSOLIDÃ‰ ACTUEL" },
                "Total factura:": { en: "Total bill:", zh: "æ€»è´¦å•ï¼š", de: "Gesamtrechnung:", fr: "Facture totale :" },
                "EstimaciÃ³n anual:": { en: "Annual estimate:", zh: "å¹´åº¦ä¼°ç®—ï¼š", de: "JÃ¤hrliche SchÃ¤tzung:", fr: "Estimation annuelle :" },
                "ðŸ“Š TU COSTE ACTUAL CONSOLIDADO": { en: "ðŸ“Š YOUR CURRENT CONSOLIDATED COST", zh: "ðŸ“Š æ‚¨å½“å‰çš„ç»¼åˆæˆæœ¬", de: "ðŸ“Š IHRE AKTUELLEN KONSOLIDIERTEN KOSTEN", fr: "ðŸ“Š VOTRE COÃ›T CONSOLIDÃ‰ ACTUEL" },
                
                // Textos de GAS y resultados
                "Tipo de tarifa:": { en: "Rate type:", zh: "è´¹çŽ‡ç±»åž‹ï¼š", de: "Tariftyp:", fr: "Type de tarif :" },
                "ðŸ”µ Tarifa Fija": { en: "ðŸ”µ Fixed Rate", zh: "ðŸ”µ å›ºå®šè´¹çŽ‡", de: "ðŸ”µ Fester Tarif", fr: "ðŸ”µ Tarif Fixe" },
                "ðŸŸ  Tarifa Indexada": { en: "ðŸŸ  Indexed Rate", zh: "ðŸŸ  æŒ‡æ•°è´¹çŽ‡", de: "ðŸŸ  Indexierter Tarif", fr: "ðŸŸ  Tarif IndexÃ©" },
                "Resultados GAS": { en: "GAS Results", zh: "å¤©ç„¶æ°”ç»“æžœ", de: "GAS-Ergebnisse", fr: "RÃ©sultats GAZ" },
                "Comparativa de tarifas": { en: "Rate comparison", zh: "è´¹çŽ‡æ¯”è¾ƒ", de: "Tarifvergleich", fr: "Comparaison des tarifs" },
                "TÃ©rmino fijo": { en: "Fixed term", zh: "å›ºå®šæ¡æ¬¾", de: "Feste Laufzeit", fr: "Terme fixe" },
                "TÃ©rmino fijo (30 dÃ­as)": { en: "Fixed term (30 days)", zh: "å›ºå®šæ¡æ¬¾ï¼ˆ30å¤©ï¼‰", de: "Feste Laufzeit (30 Tage)", fr: "Terme fixe (30 jours)" },
                "TÃ©rmino fijo:": { en: "Fixed term:", zh: "å›ºå®šæ¡æ¬¾ï¼š", de: "Feste Laufzeit:", fr: "Terme fixe :" },
                "EnergÃ­a": { en: "Energy", zh: "èƒ½æº", de: "Energie", fr: "Ã‰nergie" },
                "Impuesto hidrocarburos": { en: "Hydrocarbon tax", zh: "ç¢³æ°¢åŒ–åˆç‰©ç¨Ž", de: "Kohlenwasserstoffsteuer", fr: "Taxe sur les hydrocarbures" },
                "VAT (21%)": { en: "VAT (21%)", zh: "å¢žå€¼ç¨Žï¼ˆ21%ï¼‰", de: "MwSt. (21%)", fr: "TVA (21%)" },
                "TOTAL": { en: "TOTAL", zh: "æ€»è®¡", de: "GESAMT", fr: "TOTAL" },
                "Tu factura actual:": { en: "Your current bill:", zh: "æ‚¨å½“å‰çš„è´¦å•ï¼š", de: "Ihre aktuelle Rechnung:", fr: "Votre facture actuelle :" },
                "Con esta tarifa:": { en: "With this rate:", zh: "ä½¿ç”¨æ­¤è´¹çŽ‡ï¼š", de: "Mit diesem Tarif:", fr: "Avec ce tarif :" },
                "Ahorro mensual:": { en: "Monthly savings:", zh: "æ¯æœˆèŠ‚çœï¼š", de: "Monatliche Einsparungen:", fr: "Ã‰conomies mensuelles :" },
                "Ahorro anual:": { en: "Annual savings:", zh: "å¹´åº¦èŠ‚çœï¼š", de: "JÃ¤hrliche Einsparungen:", fr: "Ã‰conomies annuelles :" },
                "ðŸ“¤ Exportar PresentaciÃ³n": { en: "ðŸ“¤ Export Presentation", zh: "ðŸ“¤ å¯¼å‡ºæ¼”ç¤ºæ–‡ç¨¿", de: "ðŸ“¤ PrÃ¤sentation exportieren", fr: "ðŸ“¤ Exporter la PrÃ©sentation" },
                "Exportar PresentaciÃ³n": { en: "Export Presentation", zh: "å¯¼å‡ºæ¼”ç¤ºæ–‡ç¨¿", de: "PrÃ¤sentation exportieren", fr: "Exporter la PrÃ©sentation" },
                "Generar PDF": { en: "Generate PDF", zh: "ç”ŸæˆPDF", de: "PDF erstellen", fr: "GÃ©nÃ©rer PDF" },
                "ðŸ“„ Generar PDF": { en: "ðŸ“„ Generate PDF", zh: "ðŸ“„ ç”ŸæˆPDF", de: "ðŸ“„ PDF erstellen", fr: "ðŸ“„ GÃ©nÃ©rer PDF" },
                "Generar HTML para": { en: "Generate HTML for", zh: "ç”ŸæˆHTMLç”¨äºŽ", de: "HTML generieren fÃ¼r", fr: "GÃ©nÃ©rer HTML pour" },
                "ðŸ“§ Generar HTML para": { en: "ðŸ“§ Generate HTML for", zh: "ðŸ“§ ç”ŸæˆHTMLç”¨äºŽ", de: "ðŸ“§ HTML generieren fÃ¼r", fr: "ðŸ“§ GÃ©nÃ©rer HTML pour" },
                "Cancelar": { en: "Cancel", zh: "å–æ¶ˆ", de: "Abbrechen", fr: "Annuler" },
                "Aceptar": { en: "Accept", zh: "æŽ¥å—", de: "Akzeptieren", fr: "Accepter" },
                "Cancelar Pegado": { en: "Cancel Paste", zh: "å–æ¶ˆç²˜è´´", de: "EinfÃ¼gen abbrechen", fr: "Annuler le Collage" },
                "TOTAL ENERGÃA": { en: "TOTAL ENERGY", zh: "æ€»èƒ½æº", de: "GESAMTENERGIE", fr: "Ã‰NERGIE TOTALE" },
                "TOTAL CON IMPUESTOS": { en: "TOTAL WITH TAXES", zh: "å«ç¨Žæ€»è®¡", de: "GESAMT MIT STEUERN", fr: "TOTAL AVEC TAXES" },
                "CUPS TOTALES:": { en: "TOTAL CUPS:", zh: "æ€»CUPSï¼š", de: "GESAMT-CUPS:", fr: "CUPS TOTAUX :" },
                "AHORRO TOTAL FIJAS:": { en: "TOTAL FIXED SAVINGS:", zh: "æ€»å›ºå®šèŠ‚çœï¼š", de: "GESAMTE FESTE EINSPARUNGEN:", fr: "Ã‰CONOMIES TOTALES FIXES :" },
                "AHORRO TOTAL INDEXADAS:": { en: "TOTAL INDEXED SAVINGS:", zh: "æ€»æŒ‡æ•°èŠ‚çœï¼š", de: "GESAMTE INDEXIERTE EINSPARUNGEN:", fr: "Ã‰CONOMIES TOTALES INDEXÃ‰ES :" },
                "FACTURA ACTUAL TOTAL:": { en: "CURRENT TOTAL BILL:", zh: "å½“å‰æ€»è´¦å•ï¼š", de: "AKTUELLE GESAMTRECHNUNG:", fr: "FACTURE TOTALE ACTUELLE :" },
                "TOTAL:": { en: "TOTAL:", zh: "æ€»è®¡ï¼š", de: "GESAMT:", fr: "TOTAL :" },
                
                // Traducciones adicionales para PDFs
                "COMPARATIVA": { en: "COMPARISON", zh: "æ¯”è¾ƒ", de: "VERGLEICH", fr: "COMPARAISON" },
                "mes": { en: "month", zh: "æœˆ", de: "Monat", fr: "mois" },
                "DÃAS": { en: "DAYS", zh: "å¤©", de: "TAGE", fr: "JOURS" },
                "TU AHORRO ANUAL TOTAL": { en: "YOUR TOTAL ANNUAL SAVINGS", zh: "æ‚¨çš„å¹´åº¦æ€»èŠ‚çœ", de: "IHRE GESAMTEN JÃ„HRLICHEN EINSPARUNGEN", fr: "VOS Ã‰CONOMIES ANNUELLES TOTALES" },
                "Â¡AHORRA": { en: "SAVE", zh: "èŠ‚çœ", de: "SPAREN SIE", fr: "Ã‰CONOMISEZ" },
                "CADA MES!": { en: "EVERY MONTH!", zh: "æ¯æœˆï¼", de: "JEDEN MONAT!", fr: "CHAQUE MOIS !" },
                "AHORRO:": { en: "SAVINGS:", zh: "èŠ‚çœï¼š", de: "EINSPARUNGEN:", fr: "Ã‰CONOMIES :" },
                "TOTAL AHORRO:": { en: "TOTAL SAVINGS:", zh: "æ€»èŠ‚çœï¼š", de: "GESAMTEINSPARUNGEN:", fr: "Ã‰CONOMIES TOTALES :" },
                "PRECIOS APLICADOS:": { en: "APPLIED PRICES:", zh: "åº”ç”¨ä»·æ ¼ï¼š", de: "ANGEWANDTE PREISE:", fr: "PRIX APPLIQUÃ‰S :" },
                "DESGLOSE DE COSTES": { en: "COST BREAKDOWN", zh: "æˆæœ¬æ˜Žç»†", de: "KOSTENAUFSCHLÃœSSELUNG", fr: "RÃ‰PARTITION DES COÃ›TS" },
                "DESGLOSE GAS": { en: "GAS BREAKDOWN", zh: "ç‡ƒæ°”æ˜Žç»†", de: "GASAUFSCHLÃœSSELUNG", fr: "RÃ‰PARTITION GAZ" },
                "No hay datos": { en: "No data", zh: "æ— æ•°æ®", de: "Keine Daten", fr: "Pas de donnÃ©es" },
                "No hay datos de potencia": { en: "No power data", zh: "æ— åŠŸçŽ‡æ•°æ®", de: "Keine Leistungsdaten", fr: "Pas de donnÃ©es de puissance" },
                "No hay datos de energÃ­a": { en: "No energy data", zh: "æ— èƒ½æºæ•°æ®", de: "Keine Energiedaten", fr: "Pas de donnÃ©es d'Ã©nergie" },
                "Tipo:": { en: "Type:", zh: "ç±»åž‹ï¼š", de: "Typ:", fr: "Type :" },
                "DÃ­as:": { en: "Days:", zh: "å¤©æ•°ï¼š", de: "Tage:", fr: "Jours :" },
                "Subtotal": { en: "Subtotal", zh: "å°è®¡", de: "Zwischensumme", fr: "Sous-total" },
                "Sin ahorro conseguido": { en: "No savings achieved", zh: "æœªå®žçŽ°èŠ‚çœ", de: "Keine Einsparungen erzielt", fr: "Aucune Ã©conomie rÃ©alisÃ©e" },
                "RESULTADO DE LA COMPARATIVA": { en: "COMPARISON RESULT", zh: "æ¯”è¾ƒç»“æžœ", de: "VERGLEICHSERGEBNIS", fr: "RÃ‰SULTAT DE LA COMPARAISON" },
                "Liderando el ahorro y la eficiencia energÃ©tica.": { en: "Leading savings and energy efficiency.", zh: "é¢†å…ˆçš„èŠ‚èƒ½å’Œèƒ½æºæ•ˆçŽ‡ã€‚", de: "FÃ¼hrend bei Einsparungen und Energieeffizienz.", fr: "Leader en Ã©conomies et efficacitÃ© Ã©nergÃ©tique." },
                "TU NUEVO COSTE": { en: "YOUR NEW COST", zh: "æ‚¨çš„æ–°è´¹ç”¨", de: "IHRE NEUEN KOSTEN", fr: "VOTRE NOUVEAU COÃ›T" },
                "CONSOLIDADO": { en: "CONSOLIDATED", zh: "åˆå¹¶", de: "KONSOLIDIERT", fr: "CONSOLIDÃ‰" },
                "CUPS Procesadas": { en: "CUPS Processed", zh: "å·²å¤„ç†çš„CUPS", de: "Verarbeitete CUPS", fr: "CUPS TraitÃ©es" },
                
                // MÃ¡s traducciones del PDF
                "Termino fijo": { en: "Fixed term", zh: "å›ºå®šè´¹ç”¨", de: "Festpreis", fr: "Terme fixe" },
                "Energia": { en: "Energy", zh: "èƒ½æº", de: "Energie", fr: "Ã‰nergie" },
                "POTENCIA:": { en: "POWER:", zh: "åŠŸçŽ‡ï¼š", de: "LEISTUNG:", fr: "PUISSANCE :" },
                "ENERGIA:": { en: "ENERGY:", zh: "èƒ½æºï¼š", de: "ENERGIE:", fr: "Ã‰NERGIE :" },
                "Dias:": { en: "Days:", zh: "å¤©æ•°ï¼š", de: "Tage:", fr: "Jours :" },
                "dias": { en: "days", zh: "å¤©", de: "Tage", fr: "jours" },
                "dia": { en: "day", zh: "å¤©", de: "Tag", fr: "jour" },
                "d": { en: "d", zh: "å¤©", de: "T", fr: "j" },
                "Tipo": { en: "Type", zh: "ç±»åž‹", de: "Typ", fr: "Type" },
                "Tarifa": { en: "Rate", zh: "è´¹çŽ‡", de: "Tarif", fr: "Tarif" },
                "TARIFA:": { en: "RATE:", zh: "è´¹çŽ‡ï¼š", de: "TARIF:", fr: "TARIF :" },
                "Ahorro Anual": { en: "Annual Savings", zh: "å¹´åº¦èŠ‚çœ", de: "JÃ¤hrliche Einsparungen", fr: "Ã‰conomies annuelles" },
                "Electricidad": { en: "Electricity", zh: "ç”µåŠ›", de: "ElektrizitÃ¤t", fr: "Ã‰lectricitÃ©" },
                "Gas": { en: "Gas", zh: "ç‡ƒæ°”", de: "Gas", fr: "Gaz" },
                "TOTAL": { en: "TOTAL", zh: "æ€»è®¡", de: "GESAMT", fr: "TOTAL" },
                "DIAS": { en: "DAYS", zh: "å¤©", de: "TAGE", fr: "JOURS" },
                "AHORRA ": { en: "SAVE ", zh: "èŠ‚çœ ", de: "SPAREN SIE ", fr: "Ã‰CONOMISEZ " },
                " EUR CADA MES": { en: " EUR EACH MONTH", zh: " æ¬§å…ƒæ¯æœˆ", de: " EUR JEDEN MONAT", fr: " EUR CHAQUE MOIS" },
                "Responde a este email adjuntando la documentacion de los ": { en: "Reply to this email attaching the documentation of the ", zh: "å›žå¤æ­¤ç”µå­é‚®ä»¶å¹¶é™„ä¸Š ", de: "Antworten Sie auf diese E-Mail mit der Dokumentation der ", fr: "RÃ©pondez Ã  cet e-mail en joignant la documentation des " },
                " CUPS:": { en: " CUPS:", zh: " ä¸ªCUPSï¼š", de: " CUPS:", fr: " CUPS :" },
                "1. Foto del DNI/CIF (anverso y reverso)": { en: "1. Photo of ID/Tax ID (front and back)", zh: "1. èº«ä»½è¯/ç¨Žå·ç…§ç‰‡ï¼ˆæ­£åé¢ï¼‰", de: "1. Foto des Ausweises/Steuer-ID (Vorder- und RÃ¼ckseite)", fr: "1. Photo de la carte d'identitÃ©/numÃ©ro fiscal (recto et verso)" },
                "2. Ultima factura (menos de 3 meses de antiguedad)": { en: "2. Last bill (less than 3 months old)", zh: "2. æœ€è¿‘çš„è´¦å•ï¼ˆä¸è¶…è¿‡3ä¸ªæœˆï¼‰", de: "2. Letzte Rechnung (weniger als 3 Monate alt)", fr: "2. DerniÃ¨re facture (de moins de 3 mois)" },
                "3. Autorizacion de cambio de titular (si aplica)": { en: "3. Authorization for change of holder (if applicable)", zh: "3. æŒæœ‰äººå˜æ›´æŽˆæƒä¹¦ï¼ˆå¦‚é€‚ç”¨ï¼‰", de: "3. Genehmigung zur Ã„nderung des Inhabers (falls zutreffend)", fr: "3. Autorisation de changement de titulaire (le cas Ã©chÃ©ant)" },
                "4. Telefono de contacto": { en: "4. Contact phone", zh: "4. è”ç³»ç”µè¯", de: "4. Kontakttelefon", fr: "4. TÃ©lÃ©phone de contact" },
                "5. Numero de cuenta bancaria (IBAN)": { en: "5. Bank account number (IBAN)", zh: "5. é“¶è¡Œè´¦å·ï¼ˆIBANï¼‰", de: "5. Bankkontonummer (IBAN)", fr: "5. NumÃ©ro de compte bancaire (IBAN)" },
                "Envia la documentacion al comercial:": { en: "Send the documentation to the commercial:", zh: "å°†æ–‡ä»¶å‘é€ç»™å•†åŠ¡äººå‘˜ï¼š", de: "Senden Sie die Dokumentation an den Vertriebsmitarbeiter:", fr: "Envoyez la documentation au commercial :" },
                "Documento generado el ": { en: "Document generated on ", zh: "æ–‡ä»¶ç”ŸæˆäºŽ ", de: "Dokument erstellt am ", fr: "Document gÃ©nÃ©rÃ© le " },
                "TU NUEVO COSTE ": { en: "YOUR NEW COST ", zh: "æ‚¨çš„æ–°è´¹ç”¨ ", de: "IHRE NEUEN KOSTEN ", fr: "VOTRE NOUVEAU COÃ›T " },
                "COMPARATIVA PROFESIONAL - ": { en: "PROFESSIONAL COMPARISON - ", zh: "ä¸“ä¸šæ¯”è¾ƒ - ", de: "PROFESSIONELLER VERGLEICH - ", fr: "COMPARAISON PROFESSIONNELLE - " },
                "COMERCIAL: ": { en: "COMMERCIAL: ", zh: "å•†åŠ¡äººå‘˜ï¼š", de: "VERTRIEBSMITARBEITER: ", fr: "COMMERCIAL : " },
                "POWER SUBTOTAL": { en: "POWER SUBTOTAL", zh: "åŠŸçŽ‡å°è®¡", de: "LEISTUNG ZWISCHENSUMME", fr: "SOUS-TOTAL PUISSANCE" },
                "TAXABLE BASE": { en: "TAXABLE BASE", zh: "åº”ç¨ŽåŸºæ•°", de: "STEUERBEMESSUNGSGRUNDLAGE", fr: "BASE IMPOSABLE" },
                "TOTAL FACTURA (60 DÃAS)": { en: "TOTAL BILL (60 DAYS)", zh: "æ€»è´¦å•ï¼ˆ60å¤©ï¼‰", de: "GESAMTRECHNUNG (60 TAGE)", fr: "FACTURE TOTALE (60 JOURS)" },
                "TOTAL YEAR (PROJECTED)": { en: "TOTAL YEAR (PROJECTED)", zh: "å¹´åº¦æ€»è®¡ï¼ˆé¢„è®¡ï¼‰", de: "GESAMTJAHR (PROGNOSTIZIERT)", fr: "TOTAL ANNÃ‰E (PROJETÃ‰)" },
                "E1 - Punta": { en: "E1 - Peak", zh: "E1 - å³°å€¼", de: "E1 - Spitze", fr: "E1 - Pointe" },
                "E2 - Llano": { en: "E2 - Standard", zh: "E2 - æ ‡å‡†", de: "E2 - Standard", fr: "E2 - Standard" },
                "E3 - Valle": { en: "E3 - Valley", zh: "E3 - è°·å€¼", de: "E3 - Tal", fr: "E3 - VallÃ©e" },
                "PRECIOS DE LA OFERTA:": { en: "OFFER PRICES:", zh: "æŠ¥ä»·ä»·æ ¼ï¼š", de: "ANGEBOTSPREISE:", fr: "PRIX DE L'OFFRE :" },
                "RÅ¸sâ€¡Ã¿": { en: "POWER:", zh: "åŠŸçŽ‡ï¼š", de: "LEISTUNG:", fr: "PUISSANCE :" },
                "â‚¬/m-Ã¿": { en: "ENERGY:", zh: "èƒ½æºï¼š", de: "ENERGIE:", fr: "Ã‰NERGIE :" },
                
                // Visor de QR
                "ðŸ” Analizando QR": { en: "ðŸ” Analyzing QR", zh: "ðŸ” åˆ†æžäºŒç»´ç ", de: "ðŸ” QR analysieren", fr: "ðŸ” Analyse du QR" },
                "Progreso de anÃ¡lisis": { en: "Analysis progress", zh: "åˆ†æžè¿›åº¦", de: "Analysefortschritt", fr: "Progression de l'analyse" },
                "Estamos probando diferentes tÃ©cnicas para detectar tu cÃ³digo QR. Esto puede tardar unos segundos...": { en: "We are trying different techniques to detect your QR code. This may take a few seconds...", zh: "æˆ‘ä»¬æ­£åœ¨å°è¯•ä¸åŒçš„æŠ€æœ¯æ¥æ£€æµ‹æ‚¨çš„äºŒç»´ç ã€‚è¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ...", de: "Wir testen verschiedene Techniken, um Ihren QR-Code zu erkennen. Dies kann einige Sekunden dauern...", fr: "Nous testons diffÃ©rentes techniques pour dÃ©tecter votre code QR. Cela peut prendre quelques secondes..." },
                "ðŸ“¸ Completa 2x": { en: "ðŸ“¸ Complete 2x", zh: "ðŸ“¸ å®Œæˆ 2x", de: "ðŸ“¸ Abgeschlossen 2x", fr: "ðŸ“¸ Complet 2x" },
                
                // GAS - Interfaz completa
                "Selection mode:": { en: "Selection mode:", zh: "é€‰æ‹©æ¨¡å¼ï¼š", de: "Auswahlmodus:", fr: "Mode de sÃ©lection :" },
                "Best rates": { en: "Best rates", zh: "æœ€ä¼˜æƒ è´¹çŽ‡", de: "Beste Tarife", fr: "Meilleurs tarifs" },
                "Choose if you want to see the best fixed or indexed rate.": { en: "Choose if you want to see the best fixed or indexed rate.", zh: "é€‰æ‹©æ˜¯å¦è¦æŸ¥çœ‹æœ€ä½³å›ºå®šæˆ–æŒ‡æ•°è´¹çŽ‡ã€‚", de: "WÃ¤hlen Sie, ob Sie den besten festen oder indexierten Tarif sehen mÃ¶chten.", fr: "Choisissez si vous voulez voir le meilleur tarif fixe ou indexÃ©." },
                "Elegir entre resultados": { en: "Choose from results", zh: "ä»Žç»“æžœä¸­é€‰æ‹©", de: "Aus Ergebnissen wÃ¤hlen", fr: "Choisir parmi les rÃ©sultats" },
                "Selecciona manualmente las tarifas que deseas comparar.": { en: "Manually select the rates you want to compare.", zh: "æ‰‹åŠ¨é€‰æ‹©è¦æ¯”è¾ƒçš„è´¹çŽ‡ã€‚", de: "WÃ¤hlen Sie manuell die Tarife aus, die Sie vergleichen mÃ¶chten.", fr: "SÃ©lectionnez manuellement les tarifs que vous souhaitez comparer." },
                "Cancel": { en: "Cancel", zh: "å–æ¶ˆ", de: "Abbrechen", fr: "Annuler" },
                "Ver tarifas disponibles": { en: "See available rates", zh: "æŸ¥çœ‹å¯ç”¨è´¹çŽ‡", de: "VerfÃ¼gbare Tarife anzeigen", fr: "Voir les tarifs disponibles" },
                "Selecciona las tarifas a comparar:": { en: "Select rates to compare:", zh: "é€‰æ‹©è¦æ¯”è¾ƒçš„è´¹çŽ‡ï¼š", de: "WÃ¤hlen Sie Tarife zum Vergleichen:", fr: "SÃ©lectionnez les tarifs Ã  comparer :" },
                "Selecciona una o mÃ¡s tarifas para comparar.": { en: "Select one or more rates to compare.", zh: "é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªè´¹çŽ‡è¿›è¡Œæ¯”è¾ƒã€‚", de: "WÃ¤hlen Sie einen oder mehrere Tarife zum Vergleichen.", fr: "SÃ©lectionnez un ou plusieurs tarifs Ã  comparer." },
                "ðŸ” Buscar comercializadora:": { en: "ðŸ” Search provider:", zh: "ðŸ” æœç´¢ä¾›åº”å•†ï¼š", de: "ðŸ” Anbieter suchen:", fr: "ðŸ” Rechercher un fournisseur :" },
                "Escribe el nombre de la comercializadora": { en: "Enter provider name", zh: "è¾“å…¥ä¾›åº”å•†åç§°", de: "Anbieternamen eingeben", fr: "Entrez le nom du fournisseur" },
                "Ordenar por:": { en: "Sort by:", zh: "æŽ’åºæ–¹å¼ï¼š", de: "Sortieren nach:", fr: "Trier par :" },
                "ðŸ’° Mayor ahorro primero": { en: "ðŸ’° Highest savings first", zh: "ðŸ’° æœ€é«˜èŠ‚çœä¼˜å…ˆ", de: "ðŸ’° HÃ¶chste Einsparungen zuerst", fr: "ðŸ’° Ã‰conomies les plus Ã©levÃ©es d'abord" },
                "ðŸ”» Menor ahorro primero": { en: "ðŸ”» Lowest savings first", zh: "ðŸ”» æœ€ä½ŽèŠ‚çœä¼˜å…ˆ", de: "ðŸ”» Niedrigste Einsparungen zuerst", fr: "ðŸ”» Ã‰conomies les plus faibles d'abord" },
                "ðŸ“‹ Por nombre": { en: "ðŸ“‹ By name", zh: "ðŸ“‹ æŒ‰åç§°", de: "ðŸ“‹ Nach Name", fr: "ðŸ“‹ Par nom" },
                "Annual savings:": { en: "Annual savings:", zh: "å¹´åº¦èŠ‚çœï¼š", de: "JÃ¤hrliche Einsparungen:", fr: "Ã‰conomies annuelles :" },
                "Calcular tarifas seleccionadas": { en: "Calculate selected rates", zh: "è®¡ç®—æ‰€é€‰è´¹çŽ‡", de: "AusgewÃ¤hlte Tarife berechnen", fr: "Calculer les tarifs sÃ©lectionnÃ©s" },
                
                // GAS - Resultados
                "Fixed term (30 days)": { en: "Fixed term (30 days)", zh: "å›ºå®šæœŸé™ï¼ˆ30å¤©ï¼‰", de: "Feste Laufzeit (30 Tage)", fr: "Terme fixe (30 jours)" },
                "EnergÃ­a (500 kWh)": { en: "Energy (500 kWh)", zh: "èƒ½æºï¼ˆ500åƒç“¦æ—¶ï¼‰", de: "Energie (500 kWh)", fr: "Ã‰nergie (500 kWh)" },
                "Hydrocarbon tax": { en: "Hydrocarbon tax", zh: "ç¢³æ°¢åŒ–åˆç‰©ç¨Ž", de: "Kohlenwasserstoffsteuer", fr: "Taxe sur les hydrocarbures" },
                "Your current bill:": { en: "Your current bill:", zh: "æ‚¨å½“å‰çš„è´¦å•ï¼š", de: "Ihre aktuelle Rechnung:", fr: "Votre facture actuelle :" },
                "With this rate:": { en: "With this rate:", zh: "ä½¿ç”¨æ­¤è´¹çŽ‡ï¼š", de: "Mit diesem Tarif:", fr: "Avec ce tarif :" },
                "Monthly savings:": { en: "Monthly savings:", zh: "æ¯æœˆèŠ‚çœï¼š", de: "Monatliche Einsparungen:", fr: "Ã‰conomies mensuelles :" },
                
                // GAS - PDF
                "SAVINGS STUDY": { en: "SAVINGS STUDY", zh: "èŠ‚çœç ”ç©¶", de: "EINSPARUNGSSTUDIE", fr: "Ã‰TUDE D'Ã‰CONOMIES" },
                "COMPARATIVA PROFESIONAL GAS - DRK": { en: "PROFESSIONAL GAS COMPARISON - DRK", zh: "ä¸“ä¸šå¤©ç„¶æ°”æ¯”è¾ƒ - DRK", de: "PROFESSIONELLER GASVERGLEICH - DRK", fr: "COMPARAISON PROFESSIONNELLE GAZ - DRK" },
                "TARIFA:": { en: "RATE:", zh: "è´¹çŽ‡ï¼š", de: "TARIF:", fr: "TARIF :" },
                "PRECIOS DE LA OFERTA: DRK - DRK 1": { en: "OFFER PRICES: DRK - DRK 1", zh: "æŠ¥ä»·ä»·æ ¼ï¼šDRK - DRK 1", de: "ANGEBOTSPREISE: DRK - DRK 1", fr: "PRIX DE L'OFFRE : DRK - DRK 1" },
                "TÃ‰RMINO FIJO:": { en: "FIXED TERM:", zh: "å›ºå®šæœŸé™ï¼š", de: "FESTE LAUFZEIT:", fr: "TERME FIXE :" },
                "ENERGÃA:": { en: "ENERGY:", zh: "èƒ½æºï¼š", de: "ENERGIE:", fr: "Ã‰NERGIE :" },
                "Precio fijo diario (â‚¬/dÃ­a):": { en: "Daily fixed price (â‚¬/day):", zh: "æ¯æ—¥å›ºå®šä»·æ ¼ï¼ˆâ‚¬/å¤©ï¼‰ï¼š", de: "TÃ¤glicher Festpreis (â‚¬/Tag):", fr: "Prix fixe journalier (â‚¬/jour) :" },
                "Precio energÃ­a (â‚¬/kWh):": { en: "Energy price (â‚¬/kWh):", zh: "èƒ½æºä»·æ ¼ï¼ˆâ‚¬/åƒç“¦æ—¶ï¼‰ï¼š", de: "Energiepreis (â‚¬/kWh):", fr: "Prix de l'Ã©nergie (â‚¬/kWh) :" },
                "DESGLOSE DETALLADO DE LA SIMULACIÃ“N (DRK - DRK 1)": { en: "DETAILED BREAKDOWN OF SIMULATION (DRK - DRK 1)", zh: "æ¨¡æ‹Ÿè¯¦ç»†åˆ†è§£ï¼ˆDRK - DRK 1ï¼‰", de: "DETAILLIERTE AUFSCHLÃœSSELUNG DER SIMULATION (DRK - DRK 1)", fr: "DÃ‰TAIL DE LA SIMULATION (DRK - DRK 1)" },
                "TÃ‰RMINO FIJO (Precio en â‚¬/dÃ­a)": { en: "FIXED TERM (Price in â‚¬/day)", zh: "å›ºå®šæœŸé™ï¼ˆä»·æ ¼â‚¬/å¤©ï¼‰", de: "FESTE LAUFZEIT (Preis in â‚¬/Tag)", fr: "TERME FIXE (Prix en â‚¬/jour)" },
                "Precio fijo (30 dÃ­as x 0,001021)": { en: "Fixed price (30 days x 0.001021)", zh: "å›ºå®šä»·æ ¼ï¼ˆ30å¤© x 0.001021ï¼‰", de: "Festpreis (30 Tage x 0,001021)", fr: "Prix fixe (30 jours x 0,001021)" },
                "TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)": { en: "ENERGY TERM (Prices in â‚¬/kWh)", zh: "èƒ½æºæ¡æ¬¾ï¼ˆä»·æ ¼â‚¬/åƒç“¦æ—¶ï¼‰", de: "ENERGIETERM (Preise in â‚¬/kWh)", fr: "TERME Ã‰NERGIE (Prix en â‚¬/kWh)" },
                "EnergÃ­a (500 kWh x 0,099369)": { en: "Energy (500 kWh x 0.099369)", zh: "èƒ½æºï¼ˆ500åƒç“¦æ—¶ x 0.099369ï¼‰", de: "Energie (500 kWh x 0,099369)", fr: "Ã‰nergie (500 kWh x 0,099369)" },
                "Subtotal EnergÃ­a (Bruto)": { en: "Energy Subtotal (Gross)", zh: "èƒ½æºå°è®¡ï¼ˆæ€»è®¡ï¼‰", de: "Energie Zwischensumme (Brutto)", fr: "Sous-total Ã‰nergie (Brut)" },
                "Imp. Hidrocarburos": { en: "Hydrocarbon Tax", zh: "ç¢³æ°¢åŒ–åˆç‰©ç¨Ž", de: "Kohlenwasserstoffsteuer", fr: "Taxe Hydrocarbures" },
                "TOTAL FACTURA (30 DÃAS)": { en: "TOTAL BILL (30 DAYS)", zh: "æ€»è´¦å•ï¼ˆ30å¤©ï¼‰", de: "GESAMTRECHNUNG (30 TAGE)", fr: "FACTURE TOTALE (30 JOURS)" },
                "Precio fijo": { en: "Fixed price", zh: "å›ºå®šä»·æ ¼", de: "Festpreis", fr: "Prix fixe" },
                
                // Variaciones con parÃ©ntesis completos (muy importantes para PDFs)
                "TÃ‰RMINO POTENCIA (Precio en â‚¬/kW DÃ­a)": { en: "POWER TERM (Price in â‚¬/kW Day)", zh: "åŠŸçŽ‡æ¡æ¬¾ï¼ˆä»·æ ¼â‚¬/åƒç“¦å¤©ï¼‰", de: "LEISTUNGSTERM (Preis in â‚¬/kW Tag)", fr: "TERME PUISSANCE (Prix en â‚¬/kW Jour)" },
                "TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)": { en: "ENERGY TERM (Prices in â‚¬/kWh)", zh: "èƒ½æºæ¡æ¬¾ï¼ˆä»·æ ¼â‚¬/åƒç“¦æ—¶ï¼‰", de: "ENERGIETERM (Preise in â‚¬/kWh)", fr: "TERME Ã‰NERGIE (Prix en â‚¬/kWh)" },
                "TOTAL FACTURA (60 DÃAS)": { en: "TOTAL BILL (60 DAYS)", zh: "æ€»è´¦å•ï¼ˆ60å¤©ï¼‰", de: "GESAMTRECHNUNG (60 TAGE)", fr: "FACTURE TOTALE (60 JOURS)" },
                "Liderando el ahorro y la": { es: "Liderando el ahorro y la", en: "Leading in savings and", zh: "å¼•é¢†èŠ‚çœå’Œ", de: "FÃ¼hrend bei Einsparungen und", fr: "Leader de l'Ã©pargne et de" },
                "eficiencia energÃ©tica.": { es: "eficiencia energÃ©tica.", en: "energy efficiency.", zh: "èƒ½æºæ•ˆçŽ‡ã€‚", de: "Energieeffizienz.", fr: "efficacitÃ© Ã©nergÃ©tique." },
                "AsesorÃ­a EnergÃ©tica": { es: "AsesorÃ­a EnergÃ©tica", en: "Energy Consulting", zh: "èƒ½æºå’¨è¯¢", de: "Energieberatung", fr: "Conseil en Ã©nergie" },
                "60d": { en: "60d", zh: "60å¤©", de: "60T", fr: "60j" },
                
                // MULTICUPS - Interfaz completa
                "AÃ±adir Suministro": { en: "Add Supply", zh: "æ·»åŠ ä¾›åº”", de: "Versorgung hinzufÃ¼gen", fr: "Ajouter l'approvisionnement" },
                "Datos Generales": { en: "General Data", zh: "ä¸€èˆ¬æ•°æ®", de: "Allgemeine Daten", fr: "DonnÃ©es gÃ©nÃ©rales" },
                "NÃºmero CUPS": { en: "CUPS Number", zh: "CUPSå·ç ", de: "CUPS-Nummer", fr: "NumÃ©ro CUPS" },
                "DÃ­as Facturados": { en: "Billed Days", zh: "è®¡è´¹å¤©æ•°", de: "Berechnete Tage", fr: "Jours facturÃ©s" },
                "Potencias (kW)": { en: "Power (kW)", zh: "åŠŸçŽ‡ (kW)", de: "Leistung (kW)", fr: "Puissance (kW)" },
                "EnergÃ­a (kWh)": { en: "Energy (kWh)", zh: "èƒ½æº (kWh)", de: "Energie (kWh)", fr: "Ã‰nergie (kWh)" },
                "Total Factura (â‚¬)": { en: "Total Bill (â‚¬)", zh: "æ€»è´¦å• (â‚¬)", de: "Gesamtrechnung (â‚¬)", fr: "Facture totale (â‚¬)" },
                "AÃ‘ADIR SUMINISTRO MANUAL": { en: "ADD MANUAL SUPPLY", zh: "æ·»åŠ æ‰‹åŠ¨ä¾›åº”", de: "MANUELLE VERSORGUNG HINZUFÃœGEN", fr: "AJOUTER L'APPROVISIONNEMENT MANUEL" },
                "AÃ‘ADIR SUMINISTRO": { en: "ADD SUPPLY", zh: "æ·»åŠ ä¾›åº”", de: "VERSORGUNG HINZUFÃœGEN", fr: "AJOUTER L'APPROVISIONNEMENT" },
                "Cancelar": { en: "Cancel", zh: "å–æ¶ˆ", de: "Abbrechen", fr: "Annuler" },
                
                // Modal Request Improvement
                "Request Improvement from DRK": { en: "Request Improvement from DRK", zh: "å‘DRKè¯·æ±‚æ”¹è¿›", de: "Verbesserung von DRK anfordern", fr: "Demander une amÃ©lioration Ã  DRK" },
                "Solicitar Mejora a DRK": { en: "Request Improvement from DRK", zh: "å‘DRKè¯·æ±‚æ”¹è¿›", de: "Verbesserung von DRK anfordern", fr: "Demander une amÃ©lioration Ã  DRK" },
                "Complete los datos para que el equipo de Back Office pueda revisar este comparativo y buscar una mejor opciÃ³n.": { 
                    en: "Complete the data so that the Back Office team can review this comparison and find a better option.", 
                    zh: "å¡«å†™æ•°æ®ï¼Œä»¥ä¾¿åŽå°å›¢é˜Ÿå®¡æŸ¥æ­¤æ¯”è¾ƒå¹¶æ‰¾åˆ°æ›´å¥½çš„é€‰æ‹©ã€‚", 
                    de: "VervollstÃ¤ndigen Sie die Daten, damit das Back-Office-Team diesen Vergleich Ã¼berprÃ¼fen und eine bessere Option finden kann.", 
                    fr: "ComplÃ©tez les donnÃ©es pour que l'Ã©quipe du Back Office puisse examiner cette comparaison et trouver une meilleure option." 
                },
                "CÃ“DIGO COMERCIAL (Obligatorio)": { en: "COMMERCIAL CODE (Required)", zh: "å•†ä¸šä»£ç ï¼ˆå¿…å¡«ï¼‰", de: "HANDELSCODE (Erforderlich)", fr: "CODE COMMERCIAL (Obligatoire)" },
                "Nombre Cliente": { en: "Client Name", zh: "å®¢æˆ·åç§°", de: "Kundenname", fr: "Nom du client" },
                "CUPS": { en: "CUPS", zh: "CUPS", de: "CUPS", fr: "CUPS" },
                "CUPS / DIRECCIÃ“N": { en: "CUPS / ADDRESS", zh: "CUPS / åœ°å€", de: "CUPS / ADRESSE", fr: "CUPS / ADRESSE" },
                "TelÃ©fono": { en: "Phone", zh: "ç”µè¯", de: "Telefon", fr: "TÃ©lÃ©phone" },
                "Email": { en: "Email", zh: "é‚®ç®±", de: "E-Mail", fr: "Email" },
                "Observaciones (opcional)": { en: "Observations (optional)", zh: "å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰", de: "Anmerkungen (optional)", fr: "Observations (facultatif)" },
                "RECORDATORIO:": { en: "REMINDER:", zh: "æé†’ï¼š", de: "ERINNERUNG:", fr: "RAPPEL :" },
                "Por favor, adjunte las facturas del cliente en su respuesta al email automÃ¡tico que recibirÃ¡.": { 
                    en: "Please attach the client's invoices in your reply to the automatic email you will receive.", 
                    zh: "è¯·åœ¨æ‚¨æ”¶åˆ°çš„è‡ªåŠ¨ç”µå­é‚®ä»¶å›žå¤ä¸­é™„ä¸Šå®¢æˆ·çš„å‘ç¥¨ã€‚", 
                    de: "Bitte fÃ¼gen Sie die Rechnungen des Kunden in Ihrer Antwort auf die automatische E-Mail bei, die Sie erhalten werden.", 
                    fr: "Veuillez joindre les factures du client dans votre rÃ©ponse Ã  l'e-mail automatique que vous recevrez." 
                },
                "ðŸ“§ ENVIAR SOLICITUD": { en: "ðŸ“§ SEND REQUEST", zh: "ðŸ“§ å‘é€è¯·æ±‚", de: "ðŸ“§ ANFRAGE SENDEN", fr: "ðŸ“§ ENVOYER LA DEMANDE" },
                
                // Mensajes de error
                "Error: Los datos de GAS no estÃ¡n completos. Por favor, realice el cÃ¡lculo de nuevo.": { 
                    en: "Error: GAS data is incomplete. Please recalculate.", 
                    zh: "é”™è¯¯ï¼šGASæ•°æ®ä¸å®Œæ•´ã€‚è¯·é‡æ–°è®¡ç®—ã€‚", 
                    de: "Fehler: GAS-Daten sind unvollstÃ¤ndig. Bitte neu berechnen.", 
                    fr: "Erreur : Les donnÃ©es GAS sont incomplÃ¨tes. Veuillez recalculer." 
                },
                "Error: Los datos de ELECTRICIDAD no estÃ¡n completos. Por favor, realice el cÃ¡lculo de nuevo.": { 
                    en: "Error: ELECTRICITY data is incomplete. Please recalculate.", 
                    zh: "é”™è¯¯ï¼šç”µåŠ›æ•°æ®ä¸å®Œæ•´ã€‚è¯·é‡æ–°è®¡ç®—ã€‚", 
                    de: "Fehler: ELEKTRIZITÃ„T-Daten sind unvollstÃ¤ndig. Bitte neu berechnen.", 
                    fr: "Erreur : Les donnÃ©es Ã‰LECTRICITÃ‰ sont incomplÃ¨tes. Veuillez recalculer." 
                },
                
                // Modales de resultados
                "CÃ¡lculo Completado": { en: "Calculation Completed", zh: "è®¡ç®—å®Œæˆ", de: "Berechnung abgeschlossen", fr: "Calcul terminÃ©" },
                "âœ… CÃ¡lculo Completado": { en: "âœ… Calculation Completed", zh: "âœ… è®¡ç®—å®Œæˆ", de: "âœ… Berechnung abgeschlossen", fr: "âœ… Calcul terminÃ©" },
                "We found offers with savings. How do you want to continue?": { en: "We found offers with savings. How do you want to continue?", zh: "æˆ‘ä»¬å‘çŽ°äº†èŠ‚çœä¼˜æƒ ã€‚æ‚¨æƒ³å¦‚ä½•ç»§ç»­ï¼Ÿ", de: "Wir haben Angebote mit Einsparungen gefunden. Wie mÃ¶chten Sie fortfahren?", fr: "Nous avons trouvÃ© des offres avec des Ã©conomies. Comment voulez-vous continuer ?" },
                "Comparar FIJO vs INDEXADO": { en: "Compare FIXED vs INDEXED", zh: "æ¯”è¾ƒå›ºå®šä¸ŽæŒ‡æ•°", de: "FEST vs INDEXIERT vergleichen", fr: "Comparer FIXE vs INDEXÃ‰" },
                "Generate dual comparison: fixed rate and DRK INDEX indexed rate (variable market price).": { en: "Generate dual comparison: fixed rate and DRK INDEX indexed rate (variable market price).", zh: "ç”ŸæˆåŒé‡æ¯”è¾ƒï¼šå›ºå®šè´¹çŽ‡å’ŒDRK INDEXæŒ‡æ•°è´¹çŽ‡ï¼ˆå¯å˜å¸‚åœºä»·æ ¼ï¼‰ã€‚", de: "Dual-Vergleich generieren: Festpreis und DRK INDEX indexierter Preis (variabler Marktpreis).", fr: "GÃ©nÃ©rer une comparaison double : tarif fixe et tarif indexÃ© DRK INDEX (prix de marchÃ© variable)." },
                "SEE BEST OPTION": { en: "SEE BEST OPTION", zh: "æŸ¥çœ‹æœ€ä½³é€‰é¡¹", de: "BESTE OPTION SEHEN", fr: "VOIR LA MEILLEURE OPTION" },
                "Automatically shows the offer with the highest savings and generates the comparison": { en: "Automatically shows the offer with the highest savings and generates the comparison", zh: "è‡ªåŠ¨æ˜¾ç¤ºèŠ‚çœæœ€å¤šçš„ä¼˜æƒ å¹¶ç”Ÿæˆæ¯”è¾ƒ", de: "Zeigt automatisch das Angebot mit den hÃ¶chsten Einsparungen und erstellt den Vergleich", fr: "Affiche automatiquement l'offre avec les Ã©conomies les plus Ã©levÃ©es et gÃ©nÃ¨re la comparaison" },
                "CHOOSE FROM RESULTS": { en: "CHOOSE FROM RESULTS", zh: "ä»Žç»“æžœä¸­é€‰æ‹©", de: "AUS ERGEBNISSEN WÃ„HLEN", fr: "CHOISIR PARMI LES RÃ‰SULTATS" },
                "Review all offers with positive savings and choose your preferred one": { en: "Review all offers with positive savings and choose your preferred one", zh: "æŸ¥çœ‹æ‰€æœ‰å…·æœ‰æ­£èŠ‚çœçš„ä¼˜æƒ å¹¶é€‰æ‹©æ‚¨å–œæ¬¢çš„ä¼˜æƒ ", de: "ÃœberprÃ¼fen Sie alle Angebote mit positiven Einsparungen und wÃ¤hlen Sie Ihr bevorzugtes", fr: "Examinez toutes les offres avec des Ã©conomies positives et choisissez celle que vous prÃ©fÃ©rez" },
                "Advice:": { en: "Advice:", zh: "å»ºè®®ï¼š", de: "Rat:", fr: "Conseil :" },
                "Si quieres ver rÃ¡pidamente la mejor oferta, elige la primera opciÃ³n. Si necesitas comparar varias opciones o el cliente tiene preferencias especÃ­ficas, elige la segunda.": { en: "If you want to quickly see the best offer, choose the first option. If you need to compare multiple options or the client has specific preferences, choose the second.", zh: "å¦‚æžœæ‚¨æƒ³å¿«é€ŸæŸ¥çœ‹æœ€ä½³ä¼˜æƒ ï¼Œè¯·é€‰æ‹©ç¬¬ä¸€ä¸ªé€‰é¡¹ã€‚å¦‚æžœæ‚¨éœ€è¦æ¯”è¾ƒå¤šä¸ªé€‰é¡¹æˆ–å®¢æˆ·æœ‰ç‰¹å®šåå¥½ï¼Œè¯·é€‰æ‹©ç¬¬äºŒä¸ªã€‚", de: "Wenn Sie schnell das beste Angebot sehen mÃ¶chten, wÃ¤hlen Sie die erste Option. Wenn Sie mehrere Optionen vergleichen mÃ¼ssen oder der Kunde spezifische PrÃ¤ferenzen hat, wÃ¤hlen Sie die zweite.", fr: "Si vous voulez voir rapidement la meilleure offre, choisissez la premiÃ¨re option. Si vous devez comparer plusieurs options ou si le client a des prÃ©fÃ©rences spÃ©cifiques, choisissez la seconde." },
                
                // ConfirmaciÃ³n de suministro aÃ±adido
                "Suministro AÃ±adido": { en: "Supply Added", zh: "ä¾›åº”å·²æ·»åŠ ", de: "Versorgung hinzugefÃ¼gt", fr: "Approvisionnement ajoutÃ©" },
                "Suministro ES (DRK) aÃ±adido. Total:": { en: "Supply ES (DRK) added. Total:", zh: "ä¾›åº”ESï¼ˆDRKï¼‰å·²æ·»åŠ ã€‚æ€»è®¡ï¼š", de: "Versorgung ES (DRK) hinzugefÃ¼gt. Gesamt:", fr: "Approvisionnement ES (DRK) ajoutÃ©. Total :" },
                "Understood": { en: "Understood", zh: "æ˜Žç™½äº†", de: "Verstanden", fr: "Compris" },
                
                // SelecciÃ³n MULTICUPS
                "Volver a selecciÃ³n": { en: "Back to selection", zh: "è¿”å›žé€‰æ‹©", de: "ZurÃ¼ck zur Auswahl", fr: "Retour Ã  la sÃ©lection" },
                "MULTICUPS": { en: "MULTICUPS", zh: "å¤šCUPS", de: "MULTICUPS", fr: "MULTICUPS" },
                "Selecciona el tipo de contrato que deseas aÃ±adir.": { en: "Select the type of contract you want to add.", zh: "é€‰æ‹©è¦æ·»åŠ çš„åˆåŒç±»åž‹ã€‚", de: "WÃ¤hlen Sie den Vertragstyp aus, den Sie hinzufÃ¼gen mÃ¶chten.", fr: "SÃ©lectionnez le type de contrat que vous souhaitez ajouter." },
                "Total de suministros actuales:": { en: "Total current supplies:", zh: "å½“å‰ä¾›åº”æ€»æ•°ï¼š", de: "Gesamtzahl aktueller Versorgungen:", fr: "Total des approvisionnements actuels :" },
                "Permite EscÃ¡ner QR, Imagen y Entrada Manual": { en: "Allows QR Scanner, Image and Manual Entry", zh: "å…è®¸äºŒç»´ç æ‰«æã€å›¾åƒå’Œæ‰‹åŠ¨è¾“å…¥", de: "ErmÃ¶glicht QR-Scanner, Bild und manuelle Eingabe", fr: "Permet le scanner QR, l'image et la saisie manuelle" },
                "Solo Entrada de Datos Manual": { en: "Manual Data Entry Only", zh: "ä»…æ‰‹åŠ¨æ•°æ®è¾“å…¥", de: "Nur manuelle Dateneingabe", fr: "Saisie manuelle des donnÃ©es uniquement" },
                "Entrada de Datos Manual": { en: "Manual Data Entry", zh: "æ‰‹åŠ¨æ•°æ®è¾“å…¥", de: "Manuelle Dateneingabe", fr: "Saisie Manuelle des DonnÃ©es" },
                "CALCULAR": { en: "CALCULATE", zh: "è®¡ç®—", de: "BERECHNEN", fr: "CALCULER" },
                "DirecciÃ³n": { en: "Address", zh: "åœ°å€", de: "Adresse", fr: "Adresse" },
                "DirecciÃ³n de Suministro": { en: "Supply Address", zh: "ä¾›åº”åœ°å€", de: "Versorgungsadresse", fr: "Adresse d'Approvisionnement" },
                "DIRECCIÃ“N DE SUMINISTRO:": { en: "SUPPLY ADDRESS:", zh: "ä¾›åº”åœ°å€ï¼š", de: "VERSORGUNGSADRESSE:", fr: "ADRESSE D'APPROVISIONNEMENT:" },
                "FINALIZAR Y COMPARAR": { en: "FINISH AND COMPARE", zh: "å®Œæˆå¹¶æ¯”è¾ƒ", de: "ABSCHLIESSEN UND VERGLEICHEN", fr: "TERMINER ET COMPARER" },
                "Suministros": { en: "Supplies", zh: "ä¾›åº”", de: "Versorgungen", fr: "Approvisionnements" },
                
                // Datos Acumulados
                "Datos Acumulados": { en: "Accumulated Data", zh: "ç´¯è®¡æ•°æ®", de: "Kumulierte Daten", fr: "DonnÃ©es cumulÃ©es" },
                "TOTAL ENERGY": { en: "TOTAL ENERGY", zh: "æ€»èƒ½æº", de: "GESAMTENERGIE", fr: "Ã‰NERGIE TOTALE" },
                "Hogar/Negocio": { en: "Home/Business", zh: "å®¶åº­/å•†ä¸š", de: "Haus/GeschÃ¤ft", fr: "Maison/Entreprise" },
                "Industria/Gran Consumo": { en: "Industry/High Consumption", zh: "å·¥ä¸š/é«˜æ¶ˆè€—", de: "Industrie/GroÃŸverbrauch", fr: "Industrie/Grande consommation" },
                "Consumos (kWh)": { en: "Consumption (kWh)", zh: "æ¶ˆè€— (kWh)", de: "Verbrauch (kWh)", fr: "Consommation (kWh)" },
                
                // Textos adicionales de interfaz
                "PROFESIONAL": { en: "PROFESSIONAL", zh: "ä¸“ä¸š", de: "PROFESSIONELL", fr: "PROFESSIONNEL" },
                "Total Anual Estimado": { en: "Estimated Annual Total", zh: "ä¼°è®¡å¹´åº¦æ€»é¢", de: "GeschÃ¤tzter Jahresgesamtbetrag", fr: "Total annuel estimÃ©" },
                
                // TEXTOS FALTANTES - IMPORTANTE
                "Total Periodo": { en: "Total Period", zh: "æ€»æœŸé™", pt: "PerÃ­odo Total", de: "Gesamtzeitraum", fr: "PÃ©riode totale" },
                "Selecciona la regulaciÃ³n de gas.": { en: "Select gas regulation.", zh: "é€‰æ‹©å¤©ç„¶æ°”ç›‘ç®¡ã€‚", pt: "Selecione a regulamentaÃ§Ã£o de gÃ¡s.", de: "WÃ¤hlen Sie die Gasregelung.", fr: "SÃ©lectionnez la rÃ©glementation du gaz." },
                "RegulaciÃ³n de Gas - Nivel 1": { en: "Gas Regulation - Level 1", zh: "å¤©ç„¶æ°”ç›‘ç®¡ - çº§åˆ« 1", pt: "RegulaÃ§Ã£o de GÃ¡s - NÃ­vel 1", de: "Gasregelung - Stufe 1", fr: "RÃ©glementation Gaz - Niveau 1" },
                "RegulaciÃ³n de Gas - Nivel 2": { en: "Gas Regulation - Level 2", zh: "å¤©ç„¶æ°”ç›‘ç®¡ - çº§åˆ« 2", pt: "RegulaÃ§Ã£o de GÃ¡s - NÃ­vel 2", de: "Gasregelung - Stufe 2", fr: "RÃ©glementation Gaz - Niveau 2" },
                "RegulaciÃ³n de Gas - Nivel 3": { en: "Gas Regulation - Level 3", zh: "å¤©ç„¶æ°”ç›‘ç®¡ - çº§åˆ« 3", pt: "RegulaÃ§Ã£o de GÃ¡s - NÃ­vel 3", de: "Gasregelung - Stufe 3", fr: "RÃ©glementation Gaz - Niveau 3" },
                "RegulaciÃ³n de Gas - Nivel 4": { en: "Gas Regulation - Level 4", zh: "å¤©ç„¶æ°”ç›‘ç®¡ - çº§åˆ« 4", pt: "RegulaÃ§Ã£o de GÃ¡s - NÃ­vel 4", de: "Gasregelung - Stufe 4", fr: "RÃ©glementation Gaz - Niveau 4" },
                "RegulaciÃ³n de Gas - Nivel 5": { en: "Gas Regulation - Level 5", zh: "å¤©ç„¶æ°”ç›‘ç®¡ - çº§åˆ« 5", pt: "RegulaÃ§Ã£o de GÃ¡s - NÃ­vel 5", de: "Gasregelung - Stufe 5", fr: "RÃ©glementation Gaz - Niveau 5" },
                "RegulaciÃ³n de Gas - Nivel 6": { en: "Gas Regulation - Level 6", zh: "å¤©ç„¶æ°”ç›‘ç®¡ - çº§åˆ« 6", pt: "RegulaÃ§Ã£o de GÃ¡s - NÃ­vel 6", de: "Gasregelung - Stufe 6", fr: "RÃ©glementation Gaz - Niveau 6" },
                "Por favor, completa todos los campos": { en: "Please complete all fields", zh: "è¯·å¡«å†™æ‰€æœ‰å­—æ®µ", pt: "Por favor, preencha todos os campos", de: "Bitte fÃ¼llen Sie alle Felder aus", fr: "Veuillez remplir tous les champs" },
                "Aceptar": { en: "Accept", zh: "æŽ¥å—", pt: "Aceitar", de: "Akzeptieren", fr: "Accepter" },
                "Variado": { en: "Varied", zh: "å„ç§", pt: "Variado", de: "Variiert", fr: "VariÃ©" },
                "No hay datos para exportar": { en: "No data to export", zh: "æ²¡æœ‰è¦å¯¼å‡ºçš„æ•°æ®", pt: "NÃ£o hÃ¡ dados para exportar", de: "Keine Daten zum Exportieren", fr: "Aucune donnÃ©e Ã  exporter" },
                "CÃ“DIGO COMERCIAL (Obligatorio):": { en: "COMMERCIAL CODE (Required):", zh: "å•†ä¸šä»£ç ï¼ˆå¿…å¡«ï¼‰ï¼š", pt: "CÃ“DIGO COMERCIAL (ObrigatÃ³rio):", de: "HANDELSCODE (Pflicht):", fr: "CODE COMMERCIAL (Obligatoire) :" },
                "El cÃ³digo comercial es obligatorio": { en: "Commercial code is required", zh: "å•†ä¸šä»£ç ä¸ºå¿…å¡«é¡¹", pt: "O cÃ³digo comercial Ã© obrigatÃ³rio", de: "Der Handelscode ist erforderlich", fr: "Le code commercial est obligatoire" },
                "NOMBRE DEL CLIENTE:": { en: "CLIENT NAME:", zh: "å®¢æˆ·åç§°ï¼š", pt: "NOME DO CLIENTE:", de: "KUNDENNAME:", fr: "NOM DU CLIENT :" },
                "[NOMBRE COMPLETO CLIENTE]": { en: "[FULL CLIENT NAME]", zh: "[å®¢æˆ·å…¨å]", pt: "[NOME COMPLETO DO CLIENTE]", de: "[VOLLSTÃ„NDIGER KUNDENNAME]", fr: "[NOM COMPLET DU CLIENT]" },
                "Realizar Nueva ComparaciÃ³n": { en: "Make New Comparison", zh: "è¿›è¡Œæ–°æ¯”è¾ƒ", de: "Neuen Vergleich durchfÃ¼hren", fr: "Effectuer une nouvelle comparaison" },
                "âœ… Â¡Oferta copiada con Ã©xito! Ahora puede pegar (Ctrl+V o Cmd+V) el diseÃ±o visual en su correo de escritorio.": { en: "âœ… Offer copied successfully! Now you can paste (Ctrl+V or Cmd+V) the visual design into your email client.", zh: "âœ… æŠ¥ä»·å¤åˆ¶æˆåŠŸï¼çŽ°åœ¨æ‚¨å¯ä»¥å°†è§†è§‰è®¾è®¡ç²˜è´´ï¼ˆCtrl+V æˆ– Cmd+Vï¼‰åˆ°æ‚¨çš„ç”µå­é‚®ä»¶å®¢æˆ·ç«¯ã€‚", de: "âœ… Angebot erfolgreich kopiert! Jetzt kÃ¶nnen Sie das visuelle Design in Ihren E-Mail-Client einfÃ¼gen (Strg+V oder Cmd+V).", fr: "âœ… Offre copiÃ©e avec succÃ¨s ! Vous pouvez maintenant coller (Ctrl+V ou Cmd+V) le design visuel dans votre client de messagerie." },
                "No se pudo copiar el diseÃ±o visual. Intente desde un PC o contacte a soporte.": { en: "Could not copy visual design. Try from a PC or contact support.", zh: "æ— æ³•å¤åˆ¶è§†è§‰è®¾è®¡ã€‚è¯·å°è¯•ä»ŽPCæˆ–è”ç³»æ”¯æŒã€‚", de: "Visuelles Design konnte nicht kopiert werden. Versuchen Sie es von einem PC aus oder kontaktieren Sie den Support.", fr: "Impossible de copier le design visuel. Essayez depuis un PC ou contactez le support." },
                "Acumulado": { en: "Accumulated", zh: "ç´¯è®¡", de: "Kumuliert", fr: "AccumulÃ©" },
                "Total Consumo": { en: "Total Consumption", zh: "æ€»æ¶ˆè€—", de: "Gesamtverbrauch", fr: "Consommation totale" },
                "Ahorro:": { en: "Savings:", zh: "èŠ‚çœï¼š", de: "Einsparungen:", fr: "Ã‰conomies :" },
                "Ahorro": { en: "Savings", zh: "èŠ‚çœ", de: "Einsparungen", fr: "Ã‰conomies" },
                "No hay consumos para este tipo.": { en: "No consumption for this type.", zh: "æ­¤ç±»åž‹æ²¡æœ‰æ¶ˆè€—ã€‚", de: "Kein Verbrauch fÃ¼r diesen Typ.", fr: "Aucune consommation pour ce type." },
                "No hay potencias para este tipo.": { en: "No power for this type.", zh: "æ­¤ç±»åž‹æ²¡æœ‰åŠŸçŽ‡ã€‚", de: "Keine Leistung fÃ¼r diesen Typ.", fr: "Aucune puissance pour ce type." },
                "Los precios mostrados son de las ofertas ganadoras detectadas para cada tipo de tarifa y se aplican a las CUPS aÃ±adidas.": { en: "The prices shown are from the winning offers detected for each tariff type and apply to the added CUPS.", zh: "æ˜¾ç¤ºçš„ä»·æ ¼æ¥è‡ªæ£€æµ‹åˆ°çš„æ¯ç§å…³ç¨Žç±»åž‹çš„ä¸­æ ‡æŠ¥ä»·ï¼Œå¹¶é€‚ç”¨äºŽæ·»åŠ çš„CUPSã€‚", de: "Die angezeigten Preise stammen aus den fÃ¼r jeden Tariftyp erkannten gewinnenden Angeboten und gelten fÃ¼r die hinzugefÃ¼gten CUPS.", fr: "Les prix affichÃ©s proviennent des offres gagnantes dÃ©tectÃ©es pour chaque type de tarif et s'appliquent aux CUPS ajoutÃ©es." },
                
                // Secciones del PDF
                "POTENCIA": { en: "POWER", zh: "åŠŸçŽ‡", de: "LEISTUNG", fr: "PUISSANCE" },
                "ENERGÃA": { en: "ENERGY", zh: "èƒ½æº", de: "ENERGIE", fr: "Ã‰NERGIE" },
                "Resumen de Suministros AÃ±adidos": { en: "Summary of Added Supplies", zh: "å·²æ·»åŠ ä¾›åº”çš„æ‘˜è¦", de: "Zusammenfassung der hinzugefÃ¼gten Lieferungen", fr: "RÃ©sumÃ© des Fournitures AjoutÃ©es" },
                "Precios de las Ofertas Seleccionadas": { en: "Prices of Selected Offers", zh: "æ‰€é€‰æŠ¥ä»·çš„ä»·æ ¼", de: "Preise der ausgewÃ¤hlten Angebote", fr: "Prix des Offres SÃ©lectionnÃ©es" },
                "Desglose Individual por Suministro": { en: "Individual Breakdown by Supply", zh: "æŒ‰ä¾›åº”çš„ä¸ªåˆ«æ˜Žç»†", de: "EinzelaufschlÃ¼sselung nach Lieferung", fr: "Ventilation Individuelle par Fourniture" },
                "A continuaciÃ³n, se muestra el cÃ¡lculo detallado de la mejor oferta para cada CUPS, por orden de introducciÃ³n:": { en: "Below is the detailed calculation of the best offer for each CUPS, in order of entry:", zh: "ä»¥ä¸‹æ˜¯æ¯ä¸ªCUPSçš„æœ€ä½³æŠ¥ä»·çš„è¯¦ç»†è®¡ç®—ï¼ŒæŒ‰è¾“å…¥é¡ºåºï¼š", de: "Nachfolgend finden Sie die detaillierte Berechnung des besten Angebots fÃ¼r jede CUPS in Eingabereihenfolge:", fr: "Vous trouverez ci-dessous le calcul dÃ©taillÃ© de la meilleure offre pour chaque CUPS, par ordre d'introduction:" },
                "Suministro": { en: "Supply", zh: "ä¾›åº”", de: "Lieferung", fr: "Fourniture" },
                "AHORRO ANUAL": { en: "ANNUAL SAVINGS", zh: "å¹´åº¦èŠ‚çœ", de: "JÃ„HRLICHE EINSPARUNGEN", fr: "Ã‰CONOMIES ANNUELLES" },
                "TU TARIFA ACTUAL es la mejor": { en: "YOUR CURRENT RATE is the best", zh: "æ‚¨çš„å½“å‰è´¹çŽ‡æ˜¯æœ€å¥½çš„", de: "IHR AKTUELLER TARIF ist der beste", fr: "VOTRE TARIF ACTUEL est le meilleur" },
                "Tarifa aplicada en el cÃ¡lculo": { en: "Rate applied in calculation", zh: "è®¡ç®—ä¸­åº”ç”¨çš„è´¹çŽ‡", de: "Im Berechnungsverfahren angewandter Tarif", fr: "Tarif appliquÃ© dans le calcul" },
                "Factura Actual Periodo": { en: "Current Period Bill", zh: "å½“å‰æœŸé—´è´¦å•", de: "Aktuelle Periodenrechnung", fr: "Facture PÃ©riode Actuelle" },
                "Nuevo Coste Periodo": { en: "New Period Cost", zh: "æ–°æœŸé—´è´¹ç”¨", de: "Neue Periodenkosten", fr: "Nouveau CoÃ»t PÃ©riode" },
                "Desglose": { en: "Breakdown", zh: "æ˜Žç»†", de: "AufschlÃ¼sselung", fr: "Ventilation" },
                "Subtotal Potencia": { en: "Power Subtotal", zh: "åŠŸçŽ‡å°è®¡", de: "Leistung Zwischensumme", fr: "Sous-total Puissance" },
                "Subtotal EnergÃ­a (Neto)": { en: "Energy Subtotal (Net)", zh: "èƒ½æºå°è®¡ï¼ˆå‡€é¢ï¼‰", de: "Energie Zwischensumme (Netto)", fr: "Sous-total Ã‰nergie (Net)" },
                "Punta": { en: "Peak", zh: "å³°å€¼", de: "Spitze", fr: "Pointe" },
                "Llano": { en: "Standard", zh: "æ ‡å‡†", de: "Standard", fr: "Standard" },
                "Valle": { en: "Valley", zh: "è°·å€¼", de: "Tal", fr: "VallÃ©e" },
                
                // MULTICUPS - MÃ¡s textos
                "RESUMEN DE": { en: "SUMMARY OF", zh: "æ‘˜è¦", de: "ZUSAMMENFASSUNG VON", fr: "RÃ‰SUMÃ‰ DE" },
                "SUMINISTROS": { en: "SUPPLIES", zh: "ä¾›åº”", de: "VERSORGUNGEN", fr: "APPROVISIONNEMENTS" },
                "Confirmar Suministro MultiCups": { en: "Confirm MultiCups Supply", zh: "ç¡®è®¤å¤šCUPSä¾›åº”", de: "MultiCups-Versorgung bestÃ¤tigen", fr: "Confirmer l'approvisionnement MultiCups" },
                "Revisa los datos extraÃ­dos del QR antes de aÃ±adir este suministro a la lista.": { en: "Review the data extracted from the QR before adding this supply to the list.", zh: "åœ¨å°†æ­¤ä¾›åº”æ·»åŠ åˆ°åˆ—è¡¨ä¹‹å‰ï¼Œè¯·æ£€æŸ¥ä»ŽäºŒç»´ç ä¸­æå–çš„æ•°æ®ã€‚", de: "ÃœberprÃ¼fen Sie die aus dem QR-Code extrahierten Daten, bevor Sie diese Versorgung zur Liste hinzufÃ¼gen.", fr: "VÃ©rifiez les donnÃ©es extraites du QR avant d'ajouter cet approvisionnement Ã  la liste." },
                "Datos ExtraÃ­dos del QR": { en: "Data Extracted from QR", zh: "ä»ŽäºŒç»´ç æå–çš„æ•°æ®", de: "Aus QR extrahierte Daten", fr: "DonnÃ©es extraites du QR" },
                "DÃ­as Fact:": { en: "Billed Days:", zh: "è®¡è´¹å¤©æ•°ï¼š", de: "Berechnete Tage:", fr: "Jours facturÃ©s :" },
                "Total": { en: "Total", zh: "æ€»è®¡", de: "Gesamt", fr: "Total" },
                "Factura:": { en: "Bill:", zh: "è´¦å•ï¼š", de: "Rechnung:", fr: "Facture :" },
                "AÃ‘ADIR A LA LISTA DE CUPS": { en: "ADD TO CUPS LIST", zh: "æ·»åŠ åˆ°CUPSåˆ—è¡¨", de: "ZUR CUPS-LISTE HINZUFÃœGEN", fr: "AJOUTER Ã€ LA LISTE CUPS" },
                "Comparar FIJO vs INDEXADO": { en: "Compare FIXED vs INDEXED", zh: "æ¯”è¾ƒå›ºå®šä¸ŽæŒ‡æ•°", de: "FEST vs INDEXIERT vergleichen", fr: "Comparer FIXE vs INDEXÃ‰" },
                "RESUMEN DE TODOS LOS SUMINISTROS": { en: "SUMMARY OF ALL SUPPLIES", zh: "æ‰€æœ‰ä¾›åº”æ‘˜è¦", de: "ZUSAMMENFASSUNG ALLER VERSORGUNGEN", fr: "RÃ‰SUMÃ‰ DE TOUS LES APPROVISIONNEMENTS" },
                "RESUMEN DE SUMINISTROS INCLUIDOS": { en: "SUMMARY OF INCLUDED SUPPLIES", zh: "åŒ…å«ä¾›åº”æ‘˜è¦", de: "ZUSAMMENFASSUNG DER ENTHALTENEN VERSORGUNGEN", fr: "RÃ‰SUMÃ‰ DES APPROVISIONNEMENTS INCLUS" },
                "LA MEJOR OPCIÃ“N PARA TI ES": { en: "THE BEST OPTION FOR YOU IS", zh: "æœ€é€‚åˆæ‚¨çš„é€‰é¡¹æ˜¯", de: "DIE BESTE OPTION FÃœR SIE IST", fr: "LA MEILLEURE OPTION POUR VOUS EST" },
                
                // Selector de tarifa DRK
                "Â¿QuÃ© tipo de tarifa DRK quieres ver?": { en: "What type of DRK rate do you want to see?", zh: "æ‚¨æƒ³æŸ¥çœ‹å“ªç§ç±»åž‹çš„DRKè´¹çŽ‡ï¼Ÿ", de: "Welchen DRK-Tariftyp mÃ¶chten Sie sehen?", fr: "Quel type de tarif DRK souhaitez-vous voir ?" },
                "ðŸŽ¯ Â¿QuÃ© tipo de tarifa DRK quieres ver?": { en: "ðŸŽ¯ What type of DRK rate do you want to see?", zh: "ðŸŽ¯ æ‚¨æƒ³æŸ¥çœ‹å“ªç§ç±»åž‹çš„DRKè´¹çŽ‡ï¼Ÿ", de: "ðŸŽ¯ Welchen DRK-Tariftyp mÃ¶chten Sie sehen?", fr: "ðŸŽ¯ Quel type de tarif DRK souhaitez-vous voir ?" },
                "Tarifa FIJA": { en: "FIXED Rate", zh: "å›ºå®šè´¹çŽ‡", de: "FESTPREIS-Tarif", fr: "Tarif FIXE" },
                "âš¡ Tarifa FIJA": { en: "âš¡ FIXED Rate", zh: "âš¡ å›ºå®šè´¹çŽ‡", de: "âš¡ FESTPREIS-Tarif", fr: "âš¡ Tarif FIXE" },
                "Precio fijo estable (excluye DRK INDEX)": { en: "Stable fixed price (excludes DRK INDEX)", zh: "ç¨³å®šå›ºå®šä»·æ ¼ï¼ˆä¸åŒ…æ‹¬DRK INDEXï¼‰", de: "Stabiler Festpreis (ohne DRK INDEX)", fr: "Prix fixe stable (exclut DRK INDEX)" },
                "Tarifa INDEXADA (DRK INDEX)": { en: "INDEXED Rate (DRK INDEX)", zh: "æŒ‡æ•°è´¹çŽ‡ï¼ˆDRK INDEXï¼‰", de: "INDEXIERTER Tarif (DRK INDEX)", fr: "Tarif INDEXÃ‰ (DRK INDEX)" },
                "ðŸŒ± Tarifa INDEXADA (DRK INDEX)": { en: "ðŸŒ± INDEXED Rate (DRK INDEX)", zh: "ðŸŒ± æŒ‡æ•°è´¹çŽ‡ï¼ˆDRK INDEXï¼‰", de: "ðŸŒ± INDEXIERTER Tarif (DRK INDEX)", fr: "ðŸŒ± Tarif INDEXÃ‰ (DRK INDEX)" },
                "Solo muestra DRK INDEX del mercado": { en: "Only shows market DRK INDEX", zh: "ä»…æ˜¾ç¤ºå¸‚åœºDRK INDEX", de: "Zeigt nur Markt-DRK INDEX", fr: "Affiche uniquement le DRK INDEX du marchÃ©" },
                "Continuar con esta opciÃ³n â†’": { en: "Continue with this option â†’", zh: "ç»§ç»­æ­¤é€‰é¡¹â†’", de: "Mit dieser Option fortfahren â†’", fr: "Continuer avec cette option â†’" },
                
                // DUAL
                "Gestiona mÃºltiples suministros de Electricidad y Gas": { en: "Manage multiple Electricity and Gas supplies", zh: "ç®¡ç†å¤šä¸ªç”µåŠ›å’Œå¤©ç„¶æ°”ä¾›åº”", de: "Verwalten Sie mehrere Strom- und Gasversorgungen", fr: "GÃ©rer plusieurs approvisionnements en Ã©lectricitÃ© et gaz" },
                "Suministros aÃ±adidos:": { en: "Supplies added:", zh: "å·²æ·»åŠ çš„ä¾›åº”ï¼š", de: "HinzugefÃ¼gte Versorgungen:", fr: "Approvisionnements ajoutÃ©s :" },
                "No hay suministros aÃ±adidos": { en: "No supplies added", zh: "æœªæ·»åŠ ä¾›åº”", de: "Keine Versorgungen hinzugefÃ¼gt", fr: "Aucun approvisionnement ajoutÃ©" },
                "+ AÃ±adir Suministro": { en: "+ Add Supply", zh: "+ æ·»åŠ ä¾›åº”", de: "+ Versorgung hinzufÃ¼gen", fr: "+ Ajouter un approvisionnement" },
                "Calcular Comparativa Global": { en: "Calculate Global Comparison", zh: "è®¡ç®—å…¨å±€æ¯”è¾ƒ", de: "Globalen Vergleich berechnen", fr: "Calculer la comparaison globale" },
                "Limpiar todo": { en: "Clear all", zh: "æ¸…é™¤å…¨éƒ¨", de: "Alles lÃ¶schen", fr: "Tout effacer" },
                
                // Textos del modal de decisiÃ³n
                "Consejo:": { en: "Advice:", zh: "å»ºè®®ï¼š", de: "Rat:", fr: "Conseil :" },
                "Si quieres ver rÃ¡pidamente la mejor oferta, elige la primera opciÃ³n. Si necesitas comparar varias opciones o el cliente tiene preferencias especÃ­ficas, elige la segunda.": { en: "If you want to quickly see the best offer, choose the first option. If you need to compare multiple options or the client has specific preferences, choose the second.", zh: "å¦‚æžœæ‚¨æƒ³å¿«é€ŸæŸ¥çœ‹æœ€ä½³ä¼˜æƒ ï¼Œè¯·é€‰æ‹©ç¬¬ä¸€ä¸ªé€‰é¡¹ã€‚å¦‚æžœæ‚¨éœ€è¦æ¯”è¾ƒå¤šä¸ªé€‰é¡¹æˆ–å®¢æˆ·æœ‰ç‰¹å®šåå¥½ï¼Œè¯·é€‰æ‹©ç¬¬äºŒä¸ªã€‚", de: "Wenn Sie schnell das beste Angebot sehen mÃ¶chten, wÃ¤hlen Sie die erste Option. Wenn Sie mehrere Optionen vergleichen mÃ¼ssen oder der Kunde spezifische PrÃ¤ferenzen hat, wÃ¤hlen Sie die zweite.", fr: "Si vous voulez voir rapidement la meilleure offre, choisissez la premiÃ¨re option. Si vous devez comparer plusieurs options ou si le client a des prÃ©fÃ©rences spÃ©cifiques, choisissez la seconde." },
                "âš¡ Comparar FIJO vs INDEXADO": { en: "âš¡ Compare FIXED vs INDEXED", zh: "âš¡ æ¯”è¾ƒå›ºå®šä¸ŽæŒ‡æ•°", de: "âš¡ FEST vs INDEXIERT vergleichen", fr: "âš¡ Comparer FIXE vs INDEXÃ‰" },
                "Genera comparativa dual: tarifa fija y tarifa indexada DRK INDEX (precio variable del mercado).": { en: "Generate dual comparison: fixed rate and DRK INDEX indexed rate (variable market price).", zh: "ç”ŸæˆåŒé‡æ¯”è¾ƒï¼šå›ºå®šè´¹çŽ‡å’ŒDRK INDEXæŒ‡æ•°è´¹çŽ‡ï¼ˆå¯å˜å¸‚åœºä»·æ ¼ï¼‰ã€‚", de: "Dual-Vergleich generieren: Festpreis und DRK INDEX indexierter Tarif (variabler Marktpreis).", fr: "GÃ©nÃ©rer une comparaison duale : tarif fixe et tarif indexÃ© DRK INDEX (prix variable du marchÃ©)." },
                
                // Modal de selecciÃ³n de ofertas
                "ðŸ“‹ SELECCIONA TU OFERTA": { en: "ðŸ“‹ SELECT YOUR OFFER", zh: "ðŸ“‹ é€‰æ‹©æ‚¨çš„æŠ¥ä»·", de: "ðŸ“‹ WÃ„HLEN SIE IHR ANGEBOT", fr: "ðŸ“‹ SÃ‰LECTIONNEZ VOTRE OFFRE" },
                "Hemos calculado todas las opciones con ahorro. Elige la que prefieras.": { en: "We have calculated all options with savings. Choose the one you prefer.", zh: "æˆ‘ä»¬å·²è®¡ç®—æ‰€æœ‰èŠ‚çœé€‰é¡¹ã€‚é€‰æ‹©æ‚¨å–œæ¬¢çš„ã€‚", de: "Wir haben alle Optionen mit Einsparungen berechnet. WÃ¤hlen Sie die, die Sie bevorzugen.", fr: "Nous avons calculÃ© toutes les options avec des Ã©conomies. Choisissez celle que vous prÃ©fÃ©rez." },
                "ðŸ“‹ DATOS DEL SUMINISTRO": { en: "ðŸ“‹ SUPPLY DATA", zh: "ðŸ“‹ ä¾›åº”æ•°æ®", de: "ðŸ“‹ VERSORGUNGSDATEN", fr: "ðŸ“‹ DONNÃ‰ES D'APPROVISIONNEMENT" },
                "ðŸ” BUSCAR POR NOMBRE": { en: "ðŸ” SEARCH BY NAME", zh: "ðŸ” æŒ‰åç§°æœç´¢", de: "ðŸ” NACH NAME SUCHEN", fr: "ðŸ” RECHERCHER PAR NOM" },
                "Escribe nombre de comercializadora...": { en: "Enter supplier name...", zh: "è¾“å…¥ä¾›åº”å•†åç§°...", de: "Lieferantenname eingeben...", fr: "Entrez le nom du fournisseur..." },
                "ðŸ“Š ORDENAR POR": { en: "ðŸ“Š SORT BY", zh: "ðŸ“Š æŽ’åºæ–¹å¼", de: "ðŸ“Š SORTIEREN NACH", fr: "ðŸ“Š TRIER PAR" },
                "ðŸ’° Mayor ahorro primero": { en: "ðŸ’° Highest savings first", zh: "ðŸ’° æœ€é«˜èŠ‚çœä¼˜å…ˆ", de: "ðŸ’° HÃ¶chste Einsparungen zuerst", fr: "ðŸ’° Ã‰conomies les plus Ã©levÃ©es en premier" },
                "ðŸ’¸ Menor ahorro primero": { en: "ðŸ’¸ Lowest savings first", zh: "ðŸ’¸ æœ€ä½ŽèŠ‚çœä¼˜å…ˆ", de: "ðŸ’¸ Niedrigste Einsparungen zuerst", fr: "ðŸ’¸ Ã‰conomies les plus faibles en premier" },
                "ðŸ”¤ Nombre (A-Z)": { en: "ðŸ”¤ Name (A-Z)", zh: "ðŸ”¤ åç§°ï¼ˆA-Zï¼‰", de: "ðŸ”¤ Name (A-Z)", fr: "ðŸ”¤ Nom (A-Z)" },
                "ðŸ”¤ Nombre (Z-A)": { en: "ðŸ”¤ Name (Z-A)", zh: "ðŸ”¤ åç§°ï¼ˆZ-Aï¼‰", de: "ðŸ”¤ Name (Z-A)", fr: "ðŸ”¤ Nom (Z-A)" },
                "de": { en: "of", zh: "çš„", de: "von", fr: "de" },
                "ofertas": { en: "offers", zh: "æŠ¥ä»·", de: "Angebote", fr: "offres" },
                "ðŸ”„ Limpiar filtros": { en: "ðŸ”„ Clear filters", zh: "ðŸ”„ æ¸…é™¤ç­›é€‰", de: "ðŸ”„ Filter lÃ¶schen", fr: "ðŸ”„ Effacer les filtres" },
                
                // Modal de pegado
                "Esperando Pegado (Ctrl+V)": { en: "Waiting for Paste (Ctrl+V)", zh: "ç­‰å¾…ç²˜è´´ï¼ˆCtrl+Vï¼‰", de: "Warten auf EinfÃ¼gen (Strg+V)", fr: "En attente de Coller (Ctrl+V)" },
                "Con el cuadro de texto invisible enfocado, pulse Ctrl+V (o Cmd+V) para pegar la imagen de la factura.": { en: "With the invisible text box focused, press Ctrl+V (or Cmd+V) to paste the invoice image.", zh: "åœ¨ä¸å¯è§æ–‡æœ¬æ¡†èšç„¦æ—¶ï¼ŒæŒ‰Ctrl+Vï¼ˆæˆ–Cmd+Vï¼‰ç²˜è´´å‘ç¥¨å›¾åƒã€‚", de: "DrÃ¼cken Sie bei fokussiertem unsichtbaren Textfeld Strg+V (oder Cmd+V), um das Rechnungsbild einzufÃ¼gen.", fr: "Avec la zone de texte invisible focalisÃ©e, appuyez sur Ctrl+V (ou Cmd+V) pour coller l'image de la facture." },
                "Continuar Pegando": { en: "Continue Pasting", zh: "ç»§ç»­ç²˜è´´", de: "Weiter einfÃ¼gen", fr: "Continuer Ã  coller" },
                "Cancelar Pegado": { en: "Cancel Paste", zh: "å–æ¶ˆç²˜è´´", de: "EinfÃ¼gen abbrechen", fr: "Annuler le Collage" },
                
                // Textos de tarjetas de resultados
                "Ahorro anual": { en: "Annual savings", zh: "å¹´åº¦èŠ‚çœ", de: "JÃ¤hrliche Einsparungen", fr: "Ã‰conomies annuelles" },
                "Resumen de suministros": { en: "Supplies summary", zh: "ä¾›åº”æ‘˜è¦", de: "Zusammenfassung der Versorgungen", fr: "RÃ©sumÃ© des approvisionnements" },
                "TÃ©rmino fijo": { en: "Fixed term", zh: "å›ºå®šæœŸé™", de: "Feste Laufzeit", fr: "Terme fixe" },
                "dÃ­as": { en: "days", zh: "å¤©", de: "Tage", fr: "jours" },
                "Imp. hidrocarburos": { en: "Hydrocarbon tax", zh: "ç¢³æ°¢åŒ–åˆç‰©ç¨Ž", de: "Kohlenwasserstoffsteuer", fr: "Taxe sur les hydrocarbures" },
                "TOTAL MENSUAL": { en: "MONTHLY TOTAL", zh: "æœˆåº¦æ€»è®¡", de: "MONAT GESAMT", fr: "TOTAL MENSUEL" },
                "Factura actual:": { en: "Current bill:", zh: "å½“å‰è´¦å•ï¼š", de: "Aktuelle Rechnung:", fr: "Facture actuelle :" },
                "Ahorro:": { en: "Savings:", zh: "èŠ‚çœï¼š", de: "Einsparungen:", fr: "Ã‰conomies :" },
                "/mes": { en: "/month", zh: "/æœˆ", de: "/Monat", fr: "/mois" },
                "/aÃ±o": { en: "/year", zh: "/å¹´", de: "/Jahr", fr: "/an" },
                "/Mes": { en: "/Month", zh: "/æœˆ", de: "/Monat", fr: "/Mois" },
                "/AÃ±o": { en: "/Year", zh: "/å¹´", de: "/Jahr", fr: "/An" },
                "â‚¬/mes": { en: "â‚¬/month", zh: "â‚¬/æœˆ", de: "â‚¬/Monat", fr: "â‚¬/mois" },
                "â‚¬/aÃ±o": { en: "â‚¬/year", zh: "â‚¬/å¹´", de: "â‚¬/Jahr", fr: "â‚¬/an" },
                "â‚¬/Mes": { en: "â‚¬/Month", zh: "â‚¬/æœˆ", de: "â‚¬/Monat", fr: "â‚¬/Mois" },
                "â‚¬/AÃ±o": { en: "â‚¬/Year", zh: "â‚¬/å¹´", de: "â‚¬/Jahr", fr: "â‚¬/An" },
                "TÃ©rmino fijo (": { en: "Fixed term (", zh: "å›ºå®šæœŸé™ï¼ˆ", de: "Feste Laufzeit (", fr: "Terme fixe (" },
                "Imp. elÃ©ctrico (5.113%)": { en: "Electricity tax (5.113%)", zh: "ç”µåŠ›ç¨Žï¼ˆ5.113%ï¼‰", de: "Stromsteuer (5.113%)", fr: "Taxe sur l'Ã©lectricitÃ© (5.113%)" },
                "TOTAL PERIODO": { en: "PERIOD TOTAL", zh: "æœŸé—´æ€»è®¡", de: "ZEITRAUM GESAMT", fr: "TOTAL PÃ‰RIODE" },
                
                // Botones y acciones
                "Cerrar": { en: "Close", zh: "å…³é—­", de: "SchlieÃŸen", fr: "Fermer" },
                "Comparar Indexada vs Fija": { en: "Compare Indexed vs Fixed", zh: "æ¯”è¾ƒæŒ‡æ•°ä¸Žå›ºå®š", de: "Indexiert vs. Fest vergleichen", fr: "Comparer IndexÃ© vs Fixe" },
                "Generar PDF": { en: "Generate PDF", zh: "ç”ŸæˆPDF", de: "PDF erstellen", fr: "GÃ©nÃ©rer PDF" },
                "Enviar Propuesta": { en: "Send Proposal", zh: "å‘é€ææ¡ˆ", de: "Vorschlag senden", fr: "Envoyer la Proposition" },
                "Ver Detalles": { en: "View Details", zh: "æŸ¥çœ‹è¯¦æƒ…", de: "Details anzeigen", fr: "Voir les DÃ©tails" },
                "Solicitar Mejora": { en: "Request Improvement", zh: "è¯·æ±‚æ”¹è¿›", de: "Verbesserung anfordern", fr: "Demander une AmÃ©lioration" },
                "Copiar DiseÃ±o": { en: "Copy Design", zh: "å¤åˆ¶è®¾è®¡", de: "Design kopieren", fr: "Copier le Design" },
                "âœ… Â¡Copiado! Pega en tu email": { en: "âœ… Copied! Paste in your email", zh: "âœ… å·²å¤åˆ¶ï¼ç²˜è´´åˆ°é‚®ä»¶", de: "âœ… Kopiert! In E-Mail einfÃ¼gen", fr: "âœ… CopiÃ© ! Coller dans votre email" },
                
                // Mensajes de estado
                "Por favor espere.": { en: "Please wait.", zh: "è¯·ç¨å€™ã€‚", de: "Bitte warten.", fr: "Veuillez patienter." },
                "Procesando...": { en: "Processing...", zh: "å¤„ç†ä¸­...", de: "Verarbeitung...", fr: "Traitement en cours..." },
                "Generando...": { en: "Generating...", zh: "ç”Ÿæˆä¸­...", de: "Erstellen...", fr: "GÃ©nÃ©ration..." },
                
                // Datos ExtraÃ­dos
                "Periodo": { en: "Period", zh: "æœŸé—´", de: "Zeitraum", fr: "PÃ©riode" },
                "dÃ­as": { en: "days", zh: "å¤©", de: "Tage", fr: "jours" },
                "dÃ­a": { en: "day", zh: "æ—¥", de: "Tag", fr: "jour" },
                "DÃ­a": { en: "Day", zh: "æ—¥", de: "Tag", fr: "Jour" },
                "Fechas": { en: "Dates", zh: "æ—¥æœŸ", de: "Daten", fr: "Dates" },
                "Consumo por Periodo (kWh)": { en: "Consumption per Period (kWh)", zh: "æœŸé—´æ¶ˆè€— (kWh)", de: "Verbrauch pro Zeitraum (kWh)", fr: "Consommation par PÃ©riode (kWh)" },
                "Total Consumo": { en: "Total Consumption", zh: "æ€»æ¶ˆè€—", de: "Gesamtverbrauch", fr: "Consommation Totale" },
                "Potencia Contratada (kW)": { en: "Contracted Power (kW)", zh: "ç­¾çº¦åŠŸçŽ‡ (kW)", de: "Vertragsleistung (kW)", fr: "Puissance ContractÃ©e (kW)" },
                
                // Interfaz de resultados
                "Datos ExtraÃ­dos": { en: "Extracted Data", zh: "æå–æ•°æ®", de: "Extrahierte Daten", fr: "DonnÃ©es Extraites" },
                "Precios Ofertas": { en: "Offer Prices", zh: "æŠ¥ä»·ä»·æ ¼", de: "Angebotspreise", fr: "Prix des Offres" },
                "CÃ¡lculo Oficial": { en: "Official Calculation", zh: "å®˜æ–¹è®¡ç®—", de: "Offizielle Berechnung", fr: "Calcul Officiel" },
                "SimulaciÃ³n": { en: "Simulation", zh: "æ¨¡æ‹Ÿ", de: "Simulation", fr: "Simulation" },
                "Subtotal Potencia": { en: "Power Subtotal", zh: "åŠŸçŽ‡å°è®¡", de: "Leistung Zwischensumme", fr: "Sous-total Puissance" },
                "Precios de la Oferta Consolidada": { en: "Consolidated Offer Prices", zh: "åˆå¹¶æŠ¥ä»·ä»·æ ¼", de: "Konsolidierte Angebotspreise", fr: "Prix de l'Offre ConsolidÃ©e" },
                "Tarifa": { en: "Tariff", zh: "èµ„è´¹", de: "Tarif", fr: "Tarif" },
                "Punta": { en: "Peak", zh: "å³°å€¼", de: "Spitze", fr: "Pointe" },
                "Llano": { en: "Flat", zh: "å¹³æ®µ", de: "Flach", fr: "Plat" },
                "Valle": { en: "Valley", zh: "è°·æ®µ", de: "Tal", fr: "VallÃ©e" },
                "Los precios mostrados son de la oferta ganadora.": { en: "The prices shown are from the winning offer.", zh: "æ˜¾ç¤ºçš„ä»·æ ¼æ¥è‡ªä¸­æ ‡æŠ¥ä»·ã€‚", de: "Die angezeigten Preise stammen aus dem gewinnenden Angebot.", fr: "Les prix affichÃ©s proviennent de l'offre gagnante." },
                
                // Botones estÃ¡ndar (para traducciÃ³n automÃ¡tica)
                "Aceptar": { en: "Accept", zh: "æŽ¥å—", de: "Akzeptieren", fr: "Accepter" },
                "Guardar": { en: "Save", zh: "ä¿å­˜", de: "Speichern", fr: "Sauvegarder" },
                "Eliminar": { en: "Delete", zh: "åˆ é™¤", de: "LÃ¶schen", fr: "Supprimer" },
                "Editar": { en: "Edit", zh: "ç¼–è¾‘", de: "Bearbeiten", fr: "Modifier" },
                "Modificar": { en: "Modify", zh: "ä¿®æ”¹", de: "Ã„ndern", fr: "Modifier" },
                "Actualizar": { en: "Update", zh: "æ›´æ–°", de: "Aktualisieren", fr: "Mettre Ã  jour" },
                "Enviar": { en: "Send", zh: "å‘é€", de: "Senden", fr: "Envoyer" },
                "Generar": { en: "Generate", zh: "ç”Ÿæˆ", de: "Erstellen", fr: "GÃ©nÃ©rer" },
                "Ver": { en: "View", zh: "æŸ¥çœ‹", de: "Anzeigen", fr: "Voir" },
                "Calcular": { en: "Calculate", zh: "è®¡ç®—", de: "Berechnen", fr: "Calculer" },
                "Comparar": { en: "Compare", zh: "æ¯”è¾ƒ", de: "Vergleichen", fr: "Comparer" },
                "AÃ±adir": { en: "Add", zh: "æ·»åŠ ", de: "HinzufÃ¼gen", fr: "Ajouter" },
                
                // Botones de acciÃ³n especÃ­ficos
                "â† Volver": { en: "â† Back", zh: "â† è¿”å›ž", de: "â† ZurÃ¼ck", fr: "â† Retour" },
                "Generar Comparativa â†’": { en: "Generate Comparison â†’", zh: "ç”Ÿæˆæ¯”è¾ƒ â†’", de: "Vergleich erstellen â†’", fr: "GÃ©nÃ©rer la Comparaison â†’" },
                "SOLICITAR MEJORA A DRK": { en: "REQUEST IMPROVEMENT FROM DRK", zh: "å‘DRKè¯·æ±‚æ”¹è¿›", de: "VERBESSERUNG VON DRK ANFORDERN", fr: "DEMANDER UNE AMÃ‰LIORATION Ã€ DRK" },
                "Solicitar Mejora a DRK": { en: "Request Improvement from DRK", zh: "å‘DRKè¯·æ±‚æ”¹è¿›", de: "Verbesserung von DRK anfordern", fr: "Demander une AmÃ©lioration Ã  DRK" },
                "Ver desglose detallado del cÃ¡lculo": { en: "View detailed calculation breakdown", zh: "æŸ¥çœ‹è¯¦ç»†è®¡ç®—æ˜Žç»†", de: "Detaillierte BerechnungsaufschlÃ¼sselung anzeigen", fr: "Voir la rÃ©partition dÃ©taillÃ©e du calcul" }
            };

            let lang = localStorage.getItem('appLanguage') || 'es';

            // FunciÃ³n para traducir
            function tr(text) {
                if (!TR[text] || !TR[text][lang]) return text;
                return TR[text][lang];
            }
            
            // Hacer tr() global
            window.tr = tr;
            
            // CRÃTICO: Interceptor global de jsPDF para traducir automÃ¡ticamente
            // NUEVO: Sugerir cambiar idioma para generar PDF
            window.suggestLanguageChangeForPDF = function() {
                const currentLang = localStorage.getItem('appLanguage') || 'es';
                if (currentLang === 'zh') {
                    const message = 'ðŸ’¡ å¿«é€Ÿè§£å†³æ–¹æ¡ˆ (Quick Solution)\n\n' +
                        '1. ç‚¹å‡»å³ä¸Šè§’åˆ‡æ¢åˆ°è‹±è¯­ ðŸ‡¬ðŸ‡§\n' +
                        '   Click top-right to switch to English ðŸ‡¬ðŸ‡§\n\n' +
                        '2. ç”ŸæˆPDF\n' +
                        '   Generate PDF\n\n' +
                        '3. å¦‚éœ€è¦ï¼Œå†åˆ‡æ¢å›žä¸­æ–‡\n' +
                        '   Switch back to Chinese if needed\n\n' +
                        'æ•°å­—å’Œè®¡ç®—ç»“æžœå°†ç›¸åŒã€‚\n' +
                        'Numbers and calculations will be the same.';
                    
                    alert(message);
                }
            };
            
            // NUEVO: Mostrar advertencia antes de generar PDF en chino
            window.showChinesePDFWarning = function() {
                const currentLang = localStorage.getItem('appLanguage') || 'es';
                if (currentLang === 'zh') {
                    // Mostrar mensaje informativo (no preguntar, directamente hacer el cambio)
                    alert(
                        'ðŸ‡¨ðŸ‡³ ç”ŸæˆPDFæ–‡ä»¶ä¸­...\n' +
                        'ä¸ºäº†ç¡®ä¿å­—ç¬¦æ­£ç¡®æ˜¾ç¤ºï¼ŒPDFå°†ä½¿ç”¨è‹±è¯­ç”Ÿæˆã€‚\n\n' +
                        'ðŸ‡¬ðŸ‡§ Generating PDF...\n' +
                        'To ensure correct character display, the PDF will be generated in English.\n\n' +
                        'âœ… è®¡ç®—ç»“æžœå°†ä¿æŒä¸å˜\n' +
                        'âœ… Calculations will remain the same'
                    );
                    
                    // IMPORTANTE: Marcar que el usuario estaba en chino
                    window._wasChineseBeforePDF = true;
                    
                    // Cambiar automÃ¡ticamente a inglÃ©s SIN recargar
                    if (window.LANG && window.LANG.change) {
                        window.LANG.change('en', true); // skipReload = true
                    }
                    
                    return true; // PERMITIR generaciÃ³n de PDF en inglÃ©s
                }
                window._wasChineseBeforePDF = false; // No estaba en chino
                return true; // Para otros idiomas, continuar sin advertencia
            };
            
            window.setupPDFTranslation = function(doc) {
                if (!doc || !doc.text) return doc;
                
                // NOTA: PDFs en chino estÃ¡n bloqueados por showChinesePDFWarning()
                // No intentamos configurar fuentes chinas porque no funcionan sin fuente completa CJK
                
                const originalText = doc.text.bind(doc);
                
                doc.text = function(text, x, y, options) {
                    // Traducir solo strings, no objetos ni arrays
                    if (typeof text === 'string' && window.tr) {
                        // Lista EXHAUSTIVA de patrones a buscar y reemplazar
                        const patterns = [
                            // TÃTULOS PRINCIPALES
                            'DESGLOSE DETALLADO DE LA SIMULACIÃ“N',
                            'ESTUDIO DE AHORRO',
                            'COMPARATIVA PROFESIONAL',
                            'TU AHORRO ANUAL ESTIMADO ES:',
                            'TU FACTURA ACTUAL',
                            'TU NUEVO COSTE DRK',
                            'TU NUEVO COSTE POWER CUP',
                            
                            // MULTICUPS
                            'Datos Generales',
                            'Potencias (kW)',
                            'EnergÃ­a (kWh)',
                            'Consumos (kWh)',
                            'Total Consumo',
                            'Hogar/Negocio',
                            'Industria/Gran Consumo',
                            'Acumulado',
                            'TOTAL ENERGY',
                            'Datos Acumulados',
                            
                            // TÃ‰RMINOS TÃ‰CNICOS
                            'TÃ‰RMINO POTENCIA (Precio en â‚¬/kW DÃ­a)',
                            'TÃ‰RMINO POTENCIA',
                            'TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)',
                            'TÃ‰RMINO ENERGÃA',
                            'Precio en â‚¬/kW DÃ­a',
                            'Precios en â‚¬/kWh',
                            
                            // PERÃODOS
                            'E1 - Punta',
                            'E2 - Llano', 
                            'E3 - Valle',
                            'E4 - Supervalle',
                            'E5 - Punta',
                            'E6 - Valle',
                            'Punta',
                            'Llano',
                            'Valle',
                            'Supervalle',
                            
                            // SUBTOTALES Y TOTALES
                            'Subtotal EnergÃ­a (Bruto)',
                            'Subtotal EnergÃ­a (Neto)',
                            'SUBTOTAL POTENCIA',
                            'POWER SUBTOTAL',
                            'SUBTOTAL BASE (P+E)',
                            'BASE IMPONIBLE',
                            'TAXABLE BASE',
                            
                            // IMPUESTOS
                            'Imp. ElÃ©c.',
                            'IVA (21%)',
                            'VAT (21%)',
                            'Imp. Hidrocarburos',
                            
                            // TOTALES
                            'TOTAL FACTURA (60 DÃAS)',
                            'TOTAL FACTURA (30 DÃAS)',
                            'TOTAL FACTURA',
                            'TOTAL AÃ‘O (PROYECTADO)',
                            'TOTAL YEAR (PROJECTED)',
                            'Total Periodo',
                            'Estimado Mensual',
                            
                            // CLIENTE
                            'CLIENTE:',
                            'COMERCIAL:',
                            'CUPS:',
                            'CUPS TOTALES:',
                            'TARIFA:',
                            
                            // OTROS
                            'Liderando el ahorro y la',
                            'eficiencia energÃ©tica.',
                            'AsesorÃ­a EnergÃ©tica',
                            'PRECIOS DE LA OFERTA:',
                            'PARA FORMALIZAR ESTE CONTRATO:',
                            
                            // GAS
                            'TÃ‰RMINO FIJO:',
                            'ENERGÃA:',
                            'POTENCIA:',
                            'TÃ‰RMINO FIJO (Precio en â‚¬/dÃ­a)',
                            'Precio fijo diario (â‚¬/dÃ­a):',
                            'Precio energÃ­a (â‚¬/kWh):',
                            
                            // UNIDADES TEMPORALES (MUY IMPORTANTE)
                            'â‚¬/mes',
                            'â‚¬/aÃ±o',
                            '/mes',
                            '/aÃ±o',
                            'â‚¬/Mes',
                            'â‚¬/AÃ±o',
                            '/Mes',
                            '/AÃ±o',
                            
                            // Secciones del PDF (sin dos puntos)
                            'POTENCIA',
                            'ENERGÃA',
                            'RESUMEN DE',
                            'SUMINISTROS',
                            'RESUMEN DE TODOS LOS SUMINISTROS',
                            'RESUMEN DE SUMINISTROS INCLUIDOS',
                            'LA MEJOR OPCIÃ“N PARA TI ES'
                        ];
                        
                        let translated = text;
                        let hasChange = false;
                        
                        // Buscar y reemplazar cada patrÃ³n
                        patterns.forEach(pattern => {
                            if (translated.includes(pattern)) {
                                const translatedPattern = window.tr(pattern);
                                if (translatedPattern !== pattern) {
                                    translated = translated.replace(new RegExp(pattern.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), translatedPattern);
                                    hasChange = true;
                                    console.log(`ðŸ“ PDF Pattern: "${pattern}" â†’ "${translatedPattern}"`);
                                }
                            }
                        });
                        
                        // TambiÃ©n intentar traducir el texto completo
                        const fullTranslation = window.tr(text);
                        if (fullTranslation !== text) {
                            console.log(`ðŸ“ PDF Full: "${text}" â†’ "${fullTranslation}"`);
                            text = fullTranslation;
                        } else if (hasChange) {
                            text = translated;
                        }
                    }
                    return originalText(text, x, y, options);
                };
                
                return doc;
            };
            
            // FunciÃ³n para traducir TODO el HTML generado (usado antes de crear PDFs)
            window.translateHTML = function(html) {
                if (!html) return html;
                
                const currentLang = localStorage.getItem('appLanguage') || 'es';
                console.log('ðŸŒ translateHTML called with language:', currentLang);
                
                if (currentLang === 'es') {
                    console.log('âœ… Language is Spanish, no translation needed');
                    return html; // No need to translate if already in Spanish
                }
                
                // Lista exhaustiva de textos a traducir con TODAS las variantes
                const replacements = [
                    // MULTICUPS - Interfaz
                    ['AÃ±adir Suministro', tr('AÃ±adir Suministro')],
                    ['Datos Generales', tr('Datos Generales')],
                    ['NÃºmero CUPS', tr('NÃºmero CUPS')],
                    ['DÃ­as Facturados', tr('DÃ­as Facturados')],
                    ['Potencias (kW)', tr('Potencias (kW)')],
                    ['EnergÃ­a (kWh)', tr('EnergÃ­a (kWh)')],
                    ['Total Factura (â‚¬)', tr('Total Factura (â‚¬)')],
                    ['AÃ‘ADIR SUMINISTRO MANUAL', tr('AÃ‘ADIR SUMINISTRO MANUAL')],
                    ['AÃ‘ADIR SUMINISTRO', tr('AÃ‘ADIR SUMINISTRO')],
                    ['Cancelar', tr('Cancelar')],
                    
                    // Modal de confirmaciÃ³n QR
                    ['Confirmar Suministro MultiCups', tr('Confirmar Suministro MultiCups')],
                    ['Revisa los datos extraÃ­dos del QR antes de aÃ±adir este suministro a la lista.', tr('Revisa los datos extraÃ­dos del QR antes de aÃ±adir este suministro a la lista.')],
                    ['Datos ExtraÃ­dos del QR', tr('Datos ExtraÃ­dos del QR')],
                    ['DÃ­as Fact:', tr('DÃ­as Fact:')],
                    ['Total Factura:', tr('Total') + ' ' + tr('Factura:')],
                    ['AÃ‘ADIR A LA LISTA DE CUPS', tr('AÃ‘ADIR A LA LISTA DE CUPS')],
                    ['RESUMEN DE', tr('RESUMEN DE')],
                    ['SUMINISTROS', tr('SUMINISTROS')],
                    ['RESUMEN DE TODOS LOS SUMINISTROS', tr('RESUMEN DE TODOS LOS SUMINISTROS')],
                    
                    // Modales
                    ['CÃ¡lculo Completado', tr('CÃ¡lculo Completado')],
                    ['Comparar FIJO vs INDEXADO', tr('Comparar FIJO vs INDEXADO')],
                    ['SEE BEST OPTION', tr('SEE BEST OPTION')],
                    ['CHOOSE FROM RESULTS', tr('CHOOSE FROM RESULTS')],
                    ['Suministro AÃ±adido', tr('Suministro AÃ±adido')],
                    ['Understood', tr('Understood')],
                    
                    // MULTICUPS selecciÃ³n
                    ['Volver a selecciÃ³n', tr('Volver a selecciÃ³n')],
                    ['MULTICUPS', tr('MULTICUPS')],
                    ['Selecciona el tipo de contrato que deseas aÃ±adir.', tr('Selecciona el tipo de contrato que deseas aÃ±adir.')],
                    ['Total de suministros actuales:', tr('Total de suministros actuales:')],
                    ['Permite EscÃ¡ner QR, Imagen y Entrada Manual', tr('Permite EscÃ¡ner QR, Imagen y Entrada Manual')],
                    ['Solo Entrada de Datos Manual', tr('Solo Entrada de Datos Manual')],
                    ['FINALIZAR Y COMPARAR', tr('FINALIZAR Y COMPARAR')],
                    ['Suministros', tr('Suministros')],
                    
                    // Datos Acumulados
                    ['Datos Acumulados', tr('Datos Acumulados')],
                    ['TOTAL ENERGY', tr('TOTAL ENERGY')],
                    ['Hogar/Negocio', tr('Hogar/Negocio')],
                    ['Industria/Gran Consumo', tr('Industria/Gran Consumo')],
                    ['Consumos (kWh)', tr('Consumos (kWh)')],
                    ['Acumulado', tr('Acumulado')],
                    ['Total Consumo', tr('Total Consumo')],
                    
                    // Secciones del PDF (sin dos puntos para evitar conflictos)
                    ['POTENCIA', tr('POTENCIA')],
                    ['ENERGÃA', tr('ENERGÃA')],
                    ['Punta', tr('Punta')],
                    ['Llano', tr('Llano')],
                    ['Valle', tr('Valle')],
                    
                    // GAS - Interfaz
                    ['Selection mode:', tr('Selection mode:')],
                    ['Best rates', tr('Best rates')],
                    ['Elegir entre resultados', tr('Elegir entre resultados')],
                    ['Selecciona manualmente las tarifas que deseas comparar.', tr('Selecciona manualmente las tarifas que deseas comparar.')],
                    ['Ver tarifas disponibles', tr('Ver tarifas disponibles')],
                    ['Selecciona las tarifas a comparar:', tr('Selecciona las tarifas a comparar:')],
                    ['Selecciona una o mÃ¡s tarifas para comparar.', tr('Selecciona una o mÃ¡s tarifas para comparar.')],
                    ['ðŸ” Buscar comercializadora:', tr('ðŸ” Buscar comercializadora:')],
                    ['Ordenar por:', tr('Ordenar por:')],
                    ['ðŸ’° Mayor ahorro primero', tr('ðŸ’° Mayor ahorro primero')],
                    ['ðŸ”» Menor ahorro primero', tr('ðŸ”» Menor ahorro primero')],
                    ['ðŸ“‹ Por nombre', tr('ðŸ“‹ Por nombre')],
                    ['Calcular tarifas seleccionadas', tr('Calcular tarifas seleccionadas')],
                    
                    // Variaciones con parÃ©ntesis (CRÃTICAS para PDFs)
                    ['TÃ‰RMINO POTENCIA (Precio en â‚¬/kW DÃ­a)', tr('TÃ‰RMINO POTENCIA (Precio en â‚¬/kW DÃ­a)')],
                    ['TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)', tr('TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)')],
                    ['TOTAL FACTURA (60 DÃAS)', tr('TOTAL FACTURA (60 DÃAS)')],
                    ['Liderando el ahorro y la', tr('Liderando el ahorro y la')],
                    
                    // GAS - Resultados
                    ['Fixed term (30 days)', tr('Fixed term (30 days)')],
                    ['EnergÃ­a (500 kWh)', tr('EnergÃ­a (500 kWh)')],
                    ['Hydrocarbon tax', tr('Hydrocarbon tax')],
                    ['Your current bill:', tr('Your current bill:')],
                    ['With this rate:', tr('With this rate:')],
                    ['Monthly savings:', tr('Monthly savings:')],
                    ['Annual savings:', tr('Annual savings:')],
                    
                    // GAS - PDF
                    ['SAVINGS STUDY', tr('SAVINGS STUDY')],
                    ['COMPARATIVA PROFESIONAL GAS - DRK', tr('COMPARATIVA PROFESIONAL GAS - DRK')],
                    ['TARIFA:', tr('TARIFA:')],
                    ['TÃ‰RMINO FIJO:', tr('TÃ‰RMINO FIJO:')],
                    ['ENERGÃA:', tr('ENERGÃA:')],
                    ['Precio fijo diario (â‚¬/dÃ­a):', tr('Precio fijo diario (â‚¬/dÃ­a):')],
                    ['Precio energÃ­a (â‚¬/kWh):', tr('Precio energÃ­a (â‚¬/kWh):')],
                    ['TÃ‰RMINO FIJO (Precio en â‚¬/dÃ­a)', tr('TÃ‰RMINO FIJO (Precio en â‚¬/dÃ­a)')],
                    ['TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)', tr('TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)')],
                    ['Subtotal EnergÃ­a (Bruto)', tr('Subtotal EnergÃ­a (Bruto)')],
                    ['Imp. Hidrocarburos', tr('Imp. Hidrocarburos')],
                    ['TOTAL FACTURA (30 DÃAS)', tr('TOTAL FACTURA (30 DÃAS)')],
                    ['Precio fijo', tr('Precio fijo')],
                    
                    // Encabezados - TODAS las variantes
                    ['DESGLOSE DETALLADO DE LA SIMULACIÃ“N', tr('DESGLOSE DETALLADO DE LA SIMULACIÃ“N')],
                    ['TU AHORRO ANUAL ESTIMADO ES:', tr('TU AHORRO ANUAL ESTIMADO ES:')],
                    ['LA MEJOR OPCIÃ“N PARA TI ES', tr('LA MEJOR OPCIÃ“N PARA TI ES')],
                    ['TU FACTURA ACTUAL', tr('TU FACTURA ACTUAL')],
                    ['TU NUEVO COSTE DRK', tr('TU NUEVO COSTE DRK')],
                    ['TU NUEVO COSTE POWER CUP', tr('TU NUEVO COSTE POWER CUP')],
                    ['TU AHORRO ANUAL ESTIMADO', tr('TU AHORRO ANUAL ESTIMADO')],
                    ['TU AHORRO ANUAL FIJO', tr('TU AHORRO ANUAL FIJO')],
                    ['TU AHORRO ANUAL INDEXADO', tr('TU AHORRO ANUAL INDEXADO')],
                    
                    // Headers
                    ['ESTUDIO DE AHORRO', tr('ESTUDIO DE AHORRO')],
                    ['COMPARATIVA PROFESIONAL', tr('COMPARATIVA PROFESIONAL')],
                    ['COMPARATIVA', tr('COMPARATIVA')],
                    ['PROFESIONAL', tr('PROFESIONAL')],
                    ['Liderando el ahorro y la eficiencia energÃ©tica.', tr('Liderando el ahorro y la eficiencia energÃ©tica.')],
                    ['eficiencia energÃ©tica.', tr('eficiencia energÃ©tica.')],
                    ['AsesorÃ­a EnergÃ©tica', tr('AsesorÃ­a EnergÃ©tica')],
                    ['Ofrece el mayor ahorro consolidado con', tr('Ofrece el mayor ahorro consolidado con')],
                    
                    // Cliente
                    ['CLIENTE:', tr('CLIENTE:')],
                    ['CUPS:', tr('CUPS:')],
                    ['COMERCIAL:', tr('COMERCIAL:')],
                    ['CUPS TOTALES:', tr('CUPS TOTALES:')],
                    ['[NOMBRE COMPLETO CLIENTE]', tr('[NOMBRE COMPLETO CLIENTE]')],
                    
                    // TÃ©rminos - MUY IMPORTANTE
                    ['TÃ‰RMINO POTENCIA (Precio en â‚¬/kW DÃ­a)', tr('TÃ‰RMINO POTENCIA (Precio en â‚¬/kW DÃ­a)')],
                    ['TÃ‰RMINO POTENCIA', tr('TÃ‰RMINO POTENCIA')],
                    ['TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)', tr('TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)')],
                    ['TÃ‰RMINO ENERGÃA', tr('TÃ‰RMINO ENERGÃA')],
                    ['POTENCIA:', tr('POTENCIA:')],
                    ['ENERGIA:', tr('ENERGIA:')],
                    ['Precio en â‚¬/kW DÃ­a', tr('Precio en â‚¬/kW DÃ­a')],
                    ['Precios en â‚¬/kWh', tr('Precios en â‚¬/kWh')],
                    
                    // PerÃ­odos especÃ­ficos
                    ['E1 - Punta', tr('E1 - Punta')],
                    ['E2 - Llano', tr('E2 - Llano')],
                    ['E3 - Valle', tr('E3 - Valle')],
                    ['Punta', tr('Punta')],
                    ['Llano', tr('Llano')],
                    ['Valle', tr('Valle')],
                    
                    // Subtotales - CRÃTICOS
                    ['SUBTOTAL POTENCIA', tr('SUBTOTAL POTENCIA')],
                    ['POWER SUBTOTAL', tr('SUBTOTAL POTENCIA')],
                    ['SUBTOTAL BASE (P+E)', tr('SUBTOTAL BASE (P+E)')],
                    ['BASE IMPONIBLE', tr('BASE IMPONIBLE')],
                    ['TAXABLE BASE', tr('BASE IMPONIBLE')],
                    ['Subtotal EnergÃ­a (Bruto)', tr('Subtotal EnergÃ­a (Bruto)')],
                    ['Subtotal EnergÃ­a (Neto)', tr('Subtotal EnergÃ­a (Neto)')],
                    
                    // Impuestos
                    ['Imp. ElÃ©c.', tr('Imp. ElÃ©c.')],
                    ['IVA (21%)', tr('IVA (21%)')],
                    ['VAT (21%)', tr('IVA (21%)')],
                    
                    // Totales - MUY IMPORTANTES
                    ['TOTAL FACTURA (60 DÃAS)', tr('TOTAL FACTURA') + ' (60 ' + tr('DÃAS') + ')'],
                    ['TOTAL FACTURA', tr('TOTAL FACTURA')],
                    ['TOTAL AÃ‘O (PROYECTADO)', tr('TOTAL AÃ‘O (PROYECTADO)')],
                    ['TOTAL YEAR (PROJECTED)', tr('TOTAL AÃ‘O (PROYECTADO)')],
                    ['Total Periodo', tr('Total Periodo')],
                    ['Estimado Mensual', tr('Estimado Mensual')],
                    
                    // GAS especÃ­fico
                    ['Resultados GAS', tr('Resultados GAS')],
                    ['Comparativa de tarifas', tr('Comparativa de tarifas')],
                    ['TÃ©rmino fijo', tr('TÃ©rmino fijo')],
                    ['TÃ©rmino fijo:', tr('TÃ©rmino fijo:')],
                    ['Impuesto hidrocarburos', tr('Impuesto hidrocarburos')],
                    
                    // DocumentaciÃ³n
                    ['PARA FORMALIZAR ESTE CONTRATO:', tr('PARA FORMALIZAR ESTE CONTRATO:')],
                    ['Responde a este email adjuntando la siguiente documentacion:', tr('Responde a este email adjuntando la siguiente documentacion:')],
                    ['Responde a este email adjuntando la documentacion de los', tr('Responde a este email adjuntando la documentacion de los')],
                    ['Este resumen es una simulacion', tr('Este resumen es una simulacion')],
                    ['basada en su ultima factura', tr('basada en su ultima factura')],
                    ['consolidada de', tr('consolidada de')],
                    ['suministros', tr('suministros')],
                    ['Colaborador:', tr('Colaborador:')],
                    
                    // Ofertas
                    ['PRECIOS DE LA OFERTA:', tr('PRECIOS DE LA OFERTA:')],
                    ['DESGLOSE DETALLADO DE LA SIMULACIÃ“N', tr('DESGLOSE DETALLADO DE LA SIMULACIÃ“N')],
                    ['DESGLOSE DETALLADO', tr('DESGLOSE DETALLADO')]
                ];
                
                // Aplicar reemplazos
                let result = html;
                let replacedCount = 0;
                
                replacements.forEach(([original, translated]) => {
                    if (original && translated && original !== translated) {
                        const escaped = original.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        const regex = new RegExp(escaped, 'gi'); // Case insensitive
                        const matches = result.match(regex);
                        if (matches) {
                            result = result.replace(regex, translated);
                            replacedCount += matches.length;
                            console.log(`âœ… Replaced "${original}" â†’ "${translated}" (${matches.length} times)`);
                        }
                    }
                });
                
                // Traducir unidades al final (para evitar conflictos)
                const unitReplacements = [
                    [' dÃ­as)', ' ' + tr('dÃ­as') + ')'],
                    [' DÃAS)', ' ' + tr('DÃAS') + ')'],
                    ['â‚¬/mes', tr('â‚¬/mes')],
                    ['â‚¬/aÃ±o', tr('â‚¬/aÃ±o')],
                    ['â‚¬/Mes', tr('â‚¬/Mes')],
                    ['â‚¬/AÃ±o', tr('â‚¬/AÃ±o')],
                    ['/mes', tr('/mes')],
                    ['/aÃ±o', tr('/aÃ±o')],
                    ['/Mes', tr('/Mes')],
                    ['/AÃ±o', tr('/AÃ±o')]
                ];
                
                unitReplacements.forEach(([original, translated]) => {
                    if (original && translated && original !== translated) {
                        const escaped = original.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        const regex = new RegExp(escaped, 'g');
                        result = result.replace(regex, translated);
                    }
                });
                
                console.log(`ðŸŽ‰ Total replacements made: ${replacedCount}`);
                return result;
            };

            // FunciÃ³n exhaustiva de traducciÃ³n
            function translateAll() {
                // Navbar
                const accentEl = document.getElementById('app-logo-accent');
                if (accentEl) accentEl.textContent = tr('EnergÃ­a');
                const subtitleEl = document.getElementById('app-subtitle');
                if (subtitleEl) subtitleEl.textContent = tr('Selector');

                // Traducir elementos especÃ­ficos por ID
                const elementIds = [
                    'inicio-title', 'inicio-subtitle', 'inicio-supply-label',
                    'landing-title', 'savings-label', 'gas-results-subtitle', 'gas-regulation-subtitle',
                    'qr-analyzing-title', 'qr-progress-label', 'qr-help-text',
                    'multicups-datos-generales', 'multicups-potencias', 'multicups-energia',
                    'qr-confirm-title', 'qr-confirm-subtitle', 'confirm-save-supply-btn',
                    'finalize-btn-text', 'finalize-suministros-text',
                    'tariff-selector-title', 'tarifa-fija-title', 'tarifa-fija-desc',
                    'tarifa-indexada-title', 'tarifa-indexada-desc', 'tariff-selector-continue-btn',
                    'dual-title', 'dual-subtitle', 'dual-supplies-label',
                    'dual-add-btn', 'dual-calculate-btn', 'dual-reset-btn',
                    'advice-label', 'advice-content',
                    'compare-fijo-indexado-title', 'compare-fijo-indexado-desc',
                    'offer-selection-title', 'offer-selection-subtitle', 'datos-suministro-label',
                    'buscar-nombre-label', 'ordenar-por-label', 'offers-de-text', 'offers-text',
                    'limpiar-filtros-btn', 'cancel-manual-input-btn',
                    'back-offer-selection-btn', 'confirm-offer-selection-btn',
                    'gas-request-improvement-text', 'dual-request-improvement-text', 'request-improvement-text',
                    'calculation-complete-title', 'calculation-complete-subtitle',
                    'details-toggle-text', 'reset-button-text'
                ];
                
                elementIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el && el.textContent.trim()) {
                        const original = el.textContent.trim();
                        const translated = tr(original);
                        if (translated !== original) {
                            el.textContent = translated;
                        }
                    }
                });

                // Traducir TODO el DOM por contenido
                const walker = document.createTreeWalker(
                    document.body,
                    NodeFilter.SHOW_TEXT,
                    null,
                    false
                );

                let node;
                const nodesToTranslate = [];
                
                while (node = walker.nextNode()) {
                    const trimmed = node.textContent.trim();
                    if (trimmed && TR[trimmed]) {
                        nodesToTranslate.push({node, original: trimmed});
                    }
                }

                // Traducir todos los nodos encontrados
                nodesToTranslate.forEach(({node, original}) => {
                    const newText = tr(original);
                    if (node.textContent.includes(original)) {
                        node.textContent = node.textContent.replace(original, newText);
                    }
                });
                
                // CRÃTICO: Traducir placeholders
                const searchInput = document.getElementById('offer-search-input');
                if (searchInput) {
                    searchInput.placeholder = tr('Escribe nombre de comercializadora...');
                }
                
                // CRÃTICO: Traducir placeholders del modal Request Improvement
                const modalInputs = [
                    { id: 'improvement-comercial-code', text: 'CÃ“DIGO COMERCIAL (Obligatorio)' },
                    { id: 'improvement-client-name', text: 'Nombre Cliente' },
                    { id: 'improvement-client-cups', text: 'CUPS' },
                    { id: 'improvement-client-phone', text: 'TelÃ©fono' },
                    { id: 'improvement-client-email', text: 'Email' },
                    { id: 'improvement-observations', text: 'Observaciones (opcional)' }
                ];
                modalInputs.forEach(({id, text}) => {
                    const el = document.getElementById(id);
                    if (el) el.placeholder = tr(text);
                });
                
                // CRÃTICO: Traducir opciones del select de ordenaciÃ³n
                const sortSelect = document.getElementById('offer-sort-select');
                if (sortSelect) {
                    const options = sortSelect.querySelectorAll('option');
                    options.forEach(option => {
                        const originalText = option.textContent.trim();
                        option.textContent = tr(originalText);
                    });
                }
                
                // CRÃTICO: Traducir TODOS los botones con textos estÃ¡ndar
                const allButtons = document.querySelectorAll('button');
                allButtons.forEach(button => {
                    const text = button.textContent.trim();
                    // Lista completa de textos de botones a traducir
                    const buttonTexts = [
                        'Cancelar', 'Cerrar', 'Aceptar', 'Continuar', 'Guardar', 'Eliminar',
                        'Editar', 'Modificar', 'Actualizar', 'Enviar', 'Generar', 'Ver',
                        'Calcular', 'Comparar', 'AÃ±adir', 'â† Volver', 'Generar Comparativa â†’',
                        'SOLICITAR MEJORA A DRK', 'Solicitar Mejora a DRK',
                        'Ver desglose detallado del cÃ¡lculo'
                    ];
                    
                    if (buttonTexts.includes(text)) {
                        button.textContent = tr(text);
                    }
                });
            }
            
            // CRÃTICO: Hacer translateAll disponible globalmente
            window.translateAll = translateAll;

            // API global
            window.LANG = {
                change: function(newLang, skipReload = false) {
                    const oldLang = lang;
                    lang = newLang;
                    localStorage.setItem('appLanguage', newLang);
                    
                    // Solo recargar si es un cambio manual del usuario (no la carga inicial)
                    if (!skipReload && oldLang !== newLang) {
                        console.log(`ðŸ”„ Cambiando idioma de ${oldLang} a ${newLang} - Recargando pÃ¡gina...`);
                        location.reload();
                        return;
                    }
                    
                    // Si es carga inicial, solo actualizar la UI
                    if (document.getElementById('language-selector')) {
                        document.getElementById('language-selector').value = newLang;
                    }
                    document.title = tr('DRK COMPARADOR');
                    translateAll();
                },
                translate: tr,
                retranslate: translateAll,
                getCurrentLang: function() { return lang; }
            };

            // Interceptar navegaciÃ³n
            const funcsToIntercept = ['hideAllScreens', 'goToInicio', 'goToElectricidad', 'goToGas', 'goToDual', 
                                       'selectTariffType', 'showOfferDecisionModal', 'showDualResults'];
            
            funcsToIntercept.forEach(funcName => {
                const original = window[funcName];
                if (original) {
                    window[funcName] = function() {
                        const result = original.apply(this, arguments);
                        setTimeout(() => window.LANG.retranslate(), 100);
                        return result;
                    };
                }
            });

            // MutationObserver
            const observer = new MutationObserver((mutations) => {
                const hasChanges = mutations.some(m => m.addedNodes.length > 0 || m.type === 'childList');
                if (hasChanges) {
                    setTimeout(() => window.LANG.retranslate(), 50);
                }
            });

            const appEl = document.getElementById('app');
            if (appEl) {
                observer.observe(appEl, {childList: true, subtree: true});
            }

            // Inicializar
            window.addEventListener('DOMContentLoaded', () => {
                const savedLang = localStorage.getItem('appLanguage') || 'es';
                window.LANG.change(savedLang, true); // skipReload = true para carga inicial
            });

            window.addEventListener('load', () => {
                setTimeout(() => window.LANG.retranslate(), 200);
            });
        })();
        
        // FunciÃ³n para hacer scroll en los tabs con las flechas
        function scrollTabs(direction) {
            const container = document.getElementById('tabs-container');
            if (!container) return;
            
            const scrollAmount = 200; // Pixeles a desplazar
            
            if (direction === 'left') {
                container.scrollBy({
                    left: -scrollAmount,
                    behavior: 'smooth'
                });
            } else if (direction === 'right') {
                container.scrollBy({
                    left: scrollAmount,
                    behavior: 'smooth'
                });
            }
        }
    </script>
</body>
