<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lector QR Avanzado para Facturas</title>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .app-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #e9ecef;
        }

        .panel h2 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel h2 i {
            color: #667eea;
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .button:active {
            transform: translateY(0);
        }

        .button.secondary {
            background: #6c757d;
        }

        .button.success {
            background: #28a745;
        }

        .button.danger {
            background: #dc3545;
        }

        .button:disabled {
            background: #adb5bd;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .video-container {
            position: relative;
            width: 100%;
            height: 400px;
            border-radius: 10px;
            overflow: hidden;
            background: #000;
            margin: 20px 0;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .scan-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 70%;
            border: 3px solid #00ff00;
            border-radius: 10px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
        }

        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: #00ff00;
            animation: scan 2s linear infinite;
        }

        @keyframes scan {
            0% { top: 0; }
            50% { top: calc(100% - 3px); }
            100% { top: 0; }
        }

        .image-container {
            width: 100%;
            max-height: 400px;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            border: 3px dashed #dee2e6;
            position: relative;
        }

        #capturedImage {
            width: 100%;
            height: auto;
            display: block;
        }

        .crop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        .crop-box {
            position: absolute;
            border: 2px solid #ff0000;
            background: rgba(255, 0, 0, 0.1);
            z-index: 10;
        }

        .result-container {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-top: 30px;
            border-left: 5px solid #667eea;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .result-header h3 {
            color: #333;
            font-size: 22px;
        }

        .qr-data {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.5;
        }

        .qr-data pre {
            margin: 0;
        }

        .data-type {
            display: inline-block;
            padding: 5px 15px;
            background: #e9ecef;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 10px;
            color: #495057;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        .controls button {
            flex: 1;
            min-width: 150px;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .processing {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }

        .zoom-btn {
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 5px;
            cursor: pointer;
            font-size: 20px;
        }

        input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Lector Avanzado QR Facturas</h1>
            <p>Captura fotos y lee c√≥digos QR de cualquier tama√±o y calidad</p>
        </div>

        <div class="app-container">
            <!-- Panel izquierdo: Captura -->
            <div class="panel">
                <h2>üì∏ Captura de Imagen</h2>
                
                <div class="controls">
                    <button class="button" id="startCamera">
                        <span>üé•</span> Abrir C√°mara
                    </button>
                    <div class="file-input-wrapper">
                        <button class="button secondary">
                            <span>üìÅ</span> Subir Imagen
                        </button>
                        <input type="file" id="fileInput" accept="image/*, .jpg, .jpeg, .png, .bmp, .gif">
                    </div>
                </div>

                <div class="video-container hidden" id="videoContainer">
                    <video id="video" autoplay playsinline></video>
                    <div class="camera-overlay">
                        <div class="scan-area">
                            <div class="scan-line"></div>
                        </div>
                    </div>
                    <div class="zoom-controls">
                        <button class="zoom-btn" onclick="adjustZoom(-0.1)">-</button>
                        <button class="zoom-btn" onclick="adjustZoom(0.1)">+</button>
                    </div>
                </div>

                <div class="image-container hidden" id="imageContainer">
                    <img id="capturedImage" alt="Imagen capturada">
                    <div class="crop-overlay" id="cropOverlay"></div>
                </div>

                <div class="controls">
                    <button class="button success" id="captureBtn" disabled>
                        <span>üì∑</span> Tomar Foto
                    </button>
                    <button class="button" id="cropBtn" disabled>
                        <span>‚úÇÔ∏è</span> Recortar √Årea
                    </button>
                    <button class="button danger" id="cancelBtn">
                        <span>‚ùå</span> Cancelar
                    </button>
                </div>

                <div class="status info" id="status">
                    Haz clic en "Abrir C√°mara" para comenzar
                </div>

                <div class="processing hidden" id="processing">
                    <div class="spinner"></div>
                    <p>Procesando imagen...</p>
                </div>
            </div>

            <!-- Panel derecho: Resultados -->
            <div class="panel">
                <h2>üìä Resultados</h2>
                
                <div class="result-container">
                    <div class="result-header">
                        <h3>Datos del QR</h3>
                        <div>
                            <span class="data-type" id="dataType">Esperando...</span>
                        </div>
                    </div>
                    
                    <div class="qr-data" id="qrData">
                        Los datos del c√≥digo QR aparecer√°n aqu√≠
                    </div>
                    
                    <div class="controls">
                        <button class="button" onclick="copyToClipboard()">
                            <span>üìã</span> Copiar
                        </button>
                        <button class="button secondary" onclick="saveAsFile()">
                            <span>üíæ</span> Guardar
                        </button>
                        <button class="button success" onclick="processQR()">
                            <span>üîç</span> Leer QR
                        </button>
                    </div>
                </div>

                <div class="status hidden" id="resultStatus"></div>

                <div style="margin-top: 30px;">
                    <h2>‚öôÔ∏è Configuraci√≥n</h2>
                    <div style="margin-top: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                            üîß Modo de procesamiento:
                        </label>
                        <select id="processingMode" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #dee2e6;">
                            <option value="auto">Autom√°tico (Recomendado)</option>
                            <option value="enhanced">Mejorado (M√°s lento, m√°s preciso)</option>
                            <option value="fast">R√°pido (Para QR grandes y claros)</option>
                        </select>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                            üéØ Intentos de decodificaci√≥n:
                        </label>
                        <input type="range" id="attemptsSlider" min="1" max="5" value="3">
                        <span id="attemptsValue">3 intentos</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let stream = null;
        let video = document.getElementById('video');
        let capturedImage = document.getElementById('capturedImage');
        let cropBox = null;
        let isCropping = false;
        let cropStart = {x: 0, y: 0};
        let cropEnd = {x: 0, y: 0};
        let canvas = document.createElement('canvas');
        let context = canvas.getContext('2d');
        let currentZoom = 1;
        let codeReader = null;

        // Elementos del DOM
        const videoContainer = document.getElementById('videoContainer');
        const imageContainer = document.getElementById('imageContainer');
        const captureBtn = document.getElementById('captureBtn');
        const cropBtn = document.getElementById('cropBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const statusDiv = document.getElementById('status');
        const processingDiv = document.getElementById('processing');
        const qrDataDiv = document.getElementById('qrData');
        const dataTypeSpan = document.getElementById('dataType');
        const resultStatusDiv = document.getElementById('resultStatus');
        const fileInput = document.getElementById('fileInput');
        const attemptsSlider = document.getElementById('attemptsSlider');
        const attemptsValue = document.getElementById('attemptsValue');

        // Inicializar ZXing
        function initZXing() {
            const { BrowserQRCodeReader, BrowserMultiFormatReader } = window.ZXing;
            codeReader = new BrowserMultiFormatReader();
        }

        // Iniciar c√°mara
        async function startCamera() {
            try {
                showStatus('Iniciando c√°mara...', 'info');
                
                // Detener stream anterior si existe
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                // Solicitar permisos de c√°mara
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        zoom: { ideal: 1 }
                    },
                    audio: false
                });
                
                video.srcObject = stream;
                videoContainer.classList.remove('hidden');
                imageContainer.classList.add('hidden');
                captureBtn.disabled = false;
                cropBtn.disabled = true;
                
                showStatus('C√°mara lista. Enfoca el c√≥digo QR y haz clic en "Tomar Foto"', 'success');
                
            } catch (error) {
                console.error('Error al acceder a la c√°mara:', error);
                showStatus(`Error: ${error.message}. Aseg√∫rate de permitir el acceso a la c√°mara.`, 'error');
            }
        }

        // Tomar foto
        function capturePhoto() {
            if (!stream) return;
            
            // Configurar canvas con dimensiones del video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Dibujar el frame actual
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convertir a Data URL y mostrar
            capturedImage.src = canvas.toDataURL('image/jpeg', 0.9);
            
            // Cambiar vistas
            videoContainer.classList.add('hidden');
            imageContainer.classList.remove('hidden');
            cropBtn.disabled = false;
            
            // Detener c√°mara
            stream.getTracks().forEach(track => track.stop());
            stream = null;
            
            showStatus('Foto capturada. Puedes recortar el √°rea del QR si es necesario.', 'success');
            
            // Procesar autom√°ticamente despu√©s de 1 segundo
            setTimeout(processQR, 1000);
        }

        // Iniciar modo recorte
        function startCrop() {
            if (isCropping) {
                endCrop();
                return;
            }
            
            isCropping = true;
            const cropOverlay = document.getElementById('cropOverlay');
            cropOverlay.innerHTML = '';
            cropOverlay.style.cursor = 'crosshair';
            
            // Crear cuadro de recorte
            cropBox = document.createElement('div');
            cropBox.className = 'crop-box';
            cropOverlay.appendChild(cropBox);
            
            // Eventos para el recorte
            cropOverlay.onmousedown = startCropDrag;
            cropOverlay.onmousemove = dragCrop;
            cropOverlay.onmouseup = endCropDrag;
            
            // Para touch
            cropOverlay.ontouchstart = startCropDrag;
            cropOverlay.ontouchmove = dragCrop;
            cropOverlay.ontouchend = endCropDrag;
            
            cropBtn.innerHTML = '<span>‚úÖ</span> Finalizar Recorte';
            showStatus('Arrastra para seleccionar el √°rea del QR. Suelta para finalizar.', 'info');
        }

        // Iniciar arrastre para recorte
        function startCropDrag(e) {
            if (!isCropping) return;
            
            const rect = capturedImage.getBoundingClientRect();
            const x = e.clientX || e.touches[0].clientX;
            const y = e.clientY || e.touches[0].clientY;
            
            cropStart.x = x - rect.left;
            cropStart.y = y - rect.top;
            
            cropEnd.x = cropStart.x;
            cropEnd.y = cropStart.y;
            
            updateCropBox();
        }

        // Arrastrar para recorte
        function dragCrop(e) {
            if (!isCropping || !cropStart.x) return;
            
            const rect = capturedImage.getBoundingClientRect();
            const x = e.clientX || e.touches[0].clientX;
            const y = e.clientY || e.touches[0].clientY;
            
            cropEnd.x = Math.max(0, Math.min(x - rect.left, rect.width));
            cropEnd.y = Math.max(0, Math.min(y - rect.top, rect.height));
            
            updateCropBox();
        }

        // Finalizar arrastre
        function endCropDrag() {
            // Solo actualizamos el cuadro
        }

        // Actualizar cuadro de recorte
        function updateCropBox() {
            if (!cropBox) return;
            
            const left = Math.min(cropStart.x, cropEnd.x);
            const top = Math.min(cropStart.y, cropEnd.y);
            const width = Math.abs(cropEnd.x - cropStart.x);
            const height = Math.abs(cropEnd.y - cropStart.y);
            
            cropBox.style.left = left + 'px';
            cropBox.style.top = top + 'px';
            cropBox.style.width = width + 'px';
            cropBox.style.height = height + 'px';
        }

        // Finalizar recorte
        function endCrop() {
            isCropping = false;
            const cropOverlay = document.getElementById('cropOverlay');
            cropOverlay.style.cursor = 'default';
            cropOverlay.onmousedown = null;
            cropOverlay.onmousemove = null;
            cropOverlay.onmouseup = null;
            
            cropBtn.innerHTML = '<span>‚úÇÔ∏è</span> Recortar √Årea';
            showStatus('√Årea seleccionada. Haz clic en "Leer QR" para procesar.', 'success');
        }

        // Procesar QR
        async function processQR() {
            if (!capturedImage.src) {
                showResultStatus('No hay imagen para procesar', 'error');
                return;
            }
            
            showProcessing(true);
            showResultStatus('Procesando c√≥digo QR...', 'info');
            
            try {
                // Crear imagen para procesar
                const img = new Image();
                img.src = capturedImage.src;
                
                await new Promise((resolve) => {
                    img.onload = resolve;
                });
                
                // Si hay recorte, aplicar
                let processingCanvas = canvas;
                let processingContext = context;
                
                if (cropBox && cropStart.x !== cropEnd.x && cropStart.y !== cropEnd.y) {
                    const rect = capturedImage.getBoundingClientRect();
                    const scaleX = img.width / rect.width;
                    const scaleY = img.height / rect.height;
                    
                    const sx = Math.min(cropStart.x, cropEnd.x) * scaleX;
                    const sy = Math.min(cropStart.y, cropEnd.y) * scaleY;
                    const sWidth = Math.abs(cropEnd.x - cropStart.x) * scaleX;
                    const sHeight = Math.abs(cropEnd.y - cropStart.y) * scaleY;
                    
                    // Crear canvas para el recorte
                    const cropCanvas = document.createElement('canvas');
                    cropCanvas.width = sWidth;
                    cropCanvas.height = sHeight;
                    const cropContext = cropCanvas.getContext('2d');
                    
                    cropContext.drawImage(
                        img,
                        sx, sy, sWidth, sHeight,
                        0, 0, sWidth, sHeight
                    );
                    
                    processingCanvas = cropCanvas;
                    processingContext = cropContext;
                } else {
                    processingCanvas.width = img.width;
                    processingCanvas.height = img.height;
                    processingContext.drawImage(img, 0, 0);
                }
                
                // Obtener datos de la imagen
                const imageData = processingContext.getImageData(
                    0, 0, 
                    processingCanvas.width, 
                    processingCanvas.height
                );
                
                // Intentar m√∫ltiples procesamientos
                const attempts = parseInt(attemptsSlider.value);
                const processingMode = document.getElementById('processingMode').value;
                
                let result = null;
                
                for (let i = 0; i < attempts; i++) {
                    try {
                        // Procesar con diferentes configuraciones
                        const processedImage = preprocessImage(imageData, i, processingMode);
                        
                        // Decodificar con ZXing
                        const luminanceSource = new window.ZXing.BrowserLuminanceSource(
                            processedImage, 
                            processedImage.width, 
                            processedImage.height
                        );
                        const binaryBitmap = new window.ZXing.BinaryBitmap(
                            new window.ZXing.HybridBinarizer(luminanceSource)
                        );
                        
                        const hints = new Map();
                        hints.set(window.ZXing.DecodeHintType.POSSIBLE_FORMATS, [
                            window.ZXing.BarcodeFormat.QR_CODE,
                            window.ZXing.BarcodeFormat.DATA_MATRIX,
                            window.ZXing.BarcodeFormat.PDF_417
                        ]);
                        hints.set(window.ZXing.DecodeHintType.TRY_HARDER, true);
                        
                        const reader = new window.ZXing.MultiFormatReader();
                        result = reader.decode(binaryBitmap, hints);
                        
                        if (result) break;
                        
                    } catch (err) {
                        // Continuar con el siguiente intento
                        console.log(`Intento ${i+1} fallado:`, err.message);
                    }
                }
                
                if (result) {
                    displayResult(result.getText());
                    showResultStatus(`‚úÖ QR detectado correctamente (${attempts} intento${attempts > 1 ? 's' : ''})`, 'success');
                } else {
                    // √öltimo intento: convertir a blanco y negro puro
                    try {
                        const binaryImage = convertToBinary(imageData);
                        const luminanceSource = new window.ZXing.BrowserLuminanceSource(
                            binaryImage, 
                            imageData.width, 
                            imageData.height
                        );
                        const binaryBitmap = new window.ZXing.BinaryBitmap(
                            new window.ZXing.HybridBinarizer(luminanceSource)
                        );
                        
                        const reader = new window.ZXing.MultiFormatReader();
                        result = reader.decode(binaryBitmap);
                        
                        if (result) {
                            displayResult(result.getText());
                            showResultStatus('‚úÖ QR detectado (modo binario)', 'success');
                        } else {
                            throw new Error('No se pudo detectar el QR');
                        }
                    } catch (err) {
                        showResultStatus('‚ùå No se pudo detectar ning√∫n c√≥digo QR en la imagen', 'error');
                        qrDataDiv.innerHTML = `
                            <div style="text-align: center; padding: 20px;">
                                <p style="color: #dc3545; margin-bottom: 15px;">No se detect√≥ QR</p>
                                <p style="color: #666; font-size: 14px;">
                                    Sugerencias:<br>
                                    1. Aseg√∫rate de que el QR est√© bien enfocado<br>
                                    2. Intenta recortar solo el √°rea del QR<br>
                                    3. Prueba con mejor iluminaci√≥n<br>
                                    4. Verifica que el QR no est√© da√±ado
                                </p>
                            </div>
                        `;
                        dataTypeSpan.textContent = 'No detectado';
                    }
                }
                
            } catch (error) {
                console.error('Error en el procesamiento:', error);
                showResultStatus(`Error: ${error.message}`, 'error');
            } finally {
                showProcessing(false);
            }
        }

        // Preprocesamiento de imagen
        function preprocessImage(imageData, attempt, mode) {
            const width = imageData.width;
            const height = imageData.height;
            const data = imageData.data;
            const output = new Uint8ClampedArray(data.length);
            
            // Diferentes estrategias seg√∫n el modo y el intento
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                let luminance;
                
                switch(mode) {
                    case 'fast':
                        // M√©todo r√°pido
                        luminance = 0.299 * r + 0.587 * g + 0.114 * b;
                        break;
                        
                    case 'enhanced':
                        // M√©todo mejorado con contraste ajustado por intento
                        const contrast = 1 + (attempt * 0.3);
                        const avg = (r + g + b) / 3;
                        luminance = Math.min(255, Math.max(0, (avg - 128) * contrast + 128));
                        break;
                        
                    default: // auto
                        // M√©todo adaptativo
                        if (attempt === 0) {
                            luminance = 0.299 * r + 0.587 * g + 0.114 * b;
                        } else if (attempt === 1) {
                            luminance = 0.2126 * r + 0.7152 * g + 0.0722 * b;
                        } else {
                            luminance = (Math.max(r, g, b) + Math.min(r, g, b)) / 2;
                        }
                }
                
                output[i] = luminance;
                output[i + 1] = luminance;
                output[i + 2] = luminance;
                output[i + 3] = 255;
            }
            
            return output;
        }

        // Convertir a imagen binaria (blanco y negro puro)
        function convertToBinary(imageData) {
            const width = imageData.width;
            const height = imageData.height;
            const data = imageData.data;
            const output = new Uint8ClampedArray(data.length);
            
            // Calcular umbral autom√°tico (m√©todo de Otsu simplificado)
            let histogram = new Array(256).fill(0);
            for (let i = 0; i < data.length; i += 4) {
                const luminance = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                histogram[Math.floor(luminance)]++;
            }
            
            // Encontrar umbral (simplificado)
            let total = histogram.reduce((a, b) => a + b, 0);
            let sum = 0;
            for (let i = 0; i < 256; i++) sum += i * histogram[i];
            
            let sumB = 0;
            let wB = 0;
            let wF = 0;
            let maxVariance = 0;
            let threshold = 0;
            
            for (let i = 0; i < 256; i++) {
                wB += histogram[i];
                if (wB === 0) continue;
                
                wF = total - wB;
                if (wF === 0) break;
                
                sumB += i * histogram[i];
                
                let mB = sumB / wB;
                let mF = (sum - sumB) / wF;
                
                let variance = wB * wF * (mB - mF) * (mB - mF);
                
                if (variance > maxVariance) {
                    maxVariance = variance;
                    threshold = i;
                }
            }
            
            // Aplicar umbral
            for (let i = 0; i < data.length; i += 4) {
                const luminance = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                const value = luminance > threshold ? 255 : 0;
                
                output[i] = value;
                output[i + 1] = value;
                output[i + 2] = value;
                output[i + 3] = 255;
            }
            
            return output;
        }

        // Mostrar resultado
        function displayResult(text) {
            // Determinar tipo de datos
            let dataType = 'Texto';
            let formattedText = text;
            
            if (text.startsWith('http://') || text.startsWith('https://')) {
                dataType = 'URL';
                formattedText = `<a href="${text}" target="_blank">${text}</a>`;
            } else if (text.includes('<?xml') || text.includes('<cfdi:')) {
                dataType = 'XML (Factura)';
                formattedText = formatXML(text);
            } else if (text.trim().startsWith('{') || text.trim().startsWith('[')) {
                try {
                    dataType = 'JSON';
                    const json = JSON.parse(text);
                    formattedText = syntaxHighlight(JSON.stringify(json, null, 2));
                } catch (e) {
                    formattedText = text;
                }
            } else if (text.includes('|') && text.split('|').length >= 5) {
                dataType = 'Datos estructurados';
                formattedText = formatStructuredData(text);
            }
            
            dataTypeSpan.textContent = dataType;
            
            // Mostrar datos
            qrDataDiv.innerHTML = `
                <pre style="margin: 0; font-family: 'Courier New', monospace;">${formattedText}</pre>
                <div style="margin-top: 15px; font-size: 12px; color: #666;">
                    <strong>Longitud:</strong> ${text.length} caracteres<br>
                    <strong>Procesado:</strong> ${new Date().toLocaleString()}
                </div>
            `;
            
            // Guardar en localStorage para persistencia
            try {
                const history = JSON.parse(localStorage.getItem('qrHistory') || '[]');
                history.unshift({
                    text: text,
                    type: dataType,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('qrHistory', JSON.stringify(history.slice(0, 10)));
            } catch (e) {
                console.log('No se pudo guardar en historial');
            }
        }

        // Formatear XML
        function formatXML(xml) {
            return xml
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\n/g, '<br>')
                .replace(/  /g, ' &nbsp;')
                .replace(/(&lt;[^&]+&gt;)/g, '<span style="color: #d73a49;">$1</span>');
        }

        // Resaltar sintaxis JSON
        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, 
            function (match) {
                let cls = 'number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'key';
                    } else {
                        cls = 'string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'boolean';
                } else if (/null/.test(match)) {
                    cls = 'null';
                }
                return `<span style="color: ${cls === 'string' ? '#032f62' : cls === 'number' ? '#005cc5' : cls === 'boolean' ? '#6f42c1' : '#d73a49'}">${match}</span>`;
            });
        }

        // Formatear datos estructurados
        function formatStructuredData(text) {
            const parts = text.split('|');
            let html = '';
            parts.forEach((part, index) => {
                html += `<div><strong>[${index + 1}]</strong> ${part}</div>`;
            });
            return html;
        }

        // Ajustar zoom
        function adjustZoom(delta) {
            currentZoom = Math.max(0.1, Math.min(3, currentZoom + delta));
            video.style.transform = `scale(${currentZoom})`;
            video.style.transformOrigin = 'center center';
        }

        // Mostrar/ocultar procesamiento
        function showProcessing(show) {
            if (show) {
                processingDiv.classList.remove('hidden');
            } else {
                processingDiv.classList.add('hidden');
            }
        }

        // Mostrar estado
        function showStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // Mostrar estado del resultado
        function showResultStatus(message, type = 'info') {
            resultStatusDiv.textContent = message;
            resultStatusDiv.className = `status ${type}`;
            resultStatusDiv.classList.remove('hidden');
        }

        // Copiar al portapapeles
        async function copyToClipboard() {
            try {
                const text = qrDataDiv.innerText;
                await navigator.clipboard.writeText(text);
                showResultStatus('‚úÖ Datos copiados al portapapeles', 'success');
                
                // Feedback visual
                const originalColor = dataTypeSpan.style.color;
                dataTypeSpan.style.color = '#28a745';
                setTimeout(() => {
                    dataTypeSpan.style.color = originalColor;
                }, 1000);
            } catch (err) {
                showResultStatus('‚ùå Error al copiar', 'error');
            }
        }

        // Guardar como archivo
        function saveAsFile() {
            const text = qrDataDiv.innerText;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `qr-data-${new Date().getTime()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showResultStatus('‚úÖ Datos guardados como archivo', 'success');
        }

        // Manejar subida de archivo
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                showStatus('Por favor, selecciona un archivo de imagen', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                capturedImage.src = event.target.result;
                videoContainer.classList.add('hidden');
                imageContainer.classList.remove('hidden');
                captureBtn.disabled = true;
                cropBtn.disabled = false;
                showStatus('Imagen cargada. Puedes recortar si es necesario.', 'success');
                
                // Detener c√°mara si estaba activa
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                
                // Procesar autom√°ticamente despu√©s de 1 segundo
                setTimeout(processQR, 1000);
            };
            reader.readAsDataURL(file);
        });

        // Cancelar y reiniciar
        function cancelAll() {
            // Detener c√°mara
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            // Ocultar todo
            videoContainer.classList.add('hidden');
            imageContainer.classList.add('hidden');
            
            // Reiniciar botones
            captureBtn.disabled = true;
            cropBtn.disabled = true;
            
            // Limpiar imagen
            capturedImage.src = '';
            
            showStatus('Operaci√≥n cancelada. Haz clic en "Abrir C√°mara" para comenzar.', 'info');
        }

        // Event Listeners
        document.getElementById('startCamera').addEventListener('click', startCamera);
        captureBtn.addEventListener('click', capturePhoto);
        cropBtn.addEventListener('click', startCrop);
        cancelBtn.addEventListener('click', cancelAll);

        // Actualizar valor del slider
        attemptsSlider.addEventListener('input', function() {
            attemptsValue.textContent = `${this.value} intento${this.value > 1 ? 's' : ''}`;
        });

        // Inicializar al cargar
        window.addEventListener('load', () => {
            initZXing();
            showStatus('Listo para capturar y leer c√≥digos QR', 'info');
            
            // Verificar compatibilidad
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showStatus('Tu navegador no soporta acceso a la c√°mara', 'error');
                document.getElementById('startCamera').disabled = true;
            }
            
            // Cargar historial si existe
            try {
                const history = JSON.parse(localStorage.getItem('qrHistory') || '[]');
                if (history.length > 0) {
                    console.log(`${history.length} c√≥digos QR en historial`);
                }
            } catch (e) {
                // Ignorar error
            }
        });

        // Prevenir p√©rdida de datos al recargar
        window.addEventListener('beforeunload', (e) => {
            if (capturedImage.src) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
