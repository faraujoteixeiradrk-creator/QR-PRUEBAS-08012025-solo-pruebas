<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Scanner Industrial Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        body {
            background-color: #020617;
            margin: 0;
            overflow: hidden;
            font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
        }
        #video-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: black;
        }
        canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* HUD Superior */
        #hud-top {
            position: absolute;
            top: env(safe-area-inset-top, 20px);
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 60;
        }
        /* Guía de enfoque industrial */
        #scanner-gui {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 280px;
            height: 280px;
            z-index: 20;
            pointer-events: none;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .corner {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 5px solid #3b82f6;
        }
        .tl { top: 0; left: 0; border-right: 0; border-bottom: 0; border-radius: 20px 0 0 0; }
        .tr { top: 0; right: 0; border-left: 0; border-bottom: 0; border-radius: 0 20px 0 0; }
        .bl { bottom: 0; left: 0; border-right: 0; border-top: 0; border-radius: 0 0 0 20px; }
        .br { bottom: 0; right: 0; border-left: 0; border-top: 0; border-radius: 0 0 20px 0; }

        .scan-line {
            position: absolute;
            left: 10%;
            width: 80%;
            height: 2px;
            background: #3b82f6;
            box-shadow: 0 0 15px 2px #3b82f6;
            animation: moveScan 2s infinite ease-in-out;
            opacity: 0.7;
        }

        @keyframes moveScan {
            0%, 100% { top: 15%; }
            50% { top: 85%; }
        }

        /* Overlay de detección */
        .detected #scanner-gui .corner {
            border-color: #22c55e;
            filter: drop-shadow(0 0 10px #22c55e);
        }
        .detected .scan-line { background: #22c55e; box-shadow: 0 0 15px 2px #22c55e; }

        #result-card {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%) translateY(150%);
            width: 90%;
            max-width: 450px;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 32px;
            padding: 24px;
            color: white;
            z-index: 100;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #result-card.active { transform: translateX(-50%) translateY(0); }

        .btn-icon {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>

    <div id="video-container">
        <video id="video" playsinline style="display:none"></video>
        <canvas id="canvas"></canvas>
        
        <div id="hud-top">
            <div class="flex flex-col">
                <span class="text-[10px] font-bold uppercase tracking-[0.2em] text-blue-400">Scanner Engine</span>
                <span id="status-label" class="text-white text-sm font-medium">Buscando QR...</span>
            </div>
            <button id="torch-btn" class="btn-icon active:scale-90 transition-transform hidden">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
            </button>
        </div>
        
        <!-- Guía Central -->
        <div id="scanner-gui">
            <div class="corner tl"></div><div class="corner tr"></div>
            <div class="corner bl"></div><div class="corner br"></div>
            <div class="scan-line"></div>
        </div>

        <div id="loading" class="absolute inset-0 flex items-center justify-center bg-slate-950 z-[200]">
            <div class="text-center">
                <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-blue-400 font-mono text-xs tracking-widest uppercase">Initializing Optic AI</p>
            </div>
        </div>

        <!-- Resultados -->
        <div id="result-card">
            <div class="flex items-center gap-4 mb-5">
                <div class="bg-green-500 w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg shadow-green-500/20">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                </div>
                <div>
                    <h3 class="font-bold text-lg leading-tight">Captura Exitosa</h3>
                    <p class="text-slate-400 text-xs uppercase tracking-tighter">Procesado localmente</p>
                </div>
            </div>
            
            <div class="bg-white/5 p-4 rounded-2xl mb-6 border border-white/10">
                <p id="result-text" class="text-sm font-medium break-all text-blue-100"></p>
            </div>

            <div class="flex gap-3">
                <button onclick="copyData()" class="flex-[1] bg-slate-800 py-4 rounded-2xl font-bold active:scale-95 transition-all">Copiar</button>
                <button id="main-action" class="flex-[2] bg-blue-600 py-4 rounded-2xl font-bold shadow-xl shadow-blue-500/30 active:scale-95 transition-all">Acción Comercial</button>
            </div>
            <button onclick="resumeScanning()" class="w-full mt-4 text-slate-500 text-xs font-semibold py-2 uppercase tracking-widest">Siguiente Escaneo</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const canvas = canvasElement.getContext('2d', { alpha: false });
        const loading = document.getElementById('loading');
        const resultCard = document.getElementById('result-card');
        const resultText = document.getElementById('result-text');
        const container = document.getElementById('video-container');
        const torchBtn = document.getElementById('torch-btn');
        const statusLabel = document.getElementById('status-label');

        let isScanning = true;
        let videoTrack = null;
        let torchActive = false;

        async function startSystem() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: "environment",
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });
                
                video.srcObject = stream;
                videoTrack = stream.getVideoTracks()[0];
                
                // Comprobar si tiene linterna (Solo algunos Android lo permiten vía WebAPI)
                const capabilities = videoTrack.getCapabilities?.();
                if (capabilities && capabilities.torch) {
                    torchBtn.classList.remove('hidden');
                    torchBtn.onclick = toggleTorch;
                }

                video.setAttribute("playsinline", true);
                await video.play();
                loading.style.display = 'none';
                requestAnimationFrame(processFrame);
            } catch (err) {
                loading.innerHTML = `<p class='text-red-500 p-10 text-center'>Acceso denegado: ${err.message}</p>`;
            }
        }

        async function toggleTorch() {
            torchActive = !torchActive;
            try {
                await videoTrack.applyConstraints({
                    advanced: [{ torch: torchActive }]
                });
                torchBtn.classList.toggle('bg-yellow-500', torchActive);
                torchBtn.classList.toggle('text-black', torchActive);
            } catch (e) { console.error(e); }
        }

        function processFrame() {
            if (!isScanning) return requestAnimationFrame(processFrame);

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvasElement.width = video.videoWidth;
                canvasElement.height = video.videoHeight;
                
                // Dibujar frame original
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                
                // --- TRUCO INDUSTRIAL: ESCANEO POR RECORTE (DIGITAL ZOOM) ---
                // En lugar de escanear toda la pantalla, solo escaneamos el centro
                // donde el usuario pone el papel. Esto mejora la detección de QRs pequeños.
                const scanSize = Math.min(canvasElement.width, canvasElement.height) * 0.7;
                const sx = (canvasElement.width - scanSize) / 2;
                const sy = (canvasElement.height - scanSize) / 2;
                
                const imageData = canvas.getImageData(sx, sy, scanSize, scanSize);
                
                // Motor de detección
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "attemptBoth"
                });

                if (code) {
                    container.classList.add('detected');
                    statusLabel.innerText = "¡Código Capturado!";
                    onSuccess(code.data);
                } else {
                    container.classList.remove('detected');
                    statusLabel.innerText = "Buscando QR...";
                }
            }
            requestAnimationFrame(processFrame);
        }

        function onSuccess(data) {
            isScanning = false;
            if (navigator.vibrate) navigator.vibrate([150, 50, 150]);
            
            resultText.innerText = data;
            resultCard.classList.add('active');
            
            const btn = document.getElementById('main-action');
            if (data.startsWith('http')) {
                btn.innerText = "Abrir Enlace";
                btn.onclick = () => window.open(data, '_blank');
            } else {
                btn.innerText = "Copiar y Cerrar";
                btn.onclick = () => { copyData(); resumeScanning(); };
            }
        }

        function copyData() {
            const text = resultText.innerText;
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            
            statusLabel.innerText = "Copiado al portapapeles";
            setTimeout(() => statusLabel.innerText = "Buscando QR...", 2000);
        }

        function resumeScanning() {
            isScanning = true;
            resultCard.classList.remove('active');
            container.classList.remove('detected');
        }

        window.addEventListener('load', startSystem);
    </script>
</body>
</html>
