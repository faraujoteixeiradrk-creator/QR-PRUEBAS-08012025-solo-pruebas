<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcula tu Ahorro Energ√©tico | DRK</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    
    <!-- Tesseract.js OCR -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Fondo Animado */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .animated-bg::before,
        .animated-bg::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.3;
            animation: float 15s infinite ease-in-out;
        }
        
        .animated-bg::before {
            top: -20%;
            left: -10%;
            width: 600px;
            height: 600px;
            background: #3b82f6;
            animation-delay: 0s;
        }
        
        .animated-bg::after {
            bottom: -20%;
            right: -10%;
            width: 500px;
            height: 500px;
            background: #8b5cf6;
            animation-delay: 7s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, -50px) rotate(5deg); }
            66% { transform: translate(-20px, 20px) rotate(-5deg); }
        }
        
        /* Animaciones */
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Drag & Drop */
        .drop-zone {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 3px dashed #cbd5e1;
            cursor: pointer;
        }
        
        .drop-zone:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
            transform: scale(1.02);
        }
        
        .drop-zone.drag-active {
            border-color: #3b82f6 !important;
            background-color: #dbeafe !important;
            transform: scale(1.05);
        }

        /* Bot√≥n Principal */
        .btn-primary {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            transition: all 0.3s ease;
            box-shadow: 0 10px 25px -5px rgba(220, 38, 38, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px -5px rgba(220, 38, 38, 0.5);
            filter: brightness(1.1);
        }

        /* Loading */
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ocultar input file */
        input[type="file"] { display: none; }
        
        /* Resultados */
        .result-card {
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <!-- Fondo Animado -->
    <div class="animated-bg"></div>

    <!-- Contenedor Principal -->
    <div class="w-full max-w-3xl">
        
        <!-- PASO 1: SUBIR FACTURA -->
        <div id="upload-screen" class="bg-white/95 backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden fade-in">
            
            <!-- Header -->
            <div class="bg-gradient-to-br from-slate-900 to-slate-800 px-8 py-10 text-center relative overflow-hidden">
                <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(#6366f1 1px, transparent 1px); background-size: 20px 20px;"></div>
                
                <div class="relative z-10">
                    <div class="inline-flex p-4 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 shadow-lg mb-6">
                        <i data-lucide="zap" class="w-10 h-10 text-white"></i>
                    </div>
                    <h1 class="text-4xl md:text-5xl font-black text-white mb-4">
                        ¬øCu√°nto puedes <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300">ahorrar</span>?
                    </h1>
                    <p class="text-slate-300 text-lg font-medium max-w-lg mx-auto">
                        Descubre tu ahorro real en <strong>segundos</strong>. Solo necesitas tu factura de luz.
                    </p>
                </div>
            </div>

            <!-- Contenido -->
            <div class="p-8 md:p-12">
                
                <!-- Drop Zone -->
                <div id="dropZone" class="drop-zone bg-gradient-to-br from-slate-50 to-blue-50 rounded-2xl p-12 text-center mb-6">
                    <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png" />
                    
                    <div class="mb-6">
                        <div class="inline-flex p-6 rounded-full bg-blue-100 mb-4">
                            <i data-lucide="upload-cloud" class="w-12 h-12 text-blue-600"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-800 mb-2">Arrastra tu factura aqu√≠</h3>
                        <p class="text-slate-600 mb-4">PDF, JPG, PNG</p>
                        <button onclick="document.getElementById('fileInput').click()" 
                                class="text-blue-600 hover:text-blue-700 font-semibold underline decoration-2 underline-offset-4">
                            o haz clic para seleccionar
                        </button>
                    </div>
                </div>

                <!-- Features -->
                <div class="grid md:grid-cols-3 gap-4 text-center">
                    <div class="p-4 bg-green-50 rounded-xl">
                        <i data-lucide="shield-check" class="w-8 h-8 text-green-600 mx-auto mb-2"></i>
                        <p class="text-sm font-semibold text-green-900">100% Seguro</p>
                    </div>
                    <div class="p-4 bg-blue-50 rounded-xl">
                        <i data-lucide="clock" class="w-8 h-8 text-blue-600 mx-auto mb-2"></i>
                        <p class="text-sm font-semibold text-blue-900">En segundos</p>
                    </div>
                    <div class="p-4 bg-purple-50 rounded-xl">
                        <i data-lucide="gift" class="w-8 h-8 text-purple-600 mx-auto mb-2"></i>
                        <p class="text-sm font-semibold text-purple-900">Gratis</p>
                    </div>
                </div>

            </div>
        </div>

        <!-- PASO 2: LOADING -->
        <div id="loading-screen" class="bg-white/95 backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden fade-in hidden">
            <div class="p-16 text-center">
                <div class="spinner mx-auto mb-6"></div>
                <h3 class="text-2xl font-bold text-slate-800 mb-2">Analizando tu factura...</h3>
                <p class="text-slate-600">Calculando tu ahorro personalizado</p>
            </div>
        </div>

        <!-- PASO 3: RESULTADOS -->
        <div id="results-screen" class="bg-white/95 backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden result-card hidden">
            
            <!-- Header Resultado -->
            <div class="bg-gradient-to-br from-green-600 to-emerald-600 px-8 py-8 text-center text-white">
                <div class="flex items-center justify-center gap-2 mb-3">
                    <i data-lucide="check-circle" class="w-6 h-6"></i>
                    <span class="text-sm font-bold uppercase tracking-wider">An√°lisis Completado</span>
                </div>
                <h2 class="text-3xl font-black">Resultado del Estudio</h2>
                <p class="text-green-100 text-sm mt-1">CUPS: <span id="result-cups" class="font-mono">-</span></p>
            </div>

            <!-- Tarjeta Oferta -->
            <div class="p-8">
                <div class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-2xl p-8 mb-6 text-white text-center shadow-xl">
                    <h3 class="text-3xl font-black mb-2" id="result-offer-name">DRK</h3>
                    <p class="text-blue-100 text-lg font-semibold mb-6" id="result-offer-desc">DRK PLAN AMIGO</p>
                    
                    <div class="bg-white/10 backdrop-blur-sm rounded-xl p-6 mb-6">
                        <p class="text-blue-100 text-sm uppercase tracking-wider mb-2">TU AHORRO ANUAL ESTIMADO</p>
                        <p class="text-6xl font-black mb-1" id="result-savings">0,00 ‚Ç¨</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4 text-left">
                        <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-red-200 text-lg font-bold mb-1" id="result-current-cost">0,00 ‚Ç¨</p>
                            <p class="text-xs text-blue-100">Total Periodo (<span id="result-days">60</span> d√≠as)</p>
                            <p class="text-sm font-semibold text-white mt-2" id="result-current-annual">0,00 ‚Ç¨/a√±o</p>
                        </div>
                        <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-blue-100 text-sm uppercase mb-1">Tu Nuevo Coste DRK</p>
                            <p class="text-2xl font-black text-white" id="result-new-monthly">0,00 ‚Ç¨/mes</p>
                            <p class="text-xl font-bold text-blue-100 mt-1" id="result-new-annual">0,00 ‚Ç¨/a√±o</p>
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n LO QUIERO -->
                <button onclick="sendEmail()" class="btn-primary w-full py-5 rounded-xl text-white text-xl font-black uppercase tracking-wide flex items-center justify-center gap-3 mb-4">
                    <i data-lucide="mail" class="w-6 h-6"></i>
                    LO QUIERO
                </button>

                <!-- Info adicional -->
                <p class="text-center text-sm text-slate-500">
                    Al hacer clic, se abrir√° tu cliente de correo con un mensaje preconfigurado
                </p>
            </div>
        </div>

    </div>

    <script>
        // ==========================================
        // CONFIGURACI√ìN
        // ==========================================
        const SHEET_ID = '1kLfQOZnTsBJ8lRXA0ab5RXk-QM3VeSRkDQsatL3-tVk';
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
        
        let currentTariff = null;
        let extractedData = null;

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            setupDragAndDrop();
            loadTariff();
        });

        // ==========================================
        // DRAG & DROP
        // ==========================================
        function setupDragAndDrop() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');

            dropZone.addEventListener('click', () => fileInput.click());
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-active');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-active');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-active');
                const file = e.dataTransfer.files[0];
                if (file) handleFile(file);
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) handleFile(file);
            });
        }

        // ==========================================
        // CARGAR TARIFA DESDE GOOGLE SHEETS
        // ==========================================
        async function loadTariff() {
            try {
                console.log('üì• Cargando tarifa Plan Amigo...');
                const response = await fetch(SHEET_URL);
                const text = await response.text();
                const json = JSON.parse(text.substring(47).slice(0, -2));
                
                const rows = json.table.rows;
                if (rows.length < 2) {
                    throw new Error('No se encontr√≥ la tarifa en la hoja');
                }

                const dataRow = rows[1].c;
                currentTariff = {
                    name: dataRow[0]?.v || 'DRK',
                    description: dataRow[1]?.v || 'DRK PLAN AMIGO',
                    p1_price: parseFloat(dataRow[2]?.v || 0),
                    p2_price: parseFloat(dataRow[3]?.v || 0),
                    p3_price: parseFloat(dataRow[4]?.v || 0),
                    p_potencia_1: parseFloat(dataRow[5]?.v || 0),
                    p_potencia_2: parseFloat(dataRow[6]?.v || 0),
                    descuento: parseFloat(dataRow[7]?.v || 0)
                };

                console.log('‚úÖ Tarifa cargada:', currentTariff);
            } catch (error) {
                console.error('‚ùå Error cargando tarifa:', error);
                alert('Error al cargar la tarifa. Por favor, recarga la p√°gina.');
            }
        }

        // ==========================================
        // PROCESAR ARCHIVO
        // ==========================================
        async function handleFile(file) {
            if (!currentTariff) {
                alert('Espera un momento, estamos cargando la tarifa...');
                return;
            }

            showScreen('loading');

            try {
                let data;
                if (file.type === 'application/pdf') {
                    data = await extractFromPDF(file);
                } else {
                    data = await extractFromImage(file);
                }

                if (data) {
                    extractedData = data;
                    calculateSavings(data);
                } else {
                    throw new Error('No se pudo extraer informaci√≥n de la factura');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('No pudimos leer tu factura. Por favor, intenta con otra imagen m√°s clara o un PDF.');
                showScreen('upload');
            }
        }

        // ==========================================
        // EXTRACCI√ìN PDF (SIMPLIFICADO)
        // ==========================================
        async function extractFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const page = await pdf.getPage(1);
            const textContent = await page.getTextContent();
            const text = textContent.items.map(item => item.str).join(' ');
            
            return parseInvoiceText(text);
        }

        // ==========================================
        // EXTRACCI√ìN IMAGEN (SIMPLIFICADO)
        // ==========================================
        async function extractFromImage(file) {
            const { data: { text } } = await Tesseract.recognize(file, 'spa');
            return parseInvoiceText(text);
        }

        // ==========================================
        // PARSEAR TEXTO DE FACTURA
        // ==========================================
        function parseInvoiceText(text) {
            const data = {
                cups: '',
                consumo_punta: 0,
                consumo_llano: 0,
                consumo_valle: 0,
                potencia_p1_kw: 0,
                potencia_p2_kw: 0,
                dias_facturados: 60,
                importe_total: 0
            };

            // Buscar CUPS
            const cupsMatch = text.match(/ES\d{16}[A-Z0-9]{2}[0-9A-Z]/i);
            if (cupsMatch) data.cups = cupsMatch[0];

            // Buscar consumos (ejemplo simplificado)
            const puntaMatch = text.match(/punta[^\d]*(\d+)/i);
            const llanoMatch = text.match(/llano[^\d]*(\d+)/i);
            const valleMatch = text.match(/valle[^\d]*(\d+)/i);

            if (puntaMatch) data.consumo_punta = parseInt(puntaMatch[1]);
            if (llanoMatch) data.consumo_llano = parseInt(llanoMatch[1]);
            if (valleMatch) data.consumo_valle = parseInt(valleMatch[1]);

            // Buscar potencias
            const pot1Match = text.match(/potencia.*?(\d+[\.,]\d+)/i);
            if (pot1Match) {
                data.potencia_p1_kw = parseFloat(pot1Match[1].replace(',', '.'));
                data.potencia_p2_kw = data.potencia_p1_kw;
            }

            // Buscar importe total
            const importeMatch = text.match(/total.*?(\d+[\.,]\d+)/i);
            if (importeMatch) data.importe_total = parseFloat(importeMatch[1].replace(',', '.'));

            return data;
        }

        // ==========================================
        // CALCULAR AHORRO
        // ==========================================
        function calculateSavings(data) {
            const DIAS_ANO = 365;
            const IVA = 0.21;
            const IE = 0.05113;

            // Calcular coste actual (estimado)
            const currentAnnual = (data.importe_total / data.dias_facturados) * DIAS_ANO;

            // Calcular coste con Plan Amigo
            const energyCostDay = (
                data.consumo_punta * currentTariff.p1_price +
                data.consumo_llano * currentTariff.p2_price +
                data.consumo_valle * currentTariff.p3_price
            ) / data.dias_facturados;

            const powerCostDay = 
                data.potencia_p1_kw * (currentTariff.p_potencia_1 / 365) +
                data.potencia_p2_kw * (currentTariff.p_potencia_2 / 365);

            const baseCostDay = energyCostDay + powerCostDay;
            const baseCostPeriod = baseCostDay * data.dias_facturados;

            // Aplicar descuento
            const discountAmount = baseCostPeriod * (currentTariff.descuento / 100);
            const afterDiscount = baseCostPeriod - discountAmount;

            // Aplicar IE
            const withIE = afterDiscount * (1 + IE);

            // Aplicar IVA
            const totalPeriod = withIE * (1 + IVA);
            const totalAnnual = (totalPeriod / data.dias_facturados) * DIAS_ANO;

            // Calcular ahorro
            const savings = currentAnnual - totalAnnual;

            // Mostrar resultados
            showResults({
                cups: data.cups || 'No detectado',
                days: data.dias_facturados,
                currentCost: data.importe_total,
                currentAnnual: currentAnnual,
                newMonthly: totalAnnual / 12,
                newAnnual: totalAnnual,
                savings: savings
            });
        }

        // ==========================================
        // MOSTRAR RESULTADOS
        // ==========================================
        function showResults(results) {
            document.getElementById('result-cups').textContent = results.cups;
            document.getElementById('result-days').textContent = results.days;
            document.getElementById('result-current-cost').textContent = results.currentCost.toFixed(2) + ' ‚Ç¨';
            document.getElementById('result-current-annual').textContent = results.currentAnnual.toFixed(2) + ' ‚Ç¨/a√±o';
            document.getElementById('result-new-monthly').textContent = results.newMonthly.toFixed(2) + ' ‚Ç¨/mes';
            document.getElementById('result-new-annual').textContent = results.newAnnual.toFixed(2) + ' ‚Ç¨/a√±o';
            document.getElementById('result-savings').textContent = results.savings.toFixed(2) + ' ‚Ç¨';

            showScreen('results');
            lucide.createIcons();
        }

        // ==========================================
        // ENVIAR EMAIL
        // ==========================================
        function sendEmail() {
            const to = 'f.araujo@drk.es,rguerra@drk.es,s.caballero@drk.es';
            const subject = 'Estimado DRK: Estoy interesado en los precios de la oferta';
            const body = `Estimado DRK,

Estoy interesado en los precios de la oferta. Adjunto la siguiente informaci√≥n para la contrataci√≥n:

- Foto DNI
- Email de validaci√≥n de contrato
- Tel√©fono de validaci√≥n de contrato
- N√∫mero de cuenta bancaria
- Factura el√©ctrica (no puede ser m√°s antigua de 3 meses desde la fecha actual)

CUPS: ${extractedData?.cups || 'Pendiente de adjuntar'}

Gracias.`;

            const mailtoLink = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
        }

        // ==========================================
        // NAVEGACI√ìN PANTALLAS
        // ==========================================
        function showScreen(screen) {
            document.getElementById('upload-screen').classList.add('hidden');
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.add('hidden');

            document.getElementById(screen + '-screen').classList.remove('hidden');
        }
    </script>

</body>
</html>
