<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lector QR Facturas</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 100%;
            margin: 20px auto;
            padding: 20px;
            text-align: center;
        }
        
        #qr-reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        
        #qr-shaded-region {
            border-color: #4CAF50 !important;
        }
        
        .result {
            background: #f4f4f4;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            word-wrap: break-word;
            text-align: left;
        }
        
        .success {
            border-left: 5px solid #4CAF50;
            background: #e8f5e9;
        }
        
        .error {
            border-left: 5px solid #f44336;
            background: #ffebee;
        }
        
        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: left;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background: #45a049;
        }
        
        .camera-select {
            margin: 10px;
            padding: 8px;
            border-radius: 5px;
        }
        
        @media (max-width: 600px) {
            body {
                margin: 10px;
                padding: 10px;
            }
            
            #qr-reader {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <h1>üì± Lector QR para Facturas</h1>
    <p>Escanea c√≥digos QR de facturas electr√≥nicas</p>
    
    <div class="info-box">
        <strong>Instrucciones:</strong>
        <ol>
            <li>Permite el acceso a la c√°mara cuando se solicite</li>
            <li>Enfoca el c√≥digo QR dentro del √°rea marcada</li>
            <li>El c√≥digo se leer√° autom√°ticamente</li>
            <li>Los datos aparecer√°n abajo</li>
        </ol>
    </div>
    
    <div>
        <label for="camera-select">Seleccionar c√°mara: </label>
        <select id="camera-select" class="camera-select"></select>
    </div>
    
    <div id="qr-reader"></div>
    
    <div id="result-container">
        <h3>Resultado del Escaneo:</h3>
        <div id="qr-result" class="result"></div>
    </div>
    
    <div>
        <button id="copy-btn">Copiar Datos</button>
        <button id="new-scan-btn">Nuevo Escaneo</button>
        <button id="toggle-camera-btn">Cambiar C√°mara</button>
    </div>
    
    <div id="debug-info" class="result" style="display: none; font-size: 12px;"></div>

    <script>
        let html5QrCode;
        let currentCameraId = null;
        
        function initializeScanner(cameraId = null) {
            // Si ya existe un scanner, lo detenemos
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop();
            }
            
            html5QrCode = new Html5Qrcode("qr-reader");
            
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                rememberLastUsedCamera: true,
                supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
            };
            
            const startConfig = cameraId ? 
                { deviceId: { exact: cameraId } } : 
                { facingMode: "environment" }; // Prioriza c√°mara trasera
            
            html5QrCode.start(
                startConfig,
                config,
                onScanSuccess,
                onScanError
            ).then(() => {
                console.log("Scanner iniciado");
                document.getElementById('qr-result').innerHTML = 
                    '<div class="success">Escaneando... Enfoca el c√≥digo QR</div>';
            }).catch(err => {
                console.error("Error al iniciar scanner:", err);
                document.getElementById('qr-result').innerHTML = 
                    `<div class="error">Error: ${err.message}</div>`;
            });
        }
        
        function onScanSuccess(decodedText, decodedResult) {
            // Detener el scanner autom√°ticamente despu√©s de leer
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop();
            }
            
            // Mostrar resultado
            const resultDiv = document.getElementById('qr-result');
            
            // Intentar formatear si es XML/JSON
            let formattedText = decodedText;
            try {
                // Si parece XML (facturas electr√≥nicas)
                if (decodedText.trim().startsWith('<?xml') || decodedText.includes('<cfdi:')) {
                    formattedText = highlightXML(decodedText);
                }
                // Si es JSON
                else if (decodedText.trim().startsWith('{') || decodedText.trim().startsWith('[')) {
                    const jsonObj = JSON.parse(decodedText);
                    formattedText = syntaxHighlight(JSON.stringify(jsonObj, null, 2));
                }
                // Si es URL
                else if (decodedText.startsWith('http')) {
                    formattedText = `<a href="${decodedText}" target="_blank">${decodedText}</a>`;
                }
            } catch (e) {
                // Mantener texto original si no se puede formatear
                console.log("No se pudo formatear:", e);
            }
            
            resultDiv.innerHTML = `
                <div class="success">
                    <strong>‚úÖ QR Detectado!</strong><br><br>
                    <strong>Tipo:</strong> ${decodedResult.result.format?.formatName || 'Desconocido'}<br>
                    <strong>Contenido:</strong><br>
                    <div style="max-height: 300px; overflow-y: auto; background: white; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        ${formattedText}
                    </div>
                    <br>
                    <small>${new Date().toLocaleString()}</small>
                </div>
            `;
            
            // Mostrar datos en consola para depuraci√≥n
            console.log("QR detectado:", decodedText);
            console.log("Resultado completo:", decodedResult);
            
            // Actualizar informaci√≥n de depuraci√≥n
            updateDebugInfo(decodedResult);
        }
        
        function onScanError(errorMessage) {
            // No mostrar errores menores durante el escaneo normal
            if (!errorMessage.includes("NotFoundException")) {
                console.warn("Error de escaneo:", errorMessage);
            }
        }
        
        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, 
            function (match) {
                let cls = 'number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'key';
                    } else {
                        cls = 'string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'boolean';
                } else if (/null/.test(match)) {
                    cls = 'null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }
        
        function highlightXML(xml) {
            return xml
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*")/g, '<span class="string">$1</span>')
                .replace(/&lt;(\/?)(\w+)/g, '&lt;<span class="tag">$1$2</span>');
        }
        
        function updateDebugInfo(result) {
            const debugDiv = document.getElementById('debug-info');
            debugDiv.style.display = 'block';
            debugDiv.innerHTML = `
                <strong>Informaci√≥n t√©cnica:</strong><br>
                Formato: ${result.result.format?.formatName || 'N/A'}<br>
                Tama√±o QR estimado: ${result.result?.boundingBox ? 
                    `${Math.round(result.result.boundingBox.width)}x${Math.round(result.result.boundingBox.height)}px` : 'N/A'}<br>
                Puntos de esquina: ${result.result?.cornerPoints ? result.result.cornerPoints.length : '0'}
            `;
        }
        
        // Listar c√°maras disponibles
        async function listCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                const cameraSelect = document.getElementById('camera-select');
                cameraSelect.innerHTML = '';
                
                videoDevices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `C√°mara ${index + 1}`;
                    cameraSelect.appendChild(option);
                });
                
                // Si hay c√°maras, usar la primera como predeterminada
                if (videoDevices.length > 0 && !currentCameraId) {
                    currentCameraId = videoDevices[0].deviceId;
                }
                
                return videoDevices;
            } catch (err) {
                console.error("Error al listar c√°maras:", err);
                return [];
            }
        }
        
        // Event Listeners
        document.getElementById('copy-btn').addEventListener('click', () => {
            const resultText = document.querySelector('#qr-result .success')?.innerText;
            if (resultText) {
                navigator.clipboard.writeText(resultText)
                    .then(() => alert('Datos copiados al portapapeles'))
                    .catch(err => console.error('Error al copiar:', err));
            }
        });
        
        document.getElementById('new-scan-btn').addEventListener('click', () => {
            document.getElementById('qr-result').innerHTML = '';
            initializeScanner(currentCameraId);
        });
        
        document.getElementById('toggle-camera-btn').addEventListener('click', async () => {
            const cameras = await listCameras();
            if (cameras.length > 1) {
                // Cambiar a la siguiente c√°mara
                const currentIndex = cameras.findIndex(cam => cam.deviceId === currentCameraId);
                const nextIndex = (currentIndex + 1) % cameras.length;
                currentCameraId = cameras[nextIndex].deviceId;
                initializeScanner(currentCameraId);
            }
        });
        
        document.getElementById('camera-select').addEventListener('change', (e) => {
            currentCameraId = e.target.value;
            initializeScanner(currentCameraId);
        });
        
        // Inicializar cuando la p√°gina cargue
        window.addEventListener('load', async () => {
            await listCameras();
            initializeScanner();
        });
        
        // Detectar cambios en dispositivos
        navigator.mediaDevices.addEventListener('devicechange', listCameras);
        
        // Estilos para resaltado de sintaxis
        const style = document.createElement('style');
        style.textContent = `
            .string { color: green; }
            .number { color: blue; }
            .boolean { color: purple; }
            .null { color: gray; }
            .key { color: red; }
            .tag { color: #905; }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
