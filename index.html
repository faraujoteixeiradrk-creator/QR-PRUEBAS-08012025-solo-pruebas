<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcula tu Ahorro | DRK EnergÃ­a</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-bg': '#1a202c',
                        'dark-card': '#2d3748',
                    }
                }
            }
        }
    </script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    
    <!-- Tesseract.js OCR -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f172a;
            min-height: 100vh;
            color: white;
        }

        /* Animaciones */
        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Drop Zone */
        .drop-zone {
            border: 3px dashed #475569;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .drop-zone:hover {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.05);
        }
        
        .drop-zone.drag-active {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
            transform: scale(1.02);
        }

        /* Botones */
        .btn-option {
            transition: all 0.3s ease;
            border: 2px solid #334155;
        }
        
        .btn-option:hover {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(220, 38, 38, 0.4);
        }

        /* Language Selector */
        .lang-btn {
            transition: all 0.3s ease;
            border: 2px solid #334155;
        }
        
        .lang-btn:hover {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        .lang-btn.active {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.2);
        }

        /* Loading */
        .spinner {
            border: 3px solid #334155;
            border-top-color: #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        input[type="file"] { display: none; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- PANTALLA 1: SUBIR FACTURA -->
    <div id="upload-screen" class="w-full max-w-6xl fade-in">
        
        <!-- Header -->
        <div class="text-center mb-12">
            <div class="flex items-center justify-center gap-4 mb-6">
                <i data-lucide="zap" class="w-16 h-16 text-blue-500"></i>
                <h1 class="text-5xl md:text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-blue-600">
                    Extractor Inteligente
                </h1>
            </div>
            <p class="text-slate-400 text-lg uppercase tracking-widest font-mono">
                ANALIZADOR DE FACTURAS ELÃ‰CTRICAS CNMC
            </p>
        </div>

        <!-- Drop Zone -->
        <div id="dropZone" class="drop-zone bg-slate-800/50 backdrop-blur rounded-3xl p-16 mb-8">
            <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png" />
            
            <div class="text-center">
                <div class="flex items-center justify-center gap-6 mb-8">
                    <i data-lucide="file-text" class="w-20 h-20 text-slate-400"></i>
                    <i data-lucide="camera" class="w-20 h-20 text-slate-400"></i>
                </div>
                
                <h2 class="text-3xl font-bold text-white mb-4">Arrastra PDF o Foto de Factura</h2>
                <p class="text-slate-400 mb-8">
                    Aceptamos <span class="text-blue-400 font-semibold">PDF, JPG</span> o <span class="text-blue-400 font-semibold">PNG</span>. Buscamos el cÃ³digo QR o el enlace oculto para extraer los datos.
                </p>

                <!-- Botones de opciones -->
                <div class="flex flex-wrap justify-center gap-4">
                    <button onclick="document.getElementById('fileInput').click()" class="btn-option px-8 py-4 rounded-xl bg-slate-700/50 backdrop-blur text-white font-semibold flex items-center gap-2">
                        <i data-lucide="link" class="w-5 h-5"></i>
                        Link Texto
                    </button>
                    <button onclick="document.getElementById('fileInput').click()" class="btn-option px-8 py-4 rounded-xl bg-slate-700/50 backdrop-blur text-white font-semibold flex items-center gap-2">
                        <i data-lucide="diamond" class="w-5 h-5"></i>
                        MinerÃ­a IMG
                    </button>
                    <button onclick="document.getElementById('fileInput').click()" class="btn-option px-8 py-4 rounded-xl bg-slate-700/50 backdrop-blur text-white font-semibold flex items-center gap-2">
                        <i data-lucide="scissors" class="w-5 h-5"></i>
                        Recorte 3x3
                    </button>
                </div>
            </div>
        </div>

        <!-- Selector de Idioma -->
        <div class="text-center">
            <p class="text-slate-400 text-sm mb-4">Selecciona el idioma del comparativo:</p>
            <div class="flex justify-center gap-3">
                <button onclick="selectLanguage('es')" class="lang-btn active px-6 py-3 rounded-lg bg-slate-700/50 backdrop-blur text-white font-semibold" data-lang="es">
                    ðŸ‡ªðŸ‡¸ EspaÃ±ol
                </button>
                <button onclick="selectLanguage('en')" class="lang-btn px-6 py-3 rounded-lg bg-slate-700/50 backdrop-blur text-white font-semibold" data-lang="en">
                    ðŸ‡¬ðŸ‡§ English
                </button>
                <button onclick="selectLanguage('fr')" class="lang-btn px-6 py-3 rounded-lg bg-slate-700/50 backdrop-blur text-white font-semibold" data-lang="fr">
                    ðŸ‡«ðŸ‡· FranÃ§ais
                </button>
                <button onclick="selectLanguage('de')" class="lang-btn px-6 py-3 rounded-lg bg-slate-700/50 backdrop-blur text-white font-semibold" data-lang="de">
                    ðŸ‡©ðŸ‡ª Deutsch
                </button>
            </div>
        </div>

    </div>

    <!-- PANTALLA 2: LOADING -->
    <div id="loading-screen" class="w-full max-w-2xl fade-in hidden">
        <div class="bg-slate-800/50 backdrop-blur rounded-3xl p-16 text-center">
            <div class="spinner mx-auto mb-6"></div>
            <h3 class="text-2xl font-bold text-white mb-2" id="loading-text">Espera un momento, estamos cargando la tarifa...</h3>
            <p class="text-slate-400" id="loading-subtext">Conectando con Google Sheets...</p>
        </div>
    </div>

    <!-- PANTALLA 3: RESULTADOS -->
    <div id="results-screen" class="w-full max-w-4xl fade-in hidden">
        
        <!-- Header Resultado -->
        <div class="bg-gradient-to-r from-green-600 to-emerald-600 rounded-t-3xl px-8 py-6 text-center">
            <div class="flex items-center justify-center gap-2 mb-2">
                <i data-lucide="check-circle" class="w-6 h-6"></i>
                <span class="text-sm font-bold uppercase tracking-wider">AnÃ¡lisis Completado</span>
            </div>
            <h2 class="text-3xl font-black">Resultado del Estudio</h2>
            <p class="text-green-100 text-sm mt-1">CUPS: <span id="result-cups" class="font-mono">-</span></p>
        </div>

        <!-- Contenido Resultado -->
        <div class="bg-slate-800/50 backdrop-blur rounded-b-3xl p-8">
            
            <!-- Tarjeta Oferta -->
            <div class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-2xl p-8 mb-6 text-white text-center shadow-xl">
                <h3 class="text-4xl font-black mb-2" id="result-offer-name">DRK</h3>
                <p class="text-blue-100 text-xl font-semibold mb-6" id="result-offer-desc">DRK PLAN AMIGO</p>
                
                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-6 mb-6">
                    <p class="text-blue-100 text-sm uppercase tracking-wider mb-2">TU AHORRO ANUAL ESTIMADO</p>
                    <p class="text-7xl font-black mb-1" id="result-savings">0,00 â‚¬</p>
                </div>

                <div class="grid grid-cols-2 gap-4 text-left">
                    <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                        <p class="text-red-200 text-xl font-bold mb-1" id="result-current-cost">0,00 â‚¬</p>
                        <p class="text-xs text-blue-100">Total Periodo (<span id="result-days">60</span> dÃ­as)</p>
                        <p class="text-sm font-semibold text-white mt-2" id="result-current-annual">0,00 â‚¬/aÃ±o</p>
                    </div>
                    <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                        <p class="text-blue-100 text-sm uppercase mb-1">Tu Nuevo Coste DRK</p>
                        <p class="text-3xl font-black text-white" id="result-new-monthly">0,00 â‚¬/mes</p>
                        <p class="text-xl font-bold text-blue-100 mt-1" id="result-new-annual">0,00 â‚¬/aÃ±o</p>
                    </div>
                </div>
            </div>

            <!-- BotÃ³n LO QUIERO -->
            <button onclick="sendEmail()" class="btn-primary w-full py-5 rounded-xl text-white text-2xl font-black uppercase tracking-wide flex items-center justify-center gap-3 mb-4">
                <i data-lucide="mail" class="w-7 h-7"></i>
                LO QUIERO
            </button>

            <p class="text-center text-sm text-slate-400">
                Al hacer clic, se abrirÃ¡ tu cliente de correo con un mensaje preconfigurado
            </p>
        </div>

    </div>

    <script>
        // ==========================================
        // CONFIGURACIÃ“N
        // ==========================================
        const SHEET_ID = '1kLfQOZnTsBJ8lRXA0ab5RXk-QM3VeSRkDQsatL3-tVk';
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
        
        let currentTariff = null;
        let extractedData = null;
        let selectedLanguage = 'es';

        // ==========================================
        // INICIALIZACIÃ“N
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            setupDragAndDrop();
            loadTariffWithVisualFeedback();
        });

        // ==========================================
        // SELECTOR DE IDIOMA
        // ==========================================
        function selectLanguage(lang) {
            selectedLanguage = lang;
            
            // Actualizar botones
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-lang') === lang) {
                    btn.classList.add('active');
                }
            });
            
            console.log('Idioma seleccionado:', lang);
        }

        // ==========================================
        // DRAG & DROP
        // ==========================================
        function setupDragAndDrop() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');

            dropZone.addEventListener('click', () => fileInput.click());
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-active');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-active');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-active');
                const file = e.dataTransfer.files[0];
                if (file) handleFile(file);
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) handleFile(file);
            });
        }

        // ==========================================
        // CARGAR TARIFA CON FEEDBACK VISUAL
        // ==========================================
        async function loadTariffWithVisualFeedback() {
            try {
                console.log('ðŸ“¥ Iniciando carga de tarifa...');
                
                const response = await fetch(SHEET_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                console.log('ðŸ“„ Respuesta recibida, parseando...');
                
                // Eliminar el wrapper de JSONP
                const jsonText = text.substring(47).slice(0, -2);
                const json = JSON.parse(jsonText);
                
                console.log('ðŸ“Š JSON parseado:', json);
                
                const rows = json.table.rows;
                if (rows.length < 2) {
                    throw new Error('No se encontrÃ³ la tarifa en la hoja (menos de 2 filas)');
                }

                const dataRow = rows[1].c;
                currentTariff = {
                    name: dataRow[0]?.v || 'DRK',
                    description: dataRow[1]?.v || 'DRK PLAN AMIGO',
                    p1_price: parseFloat(dataRow[2]?.v || 0),
                    p2_price: parseFloat(dataRow[3]?.v || 0),
                    p3_price: parseFloat(dataRow[4]?.v || 0),
                    p_potencia_1: parseFloat(dataRow[5]?.v || 0),
                    p_potencia_2: parseFloat(dataRow[6]?.v || 0),
                    descuento: parseFloat(dataRow[7]?.v || 0)
                };

                console.log('âœ… Tarifa cargada exitosamente:', currentTariff);
                
            } catch (error) {
                console.error('âŒ Error detallado al cargar tarifa:', error);
                console.error('URL intentada:', SHEET_URL);
                
                // Mostrar error al usuario
                alert(`Error al cargar la tarifa Plan Amigo:\n\n${error.message}\n\nPor favor, verifica:\n1. La hoja de Google estÃ¡ pÃºblica\n2. El ID es correcto: ${SHEET_ID}\n3. La primera fila tiene encabezados\n4. La segunda fila tiene los datos`);
                
                // Usar datos de ejemplo para testing
                console.log('âš ï¸ Usando tarifa de ejemplo para testing...');
                currentTariff = {
                    name: 'DRK',
                    description: 'DRK PLAN AMIGO (DEMO)',
                    p1_price: 0.11266,
                    p2_price: 0.11266,
                    p3_price: 0.11266,
                    p_potencia_1: 36.909,
                    p_potencia_2: 36.163,
                    descuento: 10
                };
            }
        }

        // ==========================================
        // PROCESAR ARCHIVO
        // ==========================================
        async function handleFile(file) {
            if (!currentTariff) {
                showLoadingMessage('Espera un momento, estamos cargando la tarifa...', 'Conectando con Google Sheets...');
                
                // Esperar a que la tarifa se cargue
                let attempts = 0;
                while (!currentTariff && attempts < 10) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    attempts++;
                }
                
                if (!currentTariff) {
                    alert('Error: No se pudo cargar la tarifa. Por favor, recarga la pÃ¡gina.');
                    showScreen('upload');
                    return;
                }
            }

            showLoadingMessage('Analizando tu factura...', 'Extrayendo datos con OCR avanzado...');

            try {
                let data;
                if (file.type === 'application/pdf') {
                    data = await extractFromPDF(file);
                } else {
                    data = await extractFromImage(file);
                }

                if (data) {
                    extractedData = data;
                    calculateSavings(data);
                } else {
                    throw new Error('No se pudo extraer informaciÃ³n de la factura');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('No pudimos leer tu factura. Por favor, intenta con otra imagen mÃ¡s clara o un PDF.');
                showScreen('upload');
            }
        }

        // ==========================================
        // EXTRACCIÃ“N PDF
        // ==========================================
        async function extractFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const page = await pdf.getPage(1);
            const textContent = await page.getTextContent();
            const text = textContent.items.map(item => item.str).join(' ');
            
            return parseInvoiceText(text);
        }

        // ==========================================
        // EXTRACCIÃ“N IMAGEN
        // ==========================================
        async function extractFromImage(file) {
            const { data: { text } } = await Tesseract.recognize(file, 'spa', {
                logger: m => {
                    if (m.status === 'recognizing text') {
                        showLoadingMessage('Analizando tu factura...', `Progreso: ${Math.round(m.progress * 100)}%`);
                    }
                }
            });
            return parseInvoiceText(text);
        }

        // ==========================================
        // PARSEAR TEXTO DE FACTURA
        // ==========================================
        function parseInvoiceText(text) {
            const data = {
                cups: '',
                consumo_punta: 0,
                consumo_llano: 0,
                consumo_valle: 0,
                potencia_p1_kw: 0,
                potencia_p2_kw: 0,
                dias_facturados: 60,
                importe_total: 0
            };

            // CUPS
            const cupsMatch = text.match(/ES\d{16}[A-Z0-9]{2}[0-9A-Z]/i);
            if (cupsMatch) data.cups = cupsMatch[0];

            // Consumos
            const puntaMatch = text.match(/punta[^\d]*(\d+)/i);
            const llanoMatch = text.match(/llano[^\d]*(\d+)/i);
            const valleMatch = text.match(/valle[^\d]*(\d+)/i);

            if (puntaMatch) data.consumo_punta = parseInt(puntaMatch[1]);
            if (llanoMatch) data.consumo_llano = parseInt(llanoMatch[1]);
            if (valleMatch) data.consumo_valle = parseInt(valleMatch[1]);

            // Potencias
            const pot1Match = text.match(/potencia.*?(\d+[\.,]\d+)/i);
            if (pot1Match) {
                data.potencia_p1_kw = parseFloat(pot1Match[1].replace(',', '.'));
                data.potencia_p2_kw = data.potencia_p1_kw;
            }

            // Importe total
            const importeMatch = text.match(/total.*?(\d+[\.,]\d+)/i);
            if (importeMatch) data.importe_total = parseFloat(importeMatch[1].replace(',', '.'));

            console.log('ðŸ“„ Datos extraÃ­dos:', data);
            return data;
        }

        // ==========================================
        // CALCULAR AHORRO
        // ==========================================
        function calculateSavings(data) {
            const DIAS_ANO = 365;
            const IVA = 0.21;
            const IE = 0.05113;

            // Calcular coste actual
            const currentAnnual = (data.importe_total / data.dias_facturados) * DIAS_ANO;

            // Calcular coste con Plan Amigo
            const energyCostDay = (
                data.consumo_punta * currentTariff.p1_price +
                data.consumo_llano * currentTariff.p2_price +
                data.consumo_valle * currentTariff.p3_price
            ) / data.dias_facturados;

            const powerCostDay = 
                data.potencia_p1_kw * (currentTariff.p_potencia_1 / 365) +
                data.potencia_p2_kw * (currentTariff.p_potencia_2 / 365);

            const baseCostDay = energyCostDay + powerCostDay;
            const baseCostPeriod = baseCostDay * data.dias_facturados;

            // Aplicar descuento
            const discountAmount = baseCostPeriod * (currentTariff.descuento / 100);
            const afterDiscount = baseCostPeriod - discountAmount;

            // Aplicar IE + IVA
            const withIE = afterDiscount * (1 + IE);
            const totalPeriod = withIE * (1 + IVA);
            const totalAnnual = (totalPeriod / data.dias_facturados) * DIAS_ANO;

            // Calcular ahorro
            const savings = currentAnnual - totalAnnual;

            showResults({
                cups: data.cups || 'No detectado',
                days: data.dias_facturados,
                currentCost: data.importe_total,
                currentAnnual: currentAnnual,
                newMonthly: totalAnnual / 12,
                newAnnual: totalAnnual,
                savings: savings
            });
        }

        // ==========================================
        // MOSTRAR RESULTADOS
        // ==========================================
        function showResults(results) {
            document.getElementById('result-cups').textContent = results.cups;
            document.getElementById('result-days').textContent = results.days;
            document.getElementById('result-current-cost').textContent = results.currentCost.toFixed(2) + ' â‚¬';
            document.getElementById('result-current-annual').textContent = results.currentAnnual.toFixed(2) + ' â‚¬/aÃ±o';
            document.getElementById('result-new-monthly').textContent = results.newMonthly.toFixed(2) + ' â‚¬/mes';
            document.getElementById('result-new-annual').textContent = results.newAnnual.toFixed(2) + ' â‚¬/aÃ±o';
            document.getElementById('result-savings').textContent = results.savings.toFixed(2) + ' â‚¬';

            showScreen('results');
            lucide.createIcons();
        }

        // ==========================================
        // ENVIAR EMAIL
        // ==========================================
        function sendEmail() {
            const to = 'f.araujo@drk.es,rguerra@drk.es,s.caballero@drk.es';
            const subject = 'Estimado DRK: Estoy interesado en los precios de la oferta';
            const body = `Estimado DRK,

Estoy interesado en los precios de la oferta. Adjunto la siguiente informaciÃ³n para la contrataciÃ³n:

- Foto DNI
- Email de validaciÃ³n de contrato
- TelÃ©fono de validaciÃ³n de contrato
- NÃºmero de cuenta bancaria
- Factura elÃ©ctrica (no puede ser mÃ¡s antigua de 3 meses desde la fecha actual)

CUPS: ${extractedData?.cups || 'Pendiente de adjuntar'}
Idioma preferido: ${selectedLanguage.toUpperCase()}

Gracias.`;

            const mailtoLink = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
        }

        // ==========================================
        // NAVEGACIÃ“N PANTALLAS
        // ==========================================
        function showScreen(screen) {
            document.getElementById('upload-screen').classList.add('hidden');
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.add('hidden');

            document.getElementById(screen + '-screen').classList.remove('hidden');
        }

        function showLoadingMessage(title, subtitle) {
            document.getElementById('loading-text').textContent = title;
            document.getElementById('loading-subtext').textContent = subtitle;
            showScreen('loading');
        }
    </script>

</body>
</html>
